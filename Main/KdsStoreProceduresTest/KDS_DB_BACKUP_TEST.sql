CREATE OR REPLACE PACKAGE PKG_APPROVALS AS

/******************************************************************************
   NAME:       PKG_APPROVALS
   PURPOSE:  Approvals Modules

   REVISIONS:
   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        15/07/2009       Gregory      1. Created this package.
******************************************************************************/
TYPE	CurType	  IS	REF  CURSOR;
HARIGOT_SHAON_SIDUR_EXCLUDE CONSTANT number := 99220;

PROCEDURE get_approval_details(p_kod_ishur NUMBER,p_rama NUMBER,
    p_kod_tafkid NUMBER,
p_Cur OUT CurType);
PROCEDURE get_approval_request(p_mispar_ishi NUMBER,p_kod_ishur NUMBER,
            p_taarich DATE,p_mispar_sidur NUMBER,p_shat_hatchala DATE,
            p_shat_yetzia DATE,p_mispar_knisa NUMBER,p_rama NUMBER,
            p_erech_mevukash NUMBER,p_erech_mevukash2 NUMBER,p_Cur OUT CurType);
PROCEDURE add_approval_request(p_mispar_ishi NUMBER,p_kod_ishur NUMBER,
            p_taarich DATE,p_mispar_sidur NUMBER,p_shat_hatchala DATE,
            p_shat_yetzia DATE,p_mispar_knisa NUMBER,p_measher_rashi NUMBER,
            p_measher_mishni NUMBER,p_status NUMBER,p_rama NUMBER, p_erech_mevukash NUMBER, p_erech_mevukash2 NUMBER,
            p_erech_meushar NUMBER,p_siba VARCHAR2,p_heara VARCHAR2 default null, 
            p_gorem_nosaf NUMBER default 0);
PROCEDURE update_erech_mevukash(p_mispar_ishi NUMBER,p_kod_ishur NUMBER,
            p_taarich DATE,p_mispar_sidur NUMBER,p_shat_hatchala DATE,
            p_shat_yetzia DATE,p_mispar_knisa NUMBER,p_rama NUMBER,
            p_erech_mevukash NUMBER,p_erech_mevukash2 NUMBER,
            p_new_erech_mevukash NUMBER,p_new_erech_mevukash2 NUMBER,p_rows_affected out NUMBER);
PROCEDURE get_approval_requests_dates(p_mispar_ishi NUMBER,p_Cur OUT CurType);
PROCEDURE get_approval_statuses(p_Cur OUT CurType);
PROCEDURE get_all_approval_requests(p_mispar_ishi NUMBER,p_status NUMBER,p_additional_status NUMBER,
            p_month NUMBER,p_year NUMBER,p_Cur OUT CurType);
PROCEDURE get_approval_codes(p_Cur OUT CurType);
PROCEDURE get_approval_jobs(p_Cur OUT CurType);
PROCEDURE get_factors_from_meashrim(p_mispar_ishi NUMBER, p_taarich DATE,
            p_Cur OUT CurType);
PROCEDURE get_employee_details(p_mispar_ishi NUMBER, p_taarich DATE,
            p_Cur OUT CurType);
 PROCEDURE change_approval_request_status(p_mispar_ishi NUMBER,p_kod_ishur NUMBER,
            p_taarich DATE,p_mispar_sidur NUMBER,p_shat_hatchala DATE,
            p_shat_yetzia DATE,p_mispar_knisa NUMBER,p_status NUMBER,p_rama NUMBER,
            p_erech_mevukash NUMBER,p_erech_mevukash2 NUMBER,
            p_heara VARCHAR2,p_erech_meushar NUMBER,p_meadken_acharon NUMBER,p_rows_affected out NUMBER);
PROCEDURE update_approval_request_remark(p_mispar_ishi NUMBER,p_kod_ishur NUMBER,
            p_taarich DATE,p_mispar_sidur NUMBER,p_shat_hatchala DATE,
            p_shat_yetzia DATE,p_mispar_knisa NUMBER,p_rama NUMBER,
            p_erech_mevukash NUMBER,p_erech_mevukash2 NUMBER,
            p_heara VARCHAR2,p_rows_affected out NUMBER);
PROCEDURE check_approval_max_rama(p_kod_ishur NUMBER, p_max_rama out  NUMBER);
PROCEDURE set_approval_forward_data(p_mispar_ishi NUMBER,p_kod_ishur NUMBER,
            p_taarich DATE,p_mispar_sidur NUMBER,p_shat_hatchala DATE,
            p_shat_yetzia DATE,p_mispar_knisa NUMBER,p_rama NUMBER,
            p_erech_mevukash NUMBER,p_erech_mevukash2 NUMBER,
            p_kod_status_ishur NUMBER,p_kod_tafkid_nosaf NUMBER,
            p_gorem_nosaf NUMBER, p_meadken_acharon NUMBER);
PROCEDURE get_matching_approval_requests(p_mispar_ishi NUMBER,  p_taarich DATE,
            p_Cur OUT CurType);
PROCEDURE get_similar_approval_requests(p_mispar_ishi NUMBER,  p_taarich DATE,
            p_kod_ishur NUMBER,p_mispar_sidur NUMBER,  p_shat_hatchala DATE,
            p_shat_yetzia DATE,p_mispar_knisa NUMBER,
            p_Cur OUT CurType);
PROCEDURE get_snif_tnua_and_ezor(p_mispar_ishi NUMBER,
            p_taarich DATE,p_mispar_sidur NUMBER,p_shat_hatchala DATE,
            p_shat_yetzia DATE,p_mispar_knisa NUMBER, p_Cur OUT CurType);
PROCEDURE get_snif_tnua_hevrot_lelo_ish(p_mispar_ishi NUMBER,
            p_taarich DATE,p_mispar_sidur NUMBER,p_shat_hatchala DATE,
            p_shat_yetzia DATE,p_mispar_knisa NUMBER, p_Cur OUT CurType);
PROCEDURE update_lo_letashlum(p_mispar_ishi NUMBER,
            p_taarich DATE,p_mispar_sidur NUMBER,p_shat_hatchala DATE,
            p_value NUMBER, p_kod_siba NUMBER default null);
PROCEDURE update_chariga(p_mispar_ishi NUMBER,
            p_taarich DATE,p_mispar_sidur NUMBER,p_shat_hatchala DATE,
            p_value NUMBER);
PROCEDURE get_sidur_meuhad_approvals(p_taarich DATE, p_mispar_ishi NUMBER, p_Cur OUT CurType);
PROCEDURE get_sidur_matala_approvals(p_taarich DATE, p_mispar_ishi NUMBER, p_Cur OUT CurType);
PROCEDURE get_harigot_shaon(p_taarich DATE, p_mispar_ishi NUMBER, p_Cur OUT CurType) ;
PROCEDURE get_nahag_sidur_tafkid(p_taarich DATE, p_mispar_ishi NUMBER, p_Cur OUT CurType);
procedure get_hashlama_approvals(p_taarich DATE, p_mispar_ishi NUMBER,p_Cur OUT CurType);
PROCEDURE get_mosach_shabaton_approvals(p_taarich DATE, p_mispar_ishi NUMBER,p_Cur OUT CurType);
function get_sug_yom(p_taarich Date,p_sug_yom NUMBER) return NUMBER;
PROCEDURE get_shaot_avoda_shabat(p_taarich DATE,p_mispar_ishi NUMBER, p_Cur OUT CurType);
PROCEDURE get_hamtana_approvals(p_taarich DATE,p_mispar_ishi NUMBER, p_Cur OUT CurType);
PROCEDURE get_pending_approvals(p_rashi NUMBER,p_Cur OUT CurType);
PROCEDURE get_expired_pending_approvals(p_Cur OUT CurType);
PROCEDURE update_gorem_measher_mishni(p_mispar_ishi NUMBER,p_kod_ishur NUMBER,
            p_taarich DATE,p_mispar_sidur NUMBER,p_shat_hatchala DATE,
            p_shat_yetzia DATE,p_mispar_knisa NUMBER,p_rama NUMBER,
             p_erech_mevukash NUMBER,p_erech_mevukash2 NUMBER,
            p_gorem_measher_mishni NUMBER,
            p_rows_affected out NUMBER);
PROCEDURE update_shat_letashlum(p_mispar_ishi NUMBER,
            p_taarich DATE,p_mispar_sidur NUMBER,p_shat_hatchala DATE);
PROCEDURE get_general_population(p_taarich DATE,p_Cur OUT CurType);
PROCEDURE get_mu_lelo_nahagut_population(p_taarich DATE,p_Cur OUT CurType);
PROCEDURE get_retro_population( p_bakasha_id number,p_Cur OUT CurType);
PROCEDURE get_musach_population(p_taarich DATE,p_Cur OUT CurType);
PROCEDURE get_erech_meafyen(p_mispar_ishi NUMBER, p_taarich DATE,p_Cur OUT CurType);
PROCEDURE get_approval_to_emploee(p_mispar_ishi IN TB_Ishurim.mispar_ishi%type,
                                                                       p_taarich  IN TB_Ishurim.taarich%type,
                                                                       p_Cur OUT CurType) ;
FUNCTION fn_is_oved_musach(p_mispar_ishi IN tb_sidurim_ovdim.mispar_ishi%type,
                           p_date  IN tb_sidurim_ovdim.taarich%type) return number;
PROCEDURE update_ritzat_ishurim_acharona(p_mispar_ishi IN tb_yamey_avoda_ovdim.mispar_ishi%type,
                           p_date  IN tb_yamey_avoda_ovdim.taarich%type);
procedure get_hevrot_lelo_ishurim_leoved(p_mispar_ishi IN tb_yamey_avoda_ovdim.mispar_ishi%type, 
                           p_date in date , p_Cur OUT CurType);
END PKG_APPROVALS;
/

CREATE OR REPLACE PACKAGE BODY          PKG_APPROVALS AS

  PROCEDURE get_approval_details(p_kod_ishur NUMBER,p_rama NUMBER,
  p_kod_tafkid NUMBER,
  p_Cur OUT CurType) AS
  BEGIN
   OPEN p_Cur FOR
    select i.kod_ishur,i.teur_ishur,tm.kod_tafkid_measher,i.kod_sug_ishur,r.pail tafkid_pail,
    i.meakev_tashlum,tm.sug_peilut,i.ishur_menahel_musach,
    decode(tm.kod_tafkid_measher,2,1,10,1,0) sug_peilut_advanced, I.EGGED_TAAVORA, 
    I.PAIL
    from ctb_ishurim i,ctb_ramot_ishurim r, ctb_tfkidim_meashrim tm
    WHERE i.kod_ishur=r.kod_ishur
    and i.kod_ishur=p_kod_ishur
    and r.rama=p_rama
    and decode(p_kod_tafkid,0,r.kod_tafkid_measher,p_kod_tafkid)=tm.kod_tafkid_measher;
 
  END get_approval_details;

PROCEDURE get_approval_request(p_mispar_ishi NUMBER,p_kod_ishur NUMBER,
            p_taarich DATE,p_mispar_sidur NUMBER,p_shat_hatchala DATE,
            p_shat_yetzia DATE,p_mispar_knisa NUMBER,p_rama NUMBER,p_erech_mevukash NUMBER,
            p_erech_mevukash2 NUMBER,p_Cur OUT CurType) AS
   BEGIN
    OPEN p_Cur FOR
    select mispar_ishi,kod_ishur,taarich,mispar_sidur,shat_hatchala,
      shat_yetzia,mispar_knisa ,KOD_STATUS_ISHUR,rama,erech_mevukash,
      erech_meushar,heara,erech_mevukash2,siba
      from tb_ishurim
      where mispar_ishi=p_mispar_ishi
      and kod_ishur=p_kod_ishur
      and taarich= p_taarich
      and mispar_sidur= p_mispar_sidur
      and shat_hatchala= p_shat_hatchala
      and shat_yetzia= p_shat_yetzia
      and (rama=p_rama or p_rama is null)
      and erech_mevukash=p_erech_mevukash
          and erech_mevukash2=p_erech_mevukash2;

  END get_approval_request;

  PROCEDURE add_approval_request(p_mispar_ishi NUMBER,p_kod_ishur NUMBER,
            p_taarich DATE,p_mispar_sidur NUMBER,p_shat_hatchala DATE,
            p_shat_yetzia DATE,p_mispar_knisa NUMBER,p_measher_rashi NUMBER,
            p_measher_mishni NUMBER,p_status NUMBER,p_rama NUMBER,
            p_erech_mevukash NUMBER, p_erech_mevukash2 NUMBER,
            p_erech_meushar NUMBER,p_siba VARCHAR2,
            p_heara VARCHAR2 default null,
            p_gorem_nosaf NUMBER default 0) as
  BEGIN
    INSERT into tb_ishurim(mispar_ishi, kod_ishur, taarich, mispar_sidur,
      shat_hatchala, shat_yetzia, mispar_knisa, gorem_measher_rashsi,
      gorem_measher_mishni,  taarich_bakashat_ishur, kod_status_ishur,rama,
      erech_meushar, erech_mevukash,erech_mevukash2, siba,meadken_acharon,heara,gorem_nosaf)
      values(p_mispar_ishi, p_kod_ishur, p_taarich, p_mispar_sidur, p_shat_hatchala,
      p_shat_yetzia, p_mispar_knisa, p_measher_rashi, p_measher_mishni,
       sysdate,p_status,p_rama, p_erech_meushar, p_erech_mevukash,p_erech_mevukash2, p_siba,-1,p_heara, p_gorem_nosaf);
  END add_approval_request;

PROCEDURE update_erech_mevukash(p_mispar_ishi NUMBER,p_kod_ishur NUMBER,
            p_taarich DATE,p_mispar_sidur NUMBER,p_shat_hatchala DATE,
            p_shat_yetzia DATE,p_mispar_knisa NUMBER,p_rama NUMBER,
            p_erech_mevukash NUMBER,p_erech_mevukash2 NUMBER,
            p_new_erech_mevukash NUMBER,p_new_erech_mevukash2 NUMBER,p_rows_affected out NUMBER) as 
 begin 
    update tb_ishurim
            set
            erech_mevukash= p_new_erech_mevukash,
            erech_mevukash2=p_new_erech_mevukash2
          where mispar_ishi=p_mispar_ishi
          and kod_ishur= p_kod_ishur
          and taarich= p_taarich
          and mispar_sidur= p_mispar_sidur
          and shat_hatchala= p_shat_hatchala
          and shat_yetzia = p_shat_yetzia
          and mispar_knisa = p_mispar_knisa
          and rama= p_rama
          and erech_mevukash=p_erech_mevukash
          and erech_mevukash2=p_erech_mevukash2;
          p_rows_affected:=SQL%ROWCOUNT;
 END update_erech_mevukash;
  PROCEDURE get_approval_requests_dates(p_mispar_ishi NUMBER,p_Cur OUT CurType) as
    BEGIN
       OPEN p_Cur FOR
        Select distinct  to_char(taarich,'MM/yyyy')  request_month
                From ( SELECT TB.taarich from TB_Ishurim TB
                Where  TB.gorem_measher_rashsi= p_mispar_ishi
                    OR Gorem_Measher_Mishni= p_mispar_ishi )
                    order by to_date(request_month,'mm/yyyy')  desc;
  END get_approval_requests_dates;

  PROCEDURE get_approval_statuses(p_Cur OUT CurType) as
    BEGIN
    OPEN p_cur FOR
    select s.kod_status_ishur,s.teur_status_ishur
    from CTB_Status_Ishurim s
    order by teur_status_ishur;
  END get_approval_statuses;

  PROCEDURE get_all_approval_requests(p_mispar_ishi NUMBER,p_status NUMBER,p_additional_status NUMBER,
            p_month NUMBER,p_year NUMBER,p_Cur OUT CurType) as
    BEGIN
    OPEN p_cur FOR

    Select TB.Mispar_Ishi, O.SHEM_MISH  || '  '||  O.SHEM_PRAT SHEM, CTB. Teur_Ishur, TB. Taarich,
        TB. Mispar_Sidur, TB.Shat_hatchala ,TB. Shat_yetzia, TB. Mispar_Knisa  ,
        TB.Taarich_Bakashat_Ishur , SI. Teur_Status_Ishur, TB.Heara, TB. Kod_Ishur,
        tb.kod_status_ishur,tb.rama,nvl(tb2.Kod_Status_Ishur,0) Next_level_status,
        nvl(tb.kod_tafkid_measher_nosaf,-1) kod_tafkid_measher_nosaf,bk.bakasha_id,
        tb3.Gorem_Measher_Rashsi mispar_ishi_nosaf, O1.SHEM_MISH  || '  '||  O1.SHEM_PRAT SHEM_NOSAF,
        si1.Teur_Status_Ishur Status_Ishur_nosaf,tb3.heara heara_nosaf,
        TB3.TAARICH_BAKASHAT_ISHUR taarich_ishur_nosaf,
        tb4.Gorem_Measher_Rashsi mispar_ishi_makor, O2.SHEM_MISH  || '  '||  O2.SHEM_PRAT SHEM_makor,
        si2.Teur_Status_Ishur Status_Ishur_makor,tb4.heara heara_makor,
        TB4.TAARICH_BAKASHAT_ISHUR taarich_ishur_makor,tb.erech_mevukash,tb.erech_mevukash2
          From TB_Ishurim TB, CTB_Ishurim CTB, CTB_Status_Ishurim SI,  Ovdim O,
            tb_ishurim TB2,tb_ishurim TB3, tb_ishurim TB4,ovdim o1,CTB_Status_Ishurim SI1,
            ovdim o2,CTB_Status_Ishurim SI2,
            (select mispar_ishi,taarich, bakasha_id
              from(
              select ch.mispar_ishi,ch.taarich, ch.bakasha_id,
              bk.taarich_haavara_lesachar,
              max(taarich_haavara_lesachar)  OVER (PARTITION BY mispar_ishi,taarich )  max_date
              from
              (select DISTINCT mispar_ishi,taarich,bakasha_id from tb_chishuv_chodesh_ovdim  ) ch,
              tb_bakashot bk
              where ch.bakasha_id=bk.bakasha_id
              and bk.huavra_lesachar=1)
              where taarich_haavara_lesachar=max_date) bk

          Where TB. Kod_Ishur=CTB. Kod_Ishur
          and tb.mispar_ishi= o.mispar_ishi
          And TB.Kod_Status_Ishur=SI. Kod_Status_Ishur
          And (TB.Gorem_Measher_Rashsi=p_mispar_ishi
                OR tb.Gorem_Measher_Mishni=p_mispar_ishi)
                and (TB. Kod_Status_Ishur = p_status or TB. Kod_Status_Ishur=p_additional_status 
                        or p_status is  NULL)
           and  (p_month is null or (to_number(to_char(TB.taarich,'MM')) = p_month
            and to_number(to_char(TB.taarich,'yyyy')) = p_year))
            and tb.Mispar_Ishi=tb2.Mispar_Ishi(+)
            and tb.Taarich=tb2.Taarich(+)
            and tb.kod_ishur=tb2.kod_ishur(+)
            and tb.Mispar_Sidur=tb2.Mispar_Sidur(+)
            and tb.Shat_hatchala=tb2.Shat_hatchala(+)
            and tb.Shat_yetzia=tb2.Shat_yetzia(+)
            and tb.Mispar_Knisa=tb2.Mispar_Knisa(+)
            and tb.erech_mevukash=tb2.erech_mevukash(+)
            and tb.erech_mevukash2=tb2.erech_mevukash2(+)
            and tb.rama+1=tb2.rama(+)
            and tb.Mispar_Ishi=tb3.Mispar_Ishi(+)
            and tb.Taarich=tb3.Taarich(+)
            and tb.kod_ishur=tb3.kod_ishur(+)
            and tb.Mispar_Sidur=tb3.Mispar_Sidur(+)
            and tb.Shat_hatchala=tb3.Shat_hatchala(+)
            and tb.Shat_yetzia=tb3.Shat_yetzia(+)
            and tb.Mispar_Knisa=tb3.Mispar_Knisa(+)
            and tb.erech_mevukash=tb3.erech_mevukash(+)
            and tb.erech_mevukash2=tb3.erech_mevukash2(+)
            and tb.rama*10=tb3.rama(+)
            and tb3.Gorem_Measher_Rashsi=o1.mispar_ishi(+)
            and TB3.KOD_STATUS_ISHUR=SI1.KOD_STATUS_ISHUR(+)
            and tb.Taarich=tb4.Taarich(+)
            and tb.kod_ishur=tb4.kod_ishur(+)
            and tb.Mispar_Sidur=tb4.Mispar_Sidur(+)
            and tb.Shat_hatchala=tb4.Shat_hatchala(+)
            and tb.Shat_yetzia=tb4.Shat_yetzia(+)
            and tb.Mispar_Knisa=tb4.Mispar_Knisa(+)
            and tb.erech_mevukash=tb4.erech_mevukash(+)
            and tb.erech_mevukash2=tb4.erech_mevukash2(+)
            and tb.rama/10=tb4.rama(+)
            and tb4.Gorem_Measher_Rashsi=o2.mispar_ishi(+)
            and TB4.KOD_STATUS_ISHUR=SI2.KOD_STATUS_ISHUR(+)
            and tb.mispar_ishi=bk.mispar_ishi(+)
            and Last_Day(ADD_MONTHS(tb.taarich,-1))+1=bk.taarich(+)
            and (TB. Kod_Ishur<>35 or tb.rama=1)
          order by SHEM,Taarich;
  END get_all_approval_requests;

  PROCEDURE get_approval_codes(p_Cur OUT CurType) as
  begin
     OPEN p_cur FOR
      select kod_ishur,teur_ishur, mafne_lesade FROM ctb_ishurim
      order by teur_ishur;
  end get_approval_codes;

  PROCEDURE get_approval_jobs(p_Cur OUT CurType) as
    BEGIN
      OPEN p_cur for
        Select Teur_Tafkid_Measher,Kod_Tafkid_Measher
        From CTB_Tfkidim_Meashrim
       order by Teur_Tafkid_Measher;
  end get_approval_jobs;

  PROCEDURE get_factors_from_meashrim(p_mispar_ishi NUMBER, p_taarich DATE,
          p_Cur OUT CurType) as
    BEGIN
    OPEN p_cur FOR
      Select m.menahel_yashir menahel_yashir_rashi,null menahel_yashir_mishni
      from meashrim m
      where m.mispar_ishi=p_mispar_ishi
      and p_taarich between m.me_taarich and m.ad_taarich;
    end get_factors_from_meashrim;

  PROCEDURE get_employee_details(p_mispar_ishi NUMBER, p_taarich DATE,
      p_Cur OUT CurType) as
    begin
    OPEN p_cur FOR
    Select  Erech,
          Kod_Natun,o.kod_hevra
       From ovdim o,
       (select * from Pirtey_Ovdim po Where  po.Mispar_ishi=p_mispar_ishi
        and p_taarich between po.me_taarich AND nvl(po.ad_taarich,p_taarich)
        and po.Kod_Natun in (3,4,1)) po
      Where 
        o.mispar_ishi=p_mispar_ishi
        and o.mispar_ishi=po.mispar_ishi(+);
  end get_employee_details;

  PROCEDURE change_approval_request_status(p_mispar_ishi NUMBER,p_kod_ishur NUMBER,
            p_taarich DATE,p_mispar_sidur NUMBER,p_shat_hatchala DATE,
            p_shat_yetzia DATE,p_mispar_knisa NUMBER,p_status NUMBER,p_rama NUMBER,
            p_erech_mevukash NUMBER,p_erech_mevukash2 NUMBER,
            p_heara VARCHAR2,p_erech_meushar NUMBER,p_meadken_acharon number,  p_rows_affected out NUMBER) AS
            begin
          update tb_ishurim
            set kod_status_ishur= p_status,
            heara= p_heara,
            erech_meushar= p_erech_meushar,
            meadken_acharon=p_meadken_acharon
          where mispar_ishi=p_mispar_ishi
          and kod_ishur= p_kod_ishur
          and taarich= p_taarich
          and mispar_sidur= p_mispar_sidur
          and shat_hatchala= p_shat_hatchala
          and shat_yetzia = p_shat_yetzia
          and mispar_knisa = p_mispar_knisa
          and rama= p_rama
          and erech_mevukash=p_erech_mevukash
          and erech_mevukash2=p_erech_mevukash2;
          p_rows_affected:=SQL%ROWCOUNT;
         --delete approval request forwarded to next level
          if p_status=2 then
            delete tb_ishurim
              where mispar_ishi=p_mispar_ishi
                and kod_ishur= p_kod_ishur
                and taarich= p_taarich
                and mispar_sidur= p_mispar_sidur
                and shat_hatchala= p_shat_hatchala
                and shat_yetzia = p_shat_yetzia
                and mispar_knisa = p_mispar_knisa
                and rama= p_rama+1;
          end if;
 end change_approval_request_status;

 PROCEDURE update_approval_request_remark(p_mispar_ishi NUMBER,p_kod_ishur NUMBER,
            p_taarich DATE,p_mispar_sidur NUMBER,p_shat_hatchala DATE,
            p_shat_yetzia DATE,p_mispar_knisa NUMBER,p_rama NUMBER,
            p_erech_mevukash NUMBER,p_erech_mevukash2 NUMBER,
            p_heara VARCHAR2,p_rows_affected out NUMBER) as
  begin
      update tb_ishurim
            set
            heara= p_heara
          where mispar_ishi=p_mispar_ishi
          and kod_ishur= p_kod_ishur
          and taarich= p_taarich
          and mispar_sidur= p_mispar_sidur
          and shat_hatchala= p_shat_hatchala
          and shat_yetzia = p_shat_yetzia
          and mispar_knisa = p_mispar_knisa
          and rama= p_rama
          and erech_mevukash=p_erech_mevukash
          and erech_mevukash2=p_erech_mevukash2;
          p_rows_affected:=SQL%ROWCOUNT;
  end update_approval_request_remark;

 PROCEDURE check_approval_max_rama(p_kod_ishur NUMBER, p_max_rama out  NUMBER) as
  begin
  select max(r.rama) into p_max_rama
  from ctb_ramot_ishurim r
  where r.kod_ishur=p_kod_ishur;
 end check_approval_max_rama;

 PROCEDURE set_approval_forward_data(p_mispar_ishi NUMBER,p_kod_ishur NUMBER,
            p_taarich DATE,p_mispar_sidur NUMBER,p_shat_hatchala DATE,
            p_shat_yetzia DATE,p_mispar_knisa NUMBER,p_rama NUMBER,
            p_erech_mevukash NUMBER,p_erech_mevukash2 NUMBER,
            p_kod_status_ishur NUMBER,
            p_kod_tafkid_nosaf NUMBER,p_gorem_nosaf NUMBER,p_meadken_acharon NUMBER) as
  begin
    update tb_ishurim
            set kod_status_ishur= p_kod_status_ishur,
            kod_tafkid_measher_nosaf= p_kod_tafkid_nosaf,
            gorem_measher_nosaf= p_gorem_nosaf,
            meadken_acharon=p_meadken_acharon
          where mispar_ishi=p_mispar_ishi
          and kod_ishur= p_kod_ishur
          and taarich= p_taarich
          and mispar_sidur= p_mispar_sidur
          and shat_hatchala= p_shat_hatchala
          and shat_yetzia = p_shat_yetzia
          and mispar_knisa = p_mispar_knisa
          and rama= p_rama
          and erech_mevukash=p_erech_mevukash
          and erech_mevukash2=p_erech_mevukash2;
 end set_approval_forward_data;

 PROCEDURE get_matching_approval_requests(p_mispar_ishi NUMBER,  p_taarich DATE,
            p_Cur OUT CurType) as
  begin
    OPEN p_cur FOR
/* to do - remove default null parameters*/
 select  mispar_ishi, kod_ishur,taarich, mispar_sidur, shat_hatchala,
    shat_yetzia, mispar_knisa ,rama ,kod_status_ishur,erech_mevukash,erech_mevukash2
  from
   (select distinct t.mispar_ishi, t.kod_ishur,taarich, t.mispar_sidur, t.shat_hatchala,
         t.shat_yetzia, t.mispar_knisa  ,t.rama,t.kod_status_ishur,t.erech_mevukash,t.erech_mevukash2,
          max(t.rama) KEEP (DENSE_RANK LAST ORDER BY t.rama )
            OVER (PARTITION BY t.mispar_ishi,taarich ) max_f4
          from tb_ishurim t
        )
       where max_f4=rama
       and  mispar_ishi= p_mispar_ishi
       and taarich= p_taarich;
 end get_matching_approval_requests;

 PROCEDURE get_similar_approval_requests(p_mispar_ishi NUMBER,  p_taarich DATE,
            p_kod_ishur NUMBER,p_mispar_sidur NUMBER,  p_shat_hatchala DATE,
            p_shat_yetzia DATE,p_mispar_knisa NUMBER,
            p_Cur OUT CurType) as
  begin
    OPEN p_cur FOR

 select  mispar_ishi, kod_ishur,taarich, mispar_sidur, shat_hatchala,
    shat_yetzia, mispar_knisa ,rama ,kod_status_ishur,erech_mevukash,erech_mevukash2
  from
   (select distinct t.mispar_ishi, t.kod_ishur,taarich, t.mispar_sidur, t.shat_hatchala,
         t.shat_yetzia, t.mispar_knisa  ,t.rama,t.kod_status_ishur,t.erech_mevukash,t.erech_mevukash2,
          max(t.rama) KEEP (DENSE_RANK LAST ORDER BY t.rama )
            OVER (PARTITION BY t.mispar_ishi,taarich,mispar_sidur,shat_hatchala,shat_yetzia,
            mispar_knisa,erech_mevukash,erech_mevukash2) max_f4
          from tb_ishurim t
          where gorem_nosaf=0
        )
       where max_f4=rama
       and  mispar_ishi= p_mispar_ishi
       and taarich= p_taarich
       and  kod_ishur=nvl(p_kod_ishur,kod_ishur)
       and  mispar_sidur=nvl(p_mispar_sidur,mispar_sidur)
       and  shat_hatchala=nvl(p_shat_hatchala,shat_hatchala)
       and  shat_yetzia=nvl(p_shat_yetzia,shat_yetzia)
       and  mispar_knisa=nvl(p_mispar_knisa,mispar_knisa);
 end get_similar_approval_requests;

 PROCEDURE get_snif_tnua_and_ezor(p_mispar_ishi NUMBER,
            p_taarich DATE,p_mispar_sidur NUMBER,p_shat_hatchala DATE,
            p_shat_yetzia DATE,p_mispar_knisa NUMBER, p_Cur OUT CurType) as
  begin
   OPEN p_Cur FOR
    select sn.kod_snif_av  snif_tnua, sn.ezor, SN.KOD_HEVRA
    from tb_peilut_ovdim p, ctb_snif_av sn
    where    mispar_ishi=p_mispar_ishi
          and taarich= p_taarich
          and mispar_sidur= p_mispar_sidur
          and shat_hatchala_sidur= p_shat_hatchala
          and shat_yetzia = p_shat_yetzia
          and mispar_knisa = p_mispar_knisa
          and p.snif_tnua=sn.snif_tnua;
 end get_snif_tnua_and_ezor;


PROCEDURE get_snif_tnua_hevrot_lelo_ish(p_mispar_ishi NUMBER,
            p_taarich DATE,p_mispar_sidur NUMBER,p_shat_hatchala DATE,
            p_shat_yetzia DATE,p_mispar_knisa NUMBER, p_Cur OUT CurType) as
 begin
    OPEN p_Cur FOR
    select sn.kod_snif_av  snif_tnua, sn.ezor, SN.KOD_HEVRA
    from tb_peilut_ovdim p, 
         ctb_snif_av sn,
         tb_hevrot_lelo_ishurim h
    where    mispar_ishi=p_mispar_ishi
          and taarich= p_taarich
          and mispar_sidur= p_mispar_sidur
          and shat_hatchala_sidur= p_shat_hatchala
          and shat_yetzia = p_shat_yetzia
          and mispar_knisa = p_mispar_knisa
          and p.snif_tnua=sn.snif_tnua
          and p_taarich between H.ME_TAARICH and nvl(H.AD_TAARICH,p_taarich+1)
          and SN.KOD_HEVRA=H.KOD_HEVRA;
end get_snif_tnua_hevrot_lelo_ish;
            
PROCEDURE update_lo_letashlum(p_mispar_ishi NUMBER,
            p_taarich DATE,p_mispar_sidur NUMBER,p_shat_hatchala DATE,
            p_value NUMBER,
            p_kod_siba NUMBER default null) as
  begin
    update tb_sidurim_ovdim
    set lo_letashlum= p_value,
    kod_siba_lo_letashlum= p_kod_siba
      where    mispar_ishi=p_mispar_ishi
          and taarich= p_taarich
          and mispar_sidur= p_mispar_sidur
          and shat_hatchala= p_shat_hatchala;
end update_lo_letashlum;
PROCEDURE update_chariga(p_mispar_ishi NUMBER,
            p_taarich DATE,p_mispar_sidur NUMBER,p_shat_hatchala DATE,
            p_value NUMBER) as
    begin
        update tb_sidurim_ovdim
        set chariga= p_value
          where mispar_ishi=p_mispar_ishi
              and taarich= p_taarich
              and mispar_sidur= p_mispar_sidur
              and shat_hatchala= p_shat_hatchala;
            
end update_chariga;
PROCEDURE get_sidur_meuhad_approvals(p_taarich DATE, p_mispar_ishi NUMBER, p_Cur OUT CurType) as
  begin
    OPEN p_cur for
     /*
  kod:  7,8,9,11,12,13,14,16,17,18,19,20,22,
                  23,24,29,30,31,40
  */
      select sm.erech kod_ishur ,so.mispar_ishi,so.taarich,so.mispar_sidur,
        so.shat_hatchala,sm.kod_meafyen,
        so.shat_hatchala shat_yetzia, 0 mispar_knisa, nvl(so.menahel_musach_meadken,0) musach
      from tb_sidurim_ovdim so,
        tb_sidurim_meyuchadim sm,
        tb_yamey_avoda_ovdim ya,
        ctb_sibot_loletashlum sl
      where so.taarich=p_taarich
      and nvl(p_mispar_ishi,so.mispar_ishi)=so.mispar_ishi
      and so.mispar_ishi=ya.mispar_ishi
      and so.taarich=ya.taarich
      and ya.status=1
      and so.mispar_sidur=sm.mispar_sidur
      and so.taarich between sm.me_taarich and sm.ad_taarich
      and (sm.kod_meafyen =66 /*sidurim meuhadim*/
        or (sm.kod_meafyen=52 and sm.erech='2') /*sidurim meuhadim sport*/
        or (sm.kod_meafyen=52 and sm.erech='4') /*sidurim meuhadim kaitana*/
        or (sm.kod_meafyen=45 and sm.erech='1')) /*sidurim meuhadim visa zvait*/
      and  (sm.erech not in ( '8')
               or nvl(so.kod_siba_ledivuch_yadani_in,0) <>0
               or nvl(so.kod_siba_ledivuch_yadani_out,0)<>0) /*for codes 8 chekc if kod_siba_ledivuch_yadani exists*/
      and so.kod_siba_lo_letashlum=sl.kod_siba(+)
      and( nvl(so.lo_letashlum,0)=0 or sl.lebdikat_ishurim=1)
     and nvl(so.bitul_o_hosafa,0) not in(1,3) --canceled sidur
           
      /*visa hofhsit kod:23*/
       union  select '23' kod_ishur,so.mispar_ishi,so.taarich,so.mispar_sidur,
        so.shat_hatchala,-1 kod_meafyen,so.shat_hatchala shat_yetzia, 0 mispar_knisa,
        nvl(so.menahel_musach_meadken,0) musach
      from tb_sidurim_ovdim so, ctb_sug_visa_hofshit vh, tb_yamey_avoda_ovdim ya,
      ctb_sibot_loletashlum sl
      where so.taarich=p_taarich
      and nvl(p_mispar_ishi,so.mispar_ishi)=so.mispar_ishi
       and so.mispar_ishi=ya.mispar_ishi
      and so.taarich=ya.taarich
      and ya.status=1
      and so.sug_hazmanat_visa= vh.kod_visa
       and so.kod_siba_lo_letashlum=sl.kod_siba(+)
      and( nvl(so.lo_letashlum,0)=0 or sl.lebdikat_ishurim=1)
      and nvl(so.bitul_o_hosafa,0) not in(1,3) --canceled sidur
      
      /*mehuzt le michsat shaot nosafot kod:48*/
      union select '48' kod_ishur,so.mispar_ishi,so.taarich,so.mispar_sidur,
        so.shat_hatchala,sm.kod_meafyen,
        so.shat_hatchala shat_yetzia, 0 mispar_knisa, nvl(so.menahel_musach_meadken,0) musach
      from tb_sidurim_ovdim so,
        tb_sidurim_meyuchadim sm,
        tb_yamey_avoda_ovdim ya,
        ctb_sibot_loletashlum sl
      where so.taarich=p_taarich
        and nvl(p_mispar_ishi,so.mispar_ishi)=so.mispar_ishi
        and so.mispar_ishi=ya.mispar_ishi
        and so.taarich=ya.taarich
        and ya.status=1
        and so.mispar_sidur=sm.mispar_sidur
        and so.taarich between sm.me_taarich and sm.ad_taarich
        and so.out_michsa=1
        and sm.kod_meafyen=25 and sm.erech='1'
        and( nvl(so.lo_letashlum,0)=0 or sl.lebdikat_ishurim=1)
        and so.kod_siba_lo_letashlum=sl.kod_siba(+)
        and nvl(so.bitul_o_hosafa,0) not in(1,3); --canceled sidur
        
  end get_sidur_meuhad_approvals;

PROCEDURE get_sidur_matala_approvals(p_taarich DATE, p_mispar_ishi NUMBER, p_Cur OUT CurType) is 
    v_count  number;
    rc number;
begin
  /*
kod:  15
*/
 /*sidur matala*/
    
    /*get data from katalog tnua*/
  SELECT DISTINCT count(po.mispar_ishi) into v_count
    FROM tb_sidurim_ovdim o,tb_peilut_ovdim po
    WHERE o.mispar_ishi = po.mispar_ishi
          AND o.taarich = po.taarich
          AND o.mispar_sidur= po.mispar_sidur
          AND o.shat_hatchala = po.shat_hatchala_sidur
          AND o.mispar_ishi=p_mispar_ishi
          AND trunc(o.taarich) =p_taarich;

     IF (v_count>0) THEN
    BEGIN
       INSERT INTO TMP_CATALOG_DETAILS@kds_gw_at_tnpr
                              (activity_date,makat8)
       SELECT distinct po.TAARICH ,po.MAKAT_NESIA
       FROM tb_sidurim_ovdim o,tb_peilut_ovdim po
       WHERE o.mispar_ishi = po.mispar_ishi
          AND o.taarich = po.taarich
          AND o.mispar_sidur= po.mispar_sidur
          AND o.shat_hatchala = po.shat_hatchala_sidur
          AND o.mispar_ishi=p_mispar_ishi
          AND trunc(o.taarich) =p_taarich;

       EXCEPTION
              WHEN DUP_VAL_ON_INDEX THEN
                   NULL;
     END;
     BEGIN
        --Get makats details
      kds_catalog_pack.GetKavimDetails@kds_gw_at_tnpr(rc);

     END;
    END IF;
   
    OPEN p_cur for
        select '15' kod_ishur,so.mispar_ishi,so.taarich,so.mispar_sidur,
        so.shat_hatchala,-1 kod_meafyen,so.shat_hatchala shat_yetzia, 0 mispar_knisa,
        nvl(so.menahel_musach_meadken,0) musach
      from tb_sidurim_ovdim so, tb_peilut_ovdim po, tb_yamey_avoda_ovdim ya,
      ctb_sibot_loletashlum sl,
      TMP_CATALOG_DETAILS@kds_gw_at_tnpr cd
      where so.taarich=p_taarich
      and nvl(p_mispar_ishi,so.mispar_ishi)=so.mispar_ishi
       and so.mispar_ishi=ya.mispar_ishi
      and so.taarich=ya.taarich
      and ya.status=1
      and so.mispar_ishi=po.mispar_ishi
      and so.taarich=po.taarich
      and so.mispar_sidur=po.mispar_sidur
      and  so.shat_hatchala= po.shat_hatchala_sidur
      and po.mispar_matala<1000 and po.mispar_matala>0
       and so.kod_siba_lo_letashlum=sl.kod_siba(+)
      and( nvl(so.lo_letashlum,0)=0 or sl.lebdikat_ishurim=1)
      and nvl(so.bitul_o_hosafa,0) not in(1,3) --canceled sidur
      and po.taarich=cd.activity_date(+)
      and po.makat_nesia=cd.makat8(+)
      and (  nvl(po.makat_nesia,0)=0 
              or substr(lpad(po.makat_nesia,8,'0'),1,1) in ('5','7')
              or ( substr(lpad(po.makat_nesia,8,'0'),1,1) = '6'  and cd.mazan_tichnun>20 ));
                   
end get_sidur_matala_approvals;

  PROCEDURE get_harigot_shaon(p_taarich DATE,p_mispar_ishi NUMBER, p_Cur OUT CurType)  as
  begin
  /*
kod:  1,3,2,4,36,101,102,301,302
*/
     OPEN p_cur for
     /* hoser divuach*/
      select
        decode(lower(ye.sug_yechida),'m_me','3','m_ms','3','1') kod_ishur,
        so.mispar_ishi,so.taarich,so.mispar_sidur,
        so.shat_hatchala,
        so.shat_hatchala shat_yetzia, 0 mispar_knisa,
        nvl(so.menahel_musach_meadken,0) musach,to_number(to_char(so.shat_hatchala,'hh24mi')) erech_mevukash,
        to_number(to_char(so.shat_gmar,'hh24mi')) erech_mevukash2
      from tmp_pirtey_ovdim pto,
                ovdim o,
                tb_sidurim_ovdim so,
                ctb_yechida ye,
                tb_yamey_avoda_ovdim ya,
                ctb_sibot_ledivuch_yadani sly,
                ctb_sibot_ledivuch_yadani sly1,
                ctb_sibot_loletashlum sl,
                tb_sidurim_meyuchadim sm           
      where so.taarich=p_taarich
      and nvl(p_mispar_ishi,so.mispar_ishi)=so.mispar_ishi
       and so.mispar_ishi=ya.mispar_ishi
      and so.taarich=ya.taarich
      and ya.status=1
      and so.mispar_ishi=pto.mispar_ishi
      and so.mispar_ishi=o.mispar_ishi
      and so.taarich between pto.me_tarich and nvl(pto.ad_tarich,sysdate+1000)
      and ye.kod_hevra=o.kod_hevra
      and ye.kod_yechida=pto.yechida_irgunit
      and so.KOD_SIBA_LEDIVUCH_YADANI_IN=sly.kod_siba
      and so.KOD_SIBA_LEDIVUCH_YADANI_OUT=sly1.kod_siba
      and sly.doresh_ishur<>0
     and sly1.doresh_ishur<>0
     and so.mispar_sidur<>HARIGOT_SHAON_SIDUR_EXCLUDE
      and so.kod_siba_lo_letashlum=sl.kod_siba(+)
      and( nvl(so.lo_letashlum,0)=0 or sl.lebdikat_ishurim=1)
      and nvl(so.bitul_o_hosafa,0) not in(1,3) --canceled sidur
      and lpad(so.mispar_sidur,2)='99'
      and so.mispar_sidur=sm.mispar_sidur
      and so.taarich between sm.me_taarich and sm.ad_taarich
      and sm.kod_meafyen =54  and nvl(sm.erech,'0')<>'0'
      
       union select
        decode(lower(ye.sug_yechida),'m_me','301','m_ms','301','101') kod_ishur,
        so.mispar_ishi,so.taarich,so.mispar_sidur,
        so.shat_hatchala,
        so.shat_hatchala shat_yetzia, 0 mispar_knisa,
        nvl(so.menahel_musach_meadken,0) musach,
        to_number(to_char(so.shat_hatchala,'hh24mi')) erech_mevukash,
        null erech_mevukash2
      from tmp_pirtey_ovdim pto,
                ovdim o,
                tb_sidurim_ovdim so,
                ctb_yechida ye,
                tb_yamey_avoda_ovdim ya,
                ctb_sibot_ledivuch_yadani sly,
                ctb_sibot_loletashlum sl,
                tb_sidurim_meyuchadim sm    
      where so.taarich=p_taarich
      and nvl(p_mispar_ishi,so.mispar_ishi)=so.mispar_ishi
       and so.mispar_ishi=ya.mispar_ishi
      and so.taarich=ya.taarich
      and ya.status=1
      and so.mispar_ishi=pto.mispar_ishi
      and so.mispar_ishi=o.mispar_ishi
      and so.taarich between pto.me_tarich and nvl(pto.ad_tarich,sysdate+1000)
      and ye.kod_hevra=o.kod_hevra
      and ye.kod_yechida=pto.yechida_irgunit
      and so.KOD_SIBA_LEDIVUCH_YADANI_IN=sly.kod_siba
      and nvl(so.KOD_SIBA_LEDIVUCH_YADANI_OUT,0)=0
      and sly.doresh_ishur<>0
      and so.mispar_sidur<>HARIGOT_SHAON_SIDUR_EXCLUDE
       and so.kod_siba_lo_letashlum=sl.kod_siba(+)
      and( nvl(so.lo_letashlum,0)=0 or sl.lebdikat_ishurim=1)
      and nvl(so.bitul_o_hosafa,0) not in(1,3) --canceled sidur 
      and lpad(so.mispar_sidur,2)='99'
      and so.mispar_sidur=sm.mispar_sidur
      and so.taarich between sm.me_taarich and sm.ad_taarich
      and sm.kod_meafyen =54  and nvl(sm.erech,'0')<>'0'
      
       union select
        decode(lower(ye.sug_yechida),'m_me','302','m_ms','302','102') kod_ishur,
        so.mispar_ishi,so.taarich,so.mispar_sidur,
        so.shat_hatchala,
        so.shat_hatchala shat_yetzia, 0 mispar_knisa,
        nvl(so.menahel_musach_meadken,0) musach,null erech_mevukash,
        to_number(to_char(so.shat_gmar,'hh24mi')) erech_mevukash2
      from tmp_pirtey_ovdim pto,
                ovdim o,
                tb_sidurim_ovdim so,
                ctb_yechida ye,
                tb_yamey_avoda_ovdim ya,
                 ctb_sibot_ledivuch_yadani sly,
                 ctb_sibot_loletashlum sl,
                 tb_sidurim_meyuchadim sm    
      where so.taarich=p_taarich
      and nvl(p_mispar_ishi,so.mispar_ishi)=so.mispar_ishi
       and so.mispar_ishi=ya.mispar_ishi
      and so.taarich=ya.taarich
      and ya.status=1
      and so.mispar_ishi=pto.mispar_ishi
      and so.mispar_ishi=o.mispar_ishi
      and so.taarich between pto.me_tarich and nvl(pto.ad_tarich,sysdate+1000)
      and ye.kod_hevra=o.kod_hevra
      and ye.kod_yechida=pto.yechida_irgunit
      and so.KOD_SIBA_LEDIVUCH_YADANI_OUT=sly.kod_siba
      and nvl(so.KOD_SIBA_LEDIVUCH_YADANI_IN,0) =0
      and sly.doresh_ishur<>0
      and so.mispar_sidur<>HARIGOT_SHAON_SIDUR_EXCLUDE
      and so.kod_siba_lo_letashlum=sl.kod_siba(+)
      and( nvl(so.lo_letashlum,0)=0 or sl.lebdikat_ishurim=1)
      and nvl(so.bitul_o_hosafa,0) not in(1,3) --canceled sidur
      and lpad(so.mispar_sidur,2)='99'
      and so.mispar_sidur=sm.mispar_sidur
      and so.taarich between sm.me_taarich and sm.ad_taarich
      and sm.kod_meafyen =54  and nvl(sm.erech,'0')<>'0'
      
         /* hariga divuach*/
        union select
        decode(lower(ye.sug_yechida),'m_me','4','m_ms','4','2') kod_ishur,
        so.mispar_ishi,so.taarich,so.mispar_sidur,
        so.shat_hatchala,
        so.shat_hatchala shat_yetzia, 0 mispar_knisa,
        nvl(so.menahel_musach_meadken,0) musach,so.chariga erech_mevukash,
        null erech_mevukash2
      from tmp_pirtey_ovdim pto,
                ovdim o,
                tb_sidurim_ovdim so,
                ctb_yechida ye,
                tb_yamey_avoda_ovdim ya,
                ctb_sibot_loletashlum sl
      where so.taarich=p_taarich
      and nvl(p_mispar_ishi,so.mispar_ishi)=so.mispar_ishi
       and so.mispar_ishi=ya.mispar_ishi
      and so.taarich=ya.taarich
      and ya.status=1
      and so.mispar_ishi=pto.mispar_ishi
      and so.mispar_ishi=o.mispar_ishi
      and so.taarich between pto.me_tarich and nvl(pto.ad_tarich,sysdate+1000)
      and ye.kod_hevra=o.kod_hevra
      and ye.kod_yechida=pto.yechida_irgunit
      and so.chariga<>0
      and so.kod_siba_lo_letashlum=sl.kod_siba(+)
      and( nvl(so.lo_letashlum,0)=0 or sl.lebdikat_ishurim=1)
      and nvl(so.bitul_o_hosafa,0) not in(1,3) --canceled sidur
      
      /*hatimat shaon bikoret*/
      union select
        '36' kod_ishur,
         so.mispar_ishi,so.taarich,so.mispar_sidur,
        so.shat_hatchala,
        so.shat_hatchala shat_yetzia, 0 mispar_knisa,
        nvl(so.menahel_musach_meadken,0) musach,null erech_mevukash, null erech_mevukash2
        from tb_sidurim_ovdim so, tb_yamey_avoda_ovdim ya,
          ctb_sibot_loletashlum sl
           where so.taarich=p_taarich
            and nvl(p_mispar_ishi,so.mispar_ishi)=so.mispar_ishi
            and so.mispar_ishi=ya.mispar_ishi
            and so.taarich=ya.taarich
            and ya.status=1
            and nvl(so.bitul_o_hosafa,0) not in(1,3) --canceled sidur
             and so.kod_siba_lo_letashlum=sl.kod_siba(+)
            and( nvl(so.lo_letashlum,0)=0 or sl.lebdikat_ishurim=1)
           and ((so.shat_hatchala is null and so.mikum_shaon_knisa is null
                      and nvl(so.kod_siba_ledivuch_yadani_in,0)=10) or
                      (so.shat_gmar is null and so.mikum_shaon_yetzia is null
                      and nvl(so.kod_siba_ledivuch_yadani_out,0)=10));
  end get_harigot_shaon;

  PROCEDURE get_nahag_sidur_tafkid(p_taarich DATE,p_mispar_ishi NUMBER, p_Cur OUT CurType) as
  /*
kod:  10
*/
  begin
    open p_Cur for
      select '10' kod_ishur,  so.mispar_ishi,so.taarich,so.mispar_sidur,
        so.shat_hatchala,
        so.shat_hatchala shat_yetzia, 0 mispar_knisa,
        nvl(so.menahel_musach_meadken,0) musach
      from
        tb_sidurim_ovdim so,
        tmp_pirtey_ovdim pto,
        tb_yamey_avoda_ovdim ya,
        ctb_sibot_loletashlum sl
        where so.taarich=p_taarich
         and nvl(p_mispar_ishi,so.mispar_ishi)=so.mispar_ishi
         and so.mispar_ishi=ya.mispar_ishi
         and so.taarich=ya.taarich
         and ya.status=1
         and so.mispar_ishi=pto.mispar_ishi
         and p_taarich between pto.me_tarich and nvl(pto.ad_tarich,sysdate+1000)
         and lpad(to_char(pto.isuk),1) ='5' /*isuk nahag*/
         and so.shat_hatchala is not null
         and so.shat_gmar is not null
         and so.chariga<>0
          and so.kod_siba_lo_letashlum=sl.kod_siba(+)
      and( nvl(so.lo_letashlum,0)=0 or sl.lebdikat_ishurim=1)
      and nvl(so.bitul_o_hosafa,0) not in(1,3) --canceled sidur
      and not exists (select 1 from tmp_meafyenim_Ovdim mo where mo.mispar_ishi= ya.mispar_ishi
            and ya.taarich  between mo.ME_TAARICH and nvl(mo.AD_TAARICH,to_date('01/01/9999','dd/mm/yyyy'))
            and mo.kod_meafyen in (3,4) and nvl(mo.erech_ishi,-1)<>-1); 
      
  end get_nahag_sidur_tafkid;

  procedure get_hashlama_approvals(p_taarich DATE,p_mispar_ishi NUMBER, p_Cur OUT CurType) as
  /*
kod:  32,39
*/
    begin
      open p_cur for
      select decode(ya.sibat_hashlama_leyom,5,'39',9,'39',1,'32') kod_ishur,
        ya.mispar_ishi,ya.taarich,0 mispar_sidur,
        ya.taarich shat_hatchala,
        ya.taarich shat_yetzia, 0 mispar_knisa,
        0 musach
      from tb_yamey_avoda_ovdim ya
      where ya.taarich=p_taarich
        and nvl(p_mispar_ishi,ya.mispar_ishi)=ya.mispar_ishi
        and ya.hashlama_leyom<>0 and ya.sibat_hashlama_leyom in (1,5,9)
        and ya.status=1

      union select '38' kod_ishur,
       so.mispar_ishi,so.taarich,so.mispar_sidur,
        so.shat_hatchala,
        so.shat_hatchala shat_yetzia, 0 mispar_knisa,
       nvl(so.menahel_musach_meadken,0) musach
      from tb_sidurim_ovdim so,
          tb_yamey_avoda_ovdim ya,
          ctb_sibot_loletashlum sl
        where so.taarich=p_taarich
          and nvl(p_mispar_ishi, so.mispar_ishi)=so.mispar_ishi
         and so.mispar_ishi=ya.mispar_ishi
         and so.taarich=ya.taarich
         and ya.status=1
        and so.hashlama>0 and so.sug_hashlama=2
       and so.kod_siba_lo_letashlum=sl.kod_siba(+)
      and( nvl(so.lo_letashlum,0)=0 or sl.lebdikat_ishurim=1)
      and nvl(so.bitul_o_hosafa,0) not in(1,3); --canceled sidur

  end get_hashlama_approvals;

PROCEDURE get_mosach_shabaton_approvals(p_taarich DATE,p_mispar_ishi NUMBER, p_Cur OUT CurType) as
  /*
kod:  6
*/
  begin
    open p_cur for
       select distinct
        '6' kod_ishur,
        so.mispar_ishi,so.taarich,so.mispar_sidur,
        so.shat_hatchala,
        so.shat_hatchala shat_yetzia, 0 mispar_knisa,
        nvl(so.menahel_musach_meadken,0) musach,so.chariga erech_mevukash
      from tmp_pirtey_ovdim pto,
                ovdim o,
                tb_sidurim_ovdim so,
                ctb_yechida ye,
                tb_yamim_meyuchadim ym,
                ctb_sugey_yamim_meyuchadim sym,
                tb_yamey_avoda_ovdim ya,
                ctb_sibot_loletashlum sl
      where so.taarich=p_taarich
      and nvl(p_mispar_ishi,so.mispar_ishi)=so.mispar_ishi
       and so.mispar_ishi=ya.mispar_ishi
      and so.taarich=ya.taarich
      and ya.status=1
      and so.mispar_ishi=pto.mispar_ishi
      and so.mispar_ishi=o.mispar_ishi
      and so.taarich between pto.me_tarich and nvl(pto.ad_tarich,sysdate+1000)
      and ye.kod_hevra=o.kod_hevra
      and ye.kod_yechida=pto.yechida_irgunit
      and (lower(ye.sug_yechida)='m_me' or lower(ye.sug_yechida)='m_ms')
      and so.chariga<>0
      and ym.taarich(+)=so.taarich
      and get_sug_yom(so.taarich,ym.sug_yom)=sym.sug_yom
      and sym.shbaton=1 
       and so.kod_siba_lo_letashlum=sl.kod_siba(+)
      and( nvl(so.lo_letashlum,0)=0 or sl.lebdikat_ishurim=1)
      and nvl(so.bitul_o_hosafa,0) not in(1,3); --canceled sidur
  end get_mosach_shabaton_approvals;

PROCEDURE get_shaot_avoda_shabat(p_taarich DATE,p_mispar_ishi NUMBER, p_Cur OUT CurType) as
/*
kod:  5
*/
  begin
  open p_cur for
    select distinct
         5 kod_ishur,
        so.mispar_ishi,so.taarich,so.mispar_sidur,
        so.shat_hatchala,
        so.shat_hatchala shat_yetzia, 0 mispar_knisa,
        nvl(so.menahel_musach_meadken,0) musach,so.chariga erech_mevukash
      from
                tb_sidurim_ovdim so,
                ctb_yechida ye,
                tb_yamim_meyuchadim ym,
                ctb_sugey_yamim_meyuchadim sym,
                tb_yamey_avoda_ovdim ya,
                ctb_sibot_loletashlum sl
      where so.taarich=p_taarich
      and nvl(p_mispar_ishi,so.mispar_ishi)=so.mispar_ishi
      and so.mispar_ishi=ya.mispar_ishi
      and so.taarich=ya.taarich
      and ya.status=1
      and so.chariga<>0
      and ym.taarich(+)=so.taarich
      and get_sug_yom(so.taarich,ym.sug_yom)=sym.sug_yom
      and sym.shbaton=1
      and nvl(pkg_ovdim.fun_get_meafyen_oved(so.mispar_ishi,7,so.taarich),-1) =-1
       and so.kod_siba_lo_letashlum=sl.kod_siba(+)
      and( nvl(so.lo_letashlum,0)=0 or sl.lebdikat_ishurim=1)
      and nvl(so.bitul_o_hosafa,0) not in(1,3); --canceled sidur
  end get_shaot_avoda_shabat;

PROCEDURE get_hamtana_approvals(p_taarich DATE,p_mispar_ishi NUMBER, p_Cur OUT CurType) as
/*
kod:  33
*/
  begin
    open p_Cur for
    select '33' kod_ishur,
    po.mispar_ishi,po.taarich,po.mispar_sidur,po.shat_hatchala_sidur shat_hatchala,
    po.shat_yetzia,po.mispar_knisa,
    0 musach
    from tb_peilut_ovdim po,
    tb_parametrim pa,
    tb_yamey_avoda_ovdim ya,
    tb_sidurim_ovdim so,
    ctb_sibot_loletashlum sl
    where po.taarich= p_taarich
     and po.mispar_ishi=ya.mispar_ishi
      and po.taarich=ya.taarich
      and po.mispar_ishi=so.mispar_ishi
      and po.taarich=so.taarich
      and po.shat_hatchala_sidur=so.shat_hatchala
      and po.mispar_sidur=so.mispar_sidur
      and ya.status=1
       and so.kod_siba_lo_letashlum=sl.kod_siba(+)
      and( nvl(so.lo_letashlum,0)=0 or sl.lebdikat_ishurim=1)
    and nvl(p_mispar_ishi,po.mispar_ishi)=po.mispar_ishi
    and lpad(to_char(po.makat_nesia),3)='724'
    and pa.kod_param=161
    and po.taarich between pa.me_taarich and nvl(pa.ad_taarich,sysdate+1000)
    and to_number(substr(to_char(po.makat_nesia),4,3))>to_number(pa.erech_param)
    and nvl(so.bitul_o_hosafa,0) not in(1,3); --canceled sidur
  end get_hamtana_approvals;

function get_sug_yom(p_taarich Date,p_sug_yom NUMBER) return NUMBER
is
  v_sug_yom NUMBER;
  v_weekday NUMBER;
  begin

    v_sug_yom:=p_sug_yom;

    if v_sug_yom is null then
      v_weekday:=to_number(to_char(p_taarich, 'D'));
      case v_weekday
        when 7 then v_sug_yom:=20;
        when 6 then v_sug_yom:=10;
        else v_sug_yom:=1;
      end case;
    end  if;
    return v_sug_yom;
end get_sug_yom;

PROCEDURE get_pending_approvals(p_rashi NUMBER,p_Cur OUT CurType) as
  BEGIN
    OPEN p_Cur for
      select decode(p_rashi,1,i.gorem_measher_rashsi,i.gorem_measher_mishni) gorem_measher,
      to_char(i.taarich,'mm/yyyy') approvals_month, count(kod_ishur) approvals_count,
     max( o.shem_mish) shem_mish, max(o.shem_prat) shem_prat, max(o.email) email
      from tb_ishurim  i, ovdim o
      where
        decode(p_rashi,1,i.gorem_measher_rashsi,i.gorem_measher_mishni)=o.mispar_ishi
      and i.kod_status_ishur=0 /*pending*/
      and decode(p_rashi,1,i.gorem_measher_rashsi,i.gorem_measher_mishni) is not null
      group by decode(p_rashi,1,i.gorem_measher_rashsi,i.gorem_measher_mishni),to_char(i.taarich,'mm/yyyy');
  end get_pending_approvals;

PROCEDURE get_expired_pending_approvals(p_Cur OUT CurType) as
  BEGIN
    OPEN p_Cur for
      select i.mispar_ishi,i.kod_ishur,i.taarich,i.mispar_sidur,i.shat_hatchala,i.shat_yetzia,i.mispar_knisa,
      i.rama, i.gorem_measher_rashsi,i.erech_mevukash,i.erech_mevukash2
      from tb_ishurim i, tb_parametrim p
      where i.kod_status_ishur=0 /*pending*/
      and i.taarich_bakashat_ishur<sysdate-p.erech_param
      and i.gorem_measher_rashsi is not null
      and i.gorem_measher_mishni is null
      and p.kod_param=92 and i.taarich_bakashat_ishur between p.me_taarich and p.ad_taarich
      order by i.gorem_measher_rashsi;
end get_expired_pending_approvals;

PROCEDURE update_gorem_measher_mishni(p_mispar_ishi NUMBER,p_kod_ishur NUMBER,
            p_taarich DATE,p_mispar_sidur NUMBER,p_shat_hatchala DATE,
            p_shat_yetzia DATE,p_mispar_knisa NUMBER,p_rama NUMBER,
            p_erech_mevukash NUMBER,p_erech_mevukash2 NUMBER,
            p_gorem_measher_mishni NUMBER,
            p_rows_affected out NUMBER) AS
            begin
          update tb_ishurim
            set gorem_measher_mishni= p_gorem_measher_mishni
          where mispar_ishi=p_mispar_ishi
          and kod_ishur= p_kod_ishur
          and taarich= p_taarich
          and mispar_sidur= p_mispar_sidur
          and shat_hatchala= p_shat_hatchala
          and shat_yetzia = p_shat_yetzia
          and mispar_knisa = p_mispar_knisa
          and rama= p_rama
          and erech_mevukash=p_erech_mevukash
          and erech_mevukash2=p_erech_mevukash2;
          p_rows_affected:=SQL%ROWCOUNT;
  end update_gorem_measher_mishni;

  PROCEDURE update_shat_letashlum(p_mispar_ishi NUMBER,
            p_taarich DATE,p_mispar_sidur NUMBER,p_shat_hatchala DATE) as
    begin
         update tb_sidurim_ovdim
    set shat_hatchala_letashlum=shat_hatchala,
        shat_gmar_letashlum=shat_gmar
      where    mispar_ishi=p_mispar_ishi
          and taarich= p_taarich
          and mispar_sidur= p_mispar_sidur
          and shat_hatchala= p_shat_hatchala;
    End update_shat_letashlum;

     PROCEDURE get_general_population(p_taarich DATE,p_Cur OUT CurType) as
      begin
        OPEN p_Cur for
          select distinct  ya.mispar_ishi,ya.taarich
          from tb_yamey_avoda_ovdim ya,
                tmp_pirtey_ovdim pto,
                ovdim o,
                ctb_yechida ye
          where ya.taarich=p_taarich
          and ya.status=1
          and ya.mispar_ishi=pto.mispar_ishi
          and ya.mispar_ishi=o.mispar_ishi
          and ya.taarich between pto.me_tarich and nvl(pto.ad_tarich,sysdate+1000)
          and ye.kod_hevra=o.kod_hevra
          and ye.kod_yechida=pto.yechida_irgunit
          and (lower(ye.sug_yechida)<>'m_me' and lower(ye.sug_yechida)<>'m_ms')
          and not exists(select 1 from tb_sidurim_ovdim so where so.mispar_ishi=ya.mispar_ishi
                                      and so.taarich= ya.taarich and so.meadken_acharon=-12 );
          
      end get_general_population;

     PROCEDURE get_mu_lelo_nahagut_population(p_taarich DATE,p_Cur OUT CurType) as
      begin
        OPEN p_Cur for
          select distinct ya.mispar_ishi,ya.taarich
          from tb_yamey_avoda_ovdim ya,
                tmp_pirtey_ovdim pto,
                ovdim o,
                ctb_yechida ye
          where ya.taarich=p_taarich
          and ya.status=1
          and ya.mispar_ishi=pto.mispar_ishi
          and ya.mispar_ishi=o.mispar_ishi
          and ya.taarich between pto.me_tarich and nvl(pto.ad_tarich,sysdate+1000)
          and ye.kod_hevra=o.kod_hevra
          and ye.kod_yechida=pto.yechida_irgunit
          and (lower(ye.sug_yechida)='m_me' or lower(ye.sug_yechida)='m_ms')
          and not exists(select 1 from tb_sidurim_ovdim so where so.mispar_ishi=ya.mispar_ishi
                                      and so.taarich= ya.taarich and so.meadken_acharon=-12 );
      end get_mu_lelo_nahagut_population;
       PROCEDURE get_retro_population( p_bakasha_id number,p_Cur OUT CurType) as
       begin
        OPEN p_Cur for
           select distinct ya.mispar_ishi,ya.taarich
            from tb_yamey_avoda_ovdim ya, ovdim o
            where  o.mispar_ishi=ya.mispar_ishi
            
            and  exists
            (select mispar_ishi
                from tb_sidurim_ovdim so
                where so.mispar_ishi=ya.mispar_ishi
                and so.taarich=ya.taarich and so.meadken_acharon=-11
                and so.taarich_idkun_acharon>nvl(ya.ritzat_ishurim_acharona,so.taarich_idkun_acharon-1)
            )
            and ya.measher_o_mistayeg is not null
            and nvl(ya.status,-1)<>0;
           
          
       end get_retro_population;

       PROCEDURE get_musach_population(p_taarich DATE,p_Cur OUT CurType) as
       begin
        OPEN p_Cur for
            select ya.mispar_ishi,ya.taarich
            from tmp_pirtey_ovdim pto,
                ovdim o,
                tb_sidurim_ovdim so,
                ctb_yechida ye,
                tb_yamey_avoda_ovdim ya
      where so.taarich=p_taarich
        and so.mispar_ishi=ya.mispar_ishi
        and so.taarich=ya.taarich
        /*and ya.status=1*/
        and so.mispar_ishi=pto.mispar_ishi
        and so.mispar_ishi=o.mispar_ishi
        and so.taarich between pto.me_tarich and nvl(pto.ad_tarich,sysdate+1000)
        and ye.kod_hevra=o.kod_hevra
        and ye.kod_yechida=pto.yechida_irgunit
        and (lower(ye.sug_yechida)='m_me' or lower(ye.sug_yechida)='m_ms')
        and  exists(select 1 from tb_sidurim_ovdim so where so.mispar_ishi=ya.mispar_ishi
                                      and so.taarich= ya.taarich and so.meadken_acharon=-12 );
       end get_musach_population;

  PROCEDURE get_erech_meafyen(p_mispar_ishi NUMBER, p_taarich DATE ,p_Cur OUT CurType) as
  begin
      open p_Cur for
            select nvl(Erech_Rechiv,0) Erech_Rechiv,Kod_Rechiv
           from
                ( select   b.bakasha_id ,taarich_haavara_lesachar,Erech_Rechiv,Kod_Rechiv,
                               max(taarich_haavara_lesachar)  OVER (PARTITION BY mispar_ishi,taarich,Kod_Rechiv )  max_date
                  from TB_Bakashot b,TB_Chishuv_Chodesh_Ovdim o
                   where b.bakasha_id=o.bakasha_id
                           and o.mispar_ishi=p_mispar_ishi
                           and o.taarich=trunc(p_taarich,'MM')
                           and b.huavra_lesachar =1)
           where taarich_haavara_lesachar=max_date;
  end get_erech_meafyen;


PROCEDURE get_approval_to_emploee(p_mispar_ishi IN TB_Ishurim.mispar_ishi%type,
		  										   							       p_taarich  IN TB_Ishurim.taarich%type,
																				   p_Cur OUT CurType) as
  begin
      open p_Cur for
         select i.kod_ishur,i.mispar_sidur,i.shat_hatchala,i.shat_yetzia,i.mispar_knisa,i.RAMA,nvl(i.kod_status_ishur,0)kod_status_ishur
		 from TB_Ishurim i,ctb_ishurim c
		where i.KOD_ISHUR=c.KOD_ISHUR
		and i.Mispar_Ishi= p_mispar_ishi
		and i.Taarich= p_taarich
		and c.pail=1
		and (i.kod_status_ishur<>2 or i.kod_status_ishur is null);

EXCEPTION
        WHEN OTHERS THEN
		RAISE;
  end get_approval_to_emploee;

FUNCTION fn_is_oved_musach(p_mispar_ishi IN tb_sidurim_ovdim.mispar_ishi%type,
                           p_date  IN tb_sidurim_ovdim.taarich%type) return number IS
    v_count number;
BEGIN
    select count (o.mispar_ishi) into v_count
    from tmp_pirtey_ovdim pto,ovdim o,ctb_yechida ye
    where o.mispar_ishi=pto.mispar_ishi
            and o.mispar_ishi = p_mispar_ishi
            and p_date between pto.me_tarich and nvl(pto.ad_tarich,sysdate+1000)
            and ye.kod_hevra=o.kod_hevra
            and ye.kod_yechida=pto.yechida_irgunit
            and (lower(ye.sug_yechida)='m_me' or lower(ye.sug_yechida)='m_ms') ;

    return v_count;
EXCEPTION
        WHEN NO_DATA_FOUND THEN
           Return 0;
        WHEN OTHERS THEN
        RAISE;
END fn_is_oved_musach;

PROCEDURE update_ritzat_ishurim_acharona(p_mispar_ishi IN tb_yamey_avoda_ovdim.mispar_ishi%type,
                           p_date  IN tb_yamey_avoda_ovdim.taarich%type) as
 begin
   update tb_yamey_avoda_ovdim 
   set ritzat_ishurim_acharona=sysdate
   where mispar_ishi=p_mispar_ishi
   and taarich=p_date;
end update_ritzat_ishurim_acharona;


procedure get_hevrot_lelo_ishurim_leoved(p_mispar_ishi IN tb_yamey_avoda_ovdim.mispar_ishi%type, 
                           p_date in date , p_Cur OUT CurType) as 
 begin
    open p_Cur for
     select decode(h1.kod_hevra,null,h2.kod_hevra,h1.kod_hevra) kod_hevra
     from ovdim o, 
          tmp_pirtey_ovdim pto,  
          (select H.KOD_HEVRA from tb_hevrot_lelo_ishurim h 
                    where p_date between h.me_taarich and nvl(h.ad_taarich,p_date+1)) h1,
          (select H.KOD_HEVRA from tb_hevrot_lelo_ishurim h 
                    where p_date between h.me_taarich and nvl(h.ad_taarich,p_date+1)) h2
     where o.mispar_ishi=pto.mispar_ishi
           and o.mispar_ishi = p_mispar_ishi
           and p_date between pto.me_tarich and nvl(pto.ad_tarich,sysdate+1000)
           and O.KOD_HEVRA=h1.kod_hevra(+)
           and PTO.KOD_HEVRA_HASHALA=h2.kod_hevra(+);                        
end get_hevrot_lelo_ishurim_leoved;
END PKG_APPROVALS; 
/
CREATE OR REPLACE PACKAGE PKG_BATCH AS
TYPE    CurType      IS    REF  CURSOR;
/******************************************************************************
   NAME:       PKG_BATCH
   PURPOSE:

   REVISIONS:
   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        26/04/2009             1. Created this package.
******************************************************************************/

PROCEDURE pro_ins_log_bakasha(p_bakasha_id  IN tb_log_bakashot.bakasha_id%type,
                   p_taarich_idkun  IN tb_log_bakashot.taarich_idkun_acharon%type,
                 p_sug_hodaa  IN tb_log_bakashot.sug_hodaa%type,
                 p_kod_tahalich IN tb_log_bakashot.kod_tahalich%type,
                 p_kod_yeshut IN tb_log_bakashot.kod_yeshut%type,
              p_mispar_ishi IN tb_log_bakashot.mispar_ishi%type,
              p_taarich IN tb_log_bakashot.taarich%type,
              p_mispar_sidur IN tb_log_bakashot.mispar_sidur%type,
              p_shat_hatchala_sidur IN tb_log_bakashot.shat_hatchala_sidur%type,
              p_shat_yetzia IN tb_log_bakashot.shat_yetzia%type,
              p_mispar_knisa IN tb_log_bakashot.mispar_knisa%type,
              p_teur_hodaa IN tb_log_bakashot.teur_hodaa%type,
              p_kod_hodaa IN tb_log_bakashot.kod_hodaa%type,
              p_mispar_siduri OUT tb_log_bakashot.mispar_siduri%type);

PROCEDURE pro_ins_bakasha(p_sug_bakasha  IN tb_bakashot.sug_bakasha%type,
                   p_teur  IN tb_bakashot.teur%type,
                 p_status   IN tb_bakashot.status%type,
                 p_user_id IN tb_bakashot.mishtamesh_id%type,
              p_bakasha_id OUT tb_bakashot.bakasha_id%type);

  PROCEDURE pro_upd_bakasha(p_bakasha_id IN tb_bakashot.bakasha_id%type,
                   p_status   IN tb_bakashot.status%type,
              p_huavra_lesachar in  tb_bakashot.huavra_lesachar%type,
              p_zman_siyum   in  tb_bakashot.zman_siyum%type,
              p_tar_haavara_lesachar   in  tb_bakashot.taarich_haavara_lesachar%type) ;

 PROCEDURE pro_ins_bakasha_param(p_bakasha_id  IN tb_bakashot_params.bakasha_id%type,
                   p_param_id  IN  tb_bakashot_params.param_id%type,
                 p_erech   IN  tb_bakashot_params.erech%type);

 PROCEDURE pro_get_pirtey_ritzot(p_taarich_me in tb_bakashot.zman_hatchala%type,
             p_taarich_ad in tb_bakashot.zman_hatchala%type,
            p_get_all number,
            p_cur out CurType);

  PROCEDURE pro_get_ovdim_lechishuv(p_chodesh in date,
             p_maamad in number,
            p_ritza_gorefet in number,
            p_cur out CurType) ;

  PROCEDURE pro_get_ovdim_to_transfer(p_request_id in  tb_bakashot.bakasha_id%type,
                 p_cur_list out CurType,
            p_cur out CurType);

   PROCEDURE pro_get_chishuv_yomi(p_request_id in  tb_bakashot.bakasha_id%type,
                   p_mispar_ishi IN  tb_chishuv_yomi_ovdim.MISPAR_ISHI%TYPE,
              p_cur out CurType);

    ----------------
PROCEDURE pro_del_chishuv_after_transfer(p_request_id in  tb_bakashot.bakasha_id%type);
----------------
PROCEDURE pro_upd_status_yamey_avoda(p_request_id in  tb_bakashot.bakasha_id%type);

     PROCEDURE pro_ins_yamey_avoda_ovdim(pDt varchar);
        PROCEDURE pro_get_premiot_ovdim(pYM varchar,p_Cur OUT CurType);
     PROCEDURE pro_upd_yamey_avoda_ovdim(pDt varchar);
 --         PROCEDURE pro_upd_yamey_avoda_1oved(pDt varchar,pIshi varchar);
      PROCEDURE pro_get_my_attendance(pIshi varchar,pDt varchar,p_Cur OUT CurType);
      PROCEDURE pro_pivot(p_ishi varchar,p_Dt_from varchar,p_Dt_to varchar,p_Cur OUT CurType);
           PROCEDURE pro_pivot_1Day(p_ishi varchar,p_Dt varchar,p_Cur OUT CurType);
     PROCEDURE pro_ins_log_tahalich(p_KodTahalich  number  ,p_KodPeilut number ,  p_KodStatus  number ,  p_TeurTech varchar  ) ;
      PROCEDURE pro_ins_log_tahalich_takala(p_KodTahalich  number  ,p_KodPeilut number,  p_KodStatus  number ,  p_TeurTech varchar  ,p_KodTakala number) ;
	  PROCEDURE pro_GetListDs(pDt varchar, pIshi varchar ,psidur varchar,p_cur out CurType) ;
         PROCEDURE pro_GetRowDt(pDt varchar, p_cur out CurType) ;
      PROCEDURE pro_GetRowDtLong(pDt varchar, p_cur out CurType);
        PROCEDURE pro_GetRowDtVeryLong(pDt varchar, p_cur out CurType) ;
        PROCEDURE pro_GetRowDtVeryLong2(pDt varchar, phatchala varchar,pIshi varchar ,psidur varchar,p_cur out CurType)  ;
        PROCEDURE pro_GetRowDtVeryLongPundakim2(pDt varchar, phatchala varchar,pIshi varchar ,p_cur out CurType)  ; 
	   PROCEDURE pro_RefreshMv(shem_mvew varchar)  ;
         PROCEDURE InsIntoTrailKnisa(pDt varchar, pDt_N_KNISA varchar,SRV_D_ISHI number,calc_D_new_sidur number,P24 number)  ;
     PROCEDURE InsIntoTrailYetzia(pDt varchar, pDt_N_YETZIA varchar,SRV_D_ISHI number,calc_D_new_sidur number,P24 number)  ;
    PROCEDURE pro_get_yamei_avoda_meshek( p_date DATE, p_bakasha_id number, p_Cur OUT CurType);
      PROCEDURE pro_get_all_yamei_avoda(  p_Cur OUT CurType);
   PROCEDURE pro_new_rec(  SRV_D_ISHI varchar,  SRV_D_TAARICH varchar,  calc_D_new_sidur varchar,
      SRV_D_KNISA_X varchar,  SRV_D_MIKUM_KNISA varchar,  SRV_D_SIBAT_DIVUACH_KNISA varchar,
      SRV_D_YETZIA_X varchar,  SRV_D_MIKUM_YETZIA varchar,  SRV_D_SIBAT_DIVUACH_YETZIA varchar,
      SRV_D_ISHI_MEADKEN varchar,
   SRV_D_KOD_BITUL_ZMAN_NESIA_X varchar,
      SRV_D_KOD_CHARIGA_X varchar,  SRV_D_KOD_HALBASHA_X varchar,  SRV_D_KOD_HAZMANA_X varchar,
      TAARICH_knisa_p24 number,  TAARICH_yetzia_p24 number,  DatEfes varchar,
      TAARICH_knisa_letashlum_p24 number,  SRV_D_KNISA_letashlum_X varchar,
      TAARICH_yetzia_letashlum_p24 number,  SRV_D_YETZIA_letashlum_X varchar) ;
   PROCEDURE pro_get_yamei_avoda_shinui_hr(p_date DATE, p_bakasha_id number, p_Cur OUT CurType);
       PROCEDURE pro_measher_o_mistayeg(  SRV_D_ISHI varchar,  SRV_D_TAARICH varchar,  TAARICH_knisa_p24 number );
          PROCEDURE pro_lo_letashlum(  SRV_D_ISHI varchar,  SRV_D_TAARICH varchar,  TAARICH_knisa_p24 number ) ;
       procedure pro_upd_out_blank(  SRV_D_ISHI varchar,  SRV_D_TAARICH varchar,  calc_D_new_sidur varchar,
      SRV_D_KNISA_X varchar,  SRV_D_MIKUM_KNISA varchar,  SRV_D_SIBAT_DIVUACH_KNISA varchar,
      SRV_D_YETZIA_X varchar,  SRV_D_MIKUM_YETZIA varchar,  SRV_D_SIBAT_DIVUACH_YETZIA varchar,
      SRV_D_ISHI_MEADKEN varchar,
   SRV_D_KOD_BITUL_ZMAN_NESIA_X varchar,
      SRV_D_KOD_CHARIGA_X varchar,  SRV_D_KOD_HALBASHA_X varchar,  SRV_D_KOD_HAZMANA_X varchar,
      TAARICH_knisa_p24 number , TAARICH_yetzia_p24 number,  DatEfes varchar,
      TAARICH_knisa_letashlum_p24 number,  SRV_D_KNISA_letashlum_X varchar,
      TAARICH_yetzia_letashlum_p24 number,  SRV_D_YETZIA_letashlum_X varchar) ;
   procedure pro_upd_in_blank(  SRV_D_ISHI varchar,  SRV_D_TAARICH varchar,  calc_D_new_sidur varchar,
      SRV_D_KNISA_X varchar,  SRV_D_MIKUM_KNISA varchar,  SRV_D_SIBAT_DIVUACH_KNISA varchar,
      SRV_D_YETZIA_X varchar,  SRV_D_MIKUM_YETZIA varchar,  SRV_D_SIBAT_DIVUACH_YETZIA varchar,
      SRV_D_ISHI_MEADKEN varchar,
   SRV_D_KOD_BITUL_ZMAN_NESIA_X varchar,
      SRV_D_KOD_CHARIGA_X varchar,  SRV_D_KOD_HALBASHA_X varchar,  SRV_D_KOD_HAZMANA_X varchar,
      TAARICH_knisa_p24 number , TAARICH_yetzia_p24 number,  DatEfes varchar,
      TAARICH_knisa_letashlum_p24 number,  SRV_D_KNISA_letashlum_X varchar,
      TAARICH_yetzia_letashlum_p24 number,  SRV_D_YETZIA_letashlum_X varchar) ;
     procedure pro_upd_in_out_letashlum(  SRV_D_ISHI varchar,  SRV_D_TAARICH varchar,  calc_D_new_sidur varchar,
      SRV_D_KNISA_X varchar,
   --SRV_D_MIKUM_KNISA varchar,  SRV_D_SIBAT_DIVUACH_KNISA varchar,
      SRV_D_YETZIA_X varchar,
   --SRV_D_MIKUM_YETZIA varchar,  SRV_D_SIBAT_DIVUACH_YETZIA varchar,
      SRV_D_ISHI_MEADKEN varchar,
   SRV_D_KOD_BITUL_ZMAN_NESIA_X varchar,
      --SRV_D_KOD_CHARIGA_X varchar,
   SRV_D_KOD_HALBASHA_X varchar,
   --SRV_D_KOD_HAZMANA_X varchar,
      TAARICH_knisa_p24 number , TAARICH_yetzia_p24 number,  DatEfes varchar,
      TAARICH_knisa_letashlum_p24 number,  SRV_D_KNISA_letashlum_X varchar,
      TAARICH_yetzia_letashlum_p24 number,  SRV_D_YETZIA_letashlum_X varchar) ;
    procedure  pro_ins_yamey_avoda_1oved(SRV_D_ISHI number,  SRV_D_TAARICH varchar) ;
  PROCEDURE pro_new_rec_pundakim(  SRV_D_ISHI varchar,  SRV_D_TAARICH varchar,
                                     SRV_D_KNISA_X varchar,  SRV_D_MIKUM_KNISA varchar,   TAARICH_knisa_p24 number) ;
  PROCEDURE pro_GetListDsPundakim(pDt varchar, pIshi varchar ,p_cur out CurType) ;
 	 PROCEDURE pro_insert_debug_maatefet(p_mispar_ishi NUMBER, p_taarich date, p_taarich_ritza date,
                                    p_bakasha_id number, p_sug_bakasha number, 
                                    p_comments test_maatefet.comments%type default null);
	 procedure pro_IfSdrnManas(pDt varchar,pIshi varchar ,p_cur out CurType) ;
procedure pro_get_shinuy_matsav_ovdim(p_Cur out CurType);
procedure pro_get_Shinuy_meafyeney_bizua(p_Cur out CurType) ;
procedure pro_get_shinuy_pirey_oved( p_Cur out CurType);
procedure pro_get_shinuy_brerot_mechdal( p_Cur out CurType);
procedure pro_ins_ovdim_im_shinuy_hr(p_coll_obj_ovdim_im_shinuy_hr in coll_ovdim_im_shinuy_hr,
	 	  														   p_tavla in varchar );
procedure pro_ins_defaults_hr(p_coll_obj_brerot_mechdal_hr in coll_brerot_mechdal_meafyenim);

procedure inset_oved_im_shinuy_hr(p_mispar_ishi in number,
		  											   	   	   			  		 p_taarich in Date,p_tavla in varchar)	;
procedure update_oved_im_shinuy_hr(p_mispar_ishi in number,
		  											   	   	   			  		 p_taarich in Date)	;

PROCEDURE MoveOldMatzavOvdimToNew ;
PROCEDURE MoveOldPirteyOvedToNew ;
PROCEDURE MoveOldMeafyenimOvdimToNew ;
PROCEDURE MoveOldBrerotMechdalToNew ;																			 
PROCEDURE pro_get_ovdim4rerunsdrn( pDt varchar,p_cur OUT CurType) ;
 PROCEDURE pro_sof_meafyenim( pDt varchar,p_Cur OUT CurType);
procedure pro_get_premia_input(p_taarich date, p_bakasha_id tb_bakashot.bakasha_id%type,p_Cur OUT CurType);
procedure pro_update_calc_premia(p_taarich date, p_bakasha_id tb_bakashot.bakasha_id%type, p_mispar_ishi number,
            p_kod_rechiv number, p_erech_rechiv number);
procedure pro_get_premia_bakashot(p_taarich date,p_Cur OUT CurType);
 PROCEDURE pro_if_start(p_Cur OUT CurType);
  PROCEDURE pro_if_GalreadyRun(p_Cur OUT CurType) ;
procedure pro_get_ovdim_lehishuv_premiot(p_Cur OUT CurType);
procedure pro_update_chishuv_premia(p_bakasha_id tb_bakashot.bakasha_id%type,
            p_mispar_ishi OVDIM_LECHISHUV_PREMYOT.MISPAR_ISHI%type,
            p_chodesh ovdim_lechishuv_premyot.chodesh%type);
 procedure pro_ins_ovdim_lehishuv_premiot(pYMf NUMBER,pYM2 NUMBER) ;

END PKG_BATCH;
/

CREATE OR REPLACE PACKAGE BODY PKG_BATCH AS
/******************************************************************************
   NAME:       PKG_BATCH
   PURPOSE:

   REVISIONS:
   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        26/04/2009             1. Created this package body.
******************************************************************************/

PROCEDURE pro_ins_log_bakasha(p_bakasha_id  IN tb_log_bakashot.bakasha_id%type,
                   p_taarich_idkun  IN tb_log_bakashot.taarich_idkun_acharon%type,
                 p_sug_hodaa  IN tb_log_bakashot.sug_hodaa%type,
                 p_kod_tahalich IN tb_log_bakashot.kod_tahalich%type,
                 p_kod_yeshut IN tb_log_bakashot.kod_yeshut%type,
              p_mispar_ishi IN tb_log_bakashot.mispar_ishi%type,
              p_taarich IN tb_log_bakashot.taarich%type,
              p_mispar_sidur IN tb_log_bakashot.mispar_sidur%type,
              p_shat_hatchala_sidur IN tb_log_bakashot.shat_hatchala_sidur%type,
              p_shat_yetzia IN tb_log_bakashot.shat_yetzia%type,
              p_mispar_knisa IN tb_log_bakashot.mispar_knisa%type,
              p_teur_hodaa IN tb_log_bakashot.teur_hodaa%type,
              p_kod_hodaa IN tb_log_bakashot.kod_hodaa%type,
              p_mispar_siduri OUT tb_log_bakashot.mispar_siduri%type)
 IS
   v_mispar_siduri tb_log_bakashot.mispar_siduri%type;
  BEGIN

      select log_seq.nextval into v_mispar_siduri from dual;
   p_mispar_siduri:=v_mispar_siduri;

        INSERT INTO TB_LOG_BAKASHOT
                      (MISPAR_SIDURI,BAKASHA_ID,TAARICH_IDKUN_ACHARON,SUG_HODAA,KOD_TAHALICH,KOD_YESHUT,
         MISPAR_ISHI,TAARICH,MISPAR_SIDUR,SHAT_HATCHALA_SIDUR,SHAT_YETZIA,MISPAR_KNISA,KOD_HODAA,TEUR_HODAA)
   VALUES (v_mispar_siduri,p_bakasha_id,p_taarich_idkun,p_sug_hodaa,p_kod_tahalich,p_kod_yeshut,p_mispar_ishi, p_taarich,p_mispar_sidur,p_shat_hatchala_sidur,
           p_shat_yetzia,p_mispar_knisa,p_kod_hodaa,p_teur_hodaa);

      EXCEPTION
   WHEN OTHERS THEN
        RAISE;
  END pro_ins_log_bakasha;

/*
Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        27/04/2009      sari       1.    
*/
  PROCEDURE pro_ins_bakasha(p_sug_bakasha  IN tb_bakashot.sug_bakasha%type,
                   p_teur  IN tb_bakashot.teur%type,
                 p_status   IN tb_bakashot.status%type,
                 p_user_id IN tb_bakashot.mishtamesh_id%type,
              p_bakasha_id OUT tb_bakashot.bakasha_id%type) IS
     v_bakasha_id tb_bakashot.bakasha_id%type;
  BEGIN
        select request_seq.nextval into v_bakasha_id from dual;
   p_bakasha_id:=v_bakasha_id;

        INSERT INTO TB_BAKASHOT
                      (BAKASHA_ID,SUG_BAKASHA,TEUR,ZMAN_HATCHALA,ZMAN_SIYUM,STATUS,MISHTAMESH_ID,
         HUAVRA_LESACHAR,TAARICH_HAAVARA_LESACHAR  )
   VALUES (v_bakasha_id,p_sug_bakasha,p_teur,sysdate,Null,p_status, p_user_id,Null,Null);

      EXCEPTION
   WHEN OTHERS THEN
        RAISE;
  END pro_ins_bakasha;

  PROCEDURE pro_upd_bakasha(p_bakasha_id IN tb_bakashot.bakasha_id%type,
                   p_status   IN tb_bakashot.status%type,
              p_huavra_lesachar in  tb_bakashot.huavra_lesachar%type,
              p_zman_siyum   in  tb_bakashot.zman_siyum%type,
              p_tar_haavara_lesachar   in  tb_bakashot.taarich_haavara_lesachar%type) IS
  BEGIN
        UPDATE  TB_BAKASHOT
           SET ZMAN_SIYUM=nvl(p_zman_siyum,ZMAN_SIYUM),
               STATUS=nvl(p_status,STATUS),
         HUAVRA_LESACHAR=nvl(p_huavra_lesachar,HUAVRA_LESACHAR),
         TAARICH_HAAVARA_LESACHAR=nvl(p_tar_haavara_lesachar,TAARICH_HAAVARA_LESACHAR)
   WHERE BAKASHA_ID=p_bakasha_id;

      EXCEPTION
   WHEN OTHERS THEN
        RAISE;
  END pro_upd_bakasha;

/*
Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        27/04/2009      sari       1.       
*/
 PROCEDURE pro_ins_bakasha_param(p_bakasha_id  IN tb_bakashot_params.bakasha_id%type,
                   p_param_id  IN  tb_bakashot_params.param_id%type,
                 p_erech   IN  tb_bakashot_params.erech%type) IS
  BEGIN
        INSERT INTO TB_BAKASHOT_PARAMS
                      (BAKASHA_ID,PARAM_ID,ERECH)
   VALUES (p_bakasha_id,p_param_id,p_erech);

      EXCEPTION
   WHEN OTHERS THEN
        RAISE;
  END  pro_ins_bakasha_param;


  /*
Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        02/07/2009     sari      1.       
*/
 PROCEDURE pro_get_pirtey_ritzot(p_taarich_me in tb_bakashot.zman_hatchala%type,
             p_taarich_ad in tb_bakashot.zman_hatchala%type,
            p_get_all number,
            p_cur out CurType) IS
  v_first_bakasha NUMBER;
BEGIN
    if (p_get_all =1) then
    open p_cur for
         Select B.Zman_Hatchala , B.Bakasha_ID, B.Teur,
             (select  decode(bp.erech,null,'',1,'',2,'',' ') from tb_bakashot_params bp where bp.bakasha_id=b.bakasha_id and  bp.param_id=1)   auchlusia,
               (select  bp.erech from tb_bakashot_params bp where bp.bakasha_id=b.bakasha_id and bp.param_id=2) tkufa,
          (select  decode(bp.erech,1,'','') from tb_bakashot_params bp where bp.bakasha_id=b.bakasha_id and bp.param_id=3) ritza_gorfet
       From TB_BAKASHOT B,(Select Erech,Bakasha_ID
                   From TB_Bakashot_Params
                   Where  Param_ID = 5) P
       Where B.Sug_Bakasha=1
        and trunc(B.Zman_Hatchala) between trunc(p_taarich_me) and trunc(p_taarich_ad)
        and b.bakasha_id=p.bakasha_id
        and p.erech='0'
        and b.status=2
       order by B.Zman_Hatchala desc ;
  else
     open p_cur for
             Select B.Zman_Hatchala , B.Bakasha_ID, B.Teur,
                (select  decode(bp.erech,null,'',1,'',2,'',' ') from tb_bakashot_params bp where bp.bakasha_id=b.bakasha_id and  bp.param_id=1)   auchlusia,
             (select  bp.erech from tb_bakashot_params bp where bp.bakasha_id=b.bakasha_id and bp.param_id=2) tkufa,
             (select  decode(bp.erech,1,'','') from tb_bakashot_params bp where bp.bakasha_id=b.bakasha_id and bp.param_id=3) ritza_gorfet
        From TB_BAKASHOT B,(Select Erech,Bakasha_ID
                   From TB_Bakashot_Params
                   Where  Param_ID = 5) P
        Where B.Sug_Bakasha=1
        and trunc(B.Zman_Hatchala) between trunc(p_taarich_me) and trunc(p_taarich_ad)
        and (B.Huavra_Lesachar=0 or B.Huavra_Lesachar is null)
        and b.bakasha_id=p.bakasha_id
        and p.erech='0'
        and b.status=2
        order by B.Zman_Hatchala desc ;

  end if;

EXCEPTION
   WHEN OTHERS THEN
            RAISE;

END  pro_get_pirtey_ritzot;


PROCEDURE pro_get_ovdim_lechishuv(p_chodesh in date,
             p_maamad in number,
            p_ritza_gorefet in number,
            p_cur out CurType) IS
  v_me_taarich date;
  v_ad_taarich date;
BEGIN
  v_me_taarich:=p_chodesh;
  v_ad_taarich:=add_months(v_me_taarich,1)-1;

    if  p_ritza_gorefet<>1 then
    open p_cur for
          select MISPAR_ISHI from
        ( (select o.MISPAR_ISHI
        from ovdim o,
          (select mispar_ishi, chodesh from
             ( (select mispar_ishi,to_char(taarich,'mm/yyyy') chodesh
                    from tb_yamey_avoda_ovdim
               where status=1
               and to_char(taarich,'mm/yyyy')=to_char(p_chodesh,'mm/yyyy'))
          /*  union all
            (select mispar_ishi,to_char(chodesh,'mm/yyyy') chodesh
              from Ovdim_Im_Shinuy_HR
              where Bakasha_ID  is null)*/)
           group by mispar_ishi,chodesh) y,
         (select po.maamad,po.mispar_ishi
               from tmp_Pirtey_Ovdim PO
                 where  (v_me_taarich Between  po.ME_TARICH  and   nvl(po.ad_TARICH,to_date('01/01/9999' ,'dd/mm/yyyy'))
              or  trunc(v_ad_taarich) Between  po.ME_TARICH  and   nvl(po.ad_TARICH,to_date('01/01/9999' ,'dd/mm/yyyy'))
              or   po.ME_TARICH>=v_me_taarich and   nvl(po.ad_TARICH,to_date('01/01/9999' ,'dd/mm/yyyy'))<= trunc(v_ad_taarich))) p
        where o.mispar_ishi=p.mispar_ishi
       and (substr(p.maamad,0,1)=p_maamad  or p_maamad  is null)
       and o.mispar_ishi=y.mispar_ishi)
       union
        (select p.mispar_ishi
         from tb_premyot_yadaniyot p,
                (select po.maamad,po.mispar_ishi
               from tmp_Pirtey_Ovdim PO
                 where  (v_me_taarich Between  po.ME_TARICH  and   nvl(po.ad_TARICH,to_date('01/01/9999' ,'dd/mm/yyyy'))
              or  trunc(v_ad_taarich) Between  po.ME_TARICH  and   nvl(po.ad_TARICH,to_date('01/01/9999' ,'dd/mm/yyyy'))
              or   po.ME_TARICH>=v_me_taarich and   nvl(po.ad_TARICH,to_date('01/01/9999' ,'dd/mm/yyyy'))<= trunc(v_ad_taarich))) po
         where p.Taarich_idkun_acharon  >
                        (Select Zman_Hatchala
                        From TB_Bakashot
                        Where Taarich_Haavara_Lesachar =
                                          (Select Max(B.Taarich_Haavara_Lesachar)
                                            From TB_Bakashot B, TB_Chishuv_Chodesh_Ovdim CC
                                           Where B.Bakasha_ID = CC. Bakasha_ID
                                     And B. Huavra_Lesachar=1
                                     And CC. Mispar_Ishi =p.mispar_ishi ))
         and p.mispar_ishi=po.mispar_ishi
         and (substr(po.maamad,0,1)=p_maamad  or p_maamad  is null)
          and to_char(p.taarich,'mm/yyyy')=to_char(p_chodesh,'mm/yyyy')));
  else
     open p_cur for
         select o.MISPAR_ISHI
       from ovdim o,
       (select mispar_ishi,to_char(taarich,'mm/yyyy') chodesh
       from tb_yamey_avoda_ovdim
       where (status=1 or status=2)
      and to_char(taarich,'mm/yyyy')=to_char(p_chodesh,'mm/yyyy')
      group by mispar_ishi,to_char(taarich,'mm/yyyy') ) y,
        (select po.maamad,po.mispar_ishi
              from tmp_Pirtey_Ovdim PO
                where  (v_me_taarich Between  po.ME_TARICH  and   nvl(po.ad_TARICH,to_date('01/01/9999' ,'dd/mm/yyyy'))
             or  trunc(v_ad_taarich) Between  po.ME_TARICH  and   nvl(po.ad_TARICH,to_date('01/01/9999' ,'dd/mm/yyyy'))
             or   po.ME_TARICH>=v_me_taarich and   nvl(po.ad_TARICH,to_date('01/01/9999' ,'dd/mm/yyyy'))<= trunc(v_ad_taarich))) p
       where o.mispar_ishi=p.mispar_ishi
      and (substr(p.maamad,0,1)=p_maamad  or p_maamad  is null)
      and o.mispar_ishi=y.mispar_ishi;

  end if;

EXCEPTION
   WHEN OTHERS THEN
            RAISE;

END  pro_get_ovdim_lechishuv;

PROCEDURE pro_get_ovdim_to_transfer(p_request_id in  tb_bakashot.bakasha_id%type,
                p_cur_list out CurType,
            p_cur out CurType) IS
 BEGIN
     open p_cur_list for
			     select c.taarich,c.mispar_ishi ,decode(substr(p.maamad,0,1),1,'0013','0026') mifal,substr(p.maamad,2,2) maamad,
				 		substr(p.maamad,0,1) maamad_rashi,
			                  o.SIFRAT_BIKORET_MI sifrat_bikoret,o.SHEM_MISH,o.SHEM_PRAT,p.dirug,p.darga,o.TEUDAT_ZEHUT,p.Isuk,
			                decode((select  1 from matzav_ovdim m
									            where m.mispar_ishi=c.mispar_ishi
									           and c.TAARICH between m.taarich_hatchala and m.taarich_siyum
									          and  m.Kod_matzav='33'),null,0,1) mushhe
			     from  (select  distinct taarich,mispar_ishi
					              from TB_Chishuv_Chodesh_Ovdim c
					            where Bakasha_ID=p_request_id) c,
			           			ovdim o,
						        (select po.me_tarich,po.ad_tarich ,po.mispar_ishi,po.maamad,po.dirug,po. darga,po.Isuk
						       from tmp_Pirtey_Ovdim PO)p
			   where  c.mispar_ishi=p.mispar_ishi
			   and o.mispar_ishi=c.mispar_ishi
			    and p.ME_TARICH=(select max(po.me_tarich)
													          from   tmp_Pirtey_Ovdim po
													          where (c.taarich Between  po.ME_TARICH  and   nvl(po.ad_TARICH,to_date('01/01/9999' ,'dd/mm/yyyy'))
													          or  trunc(add_months(c.taarich,1)-1) Between  po.ME_TARICH  and   nvl(po.ad_TARICH,to_date('01/01/9999' ,'dd/mm/yyyy'))
													          or   po.ME_TARICH>=c.taarich and   nvl(po.ad_TARICH,to_date('01/01/9999' ,'dd/mm/yyyy'))<=   trunc(add_months(c.taarich,1)-1))
													  and po.ISUK is not null
													   and po.mispar_ishi=c.mispar_ishi)
			   order by c.taarich,p.mispar_ishi;

   open p_cur for
			       select c.mispar_ishi, c.taarich,c.kod_rechiv,c.erech_rechiv
			      from
			              (select  nvl(a.taarich,b.taarich) taarich,nvl(a.mispar_ishi,b.mispar_ishi)mispar_ishi,nvl(a.kod_rechiv,b.kod_rechiv) kod_rechiv,(nvl(a.erech_rechiv,0)-nvl(b.erech_rechiv,0))  erech_rechiv
						      from
								      (select c.taarich,c.BAKASHA_ID,c.mispar_ishi,c.kod_rechiv,c.erech_rechiv
								       from TB_Chishuv_Chodesh_Ovdim c
								      where c.Bakasha_ID=p_request_id
								      order by c.mispar_ishi,c.kod_rechiv)a
						      FULL JOIN
							        (  Select c1.mispar_ishi,c1.bakasha_id,c1.Taarich,c1.kod_rechiv,c1.erech_rechiv
							          From TB_Chishuv_Chodesh_Ovdim c1 ,
							                       tb_bakashot b,
							                 (select  distinct taarich,mispar_ishi
							                  from TB_Chishuv_Chodesh_Ovdim c
							                 where Bakasha_ID=p_request_id)c2
							          Where c1.Bakasha_ID<>p_request_id
							             and c1.taarich=c2.taarich
							          and c1.mispar_ishi=c2.mispar_ishi
							          and  b.Huavra_Lesachar=1
							          and b.bakasha_id=c1.bakasha_id
							           and c1.BAKASHA_ID=b.BAKASHA_ID
							          and b.Taarich_Haavara_Lesachar =  (Select Max(Taarich_Haavara_Lesachar)
																		                                        From TB_Bakashot
																		                                   Where Bakasha_ID in ( select c1.bakasha_id
																		                                                  From TB_Chishuv_Chodesh_Ovdim c1 ,
																		                                                         tb_bakashot b
																					                                         Where c1.Bakasha_ID<>p_request_id
																					                                            and c1.taarich=c2.taarich
																					                                         and c1.mispar_ishi=c2.mispar_ishi
																					                                         and  b.Huavra_Lesachar=1
																					                                          group by c1.mispar_ishi,c1.bakasha_id,c1.Taarich))
							       				order by c1.mispar_ishi,c1.taarich,c1.kod_rechiv)b
							     on a.mispar_ishi=b.mispar_ishi
							     and a.taarich=b.taarich
							     and  a.kod_rechiv  = b.kod_rechiv) c
			     order by c.taarich,c.mispar_ishi,c.kod_rechiv;

EXCEPTION
   WHEN OTHERS THEN
            RAISE;

END  pro_get_ovdim_to_transfer;

PROCEDURE pro_get_chishuv_yomi(p_request_id in  tb_bakashot.bakasha_id%type,
                   p_mispar_ishi IN  tb_chishuv_yomi_ovdim.MISPAR_ISHI%TYPE,
              p_cur out CurType) IS
 BEGIN
 OPEN p_cur  FOR
   select   taarich,kod_rechiv,erech_rechiv
   from tb_chishuv_yomi_ovdim c
   where mispar_ishi =p_mispar_ishi
  and bakasha_id=p_request_id;

EXCEPTION
   WHEN OTHERS THEN
            RAISE;

END  pro_get_chishuv_yomi;

----------------
PROCEDURE pro_del_chishuv_after_transfer(p_request_id in  tb_bakashot.bakasha_id%type) IS
 cursor v_cur(v_request_id tb_bakashot.bakasha_id%type) is
  select b.bakasha_id
     from
     (select bakasha_id,max(case when param_id=1 then erech else null end) param1 ,
     max(case when param_id=2 then erech else null end) param2
      from tb_bakashot_params
      where param_id in(1,2)
      group by bakasha_id )p,
      tb_bakashot b
    where  b.HUAVRA_LESACHAR is null
    and b.bakasha_id=p.bakasha_id
	 and b.bakasha_id<>v_request_id
    and (p.param1=(select p.erech from tb_bakashot_params p,tb_bakashot b
                    where b.bakasha_id=v_request_id
                    and b.bakasha_id=p.bakasha_id
                    and param_id=1)
    and p.param2=(select p.erech from tb_bakashot_params p,tb_bakashot b
                  where b.bakasha_id=v_request_id
                  and b.bakasha_id=p.bakasha_id
                  and param_id=2));

  begin
      FOR   v_cur_rec IN  v_cur(p_request_id)
   LOOP
    delete from TB_Chishuv_Sidur_Ovdim
    where bakasha_id=v_cur_rec.bakasha_id;

    delete from TB_Chishuv_yomi_Ovdim
    where bakasha_id=v_cur_rec.bakasha_id;

    delete from TB_Chishuv_chodesh_Ovdim
    where bakasha_id=v_cur_rec.bakasha_id;
  end loop;
EXCEPTION
     WHEN NO_DATA_FOUND THEN
        NULL;
   WHEN OTHERS THEN
            RAISE;

END   pro_del_chishuv_after_transfer;

----------------
PROCEDURE pro_upd_status_yamey_avoda(p_request_id in  tb_bakashot.bakasha_id%type) IS
 cursor v_cur(v_request_id tb_bakashot.bakasha_id%type) is
     select o.mispar_ishi,o.taarich from
    tb_chishuv_yomi_ovdim c, tb_yamey_avoda_ovdim o,tb_bakashot b
   where b.bakasha_id=v_request_id
   and b.bakasha_id=c.bakasha_id
   and c.mispar_ishi=o.mispar_ishi
   and c.taarich=o.TAARICH
   and o.Status<>0
   and o.Taarich_idkun_acharon <=b.Zman_Hatchala;
BEGIN
     FOR   v_cur_rec IN  v_cur(p_request_id)
   LOOP
   update tb_yamey_avoda_ovdim
   set status=2
   where mispar_ishi=v_cur_rec.mispar_ishi
   and taarich=v_cur_rec.taarich;
  end loop;

EXCEPTION
     WHEN OTHERS THEN
            RAISE;
END pro_upd_status_yamey_avoda;
--------------

   PROCEDURE pro_ins_yamey_avoda_ovdim(pDt varchar) IS
   BEGIN
   insert into tb_yamey_avoda_ovdim
   (mispar_ishi,taarich,lina,taarich_idkun_acharon,meadken_acharon)
   select mispar_ishi,to_date(pDt,'yyyymmdd'),0,sysdate,-11
  from  new_Matzav_Ovdim  o
   where   kod_matzav in ('01','03','04','05','06','07','08')
   and to_date(pDt,'yyyymmdd') between taarich_hatchala and nvl(taarich_siyum,sysdate+1)
   and not exists (select * from  tb_yamey_avoda_ovdim yao
  where yao.taarich=to_date(pDt,'yyyymmdd')
  and yao.MISPAR_ISHI=o.mispar_ishi);
END pro_ins_yamey_avoda_ovdim;


 PROCEDURE pro_get_premiot_ovdim(pYM varchar,p_Cur OUT CurType) IS
  BEGIN
  OPEN p_Cur FOR
select baa_premia_empl Mispar_ishi,baa_premia_year_month Tkufa,baa_premia_garagge Snif_premia,baa_sug_premia Sug_premia,baa_premia_minutes Dakot_premia
from  baam_premia_4_kds@KDS2baam
where baa_premia_year_month=pYM
union all
select * from  wr_premia_4_kds@KDS2wr1
 where wr_premia_year_month=pYM;
END pro_get_premiot_ovdim;


   PROCEDURE pro_upd_yamey_avoda_ovdim(pDt varchar) IS
   BEGIN
          update tb_yamey_avoda_ovdim  yao
      set --measher_o_mistayeg=2,
          tachograf=2
      where  exists (select * from tb_sidurim_ovdim so
           where meadken_acharon=-12
        and so.mispar_ishi=yao.mispar_ishi
        and  so.taarich=yao.taarich
        and mispar_sidur<>99200)
     and yao.taarich= to_date(pDt,'yyyymmdd');

         update tb_yamey_avoda_ovdim  yao
      set --measher_o_mistayeg=2,
          tachograf=2
      where  exists (select * from tb_sidurim_ovdim so
           where meadken_acharon=-12
        and so.mispar_ishi=yao.mispar_ishi
        and  so.taarich=yao.taarich
        and mispar_sidur<>99200)
     and yao.taarich= to_date(pDt,'yyyymmdd')+1;

 
-- 2010/06/29 measher_o_mistayeg
   update  tb_yamey_avoda_ovdim yao
 set   measher_o_mistayeg =1
where yao.taarich =  to_date(pDt,'yyyymmdd')
and measher_o_mistayeg is null
and not exists (select * from tb_sidurim_ovdim so
           where so.meadken_acharon=-12
        and so.mispar_ishi=yao.mispar_ishi
        and  so.taarich=yao.taarich
      and so.taarich =  to_date(pDt,'yyyymmdd')
        and so.mispar_sidur<>99200);

  --t2010/06/29 update measher_o_mistayeg=null,   for workers with any -12
 --     update  tb_yamey_avoda_ovdim yao
--set   measher_o_mistayeg =null
--where yao.taarich =  to_date(pDt,'yyyymmdd')
--and measher_o_mistayeg =1
--and exists (select * from tb_sidurim_ovdim so
  --         where meadken_acharon=-12
    --    and so.mispar_ishi=yao.mispar_ishi
      --  and  so.taarich=yao.taarich
     -- and so.taarich =  to_date(pDt,'yyyymmdd')
     --   and mispar_sidur<>99200);

 --           update  tb_yamey_avoda_ovdim  ty
--                   set ty.shat_hatchala         =
--                      (select min(so1.shat_hatchala)
--                       from  tb_sidurim_ovdim so1
--                       where
--                       so1.mispar_ishi          = ty.mispar_ishi and
--                       so1.taarich              = ty.taarich and
--                       so1.mispar_sidur         <>99200),
--                       ty.shat_siyum            =
--                      (select  max(so2.shat_gmar)
--                       from  tb_sidurim_ovdim so2
--                       where
--                       so2.mispar_ishi          = ty.mispar_ishi and
--                       so2.taarich              = ty.taarich and
--                       so2.mispar_sidur         <>99200)--,
--            --           ty.taarich_idkun_acharon = sysdate
--                WHERE
--                  ty.taarich       = to_date(pDt,'yyyymmdd');

--            update  tb_yamey_avoda_ovdim  ty
--                   set ty.shat_hatchala         =
--                      (select min(so1.shat_hatchala)
--                       from  tb_sidurim_ovdim so1
--                       where
--                       so1.mispar_ishi          = ty.mispar_ishi and
--                       so1.taarich              = ty.taarich and
--                       so1.mispar_sidur         <>99200),
--                       ty.shat_siyum            =
--                      (select  max(so2.shat_gmar)
--                       from  tb_sidurim_ovdim so2
--                       where
--                       so2.mispar_ishi          = ty.mispar_ishi and
--                       so2.taarich              = ty.taarich and
--                       so2.mispar_sidur         <>99200)--,
--             --          ty.taarich_idkun_acharon = sysdate
--                WHERE
--                  ty.taarich       = to_date(pDt,'yyyymmdd')+1;

    EXCEPTION
   WHEN OTHERS THEN
        RAISE;
      END pro_upd_yamey_avoda_ovdim;


--   PROCEDURE pro_upd_yamey_avoda_1oved(pDt varchar,pIshi varchar) IS
--   BEGIN
 --        update  tb_yamey_avoda_ovdim  ty
 --                  set ty.shat_hatchala         =
--                      (select min(so1.shat_hatchala)
--                       from  tb_sidurim_ovdim so1
--                       where
--                       so1.mispar_ishi          =pIshi  and
--                       so1.taarich              = ty.taarich and
--                       so1.mispar_sidur         <>99200),
--                       ty.shat_siyum            =
--                      (select  max(so2.shat_gmar)
--                       from  tb_sidurim_ovdim so2
--                       where
--                       so2.mispar_ishi          = pIshi and
--                       so2.taarich              = ty.taarich and
--                       so2.mispar_sidur         <>99200),
--                       ty.taarich_idkun_acharon = sysdate
--                WHERE
--                  ty.taarich       = to_date(pDt,'yyyymmdd')
--        and ty.mispar_ishi=pIshi     ;
--          EXCEPTION
--   WHEN OTHERS THEN
--        RAISE;
--      END pro_upd_yamey_avoda_1oved;




 PROCEDURE pro_get_my_attendance(pIshi varchar,pDt varchar,p_Cur OUT CurType) IS
  BEGIN
  OPEN p_Cur FOR
select  taarich,mikum_shaon_knisa,mikum_shaon_yetzia,
decode(to_char(shat_hatchala,'dd/mm/yyyy'),to_char(taarich,'dd/mm/yyyy'),' ',to_char(shat_hatchala,'dd/mm/yyyy'))||' '||
to_char(shat_hatchala,'hh24:mi') shat_hatchala,
decode(to_char(shat_gmar,'dd/mm/yyyy'),to_char(taarich,'dd/mm/yyyy'),' ',to_char(shat_gmar,'dd/mm/yyyy'))||' '||
to_char(shat_gmar,'hh24:mi') shat_gmar,
cast((shat_gmar - shat_hatchala)*24 as number(10,2)) zman
 from   tb_sidurim_ovdim
   where  mispar_ishi=pIshi
   and taarich = to_date(pDt,'yyyymmdd')
   and mispar_sidur=99001
   and shat_hatchala>to_date('28/02/1954','dd/mm/yyyy')
   and shat_gmar is not null
   union all
      select  taarich,mikum_shaon_knisa,mikum_shaon_yetzia,
decode(to_char(shat_hatchala,'dd/mm/yyyy'),to_char(taarich,'dd/mm/yyyy'),' ',to_char(shat_hatchala,'dd/mm/yyyy'))||' '||
to_char(shat_hatchala,'hh24:mi') shat_hatchala,
-- ' ' shat_gmar,0 zman
to_char(sysdate,'hh24:mi') shat_gmar,
cast((sysdate - shat_hatchala)*24 as number(10,2)) zman
 from   tb_sidurim_ovdim
   where  mispar_ishi=pIshi
   and taarich = to_date(pDt,'yyyymmdd')
   and shat_hatchala>to_date('28/02/1954','dd/mm/yyyy')
   and  shat_gmar  is null
   and taarich=trunc(sysdate)
   and mispar_sidur=99001
   union all
      select  taarich,mikum_shaon_knisa,mikum_shaon_yetzia,
'01/01/0001'  shat_hatchala,
decode(to_char(shat_gmar,'dd/mm/yyyy'),to_char(taarich,'dd/mm/yyyy'),' ',to_char(shat_gmar,'dd/mm/yyyy'))||' '||
to_char(shat_gmar,'hh24:mi') shat_gmar, 0  zman
 from   tb_sidurim_ovdim
   where  mispar_ishi=pIshi
   and taarich = to_date(pDt,'yyyymmdd')
   and mispar_sidur=99001
   and trunc(shat_hatchala)=to_date('01/01/0001','dd/mm/yyyy')
   and shat_gmar is not null
   union all
         select  taarich,mikum_shaon_knisa,mikum_shaon_yetzia,
'01/01/0001'  shat_hatchala,
decode(to_char(shat_gmar,'dd/mm/yyyy'),to_char(taarich,'dd/mm/yyyy'),' ',to_char(shat_gmar,'dd/mm/yyyy'))||' '||
to_char(shat_gmar,'hh24:mi') shat_gmar, 0  zman
 from   tb_sidurim_ovdim
 where  mispar_ishi=pIshi
   and taarich = to_date(pDt,'yyyymmdd')
  and mispar_sidur=99001
   and trunc(shat_hatchala)=to_date('01/01/0001','dd/mm/yyyy')
   and shat_gmar is null
   union all
      select  taarich,mikum_shaon_knisa,mikum_shaon_yetzia,
decode(to_char(shat_hatchala,'dd/mm/yyyy'),to_char(taarich,'dd/mm/yyyy'),' ',to_char(shat_hatchala,'dd/mm/yyyy'))||' '||
to_char(shat_hatchala,'hh24:mi') shat_hatchala,' ' shat_gmar,0 zman
 from   tb_sidurim_ovdim
   where  mispar_ishi=pIshi
   and taarich = to_date(pDt,'yyyymmdd')
   and shat_hatchala>to_date('28/02/1954','dd/mm/yyyy')
   and  shat_gmar  is null
   and taarich<trunc(sysdate)
   and mispar_sidur=99001
   union all
   select sysdate ,count(*),count(*)*8.9,null,null,sum(cast((nvl(shat_gmar,sysdate) - shat_hatchala)*24 as number(10,2)))
    from   tb_sidurim_ovdim
   where  mispar_ishi=pIshi
   and taarich = to_date(pDt,'yyyymmdd')
   and mispar_sidur=99001
   and shat_hatchala>to_date('28/02/1954','dd/mm/yyyy')
   --and shat_gmar is not null;
   ;
   END pro_get_my_attendance;

PROCEDURE pro_pivot(p_ishi varchar,p_Dt_from varchar,p_Dt_to varchar,p_Cur OUT CurType) IS
  BEGIN
  OPEN p_Cur FOR
select
  mispar_ishi,
  yechida_irgunit, taarich_hatzava, ezor,snif_av,mikum_yechida,  isuk, rishyon_autobus,mutaam,
    mutaam_bitachon,mercaz_erua,dirug,darga,maamad,gil,  tachanat_sachar,sug_misra,
 keren_revacha, tchilat_avoda
from (
  select
    mispar_ishi,
    max(case when kod_natun=1 then erech else null end) yechida_irgunit,
    max(case when  kod_natun=2 then erech else null end) taarich_hatzava,
    max(case when  kod_natun=3 then erech else null end)  ezor,
    max(case when kod_natun=4 then  nvl(erech,'kuku')   else null end) snif_av,
    max(case when  kod_natun=5 then erech else null end) mikum_yechida,
    max(case when  kod_natun=6  then nvl(erech,'kuku') else null end)  isuk,
    max(case when kod_natun=7 then erech else null end) rishyon_autobus,
    max(case when  kod_natun=8 then erech else null end) mutaam,
    max(case when  kod_natun=9 then erech else null end)  mutaam_bitachon,
    max(case when kod_natun=10 then erech else null end) mercaz_erua,
    max(case when  kod_natun=11 then erech else null end) dirug,
    max(case when  kod_natun=12 then erech else null end) darga,
    max(case when kod_natun=13 then erech else null end) maamad,
    max(case when  kod_natun=14 then erech else null end) gil,
    max(case when  kod_natun=15 then erech else null end)  tachanat_sachar,
    max(case when kod_natun=17 then erech else null end) sug_misra,
    max(case when  kod_natun=18 then erech else null end) keren_revacha,
    max(case when  kod_natun=19 then erech else null end) tchilat_avoda
  from
    pirtey_ovdim
 where  mispar_ishi=p_ishi
  and ((to_date(p_Dt_from,'dd/mm/yyyy') <= me_taarich  and to_date(p_Dt_to,'dd/mm/yyyy') >= me_taarich  and to_date(p_Dt_to,'dd/mm/yyyy') <= nvl(ad_taarich,to_date('31/12/4712','dd/mm/yyyy')))
  or  (to_date(p_Dt_from,'dd/mm/yyyy') <= me_taarich  and to_date(p_Dt_to,'dd/mm/yyyy') >= nvl(ad_taarich,to_date('31/12/4712','dd/mm/yyyy')))
     or (to_date(p_Dt_from,'dd/mm/yyyy') >= me_taarich  and to_date(p_Dt_from,'dd/mm/yyyy') <= nvl(ad_taarich,to_date('31/12/4712','dd/mm/yyyy')) and to_date(p_Dt_to,'dd/mm/yyyy') >= nvl(ad_taarich,to_date('31/12/4712','dd/mm/yyyy')))
  or (to_date(p_Dt_from,'dd/mm/yyyy') >= me_taarich   and to_date(p_Dt_to,'dd/mm/yyyy') <= nvl(ad_taarich,to_date('31/12/4712','dd/mm/yyyy'))))
  group by
   mispar_ishi);
end pro_pivot;

PROCEDURE pro_pivot_1Day(p_ishi varchar,p_Dt varchar,p_Cur OUT CurType) IS
  BEGIN
  OPEN p_Cur FOR
select
  mispar_ishi,
  yechida_irgunit, taarich_hatzava, ezor,snif_av,mikum_yechida,  isuk, rishyon_autobus,mutaam,
    mutaam_bitachon,mercaz_erua,dirug,darga,maamad,gil,  tachanat_sachar,sug_misra,
 keren_revacha, tchilat_avoda
from (
  select
    mispar_ishi,
    max(case when kod_natun=1 then erech else null end) yechida_irgunit,
    max(case when  kod_natun=2 then erech else null end) taarich_hatzava,
    max(case when  kod_natun=3 then erech else null end)  ezor,
    max(case when kod_natun=4 then  nvl(erech,'kuku')   else null end) snif_av,
    max(case when  kod_natun=5 then erech else null end) mikum_yechida,
    max(case when  kod_natun=6  then nvl(erech,'kuku') else null end)  isuk,
    max(case when kod_natun=7 then erech else null end) rishyon_autobus,
    max(case when  kod_natun=8 then erech else null end) mutaam,
    max(case when  kod_natun=9 then erech else null end)  mutaam_bitachon,
    max(case when kod_natun=10 then erech else null end) mercaz_erua,
    max(case when  kod_natun=11 then erech else null end) dirug,
    max(case when  kod_natun=12 then erech else null end) darga,
    max(case when kod_natun=13 then erech else null end) maamad,
    max(case when  kod_natun=14 then erech else null end) gil,
    max(case when  kod_natun=15 then erech else null end)  tachanat_sachar,
    max(case when kod_natun=17 then erech else null end) sug_misra,
    max(case when  kod_natun=18 then erech else null end) keren_revacha,
    max(case when  kod_natun=19 then erech else null end) tchilat_avoda
  from
    pirtey_ovdim
 where  mispar_ishi=p_ishi
 and to_date(p_Dt ,'dd/mm/yyyy') between me_taarich and ad_taarich
  group by
   mispar_ishi);
end pro_pivot_1Day;

PROCEDURE pro_ins_log_tahalich(p_KodTahalich  number  ,p_KodPeilut number,  p_KodStatus  number ,  p_TeurTech varchar  ) IS
  BEGIN

        INSERT INTO  tb_log_tahalich
   VALUES (p_KodTahalich,p_KodPeilut,sysdate,p_KodStatus,Null,null,p_TeurTech);

      EXCEPTION
   WHEN OTHERS THEN
        RAISE;
  END pro_ins_log_tahalich;

PROCEDURE pro_ins_log_tahalich_takala(p_KodTahalich  number  ,p_KodPeilut number,  p_KodStatus  number ,  p_TeurTech varchar  ,p_KodTakala number) IS
  BEGIN

        INSERT INTO  tb_log_tahalich
   VALUES (p_KodTahalich,p_KodPeilut,sysdate,p_KodStatus,p_KodTakala,null,p_TeurTech);

      EXCEPTION
   WHEN OTHERS THEN
        RAISE;
  END pro_ins_log_tahalich_takala;



  PROCEDURE pro_GetListDs(pDt varchar, pIshi varchar ,psidur varchar,p_cur out CurType)  IS
     BEGIN
 open p_cur for
   select to_char(shat_hatchala,'yyyymmddhh24mi') shat_hatchala,
 to_char(shat_gmar,'yyyymmddhh24mi') shat_gmar,
 to_char(shat_hatchala_letashlum,'yyyymmddhh24mi') shat_hatchala_letashlum,
 to_char(shat_gmar_letashlum,'yyyymmddhh24mi') shat_gmar_letashlum
  from tb_sidurim_ovdim
  where mispar_ishi=pIshi
  and taarich= to_date(pDt,'yyyymmdd')
  and mispar_sidur=psidur
  order by shat_hatchala;
    EXCEPTION
   WHEN OTHERS THEN
        RAISE;
 END pro_GetListDs;


  PROCEDURE pro_GetRowDt(pDt varchar, p_cur out CurType)  IS
     BEGIN
 open p_cur for
 select
               to_char(to_date(pDt ,'yyyymmdd')+1,'yyyymmdd')  thenextday
      from   dual;
        EXCEPTION
   WHEN OTHERS THEN
        RAISE;
END pro_GetRowDt;

 PROCEDURE pro_GetRowDtLong(pDt varchar, p_cur out CurType)  IS
     BEGIN
 open p_cur for
 select
           to_char(to_date(pDt ,'yyyymmddhh24mi')+(1/1440),'yyyymmddhh24mi')  thenextefes
       from   dual;
       EXCEPTION
   WHEN OTHERS THEN
        RAISE;
END pro_GetRowDtLong;

   PROCEDURE pro_GetRowDtVeryLong(pDt varchar, p_cur out CurType)  IS
     BEGIN
 open p_cur for
 select
           to_char(to_date(pDt ,'yyyymmddhh24mi')+(1/86400),'yyyymmddhh24miss') thenextdt
       from   dual;
       EXCEPTION
   WHEN OTHERS THEN
        RAISE;
END pro_GetRowDtVeryLong;


  PROCEDURE pro_GetRowDtVeryLong2(pDt varchar, phatchala varchar,pIshi varchar ,psidur varchar,p_cur out CurType)  IS
     BEGIN
 open p_cur for
 select
      to_char( max(shat_hatchala)  +(1/86400),'yyyymmddhh24miss') thenextdt
 from tb_sidurim_ovdim
 where mispar_ishi=pIshi
 and taarich=to_date(pDt,'yyyymmdd')
 and mispar_sidur=psidur
and      to_char(shat_hatchala ,'yyyymmddhh24mi')=     to_char(to_date(phatchala ,'yyyymmddhh24mi') ,'yyyymmddhh24mi');
      EXCEPTION
   WHEN OTHERS THEN
        RAISE;
END pro_GetRowDtVeryLong2;


  PROCEDURE pro_GetRowDtVeryLongPundakim2(pDt varchar, phatchala varchar,pIshi varchar ,p_cur out CurType)  IS
     BEGIN
 open p_cur for
 select
      to_char( max(shat_hityazvut)  +(1/86400),'yyyymmddhh24miss') thenextdt
  from tb_hityazvut_pundakim
  where mispar_ishi=pIshi
 and taarich=to_date(pDt,'yyyymmdd')
  and      to_char(shat_hityazvut ,'yyyymmddhh24mi')=     to_char(to_date(phatchala ,'yyyymmddhh24mi') ,'yyyymmddhh24mi');
     EXCEPTION
   WHEN OTHERS THEN
        RAISE;
END pro_GetRowDtVeryLongPundakim2;


  PROCEDURE pro_RefreshMv(shem_mvew varchar)  IS
  begin
 dbms_mview.refresh(shem_mvew,'c');

EXCEPTION
   WHEN OTHERS THEN
        RAISE;
 END pro_RefreshMv;



 procedure InsIntoTrailKnisa(pDt varchar, pDt_N_KNISA varchar,SRV_D_ISHI number,calc_D_new_sidur number,P24 number)  IS
     BEGIN
    insert into  trail_sidurim_ovdim
            (MISPAR_ISHI,MISPAR_sidur,TAARICH,Shat_hatchala,Shat_gmar,
            Shat_hatchala_letashlum,  Shat_gmar_letashlum,Pitzul_hafsaka,
            Chariga,Tosefet_Grira,Hashlama,yom_Visa,
            Lo_letashlum,Out_michsa,Mikum_shaon_knisa,
            Mikum_shaon_yetzia,Achuz_Knas_LePremyat_Visa,
            Achuz_Viza_Besikun,Mispar_Musach_O_Machsan,
            Kod_siba_lo_letashlum,Kod_siba_ledivuch_yadani_in,
            Kod_siba_ledivuch_yadani_out,Menahel_Musach_Meadken,Shayah_LeYom_Kodem ,Mispar_shiurey_nehiga,
            Mezake_Halbasha ,Mezake_nesiot,MEADKEN_ACHARON,TAARICH_IDKUN_ACHARON,
             tafkid_visa ,mivtza_visa ,Sug_Hazmanat_Visa,
             Bitul_O_Hosafa, Nidreshet_hitiatzvut ,Shat_hitiatzvut,  Ptor_Mehitiatzvut,
        Hachtama_Beatar_Lo_Takin  ,Hafhatat_Nochechut_Visa ,   Sector_Visa ,
       heara ,mispar_ishi_trail,taarich_idkun_trail,sug_peula)
            select MISPAR_ISHI,MISPAR_sidur,TAARICH,Shat_hatchala,Shat_gmar,
            Shat_hatchala_letashlum,  Shat_gmar_letashlum,Pitzul_hafsaka,
            Chariga,Tosefet_Grira, Hashlama,yom_Visa,
            Lo_letashlum,Out_michsa,Mikum_shaon_knisa,
            Mikum_shaon_yetzia,Achuz_Knas_LePremyat_Visa,
            Achuz_Viza_Besikun,Mispar_Musach_O_Machsan,
            Kod_siba_lo_letashlum,Kod_siba_ledivuch_yadani_in,
            Kod_siba_ledivuch_yadani_out,Menahel_Musach_Meadken,Shayah_LeYom_Kodem ,Mispar_shiurey_nehiga,            Mezake_Halbasha ,Mezake_nesiot,MEADKEN_ACHARON,TAARICH_IDKUN_ACHARON,
             tafkid_visa ,mivtza_visa ,Sug_Hazmanat_Visa,
             Bitul_O_Hosafa, Nidreshet_hitiatzvut ,Shat_hitiatzvut,  Ptor_Mehitiatzvut,
        Hachtama_Beatar_Lo_Takin  ,Hafhatat_Nochechut_Visa ,   Sector_Visa ,
             heara,-11,sysdate ,3
            from tb_sidurim_ovdim
             where mispar_ishi=SRV_D_ISHI
             and taarich=to_date(pDt,'yyyymmdd') + P24
             and mispar_sidur=  calc_D_new_sidur
             and shat_hatchala = to_date(pDt_N_KNISA,'yyyymmddhh24mi') +  P24  ;
      EXCEPTION
   WHEN OTHERS THEN
        RAISE;
             end  InsIntoTrailKnisa;

    procedure InsIntoTrailYetzia(pDt varchar, pDt_N_YETZIA varchar,SRV_D_ISHI number,calc_D_new_sidur number,P24 number)  IS
     BEGIN
    insert into  trail_sidurim_ovdim
            (MISPAR_ISHI,MISPAR_sidur,TAARICH,Shat_hatchala,Shat_gmar,
            Shat_hatchala_letashlum,  Shat_gmar_letashlum,Pitzul_hafsaka,
            Chariga,Tosefet_Grira,Hashlama,yom_Visa,
            Lo_letashlum,Out_michsa,Mikum_shaon_knisa,
            Mikum_shaon_yetzia,Achuz_Knas_LePremyat_Visa,
            Achuz_Viza_Besikun,Mispar_Musach_O_Machsan,
            Kod_siba_lo_letashlum,Kod_siba_ledivuch_yadani_in,
            Kod_siba_ledivuch_yadani_out,Shayah_LeYom_Kodem ,Mispar_shiurey_nehiga,
            Mezake_Halbasha ,Mezake_nesiot,MEADKEN_ACHARON,TAARICH_IDKUN_ACHARON,
             tafkid_visa ,mivtza_visa ,Sug_Hazmanat_Visa,
             Bitul_O_Hosafa, Nidreshet_hitiatzvut ,Shat_hitiatzvut,  Ptor_Mehitiatzvut,
        Hachtama_Beatar_Lo_Takin  ,Hafhatat_Nochechut_Visa ,   Sector_Visa ,
            heara ,mispar_ishi_trail,taarich_idkun_trail,sug_peula)
            select MISPAR_ISHI,MISPAR_sidur,TAARICH,Shat_hatchala,Shat_gmar,
            Shat_hatchala_letashlum,  Shat_gmar_letashlum,Pitzul_hafsaka,
            Chariga,Tosefet_Grira,Hashlama,yom_Visa,
            Lo_letashlum,Out_michsa,Mikum_shaon_knisa,
            Mikum_shaon_yetzia,Achuz_Knas_LePremyat_Visa,
            Achuz_Viza_Besikun,Mispar_Musach_O_Machsan,
            Kod_siba_lo_letashlum,Kod_siba_ledivuch_yadani_in,
            Kod_siba_ledivuch_yadani_out,Shayah_LeYom_Kodem ,Mispar_shiurey_nehiga,
            Mezake_Halbasha ,Mezake_nesiot,MEADKEN_ACHARON,TAARICH_IDKUN_ACHARON,
             tafkid_visa ,mivtza_visa ,Sug_Hazmanat_Visa,
             Bitul_O_Hosafa, Nidreshet_hitiatzvut ,Shat_hitiatzvut,  Ptor_Mehitiatzvut,
        Hachtama_Beatar_Lo_Takin  ,Hafhatat_Nochechut_Visa ,   Sector_Visa ,
             heara,-11,sysdate ,3
            from tb_sidurim_ovdim
             where mispar_ishi=SRV_D_ISHI
             and taarich=to_date(pDt,'yyyymmdd')
             and mispar_sidur=  calc_D_new_sidur
    and to_char(shat_hatchala,'yyyymmdd')='00010101'
            and shat_gmar=to_date(pDt_N_YETZIA,'yyyymmddhh24mi') +P24 ;
       EXCEPTION
   WHEN OTHERS THEN
        RAISE;
            end  InsIntoTrailYetzia;


 PROCEDURE pro_get_yamei_avoda_meshek(p_date DATE,p_bakasha_id number, p_Cur OUT CurType) is
  begin
      OPEN p_cur  for
      /* alef */
        select distinct  ya.mispar_ishi,ya.taarich
        from tb_yamey_avoda_ovdim ya,ovdim o
        where  o.mispar_ishi=ya.mispar_ishi
        and  exists
        (select mispar_ishi
          from tb_sidurim_ovdim so
          where so.mispar_ishi=ya.mispar_ishi
          and so.taarich=ya.taarich and so.meadken_acharon=-11
          and so.taarich_idkun_acharon>nvl(ya.ritzat_shgiot_acharona,so.taarich_idkun_acharon-1)
          )
       and ya.measher_o_mistayeg is not null
       and nvl(ya.status,-1)<>0
          /* bet */
            union select DISTINCT   ya.mispar_ishi,ya.taarich
            from tb_yamey_avoda_ovdim ya,ovdim o
            where ya.taarich=p_date
               and  o.mispar_ishi=ya.mispar_ishi
               and not exists(select 1 from tb_sidurim_ovdim so where so.mispar_ishi=ya.mispar_ishi
                                        and so.taarich=ya.taarich and so.meadken_acharon=-12)
              and exists(select 1 from tb_sidurim_ovdim so where so.mispar_ishi=ya.mispar_ishi
                                        and so.taarich=ya.taarich and so.meadken_acharon<>-12)
            /* gimel */
			/* 20101006:
        union select h.Mispar_Ishi, h.Taarich 
        from Ovdim_Im_Shinuy_HR h, TB_YAMEY_AVODA_OVDIM y,
		  CTB_Isuk i,   tmp_pirtey_ovdim v_pirty_oved,ovdim ov
        where h.Mispar_Ishi=y.Mispar_Ishi
          and h.Taarich=Y.Taarich
          and nvl(y. RITZAT_SHGIOT_ACHARONA,h.Taarich_Idkun_HR-1)<h.Taarich_Idkun_HR
          and (y.STATUS<>0 or y.STATUS is null)
          and y. Measher_O_Mistayeg Is not Null
		    and h.mispar_ishi            = ov.mispar_ishi
		    and v_pirty_oved.mispar_ishi(+) = h.mispar_ishi
        and h.taarich  between v_pirty_oved.me_tarich(+) and v_pirty_oved.ad_tarich(+)
         and i.kod_hevra = ov.kod_hevra
		 and  i.kod_isuk =v_pirty_oved.isuk
		 20101006*/
        /*dalet*/
        union select  distinct mispar_ishi, taarich
      from
       (select distinct t.mispar_ishi, t.kod_ishur,t.taarich, t.mispar_sidur, t.shat_hatchala,
             t.shat_yetzia, t.mispar_knisa  ,t.rama,t.kod_status_ishur,t.taarich_idkun_acharon,
              max(t.rama) KEEP (DENSE_RANK LAST ORDER BY t.rama )
                OVER (PARTITION BY t.mispar_ishi,t.taarich,t.kod_ishur ) max_f4
              from tb_ishurim t, tb_yamey_avoda_ovdim ya,ovdim o
              where  t.taarich=ya.taarich
              and t.mispar_ishi=ya.mispar_ishi
              and  o.mispar_ishi=ya.mispar_ishi
              and t.taarich_idkun_acharon>nvl(ya.ritzat_shgiot_acharona,t.taarich_idkun_acharon-1)
            )
           where max_f4=rama
           and kod_status_ishur in (1,2)
       
       /*heih*/    
        union select distinct  ya.mispar_ishi,ya.taarich
        from tb_yamey_avoda_ovdim ya
        where YA.RITZAT_SHGIOT_ACHARONA=to_date('01/01/0001','dd/mm/yyyy');
 end pro_get_yamei_avoda_meshek;

   PROCEDURE pro_get_all_yamei_avoda(  p_Cur OUT CurType) is
    begin
      OPEN p_cur for
         select ya.mispar_ishi,ya.taarich
        from tb_yamey_avoda_ovdim ya,ovdim o
        where ya.taarich> to_date('28/02/2010','dd/mm/yyyy') and ya.taarich<to_date('02/03/2010','dd/mm/yyyy')
  and o.mispar_ishi=ya.mispar_ishi
  order by o.mispar_ishi;
     --   and status is null;
        --where ya.taarich<=trunc(sysdate).;
  end pro_get_all_yamei_avoda;

  PROCEDURE pro_get_yamei_avoda_shinui_hr(p_date DATE, p_bakasha_id number, p_Cur OUT CurType) is
  begin 
    OPEN p_cur for 
        /* gimel */
        select h.Mispar_Ishi, h.Taarich 
        from Ovdim_Im_Shinuy_HR h, TB_YAMEY_AVODA_OVDIM y,
          CTB_Isuk i,   tmp_pirtey_ovdim v_pirty_oved,ovdim ov
        where h.Mispar_Ishi=y.Mispar_Ishi
          and h.Taarich=Y.Taarich
          and nvl(y. RITZAT_SHGIOT_ACHARONA,h.Taarich_Idkun_HR-1)<h.Taarich_Idkun_HR
          and (y.STATUS<>0 or y.STATUS is null)
          and y. Measher_O_Mistayeg Is not Null
            and h.mispar_ishi            = ov.mispar_ishi
            and v_pirty_oved.mispar_ishi(+) = h.mispar_ishi
        and h.taarich  between v_pirty_oved.me_tarich(+) and v_pirty_oved.ad_tarich(+)
         and i.kod_hevra = ov.kod_hevra
         and  i.kod_isuk =v_pirty_oved.isuk;
  end pro_get_yamei_avoda_shinui_hr;

       PROCEDURE pro_new_rec(  SRV_D_ISHI varchar,  SRV_D_TAARICH varchar,  calc_D_new_sidur varchar,
      SRV_D_KNISA_X varchar,  SRV_D_MIKUM_KNISA varchar,  SRV_D_SIBAT_DIVUACH_KNISA varchar,
      SRV_D_YETZIA_X varchar,  SRV_D_MIKUM_YETZIA varchar,  SRV_D_SIBAT_DIVUACH_YETZIA varchar,
      SRV_D_ISHI_MEADKEN varchar,
   SRV_D_KOD_BITUL_ZMAN_NESIA_X varchar,
      SRV_D_KOD_CHARIGA_X varchar,  SRV_D_KOD_HALBASHA_X varchar,  SRV_D_KOD_HAZMANA_X varchar,
      TAARICH_knisa_p24 number , TAARICH_yetzia_p24 number,  DatEfes varchar,
      TAARICH_knisa_letashlum_p24 number,  SRV_D_KNISA_letashlum_X varchar,
      TAARICH_yetzia_letashlum_p24 number,  SRV_D_YETZIA_letashlum_X varchar) is
    begin
 if length(SRV_D_KNISA_X) = 4 then
          insert into tb_sidurim_ovdim ( mispar_ishi  ,   taarich ,  mispar_sidur   , shat_hatchala   ,mikum_shaon_knisa  ,
             Kod_siba_ledivuch_yadani_in,  shat_gmar ,  mikum_shaon_yetzia   ,Kod_siba_ledivuch_yadani_out,
             shat_hatchala_letashlum , shat_gmar_letashlum , chariga    ,hashlama  , lo_letashlum  ,mezake_nesiot,
            mezake_halbasha, Shayah_LeYom_Kodem, Menahel_Musach_Meadken,meadken_acharon)
             values  ( SRV_D_ISHI ,
            to_date(SRV_D_TAARICH,'yyyymmdd') +   TAARICH_knisa_p24,
            calc_D_new_sidur ,
             to_date(SRV_D_KNISA_X ,'yyyymmddhh24mi') +  TAARICH_knisa_p24 ,
            decode(Trim(SRV_D_MIKUM_KNISA) , '' ,null, '00000',null,trim(SRV_D_MIKUM_KNISA) ),
            SRV_D_SIBAT_DIVUACH_KNISA ,
   to_date(SRV_D_YETZIA_X ,'yyyymmddhh24mi') +  TAARICH_yetzia_p24,
            decode (Trim(SRV_D_MIKUM_YETZIA) , '',null, '00000',null, trim(SRV_D_MIKUM_YETZIA)),
            decode (Trim(SRV_D_SIBAT_DIVUACH_YETZIA) , '',null, '00',null, '0',null,trim(SRV_D_SIBAT_DIVUACH_YETZIA)),
            to_date(SRV_D_KNISA_letashlum_X ,'yyyymmddhh24mi') +  TAARICH_knisa_letashlum_p24,
            to_date(SRV_D_YETZIA_letashlum_X ,'yyyymmddhh24mi') +  TAARICH_yetzia_letashlum_p24,
            decode( SRV_D_KOD_CHARIGA_X , '' ,  0,SRV_D_KOD_CHARIGA_X ),
            decode( SRV_D_KOD_HAZMANA_X  , '0' , null,'' ,null, '7',null, SRV_D_KOD_HAZMANA_X ),
            decode( SRV_D_KOD_HAZMANA_X , '7' ,1,null),
            decode ( SRV_D_KOD_BITUL_ZMAN_NESIA_X , '',null, '0',null, SRV_D_KOD_BITUL_ZMAN_NESIA_X),
    decode ( SRV_D_KOD_HALBASHA_X , '', null, '0',null,  SRV_D_KOD_HALBASHA_X),
            decode( TAARICH_knisa_p24 , 1 ,1,null),
            decode( SRV_D_ISHI_MEADKEN  , '0' ,'', '00000' ,'', 0,'',SRV_D_ISHI_MEADKEN ),
      -11);
   else
          insert into tb_sidurim_ovdim ( mispar_ishi  ,   taarich ,  mispar_sidur   , shat_hatchala   ,mikum_shaon_knisa  ,
             Kod_siba_ledivuch_yadani_in,  shat_gmar ,  mikum_shaon_yetzia   ,Kod_siba_ledivuch_yadani_out,
             shat_hatchala_letashlum , shat_gmar_letashlum , chariga    ,hashlama  , lo_letashlum  ,mezake_nesiot,
            mezake_halbasha, Shayah_LeYom_Kodem, Menahel_Musach_Meadken,meadken_acharon)
             values  ( SRV_D_ISHI ,
            to_date(SRV_D_TAARICH,'yyyymmdd') +   TAARICH_knisa_p24,
            calc_D_new_sidur ,
             to_date(SRV_D_KNISA_X ,'yyyymmddhh24miss') +  TAARICH_knisa_p24 ,
            decode(Trim(SRV_D_MIKUM_KNISA) , '' ,null, '00000',null,trim(SRV_D_MIKUM_KNISA) ),
            SRV_D_SIBAT_DIVUACH_KNISA ,
   to_date(SRV_D_YETZIA_X ,'yyyymmddhh24mi') +  TAARICH_yetzia_p24,
            decode (Trim(SRV_D_MIKUM_YETZIA) , '',null, '00000',null, trim(SRV_D_MIKUM_YETZIA)),
            decode (Trim(SRV_D_SIBAT_DIVUACH_YETZIA) , '',null, '00',null, '0',null,trim(SRV_D_SIBAT_DIVUACH_YETZIA)),
            to_date(SRV_D_KNISA_letashlum_X ,'yyyymmddhh24mi') +  TAARICH_knisa_letashlum_p24,
            to_date(SRV_D_YETZIA_letashlum_X ,'yyyymmddhh24mi') +  TAARICH_yetzia_letashlum_p24,
            decode( SRV_D_KOD_CHARIGA_X , '' ,  0,SRV_D_KOD_CHARIGA_X ),
            decode( SRV_D_KOD_HAZMANA_X  , '0' , null,'' ,null, '7',null, SRV_D_KOD_HAZMANA_X ),
            decode( SRV_D_KOD_HAZMANA_X , '7' ,1,null),
            decode ( SRV_D_KOD_BITUL_ZMAN_NESIA_X , '',null, '0',null, SRV_D_KOD_BITUL_ZMAN_NESIA_X),
    decode ( SRV_D_KOD_HALBASHA_X , '', null, '0',null,  SRV_D_KOD_HALBASHA_X),
            decode( TAARICH_knisa_p24 , 1 ,1,null),
            decode( SRV_D_ISHI_MEADKEN  , '0' ,'', '00000' ,'', 0,'',SRV_D_ISHI_MEADKEN ),
      -11);
   end if;
    EXCEPTION
   WHEN OTHERS THEN
        RAISE;
  end pro_new_rec;

       PROCEDURE pro_measher_o_mistayeg(  SRV_D_ISHI varchar,  SRV_D_TAARICH varchar,  TAARICH_knisa_p24 number ) is
    begin
              update tb_yamey_avoda_ovdim
                 set measher_o_mistayeg = 1
                          where mispar_ishi= SRV_D_ISHI
                       and taarich =   to_date(SRV_D_TAARICH,'yyyymmdd') +   TAARICH_knisa_p24;
    EXCEPTION
   WHEN OTHERS THEN
        RAISE;
     end pro_measher_o_mistayeg;

            PROCEDURE pro_lo_letashlum(  SRV_D_ISHI varchar,  SRV_D_TAARICH varchar,  TAARICH_knisa_p24 number ) is
    begin
              update tb_sidurim_ovdim
                 set  lo_letashlum = 1 ,KOD_SIBA_LO_LETASHLUM=3
                          where mispar_ishi= SRV_D_ISHI
                       and taarich =   to_date(SRV_D_TAARICH,'yyyymmdd') +   TAARICH_knisa_p24
        and mispar_sidur=99200;
    EXCEPTION
   WHEN OTHERS THEN
        RAISE;
     end pro_lo_letashlum;

     procedure pro_upd_out_blank(  SRV_D_ISHI varchar,  SRV_D_TAARICH varchar,  calc_D_new_sidur varchar,
      SRV_D_KNISA_X varchar,  SRV_D_MIKUM_KNISA varchar,  SRV_D_SIBAT_DIVUACH_KNISA varchar,
      SRV_D_YETZIA_X varchar,  SRV_D_MIKUM_YETZIA varchar,  SRV_D_SIBAT_DIVUACH_YETZIA varchar,
      SRV_D_ISHI_MEADKEN varchar,
   SRV_D_KOD_BITUL_ZMAN_NESIA_X varchar,
      SRV_D_KOD_CHARIGA_X varchar,  SRV_D_KOD_HALBASHA_X varchar,  SRV_D_KOD_HAZMANA_X varchar,
      TAARICH_knisa_p24 number , TAARICH_yetzia_p24 number,  DatEfes varchar,
      TAARICH_knisa_letashlum_p24 number,  SRV_D_KNISA_letashlum_X varchar,
      TAARICH_yetzia_letashlum_p24 number,  SRV_D_YETZIA_letashlum_X varchar) is
    begin
             update tb_sidurim_ovdim
             set shat_gmar=  to_date(SRV_D_YETZIA_X ,'yyyymmddhh24mi') +  TAARICH_yetzia_p24,
     mikum_shaon_yetzia=decode(Trim(SRV_D_MIKUM_YETZIA) , '', mikum_shaon_yetzia,'00000',mikum_shaon_yetzia,trim(SRV_D_MIKUM_YETZIA)),
      Kod_siba_ledivuch_yadani_out =trim(SRV_D_SIBAT_DIVUACH_YETZIA),
      Menahel_Musach_Meadken=decode(Trim(SRV_D_ISHI_MEADKEN) ,'',Menahel_Musach_Meadken,'0',Menahel_Musach_Meadken,'00000',Menahel_Musach_Meadken,trim(SRV_D_ISHI_MEADKEN)),
     shat_hatchala_letashlum=to_date(SRV_D_KNISA_letashlum_X ,'yyyymmddhh24mi') +  TAARICH_knisa_letashlum_p24,
              shat_gmar_letashlum=to_date(SRV_D_YETZIA_letashlum_X ,'yyyymmddhh24mi') +  TAARICH_yetzia_letashlum_p24,
      chariga=decode(Trim(SRV_D_KOD_CHARIGA_X) ,'',chariga,'0',chariga,Trim(SRV_D_KOD_CHARIGA_X)),
              hashlama=decode(trim(SRV_D_KOD_HAZMANA_X ),'',hashlama,'0',hashlama,'7',hashlama,trim(SRV_D_KOD_HAZMANA_X)),
     lo_letashlum=decode(trim(SRV_D_KOD_HAZMANA_X),'7',1,lo_letashlum),
     mezake_nesiot=decode(Trim(SRV_D_KOD_BITUL_ZMAN_NESIA_X),'',mezake_nesiot,'0',mezake_nesiot,Trim(SRV_D_KOD_BITUL_ZMAN_NESIA_X)),
             mezake_halbasha=decode(Trim(SRV_D_KOD_HALBASHA_X) ,'',mezake_halbasha,'0',mezake_halbasha,Trim(SRV_D_KOD_HALBASHA_X)),
             taarich_idkun_acharon = sysdate
             where mispar_ishi= SRV_D_ISHI
             and taarich =   to_date(SRV_D_TAARICH,'yyyymmdd') +   TAARICH_knisa_p24
             and mispar_sidur= calc_D_new_sidur
             and shat_hatchala =    to_date(SRV_D_KNISA_X ,'yyyymmddhh24mi') +  TAARICH_knisa_p24;
  EXCEPTION
   WHEN OTHERS THEN
        RAISE;
     end pro_upd_out_blank;

         procedure pro_upd_in_blank(  SRV_D_ISHI varchar,  SRV_D_TAARICH varchar,  calc_D_new_sidur varchar,
      SRV_D_KNISA_X varchar,  SRV_D_MIKUM_KNISA varchar,  SRV_D_SIBAT_DIVUACH_KNISA varchar,
      SRV_D_YETZIA_X varchar,  SRV_D_MIKUM_YETZIA varchar,  SRV_D_SIBAT_DIVUACH_YETZIA varchar,
      SRV_D_ISHI_MEADKEN varchar,
   SRV_D_KOD_BITUL_ZMAN_NESIA_X varchar,
      SRV_D_KOD_CHARIGA_X varchar,  SRV_D_KOD_HALBASHA_X varchar,  SRV_D_KOD_HAZMANA_X varchar,
      TAARICH_knisa_p24 number , TAARICH_yetzia_p24 number,  DatEfes varchar,
      TAARICH_knisa_letashlum_p24 number,  SRV_D_KNISA_letashlum_X varchar,
      TAARICH_yetzia_letashlum_p24 number,  SRV_D_YETZIA_letashlum_X varchar) is
    begin
             update tb_sidurim_ovdim s1
               set shat_hatchala=to_date(SRV_D_KNISA_X ,'yyyymmddhh24mi') +  TAARICH_knisa_p24 ,
          mikum_shaon_knisa=decode(Trim(SRV_D_MIKUM_KNISA) , '', mikum_shaon_knisa,'00000',mikum_shaon_knisa,trim(SRV_D_MIKUM_KNISA)),
         Kod_siba_ledivuch_yadani_in=trim(SRV_D_SIBAT_DIVUACH_KNISA),
         --meadken_acharon=decode(Trim(SRV_D_ISHI_MEADKEN) ,'',meadken_acharon,'0',meadken_acharon,'00000',meadken_acharon,trim(SRV_D_ISHI_MEADKEN)),
      Menahel_Musach_Meadken=decode(Trim(SRV_D_ISHI_MEADKEN) ,'',Menahel_Musach_Meadken,'0',Menahel_Musach_Meadken,'00000',Menahel_Musach_Meadken,trim(SRV_D_ISHI_MEADKEN)),
          shat_hatchala_letashlum=to_date(SRV_D_KNISA_letashlum_X ,'yyyymmddhh24mi') +  TAARICH_knisa_letashlum_p24,
                 shat_gmar_letashlum=to_date(SRV_D_YETZIA_letashlum_X ,'yyyymmddhh24mi') +  TAARICH_yetzia_letashlum_p24,
         chariga=decode(Trim(SRV_D_KOD_CHARIGA_X) ,'',chariga,'0',chariga,Trim(SRV_D_KOD_CHARIGA_X)),
                 hashlama=decode(trim(SRV_D_KOD_HAZMANA_X ),'',hashlama,'0',hashlama,'7',hashlama,trim(SRV_D_KOD_HAZMANA_X)),
        lo_letashlum=decode(trim(SRV_D_KOD_HAZMANA_X),'7',1,lo_letashlum),
        mezake_nesiot=decode(Trim(SRV_D_KOD_BITUL_ZMAN_NESIA_X),'',mezake_nesiot,'0',mezake_nesiot,Trim(SRV_D_KOD_BITUL_ZMAN_NESIA_X)),
                mezake_halbasha=decode(Trim(SRV_D_KOD_HALBASHA_X) ,'',mezake_halbasha,'0',mezake_halbasha,Trim(SRV_D_KOD_HALBASHA_X)),
                taarich_idkun_acharon = sysdate
                where mispar_ishi= SRV_D_ISHI
                 and taarich =   to_date(SRV_D_TAARICH,'yyyymmdd') +   TAARICH_knisa_p24
                and mispar_sidur= calc_D_new_sidur
        and to_char(shat_hatchala,'yyyymmdd')='00010101'
                and shat_gmar=to_date(SRV_D_YETZIA_X ,'yyyymmddhh24mi') + TAARICH_yetzia_p24
         and not exists (select * from tb_sidurim_ovdim s2
      where  s2.mispar_ishi= SRV_D_ISHI
         and s2.taarich =   to_date(SRV_D_TAARICH,'yyyymmdd') +   TAARICH_knisa_p24
         and s2.mispar_sidur= calc_D_new_sidur
           and s2.shat_hatchala=to_date(SRV_D_KNISA_X ,'yyyymmddhh24mi') +  TAARICH_knisa_p24 )  ;
  EXCEPTION
   WHEN OTHERS THEN
        RAISE;
     end pro_upd_in_blank;

   procedure pro_upd_in_out_letashlum(  SRV_D_ISHI varchar,  SRV_D_TAARICH varchar,  calc_D_new_sidur varchar,
      SRV_D_KNISA_X varchar,
   --SRV_D_MIKUM_KNISA varchar,  SRV_D_SIBAT_DIVUACH_KNISA varchar,
      SRV_D_YETZIA_X varchar,
   --SRV_D_MIKUM_YETZIA varchar,  SRV_D_SIBAT_DIVUACH_YETZIA varchar,
      SRV_D_ISHI_MEADKEN varchar,
   SRV_D_KOD_BITUL_ZMAN_NESIA_X varchar,
      --SRV_D_KOD_CHARIGA_X varchar,
   SRV_D_KOD_HALBASHA_X varchar,
   --SRV_D_KOD_HAZMANA_X varchar,
      TAARICH_knisa_p24 number , TAARICH_yetzia_p24 number,  DatEfes varchar,
      TAARICH_knisa_letashlum_p24 number,  SRV_D_KNISA_letashlum_X varchar,
      TAARICH_yetzia_letashlum_p24 number,  SRV_D_YETZIA_letashlum_X varchar) is
    begin
               update tb_sidurim_ovdim
       set  shat_hatchala_letashlum=
    decode(SRV_D_KNISA_letashlum_X,null,shat_hatchala_letashlum,to_date(SRV_D_KNISA_letashlum_X ,'yyyymmddhh24mi')  +TAARICH_knisa_letashlum_p24),
    --to_date(SRV_D_KNISA_letashlum_X ,'yyyymmddhh24mi') +  TAARICH_knisa_letashlum_p24,
              shat_gmar_letashlum=
    decode(SRV_D_yetzia_letashlum_X,null,shat_gmar_letashlum,to_date(SRV_D_yetzia_letashlum_X ,'yyyymmddhh24mi')  +TAARICH_yetzia_letashlum_p24),
     --to_date(SRV_D_YETZIA_letashlum_X ,'yyyymmddhh24mi') +  TAARICH_yetzia_letashlum_p24,
     mezake_nesiot=decode(Trim(SRV_D_KOD_BITUL_ZMAN_NESIA_X),'',mezake_nesiot,'0',mezake_nesiot,Trim(SRV_D_KOD_BITUL_ZMAN_NESIA_X)),
              mezake_halbasha=decode(Trim(SRV_D_KOD_HALBASHA_X) ,'',mezake_halbasha,'0',mezake_halbasha,Trim(SRV_D_KOD_HALBASHA_X)),
          --meadken_acharon=decode(Trim(SRV_D_ISHI_MEADKEN) ,'',meadken_acharon,'0',meadken_acharon,'00000',meadken_acharon,trim(SRV_D_ISHI_MEADKEN)),
      Menahel_Musach_Meadken=decode(Trim(SRV_D_ISHI_MEADKEN) ,'',Menahel_Musach_Meadken,'0',Menahel_Musach_Meadken,'00000',Menahel_Musach_Meadken,trim(SRV_D_ISHI_MEADKEN)),
     taarich_idkun_acharon = sysdate
   where mispar_ishi= SRV_D_ISHI
           and taarich =   to_date(SRV_D_TAARICH,'yyyymmdd') +   TAARICH_knisa_p24
        and mispar_sidur= calc_D_new_sidur
           and shat_hatchala =    to_date(SRV_D_KNISA_X ,'yyyymmddhh24mi') +  TAARICH_knisa_p24
          and shat_gmar=to_date(SRV_D_YETZIA_X ,'yyyymmddhh24mi') + TAARICH_yetzia_p24;
   EXCEPTION
   WHEN OTHERS THEN
        RAISE;
             end pro_upd_in_out_letashlum;


            PROCEDURE pro_ins_yamey_avoda_1oved(SRV_D_ISHI number,  SRV_D_TAARICH varchar) IS
   BEGIN
                     insert into tb_yamey_avoda_ovdim ( mispar_ishi,taarich  )
                     values  (  SRV_D_ISHI ,
                            to_date(SRV_D_TAARICH ,'yyyymmdd')  );
     EXCEPTION
   WHEN OTHERS THEN
        RAISE;
     end pro_ins_yamey_avoda_1oved;

   PROCEDURE pro_new_rec_pundakim(  SRV_D_ISHI varchar,  SRV_D_TAARICH varchar,
                                     SRV_D_KNISA_X varchar,  SRV_D_MIKUM_KNISA varchar,   TAARICH_knisa_p24 number)  IS
   BEGIN
 if length(SRV_D_KNISA_X) = 4 then
          insert into tb_hityazvut_pundakim ( mispar_ishi  ,   taarich ,  shat_hityazvut   ,mikum_shaon  ,meadken_acharon)
             values  ( SRV_D_ISHI ,
            to_date(SRV_D_TAARICH,'yyyymmdd') +   TAARICH_knisa_p24,
             to_date(SRV_D_KNISA_X ,'yyyymmddhh24mi') +  TAARICH_knisa_p24 ,
            decode(Trim(SRV_D_MIKUM_KNISA) , '' ,'0', '00000','0',trim(SRV_D_MIKUM_KNISA) ),
      -11);
   else
          insert into tb_hityazvut_pundakim ( mispar_ishi  ,   taarich ,  shat_hityazvut   ,mikum_shaon  ,meadken_acharon)
             values  ( SRV_D_ISHI ,
            to_date(SRV_D_TAARICH,'yyyymmdd') +   TAARICH_knisa_p24,
             to_date(SRV_D_KNISA_X ,'yyyymmddhh24miss') +  TAARICH_knisa_p24 ,
            decode(Trim(SRV_D_MIKUM_KNISA) , '' ,'0', '00000','0',trim(SRV_D_MIKUM_KNISA) ),
      -11);
   end if;
              EXCEPTION
   WHEN OTHERS THEN
        RAISE;
     end pro_new_rec_pundakim;

   PROCEDURE pro_GetListDsPundakim(pDt varchar, pIshi varchar ,p_cur out CurType)    IS
     BEGIN
 open p_cur for
   select to_char(shat_hityazvut,'yyyymmddhh24mi') shat_hityazvut
  from  tb_hityazvut_pundakim
  where mispar_ishi=pIshi
  and taarich= to_date(pDt,'yyyymmdd')
   order by shat_hityazvut;
         EXCEPTION
   WHEN OTHERS THEN
        RAISE;
     end pro_GetListDsPundakim ;

	 PROCEDURE pro_insert_debug_maatefet(p_mispar_ishi NUMBER, p_taarich date, p_taarich_ritza date,
                                    p_bakasha_id number, p_sug_bakasha number,
                                    p_comments test_maatefet.comments%type default null)					 is
        begin
          insert into test_maatefet(mispar_ishi, taarich, taarich_ritza, bakasha_id, sug_bakasha,comments)
          values(p_mispar_ishi , p_taarich , p_taarich_ritza ,
                                    p_bakasha_id , p_sug_bakasha, p_comments);

        end pro_insert_debug_maatefet;


procedure pro_IfSdrnManas(pDt varchar,pIshi varchar ,p_cur out CurType)  IS
     BEGIN
 open p_cur for
   select erech from Pirtey_Ovdim
where Kod_Natun=6
and trunc(Erech) in ('0420', '0422','420','422',420, 422)
and  to_date(pDt,'yyyymmdd') between me_taarich and ad_taarich
and mispar_ishi=pIshi ;
 EXCEPTION
   WHEN OTHERS THEN
        RAISE;
end pro_IfSdrnManas;

procedure pro_get_shinuy_matsav_ovdim( p_Cur out CurType) is
 BEGIN


 		       open p_Cur for
		 --select * from(
			   		select   a.mispar_ishi, a.taarich_hatchala,
							   		decode(a.taarich_siyum,null,trunc(sysdate-1),decode( instr((sysdate-1)-a.taarich_siyum,'-'),1,trunc(sysdate-1), a.taarich_siyum)) date_a,
								--	decode( instr((sysdate-1)-b.taarich_siyum,'-'),1,trunc(sysdate-1), b.taarich_siyum) date_b,
								decode( instr((sysdate-1)-b.taarich_siyum,'-'),1,trunc(sysdate-1),decode(b.taarich_siyum,null,decode(b.kod_matzav,null,null,trunc(sysdate-1)),b.taarich_siyum) )date_b,
									a.kod_matzav erech_a,b.kod_matzav erech_b,0 kod
					 from
									(select * from matzav_ovdim minus select * from new_matzav_ovdim) a,
									new_matzav_ovdim b
						where a.mispar_ishi=b.mispar_ishi(+)
							  and a.taarich_hatchala=b.taarich_hatchala(+)
							  and a.taarich_hatchala <= trunc(sysdate)
		union
			   		select  a.mispar_ishi, a.taarich_hatchala,
							   		decode(a.taarich_siyum,null,trunc(sysdate-1),decode( instr((sysdate-1)-a.taarich_siyum,'-'),1,trunc(sysdate-1), a.taarich_siyum)) date_a,
									decode( instr((sysdate-1)-b.taarich_siyum,'-'),1,trunc(sysdate-1),decode(b.taarich_siyum,null,decode(b.kod_matzav,null,null,trunc(sysdate-1)),b.taarich_siyum) )date_b,
								--	decode( instr((sysdate-1)-b.taarich_siyum,'-'),1,trunc(sysdate-1), b.taarich_siyum) date_b,
									a.kod_matzav erech_a,b.kod_matzav erech_b,0 kod
					 from
									(select * from new_matzav_ovdim minus select * from matzav_ovdim) a,
									matzav_ovdim b
						where a.mispar_ishi=b.mispar_ishi(+)
							  and a.taarich_hatchala=b.taarich_hatchala(+)
							  and a.taarich_hatchala <= trunc(sysdate);
				--	  	)
				--	where mispar_ishi =763;
				--	where RowNum<6;


  EXCEPTION
   WHEN OTHERS THEN
        RAISE;
end pro_get_shinuy_matsav_ovdim;

procedure pro_get_Shinuy_meafyeney_bizua( p_Cur out CurType) is
 BEGIN


 		       open p_Cur for
		--select * from(
			   		   	select  a.mispar_ishi, a.me_taarich taarich_hatchala,
						   		decode(a.ad_taarich,null,trunc(sysdate-1),decode( instr((sysdate-1)-a.ad_taarich,'-'),1,trunc(sysdate-1), a.ad_taarich)) date_a,
					--			decode( instr((sysdate-1)-b.ad_taarich,'-'),1,trunc(sysdate-1), b.ad_taarich) date_b,
								decode( instr((sysdate-1)-b.ad_taarich,'-'),1,trunc(sysdate-1),decode(b.ad_taarich,null,decode(b.erech_ishi ,null,null,trunc(sysdate-1)),b.ad_taarich) )date_b,
								a.erech_ishi erech_a,b.erech_ishi erech_b ,0 kod
					 from
								(select * from meafyenim_ovdim minus select * from new_meafyenim_ovdim) a,
								new_meafyenim_ovdim b
					 where a.mispar_ishi=b.mispar_ishi(+)
							and a.me_taarich=b.me_taarich(+)
							and a.kod_meafyen = b.kod_meafyen(+)
							and a.me_taarich <= trunc(sysdate)
						--	and  a.mispar_ishi=43998
	union
			   			select  a.mispar_ishi, a.me_taarich taarich_hatchala,
						   		decode(a.ad_taarich,null,trunc(sysdate-1),decode( instr((sysdate-1)-a.ad_taarich,'-'),1,trunc(sysdate-1), a.ad_taarich)) date_a,
						--		decode( instr((sysdate-1)-b.ad_taarich,'-'),1,trunc(sysdate-1), b.ad_taarich) date_b,
						decode( instr((sysdate-1)-b.ad_taarich,'-'),1,trunc(sysdate-1),decode(b.ad_taarich,null,decode(b.erech_ishi ,null,null,trunc(sysdate-1)),b.ad_taarich) )date_b,
								a.erech_ishi erech_a,b.erech_ishi erech_b ,0 kod
					 from
								(select * from new_meafyenim_ovdim minus select * from meafyenim_ovdim) a,
								meafyenim_ovdim b
					 where a.mispar_ishi=b.mispar_ishi(+)
							and a.me_taarich=b.me_taarich(+)
							and a.kod_meafyen = b.kod_meafyen(+)
							and a.me_taarich<= trunc(sysdate);
						--and  a.mispar_ishi=43998;
				--	)
			--	where mispar_ishi=224;


  EXCEPTION
   WHEN OTHERS THEN
        RAISE;
end pro_get_Shinuy_meafyeney_bizua;

procedure pro_get_shinuy_pirey_oved(p_Cur out CurType) is
 BEGIN


 		       open p_Cur for
			   		  select   a.mispar_ishi, a.me_taarich taarich_hatchala,
								 decode(a.ad_taarich,null,trunc(sysdate-1),decode( instr((sysdate-1)-a.ad_taarich,'-'),1,trunc(sysdate-1), a.ad_taarich)) date_a,
							--	decode( instr((sysdate-1)-b.ad_taarich,'-'),1,trunc(sysdate-1), b.ad_taarich) date_b,
							decode( instr((sysdate-1)-b.ad_taarich,'-'),1,trunc(sysdate-1),decode(b.ad_taarich,null,decode(b.erech ,null,null,trunc(sysdate-1)),b.ad_taarich) )date_b,
						   		a.erech erech_a,b.erech  erech_b,0 kod
					 from
							(select * from pirtey_ovdim minus select * from new_pirtey_ovdim) a,
							new_pirtey_ovdim b
					where a.mispar_ishi=b.mispar_ishi(+)
							and a.me_taarich=b.me_taarich(+)
							and a.kod_natun  = b.kod_natun (+)
							and a.me_taarich <= trunc(sysdate)
		union
					 select   a.mispar_ishi, a.me_taarich taarich_hatchala,
								 decode(a.ad_taarich,null,trunc(sysdate-1),decode( instr((sysdate-1)-a.ad_taarich,'-'),1,trunc(sysdate-1), a.ad_taarich)) date_a,
							--	decode( instr((sysdate-1)-b.ad_taarich,'-'),1,trunc(sysdate-1), b.ad_taarich) date_b,
							decode( instr((sysdate-1)-b.ad_taarich,'-'),1,trunc(sysdate-1),decode(b.ad_taarich,null,decode(b.erech ,null,null,trunc(sysdate-1)),b.ad_taarich) )date_b,
						   		a.erech erech_a,b.erech  erech_b,0 kod
					 from
							(select * from new_pirtey_ovdim minus select * from pirtey_ovdim) a,
							pirtey_ovdim b
					where a.mispar_ishi=b.mispar_ishi(+)
							and a.me_taarich=b.me_taarich(+)
							and a.kod_natun  = b.kod_natun (+)
							and a.me_taarich <= trunc(sysdate);


  EXCEPTION
   WHEN OTHERS THEN
        RAISE;
end pro_get_shinuy_pirey_oved;

procedure pro_get_shinuy_brerot_mechdal(p_Cur out CurType) is
 BEGIN


 		       open p_Cur for
			   		select a.kod_meafyen  kod, a.me_taarich taarich_hatchala,
											 decode(a.ad_taarich,null,trunc(sysdate-1),decode( instr((sysdate-1)-a.ad_taarich,'-'),1,trunc(sysdate-1), a.ad_taarich)) date_a,
											-- decode( instr((sysdate-1)-b.ad_taarich,'-'),1,trunc(sysdate-1), b.ad_taarich) date_b,
											decode( instr((sysdate-1)-b.ad_taarich,'-'),1,trunc(sysdate-1),decode(b.ad_taarich,null,decode(b.erech ,null,null,trunc(sysdate-1)),b.ad_taarich) )date_b,
						   		             a.erech erech_a,b.erech  erech_b,0 mispar_ishi
								from
											(select * from new_brerot_mechdal_meafyenim minus select * from brerot_mechdal_meafyenim) a,
											brerot_mechdal_meafyenim b
								where a.kod_meafyen=b.kod_meafyen(+)
									   and a.me_taarich=b.me_taarich(+)
									   and a.me_taarich <= trunc(sysdate)
									 --  and a.kod_meafyen=5
				union
					  	 	   select a.kod_meafyen  kod, a.me_taarich taarich_hatchala,
											 decode(a.ad_taarich,null,trunc(sysdate-1),decode( instr((sysdate-1)-a.ad_taarich,'-'),1,trunc(sysdate-1), a.ad_taarich)) date_a,
									--		 decode( instr((sysdate-1)-b.ad_taarich,'-'),1,trunc(sysdate-1), b.ad_taarich) date_b,
									decode( instr((sysdate-1)-b.ad_taarich,'-'),1,trunc(sysdate-1),decode(b.ad_taarich,null,decode(b.erech ,null,null,trunc(sysdate-1)),b.ad_taarich) )date_b,
						   		             a.erech erech_a,b.erech  erech_b,0 mispar_ishi
								from
											(select * from brerot_mechdal_meafyenim minus select * from new_brerot_mechdal_meafyenim) a,
											new_brerot_mechdal_meafyenim b
								where a.kod_meafyen=b.kod_meafyen(+)
									   and a.me_taarich=b.me_taarich(+)
									   and a.me_taarich <= trunc(sysdate);
								--	   and a.kod_meafyen=5;


  EXCEPTION
   WHEN OTHERS THEN
        RAISE;
end pro_get_shinuy_brerot_mechdal;

procedure pro_ins_ovdim_im_shinuy_hr(p_coll_obj_ovdim_im_shinuy_hr in coll_ovdim_im_shinuy_hr,
		  														   	  			 p_tavla in varchar ) IS
idNumber number;
 BEGIN
    IF (p_coll_obj_ovdim_im_shinuy_hr is not null) THEN
                 FOR i IN 1..p_coll_obj_ovdim_im_shinuy_hr.COUNT LOOP
				   	    --check if exist in table
				BEGIN

				select nvl(o.mispar_ishi,0)
						into idNumber
						from OVDIM_IM_SHINUY_HR o
						where o.mispar_ishi = p_coll_obj_ovdim_im_shinuy_hr(i).mispar_ishi
							  and o. taarich =   trunc(p_coll_obj_ovdim_im_shinuy_hr(i).taarich);
			     EXCEPTION
  				 		    WHEN NO_DATA_FOUND  THEN
        						 idNumber:=0;
				END;
						--if no then insert else update
				IF (idNumber =0) then
				   			 	PKG_BATCH.inset_oved_im_shinuy_hr( p_coll_obj_ovdim_im_shinuy_hr(i).mispar_ishi,
																	 trunc( p_coll_obj_ovdim_im_shinuy_hr(i).taarich),p_tavla);
		       ELSE
								PKG_BATCH.update_oved_im_shinuy_hr	( p_coll_obj_ovdim_im_shinuy_hr(i).mispar_ishi,
																	 trunc( p_coll_obj_ovdim_im_shinuy_hr(i).taarich));

				 END IF;
			 END LOOP;
	 END IF;
	--select 4 into idNumber from dual;
  EXCEPTION
   WHEN OTHERS THEN
        RAISE;
end pro_ins_ovdim_im_shinuy_hr;

procedure pro_ins_defaults_hr(p_coll_obj_brerot_mechdal_hr in coll_brerot_mechdal_meafyenim) IS
CURSOR p_cur(p_kod meafyenim_ovdim.KOD_MEAFYEN%type ,
	   			   				 p_me_taarich tb_yamey_avoda_ovdim.TAARICH%type,
								 p_ad_taarich  tb_yamey_avoda_ovdim.TAARICH%type) IS
	    select distinct y.MISPAR_ISHI,y.TAARICH
					 from tb_yamey_avoda_ovdim y,
					           MEAFYENIM_OVDIM m
					 where y.MISPAR_ISHI = m.MISPAR_ISHI
					 	   		and  m.KOD_MEAFYEN = p_kod
								and y.TAARICH between  p_me_taarich   and  p_ad_taarich ;
								--and  y.MISPAR_ISHI=3620;

idNumber number;
v_rec  p_cur%ROWTYPE;
BEGIN
 IF (p_coll_obj_brerot_mechdal_hr  is not null) THEN
       FOR i IN 1..p_coll_obj_brerot_mechdal_hr.COUNT LOOP
			FOR v_rec  in   p_cur(p_coll_obj_brerot_mechdal_hr(i).kod_meafyen ,
			 						   p_coll_obj_brerot_mechdal_hr(i). me_taarich,
									   p_coll_obj_brerot_mechdal_hr(i). ad_taarich )
			  LOOP
				  	 	BEGIN
							select o.mispar_ishi
								into idNumber
								from OVDIM_IM_SHINUY_HR o
								 where o.mispar_ishi = v_rec.mispar_ishi
							         and o. taarich =   trunc(v_rec.taarich);
						   EXCEPTION
	  				 		    WHEN NO_DATA_FOUND  THEN
	        						 idNumber:=0;
							END;
								IF (idNumber =0) then
				   			 	   			    PKG_BATCH.inset_oved_im_shinuy_hr( v_rec.mispar_ishi, trunc(v_rec.taarich),'brerot_mechdal');
						       ELSE
											PKG_BATCH.update_oved_im_shinuy_hr	( v_rec.mispar_ishi, trunc(v_rec.taarich));
								 END IF;
			  END LOOP;
       END LOOP;
END IF;
 EXCEPTION
   WHEN OTHERS THEN
        RAISE;
END pro_ins_defaults_hr;


PROCEDURE inset_oved_im_shinuy_hr(p_mispar_ishi in number,
		  											   	   	   			  		 p_taarich in Date,
																				 p_tavla in varchar ) IS
BEGIN
	 	     INSERT INTO OVDIM_IM_SHINUY_HR(
						   						   			   							   	 		 mispar_ishi,
						   									   	  						   	 		 taarich,
																									 taarich_idkun_hr,
																									 tavla )
																			   VALUES (
																									  p_mispar_ishi,
																									 p_taarich,
																									   sysdate,
																									   p_tavla);
END inset_oved_im_shinuy_hr;

procedure update_oved_im_shinuy_hr(p_mispar_ishi in number,
		  											   	   	   			  		 p_taarich in Date) IS
BEGIN
	 	  UPDATE  OVDIM_IM_SHINUY_HR o
		  SET o. taarich_idkun_hr=sysdate --,
		     --    tavla ='upd'
		  WHERE 	o.mispar_ishi = p_mispar_ishi
	  				   and o. taarich =   p_taarich;
END update_oved_im_shinuy_hr;

PROCEDURE MoveOldMatzavOvdimToNew  IS
BEGIN
	 execute immediate  'truncate table Matzav_Ovdim' ;    
	 execute immediate ' insert into Matzav_Ovdim select * from new_Matzav_Ovdim';
EXCEPTION
   WHEN OTHERS THEN
   		ROLLBACK;
        RAISE;
END MoveOldMatzavOvdimToNew;

PROCEDURE MoveOldPirteyOvedToNew  IS
BEGIN
	  execute immediate  'truncate table pirtey_ovdim' ;    
	 execute immediate 'insert into pirtey_ovdim select * from new_pirtey_ovdim';
EXCEPTION
   WHEN OTHERS THEN
   		ROLLBACK;
        RAISE;
END MoveOldPirteyOvedToNew;

PROCEDURE MoveOldMeafyenimOvdimToNew  IS
BEGIN
	 execute immediate  'truncate table meafyenim_ovdim' ;    
	 execute immediate 'insert into meafyenim_ovdim select * from new_meafyenim_ovdim';
EXCEPTION
   WHEN OTHERS THEN
   		ROLLBACK;
        RAISE;
END MoveOldMeafyenimOvdimToNew;

PROCEDURE MoveOldBrerotMechdalToNew  IS
BEGIN
	 execute immediate  'truncate table Brerot_Mechdal_Meafyenim' ;    
	 execute immediate 'insert into Brerot_Mechdal_Meafyenim select * from new_Brerot_Mechdal_Meafyenim';
EXCEPTION
   WHEN OTHERS THEN
   		ROLLBACK;
        RAISE;
END  MoveOldBrerotMechdalToNew;


PROCEDURE pro_get_ovdim4rerunsdrn( pDt varchar,p_Cur OUT CurType) IS
  BEGIN
  OPEN p_Cur FOR
select y.mispar_ishi
  from tb_yamey_avoda_ovdim y
where  y.taarich=to_date(pDt,'yyyymmdd')
 and measher_o_mistayeg is null
 union all
 select y.mispar_ishi
  from tb_yamey_avoda_ovdim y
where  y.taarich=to_date(pDt,'yyyymmdd')
 and measher_o_mistayeg =1
and  not exists (select * from tb_sidurim_ovdim s
  	 	 				  	   where  s.taarich=to_date(pDt,'yyyymmdd')
							   and s.taarich=y.taarich
							   and s.mispar_ishi=y.mispar_ishi
						   and (s.mispar_sidur<99000 or s.mispar_sidur>99999));
						   EXCEPTION
   WHEN OTHERS THEN
        RAISE;
END  pro_get_ovdim4rerunsdrn;

  PROCEDURE pro_sof_meafyenim( pDt varchar,p_Cur out CurType)  IS
     BEGIN
 open p_Cur for
select  count(*) ct
from   tb_log_tahalich
where trunc(taarich)  = to_date(pDt,'yyyymmdd')
  and kod_tahalich=3
  and kod_peilut_tahalich =33
  and status=2;
						   EXCEPTION
   WHEN OTHERS THEN
        RAISE;
END  pro_sof_meafyenim;

procedure pro_get_premia_input(p_taarich date, p_bakasha_id tb_bakashot.bakasha_id%type,p_Cur OUT CurType) is
begin
    OPEN p_Cur FOR
       select CY.MISPAR_ISHI,
           CS.MISPAR_SIDUR,
           CY.TAARICH,
           CY.KOD_RECHIV ,
           CY.ERECH_RECHIV,
           SP.KOD_PREMIA,
           PO.EZOR, PO.MAAMAD, PO.MUTAAM, PO.GIL, PO.ISUK,
           O.SHEM_MISH,O.SHEM_PRAT,
           pkg_ovdim.fun_get_meafyen_oved(CY.MISPAR_ISHI,60,CY.TKUFA) meafeyn_60,
           pkg_ovdim.fun_get_meafyen_oved(CY.MISPAR_ISHI,74,CY.TKUFA) meafeyn_74,
           pkg_ovdim.func_get_mispar_tachana(CY.MISPAR_ISHI,CS.MISPAR_SIDUR,CY.TAARICH,CS.SHAT_HATCHALA) mispar_tachana
        from TB_CHISHUV_YOMI_OVDIM cy,
             (select distinct t.mispar_ishi,T.BAKASHA_ID,T.MISPAR_SIDUR,T.KOD_RECHIV,T.SHAT_HATCHALA,T.TAARICH,
                  min(T.SHAT_HATCHALA) KEEP (DENSE_RANK LAST ORDER BY T.SHAT_HATCHALA)
                    OVER (PARTITION BY t.mispar_ishi,T.BAKASHA_ID,T.KOD_RECHIV,T.TAARICH ) min_shat_hat
                  from TB_CHISHUV_SIDUR_OVDIM t
                ) cs,
             CTB_SUGEY_PREMIOT sp ,
             TMP_PIRTEY_OVDIM po,
             ovdim o 
        where CY.KOD_RECHIV in (256,257,258,259,260)
        and tkufa=p_taarich
        and CY.BAKASHA_ID=p_bakasha_id
        and CY.BAKASHA_ID=CS.BAKASHA_ID
        and CY.MISPAR_ISHI=CS.MISPAR_ISHI
        and CY.KOD_RECHIV=CS.KOD_RECHIV
        and CY.TAARICH=CS.TAARICH
        and  cs.SHAT_HATCHALA=cs.min_shat_hat
        and CY.KOD_RECHIV=SP.KOD_RACHIV_NOCHECHUT(+)
        and CY.MISPAR_ISHI=O.MISPAR_ISHI
        and CY.MISPAR_ISHI=PO.MISPAR_ISHI
        and CY.TKUFA between PO.ME_TARICH and nvl(PO.AD_TARICH,CY.TKUFA+1)
        order by MISPAR_ISHI,mispar_tachana,TAARICH;
        
end pro_get_premia_input;
procedure pro_update_calc_premia(p_taarich date, p_bakasha_id tb_bakashot.bakasha_id%type, p_mispar_ishi number,
            p_kod_rechiv number, p_erech_rechiv number) as
 v_count number;
begin
    select count(*) into v_count
    from TB_CHISHUV_CHODESH_OVDIM t 
    where  T.KOD_RECHIV = p_kod_rechiv
        and T.MISPAR_ISHI = p_mispar_ishi
        and T.TAARICH = p_taarich
        and T.BAKASHA_ID = p_bakasha_id;
    
    if v_count=0 then
        insert into TB_CHISHUV_CHODESH_OVDIM(MISPAR_ISHI,TAARICH,BAKASHA_ID,KOD_RECHIV,ERECH_RECHIV )
        values(p_mispar_ishi,p_taarich,p_bakasha_id,p_kod_rechiv,p_erech_rechiv);
    else
        update TB_CHISHUV_CHODESH_OVDIM t 
            set T.ERECH_RECHIV=p_erech_rechiv
        where  T.KOD_RECHIV = p_kod_rechiv
            and T.MISPAR_ISHI = p_mispar_ishi
            and T.TAARICH = p_taarich
            and T.BAKASHA_ID = p_bakasha_id;
    end if;
    
end pro_update_calc_premia;
procedure pro_get_premia_bakashot(p_taarich date,p_Cur OUT CurType) is
begin
    OPEN p_Cur FOR
    Select TB.Bakasha_ID,TB.Bakasha_ID || ' '||  TB.Teur || ' ' || to_char(TB.Zman_Hatchala,'dd.mm.yyyy') Teur_Bakasha
        From TB_Bakashot TB,
        TB_BAKASHOT_PARAMS TC 
        Where TB.Sug_Bakasha=1
        And TB.Status in (2,4)
        And TB.Bakasha_ID=TC.Bakasha_ID
        And TC.PARAM_ID = 2
        And to_date('01/' || TC.ERECH,'dd/mm/yyyy') >= p_taarich
        Order By TB.Zman_Hatchala;

end pro_get_premia_bakashot;
PROCEDURE pro_if_start(p_Cur OUT CurType) IS
  BEGIN
  OPEN p_Cur FOR
select  count(*) ct
from tb_log_tahalich
where taarich>=trunc(sysdate)
 and kod_tahalich=1
and kod_peilut_tahalich=1
and trim(teur_tech)='start KdsSchedulerProc'  ;
   END pro_if_start;
   
 PROCEDURE pro_if_GalreadyRun(p_Cur OUT CurType) IS
  BEGIN
  OPEN p_Cur FOR
 select   nvl(min( status),0) stat1,nvl(max(status),0) stat2
from tb_log_tahalich   
where taarich>=trunc(sysdate)
and kod_tahalich=8
and kod_peilut_tahalich=3
and ( status=1  or  status=2);
   END pro_if_GalreadyRun;

procedure pro_get_ovdim_lehishuv_premiot(p_Cur OUT CurType) is
 begin
    open p_Cur for
    select mispar_ishi,chodesh
    from ovdim_lechishuv_premyot lp
    where LP.BAKASHA_ID is null
    order by chodesh;
 end pro_get_ovdim_lehishuv_premiot; 
 
 procedure pro_update_chishuv_premia(p_bakasha_id tb_bakashot.bakasha_id%type,
            p_mispar_ishi OVDIM_LECHISHUV_PREMYOT.MISPAR_ISHI%type,
            p_chodesh ovdim_lechishuv_premyot.chodesh%type) is
  begin
    update ovdim_lechishuv_premyot lp
    set LP.BAKASHA_ID=p_bakasha_id
    where LP.MISPAR_ISHI=p_mispar_ishi 
        and LP.CHODESH=p_chodesh; 
  end pro_update_chishuv_premia;
  
  procedure pro_ins_ovdim_lehishuv_premiot(pYMf NUMBER,pYM2 NUMBER) is
 begin
 delete from   Ovdim_Lechishuv_Premyot;
  insert into  Ovdim_Lechishuv_Premyot( mispar_ishi,chodesh)
 select distinct oved,tkufa from (select distinct wr_premia_empl  oved,to_date(wr_premia_year_month*100+01,'yyyymmdd') tkufa
from  wr_premia_4_kds@KDS2wr1
 where wr_premia_year_month  between pYMf and pYM2
 union all
    select distinct baa_premia_empl  ,to_date(baa_premia_year_month*100+01,'yyyymmdd') 
from  baam_premia_4_kds@KDS2baam
where baa_premia_year_month between  pYMf and pYM2
 union all 
 select distinct mispar_ishi,to_date(to_char(taarich,'yyyymm')*100+01,'yyyymmdd')
 from tb_sidurim_ovdim
where taarich between to_date(pYMf*100+01,'yyyymmdd') and  last_day(to_date(pYM2*100+01,'yyyymmdd'))
and mispar_sidur between 99220 and 99222);
 end pro_ins_ovdim_lehishuv_premiot; 
 
END PKG_BATCH;
/
CREATE OR REPLACE PACKAGE PKG_CALC AS
/******************************************************************************
   NAME:       PKG_CALC
   PURPOSE:

   REVISIONS:
   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        05/07/2009             1. Created this package.
******************************************************************************/


 TYPE    CurType      IS    REF  CURSOR;

	PROCEDURE pro_get_yemey_avoda_to_oved(p_mispar_ishi in tb_yamey_avoda_ovdim.mispar_ishi%type,
															p_taarich_me in tb_yamey_avoda_ovdim.taarich%type,
															p_taarich_ad in tb_yamey_avoda_ovdim.taarich%type,
															p_status_tipul  in  tb_yamey_avoda_ovdim.status_tipul%type,
														p_cur out CurType) ;

  PROCEDURE pro_ins_chishuv_sidur_ovdim(p_coll_chishuv_sidur in  COLL_CHISHUV_SIDUR);

  PROCEDURE pro_ins_chishuv_yomi_ovdim(p_coll_chishuv_yomi in  COLL_CHISHUV_YOMI);
	 PROCEDURE pro_ins_chishuv_yomi_tmp(p_coll_chishuv_yomi in  COLL_CHISHUV_YOMI);

	  PROCEDURE pro_ins_chishuv_codesh_ovdim(p_coll_chishuv_chodesh in  COLL_CHISHUV_CHODESH);
	 PROCEDURE pro_ins_chishuv_codesh_tmp(p_coll_chishuv_chodesh in  COLL_CHISHUV_CHODESH) ;

	PROCEDURE pro_ins_chishuv( p_coll_chishuv_chodesh in  COLL_CHISHUV_CHODESH,
												p_coll_chishuv_yomi in  COLL_CHISHUV_YOMI,
												p_coll_chishuv_sidur in  COLL_CHISHUV_SIDUR);

		PROCEDURE pro_ins_chishuv_tmp(p_coll_chishuv_chodesh in  COLL_CHISHUV_CHODESH,
												p_coll_chishuv_yomi in  COLL_CHISHUV_YOMI);

	PROCEDURE pro_get_peiluyot_lesidur(p_mispar_ishi IN  tb_peilut_ovdim.MISPAR_ISHI%type,
																			p_taarich IN  tb_peilut_ovdim.TAARICH%type,
																				p_shat_hatchala_sidur IN  tb_peilut_ovdim.SHAT_HATCHALA_SIDUR%type,
																			p_mispar_sidur IN  tb_peilut_ovdim.MISPAR_SIDUR%type,
																			p_cur out CurType);
	PROCEDURE pro_upd_sidurim_lo_letashlum(p_mispar_ishi IN  tb_sidurim_ovdim.MISPAR_ISHI%type,
																			p_taarich IN  tb_sidurim_ovdim.TAARICH%type,
																			p_mispar_sidur IN  tb_sidurim_ovdim.MISPAR_SIDUR%type,
																			p_shat_hatchala IN  tb_sidurim_ovdim.SHAT_HATCHALA%type);

	PROCEDURE pro_get_michsa_yomit(p_me_taarich IN  tb_michsa_yomit.me_taarich%type,
																			p_ad_taarich IN  tb_michsa_yomit.ad_taarich%type,
																			p_cur out CurType);

	PROCEDURE pro_get_oved_putar( p_mispar_ishi IN  MATZAV_OVDIM.mispar_ishi%type,
		  					  				   	   						p_tar_chodesh_me IN MATZAV_OVDIM.Taarich_hatchala%type,
																		p_tar_chodesh_ad IN  MATZAV_OVDIM.Taarich_hatchala%type,
																		p_putar out NUMBER);


		/*PROCEDURE pro_ins;		*/
END PKG_CALC;
/

CREATE OR REPLACE PACKAGE BODY PKG_CALC AS
/******************************************************************************
   NAME:       PKG_CALC
   PURPOSE:

   REVISIONS:
   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        05/07/2009             1. Created this package body.
******************************************************************************/



/*   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0       05/07/2009     sari      1.      */
	PROCEDURE pro_get_yemey_avoda_to_oved(p_mispar_ishi in tb_yamey_avoda_ovdim.mispar_ishi%type,
														p_taarich_me in tb_yamey_avoda_ovdim.taarich%type,
															p_taarich_ad in tb_yamey_avoda_ovdim.taarich%type,
															p_status_tipul  in  tb_yamey_avoda_ovdim.status_tipul%type,
														p_cur out CurType) is
	begin
		 open p_cur for
			 	   select y.taarich,y.shat_hatchala,y.shat_siyum ,s.mispar_sidur, nvl(s.lo_letashlum,0) lo_letashlum,
				   		  s.shat_hatchala shat_hatchala_sidur,s.shat_hatchala_letashlum ,s.shat_gmar_letashlum,
						   s.shat_gmar shat_gmar_sidur,
						  to_char(s.taarich,'d') day_taarich,
							  y.hamarat_shabat ,y.TACHOGRAF,
							      v_sidurim.sidur_misug_headrut,
								     v_sidurim.sector_avoda,
									    v_sidurim.sug_avoda,
										 v_sidurim.SUG_SIDUR,
										--s.Km_visa_lepremia,
										 v_sidurim.sidur_namlak_visa,
										decode(s.out_michsa,null,0, s.out_michsa) out_michsa,
										y.lina,y.halbasha,
										s.pitzul_hafsaka,nvl(s.Mezake_Halbasha,0)Mezake_Halbasha,
										v_sidurim.michsat_shaot_chodshit,
										v_sidurim.max_dakot_boded,
										  v_sidurim.max_shaot_byom_shishi	,
										    v_sidurim.max_shaot_beshabaton	,
											  v_sidurim.dakot_n_letashlum_hol, nvl(s.sug_hashlama,0)sug_hashlama,
											  v_sidurim.sug_shaot_byom_hol_if_migbala,
											  	nvl(s.Hashlama,0) Hashlama,s.Bitul_O_Hosafa,
												y.Hashlama_Leyom,nvl(s.yom_VISA,0) yom_VISA,
												v_sidurim.ein_leshalem_tos_lila,
												nvl(y.Zman_Nesia_Haloch,0) Zman_Nesia_Haloch,
												nvl(y.Zman_Nesia_Hazor,0 ) Zman_Nesia_Hazor ,
												v_sidurim.zakay_lehamara,nvl(s.Hafhatat_Nochechut_Visa,0) Hafhatat_Nochechut_Visa,
												nvl(s.Mezake_nesiot,0)Mezake_nesiot ,y.BITUL_ZMAN_NESIOT,
										nvl(s.KOD_SIBA_LEDIVUCH_YADANI_IN,0)KOD_SIBA_LEDIVUCH_YADANI_IN,nvl(s.kod_siba_ledivuch_yadani_out,0) kod_siba_ledivuch_yadani_out,
										nvl(s.Achuz_knas_lepremyat_visa,0)Achuz_knas_lepremyat_visa,nvl(s.ACHUZ_VIZA_BESIKUN,0) ACHUZ_VIZA_BESIKUN
					from tb_yamey_avoda_ovdim y,(select * from tb_sidurim_ovdim where   (lo_letashlum=0 or lo_letashlum is null)) s,
				   		     tmp_sidurim_meyuchadim v_sidurim,ovdim o
					where o.mispar_ishi=p_mispar_ishi
					and y.mispar_ishi=o.mispar_ishi
					and y.mispar_ishi=s.mispar_ishi(+)
					and y.taarich between p_taarich_me and p_taarich_ad
					and  v_sidurim.mispar_sidur(+)=s.mispar_sidur
					and  s.taarich between v_sidurim.me_tarich(+) and v_sidurim.ad_tarich(+)
					and y.taarich=s.taarich(+)
					--and (y.status_tipul=p_status_tipul or p_status_tipul is null)
			        and (y.status=1 or y.status=2) --or  p_status_tipul is null)
					  and not nvl(s.Bitul_O_Hosafa,0)  in (1,3)
					order by y.taarich asc;

  EXCEPTION
       WHEN OTHERS THEN
				RAISE;
end  pro_get_yemey_avoda_to_oved;

/*   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        08/07/2009      sari       1.      */
  PROCEDURE pro_ins_chishuv_sidur_ovdim(p_coll_chishuv_sidur in  COLL_CHISHUV_SIDUR) IS
 BEGIN
 	  if p_coll_chishuv_sidur is not null then
  	   		For i   in  1..p_coll_chishuv_sidur.count     LOOP
  	   					INSERT INTO TB_Chishuv_Sidur_Ovdim
			                   (MISPAR_ISHI,BAKASHA_ID,MISPAR_SIDUR,SHAT_HATCHALA,TAARICH,KOD_RECHIV,ERECH_RECHIV)
					VALUES (p_coll_chishuv_sidur(i).mispar_ishi,p_coll_chishuv_sidur(i).bakasha_id,p_coll_chishuv_sidur(i).mispar_sidur,
						   				p_coll_chishuv_sidur(i).shat_hatchala,p_coll_chishuv_sidur(i).taarich,p_coll_chishuv_sidur(i).kod_rechiv,p_coll_chishuv_sidur(i).erech_rechiv);
			  END LOOP;
		end if;
      EXCEPTION
		 WHEN OTHERS THEN
		      RAISE;
  END pro_ins_chishuv_sidur_ovdim;

  /*   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        08/07/2009      sari       1.     */
  PROCEDURE pro_ins_chishuv_yomi_ovdim(p_coll_chishuv_yomi in  COLL_CHISHUV_YOMI) IS
 BEGIN
  	   if p_coll_chishuv_yomi is not null then
  	   		For i   in  1..p_coll_chishuv_yomi.count     LOOP
  	   			    INSERT INTO TB_Chishuv_yomi_Ovdim
			                   (MISPAR_ISHI,BAKASHA_ID,TAARICH,KOD_RECHIV,ERECH_RECHIV,TKUFA)
					VALUES (p_coll_chishuv_yomi(i).mispar_ishi,p_coll_chishuv_yomi(i).bakasha_id,p_coll_chishuv_yomi(i).taarich,p_coll_chishuv_yomi(i).kod_rechiv,p_coll_chishuv_yomi(i).erech_rechiv,p_coll_chishuv_yomi(i).tkufa);
			  END LOOP;
			  end if;
      EXCEPTION
		 WHEN OTHERS THEN
		      RAISE;
  END pro_ins_chishuv_yomi_ovdim;

    PROCEDURE pro_ins_chishuv_yomi_tmp(p_coll_chishuv_yomi in  COLL_CHISHUV_YOMI) IS
 BEGIN
  	   if p_coll_chishuv_yomi is not null then
  	   		For i   in  1..p_coll_chishuv_yomi.count     LOOP
  	   			    INSERT INTO TB_tmp_Chishuv_yomi_Ovdim
			                   (MISPAR_ISHI,BAKASHA_ID,TAARICH,KOD_RECHIV,ERECH_RECHIV,TKUFA)
					VALUES (p_coll_chishuv_yomi(i).mispar_ishi,p_coll_chishuv_yomi(i).bakasha_id,p_coll_chishuv_yomi(i).taarich,p_coll_chishuv_yomi(i).kod_rechiv,p_coll_chishuv_yomi(i).erech_rechiv,p_coll_chishuv_yomi(i).tkufa);
			  END LOOP;
			  end if;
      EXCEPTION
		 WHEN OTHERS THEN
		      RAISE;
  END pro_ins_chishuv_yomi_tmp;

    /*   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        26/07/2009      sari       1.      */
  PROCEDURE pro_ins_chishuv_codesh_ovdim(p_coll_chishuv_chodesh in  COLL_CHISHUV_CHODESH) IS
 BEGIN
  	   		For i   in  1..p_coll_chishuv_chodesh.count     LOOP
				INSERT INTO TB_Chishuv_chodesh_Ovdim
			                   (MISPAR_ISHI,BAKASHA_ID,TAARICH,KOD_RECHIV,ERECH_RECHIV)
			   VALUES (p_coll_chishuv_chodesh(i).mispar_ishi,p_coll_chishuv_chodesh(i).bakasha_id,p_coll_chishuv_chodesh(i).taarich,p_coll_chishuv_chodesh(i).kod_rechiv,p_coll_chishuv_chodesh(i).erech_rechiv);
          END LOOP;
      EXCEPTION
		 WHEN OTHERS THEN
		      RAISE;
  END pro_ins_chishuv_codesh_ovdim;

   PROCEDURE pro_ins_chishuv_codesh_tmp(p_coll_chishuv_chodesh in  COLL_CHISHUV_CHODESH) IS
 BEGIN
  	   		For i   in  1..p_coll_chishuv_chodesh.count     LOOP
				INSERT INTO TB_tmp_Chishuv_chodesh_Ovdim
			                   (MISPAR_ISHI,BAKASHA_ID,TAARICH,KOD_RECHIV,ERECH_RECHIV)
			   VALUES (p_coll_chishuv_chodesh(i).mispar_ishi,p_coll_chishuv_chodesh(i).bakasha_id,p_coll_chishuv_chodesh(i).taarich,p_coll_chishuv_chodesh(i).kod_rechiv,p_coll_chishuv_chodesh(i).erech_rechiv);
          END LOOP;
      EXCEPTION
		 WHEN OTHERS THEN
		      RAISE;
  END pro_ins_chishuv_codesh_tmp;

 	PROCEDURE pro_ins_chishuv(p_coll_chishuv_chodesh in  COLL_CHISHUV_CHODESH,
												p_coll_chishuv_yomi in  COLL_CHISHUV_YOMI,
												p_coll_chishuv_sidur in  COLL_CHISHUV_SIDUR)  IS
	BEGIN
 	        pro_ins_chishuv_codesh_ovdim(p_coll_chishuv_chodesh);
			pro_ins_chishuv_yomi_ovdim(p_coll_chishuv_yomi);
			pro_ins_chishuv_sidur_ovdim(p_coll_chishuv_sidur);
      EXCEPTION
		 WHEN OTHERS THEN
		      RAISE;
  END  pro_ins_chishuv;

   	PROCEDURE pro_ins_chishuv_tmp(p_coll_chishuv_chodesh in  COLL_CHISHUV_CHODESH,
												p_coll_chishuv_yomi in  COLL_CHISHUV_YOMI)  IS
 BEGIN
  	   		pro_ins_chishuv_codesh_tmp(p_coll_chishuv_chodesh);
			pro_ins_chishuv_yomi_tmp(p_coll_chishuv_yomi);
      EXCEPTION
		 WHEN OTHERS THEN
		      RAISE;
  END  pro_ins_chishuv_tmp;

 /*   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0       05/08/2009      sari       1.   */
PROCEDURE pro_get_peiluyot_lesidur(p_mispar_ishi IN  tb_peilut_ovdim.MISPAR_ISHI%type,
																			p_taarich IN  tb_peilut_ovdim.TAARICH%type,
																			p_shat_hatchala_sidur IN  tb_peilut_ovdim.SHAT_HATCHALA_SIDUR%type,
																			p_mispar_sidur IN  tb_peilut_ovdim.MISPAR_SIDUR%type,
																			p_cur out CurType)
IS
BEGIN
    OPEN p_cur for
	    SELECT p.SHAT_HATCHALA_SIDUR,p.SHAT_YETZIA,lpad(to_char(p.MAKAT_NESIA),8,'0') MAKAT_NESIA,p.MISPAR_KNISA,nvl(e.sector_zvira_zman_haelement,0)sector_zvira_zman_haelement,nvl(p.km_visa,0) km_visa,
			   e.nesia,e.kod_lechishuv_premia,e.kupai,nvl(p.Kod_shinuy_premia,0) Kod_shinuy_premia ,p.Oto_no,nvl(p.Dakot_bafoal,0) Dakot_bafoal,
			  to_number( SUBSTR(lpad(to_char(p.MAKAT_NESIA),8,'0') ,5,3)) zmanElement,p.kisuy_tor
		 FROM tb_peilut_ovdim p,tmp_meafyeney_elementim e
         WHERE p.MISPAR_ISHI=p_mispar_ishi
	    AND  p.TAARICH=trunc(p_taarich)
	    AND  p.MISPAR_SIDUR=p_mispar_sidur
		AND p.SHAT_HATCHALA_SIDUR=p_shat_hatchala_sidur
		 AND to_number(substr(p.makat_nesia,2,2)) = e.kod_element(+)
          AND p_taarich between e.me_tarich(+) and e.ad_tarich(+)
		  and not nvl(p.Bitul_O_Hosafa,0)  in (1,3)
		  order by shat_yetzia asc   ;

		  EXCEPTION
		 WHEN OTHERS THEN
		      RAISE;
END pro_get_peiluyot_lesidur;

 /*   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0       05/08/2009      sari       1.    =1*/
PROCEDURE pro_upd_sidurim_lo_letashlum(p_mispar_ishi IN  tb_sidurim_ovdim.MISPAR_ISHI%type,
																			p_taarich IN  tb_sidurim_ovdim.TAARICH%type,
																			p_mispar_sidur IN  tb_sidurim_ovdim.MISPAR_SIDUR%type,
																			p_shat_hatchala IN  tb_sidurim_ovdim.SHAT_HATCHALA%type) IS
BEGIN
    UPDATE TB_SIDURIM_OVDIM
	  SET lo_letashlum=1
	  WHERE mispar_ishi=p_mispar_ishi
	  and taarich=p_taarich
	  and mispar_sidur=p_mispar_sidur
	  and shat_hatchala=p_shat_hatchala ;

		  EXCEPTION
		 WHEN OTHERS THEN
		      RAISE;
END pro_upd_sidurim_lo_letashlum;

/*   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0       05/08/2009      sari       1.   */
PROCEDURE pro_get_michsa_yomit(p_me_taarich IN  tb_michsa_yomit.me_taarich%type,
																			p_ad_taarich IN  tb_michsa_yomit.ad_taarich%type,
																			p_cur out CurType)
IS
BEGIN
    OPEN p_cur for
	    select  kod_michsa,sug_yom ,me_taarich, nvl(AD_TAARICH,to_date('01/01/9999','dd/mm/yyyy')) ad_taarich,michsa,Shavoa_Avoda
        from tb_michsa_yomit
		where me_taarich<=p_ad_taarich
		and nvl(AD_TAARICH,to_date('01/01/9999','dd/mm/yyyy'))>=p_me_taarich;

		  EXCEPTION
		 WHEN OTHERS THEN
		      RAISE;
END pro_get_michsa_yomit;

/*   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0       06/12/2009      sari       1.    */
PROCEDURE pro_get_oved_putar( p_mispar_ishi IN  MATZAV_OVDIM.mispar_ishi%type,
		  					  				   	   						p_tar_chodesh_me IN MATZAV_OVDIM.Taarich_hatchala%type,
																		p_tar_chodesh_ad IN  MATZAV_OVDIM.Taarich_hatchala%type,
																		p_putar out NUMBER)
IS
BEGIN
  	   Select 1 into p_putar
		From MATZAV_OVDIM m
		Where m.Kod_Matzav ='P'
		and m.mispar_ishi=p_mispar_ishi
		And m.Taarich_hatchala >= p_tar_chodesh_me
		And m.Taarich_hatchala <= p_tar_chodesh_ad;

  EXCEPTION
  		WHEN NO_DATA_FOUND THEN
		      p_putar:=0;
		 WHEN OTHERS THEN
		      RAISE;
END  pro_get_oved_putar;


   /*PROCEDURE pro_ins as
   xml xmltype;
   begin
   		xml:=xmltype.createxml('<ds><dr><mispar_ishi>75290</mispar_ishi><bakasha_id>99</bakasha_id><taarich>01/07/2009</taarich><kod_rechiv>100</kod_rechiv></dr><dr><mispar_ishi>75290</mispar_ishi><bakasha_id>99</bakasha_id><taarich>01/07/2009</taarich><kod_rechiv>101</kod_rechiv></dr></ds>');

		for j in
			(select xmltype.extract(value(a),'/dr/mispar_ishi/text()').getstringval() as v_str1,
			xmltype.extract(value(a),'/dr/bakasha_id/text()').getstringval() as v_str2,
			xmltype.extract(value(a),'/dr/taarich/text()').getstringval() as v_str3,
			xmltype.extract(value(a),'/dr/kod_rechiv/text()').getstringval() as v_str4
			from table
			(xmlsequence(xml.extract('/ds/dr')))a)
		loop
		    pro_ins_chishuv_codesh_ovdim(j.v_str1,j.v_str2,to_date(j.v_str3,'dd/mm/yyyy'),j.v_str4,77);

		end loop;

   end  pro_ins;*/
END PKG_CALC;
/
CREATE OR REPLACE PACKAGE PKG_COMPONENT_SIDURIM AS
TYPE	CurType	  IS	REF  CURSOR;
PROCEDURE pro_get_data(p_Kod IN VARCHAR2,p_Period in VARCHAR2,p_Cur OUT CurType);
PROCEDURE pro_get_matching_description(p_Prefix in VARCHAR2,  p_Cur OUT CurType);
PROCEDURE pro_get_matching_kod(p_Prefix in VARCHAR2,  p_Cur OUT CurType);
PROCEDURE pro_get_description_by_kod(p_Kod in VARCHAR2,p_Desc out VARCHAR2);
PROCEDURE pro_get_kod_by_description(p_Desc in CTB_RECHIVIM.TEUR_RECHIV%type  ,p_Kod out CTB_RECHIVIM.KOD_RECHIV%type) ;
PROCEDURE pro_get_details_Kod(p_Cur OUT CurType );
PROCEDURE pro_get_history(p_FilterKod in VARCHAR2,p_ToDate in VARCHAR2, p_Cur out Curtype);
PROCEDURE pro_upd_data(p_KodRechiv TB_SIDURIM_MEYUCHADIM_RECHIV.KOD_RECHIV%type ,p_MisparSidur TB_SIDURIM_MEYUCHADIM_RECHIV.MISPAR_SIDUR%type,p_MeTaarich date,p_AdTaarich date, p_taarich_idkun_acharon DATE,p_meadken_acharon NUMBER) ;
PROCEDURE pro_ins_data(p_KodRechiv TB_SIDURIM_MEYUCHADIM_RECHIV.KOD_RECHIV%type ,p_MisparSidur TB_SIDURIM_MEYUCHADIM_RECHIV.MISPAR_SIDUR%type,p_MeTaarich date,p_AdTaarich date, p_taarich_idkun_acharon DATE,p_meadken_acharon NUMBER) ;


END PKG_COMPONENT_SIDURIM;
/

CREATE OR REPLACE PACKAGE BODY PKG_COMPONENT_SIDURIM  AS

  PROCEDURE pro_get_data(p_Kod IN VARCHAR2,p_Period in VARCHAR2,p_Cur OUT CurType) is
  v_MaxLimitDate Date ;
  v_MinLimitDate date ;
  BEGIN
  	v_MinLimitDate := to_date('01/' || p_Period,'dd/mm/yyyy'); /* period= 05/2009=>  v_MinLimitDate = 01/05/2009 */
    v_MaxLimitDate := add_months(v_MinLimitDate,1) -1 ;    /* period= 05/2009=>  v_MaxLimitDate = 31/05/2009 */

          OPEN p_Cur FOR
          SELECT tb.MISPAR_SIDUR,ctb.KOD_RECHIV, (ctb.KOD_RECHIV||'-'|| ctb.TEUR_RECHIV )DetailsComponent ,tb.Me_Taarich,tb.Ad_Taarich, tb.taarich_idkun_acharon LastUpdate
          FROM TB_SIDURIM_MEYUCHADIM_RECHIV tb
          INNER JOIN CTB_RECHIVIM ctb
          ON ctb.KOD_RECHIV= tb.KOD_RECHIV
          WHERE ((tb.Me_Taarich <=  v_MaxLimitDate ) and (tb.Ad_Taarich >= v_MinLimitDate or tb.Ad_Taarich is null ))
          AND ctb.PAIL = 1 and p_kod =MISPAR_SIDUR
          ORDER BY   ctb.KOD_RECHIV ;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
  END pro_get_data;

  PROCEDURE pro_get_matching_description(p_Prefix in VARCHAR2,  p_Cur OUT CurType) AS
  BEGIN
  OPEN p_Cur for
      SELECT TEUR_SIDUR_MEYCHAD from CTB_SIDURIM_MEYUCHADIM SM
      WHERE SM.TEUR_SIDUR_MEYCHAD   LIKE  p_Prefix || '%' and pail =1
      order by TEUR_SIDUR_MEYCHAD asc;
    NULL;
  END pro_get_matching_description;


  PROCEDURE pro_get_matching_kod(p_Prefix in VARCHAR2,  p_Cur OUT CurType) AS
  BEGIN
  OPEN p_Cur for
      SELECT KOD_SIDUR_MEYUCHAD
      FROM CTB_SIDURIM_MEYUCHADIM SM
      WHERE SM.KOD_SIDUR_MEYUCHAD   LIKE  p_Prefix || '%' and pail =1
      ORDER BY KOD_SIDUR_MEYUCHAD ASC ;
    END pro_get_matching_kod;

PROCEDURE pro_get_history(p_FilterKod in VARCHAR2,p_ToDate in VARCHAR2, p_Cur out Curtype) IS
  v_tar_me DATE ;
  BEGIN
      v_tar_me:=to_date('01/' || p_ToDate,'dd/mm/yyyy');
  OPEN p_Cur for
            SELECT tb.KOD_RECHIV, (ctb.KOD_RECHIV||'-'|| ctb.TEUR_RECHIV) DetailsComponent , tb.Me_Taarich,tb.Ad_Taarich
          FROM TB_SIDURIM_MEYUCHADIM_RECHIV tb
          INNER JOIN CTB_RECHIVIM ctb
          ON ctb.KOD_RECHIV= tb.KOD_RECHIV
      WHERE  tb.ad_TAARICH< v_tar_me  and tb.MISPAR_SIDUR = p_filterkod
      ORDER BY tb.ME_TAARICH ASC ;

END pro_get_history;

PROCEDURE pro_get_description_by_kod(p_Kod in VARCHAR2,p_Desc out VARCHAR2) AS
  BEGIN

        SELECT  case when ( pail = 1)  then SM.teur_sidur_meychad
                        else '-1' end  into p_Desc
        FROM CTB_SIDURIM_MEYUCHADIM SM
        WHERE SM.KOD_SIDUR_MEYUCHAD = p_Kod ;
    EXCEPTION
       WHEN NO_DATA_FOUND THEN
       p_Desc := '';
  END pro_get_description_by_kod;

  PROCEDURE pro_get_kod_by_description(p_Desc in CTB_RECHIVIM.TEUR_RECHIV%type  ,p_Kod out CTB_RECHIVIM.KOD_RECHIV%type) AS
  BEGIN
          SELECT  case when ( pail = 1)  then SM.KOD_SIDUR_MEYUCHAD
                        else -1 end  into p_Kod
        FROM CTB_SIDURIM_MEYUCHADIM SM
        WHERE SM.teur_sidur_meychad = p_Desc ;
    EXCEPTION
        WHEN NO_DATA_FOUND THEN
        p_Kod := '';
  END pro_get_kod_by_description;

PROCEDURE pro_get_details_Kod(p_Cur OUT CurType ) as
BEGIN
  OPEN p_Cur for
      SELECT  SM.KOD_RECHIV  , ('-' || SM.KOD_RECHIV  || SM.TEUR_RECHIV) DetailsComponent
      FROM CTB_RECHIVIM SM
      WHERE SM.PAIL = 1
      order by KOD_RECHIV   asc ;
END pro_get_details_Kod;

  PROCEDURE pro_upd_data(p_KodRechiv TB_SIDURIM_MEYUCHADIM_RECHIV.KOD_RECHIV%type ,p_MisparSidur TB_SIDURIM_MEYUCHADIM_RECHIV.MISPAR_SIDUR%type,p_MeTaarich date,p_AdTaarich date, p_taarich_idkun_acharon DATE,p_meadken_acharon NUMBER) AS
  BEGIN
    update TB_SIDURIM_MEYUCHADIM_RECHIV SM
    set SM.AD_TAARICH = p_AdTaarich ,
          SM.TAARICH_IDKUN_ACHARON = p_taarich_idkun_acharon,
          SM.MEADKEN_ACHARON = p_meadken_acharon
    where MISPAR_SIDUR = p_MisparSidur AND
    ME_TAARICH = p_MeTaarich AND
    KOD_RECHIV = p_KodRechiv;
  END pro_upd_data;

PROCEDURE pro_ins_data(p_KodRechiv TB_SIDURIM_MEYUCHADIM_RECHIV.KOD_RECHIV%type ,p_MisparSidur TB_SIDURIM_MEYUCHADIM_RECHIV.MISPAR_SIDUR%type,p_MeTaarich date,p_AdTaarich date, p_taarich_idkun_acharon DATE,p_meadken_acharon NUMBER) AS
  BEGIN
  insert into TB_SIDURIM_MEYUCHADIM_RECHIV
    (ad_taarich,  KOD_RECHIV, me_taarich, meadken_acharon, mispar_sidur)
    VALUES (p_adtaarich,  p_KodRechiv, p_metaarich, p_meadken_acharon, p_misparsidur);
  END pro_ins_data;

END PKG_COMPONENT_SIDURIM;
/
CREATE OR REPLACE PACKAGE          PKG_COMPONENT_SUG_SIDUR AS
TYPE	CurType	  IS	REF  CURSOR;
PROCEDURE pro_get_data(p_Kod IN VARCHAR2,p_Period in VARCHAR2,p_Cur OUT CurType);
PROCEDURE pro_get_matching_description(p_Prefix in VARCHAR2,  p_Cur OUT CurType);
PROCEDURE pro_get_matching_kod(p_Prefix in VARCHAR2,  p_Cur OUT CurType);
PROCEDURE pro_get_description_by_kod(p_Kod in VARCHAR2,p_Desc out VARCHAR2);
PROCEDURE pro_get_kod_by_description(p_Desc in VARCHAR2,p_Kod out VARCHAR2);
PROCEDURE pro_get_details_Kod(p_Cur OUT CurType );
PROCEDURE pro_get_history(p_FilterKod in varchar2,p_ToDate in VARCHAR2,  p_Cur out Curtype);
PROCEDURE pro_upd_data(p_KodRechiv number,p_SugSidur number,p_MeTaarich date,p_AdTaarich date, p_taarich_idkun_acharon DATE,p_meadken_acharon NUMBER) ;
PROCEDURE pro_ins_data(p_KodRechiv number,p_SugSidur number,p_MeTaarich date,p_AdTaarich date, p_taarich_idkun_acharon DATE,p_meadken_acharon NUMBER) ;

END PKG_COMPONENT_SUG_SIDUR; 
/

CREATE OR REPLACE PACKAGE BODY          PKG_COMPONENT_SUG_SIDUR AS

  PROCEDURE pro_get_data(p_Kod IN VARCHAR2,p_Period in VARCHAR2,p_Cur OUT CurType) iS
  v_MaxLimitDate Date ;
  v_MinLimitDate date ;
  BEGIN
    v_MinLimitDate := to_date('01/' || p_Period,'dd/mm/yyyy'); /* period= 05/2009=>  v_MinLimitDate = 01/05/2009 */
    v_MaxLimitDate := add_months(v_MinLimitDate,1) -1 ;    /* period= 05/2009=>  v_MaxLimitDate = 31/05/2009 */
    OPEN p_Cur FOR
          SELECT tb.SUG_SIDUR , ctb.KOD_RECHIV,(ctb.KOD_RECHIV||'-'|| ctb.TEUR_RECHIV) DetailsComponent , tb.me_taarich, tb.ad_taarich,tb.Taarich_Idkun_Acharon  LastUpdate
          FROM TB_SUG_SIDUR_RECHIV tb
          INNER JOIN CTB_RECHIVIM ctb
          ON ctb.KOD_RECHIV= tb.KOD_RECHIV
          WHERE ((tb.Me_Taarich <=  v_MaxLimitDate ) and (tb.Ad_Taarich >= v_MinLimitDate or tb.Ad_Taarich is null ))
          AND tb.SUG_SIDUR = p_Kod AND ctb.PAIL = 1
          ORDER BY   ctb.KOD_RECHIV ;

    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    NULL;
  END pro_get_data;

  PROCEDURE pro_get_matching_description(p_Prefix in VARCHAR2,  p_Cur OUT CurType) AS
  BEGIN
OPEN p_Cur for
      SELECT TEUR_SIDUR_AVODA  from CTB_SUG_SIDUR SS
      WHERE SS.TEUR_SIDUR_AVODA   LIKE  p_Prefix || '%'
      order by TEUR_SIDUR_AVODA asc ;
    NULL;
    END pro_get_matching_description;

  PROCEDURE pro_get_matching_kod(p_Prefix in VARCHAR2,  p_Cur OUT CurType) AS

  BEGIN
      OPEN p_Cur for
          SELECT KOD_SIDUR_AVODA
          FROM CTB_SUG_SIDUR SS
          WHERE SS.KOD_SIDUR_AVODA   LIKE  p_Prefix || '%'
          ORDER BY KOD_SIDUR_AVODA ASC;
  END pro_get_matching_kod;

  PROCEDURE pro_get_description_by_kod(p_Kod in VARCHAR2,p_Desc out VARCHAR2) AS
  BEGIN
        SELECT  SS.TEUR_SIDUR_AVODA INTO p_desc
      FROM CTB_SUG_SIDUR SS
      WHERE SS.KOD_SIDUR_AVODA = p_Kod;
    EXCEPTION
        WHEN NO_DATA_FOUND THEN
        p_Desc := '';
    NULL;
  END pro_get_description_by_kod;

  PROCEDURE pro_get_kod_by_description(p_Desc in VARCHAR2,p_Kod out VARCHAR2) AS
  BEGIN
         SELECT  SS.KOD_SIDUR_AVODA  INTO p_Kod
      from CTB_SUG_SIDUR SS
      WHERE SS.TEUR_SIDUR_AVODA = p_desc;
    EXCEPTION
        WHEN NO_DATA_FOUND THEN
        p_Kod := '';
  END pro_get_kod_by_description;

  PROCEDURE pro_get_details_Kod(p_Cur OUT CurType ) AS
  BEGIN
      OPEN p_Cur for
      SELECT  SM.KOD_RECHIV , ('-' || SM.KOD_RECHIV  || SM.TEUR_RECHIV ) DetailsComponent
      FROM CTB_RECHIVIM SM
      WHERE SM.PAIL = 1
      order by KOD_RECHIV   asc ;

  END pro_get_details_Kod;

  PROCEDURE pro_get_history(p_FilterKod in varchar2,   p_ToDate in VARCHAR2, p_Cur out Curtype) IS
  v_tar_me DATE ;
  BEGIN
        v_tar_me:=to_date('01/' || p_ToDate,'dd/mm/yyyy');
  OPEN p_Cur for
    SELECT tb.KOD_RECHIV , (ctb.KOD_RECHIV||'-'|| ctb.TEUR_RECHIV) DetailsComponent , tb.me_taarich, tb.ad_taarich
    FROM TB_SUG_SIDUR_RECHIV tb
    INNER JOIN CTB_RECHIVIM ctb
    ON ctb.KOD_RECHIV= tb.KOD_RECHIV
    WHERE tb.AD_TAARICH< v_tar_me and tb.SUG_SIDUR = p_filterkod
    ORDER BY tb.ME_TAARICH asc ;
  END pro_get_history;

  PROCEDURE pro_upd_data(p_KodRechiv number,p_SugSidur number,p_MeTaarich date,p_AdTaarich date, p_taarich_idkun_acharon DATE,p_meadken_acharon NUMBER)  AS
  BEGIN
update TB_SUG_SIDUR_RECHIV SM
    set
        SM.AD_TAARICH = p_AdTaarich ,
          SM.TAARICH_IDKUN_ACHARON = p_taarich_idkun_acharon,
          SM.MEADKEN_ACHARON = p_meadken_acharon
    where SUG_SIDUR = p_SugSidur AND
    ME_TAARICH = p_MeTaarich AND
    KOD_RECHIV = p_KodRechiv;

  END pro_upd_data;

  PROCEDURE pro_ins_data(p_KodRechiv number,p_SugSidur number,p_MeTaarich date,p_AdTaarich date , p_taarich_idkun_acharon DATE,p_meadken_acharon NUMBER)  AS
  BEGIN
      insert into TB_SUG_SIDUR_RECHIV
    (ad_taarich,  KOD_RECHIV, me_taarich, meadken_acharon, SUG_SIDUR)
    VALUES (p_adtaarich,  p_KodRechiv, p_metaarich, p_meadken_acharon, p_SugSidur);
  END pro_ins_data;


END PKG_COMPONENT_SUG_SIDUR; 
/
CREATE OR REPLACE PACKAGE          PKG_ELEMENTS AS

TYPE	CurType	  IS	REF  CURSOR;
PROCEDURE pro_get_data(p_Kod IN VARCHAR2,p_Period in VARCHAR2,p_Cur OUT CurType);
PROCEDURE pro_get_matching_description(p_Prefix in VARCHAR2,  p_Cur OUT CurType);
PROCEDURE pro_get_matching_kod(p_Prefix in VARCHAR2,  p_Cur OUT CurType);
PROCEDURE pro_get_description_by_kod(p_Kod in VARCHAR2,p_Desc out VARCHAR2);
PROCEDURE pro_get_kod_by_description(p_Desc in VARCHAR2,p_Kod out VARCHAR2);
PROCEDURE pro_get_details_Kod(p_Cur OUT CurType );
PROCEDURE pro_get_history(p_FilterKod in varchar2 , p_Kod in VARCHAR2,p_ToDate in VARCHAR2,  p_Cur out Curtype);
PROCEDURE pro_upd_data(p_KodMeafyen number,p_KodElement number,p_MeTaarich date,p_AdTaarich date,p_Erech VARCHAR2 ,p_SugNatun VARCHAR2,p_Comment varchar2, p_taarich_idkun_acharon DATE,p_meadken_acharon NUMBER) ;
PROCEDURE pro_ins_data(p_KodMeafyen number,p_KodElement number,p_MeTaarich date,p_AdTaarich date,p_Erech VARCHAR2 ,p_SugNatun VARCHAR2,p_Comment varchar2, p_taarich_idkun_acharon DATE,p_meadken_acharon NUMBER);
PROCEDURE pro_Del_data(p_KodMeafyen number,p_KodElement number,p_MeTaarich date) ;
PROCEDURE pro_get_data_by_kod_element(p_kod_element in tb_meafyeney_elementim.kod_element%type,
                                      p_taarich tb_meafyeney_elementim.me_taarich%type,
                                      p_Cur out CurType);
PROCEDURE pro_get_elements_vemeafyenim(p_Taarich in varchar2,p_Cur out CurType);
PROCEDURE pro_get_teur_elements(p_Prefix in varchar2,p_Cur out CurType);
PROCEDURE calling_Pivot_Meafyeney_e ;
PROCEDURE Pivot_Meafyeney_Elementim;

PROCEDURE get_tmp_meafyeney_elementim(p_tar_me IN tb_sidurim_meyuchadim.me_taarich%type,
		  									   	  										 p_tar_ad  IN tb_sidurim_meyuchadim.me_taarich%type,
																						 p_Cur OUT CurType) ;
PROCEDURE  pro_get_all_elements_kod(p_Prefix in VARCHAR2,  p_Cur OUT CurType);
PROCEDURE pro_get_element_details(p_kod_element in ctb_elementim.kod_element%type, p_cur out curtype );
PROCEDURE pro_get_visut_details(p_kod_visut in ctb_nkudut_tifaul.kod_nekudat_tiful%type, p_cur out curtype);
END PKG_ELEMENTS; 
/

CREATE OR REPLACE PACKAGE BODY          PKG_ELEMENTS AS

  PROCEDURE pro_get_data(p_Kod IN VARCHAR2,p_Period in VARCHAR2,p_Cur OUT CurType) IS
 v_MaxLimitDate Date ;
  v_MinLimitDate date ;
  BEGIN
  	v_MinLimitDate := to_date('01/' || p_Period,'dd/mm/yyyy'); /* period= 05/2009=>  v_MinLimitDate = 01/05/2009 */
    v_MaxLimitDate := add_months(v_MinLimitDate,1) -1 ;    /* period= 05/2009=>  v_MaxLimitDate = 31/05/2009 */
       OPEN p_Cur FOR
          SELECT tb.KOD_ELEMENT, tb.Kod_Meafyen,(ctb.KOD_MEAFYEN || '-' || ctb.SHEM_MEAFYEN || '(' || ctb.SUG_NATUN || ')') DetailsElement  ,Me_Taarich,Ad_Taarich,Erech, ctb.sug_natun,tb.Taarich_Idkun_Acharon LastUpdate,TB.HEARA
          FROM TB_Meafyeney_Elementim  tb
          INNER JOIN CTB_MEAFYENEY_Elementim ctb
          ON ctb.kod_meafyen= tb.kod_meafyen
          WHERE ((tb.Me_Taarich <=  v_MaxLimitDate ) and (tb.Ad_Taarich >= v_MinLimitDate or tb.Ad_Taarich is null ))
          AND tb.KOD_ELEMENT = p_Kod-- AND ctb.PAIL = 1
          ORDER BY   ctb.Kod_Meafyen ;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    NULL;
  END pro_get_data;

  PROCEDURE pro_get_matching_description(p_Prefix in VARCHAR2,  p_Cur OUT CurType) AS
  BEGIN
      OPEN p_Cur for
      SELECT TEUR_ELEMENT from CTB_ELEMENTIM ME
      WHERE ME.TEUR_ELEMENT   LIKE  p_Prefix || '%' -- and pail =1
      order by TEUR_ELEMENT asc ;

    NULL;
  END pro_get_matching_description;


  PROCEDURE pro_get_matching_kod(p_Prefix in VARCHAR2,  p_Cur OUT CurType) AS
  BEGIN
      OPEN p_Cur for
          SELECT KOD_ELEMENT

          FROM CTB_ELEMENTIM ME
          WHERE ME.KOD_ELEMENT   LIKE  p_Prefix || '%' --and pail =1
          ORDER BY KOD_ELEMENT ASC ;
    NULL;
  END pro_get_matching_kod;

  PROCEDURE pro_get_description_by_kod(p_Kod in VARCHAR2,p_Desc out VARCHAR2) AS
  BEGIN
          SELECT SM.TEUR_ELEMENT into p_Desc
        FROM CTB_ELEMENTIM SM
        WHERE SM.KOD_ELEMENT = p_Kod ;
    EXCEPTION
        WHEN NO_DATA_FOUND THEN
        p_Desc := '';
  END pro_get_description_by_kod;

  PROCEDURE pro_get_kod_by_description(p_Desc in VARCHAR2,p_Kod out VARCHAR2) AS
  BEGIN
  	 SELECT  SM.KOD_ELEMENT into p_Kod
        FROM CTB_ELEMENTIM SM
		WHERE SM.TEUR_ELEMENT = p_Desc ;
		
    EXCEPTION
        WHEN NO_DATA_FOUND THEN
        p_Kod := '';
  END pro_get_kod_by_description;

  PROCEDURE pro_get_details_Kod(p_Cur OUT CurType ) AS
  BEGIN
        OPEN p_Cur for
      SELECT  SM.KOD_MEAFYEN Kod_Meafyen , ('-' ||  SM.KOD_MEAFYEN  ||SM.SHEM_MEAFYEN || '(' || sm.SUG_NATUN || ')' ) DetailsElement
      FROM CTB_MEAFYENEY_ELEMENTIM SM
      WHERE SM.PAIL = 1
      order by Kod_Meafyen asc ;

  END pro_get_details_Kod;

  PROCEDURE pro_get_history(p_FilterKod in varchar2, p_Kod in VARCHAR2,p_ToDate in VARCHAR2, p_Cur out Curtype) IS
  v_tar_me DATE ;
  BEGIN
      v_tar_me:=to_date(p_ToDate,'dd/mm/yyyy');
  OPEN p_Cur for
      SELECT SM.ME_TAARICH,SM.ad_taarich,SM.erech
      FROM TB_MEAFYENEY_ELEMENTIM SM
      WHERE SM.kod_meafyen =p_Kod and SM.AD_TAARICH< v_tar_me and KOD_ELEMENT = p_filterkod
      ORDER BY SM.ME_TAARICH asc ;
  END pro_get_history;
PROCEDURE pro_upd_data(p_KodMeafyen number,p_KodElement number,p_MeTaarich date,p_AdTaarich date,p_Erech VARCHAR2 ,p_SugNatun VARCHAR2, p_Comment varchar2,p_taarich_idkun_acharon DATE,p_meadken_acharon NUMBER)   AS
  BEGIN
update TB_MEAFYENEY_ELEMENTIM SM
    set SM.ERECH = p_Erech ,
        SM.AD_TAARICH = p_AdTaarich ,
          SM.TAARICH_IDKUN_ACHARON = p_taarich_idkun_acharon,
          SM.MEADKEN_ACHARON = p_meadken_acharon,
          SM.HEARA = p_Comment
    where KOD_ELEMENT = p_KodElement AND
    ME_TAARICH = p_MeTaarich AND
    KOD_MEAFYEN = p_KodMeafyen;
  END pro_upd_data;

  PROCEDURE pro_ins_data(p_KodMeafyen number,p_KodElement number,p_MeTaarich date,p_AdTaarich date,p_Erech VARCHAR2 ,p_SugNatun VARCHAR2,p_Comment varchar2, p_taarich_idkun_acharon DATE,p_meadken_acharon NUMBER)  AS
  BEGIN
      insert into TB_MEAFYENEY_ELEMENTIM
    (ad_taarich, erech, kod_meafyen, me_taarich, meadken_acharon, KOD_ELEMENT,HEARA)
    VALUES (p_adtaarich, p_erech, p_kodmeafyen, p_metaarich, p_meadken_acharon, p_KodElement,p_Comment);
  END pro_ins_data;

    PROCEDURE pro_Del_data(p_KodMeafyen number,p_KodElement number,p_MeTaarich date)  AS
  BEGIN
      Delete TB_MEAFYENEY_ELEMENTIM
      where KOD_ELEMENT = p_KodElement and
          ME_TAARICH = p_MeTaarich AND
    KOD_MEAFYEN = p_KodMeafyen;

  END pro_Del_data;


PROCEDURE pro_get_data_by_kod_element(p_kod_element in tb_meafyeney_elementim.kod_element%type,
                                      p_Taarich tb_meafyeney_elementim.me_taarich%type,
                                      p_Cur out CurType) IS
BEGIN
      OPEN p_Cur for
      SELECT sm.me_taarich,sm.ad_taarich,sm.erech,sm.kod_meafyen, sm.kod_element
      FROM   tb_meafyeney_elementim sm
      WHERE  (sm.kod_element = p_kod_element or p_kod_element is null) and
              ((ad_taarich is null and p_Taarich >= me_taarich) or  
             (p_Taarich between me_taarich and ad_taarich)); --and ad_taarich;
EXCEPTION
    WHEN OTHERS THEN
        RAISE;
END pro_get_data_by_kod_element;




PROCEDURE pro_get_elements_vemeafyenim(p_Taarich in varchar2,p_Cur out CurType) IS
BEGIN
      OPEN p_Cur for
		    SELECT  E.TEUR_ELEMENT,E.KOD_ELEMENT,M.KOD_MEAFYEN, M.ERECH
			FROM CTB_ELEMENTIM E,
	 		                 TB_MEAFYENEY_ELEMENTIM M
			WHERE
	 		 E.KOD_ELEMENT = M.KOD_ELEMENT  AND
			 to_date(p_Taarich ,'dd/mm/yyyy')  BETWEEN  M.ME_TAARICH AND nvl( M.AD_TAARICH, to_date('31/12/4712','dd/mm/yyyy'))
			ORDER BY 		KOD_ELEMENT,KOD_MEAFYEN, ERECH;
EXCEPTION
    WHEN OTHERS THEN
        RAISE;
END pro_get_elements_vemeafyenim;

PROCEDURE pro_get_teur_elements(p_Prefix in varchar2,p_Cur out CurType) IS
 BEGIN

	  OPEN p_Cur for
	  	   SELECT distinct  E.TEUR_ELEMENT
			FROM CTB_ELEMENTIM E
	 		  WHERE E.TEUR_ELEMENT LIKE  p_Prefix || '%'
			  and E.KOD_ELEMENT not in(1,11,12)
			  ORDER BY E.TEUR_ELEMENT ASC;
EXCEPTION
    WHEN OTHERS THEN
        RAISE;
END pro_get_teur_elements;
PROCEDURE calling_Pivot_Meafyeney_e  IS
  --   v_idkun_tb     date;
  --   v_idkun_tmp   date;
BEGIN
--select max(nvl(e.taarich_idkun_acharon,sysdate)) idkun_tb,
--max(nvl(t.taarich_idkun_acharon,sysdate)) idkun_tmp
--into v_idkun_tb, v_idkun_tmp
--from tb_meafyeney_elementim e, tmp_meafyeney_elementim t;
--if (v_idkun_tb > v_idkun_tmp) then
delete from  tmp_meafyeney_elementim;
PKG_ELEMENTS.Pivot_Meafyeney_Elementim;
--end if;
commit;
END calling_Pivot_Meafyeney_e;



PROCEDURE Pivot_Meafyeney_Elementim IS
--todo: truncate tmp_sidurim_meyuchadim
CURSOR tb_meafyeney_elementim_tmp IS
  SELECT  distinct  kod_element
from   tb_meafyeney_elementim
 --where   kod_element =20
;

CURSOR Me_tarich_tmp(par_kod_element number) IS
select distinct p1.me_taarich  me_tarich
from    tb_meafyeney_elementim  p1
 where  p1.kod_element=par_kod_element
 union all
select distinct  p2.ad_taarich+1 me_tarich
 from   tb_meafyeney_elementim  p2
 where  p2.kod_element=par_kod_element
   and p2.ad_taarich<to_date('01/01/4000','dd/mm/yyyy')
      and not exists( select * from tb_meafyeney_elementim  p3 where  p3.kod_element=par_kod_element
                       and   p2.ad_taarich+1=p3.me_taarich
         and  p2.kod_element= p3.kod_element);
CURSOR Me_Ad_tmp(par_kod_element number) IS
select distinct me_tarich,ad_tarich
from     tmp_meafyeney_elementim
where kod_element=par_kod_element;
CURSOR meafyeney_elementim_tmp(par_kod_element number,p_Dt_from date, p_Dt_to date) IS
select
  kod_element, teur,
  divuach_mapa_o_rishum  ,peula_o_yedia_bilvad, erech_element,kod_lechishuv_premia,
  zman_o_kamut_o_kod_min,zman_o_kamut_o_kod_max,bitul_biglal_ichur_lasidur,
  lehitalem_hafifa_bein_nesiot ,hovat_divuach_sidur_mesuyam ,
  hova_mispar_rechev,  divuach_besidur_visa,
  divuach_besidur_meyuchad,
  sector_zvira_zman_haelement,  hamtana  ,
  lershut,  hachanat_mechona  ,isuf_o_pizur  ,
  kenosea,shayach_leruey_kaitz_kaytana,
  nihul_tnua, kupai,nesia_reika ,baal_tafkid_bemivtza_meyuchad,
  avodat_meshek,  avodot_nilvot_lenehagut   ,
  pakach_bamifal,mispar_sidur_matalot_tnua,
  kod_ishur_nidrash_workflow	,monea_bdikot_retzifut	,mezake_tosefet_sikun		,
  mehayev_divuach_kav	,mehayev_divuach_mikum	,lelo_nosim	,
  nesia,bdikat_nz_hityazvut_next,peilut_mashmautit,lo_nizbar_leshat_gmar,
  lehitalem_beitur_reyka,asur_bedivuach_yadani,
  tipul_meyuchad_Baklita, tipul_meyuchad_Bashguim,   tipul_meyuchad_Bachishuv
from (
  select
    kod_element,
    max(case when  kod_meafyen=1 then nvl(erech,'-1')   else '' end)    teur,
    max(case when  kod_meafyen=2 then nvl(erech,'-1')   else '' end)   divuach_mapa_o_rishum,
    max(case when  kod_meafyen=3 then nvl(erech,'-1')   else '' end)   peula_o_yedia_bilvad,
    max(case when  kod_meafyen=4 then nvl(erech,'-1')   else '' end)   erech_element,
    max(case when  kod_meafyen=5 then nvl(erech,'-1')   else '' end)   kod_lechishuv_premia,
    max(case when  kod_meafyen=6 then nvl(erech,'-1')   else '' end)   zman_o_kamut_o_kod_min,
    max(case when  kod_meafyen=7 then nvl(erech,'-1')   else '' end)   zman_o_kamut_o_kod_max,
    max(case when  kod_meafyen=8 then nvl(erech,'-1')   else '' end)   bitul_biglal_ichur_lasidur,
    max(case when  kod_meafyen=9 then nvl(erech,'-1')   else '' end)   lehitalem_hafifa_bein_nesiot,
    max(case when  kod_meafyen=10 then nvl(erech,'-1')   else '' end) hovat_divuach_sidur_mesuyam ,
    max(case when  kod_meafyen=11 then nvl(erech,'-1')   else '' end) hova_mispar_rechev,
    max(case when  kod_meafyen=12 then nvl(erech,'-1')   else '' end) divuach_besidur_visa,
    max(case when  kod_meafyen=13 then nvl(erech,'-1')   else '' end) divuach_besidur_meyuchad,
    max(case when  kod_meafyen=14 then nvl(erech,'-1')   else '' end) sector_zvira_zman_haelement  ,
    max(case when  kod_meafyen=15 then nvl(erech,'-1')   else '' end)  hamtana  ,
    max(case when  kod_meafyen=16 then nvl(erech,'-1')   else '' end) lershut,
    max(case when  kod_meafyen=17 then nvl(erech,'-1')   else '' end)  hachanat_mechona  ,
    max(case when  kod_meafyen=18 then nvl(erech,'-1')   else '' end)  isuf_o_pizur  ,
    max(case when  kod_meafyen=19 then nvl(erech,'-1')   else '' end)  kenosea,
    max(case when  kod_meafyen=20 then nvl(erech,'-1')   else '' end)  shayach_leruey_kaitz_kaytana,
    max(case when  kod_meafyen=21 then nvl(erech,'-1')   else '' end)  nihul_tnua,
    max(case when  kod_meafyen=22 then nvl(erech,'-1')   else '' end)  kupai,
    max(case when  kod_meafyen=23 then nvl(erech,'-1')   else '' end)  nesia_reika ,
    max(case when  kod_meafyen=24 then nvl(erech,'-1')   else '' end)  baal_tafkid_bemivtza_meyuchad,
    max(case when  kod_meafyen=25 then nvl(erech,'-1')   else '' end)  avodat_meshek,
    max(case when  kod_meafyen=26 then nvl(erech,'-1')   else '' end)  avodot_nilvot_lenehagut   ,
    max(case when  kod_meafyen=27 then nvl(erech,'-1')   else '' end)  pakach_bamifal,
    max(case when  kod_meafyen=28 then nvl(erech,'-1')   else '' end)  mispar_sidur_matalot_tnua,
    max(case when  kod_meafyen=29 then nvl(erech,'-1')   else '' end)  kod_ishur_nidrash_workflow	,
    max(case when  kod_meafyen=30 then nvl(erech,'-1')   else '' end)  monea_bdikot_retzifut	,
    max(case when  kod_meafyen=31 then nvl(erech,'-1')   else '' end)  mezake_tosefet_sikun		,
    max(case when  kod_meafyen=32 then nvl(erech,'-1')   else '' end)  mehayev_divuach_kav	,
    max(case when  kod_meafyen=33 then nvl(erech,'-1')   else '' end)  mehayev_divuach_mikum	,
    max(case when  kod_meafyen=34 then nvl(erech,'-1')   else '' end)  lelo_nosim	,
    max(case when  kod_meafyen=35 then nvl(erech,'-1')   else '' end)  nesia,
    max(case when  kod_meafyen=36 then nvl(erech,'-1')   else '' end)  bdikat_nz_hityazvut_next	,
	max(case when  kod_meafyen=37 then nvl(erech,'-1')   else '' end)  peilut_mashmautit,
	max(case when  kod_meafyen=38 then nvl(erech,'-1')   else '' end)  lo_nizbar_leshat_gmar,
	max(case when  kod_meafyen=39 then nvl(erech,'-1')   else '' end)  lehitalem_beitur_reyka,
	max(case when  kod_meafyen=40 then nvl(erech,'-1')   else '' end)  asur_bedivuach_yadani,
    max(case when  kod_meafyen=51 then nvl(erech,'-1')   else '' end)  tipul_meyuchad_Baklita,
    max(case when  kod_meafyen=52 then nvl(erech,'-1')   else '' end)  tipul_meyuchad_Bashguim,
    max(case when  kod_meafyen=53 then nvl(erech,'-1')   else '' end)  tipul_meyuchad_Bachishuv
  from
     tb_meafyeney_elementim
 where kod_element=par_kod_element
    and ((p_Dt_from <= me_taarich  and  p_Dt_to >= me_taarich  and p_Dt_to <= nvl(ad_taarich,to_date('31/12/4712','dd/mm/yyyy')))
  or  (p_Dt_from <= me_taarich  and p_Dt_to >= nvl(ad_taarich,to_date('31/12/4712','dd/mm/yyyy')))
     or (p_Dt_from >= me_taarich  and  p_Dt_from <= nvl(ad_taarich,to_date('31/12/4712','dd/mm/yyyy')) and p_Dt_to >= nvl(ad_taarich,to_date('31/12/4712','dd/mm/yyyy')))
  or (p_Dt_from >= me_taarich   and  p_Dt_to <= nvl(ad_taarich,to_date('31/12/4712','dd/mm/yyyy'))))
-- and ((to_date(p_Dt_from,'dd/mm/yyyy') <= me_taarich  and to_date(p_Dt_to,'dd/mm/yyyy') >= me_taarich  and to_date(p_Dt_to,'dd/mm/yyyy') <= nvl(ad_taarich,to_date('31/12/4712','dd/mm/yyyy')))
--  or  (to_date(p_Dt_from,'dd/mm/yyyy') <= me_taarich  and to_date(p_Dt_to,'dd/mm/yyyy') >= nvl(ad_taarich,to_date('31/12/4712','dd/mm/yyyy')))
 --    or (to_date(p_Dt_from,'dd/mm/yyyy') >= me_taarich  and to_date(p_Dt_from,'dd/mm/yyyy') <= nvl(ad_taarich,to_date('31/12/4712','dd/mm/yyyy')) and to_date(p_Dt_to,'dd/mm/yyyy') >= nvl(ad_taarich,to_date('31/12/4712','dd/mm/yyyy')))
--  or (to_date(p_Dt_from,'dd/mm/yyyy') >= me_taarich   and to_date(p_Dt_to,'dd/mm/yyyy') <= nvl(ad_taarich,to_date('31/12/4712','dd/mm/yyyy'))))
  group by
   kod_element);
BEGIN
FOR  tb_meafyeney_elementim_tmp_rec IN  tb_meafyeney_elementim_tmp LOOP
FOR  Me_tarich_tmp_rec IN  Me_tarich_tmp(tb_meafyeney_elementim_tmp_rec.kod_element) LOOP
 insert into  tmp_meafyeney_elementim
 (kod_element,me_tarich,ad_tarich)
 values (tb_meafyeney_elementim_tmp_rec.kod_element,Me_tarich_tmp_rec.me_tarich,
 ( select distinct least((select   nvl(min(ad_taarich),to_date('31/12/4712','dd/mm/yyyy'))
from    tb_meafyeney_elementim
 where  kod_element=tb_meafyeney_elementim_tmp_rec.kod_element
 and ad_taarich>= Me_tarich_tmp_rec.me_tarich)
 ,
 (select nvl(min(me_taarich) - 1,to_date('31/12/4712','dd/mm/yyyy'))
from    tb_meafyeney_elementim
 where  kod_element=tb_meafyeney_elementim_tmp_rec.kod_element
   and me_taarich>(select min(me_taarich) from  tb_meafyeney_elementim where kod_element=tb_meafyeney_elementim_tmp_rec.kod_element)
 and  me_taarich>Me_tarich_tmp_rec.me_tarich )
  ,
  to_date('31/12/4712','dd/mm/yyyy')) ad_tarich
from    tb_meafyeney_elementim
 where  kod_element=tb_meafyeney_elementim_tmp_rec.kod_element)
 );
END LOOP;
 delete  from   tmp_meafyeney_elementim
 where kod_element=tb_meafyeney_elementim_tmp_rec.kod_element
 and ad_tarich<to_date('01/01/2008','dd/mm/yyyy');
 FOR  Me_Ad_tmp_rec IN  Me_Ad_tmp(tb_meafyeney_elementim_tmp_rec.kod_element) LOOP
 FOR  meafyeney_elementim_tmp_rec IN  meafyeney_elementim_tmp(tb_meafyeney_elementim_tmp_rec.kod_element,
 Me_Ad_tmp_rec.me_tarich,Me_Ad_tmp_rec.ad_tarich)
 LOOP
 update   tmp_meafyeney_elementim
 set  teur=meafyeney_elementim_tmp_rec.teur,
      divuach_mapa_o_rishum =meafyeney_elementim_tmp_rec.divuach_mapa_o_rishum,
    peula_o_yedia_bilvad=meafyeney_elementim_tmp_rec.peula_o_yedia_bilvad,
      erech_element=meafyeney_elementim_tmp_rec.erech_element,
      kod_lechishuv_premia=meafyeney_elementim_tmp_rec.kod_lechishuv_premia,
  zman_o_kamut_o_kod_min= meafyeney_elementim_tmp_rec.zman_o_kamut_o_kod_min,
  zman_o_kamut_o_kod_max= meafyeney_elementim_tmp_rec.zman_o_kamut_o_kod_max,
   bitul_biglal_ichur_lasidur= meafyeney_elementim_tmp_rec.bitul_biglal_ichur_lasidur,
      lehitalem_hafifa_bein_nesiot=meafyeney_elementim_tmp_rec.lehitalem_hafifa_bein_nesiot,
      hovat_divuach_sidur_mesuyam=meafyeney_elementim_tmp_rec.hovat_divuach_sidur_mesuyam,
      hova_mispar_rechev =meafyeney_elementim_tmp_rec.hova_mispar_rechev ,
      divuach_besidur_visa =meafyeney_elementim_tmp_rec.divuach_besidur_visa ,
    divuach_besidur_meyuchad=meafyeney_elementim_tmp_rec.divuach_besidur_meyuchad,
      sector_zvira_zman_haelement =meafyeney_elementim_tmp_rec.sector_zvira_zman_haelement,
     hamtana =meafyeney_elementim_tmp_rec.hamtana,
      lershut =meafyeney_elementim_tmp_rec.lershut,
      hachanat_mechona =meafyeney_elementim_tmp_rec.hachanat_mechona ,
      isuf_o_pizur =meafyeney_elementim_tmp_rec.isuf_o_pizur ,
      kenosea=meafyeney_elementim_tmp_rec.kenosea,
      shayach_leruey_kaitz_kaytana =meafyeney_elementim_tmp_rec.shayach_leruey_kaitz_kaytana,
     nihul_tnua =meafyeney_elementim_tmp_rec.nihul_tnua,
      kupai=meafyeney_elementim_tmp_rec.kupai,
      nesia_reika =meafyeney_elementim_tmp_rec.nesia_reika ,
	  baal_tafkid_bemivtza_meyuchad=meafyeney_elementim_tmp_rec.baal_tafkid_bemivtza_meyuchad,
      avodat_meshek=meafyeney_elementim_tmp_rec.avodat_meshek,
      avodot_nilvot_lenehagut  =meafyeney_elementim_tmp_rec.avodot_nilvot_lenehagut ,
     pakach_bamifal=meafyeney_elementim_tmp_rec.pakach_bamifal,
      mispar_sidur_matalot_tnua =meafyeney_elementim_tmp_rec.mispar_sidur_matalot_tnua,
	  kod_ishur_nidrash_workflow=meafyeney_elementim_tmp_rec.kod_ishur_nidrash_workflow,
   monea_bdikot_retzifut	=meafyeney_elementim_tmp_rec.monea_bdikot_retzifut,
   mezake_tosefet_sikun	=meafyeney_elementim_tmp_rec.mezake_tosefet_sikun,
   mehayev_divuach_kav	=meafyeney_elementim_tmp_rec.mehayev_divuach_kav,
   mehayev_divuach_mikum	=meafyeney_elementim_tmp_rec.mehayev_divuach_mikum,
   lelo_nosim	=meafyeney_elementim_tmp_rec.lelo_nosim,
   nesia = meafyeney_elementim_tmp_rec.nesia,
   bdikat_nz_hityazvut_next=meafyeney_elementim_tmp_rec.bdikat_nz_hityazvut_next,
   peilut_mashmautit	=meafyeney_elementim_tmp_rec.peilut_mashmautit,
   lo_nizbar_leshat_gmar =   meafyeney_elementim_tmp_rec.lo_nizbar_leshat_gmar,
   lehitalem_beitur_reyka =meafyeney_elementim_tmp_rec.  lehitalem_beitur_reyka,
   asur_bedivuach_yadani =meafyeney_elementim_tmp_rec.asur_bedivuach_yadani,
   tipul_meyuchad_Baklita =meafyeney_elementim_tmp_rec.tipul_meyuchad_Baklita ,
   tipul_meyuchad_Bashguim =meafyeney_elementim_tmp_rec.tipul_meyuchad_Bashguim ,
      tipul_meyuchad_Bachishuv =meafyeney_elementim_tmp_rec.tipul_meyuchad_Bachishuv
 where kod_element=tb_meafyeney_elementim_tmp_rec.kod_element
 and me_tarich=Me_Ad_tmp_rec.me_tarich
 and ad_tarich=Me_Ad_tmp_rec.ad_tarich;
END LOOP;
END LOOP;
END LOOP;
END Pivot_Meafyeney_Elementim;

PROCEDURE get_tmp_meafyeney_elementim(p_tar_me IN tb_sidurim_meyuchadim.me_taarich%type,
		  									   	  										 p_tar_ad  IN tb_sidurim_meyuchadim.me_taarich%type,
																						 p_Cur OUT CurType) AS
BEGIN
	 OPEN p_cur for
	 	  SELECT    v_element.kod_element,v_element.peula_o_yedia_bilvad element_for_yedia,
           v_element.hova_mispar_rechev bus_number_must,
           v_element.divuach_besidur_visa divuch_in_sidur_visa,
           v_element.kod_lechishuv_premia,v_element.divuach_besidur_meyuchad,
           v_element.sector_zvira_zman_haelement element_zvira_zman,
           v_element.erech_element element_in_minutes ,
           v_element.mispar_sidur_matalot_tnua,v_element.nesia_reika,
           v_element.bitul_biglal_ichur_lasidur,v_element.peilut_mashmautit,
		   v_element.lehitalem_hafifa_bein_nesiot, v_element.Hamtana element_hamtana,
		   v_element.Lershut ,v_element.bdikat_nz_hityazvut_next, v_element.erech_element,
		     v_element.lo_nizbar_leshat_gmar, v_element.lehitalem_beitur_reyka
		FROM  tmp_meafyeney_elementim  v_element
		WHERE   v_element.Me_Tarich <=p_tar_me
		AND nvl(v_element.AD_TARICH ,to_date('01/01/9999','dd/mm/yyyy'))  >=p_tar_ad;

EXCEPTION
       WHEN OTHERS THEN
				RAISE;
  END get_tmp_meafyeney_elementim;

  
 PROCEDURE  pro_get_all_elements_kod(p_Prefix in VARCHAR2,  p_Cur OUT CurType) AS
  BEGIN
      OPEN p_Cur for
	 SELECT KOD_ELEMENT
          FROM CTB_ELEMENTIM ME
          WHERE   (select count(*) from TB_MEAFYENEY_ELEMENTIM t
		  	  		  where t.KOD_ELEMENT = ME.KOD_ELEMENT and  t.KOD_MEAFYEN=40 )=0
		and   ME.KOD_ELEMENT   LIKE  p_Prefix || '%' 
		--and ME.KOD_ELEMENT not in(1,11,12)
			ORDER BY  ME.KOD_ELEMENT ASC ;
 
EXCEPTION
       WHEN OTHERS THEN
				RAISE;
  END pro_get_all_elements_kod;
  
PROCEDURE pro_get_element_details(p_kod_element in ctb_elementim.kod_element%type, p_cur out curtype ) AS
BEGIN
   OPEN p_Cur for
   SELECT  kod_element, pail, letashlum_premia, teur_element
   FROM CTB_ELEMENTIM ME
   WHERE  ME.KOD_ELEMENT =p_kod_element;
  
END pro_get_element_details;  
PROCEDURE pro_get_visut_details(p_kod_visut in ctb_nkudut_tifaul.kod_nekudat_tiful%type, p_cur out curtype) AS
BEGIN
   OPEN p_Cur for
   SELECT  teur_nekudat_tiful teur_visut
   FROM ctb_nkudut_tifaul 
   WHERE substr(ctb_nkudut_tifaul.kod_nekudat_tiful,2,3) =p_kod_visut;
END pro_get_visut_details;
END PKG_ELEMENTS; 
/
CREATE OR REPLACE PACKAGE          PKG_ERRORS AS
TYPE    CurType      IS    REF  CURSOR;

/******************************************************************************
   NAME:       PKG_ERRORS
   PURPOSE:

   REVISIONS:
   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        26/04/2009             1. Created this package.
******************************************************************************/

/*
Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        27/04/2009      vered       1. ????? ????? ????? ?????
*/

--FUNCTION fn_find_errors(mispar_ishi in pirtey_ovdim.mispar_ishi%type, kartis_avoda_dt in date ) return integer;
--FUNCTION fn_is_hour_missing(mispar_ishi in pirtey_ovdim.mispar_ishi%type,kartis_avoda_dt in date) return integer;
--FUNCTION fn_excption_error(mispar_ishi in pirtey_ovdim.mispar_ishi%type,kartis_avoda_dt in date) return integer;

PROCEDURE pro_get_oved_sidurim_peilut(p_mispar_ishi in ovdim.mispar_ishi%type, p_date in date, p_cur out CurType);
PROCEDURE pro_del_oved_errors(p_mispar_ishi in tb_shgiot.mispar_ishi%type, p_date in tb_shgiot.taarich%type);
PROCEDURE pro_get_lookup_tables(p_cur out CurType);

PROCEDURE pro_get_oved_matzav(p_mispar_ishi in matzav_ovdim.mispar_ishi%type, p_taarich in matzav_ovdim.taarich_siyum%type, p_cur out CurType) ;
PROCEDURE pro_get_oved_yom_avoda_details(p_mispar_ishi in tb_yamey_avoda_ovdim.mispar_ishi%type, p_taarich in tb_yamey_avoda_ovdim.taarich%type, p_Cur out CurType);
FUNCTION fn_is_oto_number_exists(p_oto_no in tb_peilut_ovdim.oto_no%type, p_date in date) return number;
FUNCTION fn_is_duplicate_shat_yetiza(p_mispar_ishi in ovdim.mispar_ishi%type, p_date in date) return number;
FUNCTION fn_is_zman_nesia_define(p_merkaz_erua in ctb_zman_nsiaa_mishtane.merkaz_erua%type,
                                 p_mikum_shaon_knisa in ctb_zman_nsiaa_mishtane.mikum_yaad%type,
                                 p_mikum_shaon_yetiza in ctb_zman_nsiaa_mishtane.mikum_yaad%type) return number;
PROCEDURE pro_get_sug_sidur_meafyenim(p_cur out CurType);
PROCEDURE pro_get_oved_yom_avoda_UDT(p_mispar_ishi in tb_yamey_avoda_ovdim.mispar_ishi%type, p_taarich in tb_yamey_avoda_ovdim.taarich%type,
                                             p_coll_meafeney_ovdim out coll_meafyeney_oved);
PROCEDURE pro_ins_sidurim_ovdim(p_coll_sidurim_ovdim in coll_sidurim_ovdim);
PROCEDURE pro_upd_sidurim_ovdim(p_coll_sidurim_ovdim in coll_sidurim_ovdim);
PROCEDURE pro_del_sidurim_ovdim(p_coll_sidurim_ovdim in coll_sidurim_ovdim,p_type_update in  number);
--PROCEDURE pro_upd_sidurim_ovdim(p_coll_sidurim_ovdim in COLL_TEST);
PROCEDURE pro_upd_yamey_avoda_ovdim(p_coll_yamey_avoda_ovdim in coll_yamey_avoda_ovdim);
PROCEDURE pro_upd_peilut_ovdim(p_coll_obj_peilut_ovdim in coll_obj_peilut_ovdim);
PROCEDURE pro_ins_peilut_ovdim(p_coll_obj_peilut_ovdim in coll_obj_peilut_ovdim);
PROCEDURE pro_del_peilut_ovdim(p_coll_obj_peilut_ovdim in coll_obj_peilut_ovdim);
PROCEDURE pro_ins_sidurim_ovdim_trail(p_obj_sidurim_ovdim in obj_sidurim_ovdim,p_sug_peula in trail_sidurim_ovdim.sug_peula%type);
PROCEDURE pro_upd_sidur_oved(p_obj_sidurim_ovdim in obj_sidurim_ovdim);
PROCEDURE pro_del_sidur_oved(p_obj_sidurim_ovdim in obj_sidurim_ovdim);
PROCEDURE pro_ins_yom_avoda_oved_trail(p_obj_yamey_avoda_ovdim in obj_yamey_avoda_ovdim);
PROCEDURE pro_upd_yom_avoda_oved(p_obj_yamey_avoda_ovdim in obj_yamey_avoda_ovdim);
PROCEDURE pro_upd_peilut_oved(p_obj_peilut_ovdim in obj_peilut_ovdim);
PROCEDURE pro_ins_peilut_ovdim_trail(p_obj_peilut_ovdim in obj_peilut_ovdim, p_sug_peula in trail_peilut_ovdim.sug_peula%type);
PROCEDURE pro_del_peilut_oved(p_obj_peilut_ovdim in obj_peilut_ovdim);
PROCEDURE pro_shinuy_kelet(p_coll_yamey_avoda_ovdim_upd in coll_yamey_avoda_ovdim,
                           p_coll_sidurim_ovdim_upd     in coll_sidurim_ovdim,
                           p_coll_sidurim_ovdim_ins     in coll_sidurim_ovdim,
                           p_coll_sidurim_ovdim_del     in coll_sidurim_ovdim,
                           p_coll_obj_peilut_ovdim_upd  in coll_obj_peilut_ovdim,
                           p_coll_obj_peilut_ovdim_ins  in coll_obj_peilut_ovdim,
                           p_coll_obj_peilut_ovdim_del  in coll_obj_peilut_ovdim);
PROCEDURE pro_oved_update_fields(p_mispar_ishi in ovdim.mispar_ishi%type, p_date in date, p_cur out CurType);
PROCEDURE pro_upd_card_status(p_mispar_ishi in tb_yamey_avoda_ovdim.mispar_ishi%type,
                              p_card_date in tb_yamey_avoda_ovdim.taarich%type,
                               p_status in tb_yamey_avoda_ovdim.status%type,
							    p_user_id in tb_yamey_avoda_ovdim.meadken_acharon%type);
PROCEDURE pro_get_ctb_shgiot(p_error_code in ctb_shgiot.kod_shgia%type, p_cur out CurType);
PROCEDURE pro_ins_approval_errors(p_obj_shgiot_meusharot in obj_shgiot_meusharot );

FUNCTION fn_is_approval_errors_exists(p_obj_shgiot_meusharot in obj_shgiot_meusharot, p_level in number) return number;
PROCEDURE pro_get_errors_for_field(p_field_name in ctb_shgiot.natun_lebdika%type, p_shgiot_leoved in number, p_cur out CurType);
PROCEDURE pro_upd_tar_ritzat_shgiot(p_mispar_ishi in tb_yamey_avoda_ovdim.mispar_ishi%type,
                              p_card_date in tb_yamey_avoda_ovdim.taarich%type,
							  p_shgiot_letzuga IN tb_yamey_avoda_ovdim.shgiot_letezuga_laoved%type);

PROCEDURE pro_is_duplicate_travel(p_mispar_ishi in tb_peilut_ovdim.mispar_ishi%type,
		 									  	 						 p_taarich  in tb_peilut_ovdim.taarich%type,
																		 p_makat_nesia in tb_peilut_ovdim.makat_nesia%type,
																		 p_shat_yetzia in tb_peilut_ovdim.shat_yetzia%type,
																		 p_mispar_knisa in tb_peilut_ovdim.mispar_knisa%type,
																		 p_Cur OUT CurType);

PROCEDURE pro_have_sidur_chofef(p_mispar_ishi in tb_sidurim_ovdim.mispar_ishi%type,
		 									  	 						 p_taarich  in tb_sidurim_ovdim.taarich%type,
																		 p_mispar_sidur in tb_sidurim_ovdim.mispar_sidur%type,
																		 p_shat_hatchala in tb_sidurim_ovdim.shat_hatchala%type,
																		 p_shat_gmar in tb_sidurim_ovdim.shat_gmar%type,
																		 p_param_chafifa in number,
																		 p_Cur OUT CurType);

FUNCTION  fn_count_shgiot_letzuga(p_arr_Kod_Shgia IN VARCHAR2) return number;

PROCEDURE get_idkuney_rashemet(p_mispar_ishi IN TB_idkun_rashemet.mispar_ishi%type,
		  										   							       p_taarich  IN TB_idkun_rashemet.taarich%type,
																				   p_Cur OUT CurType);
																				   

  PROCEDURE pro_check_have_sidur_grira(p_mispar_ishi in tb_sidurim_ovdim.mispar_ishi%type,
		 									  	 						 p_taarich  in tb_sidurim_ovdim.taarich%type,
																		 p_Cur OUT CurType) ;
	
	PROCEDURE pro_get_shgiot_no_active( p_cur out CurType);		
    procedure pro_get_all_shgiot(p_cur out CurType);													 																			   
END PKG_ERRORS; 
/

CREATE OR REPLACE PACKAGE BODY PKG_ERRORS AS

PROCEDURE pro_get_oved_sidurim_peilut(p_mispar_ishi in ovdim.mispar_ishi%type,
                               p_date in date, p_cur out CurType)
IS
BEGIN
    OPEN p_cur FOR
    select * from
	(SELECT o.mispar_ishi, o.mispar_sidur,o.bitul_o_hosafa, o.shat_gmar, o.shat_hatchala, o.yom_visa,
           o.chariga,nvl(o.pitzul_hafsaka,0)pitzul_hafsaka,o.taarich,o.shayah_leyom_kodem,o.mispar_shiurey_nehiga,
           o.out_michsa ,o.mezake_halbasha,
		   o.mikum_shaon_knisa,o.mikum_shaon_yetzia,
           o.hashlama,o.lo_letashlum,o.mivtza_visa,o.tafkid_visa,
           o.kod_siba_ledivuch_yadani_in, o.kod_siba_ledivuch_yadani_out, o.kod_siba_lo_letashlum,
           o.shat_hatchala_letashlum, o.shat_gmar_letashlum,o.mezake_nesiot,
           o.tosefet_grira, o.achuz_knas_lepremyat_visa,o.achuz_viza_besikun,
           o.mispar_musach_o_machsan,o.sug_hazmanat_visa, o.sug_hashlama,
           o.heara, o.taarich_idkun_acharon, o.meadken_acharon,
           o.sector_visa, o.nidreshet_hitiatzvut, o.shat_hitiatzvut, o.ptor_mehitiatzvut,o.Hachtama_Beatar_Lo_Takin,
		   po.kisuy_tor,po.makat_nesia,po.shat_yetzia,po.oto_no,po.mispar_sidur peilut_mispar_sidur,
		  po.heara heara_peilut,  po.mikum_bhirat_nesia_netzer,  po.mispar_sidur_netzer,
		  po.oto_no_netzer,po.shat_bhirat_nesia_netzer,po.shilut_netzer,
		po.shat_yetzia_netzer,po.kod_shinuy_premia,po.makat_netzer,
           po.mispar_siduri_oto,po.mispar_visa,po.mispar_knisa, po.dakot_bafoal, po.imut_netzer,
           po.bitul_o_hosafa peilut_bitul_o_hosafa,po.km_visa,  po.snif_tnua,po.mispar_matala,po.teur_nesia,
           sug_yom.erev_shishi_chag,sug_yom.shbaton, to_char(o.taarich,'d') iDay,ym.sug_yom, --mao.kod_matzav,
           v_sidurm.zakay_lezman_halbasha halbash_kod,
           v_sidurm.shat_hatchala_muteret,
           v_sidurm.shat_gmar_muteret, 
           v_sidurm.zakay_michutz_lamichsa,
           --v_sidurm.shat_hatchala_muteret hour_kod2,
           v_sidurm.sidur_asur_ledaveach_peilut no_peilot_kod,
           v_sidurm.asur_ledaveach_mispar_rechev no_oto_no,
           v_sidurm.sidur_namlak_visa sidur_visa_kod,
           v_sidurm.sector_avoda, v_sidurm.sidur_lo_nivdak_sofash,
           v_sidurm.zakay_lehashlama_avur_sidur hashlama_kod,
           v_sidurm.zakay_lechariga, v_sidurm.zakay_lehamara ,
           v_sidurm.zakay_leaman_nesia,
           v_sidurm.hova_ledaveach_peilut peilut_required_kod,
           v_sidurm.asur_ledivuach_lechevrot_bat sidur_not_valid_kod,
           --v_sidurm.sidur_netzer sidur_netzer_kod,
           v_sidurm.hukiyut_beshabaton sidur_not_in_shabton_kod,
           v_sidurm.sidur_misug_headrut headrut_type_kod,
           v_sidurm.sug_avoda,v_sidurm.hova_ledaveach_mispar_machsan,
           v_sidurm.shaon_nochachut,  v_sidurm.nitan_ledaveach_bmachala_aruc,
           v_sidurm.mispar_sidur mispar_sidur_myuhad,
           v_sidurm.sidur_kaytanot_veruey_kayiz sidur_in_summer,
           v_sidurm.lo_letashlum_automati,
		   v_sidurm.zakay_lepizul,
           v_sidurm.kizuz_al_pi_hatchala_gmar,
           v_sidurm.nitan_ledaveach_ad_taarich,
           v_sidurm.element1_hova,v_sidurm.element2_hova,v_sidurm.element3_hova,
           v_element.peula_o_yedia_bilvad element_for_yedia,
           v_element.hova_mispar_rechev bus_number_must,
           v_element.divuach_besidur_visa divuch_in_sidur_visa,
           v_element.kod_lechishuv_premia,  v_element.lo_nizbar_leshat_gmar,
           v_element.sector_zvira_zman_haelement element_zvira_zman,
           v_element.erech_element element_in_minutes ,
           v_element.mispar_sidur_matalot_tnua,v_element.divuach_besidur_meyuchad,
           v_element.bitul_biglal_ichur_lasidur,v_element.nesia_reika,
		   v_element.lehitalem_hafifa_bein_nesiot, v_element.Hamtana element_hamtana,
		   v_element.Lershut ,v_sidurm.hovat_hityazvut  ,
		   v_element.erech_element,v_element.peilut_mashmautit,
           v_element.lehitalem_beitur_reyka,           
		   decode(o.bitul_o_hosafa,1,1,3,1,0) sidur_mevutal ,
		   decode(po.bitul_o_hosafa,1,1,3,1,0) peilut_mevutelet,
           sm.teur_sidur_meychad,sl.LEBDIKAT_SHGUIM
    FROM tb_sidurim_ovdim o,tb_peilut_ovdim po,
         tb_yamim_meyuchadim ym,ctb_sugey_yamim_meyuchadim sug_yom,
         tmp_sidurim_meyuchadim v_sidurm,
         tmp_meafyeney_elementim v_element,
         ctb_sidurim_meyuchadim  sm,
		 ctb_sibot_loletashlum sl
    WHERE o.mispar_ishi = po.mispar_ishi(+)
          AND o.taarich = po.taarich(+)
          AND o.mispar_sidur= po.mispar_sidur(+)
          AND o.shat_hatchala = po.shat_hatchala_sidur(+)
          AND o.mispar_ishi=p_mispar_ishi
          AND o.taarich=p_date
          AND o.taarich=ym.taarich(+)
          AND ym.sug_yom=sug_yom.sug_yom(+)
          AND v_sidurm.mispar_sidur(+)=o.mispar_sidur
          AND p_date between v_sidurm.me_tarich(+) and v_sidurm.ad_tarich(+)
          AND to_number(substr(po.makat_nesia,2,2)) = v_element.kod_element(+)
          AND p_date between v_element.me_tarich(+) and v_element.ad_tarich(+)
          AND sm.kod_sidur_meyuchad(+) = o.mispar_sidur
		  and o.KOD_SIBA_LO_LETASHLUM= sl.KOD_SIBA(+)
		  and (sl.PAIL=1 or sl.PAIL is null) )
    ORDER BY  sidur_mevutal ,shat_hatchala,mispar_sidur  ,peilut_mevutelet,shat_yetzia,mispar_knisa ;

EXCEPTION
        WHEN OTHERS THEN
		RAISE;

END pro_get_oved_sidurim_peilut;

PROCEDURE pro_del_oved_errors(p_mispar_ishi in tb_shgiot.mispar_ishi%type, p_date in tb_shgiot.taarich%type)
IS
BEGIN
    DELETE FROM tb_shgiot s
    WHERE s.mispar_ishi=p_mispar_ishi
          AND s.taarich= p_date;

    EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END pro_del_oved_errors;
PROCEDURE pro_get_lookup_tables(p_cur out CurType)
IS
BEGIN
    OPEN p_cur FOR
    SELECT kod_lina kod, teur_lina teur, 'ctb_lina' table_name FROM ctb_lina
    WHERE pail=1
    UNION ALL
    SELECT kod_divuch kod , teur_divuch teur, 'ctb_divuch_hariga_meshaot' table_name  FROM ctb_divuch_hariga_meshaot
    UNION ALL
    SELECT kod_pizul_hafsaka kod,teur_pizul_hafsaka teur ,'ctb_pitzul_hafsaka' table_name FROM ctb_pitzul_hafsaka
    WHERE pail=1
    UNION ALL
    SELECT kod_zman_halbasha kod, teur_zman_halbasha teur,'ctb_zmaney_halbasha' table_name FROM ctb_zmaney_halbasha
    WHERE pail=1
    UNION ALL
    SELECT kod_zman_nesiaa kod, teur_zman_nesiaa teur,'ctb_zmaney_nesiaa' table_name FROM CTB_ZMANEY_NESIAA
    WHERE pail=1
    UNION ALL
    SELECT kod_yom_visa kod, teur_yom_visa teur,'ctb_yom_visa' FROM CTB_YOM_VISA
    UNION ALL
    SELECT kod_siba kod, teur_siba teur, 'ctb_sibot_hashlama_leyom' FROM CTB_SIBOT_HASHLAMA_LEYOM
    WHERE letzuga = 1 and pail = 1
    UNION ALL
    SELECT kod_status_kartis kod , teur_status_kartis teur, 'ctb_status_kartis' FROM CTB_STATUS_KARTIS
    WHERE pail=1;
EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END pro_get_lookup_tables;



PROCEDURE pro_get_oved_yom_avoda_details(p_mispar_ishi in tb_yamey_avoda_ovdim.mispar_ishi%type,
                                         p_taarich in tb_yamey_avoda_ovdim.taarich%type, p_Cur out CurType)
IS
BEGIN
     OPEN p_cur FOR
     SELECT ymao.mispar_ishi,ymao.lina,
            ymao.hashlama_leyom, ymao.halbasha, v_pirty_oved.snif_av,
            ymao.bitul_zman_nesiot, ymao.tachograf,ymao.hamarat_shabat Hamara,
            ymao.zman_nesia_haloch, ymao.zman_nesia_hazor,ymao.status,ymao.status_tipul,
            ymao.sibat_hashlama_leyom,ymao.measher_o_mistayeg,
            v_pirty_oved.maamad, v_pirty_oved.isuk,
            v_pirty_oved.mutaam, v_pirty_oved.mercaz_erua,
            v_pirty_oved.dakot_mutamut,v_pirty_oved.gil,
            v_pirty_oved.rishyon_autobus, v_pirty_oved.shlilat_rishayon,
            ov.kod_hevra,sug_yom.teur_yom,i.KOD_SECTOR_ISUK  ,
            sug_yom.erev_shishi_chag,sug_yom.shbaton, to_char(ymao.taarich,'d') iDay,
            nvl(status_card.teur_status_kartis,'')  teur_status_kartis,
             decode(s.snif_tnua,null,v_pirty_oved.hatzava_lekav,s.snif_tnua) snif_tnua

     FROM tb_yamey_avoda_ovdim ymao,
          tmp_pirtey_ovdim v_pirty_oved,
          ovdim ov,
          tb_yamim_meyuchadim ym,
          ctb_sugey_yamim_meyuchadim sug_yom,
          ctb_status_kartis status_card,
          CTB_Isuk i,
		  CTB_SNIF_AV s
     WHERE ymao.mispar_ishi             = p_mispar_ishi
        AND ymao.mispar_ishi            = ov.mispar_ishi
        AND ymao.taarich                = p_taarich
        AND ymao.taarich                = ym.taarich(+)
        AND ym.sug_yom                  = sug_yom.sug_yom(+)
        AND v_pirty_oved.mispar_ishi(+) = ymao.mispar_ishi
        AND p_taarich between v_pirty_oved.me_tarich(+) and v_pirty_oved.ad_tarich(+)
        AND status_card.kod_status_kartis(+) = ymao.status
		 	And (ov.kod_hevra= i.Kod_Hevra or  i.Kod_Hevra is null)
		 and v_pirty_oved.isuk= i.Kod_Isuk(+)
	   And (s.Kod_Hevra= ov.kod_hevra or  s.Kod_Hevra is null)
		   and s.kod_snif_av(+)=v_pirty_oved.snif_av;

EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END pro_get_oved_yom_avoda_details;
/*FUNCTION fn_find_errors(mispar_ishi in pirtey_ovdim.mispar_ishi%type,
                         kartis_avoda_dt in date ) return integer
IS
 result integer;
 error_code integer;
BEGIN
    --The procedure finds error in employee card
    --If error found return 0,  else return 1


    --9 : Sidur not exists

    --15: Missing start hour or end hour
       result := fn_is_hour_missing(mispar_ishi, kartis_avoda_dt);
       if (result<>0) then
            error_code:=15;
           else
            error_code:=1;
       end if;

       --33: Execption error
       result := fn_excption_error(mispar_ishi, kartis_avoda_dt);

       return result;

EXCEPTION
        WHEN OTHERS THEN
		RAISE;

END fn_find_errors;


FUNCTION fn_excption_error(mispar_ishi in pirtey_ovdim.mispar_ishi%type,kartis_avoda_dt in date) return integer
IS
    v_exeption_error number;
BEGIN
    SELECT chariga INTO v_exeption_error
    FROM tb_sidurim_ovdim mm
    WHERE mm.mispar_ishi = mispar_ishi
          AND mm.taarich = kartis_avoda_dt;

    if (v_exeption_error in (0,1,3,6,7,8)) then
     return 1;
     else
      return 0; --error
    end if;


    EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END fn_excption_error;

FUNCTION fn_is_hour_missing(mispar_ishi in pirtey_ovdim.mispar_ishi%type,
                            kartis_avoda_dt in date) return integer
IS
    v_shat_hatchala date;
    v_shat_gmar date;
    result integer;
BEGIN
    --15: Missing start hour or end hour
    --return 0:ok 1:missing start hour, 2:missing end hour, 3: missing start and end hour

    SELECT shat_hatchala,shat_gmar INTO v_shat_hatchala,v_shat_gmar
    FROM tb_sidurim_ovdim mm
    WHERE mm.mispar_ishi = mispar_ishi
          AND mm.taarich = kartis_avoda_dt;


    IF  (v_shat_hatchala=NULL) THEN
        IF (v_shat_gmar=NULL) THEN
           result:=3;
          ELSE
           result:=1;
        END IF;
     ELSE
        IF (v_shat_gmar=Null) THEN
           result:=2;
          ELSE
           result:=0;
        END IF;
    END IF;

    RETURN result;

    EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END fn_is_hour_missing;*/

PROCEDURE  pro_get_oved_matzav(p_mispar_ishi in matzav_ovdim.mispar_ishi%type,
                            p_taarich in matzav_ovdim.taarich_siyum%type, p_cur out CurType)

IS

BEGIN
    OPEN p_Cur FOR
    SELECT kod_matzav
    FROM Matzav_Ovdim m
    WHERE m.MISPAR_ISHI=p_mispar_ishi
          AND trunc(p_taarich) BETWEEN trunc(m.TAARICH_HATCHALA) AND trunc(m.TAARICH_SIYUM);


END  pro_get_oved_matzav;
FUNCTION fn_is_oto_number_exists(p_oto_no in tb_peilut_ovdim.oto_no%type, p_date date) return number
IS
    v_count number;
BEGIN
 -- SELECT COUNT(bus_number)  INTO v_count
 --   FROM VCL_GENERAL_VEHICLE_VIEW@kds2maale
 --   WHERE bus_number=p_oto_no;

    --Code return 0 -valid    1- error    2- not found
    SELECT VCL_LOADER.CheckBusNumber@kds2maale(p_date,p_oto_no) INTO v_count FROM dual ;
    RETURN  v_count;

    EXCEPTION
        WHEN OTHERS THEN
        v_count:=1;
		RAISE;
END fn_is_oto_number_exists;
FUNCTION fn_is_duplicate_shat_yetiza(p_mispar_ishi in ovdim.mispar_ishi%type, p_date in date) return number
IS
    v_count number;
BEGIN
    v_count:=0;
    SELECT count(shat_yetzia) into v_count FROM
    (SELECT count(po.shat_yetzia) shat_yetzia
    FROM tb_sidurim_ovdim o,tb_peilut_ovdim po
    WHERE o.mispar_ishi = po.mispar_ishi
              AND o.taarich = po.taarich
              AND o.shat_hatchala = po.shat_hatchala_sidur
              AND o.mispar_sidur= po.mispar_sidur(+)
              AND o.mispar_ishi=p_mispar_ishi
              AND o.taarich=p_date
              AND ((pkg_tnua.fn_get_makat_type(po.makat_nesia)<>5)
                   OR ((pkg_tnua.fn_get_makat_type(po.makat_nesia)=5) AND
                     (NOT EXISTS (SELECT kod_element
                                  FROM tb_meafyeney_elementim o1
                                  WHERE o1.kod_element=po.makat_nesia
                                       AND o1.kod_meafyen=9
                                       AND p_date BETWEEN o1.me_taarich AND o1.ad_taarich))
                   )
              )

    GROUP BY po.shat_yetzia
    HAVING COUNT(po.shat_yetzia) > 1);

    RETURN v_count;
EXCEPTION
        WHEN NO_DATA_FOUND THEN
          Return 0;
        WHEN OTHERS THEN
		RAISE;

END fn_is_duplicate_shat_yetiza;

FUNCTION fn_is_zman_nesia_define(p_merkaz_erua in ctb_zman_nsiaa_mishtane.merkaz_erua%type,
                                 p_mikum_shaon_knisa in ctb_zman_nsiaa_mishtane.mikum_yaad%type,
                                 p_mikum_shaon_yetiza in ctb_zman_nsiaa_mishtane.mikum_yaad%type) return number
IS
 v_count_knisa number;
 v_count_yetiza number;
 v_res number;
BEGIN
    --return 0 if the two knisa and yetiza defines
    --return 3 if both, knisa and tetiza not define
    --return 1 if knisa not define
    --return 2 if yetiza not define
    IF (p_mikum_shaon_knisa=0) THEN
        v_count_knisa:=1;
    ELSE
        SELECT COUNT(merkaz_erua) INTO v_count_knisa
        FROM ctb_zman_nsiaa_mishtane c
        WHERE c.merkaz_erua =p_merkaz_erua
              AND c.mikum_yaad=p_mikum_shaon_knisa;
    END IF;

    IF (p_mikum_shaon_yetiza=0) THEN
        v_count_yetiza:=1;
    ELSE
        SELECT COUNT(merkaz_erua) INTO v_count_yetiza
        FROM ctb_zman_nsiaa_mishtane c
        WHERE c.merkaz_erua =p_merkaz_erua
              AND c.mikum_yaad=p_mikum_shaon_yetiza;
    END IF;

     if (v_count_knisa=0) then
        if (v_count_yetiza=0) then
            v_res:=3;
         else
            v_res:=1;
        end if;
       else
         if (v_count_yetiza=0) then
            v_res:=2;
           else
            v_res:=0;
         end if;
     end if;

     return v_res;
EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END fn_is_zman_nesia_define;
PROCEDURE pro_get_sug_sidur_meafyenim(p_cur out CurType)
IS
BEGIN
    OPEN p_cur for
    SELECT sug_sidur,sug_avoda,asur_ledaveach_mispar_rechev,
           sector_avoda,zakay_leaman_nesia,zakay_lehamara,zakay_lehashlama_avur_sidur,
           lo_letashlum_automati,kizuz_al_pi_hatchala_gmar,shaon_nochachut,
           me_tarich, ad_tarich,
		   zakay_lepizul, lo_nidreshet_hityazvut
    FROM TMP_MEAFYENEY_SUG_SIDUR;

END pro_get_sug_sidur_meafyenim;

PROCEDURE pro_get_oved_yom_avoda_UDT(p_mispar_ishi in tb_yamey_avoda_ovdim.mispar_ishi%type, p_taarich in tb_yamey_avoda_ovdim.taarich%type,
                                     p_coll_meafeney_ovdim out coll_meafyeney_oved)
IS
BEGIN

     SELECT obj_meafyeney_oved
            (ymao.mispar_ishi,ymao.lina,ymao.hashlama_leyom ,ymao.halbasha, ymao.bitul_zman_nesiot,
            v_pirty_oved.maamad,v_pirty_oved.isuk, ov.kod_hevra)--, ymao.tachograf,


     BULK COLLECT into p_coll_meafeney_ovdim
     FROM tb_yamey_avoda_ovdim ymao,viw_meafyenim_ovdim v_oved_meafynim,
          tmp_pirtey_ovdim v_pirty_oved, ovdim ov
     WHERE ymao.mispar_ishi=p_mispar_ishi
        AND ymao.mispar_ishi = ov.mispar_ishi
        AND ymao.taarich=p_taarich
        AND ymao.mispar_ishi=v_oved_meafynim.mispar_ishi(+)
        AND p_taarich > v_oved_meafynim.me_taarich(+)-- and v_oved_meafynim.ad_taarich(+)
        AND v_pirty_oved.mispar_ishi(+)=ymao.mispar_ishi
        AND p_taarich between v_pirty_oved.me_tarich(+) and v_pirty_oved.ad_tarich(+);

END pro_get_oved_yom_avoda_UDT;

PROCEDURE pro_ins_sidurim_ovdim(p_coll_sidurim_ovdim in COLL_SIDURIM_OVDIM) IS
    iMinutes number;
    iCount number;
    bFound boolean;
    dShatHatchala Date;
BEGIN
     
     
      IF (p_coll_sidurim_ovdim is not null) THEN
          FOR i IN  1..p_coll_sidurim_ovdim.COUNT LOOP
             dShatHatchala:=p_coll_sidurim_ovdim(i).shat_hatchala;
             
             
             IF (to_char(dShatHatchala, 'YYYY')='0001') THEN
                  iMinutes := 1;
                  iCount := 0; 
                  bFound := false;
                  WHILE not bFound LOOP
                    SELECT COUNT(mispar_sidur) INTO iCount
                    FROM TB_SIDURIM_OVDIM a 
                    WHERE  a.mispar_ishi = p_coll_sidurim_ovdim(i).mispar_ishi
                           AND a.taarich = p_coll_sidurim_ovdim(i).taarich
                           AND a.mispar_sidur = p_coll_sidurim_ovdim(i).mispar_sidur
                           AND a.shat_hatchala = dShatHatchala;
                           
                    IF (iCount > 0) THEN 
                        iMinutes := iMinutes + 1;
                        dShatHatchala := to_date('01/01/0001 00:0' || iMinutes ,'dd/mm/yyyy HH24:MI') ;
                       ELSE
                           bFound:=true;   
                    END IF;        
                  END LOOP;                    
              END IF;
              
              
              
              INSERT INTO TB_SIDURIM_OVDIM
                          (mispar_ishi                 ,
                           mispar_sidur                ,
                           taarich                     ,
                           shat_hatchala               ,
                           shat_gmar                   ,
                           meadken_acharon             ,
                           shat_hatchala_letashlum     ,
                           shat_gmar_letashlum         ,
                           pitzul_hafsaka              ,
                           chariga                     ,
                           tosefet_grira               ,
						   bitul_o_hosafa,
                      --     hamarat_shabat              ,
                           hashlama                    ,
                           yom_visa                    ,
                           lo_letashlum                ,
                           out_michsa                  ,
                           mikum_shaon_knisa           ,
                           mikum_shaon_yetzia          ,
                           --km_visa_lepremia          ,
                           achuz_knas_lepremyat_visa   ,
                           achuz_viza_besikun          ,
                           mispar_musach_o_machsan     ,
                           tafkid_visa                 ,
                           mivtza_visa                 ,
                           kod_siba_lo_letashlum       ,
                           kod_siba_ledivuch_yadani_in ,
                           kod_siba_ledivuch_yadani_out,
                           shayah_leyom_kodem          ,
                           taarich_idkun_acharon       ,
                           heara                       ,
                           mispar_shiurey_nehiga       ,
                           mezake_halbasha             ,
                           mezake_nesiot               ,
                           sug_hazmanat_visa           ,
                           shat_hitiatzvut,
						   sector_visa,
						   ptor_mehitiatzvut ,
						   nidreshet_hitiatzvut,
						   hachtama_beatar_lo_takin,
						   sug_hashlama
                          )
              VALUES (p_coll_sidurim_ovdim(i).mispar_ishi,p_coll_sidurim_ovdim(i).mispar_sidur,
                      p_coll_sidurim_ovdim(i).taarich, dShatHatchala,
                      p_coll_sidurim_ovdim(i).shat_gmar,-2,
                      p_coll_sidurim_ovdim(i).shat_hatchala_letashlum,p_coll_sidurim_ovdim(i).shat_gmar_letashlum,
                      p_coll_sidurim_ovdim(i).pitzul_hafsaka,p_coll_sidurim_ovdim(i).chariga,
                      p_coll_sidurim_ovdim(i).tosefet_grira,    p_coll_sidurim_ovdim(i).bitul_o_hosafa,--p_coll_sidurim_ovdim(i).hamarat_shabat,
                      p_coll_sidurim_ovdim(i).hashlama,p_coll_sidurim_ovdim(i).yom_visa,
                      p_coll_sidurim_ovdim(i).lo_letashlum,p_coll_sidurim_ovdim(i).out_michsa,
                      p_coll_sidurim_ovdim(i).mikum_shaon_knisa,p_coll_sidurim_ovdim(i).mikum_shaon_yetzia,
                      p_coll_sidurim_ovdim(i).achuz_knas_lepremyat_visa,
                      p_coll_sidurim_ovdim(i).achuz_viza_besikun,
                      p_coll_sidurim_ovdim(i).mispar_musach_o_machsan,
                      p_coll_sidurim_ovdim(i).tafkid_visa,             
                      p_coll_sidurim_ovdim(i).mivtza_visa, 
                      p_coll_sidurim_ovdim(i).kod_siba_lo_letashlum,
                      p_coll_sidurim_ovdim(i).kod_siba_ledivuch_yadani_in,p_coll_sidurim_ovdim(i).kod_siba_ledivuch_yadani_out,
                      p_coll_sidurim_ovdim(i).shayah_leyom_kodem,sysdate,
                      p_coll_sidurim_ovdim(i).heara,p_coll_sidurim_ovdim(i).mispar_shiurey_nehiga,
                      p_coll_sidurim_ovdim(i).mezake_halbasha,p_coll_sidurim_ovdim(i).mezake_nesiot,
                      p_coll_sidurim_ovdim(i).sug_hazmanat_visa,
                      p_coll_sidurim_ovdim(i).shat_hitiatzvut,
					  p_coll_sidurim_ovdim(i).sector_visa,
					   p_coll_sidurim_ovdim(i).ptor_mehitiatzvut ,
					  p_coll_sidurim_ovdim(i).nidreshet_hitiatzvut,
					  p_coll_sidurim_ovdim(i).hachtama_beatar_lo_takin,
					  p_coll_sidurim_ovdim(i).sug_hashlama);
          END LOOP;
       END IF;
      EXCEPTION
		 WHEN OTHERS THEN
		      RAISE;
END pro_ins_sidurim_ovdim;

PROCEDURE pro_upd_sidurim_ovdim(p_coll_sidurim_ovdim in COLL_SIDURIM_OVDIM) IS
BEGIN

    IF (p_coll_sidurim_ovdim is not null) THEN
        FOR i IN 1..p_coll_sidurim_ovdim.COUNT LOOP
            IF (p_coll_sidurim_ovdim(i).update_object=1) THEN
                pro_ins_sidurim_ovdim_trail(p_coll_sidurim_ovdim(i),3);
                pro_upd_sidur_oved(p_coll_sidurim_ovdim(i));
            END IF;
          END LOOP;
    END IF;
      EXCEPTION
		 WHEN OTHERS THEN
		      RAISE;
END pro_upd_sidurim_ovdim;
PROCEDURE pro_del_sidurim_ovdim(p_coll_sidurim_ovdim in coll_sidurim_ovdim,p_type_update in  number) IS
BEGIN
    IF (p_coll_sidurim_ovdim is not null) THEN
        FOR i IN 1..p_coll_sidurim_ovdim.COUNT LOOP
		   IF (p_coll_sidurim_ovdim(i).update_object=p_type_update) THEN
	            pro_ins_sidurim_ovdim_trail(p_coll_sidurim_ovdim(i),2);
	            pro_del_sidur_oved(p_coll_sidurim_ovdim(i));
				end if;
          END LOOP;
    END IF;
      EXCEPTION
		 WHEN OTHERS THEN
		      RAISE;
END pro_del_sidurim_ovdim;
PROCEDURE pro_upd_yamey_avoda_ovdim(p_coll_yamey_avoda_ovdim in coll_yamey_avoda_ovdim) IS
BEGIN
      IF (p_coll_yamey_avoda_ovdim is not null) THEN
          FOR i IN 1..p_coll_yamey_avoda_ovdim.COUNT LOOP
              IF (p_coll_yamey_avoda_ovdim(i).update_object=1) THEN
                  pro_ins_yom_avoda_oved_trail(p_coll_yamey_avoda_ovdim(i));
                  pro_upd_yom_avoda_oved(p_coll_yamey_avoda_ovdim(i));
              END IF;
          END LOOP;
      END IF;
      EXCEPTION
		 WHEN OTHERS THEN
		      RAISE;
END pro_upd_yamey_avoda_ovdim;

PROCEDURE pro_upd_peilut_ovdim(p_coll_obj_peilut_ovdim in coll_obj_peilut_ovdim) IS
BEGIN

     IF (p_coll_obj_peilut_ovdim is not null) THEN
         FOR i IN 1..p_coll_obj_peilut_ovdim.COUNT LOOP
             IF (p_coll_obj_peilut_ovdim(i).update_object=1) THEN
                 pro_ins_peilut_ovdim_trail(p_coll_obj_peilut_ovdim(i),3);
                 pro_upd_peilut_oved(p_coll_obj_peilut_ovdim(i));
             END IF;

          END LOOP;
      END IF;

      EXCEPTION
		 WHEN OTHERS THEN
		      RAISE;
END pro_upd_peilut_ovdim;

PROCEDURE pro_ins_peilut_ovdim(p_coll_obj_peilut_ovdim in coll_obj_peilut_ovdim) IS
    iMinutes number;
    iCount number;
    bFound boolean;
    dShatYetiza Date;
BEGIN
      IF (p_coll_obj_peilut_ovdim is not null) THEN
          FOR i IN 1..p_coll_obj_peilut_ovdim.COUNT LOOP
          
            dShatYetiza:=p_coll_obj_peilut_ovdim(i).shat_yetzia;
            IF (to_char(dShatYetiza, 'YYYY')='0001') THEN
                  iMinutes := 1;
                  iCount := 0; 
                  bFound := false;
                  WHILE not bFound LOOP
                    SELECT COUNT(mispar_sidur) INTO iCount
                    FROM TB_PEILUT_OVDIM a 
                    WHERE  a.mispar_ishi = p_coll_obj_peilut_ovdim(i).mispar_ishi
                           AND a.taarich = p_coll_obj_peilut_ovdim(i).taarich
                           AND a.mispar_sidur = p_coll_obj_peilut_ovdim(i).mispar_sidur
                           AND a.shat_hatchala_sidur = p_coll_obj_peilut_ovdim(i).shat_hatchala_sidur
                           AND a.mispar_knisa = p_coll_obj_peilut_ovdim(i).mispar_knisa
                           AND a.shat_yetzia = dShatYetiza;
                           
                    IF (iCount > 0) THEN 
                        iMinutes := iMinutes + 1;
                        dShatYetiza := to_date('01/01/0001 00:0' || iMinutes ,'dd/mm/yyyy HH24:MI') ;
                       ELSE
                           bFound:=true;   
                    END IF;        
                  END LOOP;                    
            END IF;
              
            INSERT INTO TB_PEILUT_OVDIM
                        (mispar_ishi,
                         mispar_sidur,
                         taarich,
                         shat_hatchala_sidur,
                         shat_yetzia,
                         mispar_knisa,
                         makat_nesia,
                         oto_no,
                         mispar_siduri_oto,
                         kisuy_tor,
                         bitul_o_hosafa,
                         kod_shinuy_premia,
                         mispar_visa,
                         imut_netzer,
                         shat_bhirat_nesia_netzer,
                         oto_no_netzer,
                         mispar_sidur_netzer,
                         shat_yetzia_netzer,
                         makat_netzer,
                         shilut_netzer,
                         mikum_bhirat_nesia_netzer,
                         mispar_matala,
						 dakot_bafoal,
                         taarich_idkun_acharon,
                         meadken_acharon,
                         heara,
						 teur_nesia)
                         --ishur_kfula)
             VALUES (p_coll_obj_peilut_ovdim(i).mispar_ishi,
                     p_coll_obj_peilut_ovdim(i).mispar_sidur,
                     p_coll_obj_peilut_ovdim(i).taarich,
                     p_coll_obj_peilut_ovdim(i).shat_hatchala_sidur,
                     dShatYetiza,--p_coll_obj_peilut_ovdim(i).shat_yetzia,
                     p_coll_obj_peilut_ovdim(i).mispar_knisa,
                     p_coll_obj_peilut_ovdim(i).makat_nesia,
                     p_coll_obj_peilut_ovdim(i).oto_no,
                     p_coll_obj_peilut_ovdim(i).mispar_siduri_oto,
                     p_coll_obj_peilut_ovdim(i).kisuy_tor,
                     p_coll_obj_peilut_ovdim(i).bitul_o_hosafa,
                     p_coll_obj_peilut_ovdim(i).kod_shinuy_premia,
                     p_coll_obj_peilut_ovdim(i).mispar_visa,
                     p_coll_obj_peilut_ovdim(i).imut_netzer,
                     p_coll_obj_peilut_ovdim(i).shat_bhirat_nesia_netzer,
                     p_coll_obj_peilut_ovdim(i).oto_no_netzer,
                     p_coll_obj_peilut_ovdim(i).mispar_sidur_netzer,
                     p_coll_obj_peilut_ovdim(i).shat_yetzia_netzer,
                     p_coll_obj_peilut_ovdim(i).makat_netzer,
                     p_coll_obj_peilut_ovdim(i).shilut_netzer,
                     p_coll_obj_peilut_ovdim(i).mikum_bhirat_nesia_netzer,
			         p_coll_obj_peilut_ovdim(i).mispar_matala,
					 p_coll_obj_peilut_ovdim(i).dakot_bafoal,
                     sysdate,
                     p_coll_obj_peilut_ovdim(i).meadken_acharon,
                     p_coll_obj_peilut_ovdim(i).heara,
					 p_coll_obj_peilut_ovdim(i).teur_nesia
					  );
                    -- p_coll_obj_peilut_ovdim(i).ishur_kfula);
          END LOOP;
      END IF;
      EXCEPTION
		 WHEN OTHERS THEN
		      RAISE;
END pro_ins_peilut_ovdim;

PROCEDURE pro_del_peilut_ovdim(p_coll_obj_peilut_ovdim in coll_obj_peilut_ovdim) IS
BEGIN
      IF (p_coll_obj_peilut_ovdim is not null) THEN
            FOR i IN 1..p_coll_obj_peilut_ovdim.COUNT LOOP
                pro_ins_peilut_ovdim_trail(p_coll_obj_peilut_ovdim(i),2);
                pro_del_peilut_oved(p_coll_obj_peilut_ovdim(i));
           END LOOP;
      END IF;
      EXCEPTION
		 WHEN OTHERS THEN
		      RAISE;
END pro_del_peilut_ovdim;

PROCEDURE pro_upd_sidur_oved(p_obj_sidurim_ovdim in obj_sidurim_ovdim) IS
BEGIN
    --Insert sidurim
    UPDATE TB_SIDURIM_OVDIM
    SET lo_letashlum                 = p_obj_sidurim_ovdim.lo_letashlum,
        hashlama                     = p_obj_sidurim_ovdim.Hashlama,
    --    hamarat_shabat               = p_obj_sidurim_ovdim.hamarat_shabat,
        shat_hatchala                = p_obj_sidurim_ovdim.new_shat_hatchala,
        shat_gmar                    = p_obj_sidurim_ovdim.shat_gmar,
        mispar_ishi                  = p_obj_sidurim_ovdim.mispar_ishi,
        mispar_sidur                 = p_obj_sidurim_ovdim.new_mispar_sidur,
        chariga                      = p_obj_sidurim_ovdim.chariga,
        out_michsa                   = p_obj_sidurim_ovdim.out_michsa,
        shat_hatchala_letashlum      = p_obj_sidurim_ovdim.shat_hatchala_letashlum,
        shat_gmar_letashlum          = p_obj_sidurim_ovdim.shat_gmar_letashlum,
        mezake_nesiot                = p_obj_sidurim_ovdim.mezake_nesiot,
        mezake_halbasha              = p_obj_sidurim_ovdim.mezake_halbasha,
        taarich_idkun_acharon        = sysdate,
        meadken_acharon              = p_obj_sidurim_ovdim.meadken_acharon,
        kod_siba_ledivuch_yadani_out = p_obj_sidurim_ovdim.kod_siba_ledivuch_yadani_out,
        kod_siba_ledivuch_yadani_in  = p_obj_sidurim_ovdim.kod_siba_ledivuch_yadani_in,
        pitzul_hafsaka               = p_obj_sidurim_ovdim.pitzul_hafsaka,
        kod_siba_lo_letashlum        = p_obj_sidurim_ovdim.kod_siba_lo_letashlum,
        bitul_o_hosafa               = p_obj_sidurim_ovdim.bitul_o_hosafa,
        shat_hitiatzvut              = p_obj_sidurim_ovdim.shat_hitiatzvut,
		ptor_mehitiatzvut    = p_obj_sidurim_ovdim.ptor_mehitiatzvut,
		 nidreshet_hitiatzvut   = p_obj_sidurim_ovdim.nidreshet_hitiatzvut,
         hachtama_beatar_lo_takin= p_obj_sidurim_ovdim. hachtama_beatar_lo_takin,
		 sug_hashlama=p_obj_sidurim_ovdim.sug_hashlama
    WHERE mispar_ishi  = p_obj_sidurim_ovdim.mispar_ishi AND
          mispar_sidur = p_obj_sidurim_ovdim.new_mispar_sidur AND
          taarich      = trunc(p_obj_sidurim_ovdim.taarich) AND
          shat_hatchala= p_obj_sidurim_ovdim.new_shat_hatchala;
EXCEPTION
		 WHEN OTHERS THEN
		      RAISE;
END pro_upd_sidur_oved;
PROCEDURE pro_del_sidur_oved(p_obj_sidurim_ovdim in obj_sidurim_ovdim) IS
BEGIN
      DELETE TB_SIDURIM_OVDIM
      WHERE    mispar_ishi         = p_obj_sidurim_ovdim.mispar_ishi AND
               taarich             = trunc(p_obj_sidurim_ovdim.taarich) AND
               mispar_sidur        = p_obj_sidurim_ovdim.mispar_sidur AND
               shat_hatchala       = p_obj_sidurim_ovdim.shat_hatchala;

EXCEPTION
		 WHEN OTHERS THEN
		      RAISE;
END pro_del_sidur_oved;
PROCEDURE pro_ins_sidurim_ovdim_trail(p_obj_sidurim_ovdim in obj_sidurim_ovdim,p_sug_peula in trail_sidurim_ovdim.sug_peula%type) IS
BEGIN
    INSERT INTO TRAIL_SIDURIM_OVDIM (mispar_ishi,mispar_sidur,taarich,
                                    shat_hatchala,shat_gmar,shat_hatchala_letashlum,shat_gmar_letashlum,
                                    pitzul_hafsaka,chariga,tosefet_grira,hashlama,yom_visa,
                                    lo_letashlum,out_michsa,mikum_shaon_knisa,mikum_shaon_yetzia,
                                    achuz_knas_lepremyat_visa,achuz_viza_besikun,mispar_musach_o_machsan,
                                    kod_siba_lo_letashlum,kod_siba_ledivuch_yadani_in,kod_siba_ledivuch_yadani_out,
                                    meadken_acharon,taarich_idkun_acharon,heara,shayah_leyom_kodem,mispar_shiurey_nehiga,
                                    mispar_ishi_trail,taarich_idkun_trail,sug_peula,mezake_halbasha,mezake_nesiot,sector_visa,shat_hitiatzvut,sug_hashlama,
									menahel_musach_meadken,sug_hazmanat_visa,tafkid_visa,mivtza_visa,nidreshet_hitiatzvut,
									ptor_mehitiatzvut,hachtama_beatar_lo_takin,hafhatat_nochechut_visa   )
    SELECT mispar_ishi,mispar_sidur,taarich,
          shat_hatchala,shat_gmar,shat_hatchala_letashlum,shat_gmar_letashlum,
          pitzul_hafsaka,chariga,tosefet_grira,hashlama,yom_visa,
          lo_letashlum,out_michsa,mikum_shaon_knisa,mikum_shaon_yetzia,
          achuz_knas_lepremyat_visa,achuz_viza_besikun,mispar_musach_o_machsan,
          kod_siba_lo_letashlum,kod_siba_ledivuch_yadani_in,kod_siba_ledivuch_yadani_out,
          meadken_acharon,taarich_idkun_acharon,heara,shayah_leyom_kodem,mispar_shiurey_nehiga,
          -2,sysdate,p_sug_peula, mezake_halbasha,mezake_nesiot,sector_visa,shat_hitiatzvut,sug_hashlama,
		  menahel_musach_meadken,sug_hazmanat_visa,tafkid_visa,mivtza_visa,nidreshet_hitiatzvut ,
		  ptor_mehitiatzvut,hachtama_beatar_lo_takin ,hafhatat_nochechut_visa
    FROM TB_SIDURIM_OVDIM
    WHERE mispar_ishi  = p_obj_sidurim_ovdim.mispar_ishi    AND
         mispar_sidur  = p_obj_sidurim_ovdim.mispar_sidur   AND
         taarich       = trunc(p_obj_sidurim_ovdim.taarich) AND
         shat_hatchala = p_obj_sidurim_ovdim.shat_hatchala;
EXCEPTION
		 WHEN OTHERS THEN
		      RAISE;
END  pro_ins_sidurim_ovdim_trail;

PROCEDURE pro_upd_yom_avoda_oved(p_obj_yamey_avoda_ovdim in obj_yamey_avoda_ovdim) IS
BEGIN
     UPDATE TB_YAMEY_AVODA_OVDIM
     SET tachograf             = p_obj_yamey_avoda_ovdim.tachograf,
         halbasha              = p_obj_yamey_avoda_ovdim.halbasha,
         lina                  = p_obj_yamey_avoda_ovdim.lina,
         hashlama_leyom        = p_obj_yamey_avoda_ovdim.hashlama_leyom,
         bitul_zman_nesiot     = p_obj_yamey_avoda_ovdim.bitul_zman_nesiot,
         meadken_acharon       = p_obj_yamey_avoda_ovdim.meadken_acharon,
         zman_nesia_haloch     = p_obj_yamey_avoda_ovdim.zman_nesia_haloch,
         zman_nesia_hazor      = p_obj_yamey_avoda_ovdim.zman_nesia_hazor,
         sibat_hashlama_leyom  = p_obj_yamey_avoda_ovdim.sibat_hashlama_leyom,
         hamarat_shabat        = p_obj_yamey_avoda_ovdim.hamarat_shabat,
         taarich_idkun_acharon = sysdate
     WHERE mispar_ishi     = p_obj_yamey_avoda_ovdim.mispar_ishi AND
           taarich         = trunc(p_obj_yamey_avoda_ovdim.taarich);
EXCEPTION
		 WHEN OTHERS THEN
		      RAISE;
END pro_upd_yom_avoda_oved;

PROCEDURE pro_ins_yom_avoda_oved_trail(p_obj_yamey_avoda_ovdim in obj_yamey_avoda_ovdim) IS
BEGIN
    INSERT INTO TRAIL_YAMEY_AVODA_OVDIM(mispar_ishi,taarich,shat_hatchala,shat_siyum,
                                     tachograf,bitul_zman_nesiot,zman_nesia_haloch,
                                     zman_nesia_hazor,halbasha,lina,status,kod_histaygut_auto,
                                     measher_o_mistayeg,status_tipul,meadken_acharon,taarich_idkun_acharon,
                                     heara,hashlama_leyom,sibat_hashlama_leyom,mispar_ishi_trail,taarich_idkun_trail,
                                     sug_peula,ritzat_ishurim_acharona,shgiot_letezuga_laoved,
									 ritzat_shgiot_acharona,hamarat_shabat)
    SELECT mispar_ishi,taarich,shat_hatchala,shat_siyum,tachograf,bitul_zman_nesiot,
           zman_nesia_haloch,zman_nesia_hazor,halbasha,lina,status,kod_histaygut_auto,
           measher_o_mistayeg,status_tipul,meadken_acharon,
           taarich_idkun_acharon,heara,hashlama_leyom,sibat_hashlama_leyom,-2,sysdate,3,
		   ritzat_ishurim_acharona,shgiot_letezuga_laoved,
									 ritzat_shgiot_acharona,hamarat_shabat
    FROM TB_YAMEY_AVODA_OVDIM
    WHERE mispar_ishi   = p_obj_yamey_avoda_ovdim.mispar_ishi AND
          taarich       = trunc(p_obj_yamey_avoda_ovdim.taarich);

EXCEPTION
		 WHEN OTHERS THEN
		      RAISE;
END pro_ins_yom_avoda_oved_trail;


PROCEDURE pro_upd_peilut_oved(p_obj_peilut_ovdim in obj_peilut_ovdim)
IS
BEGIN
     UPDATE TB_PEILUT_OVDIM
     SET mispar_matala           = p_obj_peilut_ovdim.mispar_matala,
         makat_nesia             = p_obj_peilut_ovdim.makat_nesia,
         mispar_sidur            = p_obj_peilut_ovdim.new_mispar_sidur,
		 shat_yetzia             = p_obj_peilut_ovdim.new_shat_yetzia,
		 shat_hatchala_sidur     = p_obj_peilut_ovdim.new_shat_hatchala_sidur,
         taarich_idkun_acharon   = sysdate,
         meadken_acharon         = p_obj_peilut_ovdim.meadken_acharon,
		  mispar_visa = p_obj_peilut_ovdim.mispar_visa,
		  bitul_o_hosafa=p_obj_peilut_ovdim. bitul_o_hosafa
     WHERE mispar_ishi           = p_obj_peilut_ovdim.mispar_ishi AND
           taarich               = p_obj_peilut_ovdim.taarich AND
           mispar_sidur          = p_obj_peilut_ovdim.mispar_sidur AND
           shat_hatchala_sidur   = p_obj_peilut_ovdim.shat_hatchala_sidur AND
           shat_yetzia           = p_obj_peilut_ovdim.shat_yetzia AND
           mispar_knisa          = p_obj_peilut_ovdim.mispar_knisa;


    EXCEPTION
		 WHEN OTHERS THEN
		      RAISE;
END pro_upd_peilut_oved;


PROCEDURE pro_ins_peilut_ovdim_trail(p_obj_peilut_ovdim in obj_peilut_ovdim, p_sug_peula in trail_peilut_ovdim.sug_peula%type)
IS
BEGIN
    INSERT INTO TRAIL_PEILUT_OVDIM(mispar_ishi,taarich,mispar_sidur,
                                   shat_hatchala_sidur,shat_yetzia,mispar_knisa,
                                   makat_nesia,oto_no,mispar_siduri_oto,kisuy_tor,
                                   bitul_o_hosafa,kod_shinuy_premia,mispar_visa,imut_netzer,
                                   shat_bhirat_nesia_netzer,oto_no_netzer,mispar_sidur_netzer,
                                   shat_yetzia_netzer,makat_netzer,shilut_netzer,
                                   mikum_bhirat_nesia_netzer,mispar_matala,
                                   taarich_idkun_acharon,meadken_acharon,mispar_ishi_trail,
                                   taarich_idkun_trail,sug_peula,heara,snif_tnua,teur_nesia,dakot_bafoal ,km_visa)
    SELECT mispar_ishi,taarich,mispar_sidur,
           shat_hatchala_sidur,shat_yetzia,mispar_knisa,
           makat_nesia,oto_no,mispar_siduri_oto,kisuy_tor,
           bitul_o_hosafa,kod_shinuy_premia,mispar_visa,imut_netzer,
           shat_bhirat_nesia_netzer,oto_no_netzer,mispar_sidur_netzer,
           shat_yetzia_netzer,makat_netzer,shilut_netzer,
           mikum_bhirat_nesia_netzer,mispar_matala,
           taarich_idkun_acharon,meadken_acharon,-2,sysdate, p_sug_peula,
           heara,snif_tnua,teur_nesia,dakot_bafoal ,km_visa

    FROM TB_PEILUT_OVDIM
    WHERE mispar_ishi           = p_obj_peilut_ovdim.mispar_ishi         AND
          taarich               = trunc(p_obj_peilut_ovdim.taarich)      AND
          mispar_sidur          = p_obj_peilut_ovdim.mispar_sidur        AND
          shat_hatchala_sidur   = p_obj_peilut_ovdim.shat_hatchala_sidur AND
          shat_yetzia           = p_obj_peilut_ovdim.shat_yetzia         AND
          mispar_knisa          = p_obj_peilut_ovdim.mispar_knisa;

EXCEPTION
		 WHEN OTHERS THEN
		      RAISE;
END pro_ins_peilut_ovdim_trail;

PROCEDURE pro_del_peilut_oved(p_obj_peilut_ovdim in obj_peilut_ovdim) IS
BEGIN
      DELETE TB_PEILUT_OVDIM
      WHERE    mispar_ishi         = p_obj_peilut_ovdim.mispar_ishi AND
               taarich             = trunc(p_obj_peilut_ovdim.taarich) AND
               mispar_sidur        = p_obj_peilut_ovdim.mispar_sidur AND
               shat_hatchala_sidur = p_obj_peilut_ovdim.shat_hatchala_sidur AND
               shat_yetzia         = p_obj_peilut_ovdim.shat_yetzia AND
               mispar_knisa        = p_obj_peilut_ovdim.mispar_knisa AND
               makat_nesia         = p_obj_peilut_ovdim.makat_nesia;
END  pro_del_peilut_oved;
PROCEDURE pro_shinuy_kelet(p_coll_yamey_avoda_ovdim_upd in coll_yamey_avoda_ovdim,
                           p_coll_sidurim_ovdim_upd     in coll_sidurim_ovdim,
                           p_coll_sidurim_ovdim_ins     in coll_sidurim_ovdim,
                           p_coll_sidurim_ovdim_del     in coll_sidurim_ovdim,
                           p_coll_obj_peilut_ovdim_upd  in coll_obj_peilut_ovdim,
                           p_coll_obj_peilut_ovdim_ins  in coll_obj_peilut_ovdim,
                           p_coll_obj_peilut_ovdim_del  in coll_obj_peilut_ovdim) IS
BEGIN
    --  
   BEGIN
        pro_upd_yamey_avoda_ovdim(p_coll_yamey_avoda_ovdim_upd);
   EXCEPTION
		 WHEN OTHERS THEN
              raise_application_error(-20001,'An error was encountered in tb_yamey_avoda_ovdim - '||SQLCODE||' -ERROR- '||SQLERRM);

   END;
    -- 
    BEGIN
        pro_del_sidurim_ovdim(p_coll_sidurim_ovdim_del,2);
      EXCEPTION
		 WHEN OTHERS THEN
           raise_application_error(-20001,'An error was encountered in delete to tb_sidurim_ovdim - '||SQLCODE||' -ERROR- '||SQLERRM);
    END;
    --  
    BEGIN
        pro_ins_sidurim_ovdim(p_coll_sidurim_ovdim_ins);
      EXCEPTION
		 WHEN OTHERS THEN
		       raise_application_error(-20001,'An error was encountered in insert to tb_sidurim_ovdim - '||SQLCODE||' -ERROR- '||SQLERRM);
    END;
	 
	-- 
    BEGIN

        pro_del_peilut_ovdim(p_coll_obj_peilut_ovdim_del);
     EXCEPTION
		 WHEN OTHERS THEN
            raise_application_error(-20001,'An error was encountered in delete to tb_peiluyot_ovdim - '||SQLCODE||' -ERROR- '||SQLERRM);
    END;
	
	 -- 
    BEGIN
        pro_upd_peilut_ovdim(p_coll_obj_peilut_ovdim_upd);
       EXCEPTION
		 WHEN OTHERS THEN
		      raise_application_error(-20001,'An error was encountered in update to tb_peiluyot_ovdim - '||SQLCODE||' -ERROR- '||SQLERRM);
    END;
	
	  
    -- 
    BEGIN
        pro_upd_sidurim_ovdim(p_coll_sidurim_ovdim_upd);
      EXCEPTION
		 WHEN OTHERS THEN
            raise_application_error(-20001,'An error was encountered in update to tb_sidurim_ovdim - '||SQLCODE||' -ERROR- '||SQLERRM);
    END;
    -- 
    BEGIN
        pro_del_sidurim_ovdim(p_coll_sidurim_ovdim_del,0);
      EXCEPTION
		 WHEN OTHERS THEN
           raise_application_error(-20001,'An error was encountered in delete to tb_sidurim_ovdim - '||SQLCODE||' -ERROR- '||SQLERRM);
    END;

    -- 
    BEGIN
        pro_ins_peilut_ovdim(p_coll_obj_peilut_ovdim_ins);
     EXCEPTION
		 WHEN OTHERS THEN
             raise_application_error(-20001,'An error was encountered in insert to tb_peiluyot_ovdim - '||SQLCODE||' -ERROR- '||SQLERRM);
    END;



END pro_shinuy_kelet;

PROCEDURE pro_oved_update_fields(p_mispar_ishi in ovdim.mispar_ishi%type, p_date in date, p_cur out CurType)
IS
BEGIN
--Get maximun table/trail  last update
    open p_cur for
    select trunc(max_date) last_date, nvl(ovdim.SHEM_MISH || ' ' ||  ovdim.SHEM_PRAT ,'') full_name,MEADKEN_ACHARON
    from
        ovdim,
        (
            SELECT  TAARICH_IDKUN_ACHARON ,MEADKEN_ACHARON,
                    MAX(TAARICH_IDKUN_ACHARON) OVER (ORDER BY TAARICH_IDKUN_ACHARON desc) as max_date
            FROM
            (
                SELECT yo.TAARICH_IDKUN_ACHARON, yo.MEADKEN_ACHARON
                FROM tb_yamey_avoda_ovdim yo
                WHERE yo.MISPAR_ISHI= p_mispar_ishi
                AND yo.TAARICH = p_date

                UNION

                SELECT TAARICH_IDKUN_ACHARON ,MEADKEN_ACHARON
                FROM (
                  SELECT so.TAARICH_IDKUN_ACHARON ,so.MEADKEN_ACHARON,
                  MAX(TAARICH_IDKUN_ACHARON) OVER (PARTITION BY mispar_ishi,TAARICH) AS rmax_date
                  FROM tb_sidurim_ovdim so
                  WHERE so.MISPAR_ISHI= p_mispar_ishi
                        AND so.TAARICH = p_date)
                WHERE TAARICH_IDKUN_ACHARON = rmax_date

                UNION

                SELECT TAARICH_IDKUN_ACHARON ,MEADKEN_ACHARON
                FROM (
                  SELECT po.TAARICH_IDKUN_ACHARON ,po.MEADKEN_ACHARON,
                  MAX(TAARICH_IDKUN_ACHARON) OVER (PARTITION BY mispar_ishi,TAARICH) AS rmax_date
                  FROM tb_peilut_ovdim po
                  WHERE po.MISPAR_ISHI= p_mispar_ishi
                        AND po.TAARICH = p_date)
                WHERE TAARICH_IDKUN_ACHARON = rmax_date


            )
        ) tbLastUpdate
    WHERE tbLastUpdate.meadken_acharon= ovdim.MISPAR_ISHI(+);
        /*  union

      SELECT TAARICH_IDKUN_TRAIL ,MEADKEN_ACHARON
        FROM (
          SELECT a.TAARICH_IDKUN_TRAIL ,a.MEADKEN_ACHARON,
          MAX(TAARICH_IDKUN_TRAIL) OVER (PARTITION BY mispar_ishi,TAARICH) AS rmax_date
          FROM trail_yamey_avoda_ovdim a
          where a.MISPAR_ISHI= p_mispar_ishi
                and a.TAARICH = p_date)
        WHERE TAARICH_IDKUN_TRAIL = rmax_date


        union

        SELECT TAARICH_IDKUN_TRAIL ,MEADKEN_ACHARON
        FROM (
          SELECT a.TAARICH_IDKUN_TRAIL ,a.MEADKEN_ACHARON,
          MAX(TAARICH_IDKUN_TRAIL) OVER (PARTITION BY mispar_ishi,TAARICH) AS rmax_date
          FROM trail_sidurim_ovdim a
          where a.MISPAR_ISHI= p_mispar_ishi
                and a.TAARICH = p_date)
        WHERE TAARICH_IDKUN_TRAIL = rmax_date

        union

        SELECT FIRST_VALUE(TAARICH_IDKUN_TRAIL) OVER () as TAARICH_IDKUN_TRAIL
               ,MEADKEN_ACHARON
        FROM (
          SELECT (po.TAARICH_IDKUN_TRAIL) , po.MEADKEN_ACHARON, mispar_ishi,TAARICH,
          MAX(TAARICH_IDKUN_TRAIL) OVER () AS rmax_date
          FROM trail_peilut_ovdim po
          where po.MISPAR_ISHI= p_mispar_ishi
                and po.TAARICH = p_date)
        WHERE TAARICH_IDKUN_TRAIL = rmax_date)*/


EXCEPTION
		 WHEN OTHERS THEN
		      RAISE;
END pro_oved_update_fields;

PROCEDURE pro_upd_card_status(p_mispar_ishi in tb_yamey_avoda_ovdim.mispar_ishi%type,
                              p_card_date in tb_yamey_avoda_ovdim.taarich%type,
                              p_status in tb_yamey_avoda_ovdim.status%type,
							  p_user_id in tb_yamey_avoda_ovdim.meadken_acharon%type  ) IS
BEGIN
    UPDATE tb_yamey_avoda_ovdim
    SET status = p_status,
        taarich_idkun_acharon = sysdate ,
		meadken_acharon=p_user_id
    WHERE mispar_ishi = p_mispar_ishi AND taarich = p_card_date;
EXCEPTION
		 WHEN OTHERS THEN
		      RAISE;
END  pro_upd_card_status;

PROCEDURE pro_get_ctb_shgiot(p_error_code in ctb_shgiot.kod_shgia%type, p_cur out CurType) is
BEGIN
    OPEN p_cur FOR
    SELECT teur_shgia, kod_ishur
    FROM ctb_shgiot
    WHERE kod_shgia = p_error_code
          AND Pail = 1;

EXCEPTION
         WHEN OTHERS THEN
              RAISE;
END pro_get_ctb_shgiot;

PROCEDURE pro_ins_approval_errors(p_obj_shgiot_meusharot in obj_shgiot_meusharot ) IS
BEGIN
      -- Insert to tb_shgiot_meusharot
      INSERT INTO TB_SHGIOT_MEUSHAROT
                (mispar_ishi,
                 kod_shgia,
                 taarich,
                 mispar_sidur,
                 shat_hatchala,
                 shat_yetzia,
                 mispar_knisa,
                 gorem_measher,
                 taarich_ishur,
                 heara)

         VALUES (p_obj_shgiot_meusharot.mispar_ishi,
                 p_obj_shgiot_meusharot.kod_shgia,
                 p_obj_shgiot_meusharot.taarich,
                 p_obj_shgiot_meusharot.mispar_sidur,
                 p_obj_shgiot_meusharot.shat_hatchala,
                 p_obj_shgiot_meusharot.shat_yetzia,
                 p_obj_shgiot_meusharot.mispar_knisa,
                 p_obj_shgiot_meusharot.gorem_measher,
                 p_obj_shgiot_meusharot.taarich_ishur,
                 p_obj_shgiot_meusharot.heara);

EXCEPTION
         WHEN OTHERS THEN
              RAISE;
END pro_ins_approval_errors;
FUNCTION fn_is_approval_errors_exists(p_obj_shgiot_meusharot in obj_shgiot_meusharot, p_level in number) return number is
    iResult number;
BEGIN
    --Check if Error approval exists in tb_shgiot_meusharot
    --level 1- yom-avoda
    --level 2- sidur
    --level 3- peilut

    IF (p_level=1) THEN
        SELECT COUNT(kod_shgia) INTO iResult
        FROM TB_SHGIOT_MEUSHAROT S
        WHERE S.MISPAR_ISHI =  p_obj_shgiot_meusharot.mispar_ishi AND
              S.TAARICH     =  p_obj_shgiot_meusharot.taarich     AND
              S.KOD_SHGIA   =  p_obj_shgiot_meusharot.kod_shgia;
    END IF;


    IF (p_level=2) THEN
        SELECT COUNT(kod_shgia) INTO iResult
        FROM TB_SHGIOT_MEUSHAROT S
        WHERE S.MISPAR_ISHI   =  p_obj_shgiot_meusharot.mispar_ishi  AND
              S.TAARICH       =  p_obj_shgiot_meusharot.taarich      AND
              S.KOD_SHGIA     =  p_obj_shgiot_meusharot.kod_shgia    AND
              S.MISPAR_SIDUR  =  p_obj_shgiot_meusharot.mispar_sidur AND
              S.SHAT_HATCHALA =  p_obj_shgiot_meusharot.shat_hatchala;

    END IF;

     IF (p_level=3) THEN
        SELECT COUNT(kod_shgia) INTO iResult
        FROM TB_SHGIOT_MEUSHAROT S
        WHERE S.MISPAR_ISHI   =  p_obj_shgiot_meusharot.mispar_ishi   AND
              S.TAARICH       =  p_obj_shgiot_meusharot.taarich       AND
              S.KOD_SHGIA     =  p_obj_shgiot_meusharot.kod_shgia     AND
              S.MISPAR_SIDUR  =  p_obj_shgiot_meusharot.mispar_sidur  AND
              S.SHAT_HATCHALA =  p_obj_shgiot_meusharot.shat_hatchala AND
              S.SHAT_YETZIA   =  p_obj_shgiot_meusharot.shat_yetzia   AND
              S.MISPAR_KNISA  =  p_obj_shgiot_meusharot.mispar_knisa  ;

    END IF;
    return iResult;
EXCEPTION
         WHEN OTHERS THEN
              iResult:=0;
              RAISE;
END  fn_is_approval_errors_exists;
PROCEDURE pro_get_errors_for_field(p_field_name in ctb_shgiot.natun_lebdika%type,p_shgiot_leoved in number, p_cur out CurType) IS
BEGIN
    OPEN p_cur FOR
    SELECT S.KOD_SHGIA, s.TEUR_SHGIA, nvl(S.KOD_ISHUR,0) KOD_ISHUR, '' SHOW_ERROR, ('' || '|' ||  nvl(S.KOD_ISHUR,0) || '|' || S.KOD_SHGIA) ERR_KEY, nvl(S.ISHUR_RASHEMET,0) ISHUR_RASHEMET, '' USER_PROFILE
    FROM ctb_shgiot s
    WHERE UPPER(TRIM(S.NATUN_LEBDIKA)) = UPPER(TRIM(p_field_name))
     AND PAIL =1
     AND ((p_shgiot_leoved=1 and S.LETEZUGA_LAOVED=1) or (p_shgiot_leoved=0));
EXCEPTION
         WHEN OTHERS THEN
              RAISE;
END pro_get_errors_for_field;

PROCEDURE pro_upd_tar_ritzat_shgiot(p_mispar_ishi in tb_yamey_avoda_ovdim.mispar_ishi%type,
                              p_card_date in tb_yamey_avoda_ovdim.taarich%type,
							  p_shgiot_letzuga IN tb_yamey_avoda_ovdim.shgiot_letezuga_laoved%type) IS
BEGIN
    UPDATE tb_yamey_avoda_ovdim
    SET Ritzat_Shgiot_Acharona=sysdate,
	          shgiot_letezuga_laoved=p_shgiot_letzuga
    WHERE mispar_ishi = p_mispar_ishi
	AND taarich = p_card_date;
EXCEPTION
		 WHEN OTHERS THEN
		      RAISE;
END  pro_upd_tar_ritzat_shgiot;

PROCEDURE pro_is_duplicate_travel(p_mispar_ishi in tb_peilut_ovdim.mispar_ishi%type,
		 									  	 						 p_taarich  in tb_peilut_ovdim.taarich%type,
																		 p_makat_nesia in tb_peilut_ovdim.makat_nesia%type,
																		 p_shat_yetzia in tb_peilut_ovdim.shat_yetzia%type,
																		 p_mispar_knisa in tb_peilut_ovdim.mispar_knisa%type,
																		 p_Cur OUT CurType) IS
 BEGIN
     OPEN p_cur FOR
		   select y.mispar_ishi,y.taarich
		    from tb_peilut_ovdim p,tb_yamey_avoda_ovdim y
		    where p.mispar_ishi=y.mispar_ishi
		   and p.taarich=y.taarich
		   and (y.measher_o_mistayeg=0 or y.measher_o_mistayeg=1)
		   and p.mispar_ishi<>p_mispar_ishi
		  and p.taarich=trunc(p_taarich)
		  and p.makat_nesia= p_makat_nesia
		  and p.shat_yetzia=p_shat_yetzia
		  and p.mispar_knisa=p_mispar_knisa;

 EXCEPTION
         WHEN OTHERS THEN
		RAISE;

END pro_is_duplicate_travel;

PROCEDURE pro_have_sidur_chofef(p_mispar_ishi in tb_sidurim_ovdim.mispar_ishi%type,
		 									  	 						 p_taarich  in tb_sidurim_ovdim.taarich%type,
																		 p_mispar_sidur in tb_sidurim_ovdim.mispar_sidur%type,
																		 p_shat_hatchala in tb_sidurim_ovdim.shat_hatchala%type,
																		 p_shat_gmar in tb_sidurim_ovdim.shat_gmar%type,
																		 p_param_chafifa in number,
																		 p_Cur OUT CurType) IS
BEGIN
   OPEN p_cur FOR
		   select y.mispar_ishi,y.taarich
		   		from tb_sidurim_ovdim s,tb_yamey_avoda_ovdim y
				where s.mispar_ishi=y.mispar_ishi
				and s.taarich=y.taarich
		       and (y.measher_o_mistayeg=0 or y.measher_o_mistayeg=1)
				and s.mispar_ishi<>p_mispar_ishi
				and s.taarich=trunc(p_taarich)
				and s.mispar_sidur= p_mispar_sidur
				and (p_shat_hatchala<s.shat_gmar or p_shat_gmar>s.shat_hatchala )
				and ((s.shat_hatchala<=p_shat_hatchala and s.shat_gmar>=p_shat_gmar and  (p_shat_gmar-p_shat_hatchala)*1440>p_param_chafifa)
				or  (s.shat_gmar<p_shat_gmar and  (s.shat_gmar-p_shat_hatchala)*1440>p_param_chafifa)
				or  (s.shat_gmar>p_shat_gmar and  (p_shat_gmar-s.shat_hatchala)*1440>p_param_chafifa)
				or (s.shat_hatchala>p_shat_hatchala and s.shat_gmar<= p_shat_gmar  and (s.shat_gmar-s.shat_hatchala)*1440>p_param_chafifa));

 EXCEPTION
         WHEN OTHERS THEN
		RAISE;

END pro_have_sidur_chofef;

FUNCTION  fn_count_shgiot_letzuga(p_arr_Kod_Shgia IN VARCHAR2) return number
IS
    v_count number;
BEGIN
    v_count:=0;
		Select count(*) into v_count
		from CTB_SHGIOT
		where LETEZUGA_LAOVED = 1
		and kod_shgia in(select x from  table(cast(convert_string_to_table(p_arr_Kod_Shgia ,  ',') as mytabtype)));

         RETURN v_count;
EXCEPTION
        WHEN NO_DATA_FOUND THEN
             Return 0;
        WHEN OTHERS THEN
		RAISE;

END fn_count_shgiot_letzuga;

PROCEDURE get_idkuney_rashemet(p_mispar_ishi IN TB_idkun_rashemet.mispar_ishi%type,
		  										   							       p_taarich  IN TB_idkun_rashemet.taarich%type,
																				   p_Cur OUT CurType) as
  begin
      open p_Cur for
         select i.taarich,i.mispar_sidur,i.shat_hatchala,i.shat_yetzia,i.mispar_knisa,upper(m.shem_db) shem_db,i.pakad_id
		 from tb_idkun_rashemet i, tb_masach m
		 where m.masach_id=19
		 and m.sug=2
		 and m.pakad_id=i.pakad_id
		 and i.mispar_ishi=p_mispar_ishi
		 and i.taarich=p_taarich;

		   EXCEPTION
        WHEN OTHERS THEN
		RAISE;
  end get_idkuney_rashemet;

  PROCEDURE pro_check_have_sidur_grira(p_mispar_ishi in tb_sidurim_ovdim.mispar_ishi%type,
		 									  	 						 p_taarich  in tb_sidurim_ovdim.taarich%type,
																		 p_Cur OUT CurType) IS
 BEGIN
     OPEN p_cur FOR
		  select o.mispar_ishi, o.mispar_sidur,o.bitul_o_hosafa, o.shat_gmar, o.shat_hatchala, o.yom_visa,
           o.chariga,nvl(o.pitzul_hafsaka,0)pitzul_hafsaka,o.taarich,o.shayah_leyom_kodem,o.mispar_shiurey_nehiga,
           o.out_michsa ,
		   o.mikum_shaon_knisa,o.mikum_shaon_yetzia,o.mezake_halbasha,
           o.hashlama,o.lo_letashlum,
           o.kod_siba_ledivuch_yadani_in, o.kod_siba_ledivuch_yadani_out, o.kod_siba_lo_letashlum,
           o.shat_hatchala_letashlum, o.shat_gmar_letashlum,o.mezake_nesiot,
           o.tosefet_grira, o.achuz_knas_lepremyat_visa,o.achuz_viza_besikun,
           o.mispar_musach_o_machsan,o.sug_hazmanat_visa, o.sug_hashlama,
           o.heara, o.taarich_idkun_acharon, o.meadken_acharon,
           o.sector_visa, o.nidreshet_hitiatzvut, o.shat_hitiatzvut, o.ptor_mehitiatzvut,o.Hachtama_Beatar_Lo_Takin from 
			tb_sidurim_ovdim o,
			   tmp_sidurim_meyuchadim v_sidurm
			where o.mispar_ishi=p_mispar_ishi 
			and o.taarich=p_taarich
			and substr(o.mispar_sidur,0,2)='99'
			AND v_sidurm.mispar_sidur(+)=o.mispar_sidur
			 AND o.taarich between v_sidurm.me_tarich(+) and v_sidurm.ad_tarich(+)
			 and v_sidurm.sug_avoda=9;

 EXCEPTION
         WHEN OTHERS THEN
		RAISE;

END pro_check_have_sidur_grira;

PROCEDURE pro_get_shgiot_no_active( p_cur out CurType) is
BEGIN
    OPEN p_cur FOR
    SELECT kod_shgia
    FROM ctb_shgiot
    WHERE  Pail = 0;

EXCEPTION
         WHEN OTHERS THEN
              RAISE;
END pro_get_shgiot_no_active;
procedure pro_get_all_shgiot(p_cur out CurType) is
begin   
    OPEN p_cur FOR
    SELECT s.kod_shgia,s.teur_shgia,M.TEUR,s.letezuga_laoved
    FROM ctb_shgiot s,TB_MASACH m
    where upper(s.NATUN_LEBDIKA) = upper(m.SHEM_DB(+));
end pro_get_all_shgiot;

END PKG_ERRORS;
/
CREATE OR REPLACE PACKAGE PKG_OVDIM AS
/******************************************************************************
   NAME:       PKG_UTILS
   PURPOSE:

   REVISIONS:
   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        26/04/2009             1. Created this package.
******************************************************************************/

/*
Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        27/04/2009      sari       1. ????? ????? ????? ?????
*/
TYPE    CurType      IS    REF  CURSOR;
PROCEDURE pro_get_error_ovdim(p_kod_hevra in ctb_hevra.kod_hevra%type, p_kod_ezor in ctb_ezor.kod_ezor%type, p_kod_snif in ctb_snif_av.kod_snif_av%type, p_kod_maamad in ctb_maamad.kod_maamad_hr%type,
                              p_from_date in date, p_to_date in date,
                              p_cur OUT CurType);

PROCEDURE pro_get_oved_full_name(p_mispar_ishi in ovdim.mispar_ishi%type, p_full_name out ovdim.shem_mish%type);
PROCEDURE pro_get_ovedim_mispar_ishi(p_prefix in varchar2, p_misparim_range in varchar2, p_cur out CurType);
PROCEDURE pro_get_Active_Workers(p_prefix in varchar2, p_FromDate in date,p_ToDate in date , p_cur out CurType);
PROCEDURE pro_get_oved_errors_cards(p_mispar_ishi in ovdim.mispar_ishi%type,
		  										  	 						 		  p_from in tb_yamey_avoda_ovdim.taarich%type,
																					  p_to  in tb_yamey_avoda_ovdim.taarich%type,
																					  p_cur out CurType);
PROCEDURE pro_get_oved_details(p_mispar_ishi in ovdim.mispar_ishi%type,p_from_taarich in date, p_cur out CurType );
PROCEDURE pro_get_ovedim_by_name(p_prefix in varchar2, p_misparim_range in varchar2, p_cur out CurType);
PROCEDURE pro_get_oved_mispar_ishi(p_name in varchar2, p_mispar_ishi out ovdim.mispar_ishi%type);

PROCEDURE pro_get_pirtey_oved(p_mispar_ishi in ovdim.mispar_ishi%type, p_taarich in date, p_cur out CurType);

PROCEDURE pro_get_sug_chishuv(p_mispar_ishi in ovdim.mispar_ishi%type,
    		 				  p_taarich in date,
							  p_bakasha_id OUT tb_bakashot.bakasha_id%type,
							  p_sug_chishuv OUT number,
							  p_taarich_chishuv OUT DATE);

PROCEDURE pro_get_headruyot(p_cur out CurType);

PROCEDURE pro_get_pirtey_headrut(p_mispar_ishi in ovdim.mispar_ishi%type,
    						     p_taarich in date,
								 p_bakasha_id IN tb_bakashot.bakasha_id%type,
								 p_cur out CurType);

PROCEDURE pro_get_pirtey_headrut_tmp(p_mispar_ishi in ovdim.mispar_ishi%type,
    						     p_taarich in date,
								 p_bakasha_id IN tb_bakashot.bakasha_id%type,
								 p_cur out CurType);

PROCEDURE pro_get_rechivim_codshiyim(p_mispar_ishi in ovdim.mispar_ishi%type,
  								 	 p_taarich in date,
									 p_bakasha_id IN tb_bakashot.bakasha_id%type,
									 p_tzuga IN CTB_Rechivim.Letzuga_Besikum_Chodshi%type,
									 p_cur out CurType);
PROCEDURE pro_get_rechivim_codshiyim_tmp(p_mispar_ishi in ovdim.mispar_ishi%type,
  								 	 p_taarich in date,
									 p_bakasha_id IN tb_bakashot.bakasha_id%type,
									 p_tzuga IN CTB_Rechivim.Letzuga_Besikum_Chodshi%type,
									 p_cur out CurType);

PROCEDURE pro_get_rikuz_chodshi(p_mispar_ishi in ovdim.mispar_ishi%type,
							  	p_taarich in date,
     	 				        p_bakasha_id IN tb_bakashot.bakasha_id%type,
								p_tzuga IN CTB_Rechivim.Letzuga_Besikum_Chodshi%type,
								p_cur out CurType);

PROCEDURE pro_get_rikuz_chodshi_tmp(p_mispar_ishi in ovdim.mispar_ishi%type,
							  	p_taarich in date,
     	 				        p_bakasha_id IN tb_bakashot.bakasha_id%type,
								p_tzuga IN CTB_Rechivim.Letzuga_Besikum_Chodshi%type,
								p_cur out CurType);

PROCEDURE pro_get_rec_pirtey_oved(p_mispar_ishi in ovdim.mispar_ishi%type,
       							  p_taarich in date,
	    						  p_cur out CurType);

PROCEDURE pro_upd_premia_details(p_kod_premia in TRAIL_PREMYOT_YADANIYOT.SUG_PREMYA%type,
		  									  	 								p_mispar_ishi in TRAIL_PREMYOT_YADANIYOT.MISPAR_ISHI_TRAIL%type,
																				p_taarich in TRAIL_PREMYOT_YADANIYOT.TAARICH_IDKUN_TRAIL%type,
																				p_dakot_premia in TRAIL_PREMYOT_YADANIYOT.DAKOT_PREMYA%type,
																				p_mispar_ishi_of_meadken in TRAIL_PREMYOT_YADANIYOT.MISPAR_ISHI_TRAIL%type);

function fun_get_BakashaId(p_misparIshi in OVDIM.MISPAR_ISHI%type ,
                                         p_taarich in TB_CHISHUV_CHODESH_OVDIM.TAARICH%type )
                                         return TB_BAKASHOT.BAKASHA_ID%type;

FUNCTION fun_get_meafyen_oved(p_mispar_ishi in meafyenim_ovdim.mispar_ishi%type,
						 	  p_kod_meafyen  in meafyenim_ovdim.kod_meafyen%type,
							  p_taarich  in meafyenim_ovdim.me_taarich%type) return  meafyenim_ovdim.erech_ishi%type;

PROCEDURE pro_get_oved_snif_unit(p_mispar_ishi in ovdim.mispar_ishi%type, p_teur_snif out ctb_snif_av.teur_snif_av%type, p_teur_unit out ctb_yechida.teur_yechida%type);

PROCEDURE pro_get_oved_cards(p_mispar_ishi in ovdim.mispar_ishi%type,p_month in varchar2,p_cur out CurType);
PROCEDURE pro_get_oved_cards_in_tipul(p_mispar_ishi in ovdim.mispar_ishi%type,p_cur out CurType);


PROCEDURE pro_get_meafyeney_oved(p_mispar_ishi in meafyenim_ovdim.mispar_ishi%type,
		  									   	        p_taarich in meafyenim_ovdim.me_taarich%type,
														p_cur out CurType);
														
PROCEDURE pro_get_meafyeney_oved_all(p_mispar_ishi in meafyenim_ovdim.mispar_ishi%type,
		  									   	        p_me_taarich in meafyenim_ovdim.me_taarich%type,
														 p_ad_taarich in meafyenim_ovdim.me_taarich%type,
														p_brerat_Mechadal  in number,
														p_cur out CurType) ;
														
PROCEDURE pro_get_historiat_meafyen(p_mispar_ishi in meafyenim_ovdim.mispar_ishi%type,
														p_from_taarich in meafyenim_ovdim.me_taarich%type,
														p_Code_meafyen  in meafyenim_ovdim.KOD_MEAFYEN%type,
														p_cur out CurType) ;

PROCEDURE pro_get_month_year_to_oved(p_mispar_ishi in TB_Yamey_Avoda_Ovdim.mispar_ishi%type,
														p_cur out CurType);

PROCEDURE pro_get_status_oved(p_mispar_ishi in Matzav_Ovdim.mispar_ishi%type,
														p_cur out CurType);

 PROCEDURE pro_get_pirtey_oved_all(p_mispar_ishi in ovdim.mispar_ishi%type,
 		   										 						    p_taarich in date,
 		   									 							p_cur out CurType) ;
	PROCEDURE pro_get_historiat_natun(p_mispar_ishi in Pirtey_Ovdim.mispar_ishi%type,
														p_from_taarich in Pirtey_Ovdim.me_taarich%type,
														p_Code_natun  in Pirtey_Ovdim.KOD_NATUN%type,
														p_cur out CurType);

	 PROCEDURE pro_get_ritzot_chishuv(p_mispar_ishi in ovdim.mispar_ishi%type,
								 				p_taarich in date,
												p_cur out CurType);

 PROCEDURE pro_get_shaot_meal_michsa(p_mispar_ishi in ovdim.mispar_ishi%type,
 		   										 						  p_taarich in date,
																		  p_bakasha in tb_Chishuv_chodesh_Ovdim.Bakasha_ID%type,
 		   									 							p_cur out CurType) ;

  PROCEDURE pro_ins_bakasha_mechutz_lemich(p_mispar_ishi  in tb_bakashot_michutz_lamichsa.mispar_ishi%type,
																			  p_taarich  in tb_bakashot_michutz_lamichsa.taarich%type,
																			  p_shaot  in tb_bakashot_michutz_lamichsa.mevukash%type,
																			  p_siba  in tb_bakashot_michutz_lamichsa.sibat_habakasha%type,
																			  p_user_id   in tb_bakashot_michutz_lamichsa.mispar_ishi%type);



procedure pro_get_Hour_Approval(p_TypeDemand INTEGER,
                                                             p_mispar_ishi in ovdim.mispar_ishi% TYPE,
                                                             p_Month VARCHAR2,
                                                             p_StatusIsuk integer,
                                                             p_Filter in VARCHAR2,
                                                             p_cur out CurType);

procedure pro_getRelevantMonthOfApproval(p_mispar_ishi in ovdim.mispar_ishi% TYPE,
                                                             p_cur out CurType);
procedure pro_upd_Hour_Aproval(p_Bakasha_ID  in number ,
                                                    p_kod_status_ishur in number ,  p_MISPAR_ISHI IN  TB_ISHURIM.MISPAR_ISHI% type, 
                                                    p_KOD_ISHUR IN  TB_ISHURIM.kod_ishur% type,
                                                    p_TAARICH IN  TB_ISHURIM.TAARICH%type, 
                                                    p_MISPAR_SIDUR IN  TB_ISHURIM.MISPAR_SIDUR%type, 
                                                    p_SHAT_HATCHALA IN  TB_ISHURIM.SHAT_HATCHALA%type, 
                                                    p_SHAT_YETZIA IN  TB_ISHURIM.SHAT_YETZIA%type, 
                                                    p_MISPAR_KNISA IN  TB_ISHURIM.MISPAR_KNISA%type, 
                                                    p_RAMA IN  TB_ISHURIM.RAMA%type, 
                                                    p_ERECH_MEUSHAR IN  TB_ISHURIM.ERECH_MEUSHAR%type, 
                                                    p_ERECH_MEVUKASH IN TB_ISHURIM.ERECH_MEVUKASH%type ,
                                                    P_SIBA IN TB_ISHURIM.SIBA%type ,
                                                    P_MAINFACTOR NUMBER, 
                                                    P_SECONDARYFACTOR NUMBER ,
                                                    p_Result out INTEGER) ;
  
PROCEDURE pro_get_SharedMonthly_Quota(p_mispar_ishi in ovdim.mispar_ishi% TYPE,p_Period in VARCHAR2,p_Quota OUT TB_MICHSA_AGAPIT .MICHSA_AGAPIT%type,p_SharedQuota out INTEGER) ;

PROCEDURE pro_get_Status_Isuk(p_mispar_ishi in ovdim.mispar_ishi% TYPE,p_Form in INTEGER, p_Month VARCHAR2,p_Result OUT INTEGER);


PROCEDURE pro_get_tmp_pirtey_oved(p_mispar_ishi in ovdim.mispar_ishi%type, p_taarich in date,
 		   									 							p_cur out CurType) ;

FUNCTION fun_get_sug_yechida_oved(p_mispar_ishi in ovdim.mispar_ishi%type,
														p_taarich  in tmp_Pirtey_Ovdim.me_tarich%type) return ctb_yechida.SUG_YECHIDA%type;

PROCEDURE pro_get_merkaz_erua_ByKod(p_mispar_ishi in pirtey_ovdim.mispar_ishi%type,
                                   p_kod_natun in pirtey_ovdim.kod_natun%type,
								      p_taarich in pirtey_ovdim.ME_TAARICH%type,
                                   P_erech out pirtey_ovdim.erech%type);

PROCEDURE pro_get_mikum_shaon_in_out(p_mispar_ishi in TB_SIDURIM_OVDIM.mispar_ishi%type,
                                   p_taarich in date ,
                                   p_mikum_shaon_knisa  out integer   ,
                                   p_mikum_shaon_yetzia out integer) ;


PROCEDURE pro_get_zman_nesiaa_mistane (p_merkaz_erua in CTB_ZMAN_NSIAA_MISHTANE.MERKAZ_ERUA%type,
                                       p_mikum_yaad  in CTB_ZMAN_NSIAA_MISHTANE.MIKUM_YAAD%type,
                                       p_taarich in date ,
                                       p_dakot   out integer) ;

PROCEDURE pro_get_zman_nesiaa_ovdim (p_mispar_ishi in TB_YAMEY_AVODA_OVDIM.mispar_ishi%type,
                                     p_taarich in date ,
                                     p_zman_nesia_haloch  out integer   ,
                                     p_zman_nesia_hazor   out integer)  ;

PROCEDURE pro_upd_zman_nesiaa (p_mispar_ishi in TB_YAMEY_AVODA_OVDIM.mispar_ishi%type,
                                     p_taarich in date ,
                                     p_zman_nesia_haloch  in integer   ,
                                     p_zman_nesia_hazor   in integer) ;

PROCEDURE pro_get_last_updator (p_mispar_ishi in TB_YAMEY_AVODA_OVDIM.mispar_ishi%type,
                                p_taarich in date ,
                                p_cur out CurType) ;


PROCEDURE pro_get_RECHIVIM(   p_cur OUT CurType) ;

PROCEDURE pro_get_months_huavar_lesachar(p_mispar_ishi in TB_Yamey_Avoda_Ovdim.mispar_ishi%type,
														p_cur out CurType);

PROCEDURE pro_save_employee_card(p_coll_yamey_avoda_ovdim in coll_yamey_avoda_ovdim,
                                 p_coll_sidurim_ovdim_upd in coll_sidurim_ovdim,
                                 p_coll_obj_peilut_ovdim  in coll_obj_peilut_ovdim,
                                 p_coll_sidurim_ovdim_ins in coll_sidurim_ovdim,
                                 p_coll_sidurim_ovdim_del in coll_sidurim_ovdim,
                                 p_coll_idkun_rashemet in coll_idkun_rashemet );

PROCEDURE pro_upd_peilut_ovdim(p_coll_obj_peilut_ovdim in coll_obj_peilut_ovdim);
PROCEDURE pro_upd_peilut_oved(p_obj_peilut_ovdim in obj_peilut_ovdim);
PROCEDURE pro_ins_peilut_ovdim_trail(p_obj_peilut_ovdim in obj_peilut_ovdim, p_sug_peula in trail_peilut_ovdim.sug_peula%type);
PROCEDURE pro_upd_sidurim_ovdim(p_coll_sidurim_ovdim in COLL_SIDURIM_OVDIM);
PROCEDURE pro_upd_sidur_oved(p_obj_sidurim_ovdim in obj_sidurim_ovdim);
PROCEDURE pro_upd_tb_sidur_oved(p_obj_sidurim_ovdim in obj_sidurim_ovdim);
PROCEDURE pro_ins_sidurim_ovdim_trail(p_obj_sidurim_ovdim in obj_sidurim_ovdim,p_sug_peula in trail_sidurim_ovdim.sug_peula%type);

PROCEDURE pro_ins_yemey_avoda_leoved(p_mispar_ishi in tb_yamey_avoda_ovdim.mispar_ishi%type,
																	p_taarich in tb_yamey_avoda_ovdim.taarich%type,
																	p_measher_mistayeg in tb_yamey_avoda_ovdim.measher_o_mistayeg%type,
																	p_status in tb_yamey_avoda_ovdim.status_tipul%type,
																	p_meadken in tb_yamey_avoda_ovdim.meadken_acharon%type);

FUNCTION fun_get_count_yemey_avoda(p_mispar_ishi in  tb_yamey_avoda_ovdim.mispar_ishi%type,
														p_taarich_me  in  tb_yamey_avoda_ovdim.TAARICH%type,
														p_taarich_ad  in  tb_yamey_avoda_ovdim.TAARICH%type) return number;

PROCEDURE  pro_get_MisparIshiByKodVeErech (p_kod_Natun in integer  ,
  			 					   				   			  	                p_Erech in varchar2,
																				p_Taarich in date,
																				p_preFix in varchar2,
																				p_cur out CurType) ;

PROCEDURE pro_get_peiluyot_le_oved(p_mispar_ishi in  integer,
		  										 	 		 		 		  	  p_taarich in  TB_PEILUT_OVDIM.TAARICH%type,
																					  p_mispar_sidur in  integer,
																					p_shat_hatchala in  TB_PEILUT_OVDIM.SHAT_HATCHALA_SIDUR%type,
																					p_cur out CurType) ;
PROCEDURE pro_upd_yamey_avoda_ovdim(p_coll_yamey_avoda_ovdim in coll_yamey_avoda_ovdim);
PROCEDURE pro_upd_sadot_nosafim(p_coll_yamey_avoda_ovdim in coll_yamey_avoda_ovdim,
		  												 	p_coll_sidurim_ovdim in coll_sidurim_ovdim,
															p_coll_obj_peilut_ovdim in coll_obj_peilut_ovdim) ;
PROCEDURE pro_upd_yom_avoda_oved(p_obj_yamey_avoda_ovdim in obj_yamey_avoda_ovdim);
PROCEDURE pro_ins_idkuney_rashemet(p_coll_idkun_rashemet in coll_idkun_rashemet);
PROCEDURE pro_ins_idkun_rashemet(p_obj_idkun_rashemet in obj_idkun_rashemet);
PROCEDURE pro_upd_idkun_rashemet(p_obj_idkun_rashemet in obj_idkun_rashemet);
PROCEDURE pro_upd_idkun_rashemet_peilut(p_obj_idkun_rashemet in obj_idkun_rashemet);
PROCEDURE pro_get_pirtey_hitkashrut_oved(p_mispar_ishi in ovdim.mispar_ishi%type,
 		   									 							p_cur out CurType) ;
PROCEDURE pro_get_idkuney_rashemet(p_mispar_ishi in ovdim.mispar_ishi%type,p_taarich in tb_yamey_avoda_ovdim.taarich%type,p_cur out CurType);
PROCEDURE pro_get_meadken_acharon(p_mispar_ishi in ovdim.mispar_ishi%type,p_date in tb_yamey_avoda_ovdim.taarich%type,p_cur out CurType);
PROCEDURE pro_update_measher_o_mistayeg(p_mispar_ishi in ovdim.mispar_ishi%type,p_date in tb_yamey_avoda_ovdim.taarich%type, p_status in tb_yamey_avoda_ovdim.measher_o_mistayeg%type);
PROCEDURE pro_get_oved_details_betkufa(p_mispar_ishi in ovdim.mispar_ishi%type,
		  										p_start_date in date,p_end_date  in date, p_cur out CurType );
PROCEDURE	pro_get_ovdim_to_period_ByCode(p_code in  number,p_start_date in date,
												  	  					  	 	  		  			  p_end_date  in date, p_cur out CurType );
PROCEDURE pro_save_measher_O_mistayeg(p_mispar_ishi in ovdim.mispar_ishi%type,p_date in tb_yamey_avoda_ovdim.taarich%type,p_status number);
PROCEDURE pro_get_pakad_id(p_masach_id in tb_masach.masach_id%type,p_cur out CurType );
FUNCTION fun_is_card_exists_yemey_avoda(p_mispar_ishi in  tb_yamey_avoda_ovdim.mispar_ishi%type,
                                        p_taarich  in  tb_yamey_avoda_ovdim.TAARICH%type) return number;
 
FUNCTION fun_check_peilut_exist(p_mispar_sidur in tb_peilut_ovdim.mispar_sidur%type,
		 									   	  					  p_mispar_ishi in  tb_peilut_ovdim.mispar_ishi%type,
		 									  						  p_shat_hatchala in  tb_peilut_ovdim.shat_hatchala_sidur%type,
											 						  p_shat_yezia in  tb_peilut_ovdim.shat_yetzia%type ) return number;     
 FUNCTION	fun_check_sidur_exist(p_mispar_sidur in tb_sidurim_ovdim.mispar_sidur%type,
 												 		               p_mispar_ishi in  tb_sidurim_ovdim.mispar_ishi%type,
		 									                           p_shat_hatchala in  tb_sidurim_ovdim.shat_hatchala%type ) return number;   
																	   
PROCEDURE pro_del_knisot_peilut( p_mispar_ishi in  tb_peilut_ovdim.mispar_ishi%type,
		 									 p_mispar_sidur in tb_peilut_ovdim.mispar_sidur%type,
											 p_taarich in  tb_peilut_ovdim.taarich%type,
		 									   p_shat_hatchala in  tb_peilut_ovdim.shat_hatchala_sidur%type,
											 p_shat_yezia in  tb_peilut_ovdim.shat_yetzia%type,
											 p_makat_nesia in  tb_peilut_ovdim.makat_nesia%type);
	
	           
PROCEDURE pro_del_hachanot_mechona( p_mispar_ishi in  tb_peilut_ovdim.mispar_ishi%type,
		 									 p_mispar_sidur in tb_peilut_ovdim.mispar_sidur%type,
											 p_taarich in  tb_peilut_ovdim.taarich%type,
		 									   p_shat_hatchala in  tb_peilut_ovdim.shat_hatchala_sidur%type);										 																                                                       

function func_get_mispar_tachana(p_mispar_ishi in  tb_peilut_ovdim.mispar_ishi%type,
                                     p_mispar_sidur in tb_peilut_ovdim.mispar_sidur%type,
                                     p_taarich in  tb_peilut_ovdim.taarich%type,
                                     p_shat_hatchala in  tb_peilut_ovdim.shat_hatchala_sidur%type) return varchar2;

PROCEDURE pro_get_arachim_by_misIshi( p_mispar_ishi in  pirtey_ovdim.mispar_ishi%type,
																				        p_taarich in pirtey_ovdim.me_taarich%type,
																	                    p_cur out CurType);					

function func_get_erech_by_kod_natun(p_mispar_ishi in  pirtey_ovdim.mispar_ishi%type,
										                                     p_kod_natun in pirtey_ovdim.kod_natun%type,
										                                     p_taarich in  pirtey_ovdim.me_taarich%type  ) return varchar2;																				 
END PKG_OVDIM;
/

CREATE OR REPLACE PACKAGE BODY          PKG_OVDIM AS
/******************************************************************************
   NAME:       PKG_OVDIM
   PURPOSE:

   REVISIONS:
   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        26/04/2009             1. Created this package.
******************************************************************************/

/*
Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        27/04/2009      vered       1. ????? ????? ????? ?????
*/

PROCEDURE pro_get_error_ovdim(p_kod_hevra in ctb_hevra.kod_hevra%type,p_kod_ezor in ctb_ezor.kod_ezor%type,
                              p_kod_snif in ctb_snif_av.kod_snif_av%type, p_kod_maamad in ctb_maamad.kod_maamad_hr%type,
                              p_from_date in date, p_to_date in date,
                              p_cur OUT CurType) IS
BEGIN

     open p_cur for
	 	  select distinct  v.mispar_ishi , o.shem_mish || ' ' ||  o.shem_prat full_name ,to_char(v.mispar_ishi ) mispar_ishi_char,
					    v.SNIF_AV ,v.ME_TARICH , v.AD_TARICH ,ez.teur_ezor, s.teur_snif_av,  ma.teur_maamad_hr,
					   decode(l.status_key ,1,'+','') status_key,
			           decode(l.status_tipul_key ,2,'+','') status_tipul_key
          from  tmp_Pirtey_Ovdim v,
	   	  	         (select po.mispar_ishi,max(po.ME_TARICH) me_taarich
					   from tmp_Pirtey_Ovdim PO
					   where po.isuk is not null
						     and (trunc(p_from_date) Between  po.ME_TARICH  and   nvl(po.ad_TARICH,to_date('01/01/9999' ,'dd/mm/yyyy'))
					 		  or    trunc(p_to_date) Between  po.ME_TARICH  and   nvl(po.ad_TARICH,to_date('01/01/9999' ,'dd/mm/yyyy'))
					  		  or   po.ME_TARICH>= trunc(p_from_date) and   nvl(po.ad_TARICH,to_date('01/01/9999' ,'dd/mm/yyyy'))<=  trunc(p_to_date) )
					  group by po.mispar_ishi) p,
					 (select distinct nvl(x.mispar_ishi, y.mispar_ishi  ) mispar_ishi ,x.status_key, y.status_tipul_key
					 from
							 (select  mispar_ishi, 1 status_key  from tb_yamey_avoda_ovdim
							   where taarich between  trunc(p_from_date)  and  trunc(p_to_date)
							       and status=0
								   and measher_o_mistayeg is not null
								    and measher_o_mistayeg <>2
							  group by mispar_ishi) x
						 full join
						 ( select mispar_ishi ,2 status_tipul_key  from TB_ISHURIM
							   where taarich between   trunc(p_from_date) and trunc(p_to_date)
							        and nvl(KOD_STATUS_ISHUR ,0) =0
							 group by mispar_ishi) y

							on x.mispar_ishi=y.mispar_ishi
							   )l,
	                ovdim o,
	                ctb_ezor ez,
	                ctb_snif_av s,
	                ctb_maamad ma
       where  v.mispar_ishi = p.mispar_ishi
	       and  v.me_tarich = p.me_taarich
	       and  v.mispar_ishi = o.mispar_ishi
		   and  v.mispar_ishi = l.mispar_ishi
		   and  ((p_kod_hevra is null) or (o.kod_hevra = p_kod_hevra))
           and  ((p_kod_snif is null )or (v.SNIF_AV =p_kod_snif))
           and  v.SNIF_AV = s.kod_snif_av(+)
	       and  (v.snif_av is null or o.kod_hevra = s.kod_hevra)
	       and  ((p_kod_maamad  is null) or (v.MAAMAD =p_kod_maamad ))
	       and  v.MAAMAD = ma.kod_maamad_hr(+)
	       and  (v.maamad is null or ma.kod_hevra  = o.kod_hevra)
	       and  v.ezor = ez.kod_ezor (+)
	       and  (v.ezor is null or  o.kod_hevra = ez.kod_hevra )
	       and  ((p_kod_ezor is null) or (v.ezor =p_kod_ezor))
	 order by mispar_ishi;

	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END pro_get_error_ovdim;

PROCEDURE pro_get_oved_full_name(p_mispar_ishi in ovdim.mispar_ishi%type, p_full_name out ovdim.shem_mish%type)
IS
    BEGIN
        select o.SHEM_MISH || ' ' || o.SHEM_PRAT FullName into p_full_name
        from ovdim o
        where o.mispar_ishi=p_mispar_ishi;
    EXCEPTION
        WHEN NO_DATA_FOUND THEN
            p_full_name:='';
        WHEN OTHERS THEN
            RAISE;
END  pro_get_oved_full_name;

PROCEDURE pro_get_ovedim_mispar_ishi(p_prefix in varchar2, p_misparim_range in varchar2, p_cur out CurType)
IS
    BEGIN
       --open p_cur for  select 75290 mispar_ishi ,'75290 (   )' FullName from dual ;
        if ((Length(p_misparim_range)>0) and p_misparim_range is not null ) then
            open p_cur for
            select  o.mispar_ishi ,o.mispar_ishi || ' (' || o.shem_mish || ' ' || o.shem_prat   || ')'  FullName
            from ovdim o
            where o.mispar_ishi in
                 (select x from table(cast(convert_string_to_table(p_misparim_range ,  ',') as mytabtype)))
                 and o.mispar_ishi like p_prefix;
        else
            open p_cur for
            select o.mispar_ishi ,o.mispar_ishi || ' (' || o.shem_mish || ' ' || o.shem_prat   || ')'  FullName
            from ovdim o
            where o.mispar_ishi like p_prefix
            order by o.mispar_ishi;
        end if;
   EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END  pro_get_ovedim_mispar_ishi;

PROCEDURE pro_get_Active_Workers(p_prefix in varchar2, p_FromDate in date,p_ToDate in date , p_cur out CurType) is
begin
open p_cur for
select distinct o.mispar_ishi ,o.mispar_ishi || ' (' || o.shem_mish || ' ' || o.shem_prat   || ')'  FullName
            from ovdim o inner join Matzav_Ovdim Mo on mo.mispar_ishi= o.mispar_ishi
Where mo.Kod_matzav in ('01','03','04','05','06','08','09' )
And
(
    (p_ToDate between mo.Taarich_hatchala and mo.Taarich_siyum )
    or
    (p_FromDate between mo.Taarich_hatchala and mo.Taarich_siyum )
    or
    (( mo.Taarich_hatchala <= p_FromDate )    and    ( p_ToDate <= mo.Taarich_siyum))
)
and mo.mispar_ishi like  p_prefix || '%'
order by to_char(o.mispar_ishi) asc ;

   EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END  pro_get_Active_Workers;


PROCEDURE pro_get_oved_errors_cards(p_mispar_ishi in ovdim.mispar_ishi%type,
		  										  	 						 		  p_from in tb_yamey_avoda_ovdim.taarich%type,
																					  p_to  in tb_yamey_avoda_ovdim.taarich%type,
																					  p_cur out CurType)
IS
    BEGIN
         open p_cur for
        select distinct aa.mispar_ishi, aa.Taarich, aa.Status, aa.measher_o_mistayeg,aa.status_tipul,
                to_char(aa.taarich,'d') Day,
                decode(aa.status,0,'+','') status_key,
                decode(aa.measher_o_mistayeg,0,decode(aa.status_tipul,2,'','+'),'') measher_o_mistayeg_key,
				k.KOD_STATUS_ISHUR,
				decode(k.KOD_STATUS_ISHUR,0,'+','') status_tipul_key  ,
                to_char(aa.Taarich,'dd/mm/yyyy') || ' ' || (case to_char(aa.taarich,'d') when '1' then ''
                                             when '2' then ''
                                             when '3' then ''
                                             when '4' then ''
                                             when '5' then ''
                                             when '6' then ''
                                             when '7' then '' end)  || ' ' || c.teur_yom teur_yom

         from tb_yamey_avoda_ovdim aa ,TB_ISHURIM k
		        , tb_yamim_meyuchadim b, ctb_sugey_yamim_meyuchadim c
         where aa.mispar_ishi = p_mispar_ishi --25225 -- 7951 --25225 --12147  --
		      and aa.taarich between  p_from and  p_to
		 	   and aa.mispar_ishi  = k.MISPAR_ISHI(+)
              and aa.taarich = b.taarich(+)
			   and aa.taarich = k.taarich(+)
               and b.sug_yom=c.sug_yom(+)
			   and (aa.status=0 or k.KOD_STATUS_ISHUR=0);
    EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END pro_get_oved_errors_cards;
/*
PROCEDURE pro_get_oved_errors_cards(p_mispar_ishi in ovdim.mispar_ishi%type, p_cur out CurType)
IS
    BEGIN
         open p_cur for
         select aa.mispar_ishi, aa.Taarich, aa.Status, aa.measher_o_mistayeg,aa.status_tipul,
                to_char(aa.taarich,'d') Day,
                decode(aa.status,0,'+','') status_key,
                decode(aa.measher_o_mistayeg,0,decode(aa.status_tipul,2,'','+'),'') measher_o_mistayeg_key,
                decode(aa.status_Tipul ,1,'+','') status_Tipul_key,
                to_char(aa.Taarich,'dd/mm/yyyy') || ' ' || (case to_char(aa.taarich,'d') when '1' then ''
                                             when '2' then ''
                                             when '3' then ''
                                             when '4' then ''
                                             when '5' then ''
                                             when '6' then ''
                                             when '7' then '' end)  || ' ' || c.teur_yom teur_yom

         from tb_yamey_avoda_ovdim aa,tb_yamim_meyuchadim b, ctb_sugey_yamim_meyuchadim c
         where aa.mispar_ishi =p_mispar_ishi
               and aa.taarich = b.taarich(+)
               and b.sug_yom=c.sug_yom(+)
               and (aa.status = 0 or aa.status_tipul=1 or (aa.measher_o_mistayeg=0 and (aa.status_tipul<>2 or aa.status_tipul is null)));
    EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END pro_get_oved_errors_cards;
*/
PROCEDURE pro_get_oved_details(p_mispar_ishi in ovdim.mispar_ishi%type,p_from_taarich in date,p_cur out CurType )
IS
BEGIN
        OPEN p_Cur FOR
        select o.shem_mish || ' ' || o.shem_prat full_name,
               s.teur_snif_av,s.kod_snif_av, ma.teur_maamad_hr,
               ma.kod_maamad_hr, ez.kod_ezor, ez.teur_ezor,
               ck.teur_isuk, ch.teur_hevra
        from  ovdim o,ctb_snif_av s,ctb_maamad ma,ctb_ezor ez, tmp_pirtey_ovdim  po,
              ctb_isuk ck, ctb_hevra ch
        where o.mispar_ishi= p_mispar_ishi and
              po.mispar_ishi= o.mispar_ishi and
              s.kod_hevra = ez.kod_hevra and
              s.kod_snif_av = po.snif_av and
              ma.kod_maamad_hr = po.maamad and
              ez.kod_ezor = s.ezor and
              ck.KOD_HEVRA = o.KOD_HEVRA and
              ck.KOD_ISUK = po.ISUK and
              ch.KOD_HEVRA =o.KOD_HEVRA and
              p_from_taarich between po.me_tarich and po.ad_tarich;

      /*  select o.shem_mish || ' ' || o.shem_prat full_name,
           s.teur_snif_av,s.kod_snif_av, ma.teur_maamad_hr,
           ma.kod_maamad_hr, ez.kod_ezor, ez.teur_ezor
        from  ovdim o,ctb_snif_av s,ctb_maamad ma,ctb_ezor ez
        where o.mispar_ishi= p_mispar_ishi and
              s.kod_hevra = ez.kod_hevra and
              s.kod_snif_av =(select kod_snif
                              from  viw_get_oved_maamad_snif vS
                              where vS.mispar_ishi=o.mispar_ishi and
                                    vS.ad_taarich = (select max(v2.ad_taarich)
                                                     from  viw_get_oved_maamad_snif  v2
                                                     where v2.mispar_ishi=vS.mispar_ishi
                                                           and v2.me_TAARICH<=p_last_taarich))

               and ma.kod_maamad_hr =(select kod_maamad
                                      from  viw_get_oved_maamad_snif vM
                                      where vM.mispar_ishi=o.mispar_ishi
                                           and vM.ad_taarich = (select max(v3.ad_taarich)
                                                                from  viw_get_oved_maamad_snif v3
                                                                where v3.mispar_ishi=vM.mispar_ishi
                                                                      and v3.me_TAARICH <= p_last_taarich))

            and ez.kod_ezor = s.ezor;*/

	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END pro_get_oved_details;

PROCEDURE pro_get_ovedim_by_name(p_prefix in varchar2, p_misparim_range in varchar2, p_cur out CurType)
IS
BEGIN
 if ((Length(p_misparim_range)>0) and p_misparim_range is not null ) then
    open p_cur for
    select o.shem_mish || ' ' ||  o.shem_prat  || ' (' || o.mispar_ishi || ')' Oved_Name
    from ovdim o
    where o.mispar_ishi in
         (select x from table(cast(convert_string_to_table(p_misparim_range ,  ',') as mytabtype)))
         and o.shem_mish || ' ' ||  o.shem_prat like p_prefix
    order by o.shem_mish,o.shem_prat;
  else
    open p_cur for
    select o.shem_mish || ' ' ||  o.shem_prat  || ' (' || o.mispar_ishi || ')' Oved_Name
    from ovdim o
    where o.shem_mish || ' ' ||  o.shem_prat like p_prefix
    order by o.shem_mish,o.shem_prat;
  end if;
END pro_get_ovedim_by_name;

PROCEDURE pro_get_oved_mispar_ishi(p_name in varchar2, p_mispar_ishi out ovdim.mispar_ishi%type)
IS
BEGIN
    select o.mispar_ishi into p_mispar_ishi
    from ovdim o
    where
          o.shem_mish || ' ' || o.shem_prat = p_name
		  and rownum=1;
EXCEPTION
        WHEN NO_DATA_FOUND THEN
            p_mispar_ishi:='';
        WHEN OTHERS THEN
            RAISE;

END  pro_get_oved_mispar_ishi;

   /*
Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        12/05/2009     sari      1.   
*/
 PROCEDURE pro_get_pirtey_oved(p_mispar_ishi in ovdim.mispar_ishi%type, p_taarich in date,
 		   									 							p_cur out CurType) IS
	v_date_from date;

BEGIN
	 v_date_from:=to_date('01/' || to_char(p_taarich,'mm/yyyy'),'dd/mm/yyyy');
    OPEN p_cur FOR
	      select o.mispar_ishi,o.shem_MISH,o.shem_prat, to_char(p_taarich,'mm/yyyy') month_year,o. Kod_Hevra,
        (select teur_maamad_hr from ctb_maamad where kod_maamad_hr=p.maamad and kod_hevra=o. Kod_Hevra) maamad,
		 (select teur_ezor from ctb_ezor where kod_ezor=p.ezor and kod_hevra=o. Kod_Hevra) ezor,
		  (select teur_snif_av from ctb_snif_av where kod_snif_av=p.snif_av and kod_hevra=o. Kod_Hevra) snif_av,
		    (select teur_snif_av from ctb_snif_av where kod_snif_av=p.tachanat_sachar and kod_hevra=o. Kod_Hevra) tachanat_sachar,
			  (select teur_isuk from ctb_isuk where kod_isuk=p.isuk and kod_hevra=o. Kod_Hevra) isuk,
			    (select teur_kod_gil from  ctb_kod_gil  where kod_gil_hr=p.gil) gil,p.tchilat_avoda
		 from  ovdim o ,
					  (select max( po.ME_TARICH) me_taarich
					   from tmp_Pirtey_Ovdim PO
					     where 	mispar_ishi=p_mispar_ishi
					  and (v_date_from Between  po.ME_TARICH  and   nvl(po.ad_TARICH,to_date('01/01/9999' ,'dd/mm/yyyy'))
					  or  trunc(p_taarich) Between  po.ME_TARICH  and   nvl(po.ad_TARICH,to_date('01/01/9999' ,'dd/mm/yyyy'))
					  or   po.ME_TARICH>=v_date_from and   nvl(po.ad_TARICH,to_date('01/01/9999' ,'dd/mm/yyyy'))<= trunc(p_taarich))) po,
						tmp_Pirtey_Ovdim p
			where p.mispar_ishi=p_mispar_ishi
			and  p.Mispar_Ishi=o.mispar_ishi
			and  po.ME_TAARICH= p.ME_TARICH;

EXCEPTION
       WHEN OTHERS THEN
            RAISE;

END  pro_get_pirtey_oved;


 /*
Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        13/05/2009     sari      1.           
*/
 PROCEDURE pro_get_sug_chishuv(p_mispar_ishi in ovdim.mispar_ishi%type,
								 				p_taarich in date,
											p_bakasha_id OUT tb_bakashot.bakasha_id%type,
											p_sug_chishuv OUT number,
											p_taarich_chishuv OUT DATE) IS
  v_count_bakashot number;
BEGIN
 	 	select count(b.BAKASHA_ID) into  v_count_bakashot
		from TB_Bakashot B
		where B.Huavra_Lesachar=1
        and exists (select bakasha_id from TB_Chishuv_Chodesh_Ovdim  C
				   	   			where    C.Bakasha_ID=B.Bakasha_ID
								And C.Mispar_Ishi =p_mispar_ishi
								and to_char(C.Taarich,'mm/yyyy') =to_char(p_taarich,'mm/yyyy'));

		if v_count_bakashot=1 then
		    p_sug_chishuv:=0;

			Select B.Bakasha_ID into p_bakasha_id
			from TB_Bakashot B
		   where B.Huavra_Lesachar=1
           and exists (select bakasha_id from TB_Chishuv_Chodesh_Ovdim  C
				   	   			where    C.Bakasha_ID=B.Bakasha_ID
								And C.Mispar_Ishi =p_mispar_ishi
								and to_char(C.Taarich,'mm/yyyy') =to_char(p_taarich,'mm/yyyy'));

	 elsif v_count_bakashot>1 then
	 	     p_sug_chishuv:=1;

			 Select Bakasha_ID into p_bakasha_id
			 From TB_Bakashot
			 Where  Taarich_Haavara_Lesachar =  (Select Max(Taarich_Haavara_Lesachar)
         	 	   							   		   								 From TB_Bakashot
        																		Where Bakasha_ID in  (Select Bakasha_ID
																									                            From TB_Chishuv_Chodesh_Ovdim
																									                           Where Mispar_Ishi =p_mispar_ishi
																																and to_char(Taarich,'mm/yyyy') =to_char(p_taarich,'mm/yyyy') )
																				and Huavra_Lesachar=1);

   else
   		p_sug_chishuv:=2;
	end if;


	Select trunc(Zman_Hatchala) into p_taarich_chishuv
		From TB_Bakashot
		Where Bakasha_ID= p_bakasha_id;

EXCEPTION
	WHEN NO_DATA_FOUND THEN
		  p_sug_chishuv:=2;
		  p_bakasha_id :=0;
		  p_taarich_chishuv:=sysdate;
     WHEN OTHERS THEN
            RAISE;

END  pro_get_sug_chishuv;


PROCEDURE pro_get_headruyot(p_cur out CurType) IS
BEGIN
	 OPEN  p_cur FOR
	 	   select TB_SIDURIM_MEYUCHADIM.MISPAR_SIDUR,  CTB_SIDURIM_MEYUCHADIM.TEUR_SIDUR_MEYCHAD, TB_SIDURIM_MEYUCHADIM.KOD_MEAFYEN, TB_SIDURIM_MEYUCHADIM.ERECH
		   from TB_SIDURIM_MEYUCHADIM
		   inner join CTB_SIDURIM_MEYUCHADIM
		   		 on CTB_SIDURIM_MEYUCHADIM.KOD_SIDUR_MEYUCHAD = TB_SIDURIM_MEYUCHADIM.MISPAR_SIDUR
		   where TB_SIDURIM_MEYUCHADIM.KOD_MEAFYEN in (53,6,7,8);

EXCEPTION
	 WHEN OTHERS THEN
            RAISE;
 END  pro_get_headruyot;

/*
Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        17/05/2009     sari      1.        
*/
 PROCEDURE pro_get_pirtey_headrut(p_mispar_ishi in ovdim.mispar_ishi%type,
 		   										p_taarich in date,
								 			p_bakasha_id IN tb_bakashot.bakasha_id%type,
											 p_cur out CurType) IS
BEGIN
 	 	OPEN  p_cur FOR
			  Select  Mispar_Ishi,Taarich,
						sum(case Kod_Rechiv when 66 then Erech_Rechiv else null end)   as  YEMEY_HEADRUT,
			             sum(case Kod_Rechiv  when 74 then Erech_Rechiv  else null end) as YEMEY_MILUIM ,
						 sum(case Kod_Rechiv when 64  then Erech_Rechiv else null end)   as  YEMEY_TEUNA,
			             sum(case Kod_Rechiv  when 67 then Erech_Rechiv  else null end) as CHOFESH_CHOVA  ,
						 sum(case Kod_Rechiv when 8 then Erech_Rechiv else null end)   as CHOFESH_ZCHUT ,
			             sum(case Kod_Rechiv  when 60 then Erech_Rechiv  else null end) as YEMEY_MACHALA,
						  sum(case Kod_Rechiv  when 61 then Erech_Rechiv  else null end)  as YOM_MACHALA_BODED,
			             sum(case Kod_Rechiv  when 56 then Erech_Rechiv  else null end) as YEMEY_EVEL  ,
						 sum(case Kod_Rechiv when 69 then Erech_Rechiv else null end)   as MACHALAT_BEN_ZUG ,
			             sum(case Kod_Rechiv  when 71 then Erech_Rechiv  else null end) as MACHALAT_YELED,
						  sum(case Kod_Rechiv  when 70 then Erech_Rechiv  else null end)  as MACHALAT_HORE,
						  sum(case Kod_Rechiv when 68 then Erech_Rechiv else null end)   as  TIPAT_CHALAV,
			             sum(case Kod_Rechiv  when 65 then Erech_Rechiv  else null end) as HERAYON ,
						 null HEADRUT_SCHIRIM
			From TB_Chishuv_Chodesh_Ovdim
			Where Mispar_Ishi=p_mispar_ishi
			and bakasha_id= p_bakasha_id
			and to_char(Taarich,'mm/yyyy') =to_char(p_taarich,'mm/yyyy')
			and Kod_Rechiv in (56,69,71,65,70,68,66,74,64,67,8,60,61)
			group by Mispar_Ishi,Taarich;

EXCEPTION
	 WHEN OTHERS THEN
            RAISE;
 END  pro_get_pirtey_headrut;

  PROCEDURE pro_get_pirtey_headrut_tmp(p_mispar_ishi in ovdim.mispar_ishi%type,
 		   										p_taarich in date,
								 			p_bakasha_id IN tb_bakashot.bakasha_id%type,
											 p_cur out CurType) IS
BEGIN
 	 	OPEN  p_cur FOR
			  Select  Mispar_Ishi,Taarich,
						sum(case Kod_Rechiv when 66 then Erech_Rechiv else null end)   as  YEMEY_HEADRUT,
			             sum(case Kod_Rechiv  when 74 then Erech_Rechiv  else null end) as YEMEY_MILUIM ,
						 sum(case Kod_Rechiv when 64  then Erech_Rechiv else null end)   as  YEMEY_TEUNA,
			             sum(case Kod_Rechiv  when 67 then Erech_Rechiv  else null end) as CHOFESH_CHOVA  ,
						 sum(case Kod_Rechiv when 8 then Erech_Rechiv else null end)   as CHOFESH_ZCHUT ,
			             sum(case Kod_Rechiv  when 60 then Erech_Rechiv  else null end) as YEMEY_MACHALA,
						  sum(case Kod_Rechiv  when 61 then Erech_Rechiv  else null end)  as YOM_MACHALA_BODED,
			             sum(case Kod_Rechiv  when 56 then Erech_Rechiv  else null end) as YEMEY_EVEL  ,
						 sum(case Kod_Rechiv when 69 then Erech_Rechiv else null end)   as MACHALAT_BEN_ZUG ,
			             sum(case Kod_Rechiv  when 71 then Erech_Rechiv  else null end) as MACHALAT_YELED,
						  sum(case Kod_Rechiv  when 70 then Erech_Rechiv  else null end)  as MACHALAT_HORE,
						  sum(case Kod_Rechiv when 68 then Erech_Rechiv else null end)   as  TIPAT_CHALAV,
			             sum(case Kod_Rechiv  when 65 then Erech_Rechiv  else null end) as HERAYON ,
						 null HEADRUT_SCHIRIM
			From TB_tmp_Chishuv_Chodesh_Ovdim
			Where Mispar_Ishi=p_mispar_ishi
			and bakasha_id= p_bakasha_id
			and to_char(Taarich,'mm/yyyy') =to_char(p_taarich,'mm/yyyy')
			and Kod_Rechiv in (56,69,71,65,70,68,66,74,64,67,8,60,61)
			group by Mispar_Ishi,Taarich;

EXCEPTION
	 WHEN OTHERS THEN
            RAISE;
 END  pro_get_pirtey_headrut_tmp;

  /*
Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        17/05/2009     sari      1.    
*/
  PROCEDURE pro_get_rechivim_codshiyim(p_mispar_ishi in ovdim.mispar_ishi%type,
  													 								  		p_taarich in date,
																			 				p_bakasha_id IN tb_bakashot.bakasha_id%type,
																							p_tzuga IN CTB_Rechivim.Letzuga_Besikum_Chodshi%type,
																						 p_cur out CurType) IS
BEGIN
 	 	OPEN  p_cur FOR
			  Select R.Kod_Rechiv,R.Teur_Rechiv, Ch.Erech_Rechiv, R.MIYUN_BESIKUM_CHODSHI,R.Letzuga_Besikum_Chodshi,r.LETZUGA_BETIHKUR_RASHEMET
			From CTB_Rechivim R, TB_Chishuv_Chodesh_Ovdim Ch
			Where R.Kod_Rechiv=Ch.Kod_Rechiv
			and decode(p_tzuga,1,R.Letzuga_Besikum_Chodshi,r.LETZUGA_BETIHKUR_RASHEMET)=2
			and Ch.Mispar_Ishi=p_mispar_ishi
			and ch.bakasha_id=p_bakasha_id
			and to_char(ch.Taarich,'mm/yyyy') =to_char(p_taarich,'mm/yyyy')
			and Ch.Erech_Rechiv is not Null
			Order by R.MIYUN_BESIKUM_CHODSHI asc;

EXCEPTION
	 WHEN OTHERS THEN
            RAISE;

END  pro_get_rechivim_codshiyim;

 PROCEDURE pro_get_rechivim_codshiyim_tmp(p_mispar_ishi in ovdim.mispar_ishi%type,
  													 								  		p_taarich in date,
																			 				p_bakasha_id IN tb_bakashot.bakasha_id%type,
																							p_tzuga IN CTB_Rechivim.Letzuga_Besikum_Chodshi%type,
																						 p_cur out CurType) IS
BEGIN
 	 	OPEN  p_cur FOR
			  Select R.Kod_Rechiv,R.Teur_Rechiv, Ch.Erech_Rechiv, R.MIYUN_BESIKUM_CHODSHI,R.Letzuga_Besikum_Chodshi,r.LETZUGA_BETIHKUR_RASHEMET
			From CTB_Rechivim R, TB_tmp_Chishuv_Chodesh_Ovdim Ch
			Where R.Kod_Rechiv=Ch.Kod_Rechiv
			and decode(p_tzuga,1,R.Letzuga_Besikum_Chodshi,r.LETZUGA_BETIHKUR_RASHEMET)=2
			and Ch.Mispar_Ishi=p_mispar_ishi
			and ch.bakasha_id=p_bakasha_id
			and to_char(ch.Taarich,'mm/yyyy') =to_char(p_taarich,'mm/yyyy')
			and Ch.Erech_Rechiv is not Null
			Order by R.MIYUN_BESIKUM_CHODSHI asc;

EXCEPTION
	 WHEN OTHERS THEN
            RAISE;

END  pro_get_rechivim_codshiyim_tmp;

 /*
Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        18/05/2009     sari      1.     
*/
  PROCEDURE pro_get_rikuz_chodshi(p_mispar_ishi in ovdim.mispar_ishi%type,
  													 								  		p_taarich in date,
																			 				p_bakasha_id IN tb_bakashot.bakasha_id%type,
																							p_tzuga IN CTB_Rechivim.Letzuga_Besikum_Chodshi%type,
																						 p_cur out CurType) IS
			v_tar_me date;
			v_tar_ad date;
			str_dates varchar2(500);
	BEGIN
		  BEGIN
			         --     
					 v_tar_me:=to_date('01/' || to_char(p_taarich,'mm/yyyy'),'dd/mm/yyyy');

			         loop
						begin
						exit when  v_tar_me>p_taarich;
								str_dates:=str_dates || to_char(v_tar_me,'dd/mm/yyyy') || ',';
								 v_tar_me:= v_tar_me+1;
						end;
					 end loop;

					 str_dates:=substr(str_dates,0,length(str_dates)-1);
			END;

 	 OPEN  p_cur FOR
		select * from
		((select decode(tmp1.MIYUN_BESIKUM_CHODSHI,null,0,tmp1.MIYUN_BESIKUM_CHODSHI) MIYUN_BESIKUM_CHODSHI
				,tmp1.Teur_Rechiv, ' ' heara,decode(tmp1.Erech_Rechiv,null,0,tmp1.Erech_Rechiv) erech_rechiv, to_date(tmp2.x,'dd/mm/yyyy') Taarich,
							 to_number(to_char(decode(tmp1.Kod_Rechiv,null,0,tmp1.Kod_Rechiv))) Kod_Rechiv,
							 to_number(TO_CHAR(to_date(tmp2.x,'dd/mm/yyyy') ,'DD')) day_taarich ,
							 case  kod_rechiv
								     when 76 then (select y.erech_rechiv from TB_Chishuv_chodesh_Ovdim y
											Where y. Mispar_Ishi=p_mispar_ishi
											and  to_char(Taarich,'mm/yyyy') =to_char(p_taarich,'mm/yyyy')
											and y.Erech_Rechiv is not Null
											and y.Bakasha_ID=p_bakasha_id
											and y.kod_rechiv=119)
								 when 77 then (select y.erech_rechiv from TB_Chishuv_chodesh_Ovdim y
											Where y. Mispar_Ishi=p_mispar_ishi
												and  to_char(Taarich,'mm/yyyy') =to_char(p_taarich,'mm/yyyy')
											and y.Erech_Rechiv is not Null
											and y.Bakasha_ID=p_bakasha_id
											and y.kod_rechiv=120)
									 when 78 then (select y.erech_rechiv from TB_Chishuv_chodesh_Ovdim y
											Where y. Mispar_Ishi=p_mispar_ishi
												and  to_char(Taarich,'mm/yyyy') =to_char(p_taarich,'mm/yyyy')
											and y.Erech_Rechiv is not Null
											and y.Bakasha_ID=p_bakasha_id
											and y.kod_rechiv=121 )
									 when 1 then (select y.erech_rechiv from TB_Chishuv_chodesh_Ovdim y
											Where y. Mispar_Ishi=p_mispar_ishi
												and  to_char(Taarich,'mm/yyyy') =to_char(p_taarich,'mm/yyyy')
											and y.Erech_Rechiv is not Null
											and y.Bakasha_ID=p_bakasha_id
											and y.kod_rechiv=108 )
											else null end  as kizuz_meal_michsa
			  from
				(Select R.MIYUN_BESIKUM_CHODSHI,R.Teur_Rechiv, ' ' heara,C.Erech_Rechiv erech_rechiv,
						  c.Taarich,to_number(to_char(R.Kod_Rechiv)) Kod_Rechiv,to_number(TO_CHAR(c.Taarich,'DD')) day_taarich
							
						From CTB_Rechivim R, TB_Chishuv_Yomi_Ovdim C
						Where R.Kod_Rechiv=C.Kod_Rechiv
						and decode(p_tzuga,1,R.Letzuga_Besikum_Chodshi,r.LETZUGA_BETIHKUR_RASHEMET)=1
						and C. Mispar_Ishi=p_mispar_ishi
						and to_char(c.Taarich,'mm/yyyy') =to_char(p_taarich,'mm/yyyy')
						and C.Erech_Rechiv is not Null
						and C.Bakasha_ID=p_bakasha_id) tmp1,
			 			 table(cast(convert_string_to_table(str_dates ,  ',') as mytabtype)) tmp2
			where  to_date(tmp2.x,'dd/mm/yyyy')=tmp1.Taarich(+))
		union all
			   (SELECT 900 MIYUN_BESIKUM_CHODSHI, '' TEUR_RECHIV,'' heara,0 erech_rechiv,
	   		    Y.TAARICH,to_number(to_char(Y.KOD_RECHIV)) Kod_Rechiv,to_number(TO_CHAR(y.Taarich,'DD'))  day_taarich,
	   			null kizuz_meal_michsa
	          From matzav_Ovdim p, TB_Chishuv_Yomi_Ovdim y
				Where  p.Mispar_Ishi=p_mispar_ishi
			   and to_char(y.Taarich,'mm/yyyy') =to_char(p_taarich,'mm/yyyy')
					and y.TAARICH between p.taarich_hatchala and p.taarich_siyum
				and  p.Kod_matzav='33')
		union all
	   (SELECT 900 MIYUN_BESIKUM_CHODSHI, '' TEUR_RECHIV,max(H.HEARA) heara,0 erech_rechiv,
	   		    Y.TAARICH,-1 Kod_Rechiv,to_number(TO_CHAR(y.Taarich,'DD'))  day_taarich,
	   			null kizuz_meal_michsa
	   FROM (SELECT   Mispar_Ishi,Taarich,SYS_CONNECT_BY_PATH (kod_rechiv,'.') KOD_RECHIV
       		            FROM ( SELECT C. Mispar_Ishi,  C.Kod_Rechiv, c.Taarich,ROW_NUMBER () OVER (PARTITION BY c.Taarich ORDER BY c.kod_rechiv asc) RN
								          FROM TB_Chishuv_Yomi_Ovdim C,ctb_rechivim r
										  where  C.Bakasha_ID=p_bakasha_id
										  and C. Mispar_Ishi=p_mispar_ishi
										  and c.erech_rechiv>0
										  and r.yesh_heara=1
										  and r.kod_rechiv=c.kod_rechiv
										  and to_char(c.Taarich,'mm/yyyy') =to_char(p_taarich,'mm/yyyy') )
						    CONNECT BY Taarich = PRIOR Taarich AND RN = PRIOR RN + 1
						    START WITH RN = 1
						      ORDER BY Taarich) Y,
	 						 CTB_HEAROT_RECHIVIM H,
							 (Select count(Erech) Mutam_Bitachon
							From Pirtey_Ovdim
							Where  Mispar_Ishi=p_mispar_ishi
							and Me_taarich <=p_taarich
							and Ad_taarich>=p_taarich
							and Kod_Natun=9) M
	        WHERE H.KOD_RECHIV=substr(Y.KOD_RECHIV,2,length(Y.KOD_RECHIV)-1)
	       AND (M.MUTAM_BITACHON=H.MUTAM_BITACHON OR H.MUTAM_BITACHON IS NULL)
		   group by Y.TAARICH)
		    Order by MIYUN_BESIKUM_CHODSHI,Kod_Rechiv,Taarich asc);

EXCEPTION
	 WHEN OTHERS THEN
            RAISE;
END  pro_get_rikuz_chodshi;

PROCEDURE pro_get_rikuz_chodshi_tmp(p_mispar_ishi in ovdim.mispar_ishi%type,
  													 								  		p_taarich in date,
																			 				p_bakasha_id IN tb_bakashot.bakasha_id%type,
																							p_tzuga IN CTB_Rechivim.Letzuga_Besikum_Chodshi%type,
																						 p_cur out CurType) IS
			v_tar_me date;
			v_tar_ad date;
			str_dates varchar2(500);
	BEGIN
		  BEGIN
			         --     
					 v_tar_me:=to_date('01/' || to_char(p_taarich,'mm/yyyy'),'dd/mm/yyyy');

			         loop
						begin
						exit when  v_tar_me>p_taarich;
								str_dates:=str_dates || to_char(v_tar_me,'dd/mm/yyyy') || ',';
								 v_tar_me:= v_tar_me+1;
						end;
					 end loop;

					 str_dates:=substr(str_dates,0,length(str_dates)-1);
			END;

 	 OPEN  p_cur FOR
		select * from
		((select decode(tmp1.MIYUN_BESIKUM_CHODSHI,null,0,tmp1.MIYUN_BESIKUM_CHODSHI) MIYUN_BESIKUM_CHODSHI
				,tmp1.Teur_Rechiv, ' ' heara,decode(tmp1.Erech_Rechiv,null,0,tmp1.Erech_Rechiv) erech_rechiv, to_date(tmp2.x,'dd/mm/yyyy') Taarich,
							 to_number(to_char(decode(tmp1.Kod_Rechiv,null,0,tmp1.Kod_Rechiv))) Kod_Rechiv,
							 to_number(TO_CHAR(to_date(tmp2.x,'dd/mm/yyyy') ,'DD')) day_taarich ,
							  case  kod_rechiv
								     when 76 then (select y.erech_rechiv from TB_Chishuv_chodesh_Ovdim y
											Where y. Mispar_Ishi=p_mispar_ishi
											and  to_char(Taarich,'mm/yyyy') =to_char(p_taarich,'mm/yyyy')
											and y.Erech_Rechiv is not Null
											and y.Bakasha_ID=p_bakasha_id
											and y.kod_rechiv=119)
								 when 77 then (select y.erech_rechiv from TB_Chishuv_chodesh_Ovdim y
											Where y. Mispar_Ishi=p_mispar_ishi
												and  to_char(Taarich,'mm/yyyy') =to_char(p_taarich,'mm/yyyy')
											and y.Erech_Rechiv is not Null
											and y.Bakasha_ID=p_bakasha_id
											and y.kod_rechiv=120)
									 when 78 then (select y.erech_rechiv from TB_Chishuv_chodesh_Ovdim y
											Where y. Mispar_Ishi=p_mispar_ishi
												and  to_char(Taarich,'mm/yyyy') =to_char(p_taarich,'mm/yyyy')
											and y.Erech_Rechiv is not Null
											and y.Bakasha_ID=p_bakasha_id
											and y.kod_rechiv=121 )
									 when 1 then (select y.erech_rechiv from TB_Chishuv_chodesh_Ovdim y
											Where y. Mispar_Ishi=p_mispar_ishi
												and  to_char(Taarich,'mm/yyyy') =to_char(p_taarich,'mm/yyyy')
											and y.Erech_Rechiv is not Null
											and y.Bakasha_ID=p_bakasha_id
											and y.kod_rechiv=108 )
											else null end  as kizuz_meal_michsa
			  from
				(Select R.MIYUN_BESIKUM_CHODSHI,R.Teur_Rechiv, ' ' heara,C.Erech_Rechiv erech_rechiv,
						  c.Taarich,to_number(to_char(R.Kod_Rechiv)) Kod_Rechiv,to_number(TO_CHAR(c.Taarich,'DD')) day_taarich
						From CTB_Rechivim R, TB_tmp_Chishuv_Yomi_Ovdim C
						Where R.Kod_Rechiv=C.Kod_Rechiv
						and decode(p_tzuga,1,R.Letzuga_Besikum_Chodshi,r.LETZUGA_BETIHKUR_RASHEMET)=1
						and C. Mispar_Ishi=p_mispar_ishi
						and to_char(c.Taarich,'mm/yyyy') =to_char(p_taarich,'mm/yyyy')
						and C.Erech_Rechiv is not Null
						and C.Bakasha_ID=p_bakasha_id) tmp1,
			 			 table(cast(convert_string_to_table(str_dates ,  ',') as mytabtype)) tmp2
			where  to_date(tmp2.x,'dd/mm/yyyy')=tmp1.Taarich(+))
		union all
			   (SELECT 900 MIYUN_BESIKUM_CHODSHI, '' TEUR_RECHIV,'' heara,0 erech_rechiv,
	   		    Y.TAARICH,to_number(to_char(Y.KOD_RECHIV)) Kod_Rechiv,to_number(TO_CHAR(y.Taarich,'DD'))  day_taarich,
	   			null kizuz_meal_michsa
	          From matzav_Ovdim p, TB_tmp_Chishuv_Yomi_Ovdim y
				Where  p.Mispar_Ishi=p_mispar_ishi
			   and to_char(y.Taarich,'mm/yyyy') =to_char(p_taarich,'mm/yyyy')
					and y.TAARICH between p.taarich_hatchala and p.taarich_siyum
				and  p.Kod_matzav='33')
		union all
	   (SELECT 900 MIYUN_BESIKUM_CHODSHI, '' TEUR_RECHIV,max(H.HEARA) heara,0 erech_rechiv,
	   		    Y.TAARICH,-1 Kod_Rechiv,to_number(TO_CHAR(y.Taarich,'DD'))  day_taarich,
	   			null kizuz_meal_michsa
	   FROM (SELECT   Mispar_Ishi,Taarich,SYS_CONNECT_BY_PATH (kod_rechiv,'.') KOD_RECHIV
       		            FROM ( SELECT C. Mispar_Ishi,  C.Kod_Rechiv, c.Taarich,ROW_NUMBER () OVER (PARTITION BY c.Taarich ORDER BY c.kod_rechiv asc) RN
								          FROM TB_tmp_Chishuv_Yomi_Ovdim C,ctb_rechivim r
										  where  C.Bakasha_ID=p_bakasha_id
										  and C. Mispar_Ishi=p_mispar_ishi
										  and c.erech_rechiv>0
										  and r.yesh_heara=1
										  and r.kod_rechiv=c.kod_rechiv
										  and to_char(c.Taarich,'mm/yyyy') =to_char(p_taarich,'mm/yyyy'))
						    CONNECT BY Taarich = PRIOR Taarich AND RN = PRIOR RN + 1
						    START WITH RN = 1
						     ORDER BY Taarich) Y,
	 						 CTB_HEAROT_RECHIVIM H,
							 (Select count(Erech) Mutam_Bitachon
							From Pirtey_Ovdim
							Where  Mispar_Ishi=p_mispar_ishi
							and Me_taarich <=p_taarich
							and Ad_taarich>=p_taarich
							and Kod_Natun=9) M
	         WHERE H.KOD_RECHIV=substr(Y.KOD_RECHIV,2,length(Y.KOD_RECHIV)-1)
	       AND (M.MUTAM_BITACHON=H.MUTAM_BITACHON OR H.MUTAM_BITACHON IS NULL)
		   		    group by Y.TAARICH)
		    Order by MIYUN_BESIKUM_CHODSHI,Kod_Rechiv,Taarich asc);

EXCEPTION
	 WHEN OTHERS THEN
            RAISE;
END  pro_get_rikuz_chodshi_tmp;

PROCEDURE pro_get_rec_pirtey_oved(p_mispar_ishi in ovdim.mispar_ishi%type, p_taarich in date, p_cur out CurType)
IS
BEGIN
    OPEN p_cur FOR
		select distinct q1.erech yacha,q2.erech taarich_hatzava ,q3.erech ezor,q4.erech snif_av,q5.erech mikum,
		q6.erech isuk,q7.erech rishyon,q8.erech mutam,q9.erech mutam_bitachon,q10.erech erua,
		q11.erech dirug,q12.erech darga, q13.erech maamad, q14.erech gil, q15.erech tachanat_sachar,
		q17.erech misra,q18.erech revacha
from pirtey_ovdim q1,  pirtey_ovdim q2,  pirtey_ovdim q3,  pirtey_ovdim q4,  pirtey_ovdim q5,  pirtey_ovdim q6,
          pirtey_ovdim q7,  pirtey_ovdim q8, pirtey_ovdim q9,  pirtey_ovdim q10,pirtey_ovdim q11,pirtey_ovdim q12,
		  pirtey_ovdim q13,  pirtey_ovdim q14,  pirtey_ovdim q15,   pirtey_ovdim q17,  pirtey_ovdim q18
where q1.mispar_ishi(+)=p_mispar_ishi
and  q1.kod_natun(+)=1
 and q1.mispar_ishi(+)=q2.mispar_ishi
 and p_taarich between q1.me_taarich(+) and q1.ad_taarich(+)
and q2.mispar_ishi=p_mispar_ishi
and  q2.kod_natun=2
 and p_taarich between q2.me_taarich(+) and q2.ad_taarich(+)
and q3.mispar_ishi(+)=p_mispar_ishi
and  q3.kod_natun(+)=3
 and q3.mispar_ishi(+)=q2.mispar_ishi
 and p_taarich between q3.me_taarich(+) and q3.ad_taarich(+)
and q4.mispar_ishi(+)=p_mispar_ishi
and  q4.kod_natun(+)=4
 and q4.mispar_ishi(+)=q2.mispar_ishi
 and p_taarich between q4.me_taarich(+) and q4.ad_taarich(+)
and q5.mispar_ishi(+)=p_mispar_ishi
and  q5.kod_natun(+)=5
 and q5.mispar_ishi(+)=q2.mispar_ishi
 and p_taarich between q5.me_taarich(+) and q5.ad_taarich(+)
and q6.mispar_ishi(+)=p_mispar_ishi
and  q6.kod_natun(+)=6
 and q6.mispar_ishi(+)=q2.mispar_ishi
 and p_taarich between q6.me_taarich(+) and q6.ad_taarich(+)
and q7.mispar_ishi(+)=p_mispar_ishi
and  q7.kod_natun(+)=7
 and q7.mispar_ishi(+)=q2.mispar_ishi
 and p_taarich between q7.me_taarich(+) and q7.ad_taarich(+)
and q8.mispar_ishi(+)=p_mispar_ishi
and  q8.kod_natun(+)=8
 and q8.mispar_ishi(+)=q2.mispar_ishi
 and p_taarich between q8.me_taarich(+) and q8.ad_taarich(+)
and q9.mispar_ishi(+)=p_mispar_ishi
and  q9.kod_natun(+)=9
 and q9.mispar_ishi(+)=q2.mispar_ishi
 and p_taarich between q9.me_taarich(+) and q9.ad_taarich(+)
and q10.mispar_ishi(+)=p_mispar_ishi
and  q10.kod_natun(+)=10
 and q10.mispar_ishi(+)=q2.mispar_ishi
 and p_taarich between q10.me_taarich(+) and q10.ad_taarich(+)
and q11.mispar_ishi(+)=p_mispar_ishi
and  q11.kod_natun(+)=11
 and q11.mispar_ishi(+)=q2.mispar_ishi
 and p_taarich between q11.me_taarich(+) and q11.ad_taarich(+)
and q12.mispar_ishi(+)=p_mispar_ishi
and  q12.kod_natun(+)=12
 and q12.mispar_ishi(+)=q2.mispar_ishi
 and p_taarich between q12.me_taarich(+) and q12.ad_taarich(+)
and q13.mispar_ishi(+)=p_mispar_ishi
and  q13.kod_natun(+)=13
 and q13.mispar_ishi(+)=q2.mispar_ishi
 and p_taarich between q13.me_taarich(+) and q13.ad_taarich(+)
and q14.mispar_ishi(+)=p_mispar_ishi
and  q14.kod_natun(+)=14
 and q14.mispar_ishi(+)=q2.mispar_ishi
 and p_taarich between q14.me_taarich(+) and q14.ad_taarich(+)
and q15.mispar_ishi(+)=p_mispar_ishi
and  q15.kod_natun(+)=15
 and q15.mispar_ishi(+)=q2.mispar_ishi
 and p_taarich between q15.me_taarich(+) and q15.ad_taarich(+)
and q17.mispar_ishi(+)=p_mispar_ishi
and  q17.kod_natun(+)=17
 and q17.mispar_ishi(+)=q2.mispar_ishi
 and p_taarich between q17.me_taarich(+) and q17.ad_taarich(+)
and q18.mispar_ishi(+)=p_mispar_ishi
and  q18.kod_natun(+)=18
and q18.mispar_ishi(+)=q2.mispar_ishi
 and p_taarich between q18.me_taarich(+) and q18.ad_taarich(+);

EXCEPTION
       WHEN OTHERS THEN
            RAISE;

END  pro_get_rec_pirtey_oved;

PROCEDURE pro_upd_premia_details(p_kod_premia in TRAIL_PREMYOT_YADANIYOT.SUG_PREMYA%type,
		  									  	 								p_mispar_ishi in TRAIL_PREMYOT_YADANIYOT.MISPAR_ISHI_TRAIL%type,
																				p_taarich in TRAIL_PREMYOT_YADANIYOT.TAARICH_IDKUN_TRAIL%type,
																				p_dakot_premia in TRAIL_PREMYOT_YADANIYOT.DAKOT_PREMYA%type,
																				p_mispar_ishi_of_meadken in TRAIL_PREMYOT_YADANIYOT.MISPAR_ISHI_TRAIL%type)
IS
  meadken_acharon number;
  taarich_idkun_acharon date;
BEGIN

	 meadken_acharon:=0;
	  taarich_idkun_acharon:=null;

	select count(*)	 into meadken_acharon
	 from TB_Premyot_Yadaniyot
	 where MISPAR_ISHI = p_mispar_ishi
	      and TAARICH = p_taarich
		  and SUG_PREMYA = p_kod_premia;

	if meadken_acharon > 0 then
	 select MEADKEN_ACHARON, TAARICH_IDKUN_ACHARON
	 		    into meadken_acharon, taarich_idkun_acharon
	 from TB_Premyot_Yadaniyot
	 where MISPAR_ISHI = p_mispar_ishi
	     and TAARICH = p_taarich
		 and SUG_PREMYA = p_kod_premia;
    end if;

	if taarich_idkun_acharon is not null then
			    insert into TRAIL_PREMYOT_YADANIYOT(MISPAR_ISHI,TAARICH,SUG_PREMYA,DAKOT_PREMYA,TAARICH_IDKUN_ACHARON,MEADKEN_ACHARON,MISPAR_ISHI_TRAIL,TAARICH_IDKUN_TRAIL,SUG_PEULA)
				select MISPAR_ISHI,TAARICH,SUG_PREMYA,DAKOT_PREMYA,TAARICH_IDKUN_ACHARON,MEADKEN_ACHARON,p_mispar_ishi_of_meadken,sysdate,3 
			   from  TB_Premyot_Yadaniyot
			      where MISPAR_ISHI = p_mispar_ishi
			     and TAARICH = p_taarich
				 and SUG_PREMYA = p_kod_premia;
		 
			   update TB_Premyot_Yadaniyot
			   set DAKOT_PREMYA = p_dakot_premia,
			          MEADKEN_ACHARON = p_mispar_ishi_of_meadken,
					  TAARICH_IDKUN_ACHARON = sysdate
			   where MISPAR_ISHI = p_mispar_ishi
			     and TAARICH = p_taarich
				 and SUG_PREMYA = p_kod_premia;

		else
		insert into TB_Premyot_Yadaniyot(MISPAR_ISHI,TAARICH,SUG_PREMYA,DAKOT_PREMYA,TAARICH_IDKUN_ACHARON,MEADKEN_ACHARON)
		values(p_mispar_ishi,p_taarich,p_kod_premia,p_dakot_premia,sysdate,p_mispar_ishi_of_meadken);

		--insert into meafyenim_ovdim(MISPAR_ISHI,KOD_MEAFYEN,ME_TAARICH,AD_TAARICH,ERECH_ISHI)
		--values(p_mispar_ishi,p_kod_premia,p_taarich,to_date('4712/12/31', 'yyyy/mm/dd'),1);
	end if;

EXCEPTION
       WHEN OTHERS THEN
            RAISE;

END pro_upd_premia_details;


function fun_get_BakashaId(p_misparIshi in OVDIM.MISPAR_ISHI%type ,
                                         p_taarich in TB_CHISHUV_CHODESH_OVDIM.TAARICH%type )
                                         return TB_BAKASHOT.BAKASHA_ID%type as
        v_bakashaId TB_BAKASHOT.BAKASHA_ID%type ; 
        v_sug_chishuv number ;
        v_taarich_chishuv DATE;
begin
 v_bakashaId := 0 ;
 pro_get_sug_chishuv(p_misparIshi,p_taarich , v_bakashaId,v_sug_chishuv ,v_taarich_chishuv ) ;
return v_bakashaId;  
end fun_get_BakashaId;
                                          
                                         
/*
Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0       25/05/2009     sari      1.    
*/
FUNCTION fun_get_meafyen_oved(p_mispar_ishi in meafyenim_ovdim.mispar_ishi%type,
														p_kod_meafyen  in meafyenim_ovdim.kod_meafyen%type,
														p_taarich  in meafyenim_ovdim.me_taarich%type) return meafyenim_ovdim.erech_ishi%type as
	v_erech meafyenim_ovdim.erech_ishi%type;
begin
	begin

		select decode(m.erech_ishi,null,m.ERECH_MECHDAL_PARTANY,m.erech_ishi) into v_erech
		   from tmp_meafyenim_Ovdim m
		   where trunc(p_taarich) between m.ME_TAARICH and nvl(m.AD_TAARICH,to_date('01/01/9999','dd/mm/yyyy'))
		   and m.MISPAR_ISHI=p_mispar_ishi
			and m.kod_meafyen=p_kod_meafyen;

		 EXCEPTION
	       WHEN NO_DATA_FOUND THEN
		   		 v_erech:='-1';
	end;
	     if  v_erech='-1' then
				       select  m.erech  into v_erech
				   		from BREROT_MECHDAL_MEAFYENIM m
				   		where trunc(p_taarich) between m.ME_TAARICH and nvl(m.AD_TAARICH,to_date('01/01/9999','dd/mm/yyyy'))
						and m.kod_meafyen=p_kod_meafyen;
		end if;
     return v_erech;
end   fun_get_meafyen_oved;

PROCEDURE pro_get_ovedim_mispar_ishi(p_prefix in varchar2, p_cur out CurType) is
BEGIN
        open p_cur for
        select o.mispar_ishi
        from ovdim o
        where o.mispar_ishi like p_prefix
        order by o.mispar_ishi;

    EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END pro_get_ovedim_mispar_ishi;

PROCEDURE pro_get_oved_snif_unit(p_mispar_ishi in ovdim.mispar_ishi%type, p_teur_snif out ctb_snif_av.teur_snif_av%type, p_teur_unit out ctb_yechida.teur_yechida%type) IS
    v_teur_unit ctb_yechida.teur_yechida%type;
    v_teur_snif ctb_snif_av.teur_snif_av%type;
BEGIN
     --Get unit and snif description for employee
     SELECT s.Teur_Snif_av, y.teur_yechida into  v_teur_snif,v_teur_unit

     FROM pirtey_ovdim o1, pirtey_ovdim o2,  ctb_snif_av s ,ctb_yechida y,ovdim o,
            (SELECT tb_snif.mispar_ishi,
                   DECODE (tb_snif.kod_natun, 4, taarich_snif) taarich_snif,
                   DECODE (tb_unit.kod_natun, 1, taarich_unit) taarich_unit
             FROM (SELECT  MAX (o.me_taarich) taarich_unit, mispar_ishi  , kod_natun
                  FROM pirtey_ovdim o
                  WHERE o.kod_natun = 1
                  GROUP BY mispar_ishi, kod_natun) tb_unit,

                  (SELECT MAX (o.me_taarich) taarich_snif, mispar_ishi, kod_natun
                   FROM pirtey_ovdim o
                   WHERE o.kod_natun = 4
                   GROUP BY mispar_ishi, kod_natun) tb_snif
            WHERE tb_unit.mispar_ishi = tb_snif.mispar_ishi and tb_unit.mispar_ishi=  p_mispar_ishi
            ) b

     WHERE o1.kod_natun = 1
          AND o1.mispar_ishi = b.mispar_ishi
          AND o1.me_taarich =  b.taarich_unit
          AND o2.mispar_ishi = b.mispar_ishi
          AND o2.me_taarich =  b.taarich_snif
          AND o2.kod_natun = 4
          AND s.kod_snif_av = o2.erech
          AND y.kod_yechida = o1.erech
          AND y.kod_hevra= s.kod_hevra
          AND o1.mispar_ishi = p_mispar_ishi
          AND o2.mispar_ishi=  p_mispar_ishi
          AND o1.mispar_ishi = o.mispar_ishi
          AND o2.mispar_ishi = o.mispar_ishi
          AND s.kod_hevra = o.kod_hevra
          AND y.kod_hevra = o.kod_hevra;

          p_teur_unit:=v_teur_unit;
          p_teur_snif:=v_teur_snif;
      EXCEPTION
        WHEN NO_DATA_FOUND THEN
            p_teur_unit:= '';
            p_teur_snif := '';
        WHEN OTHERS THEN
		RAISE;
END pro_get_oved_snif_unit;

PROCEDURE pro_get_oved_cards(p_mispar_ishi in ovdim.mispar_ishi%type,p_month in varchar2,p_cur out CurType)
IS
BEGIN
    --get oved card for month
    OPEN p_cur FOR
    SELECT distinct  to_char(y.taarich,'dd/mm/yyyy')  || ' ' || (case to_char(y.taarich,'d') when '1' then ''
                                             when '2' then ''
                                             when '3' then ''
                                             when '4' then ''
                                             when '5' then ''
                                             when '6' then ''
                                             when '7' then '' end)  || ' ' || c.teur_yom taarich,
		 decode (y.SHGIOT_LETEZUGA_LAOVED,1,'')     status,
           me.teur_measher_o_mistayeg measher_o_mistayeg_key,
            decode(nvl(so.mispar_sidur,0),0,'+','') kartis_without_peilut ,
		     y.taarich sDate,
			decode (r.KOD_STATUS_ISHUR  ,0,'+','') status_tipul_key
    FROM tb_yamey_avoda_ovdim y,ctb_measher_o_mistayeg me,
         tb_yamim_meyuchadim b, ctb_sugey_yamim_meyuchadim c,
         tb_sidurim_ovdim so ,   (select distinct r.taarich,r.mispar_ishi,decode(r.KOD_STATUS_ISHUR,null,null,0) KOD_STATUS_ISHUR from   TB_ISHURIM r where r.KOD_STATUS_ISHUR in(0,3) ) r
    WHERE y.mispar_ishi=p_mispar_ishi
          AND so.mispar_ishi(+)=y.mispar_ishi
          AND so.taarich(+) = y.taarich
          AND to_char(y.taarich,'mm/yyyy') =p_month
          AND y.taarich= b.taarich(+)
          AND b.sug_yom= c.sug_yom(+)
		 -- and (r.KOD_STATUS_ISHUR  in (0,3) or r.KOD_STATUS_ISHUR  is null)
      --    AND y.status = k.kod_status_kartis(+)
          AND nvl(y.measher_o_mistayeg,2) = me.kod_measher_o_mistayeg(+)
         AND  y.mispar_ishi = r.mispar_ishi(+)
		AND y.taarich = r.taarich(+)
order by sDate desc;


    EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END pro_get_oved_cards;

PROCEDURE pro_get_oved_cards_in_tipul(p_mispar_ishi in ovdim.mispar_ishi%type,p_cur out CurType)
IS
BEGIN
    --get oved cards that status tipul is not 1, still in tipul
    OPEN p_cur FOR
    SELECT distinct  to_char(y.taarich,'dd/mm/yyyy')  || ' ' || (case to_char(y.taarich,'d') when '1' then ''
                                             when '2' then ''
                                             when '3' then ''
                                             when '4' then ''
                                             when '5' then ''
                                             when '6' then ''
                                             when '7' then '' end)  || ' ' || c.teur_yom taarich,
        --   k.teur_status_kartis status,
		 decode (y.SHGIOT_LETEZUGA_LAOVED,1,'')    status,
           me.teur_measher_o_mistayeg measher_o_mistayeg_key,
            decode(nvl(so.mispar_sidur,0),0,'+','') kartis_without_peilut,
		    decode (r.KOD_STATUS_ISHUR  ,0,'+','') status_tipul_key,
            y.taarich  sDate
    FROM tb_yamey_avoda_ovdim y,
         ctb_measher_o_mistayeg me,tb_sidurim_ovdim so,
         tb_yamim_meyuchadim b, ctb_sugey_yamim_meyuchadim c ,
		 TB_ISHURIM r
    WHERE y.mispar_ishi=p_mispar_ishi
          AND so.mispar_ishi(+)=y.mispar_ishi
          AND so.taarich(+) = y.taarich
          AND y.taarich= b.taarich(+)
          AND b.sug_yom= c.sug_yom(+)
       --   AND y.status = k.kod_status_kartis(+)
          AND nvl(y.measher_o_mistayeg,2) = me.kod_measher_o_mistayeg(+)
		  AND (y.SHGIOT_LETEZUGA_LAOVED=1 or r.KOD_STATUS_ISHUR=0 or nvl(so.mispar_sidur,0)=0 )
		   AND  y.mispar_ishi = r.mispar_ishi(+)
		  AND y.taarich = r.taarich(+)
    ORDER BY y.taarich desc;


    EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END pro_get_oved_cards_in_tipul;


/*
Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0       07/06/2009     sari      1.    
*/
PROCEDURE pro_get_meafyeney_oved(p_mispar_ishi in meafyenim_ovdim.mispar_ishi%type,
		  									   	        p_taarich in meafyenim_ovdim.me_taarich%type,
														p_cur out CurType) is
	begin
	 open p_cur for
	   		  select  decode(m.kod_meafyen,null,b.kod_meafyen,m.kod_meafyen) kod_meafyen,decode(m.Erech_Mechdal_partany,null,'',m.Erech_Mechdal_partany ||   ' (..) ') Erech_Mechdal_partany,c.teur_MEAFYEN_BITZUA,
			                 decode(b.erech,null,'',b.erech  ||   ' (.. ) ') Erech_Brirat_Mechdal,y.TEUR_YECHIDA_MEAFYEN YECHIDA,
			   		 		 decode(m.erech_ishi,null,decode(m.ERECH_MECHDAL_PARTANY,null, b.ME_TAARICH,m.ME_TAARICH),m.ME_TAARICH) ME_TAARICH,
			  				 decode(m.erech_ishi,null,decode(m.ERECH_MECHDAL_PARTANY,null, b.ad_TAARICH,m.ad_TAARICH),m.ad_TAARICH) AD_TAARICH,
			    			  decode(m.erech_ishi,null,decode(m.ERECH_MECHDAL_PARTANY,null, b.erech ||  ' (.. ) ' ,m.ERECH_MECHDAL_PARTANY || ' (..) ' ),m.erech_ishi || ' () '  ) Erech_ishi,
							  to_number(decode(m.erech_ishi,null,decode(m.ERECH_MECHDAL_PARTANY,null, b.erech ,m.ERECH_MECHDAL_PARTANY ),m.erech_ishi))  value_erech_ishi,
							  decode(m.kod_meafyen,null,2,1) source_meafyen
				from tmp_meafyenim_Ovdim m,CTB_MEAFYEN_BITZUA c, BREROT_MECHDAL_MEAFYENIM b,CTB_YECHIDAT_MEAFYEN Y
				where trunc(p_taarich) between m.ME_TAARICH(+) and nvl(m.AD_TAARICH(+),to_date('01/01/9999','dd/mm/yyyy'))
				 and   m.MISPAR_ISHI(+)=p_mispar_ishi
				  and  trunc(p_taarich) between b.ME_TAARICH and nvl(b.AD_TAARICH,to_date('01/01/9999','dd/mm/yyyy'))
				   and b.kod_meafyen=m.kod_meafyen(+)
				   and c.KOD_MEAFYEN_BITZUA= b.kod_meafyen
				   and c.YECHIDAT_MEAFYEN = Y.KOD_YECHIDA_MEAFYEN(+);
	
  EXCEPTION
       WHEN OTHERS THEN
				RAISE;
end   pro_get_meafyeney_oved;

PROCEDURE pro_get_meafyeney_oved_all(p_mispar_ishi in meafyenim_ovdim.mispar_ishi%type,
		  									   	        p_me_taarich in meafyenim_ovdim.me_taarich%type,
														 p_ad_taarich in meafyenim_ovdim.me_taarich%type,
														p_brerat_Mechadal  in number,
														p_cur out CurType) is
	begin
	if p_brerat_Mechadal =1 then
	 open p_cur for
	   		  select  decode(m.kod_meafyen,null,b.kod_meafyen,m.kod_meafyen) kod_meafyen,decode(m.Erech_Mechdal_partany,null,'',m.Erech_Mechdal_partany ||   ' (..) ') Erech_Mechdal_partany,c.teur_MEAFYEN_BITZUA,
			                 decode(b.erech,null,'',b.erech  ||   ' (.. ) ') Erech_Brirat_Mechdal,y.TEUR_YECHIDA_MEAFYEN YECHIDA,
			   		 		 decode(m.erech_ishi,null,decode(m.ERECH_MECHDAL_PARTANY,null, b.ME_TAARICH,m.ME_TAARICH),m.ME_TAARICH) ME_TAARICH,
			  				 decode(m.erech_ishi,null,decode(m.ERECH_MECHDAL_PARTANY,null, b.ad_TAARICH,m.ad_TAARICH),m.ad_TAARICH) AD_TAARICH,
			    			  decode(m.erech_ishi,null,decode(m.ERECH_MECHDAL_PARTANY,null, b.erech ||  ' (.. ) ' ,m.ERECH_MECHDAL_PARTANY || ' (..) ' ),m.erech_ishi || ' () '  ) Erech_ishi,
							  to_number(decode(m.erech_ishi,null,decode(m.ERECH_MECHDAL_PARTANY,null, b.erech ,m.ERECH_MECHDAL_PARTANY ),m.erech_ishi))  value_erech_ishi,
							  decode(m.kod_meafyen,null,2,1) source_meafyen
				from tmp_meafyenim_Ovdim m,CTB_MEAFYEN_BITZUA c, BREROT_MECHDAL_MEAFYENIM b,CTB_YECHIDAT_MEAFYEN Y
				where  (trunc(p_me_taarich)  Between  m.ME_TAARICH(+)  and   nvl(m.ad_TAARICH(+),to_date('01/01/9999' ,'dd/mm/yyyy'))
					  or  trunc(p_ad_taarich) Between  m.ME_TAARICH(+)  and   nvl(m.ad_TAARICH(+),to_date('01/01/9999' ,'dd/mm/yyyy'))
					  or   m.ME_TAARICH(+)>= trunc(p_me_taarich)  and   nvl(m.ad_TAARICH(+),to_date('01/01/9999' ,'dd/mm/yyyy'))<=  trunc(p_ad_taarich) )
				 and   m.MISPAR_ISHI(+)=p_mispar_ishi
				   and  (trunc(p_me_taarich)  Between  b.ME_TAARICH  and   nvl(b.ad_TAARICH,to_date('01/01/9999' ,'dd/mm/yyyy'))
					  or  trunc(p_ad_taarich) Between  b.ME_TAARICH  and   nvl(b.ad_TAARICH,to_date('01/01/9999' ,'dd/mm/yyyy'))
					  or   b.ME_TAARICH>= trunc(p_me_taarich)  and   nvl(b.ad_TAARICH,to_date('01/01/9999' ,'dd/mm/yyyy'))<=  trunc(p_ad_taarich) )
				   and b.kod_meafyen=m.kod_meafyen(+)
				   and c.KOD_MEAFYEN_BITZUA= b.kod_meafyen
				   and c.YECHIDAT_MEAFYEN = Y.KOD_YECHIDA_MEAFYEN(+);
	else
		open p_cur for
	   		    select m.kod_meafyen,decode(m.Erech_Mechdal_partany,null,'',m.Erech_Mechdal_partany ||   ' (..) ') Erech_Mechdal_partany,
				 	   		 c.teur_MEAFYEN_BITZUA,( select  b.erech  ||   ' (.. ) '
																   		from BREROT_MECHDAL_MEAFYENIM b
																   		where trunc(sysdate) between b.ME_TAARICH and nvl(b.AD_TAARICH,to_date('01/01/9999','dd/mm/yyyy'))
																		and b.kod_meafyen=m.kod_meafyen
																		and b.erech  is not null)  Erech_Brirat_Mechdal,
				 			m.ME_TAARICH,m.ad_TAARICH,y.TEUR_YECHIDA_MEAFYEN YECHIDA,
				           decode(m.erech_ishi,null,decode(m.ERECH_MECHDAL_PARTANY,null, null,m.Erech_Mechdal_partany || ' (..) '),m.erech_ishi || ' () ' ) Erech_ishi,
						    to_number(decode(m.erech_ishi,null,decode(m.ERECH_MECHDAL_PARTANY,null, null,m.Erech_Mechdal_partany),m.erech_ishi ) ) value_Erech_ishi
				from tmp_meafyenim_Ovdim m,CTB_MEAFYEN_BITZUA c,CTB_YECHIDAT_MEAFYEN Y
				 where   (trunc(p_me_taarich)  Between  m.ME_TAARICH  and   nvl(m.ad_TAARICH,to_date('01/01/9999' ,'dd/mm/yyyy'))
					  or  trunc(p_ad_taarich) Between  m.ME_TAARICH  and   nvl(m.ad_TAARICH,to_date('01/01/9999' ,'dd/mm/yyyy'))
					  or   m.ME_TAARICH>= trunc(p_me_taarich)  and   nvl(m.ad_TAARICH,to_date('01/01/9999' ,'dd/mm/yyyy'))<=  trunc(p_ad_taarich) )
				and   m.MISPAR_ISHI=p_mispar_ishi
				and c.KOD_MEAFYEN_BITZUA=m.kod_meafyen
				   and c.YECHIDAT_MEAFYEN =Y.KOD_YECHIDA_MEAFYEN(+);
	end if;
  EXCEPTION
       WHEN OTHERS THEN
				RAISE;
end   pro_get_meafyeney_oved_all;
/*
Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0       10/06/2009     sari      1.      
*/
PROCEDURE pro_get_historiat_meafyen(p_mispar_ishi in meafyenim_ovdim.mispar_ishi%type,
														p_from_taarich in meafyenim_ovdim.me_taarich%type,
														p_Code_meafyen  in meafyenim_ovdim.KOD_MEAFYEN%type,
														p_cur out CurType) is
	begin
	open p_cur for
	   		    select m.kod_meafyen,decode(m.Erech_Mechdal_partany,null,'',m.Erech_Mechdal_partany ||   ' (..) ') Erech_Mechdal_partany,
				 	   		 c.teur_MEAFYEN_BITZUA,( select  b.erech  ||   ' (.. ) '
																   		from BREROT_MECHDAL_MEAFYENIM b
																   		where trunc(sysdate) between b.ME_TAARICH and nvl(b.AD_TAARICH,to_date('01/01/9999','dd/mm/yyyy'))
																		and b.kod_meafyen=m.kod_meafyen
																		and b.erech  is not null)  Erech_Brirat_Mechdal,
				 			m.ME_TAARICH,m.ad_TAARICH,y.TEUR_YECHIDA_MEAFYEN YECHIDA,
				           decode(m.erech_ishi,null,decode(m.ERECH_MECHDAL_PARTANY,null, null,m.Erech_Mechdal_partany || ' (..) '),m.erech_ishi || ' () ' ) Erech_ishi,
						    to_number(decode(m.erech_ishi,null,decode(m.ERECH_MECHDAL_PARTANY,null, null,m.Erech_Mechdal_partany),m.erech_ishi ) ) value_Erech_ishi
				from tmp_meafyenim_Ovdim m,CTB_MEAFYEN_BITZUA c,CTB_YECHIDAT_MEAFYEN Y
				 where m.AD_TAARICH<= trunc(p_from_taarich)
				and   m.MISPAR_ISHI=p_mispar_ishi
				and c.KOD_MEAFYEN_BITZUA=m.kod_meafyen
				and m.KOD_MEAFYEN=p_Code_meafyen
				  and c.YECHIDAT_MEAFYEN =Y.KOD_YECHIDA_MEAFYEN(+)
				order by me_taarich desc;

  EXCEPTION
       WHEN OTHERS THEN
				RAISE;
end   pro_get_historiat_meafyen;

/*
Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0       07/06/2009     sari      1.   12    
*/
PROCEDURE pro_get_month_year_to_oved(p_mispar_ishi in TB_Yamey_Avoda_Ovdim.mispar_ishi%type,
														p_cur out CurType) is
	begin
	  open p_cur for
	   	select  to_char(month_year,'mm/yyyy') month_year from
		(select  distinct to_date('01/' || to_char(taarich,'mm/yyyy'),'dd/mm/yyyy')  month_year
		from TB_Yamey_Avoda_Ovdim
		where mispar_ishi=p_mispar_ishi
		order by month_year  desc)
		where rownum<15;
  EXCEPTION
       WHEN OTHERS THEN
				RAISE;
end   pro_get_month_year_to_oved;

/*
Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0       23/06/2009     sari      1.    
*/
PROCEDURE pro_get_status_oved(p_mispar_ishi in Matzav_Ovdim.mispar_ishi%type,
														p_cur out CurType) is
	begin
	  open p_cur for
	   	   select m.KOD_MATZAV ,s.TEUR_STATUS, m.Taarich_hatchala,m.Taarich_siyum
			 from Matzav_Ovdim  m,CTB_Status s,ovdim o
			 where m.mispar_ishi=p_mispar_ishi
			 and m.mispar_ishi=o.mispar_ishi
			and s.Kod_Status=m.Kod_matzav
			And o. Kod_Hevra= s. Kod_Hevra
			order by m.Taarich_hatchala desc;

  EXCEPTION
       WHEN OTHERS THEN
				RAISE;
end   pro_get_status_oved;

/*
Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        12/05/2009     sari      1.   
*/
 PROCEDURE pro_get_pirtey_oved_all(p_mispar_ishi in ovdim.mispar_ishi%type,
 		   										 						    p_taarich in date,
 		   									 							p_cur out CurType) IS
		v_date_from date;

BEGIN
	 v_date_from:=to_date('01/' || to_char(p_taarich,'mm/yyyy'),'dd/mm/yyyy');

	 OPEN p_cur FOR
		 select o.mispar_ishi,h.TEUR_NATUN,decode(K.kod ,null,p.ERECH,K.kod)kod_erech,k.teur teur_erech,
		 		p.ME_TAARICH ,p.ad_TAARICH ,k.kod_natun,to_char(p_taarich,'mm/yyyy') month_year
		 from   viw_kod_natun k,
						Pirtey_Ovdim p,
						Ovdim o,
						ctb_natun_hr h
			where   p.Mispar_Ishi=o.mispar_ishi
			and p.KOD_NATUN=K.kod_natun
			and p.Mispar_Ishi=p_mispar_ishi
			and p.KOD_NATUN=p.kod_natun
			and p.KOD_NATUN=h.KOD_NATUN
			 and (v_date_from Between  p.ME_TAARICH  and   nvl(p.ad_TAARICH,to_date('01/01/9999' ,'dd/mm/yyyy'))
			 or  trunc(p_taarich) Between  p.ME_TAARICH  and   nvl(p.ad_TAARICH,to_date('01/01/9999' ,'dd/mm/yyyy'))
			 or   p.ME_TAARICH>=v_date_from  and   nvl(p.ad_TAARICH,to_date('01/01/9999' ,'dd/mm/yyyy'))<= trunc(p_taarich))
			and (p.ERECH=K.kod or  K.kod is null)
			and  (o. Kod_Hevra= k.Kod_Hevra or  k.Kod_Hevra is null);

EXCEPTION
       WHEN OTHERS THEN
            RAISE;

END  pro_get_pirtey_oved_all;

/*
Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0       28/06/2009     sari      1.    
*/
	PROCEDURE pro_get_historiat_natun(p_mispar_ishi in Pirtey_Ovdim.mispar_ishi%type,
														p_from_taarich in Pirtey_Ovdim.me_taarich%type,
														p_Code_natun  in Pirtey_Ovdim.KOD_NATUN%type,
														p_cur out CurType) is
	begin

		open p_cur for
		select p.mispar_ishi,decode(K.kod ,null,p.ERECH,K.kod)kod_erech,k.teur teur_erech,
		 		p.ME_TAARICH ,p.ad_TAARICH ,k.kod_natun
			from Pirtey_Ovdim p,viw_kod_natun k,Ovdim o
				 where p.AD_TAARICH<= trunc(p_from_taarich)
				and   p.MISPAR_ISHI=p_mispar_ishi
				and  p.Mispar_Ishi=o.mispar_ishi
				and p.KOD_NATUN=k.KOD_NATUN
				and p.KOD_NATUN=p_Code_natun
				and (p.ERECH=k.kod or  k.kod is null)
				and  (o. Kod_Hevra= k.Kod_Hevra or k.Kod_Hevra is null)
				order by me_taarich desc;

  EXCEPTION
       WHEN OTHERS THEN
				RAISE;
end   pro_get_historiat_natun;

/*
Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        13/05/2009     sari      1.      
*/
 PROCEDURE pro_get_ritzot_chishuv(p_mispar_ishi in ovdim.mispar_ishi%type,
								 				p_taarich in date,
												p_cur out CurType) IS
		v_first_bakasha NUMBER;
BEGIN
	 BEGIN
		 	 Select distinct b.Bakasha_ID into v_first_bakasha
			From TB_Chishuv_Chodesh_Ovdim  C, TB_Bakashot B
			Where C.Bakasha_ID=B.Bakasha_ID
			And C.Mispar_Ishi =p_mispar_ishi
			and C.Taarich =p_taarich
			and B.Huavra_Lesachar=1
			And B.Zman_Hatchala =(Select Min (Zman_Hatchala)
														From TB_Chishuv_Chodesh_Ovdim C2, TB_Bakashot B2
														Where C2.Bakasha_ID=B2.Bakasha_ID
														And C2.Mispar_Ishi =p_mispar_ishi
														and C2.Taarich =p_taarich
														and B2.Huavra_Lesachar=1);

	EXCEPTION
	WHEN NO_DATA_FOUND THEN
		  v_first_bakasha:=0;
	  WHEN OTHERS THEN
            RAISE;
	end;

	open p_cur for
		 Select distinct TB.Bakasha_ID code_bakasha,TB.Zman_Hatchala,
		  TB.Bakasha_ID || ' - '||  substr(TB.Teur,0,15)  || '  ('||  to_char( TB.Zman_Hatchala,'dd.mm.yyyy')  || ') - ' ||  decode(TB.Bakasha_ID, v_first_bakasha,'','')  Teur_bakasha,
		  TB.Bakasha_ID || ' - '||  TB.Teur  || '  ('||  to_char( TB.Zman_Hatchala,'dd.mm.yyyy')  || ') - ' ||  decode(TB.Bakasha_ID, v_first_bakasha,'','')  Teur_bakasha_full
		From TB_Bakashot TB, TB_Chishuv_Chodesh_Ovdim TC
		Where TB. Bakasha_ID=TC. Bakasha_ID
		And TB.Huavra_Lesachar = 1
		and TC.Mispar_Ishi =p_mispar_ishi
		And TC.Taarich =p_taarich
		Order By TB.Zman_Hatchala;

EXCEPTION
	  WHEN OTHERS THEN
            RAISE;

END  pro_get_ritzot_chishuv;

/*
Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        01/07/2009     sari      1.      
*/
 PROCEDURE pro_get_shaot_meal_michsa(p_mispar_ishi in ovdim.mispar_ishi%type,
 		   										 						  p_taarich in date,
																		  p_bakasha in tb_Chishuv_chodesh_Ovdim.Bakasha_ID%type,
 		   									 							p_cur out CurType) IS
BEGIN
	 OPEN p_cur FOR
		 select  c.Kod_Rechiv,c.ERECH_RECHIV
		 		/* case  c.kod_rechiv
	  			     when 76 then (select sum(y.erech_rechiv) from  TB_Chishuv_chodesh_Ovdim  y
											Where y. Mispar_Ishi=p_mispar_ishi
											and  to_char(c.Taarich,'mm/yyyy') =to_char(p_taarich,'mm/yyyy')
											and y.Erech_Rechiv is not Null
											and y.Bakasha_ID= p_bakasha
											and y.kod_rechiv=119)
								 when 77 then (select sum(y.erech_rechiv) from TB_Chishuv_chodesh_Ovdim y
											Where y. Mispar_Ishi=p_mispar_ishi
											and  to_char(c.Taarich,'mm/yyyy') =to_char(p_taarich,'mm/yyyy')
											and y.Erech_Rechiv is not Null
											and y.Bakasha_ID= p_bakasha
											and y.kod_rechiv=120)
									when 79 then (select sum(y.erech_rechiv) from TB_Chishuv_chodesh_Ovdim  y
											Where y. Mispar_Ishi=p_mispar_ishi
											and  to_char(c.Taarich,'mm/yyyy') =to_char(p_taarich,'mm/yyyy')
											and y.Erech_Rechiv is not Null
											and y.Bakasha_ID= p_bakasha
											and y.kod_rechiv=122 ) end  as kizuz_meal_michsa*/
		From TB_Chishuv_chodesh_Ovdim C
						Where C.Mispar_Ishi(+)=p_mispar_ishi
						and to_char(c.Taarich(+),'mm/yyyy') =to_char(p_taarich,'mm/yyyy')
						and c.kod_rechiv in(119,120,121,143,147,160,161,163,253,254,255)
						and C.Bakasha_ID(+)= p_bakasha;
EXCEPTION
       WHEN OTHERS THEN
            RAISE;

END  pro_get_shaot_meal_michsa;

/*Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        01/07/2009      sari       1.       
*/
  PROCEDURE pro_ins_bakasha_mechutz_lemich(p_mispar_ishi  in tb_bakashot_michutz_lamichsa.mispar_ishi%type,
																			  p_taarich  in tb_bakashot_michutz_lamichsa.taarich%type,
																			  p_shaot  in tb_bakashot_michutz_lamichsa.mevukash%type,
																			  p_siba  in tb_bakashot_michutz_lamichsa.sibat_habakasha%type,
																			  p_user_id   in tb_bakashot_michutz_lamichsa.mispar_ishi%type) IS
  BEGIN
  	   		INSERT INTO TB_BAKASHOT_MICHUTZ_LAMICHSA
			                   ( MISPAR_ISHI ,TAARICH  ,MEVUKASH, SIBAT_HABAKASHA ,TAARICH_IDKUN_ACHARON , MEADKEN_ACHARON)
			VALUES (p_mispar_ishi,p_taarich,p_shaot,p_siba,sysdate,p_user_id);

      EXCEPTION
		 WHEN OTHERS THEN
		      RAISE;
  END pro_ins_bakasha_mechutz_lemich;


procedure pro_get_Hour_Approval(p_TypeDemand INTEGER,
                                                             p_mispar_ishi in ovdim.mispar_ishi% TYPE,
                                                             p_Month VARCHAR2,
                                                             p_StatusIsuk integer,
                                                             p_Filter in VARCHAR2,
                                                             p_cur out CurType) is
      strSql VARCHAR2(5000);
      TypeDemandCondition VARCHAR2(100);
      IsukCondition VARCHAR2(3000);
      strSqlEtsNiuli VARCHAR2(1000);
      EtsNiuliCondition varchar2(2000);
      Status_Isuk INTEGER;
      strSqlAll varchar2(15000);
       v_FirstInMonthDate Date ;
      v_LastInMonthDate date ;
      countRec  number ;
  BEGIN
    if (p_Month is null ) then
      v_FirstInMonthDate := to_date('30/12/1899','dd/mm/yyyy');
      v_LastInMonthDate := to_date('30/12/4712','dd/mm/yyyy');
    else
      v_FirstInMonthDate := to_date('01/' || p_Month,'dd/mm/yyyy'); /* period= 05/2009=>  v_MinLimitDate = 01/05/2009 */
      v_LastInMonthDate := add_months(v_FirstInMonthDate,1) -1 ;    /* period= 05/2009=>  v_MaxLimitDate = 31/05/2009 */
    end if ;
        if (p_StatusIsuk= 4) then
            strSql  :=  strSql   || ' Select rama3.kod_status_ishur,rama3.Rama,' ;
      else
            strSql  :=  strSql   || 'Select rama2.kod_status_ishur,rama2.Rama,' ;
      end if ;
        strSql  :=  strSql   || 'rama1.mispar_ishi , 
            Shem,
            Yechida.TEUR_YECHIDA Agaf , 
            replace(TEUR_SNIF_AV, '''','''')  snif_av,
            TEUR_MAAMAD_HR maamad,
            teur_isuk isuk ,
            rama2.TAARICH ,
            rama1.erech_mevukash Mevukash,
            rama1.siba,
            rama1.erech_meushar Meushar_MenahelYashir,
            rama2.erech_meushar Meushar_Agafit ,
            rama3.erech_mevukash UavarLeIshurVaad, 
            rama3.erech_meushar UsharAlVaad,
             PKG_OVDIM.fun_get_BakashaId(  rama1.mispar_ishi,   rama2.TAARICH) Bakasha_ID, 
            rama2.KOD_ISHUR ,
            rama2.MISPAR_SIDUR,
            rama2.SHAT_HATCHALA,
            rama2.SHAT_YETZIA,
            rama2.MISPAR_KNISA,';
        if (p_StatusIsuk= 4) then
            strSql  :=  strSql   || 'rama3.kod_status_ishur OriginalStatusIshur ' ;
      else
            strSql  :=  strSql   || 'rama2.kod_status_ishur OriginalStatusIshur ' ;
      end if ;
            
             strSql  :=  strSql   || ' FROM   (select  (shem_mish|| '' '' ||  shem_prat) as Shem,kod_hevra,mispar_ishi from  ovdim ) Ov,
            tb_ishurim rama1,           
            tb_ishurim rama2           ,
            tb_ishurim rama3           ,
            tmp_Pirtey_Ovdim  Details, 
            CTB_Maamad Maamad,  
            ctb_snif_av Snif,
            ctb_isuk Isuk,
            CTB_Yechida Yechida  ,
            (select po.mispar_ishi,max(po.ME_TARICH) me_taarich
                       from tmp_Pirtey_Ovdim PO
                       where po.isuk is not null
                             and (  ''' || v_FirstInMonthDate || '''  Between  po.ME_TARICH  and   nvl(po.ad_TARICH,to_date(''01/01/9999'' ,''dd/mm/yyyy''))
                               or    ''' || v_LastInMonthDate || ''' Between  po.ME_TARICH  and   nvl(po.ad_TARICH,to_date(''01/01/9999'' ,''dd/mm/yyyy''))
                                or   po.ME_TARICH>=  ''' || v_FirstInMonthDate || ''' and  nvl(po.ad_TARICH,to_date(''01/01/9999'' ,''dd/mm/yyyy''))<=  ''' || v_LastInMonthDate || ''' )
                      group by po.mispar_ishi) RelevantDetails '  ||
           ' where  Ov.mispar_ishi = rama1.mispar_ishi
                and Ov.kod_hevra = Yechida.kod_hevra 
                and Ov.kod_hevra = MAAMAD.KOD_HEVRA 
                and Yechida.kod_hevra = Isuk.kod_hevra
                and Yechida.KOD_YECHIDA = Details.Agaf
                and rama1.rama = 1 
                and rama1.kod_ishur =35
                and rama2.rama = 2 
                and rama1.mispar_ishi = rama2.mispar_ishi
                and rama1.taarich =rama2.taarich
                and rama1.kod_ishur =rama2.kod_ishur
                and rama1.SHAT_HATCHALA =rama2.SHAT_HATCHALA
                and rama1.SHAT_YETZIA =rama2.SHAT_YETZIA
                and rama1.mispar_knisa =rama2.mispar_knisa
                and rama1.mispar_sidur =rama2.mispar_sidur
                and rama1.mispar_ishi = rama3.mispar_ishi(+) 
                and rama1.taarich =rama3.taarich(+)
                and rama1.kod_ishur =rama3.kod_ishur(+)
                and rama1.SHAT_HATCHALA =rama3.SHAT_HATCHALA(+)
                and rama1.SHAT_YETZIA =rama3.SHAT_YETZIA(+)
                and rama1.mispar_knisa =rama3.mispar_knisa(+)
                and rama1.mispar_sidur =rama3.mispar_sidur(+)
                and ( rama2.taarich BETWEEN ''' || v_FirstInMonthDate || ''' AND ''' || v_LastInMonthDate || ''')
                and  Details.mispar_ishi = rama1.mispar_ishi 
                And Details.isuk            = Isuk.kod_isuk
                And Details.snif_av       = Snif.kod_snif_av   
                And Details.maamad     = maamad.kod_maamad_hr  
                and Details.mispar_ishi = RelevantDetails.mispar_ishi 
                and  Details.ME_TARICH = RelevantDetails.me_taarich ' ;
                
        --           p_mispar_ishi
                
        if (p_StatusIsuk <> 4) then --  
          TypeDemandCondition := case (p_TypeDemand) when 0 then  '(rama2.kod_status_ishur= 0 or rama2.kod_status_ishur is null)' else  '(rama2.kod_status_ishur<> 0)' end ;
            strSql  :=  strSql || ' and rama3.rama(+) = 3 and '  || TypeDemandCondition || ' and ( rama2.mispar_ishi  in (
            select distinct a.mispar_ishi                from (select * from ez_nihuly e,
            (select Mispar_Ishi,erech from Pirtey_Ovdim where  trunc(sysdate)>= Me_taarich and trunc(sysdate)<= Ad_taarich and  Kod_Natun=1) p
            where p.erech=e.yechida_mekorit) a
            CONNECT BY a.YECHIDAT_ABA  = PRIOR a.yechida_mekorit  START WITH a.YECHIDAT_ABA  =(Select Erech From Pirtey_Ovdim
            Where Mispar_Ishi=' || p_mispar_ishi ||  ' and trunc(sysdate)>= Me_taarich and trunc(sysdate)<= Ad_taarich and  Kod_Natun=1))) '  ;
        else 
            TypeDemandCondition := case (p_TypeDemand) when 0 then  '(rama3.kod_status_ishur= 0 or rama3.kod_status_ishur is null)' else  '(rama3.kod_status_ishur<> 0)' end ;
            strSql  :=  strSql || 'and rama3.rama = 3  and '  || TypeDemandCondition ;
        end if ;
                
        if (p_Filter is not null ) then --  
            strSql  :=  strSql ||replace(p_Filter,'mispar_ishi','rama1.mispar_ishi') ||  ' order by  mispar_ishi asc ,TAARICH desc ';
        else             
           strSql  :=  strSql ||  ' order by  Shem asc ,TAARICH desc ';
        end if;

        strSqlAll  := strSql  ;
/*
         execute immediate 'select count(*)   from (' || strSqlAll || ')' into countRec ;
INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'countRec',countRec);
  */       
        open p_Cur for  strSqlAll   ;

           DBMS_OUTPUT.PUT_LINE('strSqlAll = ' || strSqlAll);


       EXCEPTION
         WHEN OTHERS THEN
              RAISE;
  end pro_get_Hour_Approval;

procedure pro_getRelevantMonthOfApproval(p_mispar_ishi in ovdim.mispar_ishi% TYPE,
                                                             p_cur out CurType) is
  BEGIN
        open p_Cur for  Select      Distinct to_char(rama2.TAARICH,'MM/YYYY') RelevantMonths
                                 FROM   
                                        tb_ishurim rama1,           
                                        tb_ishurim rama2           ,
                                        tb_ishurim rama3           ,
                                        tmp_Pirtey_Ovdim  Details
                            where  Details.mispar_ishi = rama1.mispar_ishi
                                    and rama1.rama = 1 
                                    and rama1.kod_ishur =35
                                    and rama2.rama = 2 
                                    and rama1.mispar_ishi = rama2.mispar_ishi
                                    and rama1.taarich =rama2.taarich
                                    and rama1.kod_ishur =rama2.kod_ishur
                                    and rama1.SHAT_HATCHALA =rama2.SHAT_HATCHALA
                                    and rama1.SHAT_YETZIA =rama2.SHAT_YETZIA
                                    and rama1.mispar_knisa =rama2.mispar_knisa
                                    and rama1.mispar_sidur =rama2.mispar_sidur
                                    and rama1.mispar_ishi = rama3.mispar_ishi(+) 
                                    and rama1.taarich =rama3.taarich(+)
                                    and rama1.kod_ishur =rama3.kod_ishur(+)
                                    and rama1.SHAT_HATCHALA =rama3.SHAT_HATCHALA(+)
                                    and rama1.SHAT_YETZIA =rama3.SHAT_YETZIA(+)
                                    and rama1.mispar_knisa =rama3.mispar_knisa(+)
                                    and rama1.mispar_sidur =rama3.mispar_sidur(+)
                                    and  Details.mispar_ishi = rama1.mispar_ishi 
                                    and rama3.rama(+) = 3 
                                    and (rama2.kod_status_ishur= 0 or rama2.kod_status_ishur is null) 
                                    and ( rama2.mispar_ishi  in (
                                select distinct a.mispar_ishi                from (select * from ez_nihuly e,
                                (select Mispar_Ishi,erech from Pirtey_Ovdim where  trunc(sysdate)>= Me_taarich and trunc(sysdate)<= Ad_taarich and  Kod_Natun=1) p
                                where p.erech=e.yechida_mekorit) a
                                CONNECT BY a.YECHIDAT_ABA  = PRIOR a.yechida_mekorit  START WITH a.YECHIDAT_ABA  =(Select Erech From Pirtey_Ovdim
                                Where Mispar_Ishi=p_mispar_ishi and trunc(sysdate)>= Me_taarich and trunc(sysdate)<= Ad_taarich and  Kod_Natun=1)))   ;


       EXCEPTION
         WHEN OTHERS THEN
              RAISE;
  end pro_getRelevantMonthOfApproval;



procedure pro_upd_Hour_Aproval(p_Bakasha_ID  in number ,
                                                    p_kod_status_ishur in number ,  p_MISPAR_ISHI IN  TB_ISHURIM.MISPAR_ISHI% type, 
                                                    p_KOD_ISHUR IN  TB_ISHURIM.kod_ishur% type,
                                                    p_TAARICH IN  TB_ISHURIM.TAARICH%type, 
                                                    p_MISPAR_SIDUR IN  TB_ISHURIM.MISPAR_SIDUR%type, 
                                                    p_SHAT_HATCHALA IN  TB_ISHURIM.SHAT_HATCHALA%type, 
                                                    p_SHAT_YETZIA IN  TB_ISHURIM.SHAT_YETZIA%type, 
                                                    p_MISPAR_KNISA IN  TB_ISHURIM.MISPAR_KNISA%type, 
                                                    p_RAMA IN  TB_ISHURIM.RAMA%type, 
                                                    p_ERECH_MEUSHAR IN  TB_ISHURIM.ERECH_MEUSHAR%type, 
                                                    p_ERECH_MEVUKASH IN TB_ISHURIM.ERECH_MEVUKASH%type ,
                                                    P_SIBA IN TB_ISHURIM.SIBA%type ,
                                                    P_MAINFACTOR NUMBER, 
                                                    P_SECONDARYFACTOR NUMBER ,
                                                    p_Result out INTEGER) IS 
Old_Erech_Meushar number ;
Old_Erech_Mevukash number ;
Erech_Meushar_Agaf  number ; 
ApprovalDemandExist  NUMBER;
approve_value number;
v_FirstInMonthDate Date ; 
v_LastInMonthDate date ; 
Erech_147 number ;
Erech_143 number ;
Erech_253 number ;
AllResult number ;
KDS_GW_EXCEPTION EXCEPTION ;
begin
        v_FirstInMonthDate := to_date('01/' || TO_CHAR(p_TAARICH,'mm/yyyy'),'DD/MM/YYYY'); /* period= 05/2009=>  v_MinLimitDate = 01/05/2009 */
        v_LastInMonthDate := add_months(v_FirstInMonthDate,1) -1 ;    /* period= 05/2009=>  v_MaxLimitDate = 31/05/2009 */
        
          select I.ERECH_MEUSHAR into Erech_Meushar_Agaf 
          from TB_ISHURIM I WHERE 
          MISPAR_ISHI = P_MISPAR_ISHI AND 
          KOD_ISHUR = p_kod_ishur AND
          TAARICH = p_TAARICH AND 
          MISPAR_SIDUR = p_MISPAR_SIDUR AND  
          SHAT_HATCHALA = p_SHAT_HATCHALA AND
          SHAT_YETZIA = p_SHAT_YETZIA AND
          MISPAR_KNISA = p_MISPAR_KNISA AND
          RAMA =1;
          Erech_147 :=  PKG_UTILS.fun_GET_Rechiv_Value(p_mispar_ishi,147,v_FirstInMonthDate,v_LastInMonthDate,p_Bakasha_ID);
          Erech_143 := nvl(PKG_UTILS.fun_GET_Rechiv_Value(p_mispar_ishi,143,v_FirstInMonthDate,v_LastInMonthDate,p_Bakasha_ID),0);
          Erech_253 := nvl(PKG_UTILS.fun_GET_Rechiv_Value(p_mispar_ishi,253,v_FirstInMonthDate,v_LastInMonthDate,p_Bakasha_ID),0);

          select I.ERECH_MEUSHAR , I.erech_mevukash  into Old_Erech_Meushar,Old_Erech_Mevukash
          from TB_ISHURIM I WHERE 
          MISPAR_ISHI = P_MISPAR_ISHI AND 
          KOD_ISHUR = p_kod_ishur AND
          TAARICH = p_TAARICH AND 
          MISPAR_SIDUR = p_MISPAR_SIDUR AND  
          SHAT_HATCHALA = p_SHAT_HATCHALA AND
          SHAT_YETZIA = p_SHAT_YETZIA AND
          MISPAR_KNISA = p_MISPAR_KNISA AND
          RAMA = p_RAMA;
           DBMS_OUTPUT.PUT_LINE('Old_Erech_Meushar = ' || Old_Erech_Meushar);


         select count (MISPAR_ISHI) into ApprovalDemandExist from TB_ISHURIM        WHERE 
          MISPAR_ISHI = P_MISPAR_ISHI AND 
          KOD_ISHUR = p_kod_ishur AND
          TAARICH = p_TAARICH AND 
          MISPAR_SIDUR = p_MISPAR_SIDUR AND  
          SHAT_HATCHALA = p_SHAT_HATCHALA AND
          SHAT_YETZIA = p_SHAT_YETZIA AND
          MISPAR_KNISA = p_MISPAR_KNISA AND
          RAMA = 3 ; 
           DBMS_OUTPUT.PUT_LINE('ApprovalDemandExist = ' || ApprovalDemandExist);
          if (p_RAMA = 2) then 
              if (p_kod_status_ishur =1 ) then --    
                     DBMS_OUTPUT.PUT_LINE('p_kod_status_ishur =1   ');
                       AllResult := 2000 ;    
                       if ( (p_erech_meushar > Erech_147 ) and ( Erech_147 > 0 )) then
                           AllResult := AllResult + 100 ; 
                           Egd_mafienim_New.Tipul_Mafienim@KDS_GW( approve_value,to_char(p_MISPAR_ISHI),to_date(to_char(P_TAARICH,'mm/yyyy'),'mm/yyyy'),Erech_147 + Erech_143 ,14) ;
                           AllResult := AllResult + approve_value*10;
                           if (approve_value<> 0) then 
                                RAISE KDS_GW_EXCEPTION ;
                            end if;
                            Egd_mafienim_New.Tipul_Mafienim@KDS_GW( approve_value, to_char(p_MISPAR_ISHI),to_date(to_char(P_TAARICH,'mm/yyyy'),'mm/yyyy'),Erech_253 + (p_erech_meushar- Erech_147) ,13) ;  
                           AllResult := AllResult + approve_value;
                           if (approve_value<> 0) then 
                                RAISE KDS_GW_EXCEPTION ;
                            end if;
                       elsif  (Erech_147 = 0 ) then 
                            AllResult := AllResult + 200 ;
                           Egd_mafienim_New.Tipul_Mafienim@KDS_GW( approve_value, to_char(p_MISPAR_ISHI),to_date(to_char(P_TAARICH,'mm/yyyy'),'mm/yyyy'), (p_erech_meushar+ Erech_253) ,13) ;  
                           AllResult := AllResult + approve_value*10;
                           if (approve_value<> 0) then 
                                RAISE KDS_GW_EXCEPTION ;
                            end if;
                       else
                            AllResult := AllResult + 300 ;
                            Egd_mafienim_New.Tipul_Mafienim@KDS_GW (approve_value,  to_char(p_MISPAR_ISHI),to_date(to_char(P_TAARICH,'mm/yyyy'),'mm/yyyy'),p_erech_meushar + Erech_143 ,14) ;  
                            AllResult := AllResult + approve_value*10;
                           if (approve_value<> 0) then 
                                RAISE KDS_GW_EXCEPTION ;
                            end if;
                           Egd_mafienim_New.Tipul_Mafienim@KDS_GW (approve_value,  to_char(p_MISPAR_ISHI),to_date(to_char(P_TAARICH,'mm/yyyy'),'mm/yyyy'),Erech_253,13) ;  
                           AllResult := AllResult + approve_value;
                          if (approve_value<> 0) then 
                                RAISE KDS_GW_EXCEPTION ;
                            end if;
                        end if ;

                        update TB_ISHURIM I set I.ERECH_MEUSHAR = p_ERECH_MEUSHAR, I.KOD_STATUS_ISHUR = 1 WHERE 
                        MISPAR_ISHI = P_MISPAR_ISHI AND KOD_ISHUR = p_kod_ishur AND TAARICH = p_TAARICH 
                        AND MISPAR_SIDUR = p_MISPAR_SIDUR AND  SHAT_HATCHALA = p_SHAT_HATCHALA AND SHAT_YETZIA = p_SHAT_YETZIA 
                        AND MISPAR_KNISA = p_MISPAR_KNISA AND RAMA = p_RAMA;
                       
                            if  (ApprovalDemandExist > 0)  then--    
                                 AllResult := AllResult + 1 ;
                                   DBMS_OUTPUT.PUT_LINE('(ApprovalDemandExist > 0 ) and ( p_kod_status_ishur =1) ');
                                      update TB_ISHURIM I set  I.erech_mevukash = p_ERECH_MEVUKASH  WHERE 
                                      MISPAR_ISHI = P_MISPAR_ISHI AND KOD_ISHUR = p_kod_ishur AND TAARICH = p_TAARICH 
                                      AND MISPAR_SIDUR = p_MISPAR_SIDUR AND  SHAT_HATCHALA = p_SHAT_HATCHALA AND SHAT_YETZIA = p_SHAT_YETZIA 
                                      AND MISPAR_KNISA = p_MISPAR_KNISA AND RAMA = 3;
                          elsif  (p_ERECH_MEVUKASH >0 ) then  
                                    AllResult := AllResult + 2 ;
                                           DBMS_OUTPUT.PUT_LINE('    ');
                                      insert into tb_ishurim (mispar_ishi, kod_ishur, taarich, mispar_sidur, shat_hatchala, shat_yetzia, mispar_knisa, 
                                                        rama, siba, kod_status_ishur, erech_mevukash, taarich_bakashat_ishur, gorem_measher_rashsi, gorem_measher_mishni)  values (
                                                        p_mispar_ishi,p_kod_ishur, p_taarich, p_mispar_sidur, p_shat_hatchala,p_shat_yetzia, p_mispar_knisa, 
                                                        3, p_siba, 0, p_ERECH_MEVUKASH,sysdate, 
                                                        case when P_MAINFACTOR= 0 then null else P_MAINFACTOR end  ,case when P_SECONDARYFACTOR = 0 then null else P_SECONDARYFACTOR end  ); 
                            end if ;
                        --end if ; 
                        p_Result := AllResult ;
              else -- ???? ?? ?????
                     DBMS_OUTPUT.PUT_LINE('????? ????? ??? ?????');
                     p_Result := 2;
                        update TB_ISHURIM I set I.KOD_STATUS_ISHUR = 2 , I.ERECH_MEUSHAR = 0    WHERE 
                        MISPAR_ISHI = P_MISPAR_ISHI AND KOD_ISHUR = p_kod_ishur AND TAARICH = p_TAARICH 
                        AND MISPAR_SIDUR = p_MISPAR_SIDUR AND  SHAT_HATCHALA = p_SHAT_HATCHALA AND SHAT_YETZIA = p_SHAT_YETZIA 
                        AND MISPAR_KNISA = p_MISPAR_KNISA AND RAMA = p_RAMA;
              end if ;
    
              if ((ApprovalDemandExist > 0) and 
                  ( (p_kod_status_ishur = 2  )  or  ( p_ERECH_MEUSHAR = Old_Erech_Mevukash ) )) then  -- ???? ???? ???? ?????? ??? ?? ????? ?? ???? ??? 
                     p_Result := 3;
                     DBMS_OUTPUT.PUT_LINE('(ApprovalDemandExist > 0  ( Old_Kod_Status_Ishur =2 or ( p_ERECH_MEVUKASH = p_ERECH_MEUSHAR ))');
                        delete TB_ISHURIM I  WHERE 
                        MISPAR_ISHI = P_MISPAR_ISHI AND KOD_ISHUR = p_kod_ishur AND TAARICH = p_TAARICH 
                        AND MISPAR_SIDUR = p_MISPAR_SIDUR AND  SHAT_HATCHALA = p_SHAT_HATCHALA AND SHAT_YETZIA = p_SHAT_YETZIA 
                        AND MISPAR_KNISA = p_MISPAR_KNISA AND RAMA = 3;
              end if ;
          else --   
                    AllResult:= 3000; 
                       if ( ((p_erech_meushar + Old_Erech_Meushar) > Erech_147 ) and ( Erech_147 > 0 )) then 
                           AllResult := AllResult + 100 ; 
                            Egd_mafienim_New.Tipul_Mafienim@KDS_GW (approve_value,  to_char(p_MISPAR_ISHI),to_date(to_char(P_TAARICH,'mm/yyyy'),'mm/yyyy'),Erech_147 + Erech_143 ,14) ;
                           AllResult := AllResult + approve_value*10;
                          if (approve_value<> 0) then 
                                RAISE KDS_GW_EXCEPTION ;
                            end if;
                           Egd_mafienim_New.Tipul_Mafienim@KDS_GW (approve_value,  to_char(p_MISPAR_ISHI),to_date(to_char(P_TAARICH,'mm/yyyy'),'mm/yyyy'),Erech_253 + ((p_erech_meushar+ Old_Erech_Meushar)- Erech_147) ,13) ;  
                           AllResult := AllResult + approve_value;
                          if (approve_value<> 0) then 
                                RAISE KDS_GW_EXCEPTION ;
                            end if;
                       elsif  (Erech_147 = 0 ) then 
                            AllResult := AllResult + 200 ;
                           Egd_mafienim_New.Tipul_Mafienim@KDS_GW( approve_value, to_char(p_MISPAR_ISHI),to_date(to_char(P_TAARICH,'mm/yyyy'),'mm/yyyy'), (p_erech_meushar+ Erech_253) ,13) ;  
                           AllResult := AllResult + approve_value*10;
                          if (approve_value<> 0) then 
                                RAISE KDS_GW_EXCEPTION ;
                            end if;
                       else
                            AllResult := AllResult + 300 ;
                           Egd_mafienim_New.Tipul_Mafienim@KDS_GW (approve_value,  to_char(p_MISPAR_ISHI),to_date(to_char(P_TAARICH,'mm/yyyy'),'mm/yyyy'),p_erech_meushar + Old_Erech_Meushar + Erech_143 ,14) ;  
                           AllResult := AllResult + approve_value;
                          if (approve_value<> 0) then 
                                RAISE KDS_GW_EXCEPTION ;
                            end if;
                           Egd_mafienim_New.Tipul_Mafienim@KDS_GW (approve_value,  to_char(p_MISPAR_ISHI),to_date(to_char(P_TAARICH,'mm/yyyy'),'mm/yyyy'),Erech_253,13) ;  
                           AllResult := AllResult + approve_value;
                          if (approve_value<> 0) then 
                                RAISE KDS_GW_EXCEPTION ;
                            end if;
                        end if ;
                    -- table of update datas 
                    -- select * from egd_mafien_erechim_people_new@KDS_GW 
                     p_Result := AllResult;
                        update TB_ISHURIM I set I.ERECH_MEUSHAR = p_ERECH_MEUSHAR, I.KOD_STATUS_ISHUR = p_kod_status_ishur WHERE 
                        MISPAR_ISHI = P_MISPAR_ISHI AND KOD_ISHUR = p_kod_ishur AND TAARICH = p_TAARICH 
                        AND MISPAR_SIDUR = p_MISPAR_SIDUR AND  SHAT_HATCHALA = p_SHAT_HATCHALA AND SHAT_YETZIA = p_SHAT_YETZIA 
                        AND MISPAR_KNISA = p_MISPAR_KNISA AND RAMA = p_RAMA;
          end if;
          
         EXCEPTION 
             WHEN KDS_GW_EXCEPTION THEN 
                         p_Result := AllResult;
             WHEN OTHERS THEN 
                  RAISE;           
end pro_upd_Hour_Aproval;



    PROCEDURE pro_get_SharedMonthly_Quota(p_mispar_ishi in ovdim.mispar_ishi% TYPE,p_Period in VARCHAR2,
    p_Quota OUT TB_MICHSA_AGAPIT .MICHSA_AGAPIT%type,
    p_SharedQuota out INTEGER) is
  v_MaxLimitDate Date ;
  v_MinLimitDate date ;
  BEGIN
    if (p_Period is null ) then
      v_MinLimitDate  := to_date('30-12-1899','dd/mm/yyyy');
      v_MaxLimitDate := to_date('30-12-2299','dd/mm/yyyy');
    else
      v_MinLimitDate := to_date('01/' || p_Period,'dd/mm/yyyy'); /* period= 05/2009=>  v_MinLimitDate = 01/05/2009 */
      v_MaxLimitDate := add_months(v_MinLimitDate,1) -1 ;    /* period= 05/2009=>  v_MaxLimitDate = 31/05/2009 */
    end if ;


         SELECT  MICHSA_AGAPIT   into p_Quota from TB_MICHSA_AGAPIT tb
          WHERE ((tb.Me_Taarich <=  v_MaxLimitDate ) and (tb.Ad_Taarich >= v_MinLimitDate or tb.Ad_Taarich is null )) and kod_agaf in (
          select distinct yechida_irgunit from tmp_pirtey_ovdim  o where o.mispar_ishi = p_mispar_ishi
          and
          (o.me_tarich <=  v_MaxLimitDate ) and (o.ad_tarich >= v_MinLimitDate or o.ad_tarich  is null ) )
          AND ROWNUM =1
          ORDER BY Me_Taarich DESC ;
          Select nvl(Sum(Erech_Meushar),0) INTO p_SharedQuota
          From TB_Ishurim
          Where Rama=2 And Kod_Ishur =35
          and to_char(taarich,'MM/YYYY') = p_period
          and mispar_ishi in
          (select distinct a.mispar_ishi                from (select * from ez_nihuly e,
        (select Mispar_Ishi,erech from Pirtey_Ovdim where  trunc(sysdate)>= Me_taarich and trunc(sysdate)<= Ad_taarich and  Kod_Natun=1) p
        where p.erech=e.yechida_mekorit) a
        CONNECT BY a.YECHIDAT_ABA  = PRIOR a.yechida_mekorit  START WITH a.YECHIDAT_ABA  =(Select Erech From Pirtey_Ovdim
        Where Mispar_Ishi= p_mispar_ishi  and trunc(sysdate)>= Me_taarich and trunc(sysdate)<= Ad_taarich and  Kod_Natun=1))  ;

    EXCEPTION
	WHEN NO_DATA_FOUND THEN
  p_Quota := 0;
  p_SharedQuota := 0 ;
  WHEN OTHERS THEN
            RAISE;
  END pro_get_SharedMonthly_Quota;

    PROCEDURE pro_get_Status_Isuk(p_mispar_ishi in ovdim.mispar_ishi% TYPE,p_Form in INTEGER, p_Month VARCHAR2,p_Result OUT INTEGER) is
    v_MaxLimitDate Date ;
  v_MinLimitDate date ;
  BEGIN
    if (p_Month is null ) then
      v_MinLimitDate :=sysdate;
    else
      v_MinLimitDate := to_date('01/' || p_Month,'dd/mm/yyyy'); /* period= 05/2009=>  v_MinLimitDate = 01/05/2009 */
    end if ;
      v_MaxLimitDate := add_months(v_MinLimitDate,1) -1 ;    /* period= 05/2009=>  v_MaxLimitDate = 31/05/2009 */

select case
          when ((o.isuk in (11 , 12 , 13 , 36)) and (o.snif_av in (72181 , 72184 , 78188 )) ) then 1 -- /   
          when ((o.isuk in (11 , 12 , 13 , 36)) and (o.snif_av not in (72181 , 72184 , 78188 ))) then
              case when  ( (o.isuk =36) and (o.snif_av = 80143 ) and (p_Form =2 ) ) then 4 -- 
              else 2-- --  /   
              end
          when (o.isuk not in (11 , 12 , 13 , 36)) then 3  --  /  
          else 0
          end INTO p_Result
from tmp_pirtey_ovdim O inner join ctb_isuk c on c.kod_isuk= o.isuk
where o.mispar_ishi=p_mispar_ishi
and  ((o.me_tarich <= to_date(v_MaxLimitDate,'dd/mm/yyyy') ) and (o.ad_tarich >= to_date(v_MinLimitDate,'dd/mm/yyyy') or o.ad_tarich is null ))
order by o.mispar_ishi, o.snif_av;

END pro_get_Status_Isuk;




PROCEDURE pro_get_tmp_pirtey_oved(p_mispar_ishi in ovdim.mispar_ishi%type, p_taarich in date,
 		   									 							p_cur out CurType) IS
BEGIN
	 OPEN p_cur FOR
	   	select po.*, i.KOD_SECTOR_ISUK
		  from tmp_Pirtey_Ovdim PO,CTB_Isuk i,ovdim o
		where 	po.mispar_ishi=p_mispar_ishi
		and po.mispar_ishi=o.mispar_ishi
		  and  trunc(p_taarich) Between  po.ME_TARICH  and   nvl(po.ad_TARICH,to_date('01/01/9999' ,'dd/mm/yyyy'))
		  And i.Kod_Hevra = o.kod_hevra
		 and  i.Kod_Isuk =po.isuk;

EXCEPTION
       WHEN OTHERS THEN
            RAISE;

END  pro_get_tmp_pirtey_oved;
FUNCTION fun_get_sug_yechida_oved(p_mispar_ishi in ovdim.mispar_ishi%type,
														p_taarich  in tmp_Pirtey_Ovdim.me_tarich%type) return ctb_yechida.SUG_YECHIDA%type as
	v_sug_yechida ctb_yechida.SUG_YECHIDA%type;
	 v_date_from date;
begin
	   v_date_from:=to_date('01/' || to_char(p_taarich,'mm/yyyy'),'dd/mm/yyyy');
		select y.SUG_YECHIDA into v_sug_yechida
		 from   (select max( po.ME_TARICH) me_taarich
					   from tmp_Pirtey_Ovdim PO
					     where 	po.mispar_ishi=p_mispar_ishi
					 and (v_date_from Between  po.ME_TARICH  and   nvl(po.ad_TARICH,to_date('01/01/9999' ,'dd/mm/yyyy'))
		or  trunc(p_taarich) Between  po.ME_TARICH  and   nvl(po.ad_TARICH,to_date('01/01/9999' ,'dd/mm/yyyy'))
		or   po.ME_TARICH>=v_date_from  and   nvl(po.ad_TARICH,to_date('01/01/9999' ,'dd/mm/yyyy'))<= trunc(p_taarich))) po,
		 	  tmp_Pirtey_Ovdim p,ovdim o,ctb_yechida y
		where o.mispar_ishi=p_mispar_ishi
		and o.mispar_ishi=p.mispar_ishi
		and  po.ME_TAARICH= p.ME_TARICH
		and y.KOD_HEVRA=o.KOD_HEVRA
		and y.KOD_YECHIDA=p.YECHIDA_IRGUNIT;

		return v_sug_yechida;

		 EXCEPTION
	       WHEN NO_DATA_FOUND THEN
		   		 return '';

end  fun_get_sug_yechida_oved;

PROCEDURE pro_get_merkaz_erua_ByKod (p_mispar_ishi in pirtey_ovdim.mispar_ishi%type,
                                   p_kod_natun in pirtey_ovdim.kod_natun%type,
								   p_taarich in pirtey_ovdim.ME_TAARICH%type,
                                   P_erech out pirtey_ovdim.erech%type)   IS

begin

       select e.KOD_MERKAZ_EROA_EZORI     into  P_erech
       from   pirtey_ovdim p , CTB_MERKAZ_EROA e
		where p.mispar_ishi =p_mispar_ishi and
			  	     p.kod_natun =p_kod_natun and
					 p_taarich between  p.ME_TAARICH and nvl(p.AD_TAARICH,to_date('30/12/4712','dd/mm/yyyy')) and
					 p.ERECH = e.KOD_MERKAZ_EROA ;

EXCEPTION
    WHEN NO_DATA_FOUND THEN
         P_erech := 0;
end pro_get_merkaz_erua_ByKod;

PROCEDURE pro_get_mikum_shaon_in_out(p_mispar_ishi in TB_SIDURIM_OVDIM.mispar_ishi%type,
                                     p_taarich in date ,
                                     p_mikum_shaon_knisa  out integer   ,
                                     p_mikum_shaon_yetzia out integer)  IS
begin

select nvl((select y.KOD_MIKUM_YECHIDA_EZORI
					from CTB_MIKUM_YECHIDA y,
								(select decode (t.rk1,1,MIKUM_SHAON_knisa,null) knisa
								  from  (
										        select   rank () over (order by SHAT_HATCHALA asc) rk1 ,
										        rank () over (order by SHAT_HATCHALA desc ) rk2,
										        MISPAR_ISHI ,MISPAR_SIDUR,SHAT_HATCHALA,SHAT_HATCHALA_LETASHLUM,SHAT_GMAR,SHAT_GMAR_LETASHLUM,MIKUM_SHAON_KNISA,MIKUM_SHAON_YETZIA,taarich
										        from TB_SIDURIM_OVDIM
										        where MISPAR_ISHi = p_mispar_ishi
										        and taarich =trunc(p_taarich) ) t
								 where  t.rk1=1 )k
					where substr(k.knisa,0,3) = y.KOD_MIKUM_YECHIDA),0) KNISA ,
		     nvl((select y.KOD_MIKUM_YECHIDA_EZORI
					from  CTB_MIKUM_YECHIDA y,
							  (select decode (t.rk2,1,MIKUM_SHAON_YETZIA,null) yezia
							   from (
									        select   rank () over (order by SHAT_HATCHALA asc) rk1 ,
									        rank () over (order by SHAT_HATCHALA desc ) rk2,
									        MISPAR_ISHI ,MISPAR_SIDUR,SHAT_HATCHALA,SHAT_HATCHALA_LETASHLUM,SHAT_GMAR,SHAT_GMAR_LETASHLUM,MIKUM_SHAON_KNISA,MIKUM_SHAON_YETZIA,taarich
									        from TB_SIDURIM_OVDIM
									        where MISPAR_ISHi = p_mispar_ishi
									        and taarich = trunc(p_taarich)  ) t
									        where  t.rk2=1)k
							    where substr(k.yezia,0,3) = y.KOD_MIKUM_YECHIDA),0) YEZIA
into  p_mikum_shaon_knisa, p_mikum_shaon_yetzia
from dual;

EXCEPTION
    when others         then
         p_mikum_shaon_knisa := 0;
         p_mikum_shaon_yetzia := 0;

end pro_get_mikum_shaon_in_out;

PROCEDURE pro_get_zman_nesiaa_mistane (p_merkaz_erua in CTB_ZMAN_NSIAA_MISHTANE.MERKAZ_ERUA%type,
                                       p_mikum_yaad  in CTB_ZMAN_NSIAA_MISHTANE.MIKUM_YAAD%type,
                                       p_taarich in date ,
                                       p_dakot   out integer)  IS

begin
    select DAKOT into p_dakot
        from CTB_ZMAN_NSIAA_MISHTANE
         where MERKAZ_ERUA =  p_merkaz_erua and
               MIKUM_YAAD  =  p_mikum_yaad  and
               ME_TAARICH  <= p_taarich     and
               AD_TAARICH  >= p_taarich;

EXCEPTION
    WHEN NO_DATA_FOUND THEN
         p_dakot := 0;

end pro_get_zman_nesiaa_mistane;

PROCEDURE pro_get_zman_nesiaa_ovdim (p_mispar_ishi in TB_YAMEY_AVODA_OVDIM.mispar_ishi%type,
                                     p_taarich in date ,
                                     p_zman_nesia_haloch  out integer   ,
                                     p_zman_nesia_hazor   out integer)  IS

begin
select sum(case ZMAN_NESIA_HALOCH  when  null then 0 else ZMAN_NESIA_HALOCH end) as  ZMAN_NESIA_HALOCH  ,
       sum(case ZMAN_NESIA_HAZOR   when  null then 0 else  ZMAN_NESIA_HAZOR end) as ZMAN_NESIA_HAZOR
       into p_zman_nesia_haloch , p_zman_nesia_hazor
        from TB_YAMEY_AVODA_OVDIM
      where MISPAR_ISHi = p_mispar_ishi  and
            TAARICH   = p_taarich ;


end pro_get_zman_nesiaa_ovdim ;

PROCEDURE pro_upd_zman_nesiaa (p_mispar_ishi in TB_YAMEY_AVODA_OVDIM.mispar_ishi%type,
                                     p_taarich in date ,
                                     p_zman_nesia_haloch  in integer   ,
                                     p_zman_nesia_hazor   in integer)  IS
begin
 update TB_YAMEY_AVODA_OVDIM
   SET  ZMAN_NESIA_HALOCH = p_ZMAN_NESIA_HALOCH ,
        ZMAN_NESIA_HAZOR  = p_ZMAN_NESIA_HAZOR
     where
            MISPAR_ISHi = p_MISPAR_ISHi and
            taarich =  p_taarich ;


end pro_upd_zman_nesiaa  ;


PROCEDURE pro_get_last_updator (p_mispar_ishi in TB_YAMEY_AVODA_OVDIM.mispar_ishi%type,
                                p_taarich in date ,
                                p_cur out CurType )  IS
begin

  OPEN  p_cur FOR
  		select UpdateDate,decode(mispar_ishi,-1,'',FullName) FullName,
		decode(mispar_ishi,-1,'',mispar_ishi) IDNUM
 from (select UpdateDate,O.SHEM_MISH || ' ' || O.SHEM_PRAT FullName , nvl(o.mispar_ishi,IdNum) mispar_ishi
  from
   ( select UpdateDate , case when (IdNum< 0) then -1 else IdNum end IdNum
    from
    (
      select a.TAARICH_IDKUN_ACHARON UpdateDate , a.MEADKEN_ACHARON IdNum
        from   TB_YAMEY_AVODA_OVDIM a
           where a.MISPAR_ISHI = p_mispar_ishi and   a.TAARICH = trunc(p_taarich)
    UNION
      select b.TAARICH_IDKUN_ACHARON UpdateDate , b.MEADKEN_ACHARON  IdNum
       from   TB_SIDURIM_OVDIM b
           where b.MISPAR_ISHI = p_mispar_ishi and   b.TAARICH = trunc(p_taarich)
    UNION
      select  c.TAARICH_IDKUN_ACHARON UpdateDate , c.MEADKEN_ACHARON  IdNum
       from   TB_PEILUT_OVDIM c
           where c.MISPAR_ISHI = p_mispar_ishi and   c.TAARICH = trunc(p_taarich)
    UNION
      select d.TAARICH_IDKUN_ACHARON UpdateDate , d.MEADKEN_ACHARON  IdNum
       from   TRAIL_YAMEY_AVODA_OVDIM d
           where d.MISPAR_ISHI = p_mispar_ishi and   d.TAARICH =   trunc(p_taarich)
    UNION
      select e.TAARICH_IDKUN_ACHARON UpdateDate , e.MEADKEN_ACHARON  IdNum
       from   TRAIL_SIDURIM_OVDIM e
           where e.MISPAR_ISHI = p_mispar_ishi and   e.TAARICH =  trunc(p_taarich)
    UNION
      select  f.TAARICH_IDKUN_ACHARON UpdateDate , f.MEADKEN_ACHARON  IdNum
       from    TRAIL_PEILUT_OVDIM f
        where f.MISPAR_ISHI = p_mispar_ishi and   f.TAARICH =  trunc(p_taarich)
		    )) x,
		Ovdim o
		where x.IdNum= o.mispar_ishi(+)
		)
order by  UpdateDate desc;


end  pro_get_last_updator ;

PROCEDURE pro_get_RECHIVIM(   p_cur OUT CurType)
  IS
begin
OPEN p_cur FOR

 select   KOD_RECHIV ,
        case
            when (KOD_RECHIV in (133 , 134 ))then
            '  +  '
            else TEUR_RECHIV
        end TEUR_RECHIV

    from  CTB_RECHIVIM
      where   KOD_RECHIV in (18,217) --23,52,105,133,134,217,214,215) -- ,216)
             order by KOD_RECHIV ;

end  pro_get_RECHIVIM ;

PROCEDURE pro_get_months_huavar_lesachar(p_mispar_ishi in TB_Yamey_Avoda_Ovdim.mispar_ishi%type,
														p_cur out CurType) is
	begin
	  open p_cur for
	  	select  to_char(taarich,'mm/yyyy') month_year from
		(select c.TAARICH
		from TB_bakashot b,tb_chishuv_chodesh_ovdim c
		where c.mispar_ishi=p_mispar_ishi
		and  b.HUAVRA_LESACHAR=1
		and b.BAKASHA_ID=c.bakasha_id
		group by c.TAARICH
		order by c.TAARICH desc)
		where rownum<15;

  EXCEPTION
       WHEN OTHERS THEN
				RAISE;
end  pro_get_months_huavar_lesachar;

PROCEDURE pro_save_employee_card(p_coll_yamey_avoda_ovdim in coll_yamey_avoda_ovdim,
                                 p_coll_sidurim_ovdim_upd in coll_sidurim_ovdim,
                                 p_coll_obj_peilut_ovdim  in coll_obj_peilut_ovdim,
                                 p_coll_sidurim_ovdim_ins in coll_sidurim_ovdim,
                                 p_coll_sidurim_ovdim_del in coll_sidurim_ovdim,
                                 p_coll_idkun_rashemet in coll_idkun_rashemet) IS
BEGIN

    --Update tb_yamey_avoda_ovdim
    BEGIN
        pkg_errors.pro_upd_yamey_avoda_ovdim(p_coll_yamey_avoda_ovdim);
     EXCEPTION
		 WHEN OTHERS THEN
              raise_application_error(-20001,'An error was encountered in tb_yamey_avoda_ovdim - '||SQLCODE||' -ERROR- '||SQLERRM);
    END;

    --Insert sidurim_ovdim
    BEGIN
        pkg_errors.pro_ins_sidurim_ovdim(p_coll_sidurim_ovdim_ins);
      EXCEPTION
         WHEN OTHERS THEN
            raise_application_error(-20001,'An error was encountered in insert to tb_sidurim_ovdim - '||SQLCODE||' -ERROR- '||SQLERRM);
    END;

    --update peiluyot
    BEGIN
        pro_upd_peilut_ovdim(p_coll_obj_peilut_ovdim);
      EXCEPTION
         WHEN OTHERS THEN
            raise_application_error(-20001,'An error was encountered in update to tb_peilut_ovdim - '||SQLCODE||' -ERROR- '||SQLERRM);
    END;

    --update siduriim ovdim
    BEGIN
       pro_upd_sidurim_ovdim(p_coll_sidurim_ovdim_upd);
      EXCEPTION
        WHEN OTHERS THEN
            raise_application_error(-20001,'An error was encountered in update to tb_sidurim_ovdim - '||SQLCODE||' -ERROR- '||SQLERRM);
    END;

    --delete sidurim
    BEGIN
        pkg_errors.pro_del_sidurim_ovdim(p_coll_sidurim_ovdim_del,1);
       EXCEPTION
         WHEN OTHERS THEN
            raise_application_error(-20001,'An error was encountered in delete in tb_sidurim_ovdim - '||SQLCODE||' -ERROR- '||SQLERRM);
    END;

     --insert field that changed to tb_idkun_rashemet
    BEGIN
        pro_ins_idkuney_rashemet(p_coll_idkun_rashemet);
       EXCEPTION
        WHEN OTHERS THEN
            raise_application_error(-20001,'An error was encountered in insert to tb_idkun_rashemet - '||SQLCODE||' -ERROR- '||SQLERRM);
    END;

END  pro_save_employee_card;
PROCEDURE pro_upd_peilut_ovdim(p_coll_obj_peilut_ovdim in coll_obj_peilut_ovdim) IS
BEGIN

     IF (p_coll_obj_peilut_ovdim is not null) THEN
         FOR i IN reverse 1..p_coll_obj_peilut_ovdim.COUNT LOOP
             IF (p_coll_obj_peilut_ovdim(i).update_object=1) THEN
                 pro_ins_peilut_ovdim_trail(p_coll_obj_peilut_ovdim(i),3);
                 pro_upd_peilut_oved(p_coll_obj_peilut_ovdim(i));
             END IF;

          END LOOP;
      END IF;

      EXCEPTION
         WHEN OTHERS THEN
              RAISE;
END pro_upd_peilut_ovdim;
PROCEDURE pro_upd_peilut_oved(p_obj_peilut_ovdim in obj_peilut_ovdim)
IS
BEGIN
     UPDATE TB_PEILUT_OVDIM
     SET kisuy_tor               = nvl( p_obj_peilut_ovdim.kisuy_tor,kisuy_tor),
         dakot_bafoal            = nvl(p_obj_peilut_ovdim.dakot_bafoal,dakot_bafoal),
         makat_nesia             = nvl( p_obj_peilut_ovdim.makat_nesia,makat_nesia),
         oto_no                  = nvl(p_obj_peilut_ovdim.oto_no,oto_no),
         shat_yetzia             = p_obj_peilut_ovdim.new_shat_yetzia,
         shat_hatchala_sidur     = p_obj_peilut_ovdim.new_shat_hatchala_sidur,
         --  mispar_sidur            = p_obj_peilut_ovdim.new_mispar_sidur,        
         --taarich_idkun_acharon   = p_obj_peilut_ovdim.taarich_idkun_acharon,
         taarich_idkun_acharon   = decode(trunc(p_obj_peilut_ovdim.taarich_idkun_acharon),to_date('01/01/0001','dd/mm/yyyy'),taarich_idkun_acharon,p_obj_peilut_ovdim.taarich_idkun_acharon),
         meadken_acharon         =nvl( p_obj_peilut_ovdim.meadken_acharon,meadken_acharon),
         bitul_o_hosafa          = nvl(p_obj_peilut_ovdim.bitul_o_hosafa,bitul_o_hosafa ) 
		 --mispar_siduri_oto=  nvl(p_obj_peilut_ovdim.mispar_siduri_oto ,mispar_siduri_oto) ,
		 --kod_shinuy_premia= nvl(p_obj_peilut_ovdim.kod_shinuy_premia,kod_shinuy_premia),
		--km_visa= nvl(p_obj_peilut_ovdim. km_visa, km_visa),
		--mispar_visa= nvl(p_obj_peilut_ovdim.mispar_visa,mispar_visa)
		-- snif_tnua =nvl( p_obj_peilut_ovdim.snif_tnua,snif_tnua)
     WHERE mispar_ishi           = p_obj_peilut_ovdim.mispar_ishi AND
           trunc(taarich)        = p_obj_peilut_ovdim.taarich AND
           mispar_sidur          = p_obj_peilut_ovdim.mispar_sidur AND
           shat_hatchala_sidur   = p_obj_peilut_ovdim.shat_hatchala_sidur AND
           shat_yetzia           = p_obj_peilut_ovdim.shat_yetzia AND
           mispar_knisa          = p_obj_peilut_ovdim.mispar_knisa;


    EXCEPTION
         WHEN OTHERS THEN
              RAISE;
END pro_upd_peilut_oved;
PROCEDURE pro_ins_peilut_ovdim_trail(p_obj_peilut_ovdim in obj_peilut_ovdim, p_sug_peula in trail_peilut_ovdim.sug_peula%type)
IS
BEGIN
    INSERT INTO TRAIL_PEILUT_OVDIM(mispar_ishi,taarich,mispar_sidur,
                                   shat_hatchala_sidur,shat_yetzia,mispar_knisa,
                                   makat_nesia,oto_no,mispar_siduri_oto,kisuy_tor,
                                   bitul_o_hosafa,kod_shinuy_premia,mispar_visa,imut_netzer,
                                   shat_bhirat_nesia_netzer,oto_no_netzer,mispar_sidur_netzer,
                                   shat_yetzia_netzer,makat_netzer,shilut_netzer,
                                   mikum_bhirat_nesia_netzer,mispar_matala,
                                   taarich_idkun_acharon,meadken_acharon,mispar_ishi_trail,
                                   taarich_idkun_trail,sug_peula,heara,snif_tnua,teur_nesia,dakot_bafoal,
								  km_visa  )
    SELECT mispar_ishi,taarich,mispar_sidur,
           shat_hatchala_sidur,shat_yetzia,mispar_knisa,
           makat_nesia,oto_no,mispar_siduri_oto,kisuy_tor,
           bitul_o_hosafa,kod_shinuy_premia,mispar_visa,imut_netzer,
           shat_bhirat_nesia_netzer,oto_no_netzer,mispar_sidur_netzer,
           shat_yetzia_netzer,makat_netzer,shilut_netzer,
           mikum_bhirat_nesia_netzer,mispar_matala,
           taarich_idkun_acharon,meadken_acharon,-2,sysdate, p_sug_peula,
           heara,snif_tnua,teur_nesia,dakot_bafoal ,km_visa

    FROM TB_PEILUT_OVDIM
    WHERE mispar_ishi           = p_obj_peilut_ovdim.mispar_ishi         AND
          taarich               = trunc(p_obj_peilut_ovdim.taarich)      AND
          mispar_sidur          = p_obj_peilut_ovdim.mispar_sidur        AND
          shat_hatchala_sidur   = p_obj_peilut_ovdim.shat_hatchala_sidur AND
          shat_yetzia           = p_obj_peilut_ovdim.shat_yetzia         AND
          mispar_knisa          = p_obj_peilut_ovdim.mispar_knisa;

EXCEPTION
         WHEN OTHERS THEN
              RAISE;
END pro_ins_peilut_ovdim_trail;
PROCEDURE pro_upd_sidurim_ovdim(p_coll_sidurim_ovdim in COLL_SIDURIM_OVDIM) IS
BEGIN

    IF (p_coll_sidurim_ovdim is not null) THEN
        FOR i IN 1..p_coll_sidurim_ovdim.COUNT LOOP
            IF (p_coll_sidurim_ovdim(i).update_object=1) THEN
                pro_ins_sidurim_ovdim_trail(p_coll_sidurim_ovdim(i),3);
                pro_upd_tb_sidur_oved(p_coll_sidurim_ovdim(i));
            END IF;
          END LOOP;
    END IF;
      EXCEPTION
         WHEN OTHERS THEN
              RAISE;
END pro_upd_sidurim_ovdim;

PROCEDURE pro_upd_tb_sidur_oved(p_obj_sidurim_ovdim in obj_sidurim_ovdim) IS
BEGIN
    --Insert sidurim
    UPDATE TB_SIDURIM_OVDIM
    SET lo_letashlum                 = p_obj_sidurim_ovdim.lo_letashlum,
        hashlama                     = p_obj_sidurim_ovdim.Hashlama,
      --  hamarat_shabat               = p_obj_sidurim_ovdim.hamarat_shabat,
        shat_hatchala                = p_obj_sidurim_ovdim.new_shat_hatchala,
        shat_gmar                    = nvl(p_obj_sidurim_ovdim.shat_gmar,null),
        mispar_ishi                  = p_obj_sidurim_ovdim.mispar_ishi,
        mispar_sidur                 = p_obj_sidurim_ovdim.new_mispar_sidur,
        chariga                      = p_obj_sidurim_ovdim.chariga,
        out_michsa                   = p_obj_sidurim_ovdim.out_michsa,
        shat_hatchala_letashlum      = p_obj_sidurim_ovdim.shat_hatchala_letashlum,
        shat_gmar_letashlum          = p_obj_sidurim_ovdim.shat_gmar_letashlum,
        mezake_nesiot                = p_obj_sidurim_ovdim.mezake_nesiot,
        mezake_halbasha              = p_obj_sidurim_ovdim.mezake_halbasha,
        taarich_idkun_acharon        = sysdate,
        meadken_acharon              = p_obj_sidurim_ovdim.meadken_acharon,
        kod_siba_ledivuch_yadani_out = p_obj_sidurim_ovdim.kod_siba_ledivuch_yadani_out,
        kod_siba_ledivuch_yadani_in  = p_obj_sidurim_ovdim.kod_siba_ledivuch_yadani_in,
        pitzul_hafsaka               = p_obj_sidurim_ovdim.pitzul_hafsaka,
        kod_siba_lo_letashlum        = p_obj_sidurim_ovdim.kod_siba_lo_letashlum,
        bitul_o_hosafa               = p_obj_sidurim_ovdim.bitul_o_hosafa,
        shat_hitiatzvut              = p_obj_sidurim_ovdim.shat_hitiatzvut,
        --yom_visa                     = p_obj_sidurim_ovdim.yom_visa,
        --achuz_knas_lepremyat_visa    = p_obj_sidurim_ovdim.achuz_knas_lepremyat_visa,
        --achuz_viza_besikun           = p_obj_sidurim_ovdim.achuz_viza_besikun,
        --mispar_musach_o_machsan      = p_obj_sidurim_ovdim.mispar_musach_o_machsan,
        --mispar_shiurey_nehiga        = p_obj_sidurim_ovdim.mispar_shiurey_nehiga,
        --sug_hazmanat_visa            = p_obj_sidurim_ovdim.sug_hazmanat_visa,
        --tafkid_visa                  = p_obj_sidurim_ovdim.tafkid_visa,
        --mivtza_visa                  = p_obj_sidurim_ovdim.mivtza_visa,
        heara                        = p_obj_sidurim_ovdim.heara,
        sug_hashlama                 = p_obj_sidurim_ovdim.sug_hashlama,
        mikum_shaon_knisa            = p_obj_sidurim_ovdim.mikum_shaon_knisa,
        mikum_shaon_yetzia           = p_obj_sidurim_ovdim.mikum_shaon_yetzia
    WHERE mispar_ishi  = p_obj_sidurim_ovdim.mispar_ishi AND
          mispar_sidur = p_obj_sidurim_ovdim.mispar_sidur AND
          taarich      = trunc(p_obj_sidurim_ovdim.taarich) AND
          shat_hatchala= p_obj_sidurim_ovdim.shat_hatchala;
EXCEPTION
         WHEN OTHERS THEN
              RAISE;
END pro_upd_tb_sidur_oved;
PROCEDURE pro_upd_sidur_oved(p_obj_sidurim_ovdim in obj_sidurim_ovdim) IS
BEGIN
    --Insert sidurim
    UPDATE TB_SIDURIM_OVDIM
    SET lo_letashlum                 =nvl( p_obj_sidurim_ovdim.lo_letashlum,lo_letashlum),
        hashlama                     = nvl(p_obj_sidurim_ovdim.Hashlama,  hashlama),
      --  hamarat_shabat               = p_obj_sidurim_ovdim.hamarat_shabat,
        shat_hatchala                = nvl(p_obj_sidurim_ovdim.new_shat_hatchala, shat_hatchala  ),
        shat_gmar                    =nvl( p_obj_sidurim_ovdim.shat_gmar,shat_gmar  ),
        mispar_ishi                  = nvl(p_obj_sidurim_ovdim.mispar_ishi,mispar_ishi),
        mispar_sidur                 = nvl(p_obj_sidurim_ovdim.new_mispar_sidur,mispar_sidur),
        chariga                      =nvl( p_obj_sidurim_ovdim.chariga,chariga),
        out_michsa                   = nvl(p_obj_sidurim_ovdim.out_michsa, out_michsa  ),
        shat_hatchala_letashlum      =nvl( p_obj_sidurim_ovdim.shat_hatchala_letashlum,shat_hatchala_letashlum),
        shat_gmar_letashlum          = nvl(p_obj_sidurim_ovdim.shat_gmar_letashlum,shat_gmar_letashlum),
        mezake_nesiot                = nvl(p_obj_sidurim_ovdim.mezake_nesiot,mezake_nesiot  ),
        mezake_halbasha              =nvl( p_obj_sidurim_ovdim.mezake_halbasha,mezake_halbasha),
        taarich_idkun_acharon        = sysdate,
        meadken_acharon          =nvl( p_obj_sidurim_ovdim.meadken_acharon,meadken_acharon),
        kod_siba_ledivuch_yadani_out =nvl( p_obj_sidurim_ovdim.kod_siba_ledivuch_yadani_out,kod_siba_ledivuch_yadani_out),
        kod_siba_ledivuch_yadani_in  = nvl( p_obj_sidurim_ovdim.kod_siba_ledivuch_yadani_in,kod_siba_ledivuch_yadani_in ),
        pitzul_hafsaka               =nvl( p_obj_sidurim_ovdim.pitzul_hafsaka,pitzul_hafsaka),
        kod_siba_lo_letashlum        = nvl(p_obj_sidurim_ovdim.kod_siba_lo_letashlum,kod_siba_lo_letashlum ),
        bitul_o_hosafa               = nvl( p_obj_sidurim_ovdim.bitul_o_hosafa,bitul_o_hosafa),
        shat_hitiatzvut              =nvl( p_obj_sidurim_ovdim.shat_hitiatzvut,shat_hitiatzvut),
		yom_visa  =nvl( p_obj_sidurim_ovdim.yom_visa,yom_visa),
		achuz_knas_lepremyat_visa =nvl( p_obj_sidurim_ovdim.achuz_knas_lepremyat_visa,achuz_knas_lepremyat_visa),
		achuz_viza_besikun=nvl(p_obj_sidurim_ovdim.achuz_viza_besikun,achuz_viza_besikun),
        mispar_musach_o_machsan    =nvl(p_obj_sidurim_ovdim.mispar_musach_o_machsan,mispar_musach_o_machsan),
		mispar_shiurey_nehiga= nvl(p_obj_sidurim_ovdim.mispar_shiurey_nehiga,mispar_shiurey_nehiga),
		sug_hazmanat_visa=nvl(p_obj_sidurim_ovdim.sug_hazmanat_visa,sug_hazmanat_visa),
		tafkid_visa=nvl(p_obj_sidurim_ovdim.tafkid_visa,tafkid_visa),
		mivtza_visa=nvl(p_obj_sidurim_ovdim. mivtza_visa,mivtza_visa),
		heara = nvl(p_obj_sidurim_ovdim.heara,heara),
        sug_hashlama = p_obj_sidurim_ovdim.sug_hashlama
    WHERE mispar_ishi  = p_obj_sidurim_ovdim.mispar_ishi AND
          mispar_sidur = p_obj_sidurim_ovdim.mispar_sidur AND
          taarich      = trunc(p_obj_sidurim_ovdim.taarich) AND
          shat_hatchala= p_obj_sidurim_ovdim.shat_hatchala;
EXCEPTION
         WHEN OTHERS THEN
              RAISE;
END pro_upd_sidur_oved;
PROCEDURE pro_ins_sidurim_ovdim_trail(p_obj_sidurim_ovdim in obj_sidurim_ovdim,p_sug_peula in trail_sidurim_ovdim.sug_peula%type) IS
BEGIN
    INSERT INTO TRAIL_SIDURIM_OVDIM (mispar_ishi,mispar_sidur,taarich,
                                    shat_hatchala,shat_gmar,shat_hatchala_letashlum,shat_gmar_letashlum,
                                    pitzul_hafsaka,chariga,tosefet_grira,hashlama,yom_visa,
                                    lo_letashlum,out_michsa,mikum_shaon_knisa,mikum_shaon_yetzia,
                                    achuz_knas_lepremyat_visa,achuz_viza_besikun,mispar_musach_o_machsan,
                                    kod_siba_lo_letashlum,kod_siba_ledivuch_yadani_in,kod_siba_ledivuch_yadani_out,
                                    meadken_acharon,taarich_idkun_acharon,heara,shayah_leyom_kodem,mispar_shiurey_nehiga,
                                    mispar_ishi_trail,taarich_idkun_trail,sug_peula,mezake_halbasha,mezake_nesiot,
									menahel_musach_meadken,sug_hazmanat_visa,tafkid_visa,mivtza_visa,nidreshet_hitiatzvut,
									ptor_mehitiatzvut,hachtama_beatar_lo_takin,hafhatat_nochechut_visa )
    SELECT mispar_ishi,mispar_sidur,taarich,
          shat_hatchala,shat_gmar,shat_hatchala_letashlum,shat_gmar_letashlum,
          pitzul_hafsaka,chariga,tosefet_grira,hashlama,yom_visa,
          lo_letashlum,out_michsa,mikum_shaon_knisa,mikum_shaon_yetzia,
          achuz_knas_lepremyat_visa,achuz_viza_besikun,mispar_musach_o_machsan,
          kod_siba_lo_letashlum,kod_siba_ledivuch_yadani_in,kod_siba_ledivuch_yadani_out,
          meadken_acharon,taarich_idkun_acharon,heara,shayah_leyom_kodem,mispar_shiurey_nehiga,
          -2,sysdate,p_sug_peula, mezake_halbasha,mezake_nesiot,
		  menahel_musach_meadken,sug_hazmanat_visa,tafkid_visa,mivtza_visa,nidreshet_hitiatzvut,
									ptor_mehitiatzvut,hachtama_beatar_lo_takin,hafhatat_nochechut_visa 
								
    FROM TB_SIDURIM_OVDIM
    WHERE mispar_ishi  = p_obj_sidurim_ovdim.mispar_ishi    AND
         mispar_sidur  = p_obj_sidurim_ovdim.mispar_sidur   AND
         taarich       = trunc(p_obj_sidurim_ovdim.taarich) AND
         shat_hatchala = p_obj_sidurim_ovdim.shat_hatchala;
EXCEPTION
         WHEN OTHERS THEN
              RAISE;
END  pro_ins_sidurim_ovdim_trail;

PROCEDURE pro_ins_yemey_avoda_leoved(p_mispar_ishi in tb_yamey_avoda_ovdim.mispar_ishi%type,
																	p_taarich in tb_yamey_avoda_ovdim.taarich%type,
																	p_measher_mistayeg in tb_yamey_avoda_ovdim.measher_o_mistayeg%type,
																	p_status in tb_yamey_avoda_ovdim.status_tipul%type,
																	p_meadken in tb_yamey_avoda_ovdim.meadken_acharon%type) IS
v_count number;
begin
	 		select count(*) into v_count
			from TB_YAMEY_AVODA_OVDIM
			where mispar_ishi=p_mispar_ishi
			and taarich=p_taarich;

	if (v_count=0) then
  	     INSERT INTO TB_YAMEY_AVODA_OVDIM
		   (mispar_ishi,taarich, measher_o_mistayeg,status_tipul,meadken_acharon,taarich_idkun_acharon,ritzat_shgiot_acharona)
			  values (p_mispar_ishi,p_taarich,p_measher_mistayeg,p_status,p_meadken,sysdate,to_date('01/01/0001','dd/mm/yyyy') );
	else
			  update  TB_YAMEY_AVODA_OVDIM
			  set ritzat_shgiot_acharona=to_date('01/01/0001','dd/mm/yyyy') 
			  where mispar_ishi=p_mispar_ishi
			and taarich=p_taarich;
	  end if;

  EXCEPTION
         WHEN OTHERS THEN
              RAISE;
END  pro_ins_yemey_avoda_leoved;

FUNCTION fun_get_count_yemey_avoda(p_mispar_ishi in  tb_yamey_avoda_ovdim.mispar_ishi%type,
														p_taarich_me  in  tb_yamey_avoda_ovdim.taarich%type,
														p_taarich_ad  in  tb_yamey_avoda_ovdim.taarich%type) return number as
	v_count number;
begin
	 		select count(*) into v_count
			from tb_yamey_avoda_ovdim y,tb_sidurim_ovdim s
			where y.mispar_ishi=p_mispar_ishi
			and y.taarich between p_taarich_me  and p_taarich_ad
			and y.mispar_ishi=s.mispar_ishi
			and y.taarich=s.taarich
			and (s.bitul_o_hosafa is null or s.bitul_o_hosafa<>1);

			return v_count;
  EXCEPTION
         WHEN OTHERS THEN
		      return 0;
              RAISE;
END   fun_get_count_yemey_avoda;


  PROCEDURE  pro_get_MisparIshiByKodVeErech (p_kod_Natun in integer  ,
  			 					   				   			  	                p_Erech in varchar2,
																				p_Taarich in date,
																				p_preFix in varchar2,
																				p_cur out CurType) IS
  BEGIN
      open p_cur for

  		  SELECT Distinct P.MISPAR_ISHI   ---,   O.SHEM_MISH || ' ' ||  O.SHEM_PRAT  FULL_NAME
		   FROM PIRTEY_OVDIM P -- ,
		   			--	OVDIM O
		   WHERE
		   		 	--		 P.MISPAR_ISHI = O.MISPAR_ISHI AND
		   		 			P.KOD_NATUN = p_kod_Natun AND
							P.ERECH = p_Erech AND
							p_Taarich between P.ME_TAARICH and P.AD_TAARICH AND
							( p_preFix is null OR P.MISPAR_ISHI Like p_preFix ||  '%'  )
		   ORDER BY P.MISPAR_ISHI;

	   EXCEPTION
		 WHEN OTHERS THEN
		      RAISE;
  END pro_get_MisparIshiByKodVeErech;

PROCEDURE pro_get_peiluyot_le_oved(p_mispar_ishi in  integer,
		  										 	 		 		 		  	  p_taarich in  TB_PEILUT_OVDIM.TAARICH%type,
																					  p_mispar_sidur in  integer,
																					p_shat_hatchala in  TB_PEILUT_OVDIM.SHAT_HATCHALA_SIDUR%type,
																					p_cur out CurType) IS
BEGIN
   			open p_cur for
				 select t.*,v_element.hova_mispar_rechev bus_number_must
				 from TB_PEILUT_OVDIM t,tmp_meafyeney_elementim v_element
				 where t.MISPAR_ISHI = p_mispar_ishi and
				 	   		  t.MISPAR_SIDUR = p_mispar_sidur and
							  t.TAARICH = trunc(p_taarich) and
							  t.SHAT_HATCHALA_SIDUR =p_shat_hatchala and
							 to_number(substr(t.makat_nesia,2,2)) = v_element.kod_element(+) and
                             p_taarich between v_element.me_tarich(+) and v_element.ad_tarich(+)
				order by t.SHAT_YETZIA;

	   EXCEPTION
		 WHEN OTHERS THEN
		      RAISE;
  END pro_get_peiluyot_le_oved;

PROCEDURE pro_upd_yamey_avoda_ovdim(p_coll_yamey_avoda_ovdim in coll_yamey_avoda_ovdim) IS
BEGIN
      IF (p_coll_yamey_avoda_ovdim is not null) THEN
          FOR i IN 1..p_coll_yamey_avoda_ovdim.COUNT LOOP
              IF (p_coll_yamey_avoda_ovdim(i).update_object=1) THEN
                --  pro_ins_yom_avoda_oved_trail(p_coll_yamey_avoda_ovdim(i));
                  pro_upd_yom_avoda_oved(p_coll_yamey_avoda_ovdim(i));
              END IF;
          END LOOP;
      END IF;
      EXCEPTION
		 WHEN OTHERS THEN
		      RAISE;
END pro_upd_yamey_avoda_ovdim;

PROCEDURE pro_upd_sadot_nosafim(p_coll_yamey_avoda_ovdim in coll_yamey_avoda_ovdim,
		  												 	p_coll_sidurim_ovdim in coll_sidurim_ovdim,
															p_coll_obj_peilut_ovdim in coll_obj_peilut_ovdim) IS
	 p_obj_yamey_avoda_ovdim obj_yamey_avoda_ovdim;
	p_obj_sidurim_ovdim obj_sidurim_ovdim;		
	p_obj_peilut_ovdim obj_peilut_ovdim;			
BEGIN
   IF (p_coll_yamey_avoda_ovdim is not null) THEN
          FOR i IN 1..p_coll_yamey_avoda_ovdim.COUNT LOOP
              IF (p_coll_yamey_avoda_ovdim(i).update_object=1) THEN
                  pkg_errors.pro_ins_yom_avoda_oved_trail(p_coll_yamey_avoda_ovdim(i));
                  
				  p_obj_yamey_avoda_ovdim:=p_coll_yamey_avoda_ovdim(i);
				  UPDATE TB_YAMEY_AVODA_OVDIM
			     SET lina  = p_obj_yamey_avoda_ovdim.lina,
			         meadken_acharon        =p_obj_yamey_avoda_ovdim.meadken_acharon,
			         taarich_idkun_acharon = sysdate
			     WHERE mispar_ishi     = p_obj_yamey_avoda_ovdim.mispar_ishi AND
			           taarich         = trunc(p_obj_yamey_avoda_ovdim.taarich);
              END IF;
          END LOOP;
      END IF;
	
	  IF (p_coll_sidurim_ovdim is not null) THEN
        FOR i IN 1..p_coll_sidurim_ovdim.COUNT LOOP
            IF (p_coll_sidurim_ovdim(i).update_object=1) THEN
                pro_ins_sidurim_ovdim_trail(p_coll_sidurim_ovdim(i),3);
              
			  p_obj_sidurim_ovdim :=p_coll_sidurim_ovdim(i);
			  	 UPDATE TB_SIDURIM_OVDIM
			    SET meadken_acharon          =p_obj_sidurim_ovdim.meadken_acharon,
			        yom_visa  =p_obj_sidurim_ovdim.yom_visa,
					achuz_knas_lepremyat_visa =p_obj_sidurim_ovdim.achuz_knas_lepremyat_visa,
					achuz_viza_besikun=p_obj_sidurim_ovdim.achuz_viza_besikun,
			        mispar_musach_o_machsan    =p_obj_sidurim_ovdim.mispar_musach_o_machsan,
					mispar_shiurey_nehiga= p_obj_sidurim_ovdim.mispar_shiurey_nehiga,
					sug_hazmanat_visa=p_obj_sidurim_ovdim.sug_hazmanat_visa,
					tafkid_visa=p_obj_sidurim_ovdim.tafkid_visa,
					mivtza_visa=p_obj_sidurim_ovdim. mivtza_visa,
					  taarich_idkun_acharon        = sysdate
			    WHERE mispar_ishi  = p_obj_sidurim_ovdim.mispar_ishi AND
			          mispar_sidur = p_obj_sidurim_ovdim.mispar_sidur AND
			          taarich      = trunc(p_obj_sidurim_ovdim.taarich) AND
			          shat_hatchala= p_obj_sidurim_ovdim.shat_hatchala;
            END IF;
          END LOOP;
    END IF;

	 IF (p_coll_obj_peilut_ovdim is not null) THEN
         FOR i IN 1..p_coll_obj_peilut_ovdim.COUNT LOOP
             IF (p_coll_obj_peilut_ovdim(i).update_object=1) THEN
                 pro_ins_peilut_ovdim_trail(p_coll_obj_peilut_ovdim(i),3);
               
			   p_obj_peilut_ovdim:=p_coll_obj_peilut_ovdim(i);
			     UPDATE TB_PEILUT_OVDIM
			     SET     taarich_idkun_acharon   = sysdate,
			         meadken_acharon         = p_obj_peilut_ovdim.meadken_acharon,
			        mispar_siduri_oto=  p_obj_peilut_ovdim.mispar_siduri_oto ,
					 kod_shinuy_premia= p_obj_peilut_ovdim.kod_shinuy_premia,
					km_visa= p_obj_peilut_ovdim. km_visa,
					mispar_visa= p_obj_peilut_ovdim.mispar_visa
				   WHERE mispar_ishi           = p_obj_peilut_ovdim.mispar_ishi AND
			           trunc(taarich)        = p_obj_peilut_ovdim.taarich AND
			           mispar_sidur          = p_obj_peilut_ovdim.mispar_sidur AND
			           shat_hatchala_sidur   = p_obj_peilut_ovdim.shat_hatchala_sidur AND
			           shat_yetzia           = p_obj_peilut_ovdim.shat_yetzia AND
			           mispar_knisa          = p_obj_peilut_ovdim.mispar_knisa;

             END IF;

          END LOOP;
      END IF;

      EXCEPTION
		 WHEN OTHERS THEN
		      RAISE;
END  pro_upd_sadot_nosafim;

PROCEDURE pro_upd_yom_avoda_oved(p_obj_yamey_avoda_ovdim in obj_yamey_avoda_ovdim) IS
BEGIN
     UPDATE TB_YAMEY_AVODA_OVDIM
     SET tachograf             = nvl(p_obj_yamey_avoda_ovdim.tachograf, tachograf ),
         halbasha              = nvl(p_obj_yamey_avoda_ovdim.halbasha,halbasha),
         lina                  = nvl(p_obj_yamey_avoda_ovdim.lina, lina ),
         hashlama_leyom        = nvl(p_obj_yamey_avoda_ovdim.hashlama_leyom,hashlama_leyom   ),
         bitul_zman_nesiot     = nvl(p_obj_yamey_avoda_ovdim.bitul_zman_nesiot,bitul_zman_nesiot  ),
         meadken_acharon        =nvl( p_obj_yamey_avoda_ovdim.meadken_acharon,meadken_acharon),
         zman_nesia_haloch     = nvl(p_obj_yamey_avoda_ovdim.zman_nesia_haloch,zman_nesia_haloch),
         zman_nesia_hazor      = nvl(p_obj_yamey_avoda_ovdim.zman_nesia_hazor,zman_nesia_hazor),
         sibat_hashlama_leyom  = nvl(p_obj_yamey_avoda_ovdim.sibat_hashlama_leyom,sibat_hashlama_leyom),
         taarich_idkun_acharon = sysdate
     WHERE mispar_ishi     = p_obj_yamey_avoda_ovdim.mispar_ishi AND
           taarich         = trunc(p_obj_yamey_avoda_ovdim.taarich);
EXCEPTION
		 WHEN OTHERS THEN
		      RAISE;
END pro_upd_yom_avoda_oved;

PROCEDURE pro_ins_idkuney_rashemet(p_coll_idkun_rashemet in coll_idkun_rashemet) IS
BEGIN
      IF (p_coll_idkun_rashemet is not null) THEN
          FOR i IN 1..p_coll_idkun_rashemet.COUNT LOOP
               if (p_coll_idkun_rashemet(i).NEW_SHAT_HATCHALA=p_coll_idkun_rashemet(i).SHAT_HATCHALA) then                  
                  if (p_coll_idkun_rashemet(i).NEW_SHAT_YETZIA<>p_coll_idkun_rashemet(i).SHAT_YETZIA) then
                      pro_upd_idkun_rashemet_peilut(p_coll_idkun_rashemet(i));                     
                  end if;
                  pro_ins_idkun_rashemet(p_coll_idkun_rashemet(i));
                 else
                   pro_upd_idkun_rashemet(p_coll_idkun_rashemet(i)); 
                   if (p_coll_idkun_rashemet(i).update_object=1) then
                        pro_ins_idkun_rashemet(p_coll_idkun_rashemet(i));
                   end if;                    
               end if;   
          END LOOP;
      END IF;
    EXCEPTION
         WHEN OTHERS THEN
              RAISE;
END pro_ins_idkuney_rashemet;
PROCEDURE pro_ins_idkun_rashemet(p_obj_idkun_rashemet in obj_idkun_rashemet) is
BEGIN
     INSERT INTO TB_IDKUN_RASHEMET (mispar_ishi,
                                    taarich,
                                    mispar_sidur,
                                    shat_hatchala,
                                    shat_yetzia,
                                    mispar_knisa,
                                    taarich_idkun,
                                    pakad_id,
                                    gorem_meadken)
     VALUES (p_obj_idkun_rashemet.mispar_ishi,
             p_obj_idkun_rashemet.taarich,
             p_obj_idkun_rashemet.mispar_sidur,
             p_obj_idkun_rashemet.new_shat_hatchala,
             p_obj_idkun_rashemet.new_shat_yetzia,
             p_obj_idkun_rashemet.mispar_knisa,
             sysdate,
             p_obj_idkun_rashemet.pakad_id,
             p_obj_idkun_rashemet.gorem_meadken);
EXCEPTION
    WHEN DUP_VAL_ON_INDEX THEN
        RETURN;
    WHEN OTHERS THEN
            RAISE;  
        
END pro_ins_idkun_rashemet;
PROCEDURE pro_upd_idkun_rashemet(p_obj_idkun_rashemet in obj_idkun_rashemet) IS
BEGIN
    UPDATE TB_IDKUN_RASHEMET 
    SET mispar_sidur    = p_obj_idkun_rashemet.mispar_sidur,
        shat_hatchala   = p_obj_idkun_rashemet.new_shat_hatchala
       -- shat_yetzia     = p_obj_idkun_rashemet.new_shat_yetzia,
       -- mispar_knisa    = p_obj_idkun_rashemet.mispar_knisa--,
       -- taarich_idkun   = sysdate,
       -- pakad_id        = p_obj_idkun_rashemet.pakad_id
    WHERE
        mispar_ishi     = p_obj_idkun_rashemet.mispar_ishi AND 
        taarich         = p_obj_idkun_rashemet.taarich AND                                
        mispar_sidur    = p_obj_idkun_rashemet.mispar_sidur AND
        shat_hatchala   = p_obj_idkun_rashemet.shat_hatchala; 
      --  shat_yetzia     = p_obj_idkun_rashemet.shat_yetzia AND
      --  mispar_knisa    = p_obj_idkun_rashemet.mispar_knisa;                                                               
                                    
    
EXCEPTION    
    WHEN OTHERS THEN
            RAISE;  
END pro_upd_idkun_rashemet;
PROCEDURE pro_upd_idkun_rashemet_peilut(p_obj_idkun_rashemet in obj_idkun_rashemet) IS
BEGIN
    UPDATE TB_IDKUN_RASHEMET 
    SET shat_yetzia    = p_obj_idkun_rashemet.new_shat_yetzia        
    WHERE
        mispar_ishi     = p_obj_idkun_rashemet.mispar_ishi AND 
        taarich         = p_obj_idkun_rashemet.taarich AND                     
        mispar_sidur    = p_obj_idkun_rashemet.mispar_sidur AND        
        shat_hatchala   = p_obj_idkun_rashemet.shat_hatchala AND
        shat_yetzia     = p_obj_idkun_rashemet.shat_yetzia; 
EXCEPTION    
    WHEN OTHERS THEN
            RAISE;    
END pro_upd_idkun_rashemet_peilut;
PROCEDURE pro_get_pirtey_hitkashrut_oved(p_mispar_ishi in ovdim.mispar_ishi%type,
 		   									 							p_cur out CurType) IS
BEGIN

	 OPEN p_cur FOR
		Select o.KTOVET,o.TELEFON_AVODA,o.TELEFON_BAIT,o.TELEFON_NAID,o.EMAIL
		from Ovdim o
		where o.MISPAR_ISHI = p_mispar_ishi ;

EXCEPTION
       WHEN OTHERS THEN
            RAISE;
 END pro_get_pirtey_hitkashrut_oved;
PROCEDURE pro_get_idkuney_rashemet(p_mispar_ishi in ovdim.mispar_ishi%type,p_taarich in tb_yamey_avoda_ovdim.taarich%type,p_cur out CurType) IS
BEGIN
    OPEN p_cur FOR
    SELECT * FROM TB_IDKUN_RASHEMET
    WHERE mispar_ishi = p_mispar_ishi
    AND taarich =  p_taarich;
EXCEPTION
       WHEN OTHERS THEN
            RAISE;
END  pro_get_idkuney_rashemet;
PROCEDURE pro_get_meadken_acharon(p_mispar_ishi in ovdim.mispar_ishi%type,p_date in tb_yamey_avoda_ovdim.taarich%type,p_cur out CurType) is
BEGIN

     --Get maximun table/trail  last update
    open p_cur for
                
            SELECT a.TAARICH_IDKUN_ACHARON ,a.MEADKEN_ACHARON           
            FROM tb_yamey_avoda_ovdim a
              WHERE a.MISPAR_ISHI= p_mispar_ishi
                    and a.TAARICH = p_date
                    and MEADKEN_ACHARON > 0 
                    and MEADKEN_ACHARON <> p_mispar_ishi

            union

            SELECT a.TAARICH_IDKUN_ACHARON ,a.MEADKEN_ACHARON           
            FROM tb_sidurim_ovdim a
              WHERE a.MISPAR_ISHI= p_mispar_ishi
                    and a.TAARICH = p_date
                    and MEADKEN_ACHARON > 0 
                    and MEADKEN_ACHARON <> p_mispar_ishi

            union


            SELECT a.TAARICH_IDKUN_ACHARON ,a.MEADKEN_ACHARON           
            FROM tb_peilut_ovdim a
              WHERE a.MISPAR_ISHI= p_mispar_ishi
                    and a.TAARICH = p_date
                    and MEADKEN_ACHARON > 0 
                    and MEADKEN_ACHARON <> p_mispar_ishi

            UNION

            SELECT a.TAARICH_IDKUN_TRAIL ,a.MEADKEN_ACHARON           
            FROM trail_yamey_avoda_ovdim a
              WHERE a.MISPAR_ISHI= p_mispar_ishi
                    and a.TAARICH = p_date
                    and MEADKEN_ACHARON > 0 
                    and MEADKEN_ACHARON <> p_mispar_ishi

            UNION

            SELECT a.TAARICH_IDKUN_TRAIL ,a.MEADKEN_ACHARON           
            FROM trail_sidurim_ovdim a
              WHERE a.MISPAR_ISHI= p_mispar_ishi
                    and a.TAARICH = p_date
                    and MEADKEN_ACHARON > 0 
                    and MEADKEN_ACHARON <> p_mispar_ishi
            UNION

            SELECT a.TAARICH_IDKUN_TRAIL ,a.MEADKEN_ACHARON           
            FROM trail_peilut_ovdim a
              WHERE a.MISPAR_ISHI= p_mispar_ishi
                    and a.TAARICH = p_date
                    and MEADKEN_ACHARON > 0 
                    and MEADKEN_ACHARON <> p_mispar_ishi;
            

        
        /*  union

      SELECT TAARICH_IDKUN_TRAIL ,MEADKEN_ACHARON
        FROM (
          SELECT a.TAARICH_IDKUN_TRAIL ,a.MEADKEN_ACHARON,
          MAX(TAARICH_IDKUN_TRAIL) OVER (PARTITION BY mispar_ishi,TAARICH) AS rmax_date
          FROM trail_yamey_avoda_ovdim a
          where a.MISPAR_ISHI= p_mispar_ishi
                and a.TAARICH = p_date)
        WHERE TAARICH_IDKUN_TRAIL = rmax_date


        union

        SELECT TAARICH_IDKUN_TRAIL ,MEADKEN_ACHARON
        FROM (
          SELECT a.TAARICH_IDKUN_TRAIL ,a.MEADKEN_ACHARON,
          MAX(TAARICH_IDKUN_TRAIL) OVER (PARTITION BY mispar_ishi,TAARICH) AS rmax_date
          FROM trail_sidurim_ovdim a
          where a.MISPAR_ISHI= p_mispar_ishi
                and a.TAARICH = p_date)
        WHERE TAARICH_IDKUN_TRAIL = rmax_date

        union

        SELECT FIRST_VALUE(TAARICH_IDKUN_TRAIL) OVER () as TAARICH_IDKUN_TRAIL
               ,MEADKEN_ACHARON
        FROM (
          SELECT (po.TAARICH_IDKUN_TRAIL) , po.MEADKEN_ACHARON, mispar_ishi,TAARICH,
          MAX(TAARICH_IDKUN_TRAIL) OVER () AS rmax_date
          FROM trail_peilut_ovdim po
          where po.MISPAR_ISHI= p_mispar_ishi
                and po.TAARICH = p_date)
        WHERE TAARICH_IDKUN_TRAIL = rmax_date)*/

EXCEPTION
         WHEN OTHERS THEN
              RAISE;
END pro_get_meadken_acharon;

PROCEDURE pro_update_measher_o_mistayeg(p_mispar_ishi in ovdim.mispar_ishi%type,p_date in tb_yamey_avoda_ovdim.taarich%type, p_status in tb_yamey_avoda_ovdim.measher_o_mistayeg%type) is
BEGIN
    UPDATE tb_yamey_avoda_ovdim
    SET MEASHER_O_MISTAYEG = p_status
    WHERE MISPAR_ISHI = p_mispar_ishi
    AND TAARICH = p_date;
EXCEPTION
         WHEN OTHERS THEN
              RAISE;

END pro_update_measher_o_mistayeg;


PROCEDURE pro_get_oved_details_betkufa(p_mispar_ishi in ovdim.mispar_ishi%type,
		  											 						   		      p_start_date in date,p_end_date  in date, p_cur out CurType )
IS
BEGIN
        OPEN p_Cur FOR
		 select distinct  o.shem_mish || ' ' || o.shem_prat full_name,
		               s.teur_snif_av,s.kod_snif_av, ma.teur_maamad_hr,
		               ma.kod_maamad_hr, ez.kod_ezor, ez.teur_ezor,
		               ck.teur_isuk, ch.teur_hevra
		        from  ovdim o,ctb_snif_av s,ctb_maamad ma,ctb_ezor ez, tmp_pirtey_ovdim  po,
		              ctb_isuk ck, ctb_hevra ch          ,
					    (select t.mispar_ishi,max(t.ME_TARICH) me_taarich
							   from tmp_Pirtey_Ovdim t
							   where t.isuk is not null
								     and (trunc(p_start_date) Between  t.ME_TARICH  and   nvl(t.ad_TARICH,to_date('01/01/9999' ,'dd/mm/yyyy'))
							 		  or    trunc(p_end_date) Between t.ME_TARICH  and   nvl(t.ad_TARICH,to_date('01/01/9999' ,'dd/mm/yyyy'))
							  		  or  t.ME_TARICH>= trunc(p_start_date) and   nvl(t.ad_TARICH,to_date('01/01/9999' ,'dd/mm/yyyy'))<=  trunc(p_end_date) )
									  and t.MISPAR_ISHI = p_mispar_ishi
							  group by t.mispar_ishi) p
		        where po.mispar_ishi = p.mispar_ishi and
		              po.me_tarich = p.me_taarich and
				     o.mispar_ishi= p_mispar_ishi and
		              po.mispar_ishi= o.mispar_ishi and
		              s.kod_hevra = ez.kod_hevra and
		              s.kod_snif_av = po.snif_av and
		              ma.kod_maamad_hr = po.maamad and
		              ez.kod_ezor = s.ezor and
		              ck.KOD_HEVRA = o.KOD_HEVRA and
		              ck.KOD_ISUK = po.ISUK and
		              ch.KOD_HEVRA =o.KOD_HEVRA and
					  o.mispar_ishi =p.mispar_ishi ;
EXCEPTION
         WHEN OTHERS THEN
              RAISE;

END pro_get_oved_details_betkufa;

PROCEDURE	pro_get_ovdim_to_period_ByCode(p_code in  number,p_start_date in date,
												  	  					  	 	  		  			  p_end_date  in date, p_cur out CurType )is
BEGIN
        OPEN p_Cur FOR
			 select y.MISPAR_ISHI,y.TAARICH
			 from tb_yamey_avoda_ovdim y,
			           MEAFYENIM_OVDIM m
			 where y.MISPAR_ISHI = m.MISPAR_ISHI
			 	   		and  m.KOD_MEAFYEN = p_code
						and y.TAARICH between p_start_date and p_end_date;

EXCEPTION
         WHEN OTHERS THEN
              RAISE;

END pro_get_ovdim_to_period_ByCode;
PROCEDURE pro_save_measher_O_mistayeg(p_mispar_ishi in ovdim.mispar_ishi%type,p_date in tb_yamey_avoda_ovdim.taarich%type,p_status number) IS
BEGIN
    UPDATE tb_yamey_avoda_ovdim
    SET MEASHER_O_MISTAYEG = p_status
    WHERE MISPAR_ISHI = p_mispar_ishi
    AND TAARICH = p_date;
EXCEPTION
         WHEN OTHERS THEN
              RAISE;
END  pro_save_measher_O_mistayeg;
PROCEDURE pro_get_pakad_id(p_masach_id in tb_masach.masach_id%type,  p_cur out CurType) is
BEGIN
    OPEN p_cur FOR
    SELECT pakad_id, shem_db 
    FROM TB_MASACH M
    WHERE M.MASACH_ID = p_masach_id;
   
EXCEPTION
         WHEN OTHERS THEN
              RAISE;
     
END pro_get_pakad_id;
FUNCTION fun_is_card_exists_yemey_avoda(p_mispar_ishi in  tb_yamey_avoda_ovdim.mispar_ishi%type,
                                        p_taarich  in  tb_yamey_avoda_ovdim.TAARICH%type) return number AS

v_count number;
BEGIN
        select count(*) into v_count
        from tb_yamey_avoda_ovdim y
        where y.mispar_ishi=p_mispar_ishi
        and y.taarich = trunc(p_taarich);
            
        return v_count;
  EXCEPTION
         WHEN OTHERS THEN
              return 0;
              RAISE;
END  fun_is_card_exists_yemey_avoda;           

FUNCTION fun_check_peilut_exist(p_mispar_sidur in tb_peilut_ovdim.mispar_sidur%type,
		 									   p_mispar_ishi in  tb_peilut_ovdim.mispar_ishi%type,
		 									  p_shat_hatchala in  tb_peilut_ovdim.shat_hatchala_sidur%type,
											 p_shat_yezia in  tb_peilut_ovdim.shat_yetzia%type ) return number    AS

v_count number;
BEGIN
      
		select count(*)  into v_count
		from TB_PEILUT_OVDIM p
		where p.MISPAR_ISHI =p_mispar_ishi 
		and p.MISPAR_SIDUR = p_mispar_sidur
		--   and p.TAARICH = to_date('08/03/2010','dd/mm/yyyy')
		   and p.SHAT_HATCHALA_SIDUR  =p_shat_hatchala --  to_date('08/03/2010 06:24:00 ','dd/mm/yyyy HH24:mi:ss')
		   and p.SHAT_YETZIA =p_shat_yezia; -- to_date('08/03/2010 17:23:00 ','dd/mm/yyyy HH24:mi:ss')
            
        return v_count;
  EXCEPTION
         WHEN OTHERS THEN
              return 0;
              RAISE;
END fun_check_peilut_exist;
       
FUNCTION fun_check_sidur_exist(p_mispar_sidur in tb_sidurim_ovdim.mispar_sidur%type,
		 									  	 					 p_mispar_ishi in  tb_sidurim_ovdim.mispar_ishi%type,
		 									                         p_shat_hatchala in  tb_sidurim_ovdim.shat_hatchala%type ) return number    AS

v_count number;
BEGIN
      
		select count(*)  into v_count
		from TB_SIDURIM_OVDIM s
		where s.MISPAR_ISHI =p_mispar_ishi 
		  and s.MISPAR_SIDUR = p_mispar_sidur
		   and s.SHAT_HATCHALA  =p_shat_hatchala ;
		
        return v_count;
  EXCEPTION
         WHEN OTHERS THEN
              return 0;
              RAISE;
END fun_check_sidur_exist;      

PROCEDURE pro_del_knisot_peilut( p_mispar_ishi in  tb_peilut_ovdim.mispar_ishi%type,
		 									 p_mispar_sidur in tb_peilut_ovdim.mispar_sidur%type,
											 p_taarich in  tb_peilut_ovdim.taarich%type,
		 									   p_shat_hatchala in  tb_peilut_ovdim.shat_hatchala_sidur%type,
											 p_shat_yezia in  tb_peilut_ovdim.shat_yetzia%type,
											 p_makat_nesia in  tb_peilut_ovdim.makat_nesia%type) IS
BEGIN
	  INSERT INTO TRAIL_PEILUT_OVDIM(mispar_ishi,taarich,mispar_sidur,
                                   shat_hatchala_sidur,shat_yetzia,mispar_knisa,
                                   makat_nesia,oto_no,mispar_siduri_oto,kisuy_tor,
                                   bitul_o_hosafa,kod_shinuy_premia,mispar_visa,imut_netzer,
                                   shat_bhirat_nesia_netzer,oto_no_netzer,mispar_sidur_netzer,
                                   shat_yetzia_netzer,makat_netzer,shilut_netzer,
                                   mikum_bhirat_nesia_netzer,mispar_matala,
                                   taarich_idkun_acharon,meadken_acharon,mispar_ishi_trail,
                                   taarich_idkun_trail,sug_peula,heara,snif_tnua,teur_nesia)
    SELECT mispar_ishi,taarich,mispar_sidur,
           shat_hatchala_sidur,shat_yetzia,mispar_knisa,
           makat_nesia,oto_no,mispar_siduri_oto,kisuy_tor,
           bitul_o_hosafa,kod_shinuy_premia,mispar_visa,imut_netzer,
           shat_bhirat_nesia_netzer,oto_no_netzer,mispar_sidur_netzer,
           shat_yetzia_netzer,makat_netzer,shilut_netzer,
           mikum_bhirat_nesia_netzer,mispar_matala,
           taarich_idkun_acharon,meadken_acharon,-2,sysdate,3,
           heara,snif_tnua,teur_nesia

    FROM TB_PEILUT_OVDIM
     WHERE    mispar_ishi =p_mispar_ishi 
	    AND taarich  = p_taarich
		AND mispar_sidur = p_mispar_sidur
		AND shat_hatchala_sidur = p_shat_hatchala
		AND shat_yetzia= p_shat_yezia
		AND  mispar_knisa >0
		 AND makat_nesia=p_makat_nesia;

        DELETE TB_PEILUT_OVDIM
        WHERE    mispar_ishi =p_mispar_ishi 
	    AND taarich  = p_taarich
		AND mispar_sidur = p_mispar_sidur
		AND shat_hatchala_sidur = p_shat_hatchala
		AND shat_yetzia= p_shat_yezia
		AND  mispar_knisa >0
		 AND makat_nesia=p_makat_nesia;
			   
		EXCEPTION
         WHEN OTHERS THEN
              RAISE;	   
END  pro_del_knisot_peilut;
           
PROCEDURE pro_del_hachanot_mechona( p_mispar_ishi in  tb_peilut_ovdim.mispar_ishi%type,
		 									 p_mispar_sidur in tb_peilut_ovdim.mispar_sidur%type,
											 p_taarich in  tb_peilut_ovdim.taarich%type,
		 									   p_shat_hatchala in  tb_peilut_ovdim.shat_hatchala_sidur%type) IS
BEGIN
	  DELETE TB_PEILUT_OVDIM
        WHERE    mispar_ishi =p_mispar_ishi 
	    AND taarich  = p_taarich
		AND mispar_sidur = p_mispar_sidur
		AND shat_hatchala_sidur = p_shat_hatchala
		AND  to_number(substr(makat_nesia,0,3)) in (701,711,712);
			   
		EXCEPTION
         WHEN OTHERS THEN
              RAISE;	   
END  pro_del_hachanot_mechona;  

function func_get_mispar_tachana(p_mispar_ishi in  tb_peilut_ovdim.mispar_ishi%type,
                                     p_mispar_sidur in tb_peilut_ovdim.mispar_sidur%type,
                                     p_taarich in  tb_peilut_ovdim.taarich%type,
                                     p_shat_hatchala in  tb_peilut_ovdim.shat_hatchala_sidur%type) return varchar2 as
 v_tachana varchar2(10);
 v_snif_tnua number;
 v_oto_num number;
 begin
    if substr(lpad(p_mispar_sidur,5,'0'),0,2)<>'99' then
        v_tachana:=substr(lpad(p_mispar_sidur,5,'0'),0,2);     
    else
        begin 
            Select SNIF_TNUA into v_snif_tnua
            From CTB_SNIF_AV sa,TMP_PIRTEY_OVDIM po , ovdim o
            Where SA.KOD_SNIF_AV = PO.SNIF_AV
            And sa.KOD_HEVRA = o.KOD_HEVRA
            and PO.MISPAR_ISHI=p_mispar_ishi
            and trunc(p_taarich,'MM') between PO.ME_TARICH and nvl(PO.AD_TARICH,p_taarich+1)  
            and PO.MISPAR_ISHI=O.MISPAR_ISHI;  
        
            EXCEPTION
                WHEN NO_DATA_FOUND THEN  v_snif_tnua:=null;
        end;
       
        if v_snif_tnua is not null then 
            v_tachana:=to_char(v_snif_tnua);
        else
            begin
                select po.OTO_NO into v_oto_num
                from TB_PEILUT_OVDIM po
                where PO.MISPAR_ISHI=p_mispar_ishi
                    and PO.TAARICH=p_taarich
                    and PO.MISPAR_SIDUR=p_mispar_sidur
                    and p_shat_hatchala=p_shat_hatchala
                    and PO.OTO_NO is not null
                 order by PO.SHAT_YETZIA;
                 
                 select substr(Branch2,3,2) into v_tachana  
                 from VCL_GENERAL_VEHICLE_VIEW@kds2maale 
                 where bus_number=v_oto_num;
                
                EXCEPTION
                WHEN NO_DATA_FOUND THEN  v_tachana:='00';
            end; 
                                   
        end if;  
       
    end if;
 
    return v_tachana;
end func_get_mispar_tachana;

PROCEDURE pro_get_arachim_by_misIshi( p_mispar_ishi in  pirtey_ovdim.mispar_ishi%type,
																				        p_taarich in pirtey_ovdim.me_taarich%type,
																	                    p_cur out CurType) is
BEGIN
    OPEN p_cur FOR
    SELECT p.KOD_NATUN, p.ERECH
    FROM PIRTEY_OVDIM p
    WHERE p.MISPAR_ISHI = p_mispar_ishi and
					p_taarich between p.ME_TAARICH and p.AD_TAARICH;
   
EXCEPTION
         WHEN OTHERS THEN
              RAISE;
     
END pro_get_arachim_by_misIshi;
	
function func_get_erech_by_kod_natun(p_mispar_ishi in  pirtey_ovdim.mispar_ishi%type,
										                                     p_kod_natun in pirtey_ovdim.kod_natun%type,
										                                     p_taarich in  pirtey_ovdim.me_taarich%type  ) return varchar2 is
		 v_erech varchar2(60);																	 
BEGIN
	 			select p.erech
				into v_erech
				from PIRTEY_OVDIM p
				where p.MISPAR_ISHI =	p_mispar_ishi
					  and p.KOD_NATUN =  	p_kod_natun
					  and  p_taarich  between p.ME_TAARICH and p.AD_TAARICH;		
					  
				return v_erech;	  									 
EXCEPTION
         WHEN OTHERS THEN
              RAISE;
END		func_get_erech_by_kod_natun;																 																					                                         
END PKG_OVDIM; 
/
CREATE OR REPLACE PACKAGE          PKG_PARAMETERS AS

TYPE	CurType	  IS	REF  CURSOR;
PROCEDURE pro_get_data(p_Kod IN VARCHAR2,p_Period in VARCHAR2, p_Cur OUT CurType);
PROCEDURE pro_get_matching_description(p_Prefix in VARCHAR2,  p_Cur OUT CurType);
PROCEDURE pro_get_matching_kod(p_Prefix in VARCHAR2,  p_Cur OUT CurType);
PROCEDURE pro_get_description_by_kod(p_Kod in VARCHAR2,p_Desc out VARCHAR2);
PROCEDURE pro_get_kod_by_description(p_Desc in CTB_PARAMETRIM.TEUR_PARAM%type,p_Kod out CTB_PARAMETRIM.KOD_PARAM%type);
PROCEDURE pro_get_details_Kod(p_Cur OUT CurType );
PROCEDURE pro_get_history(p_Kod in VARCHAR2,p_ToDate in VARCHAR2,  p_Cur out Curtype);
PROCEDURE pro_upd_data(p_Kod number,p_MeTaarich date,p_AdTaarich date,p_Erech VARCHAR2 ,p_SugNatun VARCHAR2,p_comment varchar2, p_taarich_idkun_acharon DATE,p_meadken_acharon NUMBER) ;
PROCEDURE pro_ins_data(p_Kod number,p_MeTaarich date,p_AdTaarich date,p_Erech VARCHAR2 ,p_SugNatun VARCHAR2,p_comment varchar2, p_taarich_idkun_acharon DATE,p_meadken_acharon NUMBER) ;
PROCEDURE pro_Del_data(p_Kod number,p_MeTaarich date) ;
 PROCEDURE pro_get_erech_by_kod(p_KodList in VARCHAR2,p_taarich in VARCHAR2,p_Cur out Curtype) ;

END PKG_PARAMETERS;
/

CREATE OR REPLACE PACKAGE BODY PKG_PARAMETERS AS

  PROCEDURE pro_get_data(p_Kod IN VARCHAR2,p_Period in VARCHAR2, p_Cur OUT CurType)is
  v_MaxLimitDate Date ;
  v_MinLimitDate date ;
  BEGIN
  	v_MinLimitDate := to_date('01/' || p_Period,'dd/mm/yyyy'); /* period= 05/2009=>  v_MinLimitDate = 01/05/2009 */
    v_MaxLimitDate := add_months(v_MinLimitDate,1) -1 ;    /* period= 05/2009=>  v_MaxLimitDate = 31/05/2009 */

    if (p_Kod = '') or (p_Kod is null)  then
              OPEN p_Cur FOR
          SELECT  ctb.KOD_PARAM,(ctb.KOD_PARAM||'-'|| ctb.TEUR_PARAM || '(' || ctb.SUG_NATUN || ')')Details ,tb.Me_Taarich,tb.Ad_Taarich,ERECH_PARAM, ctb.sug_natun,tb.taarich_idkun_acharon LastUpdate,TB.HEARA
          FROM TB_PARAMETRIM tb      INNER JOIN CTB_PARAMETRIM ctb
          ON ctb.KOD_PARAM= tb.KOD_PARAM
          WHERE ((tb.Me_Taarich <=  v_MaxLimitDate ) and (tb.Ad_Taarich >= v_MinLimitDate or tb.Ad_Taarich is null ))
          AND ctb.PAIL = 1
          ORDER BY   ctb.KOD_PARAM ;
    else
          OPEN p_Cur FOR
          SELECT  ctb.KOD_PARAM,(ctb.KOD_PARAM||'-'|| ctb.TEUR_PARAM || '(' || ctb.SUG_NATUN || ')')Details ,tb.Me_Taarich,tb.Ad_Taarich,ERECH_PARAM, ctb.sug_natun,tb.taarich_idkun_acharon LastUpdate,TB.HEARA
          FROM TB_PARAMETRIM tb      INNER JOIN CTB_PARAMETRIM ctb
          ON ctb.KOD_PARAM= tb.KOD_PARAM
          WHERE ((tb.Me_Taarich <=  v_MaxLimitDate ) and (tb.Ad_Taarich >= v_MinLimitDate or tb.Ad_Taarich is null ))
          AND tb.KOD_PARAM = p_Kod AND ctb.PAIL = 1
          ORDER BY   ctb.KOD_PARAM ;
    end if;

    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
  END pro_get_data;

  PROCEDURE pro_get_matching_description(p_Prefix in VARCHAR2,  p_Cur OUT CurType) AS
  BEGIN
      OPEN p_Cur for
      SELECT TEUR_PARAM from CTB_PARAMETRIM SM
      WHERE SM.TEUR_PARAM   LIKE  p_Prefix || '%' and pail =1
      order by TEUR_PARAM asc ;
  END pro_get_matching_description;

  PROCEDURE pro_get_matching_kod(p_Prefix in VARCHAR2,  p_Cur OUT CurType) AS
  BEGIN
      OPEN p_Cur for
      SELECT KOD_PARAM from CTB_PARAMETRIM SM
      WHERE SM.KOD_PARAM   LIKE  p_Prefix || '%' and pail =1
      order by kod_param asc ;
  END pro_get_matching_kod;

  PROCEDURE pro_get_description_by_kod(p_Kod in VARCHAR2,p_Desc out VARCHAR2) AS
  BEGIN

       SELECT  case when ( pail = 1)  then SM.TEUR_PARAM
                        else '-1' end  into p_Desc
        FROM CTB_PARAMETRIM SM
        WHERE SM.KOD_PARAM = p_Kod ;
    EXCEPTION
       WHEN NO_DATA_FOUND THEN
       p_Desc := '';
  END pro_get_description_by_kod;

  PROCEDURE pro_get_kod_by_description(p_Desc in CTB_PARAMETRIM.TEUR_PARAM%type,p_Kod out CTB_PARAMETRIM.KOD_PARAM%type) AS
  BEGIN
              SELECT  case when ( pail = 1)  then SM.KOD_PARAM
                        else -1 end  into p_Kod
        FROM CTB_PARAMETRIM SM
        WHERE SM.TEUR_PARAM = p_Desc ;
      EXCEPTION
        WHEN NO_DATA_FOUND THEN
        p_Kod := '';
  END pro_get_kod_by_description;

  PROCEDURE pro_get_details_Kod(p_Cur OUT CurType ) AS
  BEGIN
  OPEN p_Cur for
      SELECT  SM.KOD_PARAM  , ('-' || SM.KOD_PARAM  || SM.TEUR_PARAM || '(' || sm.SUG_NATUN || ')' ) Details
      FROM CTB_PARAMETRIM SM
      WHERE SM.PAIL = 1
      order by KOD_PARAM asc ;

  END pro_get_details_Kod;

  PROCEDURE pro_get_history(p_Kod in VARCHAR2,p_ToDate in VARCHAR2, p_Cur out Curtype) IS
  v_tar_me DATE ;
  BEGIN
      v_tar_me:=to_date(p_ToDate,'dd/mm/yyyy');
  OPEN p_Cur for
      SELECT SM.ME_TAARICH,SM.ad_taarich,ERECH_PARAM   erech
      FROM TB_PARAMETRIM SM
      WHERE SM.KOD_PARAM =p_Kod and SM.AD_TAARICH< v_tar_me
      ORDER BY SM.ME_TAARICH asc ;

  END pro_get_history;

  PROCEDURE pro_upd_data(p_Kod number,p_MeTaarich date,p_AdTaarich date,p_Erech VARCHAR2 ,p_SugNatun VARCHAR2,p_comment varchar2, p_taarich_idkun_acharon DATE,p_meadken_acharon NUMBER)  AS
  BEGIN
  update TB_PARAMETRIM SM
    set SM.ERECH_PARAM = p_Erech ,
        SM.AD_TAARICH = p_AdTaarich ,
          SM.TAARICH_IDKUN_ACHARON = p_taarich_idkun_acharon,
          SM.MEADKEN_ACHARON = p_meadken_acharon,
          SM.HEARA = p_comment
    where    ME_TAARICH = p_MeTaarich AND
    KOD_PARAM = p_Kod;
  END pro_upd_data;

  PROCEDURE pro_ins_data(p_Kod number,p_MeTaarich date,p_AdTaarich date,p_Erech VARCHAR2 ,p_SugNatun VARCHAR2,p_comment varchar2, p_taarich_idkun_acharon DATE,p_meadken_acharon NUMBER)  AS
  BEGIN
  insert into TB_PARAMETRIM
    (ad_taarich, ERECH_PARAM, KOD_PARAM, me_taarich, meadken_acharon,heara)
    VALUES (p_adtaarich, p_erech, p_Kod, p_metaarich, p_meadken_acharon,p_comment);
  END pro_ins_data;

      PROCEDURE pro_Del_data(p_Kod number,p_MeTaarich date)  AS
  BEGIN
      Delete TB_PARAMETRIM
    where    ME_TAARICH = p_MeTaarich AND
    KOD_PARAM = p_Kod;

  END pro_Del_data;

    PROCEDURE pro_get_erech_by_kod(p_KodList in VARCHAR2,p_taarich in VARCHAR2,p_Cur out Curtype) IS
  v_tar DATE ;
  BEGIN
      v_tar:=to_date(p_taarich,'dd/mm/yyyy');

	  OPEN p_Cur for
      SELECT SM.KOD_PARAM, SM.ERECH_PARAM
      FROM TB_PARAMETRIM SM
      WHERE SM.KOD_PARAM   in( select x from table(cast(convert_string_to_table(p_KodList ,  ',') as mytabtype)))  and
	  v_tar BETWEEN SM.ME_TAARICH AND SM.AD_TAARICH
  ORDER BY  SM.KOD_PARAM asc ;

	   EXCEPTION
       WHEN NO_DATA_FOUND THEN
       		        RAISE;
  END pro_get_erech_by_kod;

END PKG_PARAMETERS;
/
CREATE OR REPLACE PACKAGE          PKG_REPORTS AS
/******************************************************************************
   NAME:       PKG_REPORTS
   PURPOSE:

   REVISIONS:
   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        27/05/2009             1. Created this package.
******************************************************************************/
 TYPE    CurType      IS    REF  CURSOR;

PROCEDURE pro_get_ishurim_lekartis(p_mispar_ishi in tb_ishurim.MISPAR_ISHI%type,
			  										 	 					   p_taarich in tb_ishurim.TAARICH%type,
																			   p_cur out CurType) ;
procedure pro_get_ProfilToDisplay(p_ProfilFilter in varchar2 , p_cur out CurType);
procedure pro_get_Comment_Approval(p_Cur out CurType);
  procedure pro_get_Regions(p_cur out CurType);
procedure pro_get_Status_Approval(p_cur out CurType);
PROCEDURE pro_get_Factors_Confirm(p_cur out CurType);
procedure pro_get_CompanyId ( p_cur out CurType ) ;

procedure pro_get_Ishurim_Rashemet (p_cur out Curtype ,
                                                                 P_WorkerViewLevel in number, 
                                                                 P_WORKERID IN varchar2, 
                                                                 P_MISPAR_ISHI IN varchar2,
                                                                 P_STARTDATE IN date,
                                                                 P_ENDDATE IN DATE ,
                                                                 P_KOD_ISHUR TB_Ishurim.Kod_Status_Ishur%TYPE ,
                                                                 P_FactorConfirm IN ovdim.mispar_ishi%type,
                                                                 P_STATUS IN TB_Ishurim.Kod_Status_Ishur%TYPE ) ;

procedure pro_get_Ishurim_RashemetOld (p_cur out Curtype ,
                                                                 P_MISPAR_ISHI IN ovdim.mispar_ishi%type,
                                                                 P_STARTDATE IN date,
                                                                 P_ENDDATE IN DATE ,
                                                                 P_KOD_ISHUR TB_Ishurim.Kod_Status_Ishur%TYPE ,
                                                                 P_FactorConfirm IN ovdim.mispar_ishi%type,
                                                                 P_STATUS IN TB_Ishurim.Kod_Status_Ishur%TYPE ) ;
procedure pro_get_SidurimOvdim(p_FromDate in date , p_ToDate in date, p_prefix in varchar2 , p_cur out CurType);

procedure pro_get_WorkStation(p_prefix in varchar2 , p_cur out CurType);

procedure pro_get_LicenseNumber(p_prefix in varchar2 , p_cur out CurType);

procedure pro_get_Id_of_Yamey_Avoda(p_FromDate in date , p_ToDate in date,p_Prefix in varchar2, p_cur out CurType) ;
procedure pro_get_MakatOfActivity(p_FromDate in date , p_ToDate in date, p_prefix in varchar2 , p_cur out CurType);
procedure pro_get_Id_of_Yamey_Avoda(p_FromDate in date , p_ToDate in date ,p_CompanyId in varchar2,p_Prefix in varchar2, p_cur out CurType);

procedure pro_get_Find_Worker_Card(p_cur out CurType,
                                                                P_STARTDATE in date,
                                                                P_ENDDATE in date ,
                                                                P_Makat in number,
                                                                P_SIDURNUMBER in varchar,
                                                                P_CARNUMBER in varchar,
                                                                P_SNIF in varchar,
                                                                P_WORKSTATION in varchar,
                                                                P_DAYTYPE in varchar ,
                                                                P_WORKERID in varchar, 
                                                                P_SECTORISUK in varchar ,
                                                                P_SNIF_MASHAR in varchar , 
                                                                P_COMPANYID in varchar  ,
                                                                P_MAMAD in varchar 
                                                                );
    function fct_MakatDateSql    (  P_STARTDATE in date,
                                                P_ENDDATE in date ,
                                                P_Makat in number,
                                                P_SIDURNUMBER in varchar,
                                                P_WORKERID in varchar ) return varchar ;
  procedure pro_Prepare_Catalog_Details ( GeneralQry in varchar )    ;



procedure pro_get_Presence (p_cur out Curtype ,
                                                                 P_WorkerViewLevel in number, 
                                                                 P_WORKERID IN varchar2, 
                                                                 P_MISPAR_ISHI IN VARCHAR2 ,
                                                                 P_STARTDATE IN date,
                                                                 P_ENDDATE IN DATE);
procedure pro_get_DriverWithoutTacograph  (p_cur out CurType ,
                                                                            p_ezor IN varchar2,
                                                                            p_Period in VARCHAR2);

  PROCEDURE Pro_Get_MaxTimeNoTacograph(p_cur out CurType ,
                                                                            p_Period in VARCHAR2);

  procedure pro_get_DriverNotSigned  (p_cur out CurType ,
                                                                            p_ezor IN varchar2,
                                                                            p_Period in VARCHAR2) ;

procedure pro_get_SumDriverNotSigned  (p_cur out CurType ,
                                                                            p_ezor IN varchar2,
                                                                            p_Period in VARCHAR2);

  PROCEDURE Pro_Get_MaxTimeNoSignature(p_cur out CurType ,
                                                                              p_Period in VARCHAR2);

Procedure Pro_Get_DisregardDrivers(p_Cur out CurType ,
                                     P_DISREGARDTYPE IN VARCHAR2,
                                     p_Period in VARCHAR2);

   Procedure Pro_Get_PremiotPresence(p_Cur out CurType ,
                                                        p_kod_premia in MEAFYENIM_OVDIM.KOD_MEAFYEN%type,
                                                        P_MISPAR_ISHI in varchar,
                                                        p_Period in VARCHAR2) ;
 PROCEDURE pro_get_rizot_chishuv_succeed(  P_CHODESH_HARAZA  IN VARCHAR2,
																						   p_Cur out CurType)  ;
	PROCEDURE  pro_get_maamadot(p_Cur out CurType );

procedure pro_get_AbsenceType( p_Cur out CurType );
procedure pro_get_WorkDayList( p_Cur out CurType );

PROCEDURE  pro_get_pirtey_rizot(listMispareiRizot in varchar2,
		   										  	 		  							      IdReport in number,
																	  strChodashim in varchar2,
		   									  	 		     p_Cur out CurType );

PROCEDURE  pro_getNetuneyHashvaatRizot( P_CHODESH in varchar2,
		   								   			 			 									  P_MIS_RITZA in integer,
		   										 													  P_MIS_RITZA_LEHASVAA in integer,
																									  P_MAMAD in varchar2,
																									  P_ISUK in varchar2,
																									  P_MISPAR_ISHI in varchar2,
																						   p_Cur out CurType ) ;


PROCEDURE pro_get_rizot_chishuv_lehodesh(  P_CHODESH_HARAZA  IN VARCHAR2,
																						   p_Cur out CurType) ;

PROCEDURE  pro_get_ramot_chishuv_letezuga(p_Cur out CurType );

PROCEDURE  pro_GetHashvaatChodsheyRizot( P_CHODESH in varchar2,
		   								   			 			 								   P_MIS_RITZA in integer,
		   										 												   P_CHODESH_LEHASHVAA in  varchar2,
																								   P_MIS_RITZA_LEHASVAA in integer,
																								   P_RAMA_LETEZUGA in varchar2,
																								    p_Cur out CurType );

PROCEDURE  pro_get_reports_list(P_PROFIL  in varchar2,
		   								   							   p_Cur out CurType );

	PROCEDURE  pro_GetNetuneyIdkuneyRashemet( P_MIS_RASHEMET in integer,
		   								   			 			 								   P_TAARICH_CA in VARCHAR2,  -- CA=Cartis Avoda
		   										 												   P_SHAA in varchar2,
																								    p_Cur out CurType ) ;

PROCEDURE PREPARE_DAYLIST_OF_RPT( CurrentMonth varchar2 );
procedure pro_Get_AbsentWorkers(P_PERIOD in  VARCHAR2 ,
                                                   P_EZOR in NUMBER ,
                                                   P_ABSENCE_TYPE in NUMBER ,
                                                   P_WORKDAYS in NUMBER,
                                                   P_MAMAD in NUMBER ,
                                                   p_cur out CurType ) ;

procedure pro_GetMainDetailsAverage (P_STARTDATE in date,
                                            P_ENDDATE in date ,
                                            P_SNIF in varchar2 ,
                                            P_MAMAD in varchar2 ,
                                            P_ISUK varchar2 ,
                                            P_EZOR in varchar ,
                                            P_COMPANYID  in varchar2 ,
                                            P_MisparIshi  in varchar2 ,
                                            P_KOD_YECHIDA IN varchar2 ,
                                            P_SECTORISUK in varchar2 ,
                                            p_cur out CurType );

procedure pro_GetRechivValueAverage (P_STARTDATE in date,
                                            P_ENDDATE in date ,
                                            P_MisparIshi  in varchar2,
                                            p_cur out CurType ) ;
function fct_GetSumMonthWithRechiv (P_STARTDATE in date, 
                                            P_ENDDATE in date ,
                                            P_MisparIshi  in varchar2 ) return  number;
procedure pro_GetDescriptionComponents (P_STARTDATE  in varchar2,
                                          P_ENDDATE in varchar2,
                                             P_COMPANYID  in varchar2,
                                            p_cur out CurType ) ;

PROCEDURE  pro_GetPundakimLeHitchashbenut( P_STARTDATE in TB_HITYAZVUT_PUNDAKIM.TAARICH%TYPE,
		   								   			  P_ENDDATE in TB_HITYAZVUT_PUNDAKIM.TAARICH%TYPE,
													 p_Cur out CurType ) ;
procedure pro_get_Id_of_Ovdim(p_FromDate in date , p_ToDate in date ,
		  								 		   			      p_preFix in varchar2,  p_cur out CurType) ;
procedure pro_ins_Heavy_Reports (p_BakashaId in tb_bakashot.bakasha_id%type, 
                                                   p_ReportName in CTB_SUGEY_DOCHOT.SHEM_DOCH_BAKOD%type,
                                                   p_ReportParams in    COLL_Report_Param,
                                                   p_MisparIshi in number ,
                                                   p_Extension in TB_DOCHOT_MISPAR_ISHI.EXTENSION_TYPE%type ,
                                                   p_DestinationFolder in TB_DOCHOT_MISPAR_ISHI.SHEM_TIKIYA%type,
                                                   p_SendToMail in number);

procedure  pro_get_Definition_Reports(p_BakashaId in  tb_bakashot.bakasha_id%type, p_cur out CurType) ;
procedure pro_get_Details_Reports      (p_BakashaId in  tb_bakashot.bakasha_id%type, p_cur out CurType);
procedure pro_get_Destinations_Reports(p_BakashaId in  tb_bakashot.bakasha_id%type,p_cur out CurType);

/*PROCEDURE pro_Get_TlunotPundakim(P_STARTDATE in TB_PEILUT_OVDIM.TAARICH%TYPE,
		  					   	  				P_ENDDATE in TB_PEILUT_OVDIM.TAARICH%TYPE,
												P_MISPAR_ISHI in VARCHAR2,
												pCur out Curtype ) ;			*/
  PROCEDURE Pro_Get_TlunotPundakim(p_Cur out Curtype ,
  										 	 		  	 		   				    P_STARTDATE in VARCHAR2,
		  					   	  												  	P_ENDDATE in VARCHAR2,
																					P_MISPAR_ISHI in VARCHAR2,
																					P_SUG_REPORT NUMBER ) ;

PROCEDURE pro_Prepare_Netunim_Tnua(P_STARTDATE in VARCHAR2,
		  					   	  				  		   		     P_ENDDATE in VARCHAR2);

PROCEDURE pro_getPirteyOvedForWorkCard(p_Cur out Curtype,
												  										 	 	P_TAARICH in DATE,
																								P_MISPAR_ISHI in NUMBER) ;

PROCEDURE pro_getSidurimVePeiluyotForWC(p_Cur out Curtype,
												  										 	 	P_TAARICH in DATE,
																								P_MISPAR_ISHI in NUMBER) ;
FUNCTION IsEilatTrip(km NUMBER,taarich DATE, eilatTrip NUMBER) return number ;
FUNCTION bdok_shibuz_mechona(P_TAARICH in DATE, P_MISPAR_ISHI in NUMBER) return number ;
PROCEDURE pro_getPrepareReports(P_MISPAR_ISHI in NUMBER,
		  									  	 			   		  		    P_STATUS_LIST in VARCHAR2,
		  									   	  		                          p_Cur out Curtype ) ;

PROCEDURE pro_updatePrepareReports(P_MISPAR_ISHI in NUMBER ) ;	
PROCEDURE pro_getSidureyVisaForWC(p_Cur out Curtype,
                                                                                     P_TAARICH in DATE,
                                                                                       P_MISPAR_ISHI in NUMBER) ;		
	
PROCEDURE pro_get_HeavyReportsToDelete(p_Cur out Curtype) ;														   																  
END PKG_REPORTS; 
/

CREATE OR REPLACE PACKAGE BODY PKG_REPORTS AS
/******************************************************************************
   NAME:       PKG_REPORTS
   PURPOSE:

   REVISIONS:
   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        27/05/2009             1. Created this package body.
******************************************************************************/
                                                         
 
      PROCEDURE pro_get_ishurim_lekartis(p_mispar_ishi in tb_ishurim.MISPAR_ISHI%type,
                                                                                   p_taarich in tb_ishurim.TAARICH%type,
                                                                               p_cur out CurType)  IS
 BEGIN
 if to_number(to_char(p_taarich,'DD'))  >1 then
        open p_cur for
           Select  TB.Kod_Ishur ,CTB. Teur_Ishur ,  Si.TEUR_STATUS_ISHUR , Ov.SHEM_MISH || ' ' ||  Ov.SHEM_PRAT Gorem_Meacher ,TB.TAARICH_IDKUN_ACHARON
            From TB_Ishurim TB,  CTB_Ishurim CTB, CTB_Status_Ishurim Si , Ovdim Ov 
            Where TB.Kod_Ishur = CTB. Kod_Ishur
--            and  TB. Kod_Status_Ishur=0
            and TB. Mispar_Ishi=p_mispar_ishi
            and TB.Taarich=p_taarich
            and TB.KOD_STATUS_ISHUR = Si.KOD_STATUS_ISHUR
            and Ov.MIspar_ishi (+)= TB.GOREM_MEASHER_RASHSI;
else
    open p_cur for
                    Select  TB.Kod_Ishur ,CTB.Teur_Ishur,  Si.TEUR_STATUS_ISHUR , Ov.SHEM_MISH || ' ' ||  Ov.SHEM_PRAT Gorem_Meacher ,TB.TAARICH_IDKUN_ACHARON
                From TB_Ishurim TB,  CTB_Ishurim CTB, CTB_Status_Ishurim Si , Ovdim Ov 
                Where TB.Kod_Ishur = CTB. Kod_Ishur
  --              and  TB. Kod_Status_Ishur=0
                and TB. Mispar_Ishi=p_mispar_ishi
                and TB.Taarich=p_taarich
            and TB.KOD_STATUS_ISHUR = Si.KOD_STATUS_ISHUR
            and Ov.MIspar_ishi(+) = TB.GOREM_MEASHER_RASHSI
            union all 
                Select TB.Kod_Ishur ,CTB. Teur_Ishur,  Si.TEUR_STATUS_ISHUR , Ov.SHEM_MISH || ' ' ||  Ov.SHEM_PRAT Gorem_Meacher ,TB.TAARICH_IDKUN_ACHARON
                From TB_Ishurim TB,  CTB_Ishurim CTB, CTB_Status_Ishurim Si , Ovdim Ov 
                Where TB.Kod_Ishur = CTB. Kod_Ishur
                and TB.Kod_Ishur  in (34,35)
    --            and  TB. Kod_Status_Ishur=0
                and TB. Mispar_Ishi=p_mispar_ishi
                and to_char(TB.Taarich,'MM') = to_char(add_Months(p_taarich,-1),'MM')
            and TB.KOD_STATUS_ISHUR = Si.KOD_STATUS_ISHUR
            and Ov.MIspar_ishi (+) = TB.GOREM_MEASHER_RASHSI ;
end if;

      EXCEPTION 
         WHEN OTHERS THEN 
              RAISE;               
  END  pro_get_ishurim_lekartis;
  
  

procedure pro_get_ProfilToDisplay(p_ProfilFilter in varchar2 , p_cur out CurType) is  
  begin 
  
--INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'p_ProfilFilter',p_ProfilFilter);
  
  open p_cur for select KOD_PROFIL,TEUR_PROFIL_HEB  from(
      select  0 KOD_PROFIL ,''  TEUR_PROFIL_HEB , 1 ord from dual 
union 
      SELECT KOD_PROFIL,TEUR_PROFIL_HEB , 2 ord 
        FROM CTB_PROFIL t
        where LETEZUGA = 1 
        and T.TEUR_PROFIL in 
         (SELECT X FROM TABLE(CAST(CONVERT_STRING_TO_TABLE( p_ProfilFilter,  ',') AS MYTABTYPE)))
        order by ord,TEUR_PROFIL_HEB
    );
        EXCEPTION 
         WHEN OTHERS THEN 
              RAISE;               
  END  pro_get_ProfilToDisplay;

  
  
  procedure pro_get_Comment_Approval(p_cur out CurType) is 
  begin 
  open p_cur for select Kod_Ishur,teur_ishur  from(
  select  -1 Kod_Ishur ,''  teur_ishur , 1 ord from dual 
union 
SELECT Kod_Ishur,teur_ishur , 2 ord FROM CTB_Ishurim order by ord,teur_ishur);
        EXCEPTION 
         WHEN OTHERS THEN 
              RAISE;               
  END  pro_get_Comment_Approval;
  
  
  
  procedure pro_get_Regions(p_cur out CurType) is 
  begin 
  open p_cur for select kod_ezor,teur_ezor  from(
  select  -1 kod_ezor ,''  teur_ezor , 1 ord from dual 
union
select distinct kod_ezor,teur_ezor ,2 ord from CTB_EZOR 
 order by ord,teur_ezor);
        EXCEPTION 
         WHEN OTHERS THEN 
              RAISE;               
  END  pro_get_Regions;
  
  
  
  
  
  
  procedure pro_get_Status_Approval(p_cur out CurType) is 
  begin 
--set transaction read only ;
  open p_cur for 
-- select LICENSE_NUMBER kod_status_ishur,1 teur_status_ishur FROM VCL_GENERAL_VEHICLE_VIEW@kds2maale ORDER BY LICENSE_NUMBER;
  select  -1 kod_status_ishur ,''  teur_status_ishur from dual 
union 
 select kod_status_ishur, teur_status_ishur from ctb_status_ishurim ;

        EXCEPTION 
         WHEN OTHERS THEN 
              RAISE;               
  END  pro_get_Status_Approval;
  
  PROCEDURE pro_get_Factors_Confirm(p_cur out CurType)   IS
 BEGIN
  open p_cur for 
  select FullName,mispar_ishi from 
  (select '' FullName, -1 mispar_ishi , 1 ord from dual
union 
  Select Distinct o.SHEM_MISH || ' ' || O. SHEM_PRAT FullName, o.mispar_ishi,2 ord
From TB_Ishurim TB,  Ovdim O Where TB. Gorem_Measher_Rashsi = O. Mispar_Ishi 
order by ord,FullName);

        EXCEPTION 
         WHEN OTHERS THEN 
              RAISE;               
  END  pro_get_Factors_Confirm;
  
  procedure pro_get_CompanyId ( p_cur out CurType ) is 
  begin 
  
  open p_cur for 
  select Teur_Hevra,Kod_Hevra from 
  (select '' Teur_Hevra, -1 Kod_Hevra , 1 ord from dual
union 
    Select Teur_Hevra , Kod_Hevra,   2 ord From CTB_Hevra 
order by ord,Teur_Hevra);

        EXCEPTION 
         WHEN OTHERS THEN 
              RAISE;               
  END  pro_get_CompanyId;

  
  procedure pro_get_Ishurim_RashemetOld (p_cur out Curtype ,
                                                                 P_MISPAR_ISHI IN ovdim.mispar_ishi%type, 
                                                                 P_STARTDATE IN date,
                                                                 P_ENDDATE IN date ,
                                                                 P_KOD_ISHUR TB_Ishurim.Kod_Status_Ishur%TYPE ,
                                                                 P_FactorConfirm IN ovdim.mispar_ishi%type,
                                                                 P_STATUS IN TB_Ishurim.Kod_Status_Ishur%TYPE ) is
                                                                 strGeneral varchar2(10000);
                                                                 strFilter varchar2(500);
begin 



strGeneral := 'Select TB.Mispar_Ishi ,' ||
            'O. SHEM_MISH || '' '' ||  O. SHEM_PRAT FULL_NAME,' ||
            'TB.Taarich,CTB.Teur_Ishur,' ||
            'OvGorem. SHEM_MISH || '' '' ||  OvGorem.SHEM_PRAT Factor_Confirm,'||
            'S.Teur_Status_Ishur ,TB.TAARICH_IDKUN_ACHARON ' ||
            'From TB_Ishurim TB,CTB_Ishurim CTB,'  ||
            'Ovdim O, Ovdim OvGorem,CTB_Status_Ishurim S ' ||
            'Where TB.Kod_Ishur = CTB.Kod_Ishur ' ||
            'and TB.Mispar_Ishi  = O.Mispar_Ishi ' || 
            'and TB.Gorem_Measher_Rashsi  = OvGorem.Mispar_Ishi ' ||
            'and TB.Kod_Status_Ishur=S.Kod_Status_Ishur ' ;
strFilter := '' ;
if ( P_MISPAR_ISHI is not null ) THEN
    strFilter := ' and TB.Mispar_Ishi = ' || P_MISPAR_ISHI;
end if ; 
if ( P_KOD_ISHUR <> -1) THEN
    strFilter := strFilter || ' and TB.Kod_Ishur = ' || P_KOD_ISHUR;
end if ; 
if ( P_FactorConfirm  <> -1 ) THEN
    strFilter := strFilter || ' and TB.Gorem_Measher_Rashsi = ' || P_FactorConfirm;
end if ; 
if ( P_STATUS <> -1  ) THEN
    strFilter := strFilter || ' and TB.Kod_Status_Ishur = ' || P_STATUS;
end if ; 
if (( P_STARTDATE is not null  ) OR ( P_STARTDATE <> '' )) THEN
    strFilter := strFilter || ' and TB.Taarich >= ''' || trunc(P_STARTDATE) || '''';
end if ; 
if (( P_ENDDATE is not  null ) OR ( P_ENDDATE <> '' )) THEN 
    strFilter := strFilter || ' and TB.Taarich <= ''' || trunc(P_ENDDATE) || '''';
end if ; 

open p_cur for strGeneral || strFilter || ' ORDER BY Mispar_Ishi desc  , taarich desc ,CTB.Kod_Ishur asc ' ; 
           select replace(strGeneral,'Where',chr(13) ||'Where' ) into strGeneral from dual; 
           select replace(strGeneral,'From',chr(13) ||'From' ) into strGeneral from dual; 
           select replace(strFilter,'and',chr(13) ||'and' ) into strFilter from dual; 
           DBMS_OUTPUT.PUT_LINE('sql = ' || strGeneral || strFilter);
     
        EXCEPTION 
         WHEN OTHERS THEN 
              RAISE;               
  END  pro_get_Ishurim_RashemetOld;     

  
    procedure pro_get_Ishurim_Rashemet (p_cur out Curtype ,
                                                                 P_WorkerViewLevel in number, 
                                                                 P_WORKERID IN varchar2, 
                                                                 P_MISPAR_ISHI IN varchar2, 
                                                                 P_STARTDATE IN date,
                                                                 P_ENDDATE IN date ,
                                                                 P_KOD_ISHUR TB_Ishurim.Kod_Status_Ishur%TYPE ,
                                                                 P_FactorConfirm IN ovdim.mispar_ishi%type,
                                                                 P_STATUS IN TB_Ishurim.Kod_Status_Ishur%TYPE ) is
                                                                 strGeneral varchar2(10000);
                                                                 strFilter varchar2(500);
begin 

if (P_WorkerViewLevel = 5) then  
        pkg_utils.pro_ins_Manage_Tree(to_number(P_WORKERID,999999999));
end if ;

--INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_WorkerViewLevel:',P_WorkerViewLevel);
--INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_WORKERID:',P_WORKERID);
--INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_MISPAR_ISHI:',P_MISPAR_ISHI);
--INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_STARTDATE:',P_STARTDATE);
--INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_ENDDATE:',P_ENDDATE);
--INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_KOD_ISHUR:',P_KOD_ISHUR);
--INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_FactorConfirm:',P_FactorConfirm);
--INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_STATUS:',P_STATUS);

strGeneral := 'Select TB.Mispar_Ishi ,
            O. SHEM_MISH || '' '' ||  O. SHEM_PRAT FULL_NAME,
            TB.Taarich,CTB.Teur_Ishur,
            OvGorem. SHEM_MISH || '' '' ||  OvGorem.SHEM_PRAT Factor_Confirm,
            S.Teur_Status_Ishur ,TB.TAARICH_IDKUN_ACHARON 
            From TB_Ishurim TB,CTB_Ishurim CTB,
            Ovdim O, Ovdim OvGorem,CTB_Status_Ishurim S ' ;
            if (P_WorkerViewLevel = 5) then
              strGeneral := strGeneral || ',TMP_MANAGE_TREE Tree ';
            end if ;    
              strGeneral := strGeneral || 'where
             TB.Kod_Ishur = CTB.Kod_Ishur 
            and TB.Mispar_Ishi  = O.Mispar_Ishi  
            and TB.Gorem_Measher_Rashsi  =  OvGorem.Mispar_Ishi (+) 
            and TB.Kod_Status_Ishur=S.Kod_Status_Ishur ' ;
            
strFilter := '' ;
if ( P_KOD_ISHUR <> -1) THEN
    strFilter := strFilter || ' and TB.Kod_Ishur = ' || P_KOD_ISHUR;
end if ; 
if ( P_FactorConfirm  <> -1 ) THEN
    strFilter := strFilter || ' and TB.Gorem_Measher_Rashsi = ' || P_FactorConfirm;
end if ; 
if ( P_STATUS <> -1  ) THEN
    strFilter := strFilter || ' and TB.Kod_Status_Ishur = ' || P_STATUS;
end if ; 
if (( P_STARTDATE is not null  ) OR ( P_STARTDATE <> '' )) THEN
    strFilter := strFilter || ' and TB.Taarich >= ''' || trunc(P_STARTDATE) || '''';
end if ; 
if (( P_ENDDATE is not  null ) OR ( P_ENDDATE <> '' )) THEN 
    strFilter := strFilter || ' and TB.Taarich <= ''' || trunc(P_ENDDATE) || '''';
end if ; 


if (
       (
            (nvl(P_MISPAR_ISHI,-1) <> nvl(P_WORKERID,-1))  
            or  
            (P_WorkerViewLevel =0)
        )
    and ( (P_MISPAR_ISHI <> '' ) or   (P_MISPAR_ISHI is not null ))
  )then 
        strFilter := strFilter || ' and TB.mispar_ishi in (' || P_MISPAR_ISHI || ') ';
end if ; 


if (P_WorkerViewLevel = 5) then
  strFilter := strFilter || 'And  TB.mispar_ishi in Tree.mispar_ishi ';
end if ;    


if (( strFilter is not null  ) OR ( strFilter <> '')) then
  strGeneral := strGeneral || strFilter;
end if ;

DBMS_OUTPUT.PUT_LINE(strGeneral );
open p_cur for strGeneral || ' ORDER BY Mispar_Ishi desc  , taarich desc ,CTB.Kod_Ishur asc ' ; 
     
        EXCEPTION 
         WHEN OTHERS THEN 
              RAISE;               
  END  pro_get_Ishurim_Rashemet;     
       



procedure pro_get_MakatOfActivity(p_FromDate in date , p_ToDate in date, p_prefix in varchar2 , p_cur out CurType) as 
begin 

open p_cur for 
Select Distinct Makat_nesia 
from TB_peilut_Ovdim Activity
where ACTIVITY.TAARICH between trunc(p_FromDate)and trunc(p_todate)
and ACTIVITY.MAKAT_NESIA like  p_prefix  ||  '%' ; 
        EXCEPTION 
         WHEN OTHERS THEN 
              RAISE;               
  END  pro_get_MakatOfActivity;     


procedure pro_get_SidurimOvdim(p_FromDate in date , p_ToDate in date, p_prefix in varchar2 , p_cur out CurType) as 
begin 

open p_cur for 
Select Distinct Mispar_sidur  
from TB_Sidurim_Ovdim So
where SO.TAARICH between trunc(p_FromDate)and trunc(p_todate)
and SO.MISPAR_SIDUR  like   p_prefix ||'%'   
order by 1 ; 
        EXCEPTION 
         WHEN OTHERS THEN 
              RAISE;               
  END  pro_get_SidurimOvdim; 
  

procedure pro_get_WorkStation(p_prefix in varchar2 , p_cur out CurType) as 
begin 

open p_cur for 
select distinct ST.KOD_SNIF_TNUAA from 
CTB_SNIFEY_TNUAA st 
where ST.KOD_SNIF_TNUAA  like   p_prefix  ||  '%' ; 
        EXCEPTION 
         WHEN OTHERS THEN 
              RAISE;               
  END  pro_get_WorkStation; 
    


procedure pro_get_LicenseNumber(p_prefix in varchar2 , p_cur out CurType) as 
begin 

open p_cur for 
select LICENSE_NUMBER FROM VCL_GENERAL_VEHICLE_VIEW@kds2maale V 
where v.LICENSE_NUMBER LIKE  P_PREFIX  ||  '%'; 
        EXCEPTION 
         WHEN OTHERS THEN 
              RAISE;               
  END  pro_get_LicenseNumber; 
    

procedure pro_get_Id_of_Yamey_Avoda(p_FromDate in date , p_ToDate in date,p_Prefix in varchar2, p_cur out CurType) as 
begin 
if (p_Prefix <> ''  ) then 
open p_cur for 
--select 1 mispar_ishi from dual ;
  select distinct mispar_ishi 
  from  TB_Yamey_Avoda_Ovdim O
  WHERE O.TAARICH between trunc(p_FromDate)and trunc(p_todate)
  and O.MISPAR_ISHI like   p_prefix  ||  '%' ; 
  else 
open p_cur for 
--select 1 mispar_ishi from dual ;
  select distinct mispar_ishi 
  from  TB_Yamey_Avoda_Ovdim O
  WHERE O.TAARICH between trunc(p_FromDate)and trunc(p_todate)
  and O.MISPAR_ISHI like p_prefix  || '%' ; 
end if ;  
  
        EXCEPTION 
         WHEN OTHERS THEN 
              RAISE;               
  END  pro_get_Id_of_Yamey_Avoda;     

procedure pro_get_Id_of_Yamey_Avoda(p_FromDate in date , p_ToDate in date ,p_CompanyId in varchar2,p_Prefix in varchar2, p_cur out CurType) as 
begin 
  --  open p_cur for 
    --select p_CompanyId mispar_ishi ,  p_CompanyId FullName from dual ;

if (p_Prefix <> ''  ) then 
    open p_cur for 
           select    O.mispar_ishi ,  FullName
            from ( select distinct  mispar_ishi 
                      from TB_Yamey_Avoda_Ovdim
                      WHERE TAARICH between trunc(p_FromDate)and trunc(p_todate)
                        and (mispar_ishi like  p_prefix  ||  '%'  )
                    )  O ,
                    (select mispar_ishi, (mispar_ishi ||  ' (' || SHEM_MISH || ' ' || SHEM_PRAT || ')')  FullName  from Ovdim 
                    where ((p_CompanyId =  '-1') or  ( KOD_HEVRA = p_CompanyId))
                    ) Ov
            where  OV.MISPAR_ISHI = O.MISPAR_ISHI(+) ;
else 
    open p_cur for 
           select    O.mispar_ishi ,  FullName
            from ( select distinct  mispar_ishi 
                      from TB_Yamey_Avoda_Ovdim
                      WHERE TAARICH between trunc(p_FromDate)and trunc(p_todate) 
                    )  O ,
                    (select mispar_ishi, (mispar_ishi ||  ' (' || SHEM_MISH || ' ' || SHEM_PRAT || ')')  FullName  from Ovdim 
                    where ((p_CompanyId =  '-1') or  ( KOD_HEVRA = p_CompanyId))
                    ) Ov
            where  OV.MISPAR_ISHI = O.MISPAR_ISHI(+) ;
end if ;               

        EXCEPTION 
         WHEN OTHERS THEN 
              RAISE;               
  END  pro_get_Id_of_Yamey_Avoda;     
  
  
procedure pro_get_Find_Worker_Card(p_cur out CurType, 
                                                                P_STARTDATE in date,
                                                                P_ENDDATE in date , 
                                                                P_Makat in number,
                                                                P_SIDURNUMBER in varchar,
                                                                P_CARNUMBER in varchar,
                                                                P_SNIF in varchar,
                                                                P_WORKSTATION in varchar,
                                                                P_DAYTYPE in varchar ,
                                                                P_WORKERID in varchar,
                                                                P_SECTORISUK in varchar ,
                                                                P_SNIF_MASHAR in varchar , 
                                                                P_COMPANYID in varchar ,
                                                                P_MAMAD in varchar 
                                                                 ) as
GeneralQry varchar2(32767);
QryMakatDate varchar2(3500);
ParamQry varchar2(1000);
rc number ;
begin

/*
INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_STARTDATE:',P_STARTDATE);
INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_ENDDATE:',P_ENDDATE);
INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_Makat:',P_Makat);
INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_SIDURNUMBER:',P_SIDURNUMBER);
INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_CARNUMBER:',P_CARNUMBER);
INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_SNIF:',P_SNIF);
INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_WORKSTATION:',P_WORKSTATION);
INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_DAYTYPE:',P_DAYTYPE);
INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_WORKERID:',P_WORKERID);
INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_SECTORISUK:',P_SECTORISUK);
INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_SNIF_MASHAR:',P_SNIF_MASHAR);
INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_COMPANYID:',P_COMPANYID);
*/

QryMakatDate :=  fct_MakatDateSql(P_STARTDATE ,P_ENDDATE  ,P_Makat ,P_SIDURNUMBER ,P_WORKERID  );
 pro_Prepare_Catalog_Details(QryMakatDate);
 COMMIT ; 
GeneralQry := 'Select substr(Details.EZOR,0,1) || substr(Details.MAAMAD,0,1) || ''-'' ||  Details.MISPAR_ISHI Misparishi,activity.shilut_netzer, activity.makat_nesia, activity.shat_yetzia, activity.mispar_knisa, 
activity.oto_no,activity.Snif_Tnua,snif.teur_snif_av,Ov.shem_mish|| '' '' ||  shem_prat full_name,So.chariga,So.hashlama,
So.out_michsa, So.meadken_acharon, so.mispar_sidur,so.shat_hatchala, so.shat_gmar,so.taarich,dayofweek(so.taarich) DayOfWeek  , 
Sidur.teur_sidur_meychad, teur_maamad_hr,isuk.teur_isuk,bus_number, license_number ,
Catalog.ACTIVITY_DATE  , Catalog.MAKAT8,Catalog.DESCRIPTION ,Catalog.SHILUT ,Catalog.MAZAN_TASHLUM,Catalog.KM,Catalog.NIHUL_NAME             
From  
TMP_PIRTEY_OVDIM  Details  ,
(select po.mispar_ishi,max(po.ME_TARICH) me_taarich
                       from tmp_Pirtey_Ovdim PO
                       where po.isuk is not null
                             and (''' || trunc(P_STARTDATE) || '''  Between  po.ME_TARICH  and   nvl(po.ad_TARICH,to_date(''01/01/9999'' ,''dd/mm/yyyy''))
                               or   ''' || trunc(P_ENDDATE) || '''  Between  po.ME_TARICH  and   nvl(po.ad_TARICH,to_date(''01/01/9999'' ,''dd/mm/yyyy''))
                                or   po.ME_TARICH>= ''' || trunc(P_STARTDATE) || '''  and   nvl(po.ad_TARICH,to_date(''01/01/9999'' ,''dd/mm/yyyy''))<=  ''' || trunc(P_ENDDATE) || '''  )
                      group by po.mispar_ishi) RelevantDetails,
TB_peilut_Ovdim Activity ,ovdim Ov,TB_Sidurim_Ovdim so   ,ctb_snif_av Snif ,CTB_Sidurim_Meyuchadim Sidur  ,
        ctb_maamad   Maamad ,ctb_isuk Isuk ,tmp_Catalog Catalog,VCL_GENERAL_VEHICLE_VIEW@kds2maale Mashar
WHERE 
 (Details.mispar_ishi = so.mispar_ishi )  
and Details.mispar_ishi = RelevantDetails.mispar_ishi 
and  Details.ME_TARICH = RelevantDetails.me_taarich
and Details.mispar_ishi = so.mispar_ishi 
and (so.mispar_ishi        = activity.mispar_ishi(+))  
And  (details.mispar_ishi = Ov.mispar_ishi)  
and ( Catalog.makat8(+) = activity.makat_nesia)
AND  (Mashar.bus_number(+) = activity.oto_no)
And (so.mispar_sidur      = activity.mispar_sidur(+))
And (so.shat_hatchala = activity.shat_hatchala_sidur(+)) 
and (so.taarich           = activity.taarich(+)) 
And (so.mispar_sidur = Sidur.kod_sidur_meyuchad(+) )    
And  (details.maamad     = maamad.kod_maamad_hr)  
And  (details.isuk            = Isuk.kod_isuk )
And  (details.snif_av       = Snif.kod_snif_av )  
and (maamad.kod_hevra = Ov.kod_hevra)
and (maamad.kod_hevra = Snif.kod_hevra)
and (maamad.kod_hevra = Isuk.kod_hevra)
and  (so.taarich     between     ''' || trunc(P_STARTDATE) || ''' AND ''' || trunc(P_ENDDATE) || ''')' ; 



--if (( P_MAMAD is not  null ) OR ( P_MAMAD <> '' )) THEN 
--    ParamQry := ParamQry || PREPARE_LIKE_OF_LIST('maamad.KOD_MAAMAD_HR', P_MAMAD) || ' AND '; 
--end if ; 

if (( P_DAYTYPE is not  null ) OR ( P_DAYTYPE <> '' )) THEN 
    ParamQry := ParamQry ||  '  dayofweek(so.taarich) = ''''  AND '; 
end if ; 
if (( P_SNIF is not  null ) OR ( P_SNIF <> '' )) THEN 
    ParamQry := ParamQry ||  '  Snif.kod_snif_av in (' || P_SNIF || ') AND '; 
end if ; 
if (( P_WORKERID is not  null ) OR ( P_WORKERID <> '' )) THEN 
    ParamQry := ParamQry || '  so.mispar_ishi in (' || P_WORKERID || ') AND ';
end if ; 
if (( P_Makat is not  null ) OR ( P_Makat <> '' )) THEN 
    ParamQry := ParamQry || ' Activity.makat_nesia like  ''%' || P_Makat || '%'' AND ';
end if ; 
if (( P_SIDURNUMBER is not  null ) OR ( P_SIDURNUMBER <> '' )) THEN 
    ParamQry := ParamQry || PREPARE_LIKE_OF_LIST('Activity.mispar_sidur', P_SIDURNUMBER) || ' AND '; 
end if ; 
if (( P_CARNUMBER is not  null ) OR ( P_CARNUMBER <> '' )) THEN 
    ParamQry := ParamQry || ' Mashar.license_number in (' || P_CARNUMBER || ') AND ';
end if ; 
if (( P_WORKSTATION is not  null ) OR ( P_WORKSTATION <> '' )) THEN 
    ParamQry := ParamQry || '  Mashar.Branch2 in (' || P_WORKSTATION || ') AND ';
end if ; 

if (( ParamQry is not null  ) OR ( ParamQry <> '')) then 
  ParamQry := SUBSTR(ParamQry,0,LENGTH(ParamQry)-4); -- TO DELETE THE LAST 'AND ' 
  GeneralQry := GeneralQry || ' And ' || ParamQry;
end if ;


DBMS_OUTPUT.PUT_LINE ( GeneralQry);
--execute immediate 'select count(*) from (' || GeneralQry || ')' into rc ;
open p_cur for GeneralQry ;
                                                                
        EXCEPTION 
         WHEN OTHERS THEN 
             DBMS_OUTPUT.PUT_LINE (SQLERRM);
              RAISE;               
  END  pro_get_Find_Worker_Card;     
  
    function fct_MakatDateSql    (  P_STARTDATE in date,
                                                P_ENDDATE in date , 
                                                P_Makat in number,
                                                P_SIDURNUMBER in varchar,
                                                P_WORKERID in varchar ) return varchar as
GeneralQry varchar2(3000);
ParamQry varchar2(1000);
begin 

GeneralQry:= 'Select   distinct activity.makat_nesia,ACTIVITY.TAARICH  
                    From TB_peilut_Ovdim Activity, TB_Sidurim_Ovdim so 
                    WHERE  (so.mispar_ishi          = activity.mispar_ishi)  
                      And (so.mispar_sidur  = activity.mispar_sidur)
                      And (so.shat_hatchala = activity.shat_hatchala_sidur) 
                      And (so.taarich           = activity.taarich)  
                      And so.taarich between  ''' || trunc(P_STARTDATE) || ''' AND ''' || trunc(P_ENDDATE) || '''';

if (( P_WORKERID is not  null ) OR ( P_WORKERID <> '' )) THEN 
    ParamQry := ParamQry || '  so.mispar_ishi in (' || P_WORKERID || ') AND ';
end if ; 
if (( P_Makat is not  null ) OR ( P_Makat <> '' )) THEN 
    ParamQry := ParamQry || ' Activity.makat_nesia like  ''%' || P_Makat || '%'' AND ';
end if ; 
if (( P_SIDURNUMBER is not  null ) OR ( P_SIDURNUMBER <> '' )) THEN 
    ParamQry := ParamQry ||  PREPARE_LIKE_OF_LIST('Activity.mispar_sidur', P_SIDURNUMBER)  || ' AND ';
end if ; 
if (( ParamQry is not null  ) OR ( ParamQry <> '')) then 
  ParamQry := SUBSTR(ParamQry,0,LENGTH(ParamQry)-4); -- TO DELETE THE LAST 'AND ' 
  GeneralQry := GeneralQry || 'And ' || ParamQry;
end if ;

return GeneralQry ; 

EXCEPTION 
WHEN OTHERS THEN 
  RAISE;               
  END  fct_MakatDateSql;   
    
  procedure pro_Prepare_Catalog_Details ( GeneralQry in varchar ) as
CountQry varchar2(3000); 
InsertQry varchar2(3000); 
rc number ;                                                                
CountRows number ;
begin 
execute immediate  'truncate table tmp_Catalog' ;     
CountQry := 'Select  nvl(count(*),0)  from (' || GeneralQry || ')'  ;  
execute immediate CountQry INTO CountRows  ; 
--DBMS_OUTPUT.PUT_LINE ('5:'  || to_char(sysdate,'HH24:mi:ss'));
if (CountRows > 0 ) then 
 -- DBMS_OUTPUT.PUT_LINE (CountRows);
    InsertQry := 'INSERT INTO  TMP_CATALOG_DETAILS@kds_gw_at_tnpr (makat8,activity_date) ' || GeneralQry  ;
    -- DBMS_OUTPUT.PUT_LINE (InsertQry);                            
    execute immediate InsertQry ;
    --DBMS_OUTPUT.PUT_LINE ('6:'  || to_char(sysdate,'HH24:mi:ss'));
    -- Get the others details requiered from kds_gw_at_tnpr
    kds_catalog_pack.GetKavimDetails@kds_gw_at_tnpr(rc);
    --DBMS_OUTPUT.PUT_LINE ('7:'  || to_char(sysdate,'HH24:mi:ss'));
    -- copy the data from kds_gw_at_tnpr to local tmp_Catalog ( which trunkated on preserve - at the end of the session )
    insert into tmp_Catalog( activity_date,makat8, Shilut,Description,nihul_name,mazan_tashlum,mazan_tichnun,Km,sug_shirut_name,eilat_trip,onatiut) 
    SELECT activity_date, makat8, Shilut,Description,nihul_name,mazan_tashlum,mazan_tichnun,Km,sug_shirut_name,eilat_trip,onatiut  FROM TMP_CATALOG_DETAILS@kds_gw_at_tnpr ;
    commit ; 
 end if ; 

EXCEPTION 
WHEN OTHERS THEN 
  RAISE;               
  END  pro_Prepare_Catalog_Details;   
    
  procedure pro_get_Presence (p_cur out Curtype ,
                                                                 P_WorkerViewLevel in number, 
                                                                 P_WORKERID IN varchar2, 
                                                                 P_MISPAR_ISHI IN VARCHAR2 ,
                                                                 P_STARTDATE IN date,
                                                                 P_ENDDATE IN DATE)as  
GeneralQry varchar2(32767);
QryMakatDate varchar2(3000);
ParamQry varchar2(1000);
begin 
--TMP_MANAGE_TREE
INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_WorkerViewLevel:',P_WorkerViewLevel);
INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_WORKERID:',P_WORKERID);
INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_MISPAR_ISHI:',P_MISPAR_ISHI);
--INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_STARTDATE:',P_STARTDATE);
--INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_ENDDATE:',P_ENDDATE);

if (P_WorkerViewLevel = 5) then  
        pkg_utils.pro_ins_Manage_Tree(to_number(P_WORKERID,999999999));
end if ;

GeneralQry:= ' Select
             Ov.kod_hevra, So.mispar_ishi , Ov.shem_mish|| '' '' ||  Ov.shem_prat full_name,
            (PKG_OVDIM.fun_get_meafyen_oved(Ov.mispar_ishi, 3,''' || trunc(P_ENDDATE) || ''' )) START_TIME_ALLOWED ,
            (PKG_OVDIM.fun_get_meafyen_oved(Ov.mispar_ishi, 4,''' || trunc(P_ENDDATE) || ''')) END_TIME_ALLOWED ,
 isuk.teur_isuk ,Ezor.Teur_ezor,Maamad.teur_maamad_hr,snif.teur_snif_av,Sidur.teur_sidur_meychad,
So.chariga,So.hashlama,So.out_michsa, so.mispar_sidur,so.shat_hatchala, so.shat_gmar,so.taarich,MikumKnissa.Teur_Mikum_Yechida ClockEntry, MikumYetsia.Teur_Mikum_Yechida ClockExit,
dayofweek(so.taarich) DayOfWeek
from
TMP_PIRTEY_OVDIM Details  ,
(select po.mispar_ishi,max(po.ME_TARICH) me_taarich
                       from tmp_Pirtey_Ovdim PO
                       where po.isuk is not null
                             and (''' || trunc(P_STARTDATE) || '''  Between  po.ME_TARICH  and   nvl(po.ad_TARICH,to_date(''01/01/9999'' ,''dd/mm/yyyy''))
                               or   ''' || trunc(P_ENDDATE) || '''  Between  po.ME_TARICH  and   nvl(po.ad_TARICH,to_date(''01/01/9999'' ,''dd/mm/yyyy''))
                                or   po.ME_TARICH>= ''' || trunc(P_STARTDATE) || '''  and   nvl(po.ad_TARICH,to_date(''01/01/9999'' ,''dd/mm/yyyy''))<=  ''' || trunc(P_ENDDATE) || '''  )
                      group by po.mispar_ishi) RelevantDetails,
ovdim Ov,
ctb_ezor Ezor ,
ctb_maamad Maamad,
TB_Sidurim_Ovdim So,
TB_Sidurim_Meyuchadim Sm ,
ctb_isuk Isuk,
CTB_Mikum_Yechida MikumKnissa,
CTB_Mikum_Yechida MikumYetsia,
CTB_Sidurim_Meyuchadim Sidur,
ctb_snif_av Snif ' ;
if (P_WorkerViewLevel = 5) then
  GeneralQry := GeneralQry || ',TMP_MANAGE_TREE Tree ';
end if ;    
  GeneralQry := GeneralQry || 'where
Details.mispar_ishi = RelevantDetails.mispar_ishi 
And   so.mispar_ishi = Ov.Mispar_ishi (+)
and  Details.ME_TARICH = RelevantDetails.me_taarich (+)
and Ezor.kod_ezor(+) = Details.ezor
and EZOR.KOD_HEVRA = OV.KOD_HEVRA
and Isuk.KOD_HEVRA = OV.KOD_HEVRA
and Snif.KOD_HEVRA = OV.KOD_HEVRA 
and MAAMAD.KOD_HEVRA = OV.KOD_HEVRA
and maamad.kod_maamad_hr(+) =  details.maamad
and Snif.kod_snif_av(+) = details.snif_av
and So.mispar_ishi = Details.mispar_ishi
and SM.MISPAR_SIDUR = SO.MISPAR_SIDUR
and SM.KOD_MEAFYEN in (53,54)
and Sidur.kod_sidur_meyuchad(+) = so.mispar_sidur
and Isuk.kod_isuk(+) = details.isuk
and MikumKnissa.kod_mikum_yechida (+) =  to_number(substr(lpad(so.mikum_shaon_knisa  , 5, ''0''),0,3))
and MikumYetsia.kod_mikum_yechida (+) = to_number(substr(lpad(so.MIKUM_SHAON_YETZIA  , 5, ''0''),0,3))
and  (so.taarich     between     ''' || trunc(P_STARTDATE) || ''' AND ''' || trunc(P_ENDDATE) || ''')';
if (
       (
            (nvl(P_MISPAR_ISHI,-1) <> nvl(P_WORKERID,-1))  
            or  
            (P_WorkerViewLevel =0)
        )
    and ( (P_MISPAR_ISHI <> '' ) or   (P_MISPAR_ISHI is not null ))
  )then 
        ParamQry := ParamQry || '  So.mispar_ishi in (' || P_MISPAR_ISHI || ') AND ';
end if ; 


if (( ParamQry is not null  ) OR ( ParamQry <> '')) then
  ParamQry := SUBSTR(ParamQry,0,LENGTH(ParamQry)-4); -- TO DELETE THE LAST 'AND '
  GeneralQry := GeneralQry || 'And ' || ParamQry;
end if ;

if (P_WorkerViewLevel = 5) then
  GeneralQry := GeneralQry || 'And  RelevantDetails.mispar_ishi in Tree.mispar_ishi ';
end if ;    


  GeneralQry := GeneralQry || ' order by so.mispar_ishi, so.taarich ';
DBMS_OUTPUT.PUT_LINE ( GeneralQry);
--execute immediate 'select count(*) from (' || GeneralQry || ')' into rc ;
open p_cur for GeneralQry ;
       
           EXCEPTION 
         WHEN OTHERS THEN 
              RAISE;               
  END  pro_get_Presence;     

       

procedure pro_get_DriverWithoutTacograph  (p_cur out CurType , 
                                                                            p_ezor IN varchar2,
                                                                            p_Period in VARCHAR2) is 
    p_ToDate Date ; 
    p_FromDate date ; 
    p_Erech TB_Parametrim.erech_param%TYPE ;
    GeneralQry varchar2(32767);
    QryMakatDate varchar2(3000);
    ParamQry varchar2(1000);
begin
    p_FromDate := to_date('01/' || p_Period,'dd/mm/yyyy'); /* period= 05/2009=>  v_MinLimitDate = 01/05/2009 */
    p_ToDate := add_months(p_FromDate,1) -1 ;    /* period= 05/2009=>  v_MaxLimitDate = 31/05/2009 */
    PKG_UTILS.Pro_Get_Value_From_Parametrim(193,p_period,p_Erech);

    QryMakatDate :=  fct_MakatDateSql(p_FromDate ,p_ToDate  ,null ,null ,null  );
    pro_Prepare_Catalog_Details(QryMakatDate);
    COMMIT ; 
    GeneralQry :=  ' SELECT   Yao.mispar_ishi , Yao.taarich , Ov.shem_mish|| '' '' || Ov.shem_prat  Full_Name,
Activity.oto_no,Ezor.Teur_ezor,
So.mispar_sidur , So.shat_hatchala , So.shat_gmar , Snif.teur_snif_av , 0 Km  ,Mashar.vehicle_type_dscr ,Mashar.manufacture_year
from
  (Select mispar_ishi, taarich
From TB_Yamey_Avoda_Ovdim
Where Tachograf = 1 and 
Mispar_ishi in (Select Mispar_ishi  
                        From TB_Yamey_Avoda_Ovdim 
                        Where Tachograf = 1
                        AND taarich BETWEEN  ''' || trunc(p_FromDate) || '''  And  ''' || trunc(p_ToDate) || '''
                        Group by Mispar_ishi 
                        Having count(Mispar_ishi) >= ' || p_Erech || ' 
                        )
and taarich BETWEEN ''' || trunc(p_FromDate) || '''  And  ''' || trunc(p_ToDate) || ''') Yao ,
TMP_PIRTEY_OVDIM Details ,
 ovdim Ov,
ctb_snif_av Snif ,
TB_Sidurim_Ovdim So ,
TB_peilut_Ovdim Activity ,
(
select MISPAR_ISHI,TAARICH,MISPAR_SIDUR,SHAT_HATCHALA_SIDUR,MISPAR_KNISA,min(shat_yetzia) SHAT_YETZIA from TB_peilut_Ovdim
group by MISPAR_ISHI,TAARICH,MISPAR_SIDUR,SHAT_HATCHALA_SIDUR,MISPAR_KNISA
 ) RelevantActivity ,
ctb_ezor  Ezor ,
(select po.mispar_ishi,max(po.ME_TARICH) me_taarich
                       from tmp_Pirtey_Ovdim PO
                       where po.isuk is not null
                             and (''' || trunc(p_FromDate) || '''  Between  po.ME_TARICH  and   nvl(po.ad_TARICH,to_date(''01/01/9999'' ,''dd/mm/yyyy''))
                               or   ''' || trunc(p_ToDate) || '''  Between  po.ME_TARICH  and   nvl(po.ad_TARICH,to_date(''01/01/9999'' ,''dd/mm/yyyy''))
                                or   po.ME_TARICH>= ''' || trunc(p_ToDate) || '''  and   nvl(po.ad_TARICH,to_date(''01/01/9999'' ,''dd/mm/yyyy''))<=  ''' || trunc(p_ToDate) || '''  )
                      group by po.mispar_ishi) RelevantDetails,
VCL_GENERAL_VEHICLE_VIEW@kds2maale Mashar   
where 
 Yao.taarich between Details.me_tarich and Details.ad_tarich
and Ov.mispar_ishi(+) = Yao.mispar_ishi 
and So.taarich = Yao.Taarich
and So.mispar_ishi = Yao.mispar_ishi(+)
and So.mispar_ishi = Details.mispar_ishi(+)  
and Ezor.kod_ezor = Details.ezor  
and Ov.kod_hevra = Ezor.kod_hevra
and RelevantDetails.mispar_ishi = Ov.mispar_ishi 
and Details.mispar_ishi = RelevantDetails.mispar_ishi 
and Details.ME_TARICH = RelevantDetails.me_taarich
And Details.snif_av       = Snif.kod_snif_av(+)  
and (so.mispar_ishi        = activity.mispar_ishi(+))  
And (so.mispar_sidur      = activity.mispar_sidur(+))
And (so.shat_hatchala = activity.shat_hatchala_sidur(+)) 
and (so.taarich           = activity.taarich(+))
And        RelevantActivity.MISPAR_ISHI     = Activity.MISPAR_ISHI         
And        RelevantActivity.TAARICH         =  Activity.TAARICH              
And        RelevantActivity.MISPAR_SIDUR   =   Activity.MISPAR_SIDUR         
And        RelevantActivity.SHAT_HATCHALA_SIDUR =  Activity.SHAT_HATCHALA_SIDUR    
And        RelevantActivity.SHAT_YETZIA          =  Activity.SHAT_YETZIA           
And        RelevantActivity.MISPAR_KNISA      =  Activity.MISPAR_KNISA
AND  (Mashar.bus_number(+) = activity.oto_no)';

if (( p_ezor is not  null ) OR ( p_ezor <> '' )) THEN 
    ParamQry := ParamQry || '  Details.ezor in (' || p_ezor || ') AND ';
end if ; 

if (( ParamQry is not null  ) OR ( ParamQry <> '')) then 
  ParamQry := SUBSTR(ParamQry,0,LENGTH(ParamQry)-4); -- TO DELETE THE LAST 'AND ' 
  GeneralQry := GeneralQry || ' And ' || ParamQry;
end if ;
                      
DBMS_OUTPUT.PUT_LINE ( GeneralQry);

    open p_cur for GeneralQry ;
    
           EXCEPTION 
         WHEN OTHERS THEN 
              RAISE;               
  END  pro_get_DriverWithoutTacograph;     

  PROCEDURE Pro_Get_MaxTimeNoTacograph(p_cur out CurType , 
                                                                            p_Period in VARCHAR2) is 
  p_Erech TB_Parametrim.erech_param%TYPE ;
  BEGIN
   PKG_UTILS.Pro_Get_Value_From_Parametrim(193,p_period,p_Erech);
    open p_cur for select  p_erech ERECH_PARAM from dual ; 
           EXCEPTION 
         WHEN OTHERS THEN 
              RAISE;               
  END  Pro_Get_MaxTimeNoTacograph;           

procedure pro_get_SumDriverNotSigned  (p_cur out CurType , 
                                                                            p_ezor IN varchar2,
                                                                            p_Period in VARCHAR2) is 
    p_ToDate Date ; 
    p_FromDate date ; 
    p_Erech TB_Parametrim.erech_param%TYPE ;
    GeneralQry varchar2(32767);
    QryMakatDate varchar2(3000);
    ParamQry varchar2(1000);
  BEGIN
      p_FromDate := to_date('01/' || p_Period,'dd/mm/yyyy'); /* period= 05/2009=>  v_MinLimitDate = 01/05/2009 */
    p_ToDate := add_months(p_FromDate,1) -1 ;    /* period= 05/2009=>  v_MaxLimitDate = 31/05/2009 */
    PKG_UTILS.Pro_Get_Value_From_Parametrim(147,p_period,p_Erech);      
        GeneralQry :='
                  select Snif.teur_snif_av  ,So.taarich ,SUM (CASE WHEN So.mispar_ishi = 0 THEN 0 ELSE 1 END) Cnt
          from 
            (select po.mispar_ishi,max(po.ME_TARICH) me_taarich
                       from tmp_Pirtey_Ovdim PO
                       where po.isuk is not null
                             and (''' || trunc(p_FromDate) || '''  Between  po.ME_TARICH  and   nvl(po.ad_TARICH,to_date(''01/01/9999'' ,''dd/mm/yyyy''))
                               or   ''' || trunc(p_ToDate) || '''  Between  po.ME_TARICH  and   nvl(po.ad_TARICH,to_date(''01/01/9999'' ,''dd/mm/yyyy''))
                                or   po.ME_TARICH>= ''' || trunc(p_ToDate) || '''  and   nvl(po.ad_TARICH,to_date(''01/01/9999'' ,''dd/mm/yyyy''))<=  ''' || trunc(p_ToDate) || '''  )
                      group by po.mispar_ishi) RelevantDetails,
          TMP_PIRTEY_OVDIM Details ,
          (
              select taarich , mispar_ishi  from tb_sidurim_ovdim 
                    where mispar_ishi in ( 
                                              select /*+  index( tb_sidurim_ovdim,PK_SIDURIM )  */
                                               distinct mispar_ishi from tb_sidurim_ovdim
                                              Where Nidreshet_hitiatzvut > 0 
                                                      And (
                                                                    Shat_hitiatzvut is null and (Ptor_Mehitiatzvut is null or Ptor_Mehitiatzvut = 0)
                                                              OR 
                                                              (     Shat_hitiatzvut is not null 
                                                                        And Kod_SIBA_LEDIVUCH_YADANI_in in (
                                                                                                select Kod_Siba from CTB_SIBOT_LEDIVUCH_YADANI Where Mutzdak = 0))
                                                                                                )
                                              and taarich BETWEEN  ''' || trunc(p_FromDate) || '''  And  ''' || trunc(p_ToDate) || '''                                 
                                              )
                  UNION
                  select to_date(x,''dd/mm/yyyy'') Taarich ,0 
                                      from table(cast(convert_string_to_table(STRING_DATES_OF_PERIOD(''' ||p_Period || '''),'','') as mytabtype))
          )         So, 
          ctb_snif_av Snif 
          where  
                  Details.mispar_ishi = RelevantDetails.mispar_ishi 
            and Details.ME_TARICH = RelevantDetails.me_taarich 
            and to_char(So.taarich,''MM/YYYY'') = ''' || p_Period || '''
            and Snif.kod_snif_av = Details.snif_av(+) 
            and SNIF.EZOR = Details.ezor
             and (( So.mispar_ishi <> 0 AND RelevantDetails.mispar_ishi = So.mispar_ishi  ) OR  (So.mispar_ishi = 0    ))
        ';
        
    
    
    if (( p_ezor is not  null ) OR ( p_ezor <> '' )) THEN 
    ParamQry := ParamQry || '  SNIF.ezor in (' || p_ezor || ') AND ';
end if ; 

if (( ParamQry is not null  ) OR ( ParamQry <> '')) then 
  ParamQry := SUBSTR(ParamQry,0,LENGTH(ParamQry)-4); -- TO DELETE THE LAST 'AND ' 
  GeneralQry := GeneralQry || ' And ' || ParamQry ;  
end if ;
          
  GeneralQry := GeneralQry ||  
          'group by cube(Snif.teur_snif_av,So.taarich )
          having grouping (Snif.teur_snif_av) = 0 AND grouping (So.taarich)  = 0 
          order by So.taarich ' ;             
DBMS_OUTPUT.PUT_LINE ( GeneralQry);

    open p_cur for GeneralQry ;
    
           EXCEPTION 
         WHEN OTHERS THEN 
              RAISE;               
  END  pro_get_SumDriverNotSigned;           
  
  PROCEDURE Pro_Get_MaxTimeNoSignature(p_cur out CurType , 
                                                                            p_Period in VARCHAR2) is 
  p_Erech TB_Parametrim.erech_param%TYPE ;
  BEGIN
   PKG_UTILS.Pro_Get_Value_From_Parametrim(147,p_period,p_Erech);
    open p_cur for select  p_erech ERECH_PARAM from dual ; 
           EXCEPTION 
         WHEN OTHERS THEN 
              RAISE;               
  END  Pro_Get_MaxTimeNoSignature;           
  

  procedure pro_get_DriverNotSigned  (p_cur out CurType , 
                                                                            p_ezor IN varchar2,
                                                                            p_Period in VARCHAR2) is 
    p_ToDate Date ; 
    p_FromDate date ; 
    p_Erech TB_Parametrim.erech_param%TYPE ;
    GeneralQry varchar2(32767);
    ParamQry varchar2(1000);        
  BEGIN
INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'p_ezor:',p_ezor);
INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'p_Period:',p_Period);
      p_FromDate := to_date('01/' || p_Period,'dd/mm/yyyy'); /* period= 05/2009=>  v_MinLimitDate = 01/05/2009 */
    p_ToDate := add_months(p_FromDate,1) -1 ;    /* period= 05/2009=>  v_MaxLimitDate = 31/05/2009 */
    PKG_UTILS.Pro_Get_Value_From_Parametrim(147,p_period,p_Erech);
    GeneralQry := '
              select Snif.teur_snif_av  ,Details.mispar_ishi, Ezor.Teur_ezor,Ov.shem_mish || '' '' || Ov.shem_prat full_name,
          So.taarich, So.mispar_sidur,
          case nidreshet_hitiatzvut 
                  when 1  then So.shat_hatchala 
                  else null end StartTime1 , 
          case nidreshet_hitiatzvut 
                    when 1  then shat_gmar
                    else null end EndTime1, 
          case nidreshet_hitiatzvut 
                  when 2  then So.shat_hatchala 
                  else null end StartTime2 , 
          case nidreshet_hitiatzvut 
                    when 2  then So.shat_gmar
                    else null end EndTime2 
          from 
            tb_sidurim_ovdim So, 
          (
              select mispar_ishi 
              from tb_sidurim_ovdim 
              where 
              taarich BETWEEN  ''' || trunc(p_FromDate) || '''  And  ''' || trunc(p_ToDate) || '''          
              and Nidreshet_hitiatzvut > 0 
              And (
                      (Shat_hitiatzvut is null and (Ptor_Mehitiatzvut is null or Ptor_Mehitiatzvut = 0))
                       OR 
                      (Shat_hitiatzvut is not null And Kod_SIBA_LEDIVUCH_YADANI_in in (select Kod_Siba from CTB_SIBOT_LEDIVUCH_YADANI Where Mutzdak = 0))
                      )
            group by mispar_ishi
            having count(mispar_ishi) >' ||  p_Erech ||' 
            ) SoHasHitiatsvout,
          TMP_PIRTEY_OVDIM  Details ,
            (
                select po.mispar_ishi,max(po.ME_TARICH) me_taarich
                from tmp_Pirtey_Ovdim PO
                where po.isuk is not null
                and (''' || trunc(P_FromDate) || ''' Between po.ME_TARICH and nvl(po.ad_TARICH,to_date(''01/01/9999'' ,''dd/mm/yyyy''))
                or ''' || trunc(P_ToDate) || ''' Between po.ME_TARICH and nvl(po.ad_TARICH,to_date(''01/01/9999'' ,''dd/mm/yyyy''))
                or po.ME_TARICH>=''' || trunc(P_ToDate) || ''' and nvl(po.ad_TARICH,to_date(''01/01/9999'' ,''dd/mm/yyyy''))<=''' || trunc(P_ToDate) || ''' )
                group by po.mispar_ishi
            ) RelevantDetails ,
          ctb_snif_av Snif ,
         ovdim  Ov,
          ctb_ezor Ezor
          where  
          SO.MISPAR_ISHI = SoHasHitiatsvout.MISPAR_ISHI 
        and Ov.kod_hevra = Ezor.kod_hevra
        and Details.mispar_ishi = RelevantDetails.mispar_ishi 
        and Details.ME_TARICH = RelevantDetails.me_taarich (+)
        And so.mispar_ishi = Ov.Mispar_ishi (+)
        and Ezor.kod_ezor  = Details.ezor
        and EZOR.KOD_HEVRA = OV.KOD_HEVRA
        and Snif.KOD_HEVRA = OV.KOD_HEVRA 
        and Snif.kod_snif_av(+) = details.snif_av
        and SoHasHitiatsvout.mispar_ishi = Details.mispar_ishi
        and So.taarich between ''' || trunc(p_FromDate) || '''  And  ''' || trunc(p_ToDate) || '''                                 
        and SO.MISPAR_ISHI = SoHasHitiatsvout.mispar_ishi
        and So.Nidreshet_hitiatzvut > 0 
              And (
                        (So.Shat_hitiatzvut is null and (So.Ptor_Mehitiatzvut is null or So.Ptor_Mehitiatzvut = 0))
                        OR 
                        (So.Shat_hitiatzvut is not null And So.Kod_SIBA_LEDIVUCH_YADANI_in in (select Kod_Siba from CTB_SIBOT_LEDIVUCH_YADANI Where Mutzdak = 0))
                    )  ';
if (( P_EZOR is not  null ) OR ( P_EZOR <> '' )) THEN 
    ParamQry := ParamQry || ' EZOR.kod_ezor in (' || P_EZOR || ') AND ';
end if ; 

if (( ParamQry is not null  ) OR ( ParamQry <> '')) then
  ParamQry := SUBSTR(ParamQry,0,LENGTH(ParamQry)-4); -- TO DELETE THE LAST 'AND '
  GeneralQry := GeneralQry || 'And ' || ParamQry || 'order by So.taarich,SO.MISPAR_ISHI' ;
end if ;

DBMS_OUTPUT.PUT_LINE ( GeneralQry);
--execute immediate 'select count(*) from (' || GeneralQry || ')' into rc ;
open p_cur for GeneralQry ;      
      
           EXCEPTION 
         WHEN OTHERS THEN 
              RAISE;               
  END  pro_get_DriverNotSigned;          


  
 Procedure Pro_Get_DisregardDrivers(p_Cur out CurType ,
                                     P_DISREGARDTYPE IN VARCHAR2,                                                                              
                                     p_Period in VARCHAR2) 
is 
    p_ToDate Date ; 
    p_FromDate date ; 
    GeneralQry varchar2(32767);
  BEGIN
        p_FromDate := to_date('01/' || p_Period,'dd/mm/yyyy'); /* period= 05/2009=>  v_MinLimitDate = 01/05/2009 */
        p_ToDate := add_months(p_FromDate,1) -1 ;    /* period= 05/2009=>  v_MaxLimitDate = 31/05/2009 */
    GeneralQry:= '
    SELECT
Ov.shem_mish || '' '' || Ov.shem_prat full_name , 
Yao.mispar_ishi , Yao.taarich , dayofweek(Yao.taarich) DayOfWeek ,
So.mispar_sidur , So.shat_hatchala , So.shat_gmar , 
Activity.oto_no,
Ezor.Teur_ezor,
Snif.teur_snif_av
from 
TB_Yamey_Avoda_Ovdim Yao ,
ovdim Ov ,
tmp_Pirtey_Ovdim Details ,
(
    select po.mispar_ishi,max(po.ME_TARICH) me_taarich
    from tmp_Pirtey_Ovdim PO
    where po.isuk is not null
    and (''' || trunc(P_FromDate) || ''' Between po.ME_TARICH and nvl(po.ad_TARICH,to_date(''01/01/9999'' ,''dd/mm/yyyy''))
    or ''' || trunc(P_ToDate) || ''' Between po.ME_TARICH and nvl(po.ad_TARICH,to_date(''01/01/9999'' ,''dd/mm/yyyy''))
    or po.ME_TARICH>=''' || trunc(P_ToDate) || ''' and nvl(po.ad_TARICH,to_date(''01/01/9999'' ,''dd/mm/yyyy''))<=''' || trunc(P_ToDate) || ''' )
    group by po.mispar_ishi
) RelevantDetails ,
TB_Sidurim_Ovdim So ,
(
    select taarich, shat_hatchala_sidur,SHAT_YETZIA,mispar_sidur, oto_no,mispar_ishi 
    from TB_peilut_Ovdim a
    where to_char(taarich,''MM/YYYY'') = ''' || p_Period || ''' 
             and SHAT_YETZIA = (
                                            select distinct min(SHAT_YETZIA) OVER (PARTITION BY taarich,mispar_ishi) 
                                            from TB_peilut_Ovdim b
                                            where to_char(taarich,''MM/YYYY'') = ''' || p_Period || ''' 
                                                and MISPAR_KNISA = 0
                                                and a.mispar_ishi=b.mispar_ishi
                                                and a.taarich=b.taarich)
            and MISPAR_KNISA = 0
) Activity ,
ctb_ezor Ezor,
ctb_snif_av Snif 
where 
 So.taarich = Yao.Taarich
and So.mispar_ishi = Yao.mispar_ishi
and So.mispar_ishi = Details.mispar_ishi 
and Ezor.kod_ezor = Details.ezor 
and Ov.kod_hevra = Ezor.kod_hevra
and RelevantDetails.mispar_ishi = Ov.mispar_ishi 
and Details.mispar_ishi = RelevantDetails.mispar_ishi 
and Details.ME_TARICH = RelevantDetails.me_taarich
And Details.snif_av = Snif.kod_snif_av(+) 
and Ov.kod_hevra = Snif.kod_hevra
and (so.mispar_ishi = activity.mispar_ishi) 
And (so.mispar_sidur = activity.mispar_sidur)
And (so.shat_hatchala = activity.shat_hatchala_sidur) 
and (so.taarich = activity.taarich)
AND Yao.Measher_O_Mistayeg is null
and to_char(Yao.taarich,''MM/YYYY'') =''' || p_Period || '''' ; 

--and SO.MISPAR_ISHI= 65441
    
    if ( P_DISREGARDTYPE= 'DisregardDriversVisot') THEN 
         GeneralQry := GeneralQry || ' and (So.SECTOR_VISA >= 0) ';
    end if ; 
 GeneralQry := GeneralQry || ' order by Snif.teur_snif_av ,Yao.Mispar_ishi ,yao.taarich,So.shat_hatchala '; 
                      
DBMS_OUTPUT.PUT_LINE ( GeneralQry);

    open p_cur for GeneralQry ;
    
               EXCEPTION 
         WHEN OTHERS THEN 
              RAISE;               
  END  Pro_Get_DisregardDrivers; 
 
  Procedure Pro_Get_PremiotPresence(p_Cur out CurType ,
                                                        p_kod_premia in MEAFYENIM_OVDIM.KOD_MEAFYEN%type,  
                                                        P_MISPAR_ISHI in varchar,                                                                            
                                                        p_Period in VARCHAR2) 
is 
  p_ToDate Date ; 
  p_FromDate date ; 
GeneralQry varchar2(32767);
QryMakatDate varchar2(3000);
ParamQry varchar2(1000);

    p_Erech TB_Parametrim.erech_param%TYPE ;
  BEGIN
      p_FromDate := to_date('01/' || p_Period,'dd/mm/yyyy'); /* period= 05/2009=>  v_MinLimitDate = 01/05/2009 */
    p_ToDate := add_months(p_FromDate,1) -1 ;    /* period= 05/2009=>  v_MaxLimitDate = 31/05/2009 */

--INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'p_kod_premia:',p_kod_premia);
--INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_MISPAR_ISHI:',P_MISPAR_ISHI);
--INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'p_Period:',p_Period);
  GeneralQry :='    SELECT  
            Ov.kod_hevra, Ov.mispar_ishi , (Ov.shem_mish|| '' '' ||  Ov.shem_prat) Full_Name, 
            (PKG_OVDIM.fun_get_meafyen_oved(Ov.mispar_ishi, 56,''' || trunc(P_ToDate) || '''  )) Wording_date, 
            (PKG_OVDIM.fun_get_meafyen_oved(Ov.mispar_ishi, 3, ''' || trunc(P_ToDate) || ''' )) START_TIME_ALLOWED ,
            (PKG_OVDIM.fun_get_meafyen_oved(Ov.mispar_ishi, 4,''' || trunc(P_ToDate) || ''')) END_TIME_ALLOWED,
            So.mispar_ishi ,
            Gil.Teur_kod_gil ,Isuk.teur_isuk,    Maamad.teur_maamad_hr, Ezor.Teur_ezor,
            Snif.teur_snif_av  ,CY. Erech_Rechiv Min_Presence ,
            So.taarich , dayofweek(So.taarich) DayOfWeek ,
            So.mispar_sidur , So.shat_hatchala , So.shat_gmar,
            So.Pitzul_hafsaka,So.Chariga,Yao.Hamarat_shabat,So.Hashlama,So.Out_michsa,
            Yao.LINA,Yao.BITUL_ZMAN_NESIOT,Yao.HALBASHA ,Ct.TEUR_SIDUR_MEYCHAD
    from 
            TB_Sidurim_Meyuchadim SM, 
            CTB_Sidurim_Meyuchadim CT,
            CTB_Kod_Gil Gil, 
            ovdim Ov ,
            TMP_PIRTEY_OVDIM  Details ,
            TB_Sidurim_Ovdim So ,
            ctb_ezor Ezor,
            ctb_snif_av Snif ,
            ctb_maamad  Maamad ,
            ctb_isuk  Isuk,
            TB_Yamey_Avoda_Ovdim Yao ,
            TB_Chishuv_Yomi_Ovdim CY, 
            TB_Bakashot B,
            (select po.mispar_ishi,max(po.ME_TARICH) me_taarich
                       from tmp_Pirtey_Ovdim PO
                       where po.isuk is not null
                             and ( ''' || trunc(P_FromDate) || '''  Between  po.ME_TARICH  and   nvl(po.ad_TARICH,to_date(''01/01/9999'' ,''dd/mm/yyyy''))
                               or   ''' || trunc(P_ToDate) || ''' Between  po.ME_TARICH  and   nvl(po.ad_TARICH,to_date(''01/01/9999'' ,''dd/mm/yyyy''))
                                or   po.ME_TARICH>= ''' || trunc(P_FromDate) || '''   and   nvl(po.ad_TARICH,to_date(''01/01/9999'' ,''dd/mm/yyyy''))<=  ''' || trunc(P_ToDate) || '''  )
                      group by po.mispar_ishi) RelevantDetails
    where 
                  Details.mispar_ishi = Ov.mispar_ishi    
            and Details.mispar_ishi = RelevantDetails.mispar_ishi 
            and Details.ME_TARICH = RelevantDetails.me_taarich
            and Details.GIL         = Gil.kod_gil_hr 
            and Ezor.kod_ezor (+) = Details.ezor 
            and Snif.kod_hevra = Ov.kod_hevra 
            and Ezor.kod_hevra = Ov.kod_hevra 
            and Isuk.kod_hevra = Ov.kod_hevra   
            and maamad.kod_maamad_hr(+) =  details.maamad  
            and Snif.kod_snif_av(+) = details.snif_av  
            and So.mispar_ishi = Details.mispar_ishi(+)  
            and Ct.kod_sidur_meyuchad(+) = so.mispar_sidur 
            and Isuk.kod_isuk(+) = details.isuk 
            and So.mispar_ishi= Yao.mispar_ishi
            and So.taarich between Details.me_tarich and Details.ad_tarich
            and Yao.taarich between Details.me_tarich and Details.ad_tarich
            and So.taarich = Yao.Taarich
            and So.mispar_sidur =  Sm.Mispar_sidur
            and Ov.mispar_ishi(+) = Cy.mispar_ishi 
            and CT.Kod_Sidur_Meyuchad=SM.Mispar_sidur
            And SM.Kod_Meafyen IN (53,54)
            and (sm.Me_Taarich <=  ''' || trunc(P_ToDate) || '''  ) and (sm.Ad_Taarich >= ''' || trunc(P_FromDate) || '''  or sm.Ad_Taarich is null )
            and Yao.taarich BETWEEN ''' || trunc(P_FromDate) || '''  And  ''' || trunc(P_ToDate) || ''' 
            and TO_CHAR(CY.Tkufa,''MM/YYYY'') = ''' || p_Period || '''
            And CY.Kod_Rechiv IN ( 
                                       Select SP.KOD_RACHIV_NOCHECHUT from 
                                     CTB_SUGEY_PREMIOT Sp 
                                       where SP.KOD_PREMIA =' || p_kod_premia || ') 
          And CY.Bakasha_ID = B.Bakasha_ID
        and CY.TAARICH = YAO.TAARICH
         And B.Huavra_Lesachar=1
          And B. Taarich_Haavara_Lesachar =  (
           Select Max(Taarich_Haavara_Lesachar)
                                                                From Tb_Bakashot B1, Tb_Chishuv_Chodesh_Ovdim B2
                                                                Where B1.Bakasha_Id= B2.Bakasha_Id
                                                                And   B2. Mispar_Ishi= Cy.Mispar_Ishi
                                                                And To_Char(B2.Taarich,''MM/YYYY'') = ''' || p_Period || '''
                                                                And B1. Huavra_Lesachar=1
                                                                Group By B2. Mispar_Ishi, B1.Bakasha_Id 
                                                                )'    ;
  
if (( P_MISPAR_ISHI is not  null ) OR ( P_MISPAR_ISHI <> '' )) THEN 
    ParamQry := ParamQry || '   CY.mispar_ishi in (' || P_MISPAR_ISHI || ') AND ';
end if ; 

if (( ParamQry is not null  ) OR ( ParamQry <> '')) then 
  ParamQry := SUBSTR(ParamQry,0,LENGTH(ParamQry)-4); -- TO DELETE THE LAST 'AND ' 
  GeneralQry := GeneralQry || ' And ' || ParamQry;
end if ;
  GeneralQry := GeneralQry || ' order by Yao.Mispar_ishi ,yao.taarich,So.shat_hatchala,So.shat_gmar';
DBMS_OUTPUT.PUT_LINE ( GeneralQry);
--execute immediate 'select count(*) from (' || GeneralQry || ')' into rc ;
open p_cur for GeneralQry ;



               EXCEPTION 
         WHEN OTHERS THEN 
              RAISE;         
 END  Pro_Get_PremiotPresence;
 
 
 /***************************************************************/
 PROCEDURE pro_get_rizot_chishuv_succeed(  P_CHODESH_HARAZA  IN VARCHAR2,
                                                                                           p_Cur out CurType)  IS

  p_ToDate Date ; 
  p_FromDate date ; 
  --  p_Erech TB_Parametrim.erech_param%TYPE ;
  BEGIN
if  ( trim(P_CHODESH_HARAZA) != '-1' ) then  
      p_FromDate := to_date('01/' || P_CHODESH_HARAZA ,'dd/mm/yyyy'); /* period= 05/2009=>  v_MinLimitDate = 01/05/2009 */
     p_ToDate := add_months(p_FromDate,1) -1 ;
     end if ;   
 
    open p_cur for   
        SELECT BAKASHA_ID,Pirtey_Riza FROM(
                 SELECT -1 BAKASHA_ID, '' Pirtey_Riza, 1 ord , sysdate  ZMAN_HATCHALA from dual 
            UNION
                 SELECT TB.BAKASHA_ID, TB.BAKASHA_ID || ' -  ' || TB.TEUR || ' -  ' || 
                   replace(TB.ZMAN_HATCHALA,'-',' ') || (CASE     TB.HUAVRA_LESACHAR WHEN '1' THEN  ' -    '  ELSE ''  END)  Pirtey_Riza , 2 ord , TB.ZMAN_HATCHALA ZMAN_HATCHALA
                   FROM  TB_BAKASHOT TB  
                   WHERE  TB.STATUS=2 AND
                   TB.SUG_BAKASHA=1 AND
                   (  (trim(P_CHODESH_HARAZA) != '-1'  and  (TB.ZMAN_HATCHALA   BETWEEN p_FromDate And p_ToDate) ) or trim(P_CHODESH_HARAZA) = '-1')
                   ORDER BY ord , ZMAN_HATCHALA);


     EXCEPTION 
                WHEN OTHERS THEN 
                       RAISE;         
 END  pro_get_rizot_chishuv_succeed;
  /***************************************************************/
PROCEDURE  pro_get_maamadot(p_Cur out CurType )  IS
BEGIN

    OPEN p_Cur FOR 
        select ' ' description  , -1 kod from dual
    union  
        SELECT '' description,1 kod  from dual 
    UNION 
        SELECT '' , 2  from dual;
                         
 EXCEPTION 
                WHEN OTHERS THEN 
                       RAISE;         
END   pro_get_maamadot;
 /***************************************************************/
procedure pro_get_AbsenceType( p_Cur out CurType ) is 
Begin 
open p_Cur For
select KOD_HEADRUT_CLALI, TEUR_CLALI from 
(
select -1 KOD_HEADRUT_CLALI , ' ' TEUR_CLALI  , 1 ord from dual
union  
select  distinct CTB.KOD_HEADRUT_CLALI, CTB.TEUR_CLALI, 2 ord from
    CTB_SUGEY_HEADRUYUT Ctb   where CTB.KOD_HEADRUT_CLALI is not null 
    order by ord, TEUR_CLALI
    ) ; 

    
EXCEPTION 
                WHEN OTHERS THEN 
                       RAISE;         
END   pro_get_AbsenceType;

 /***************************************************************/
procedure pro_get_WorkDayList( p_Cur out CurType ) is 
Begin 
open p_Cur For
select KOD,Description from 
(
select -1 KOD , ' ' Description  , 1 ord from dual
union  
select 5 KOD , '5  ' Description  , 2 ord from dual
union
select 6 KOD , '6  ' Description  , 3 ord from dual
    order by ord, Description
 ) ;
EXCEPTION 
                WHEN OTHERS THEN 
                       RAISE;         
END   pro_get_WorkDayList;
 /***************************************************************/
PROCEDURE  pro_get_pirtey_rizot(listMispareiRizot in varchar2,
                                                                              IdReport in number,
                                                                      strChodashim in varchar2,
                                                                   p_Cur out CurType )  IS
BEGIN

          OPEN p_Cur FOR 
		  	   SELECT  TB.BAKASHA_ID, TB.TEUR, TB.ZMAN_HATCHALA, TB.HUAVRA_LESACHAR ,			   
  		  		case IdReport when 1 then '  ' else '  '  end koteret, 
			    case strChodashim when null then null else  substr(strChodashim,0,7)   end chodesh
		    FROM TB_BAKASHOT TB  
               WHERE TB.BAKASHA_ID =substr(listMispareiRizot,0,instr(listMispareiRizot,',')-1)  
union 
	  
	  SELECT  TB.BAKASHA_ID, TB.TEUR, TB.ZMAN_HATCHALA, TB.HUAVRA_LESACHAR ,			   
  		  		case IdReport when 1 then '  ' else  '   ' end koteret, 
			    case strChodashim when null then null else  substr(strChodashim,9,7)   end chodesh
		   FROM TB_BAKASHOT TB  
               WHERE TB.BAKASHA_ID =substr(listMispareiRizot,instr(listMispareiRizot,',')+1); 
                /*  SELECT  TB.BAKASHA_ID, TB.TEUR, TB.ZMAN_HATCHALA, TB.HUAVRA_LESACHAR ,
                   case IdReport when 1 then 
                          ( case instr(listMispareiRizot,',' || to_char(TB.BAKASHA_ID))  when 0 then ':  ' else ':  '  end)
                   else
                         (     case instr(listMispareiRizot,',' || to_char(TB.BAKASHA_ID))  when 0 then ':  ' else ':   '  end) end koteret,
               case strChodashim when null then null
			   else ( case instr(listMispareiRizot,',' || to_char(TB.BAKASHA_ID))  when 0 then  substr(strChodashim,0,7)  else substr(strChodashim,9,7)  end) end chodesh
			--   case  instr(strChodashim,',')   when 7 then substr(strChodashim,0,7) else substr(strChodashim,7,7) )end chodesh
        --       case instr(listMispareiRizot,',' || to_char(TB.BAKASHA_ID))  when 0 then '  :' else '  :' end koteret
               FROM TB_BAKASHOT TB  
               WHERE TB.BAKASHA_ID in (select x from table(cast(convert_string_to_table(listMispareiRizot ,  ',') as mytabtype)));
			   */      
END pro_get_pirtey_rizot;
 /***************************************************************/
PROCEDURE  pro_getNetuneyHashvaatRizot( P_CHODESH in varchar2,
                                                                                                              P_MIS_RITZA in integer,
                                                                                                          P_MIS_RITZA_LEHASVAA in integer, 
                                                                                                      P_MAMAD in varchar2,
                                                                                                      P_ISUK in varchar2,
                                                                                                      P_MISPAR_ISHI in varchar2,
                                                                                           p_Cur out CurType )  IS
                                                                   
BEGIN
                OPEN p_Cur FOR     
                    SELECT H.TAARICH,H.MISPAR_ISHI, H.KOD_RECHIV,H.XX,H.YY,H.HEFRESH,
                                      OV.SHEM_MISH || ' ' ||  OV.SHEM_PRAT  FULL_NAME ,
                                       I. TEUR_ISUK ISUK,M.TEUR_MAAMAD_HR MAAMAD, E.TEUR_EZOR EZOR, S.TEUR_SNIF_AV SNIF,R.TEUR_RECHIV
                    FROM
                                       TMP_PIRTEY_OVDIM T ,
                                        OVDIM OV,
                                        CTB_MAAMAD M,
                                        CTB_ISUK I,
                                        CTB_EZOR E,
                                         CTB_SNIF_AV S,
                                         CTB_RECHIVIM R,
                                            (SELECT decode(A.TAARICH,null,B.TAARICH,A.TAARICH) TAARICH,                 
																decode(A.MISPAR_ISHI,null,B.MISPAR_ISHI,A.MISPAR_ISHI) MISPAR_ISHI , 
                                                               decode(A.KOD_RECHIV,null,B.KOD_RECHIV,A.KOD_RECHIV) KOD_RECHIV,
															   nvl(A.ERECH_RECHIV,0) XX,nvl(B.ERECH_RECHIV,0) YY,
                                                                (NVL(A.ERECH_RECHIV,0)-NVL(B.ERECH_RECHIV,0) ) HEFRESH
                                              FROM
                                                        (SELECT A.MISPAR_ISHI,A.KOD_RECHIV,A.ERECH_RECHIV,A.TAARICH
                                                        FROM  TB_CHISHUV_CHODESH_OVDIM A
                                                        WHERE A.BAKASHA_ID = P_MIS_RITZA
                                                            AND (TO_CHAR(A.TAARICH,'mm/yyyy')=P_CHODESH OR P_CHODESH = '-1')
                                                            AND ((P_MISPAR_ISHI  IS NULL) OR A.MISPAR_ISHI IN (SELECT X FROM TABLE(CAST(CONVERT_STRING_TO_TABLE( P_MISPAR_ISHI,  ',') AS MYTABTYPE))) )) A
                                            FULL JOIN
                                                    (SELECT B.MISPAR_ISHI, B.KOD_RECHIV,B.ERECH_RECHIV,B.TAARICH
                                                    FROM  TB_CHISHUV_CHODESH_OVDIM B
                                                    WHERE B.BAKASHA_ID =P_MIS_RITZA_LEHASVAA
                                                        AND (TO_CHAR(B.TAARICH,'mm/yyyy')=P_CHODESH OR P_CHODESH = '-1')
                                                        AND ( ( P_MISPAR_ISHI  IS NULL) OR B.MISPAR_ISHI IN (SELECT X FROM TABLE(CAST(CONVERT_STRING_TO_TABLE( P_MISPAR_ISHI ,  ',') AS MYTABTYPE)))  )) B
                                            ON B.MISPAR_ISHI=A.MISPAR_ISHI
                                                            AND  B.KOD_RECHIV=A.KOD_RECHIV
                                                            AND B.TAARICH=A.TAARICH)     H
                    WHERE    
                                         H.MISPAR_ISHI = OV.MISPAR_ISHI (+)
                                        AND H.MISPAR_ISHI = T.MISPAR_ISHI
                                        AND T.MAAMAD =   M.KOD_MAAMAD_HR 
                                         AND OV.KOD_HEVRA=M.KOD_HEVRA
                                        AND T.ISUK = I.KOD_ISUK 
                                        AND OV.KOD_HEVRA=I.KOD_HEVRA
                                        AND T.EZOR = E.KOD_EZOR
                                        AND OV.KOD_HEVRA=E.KOD_HEVRA
                                        AND T.SNIF_AV = S.KOD_SNIF_AV
                                        AND OV.KOD_HEVRA=S.KOD_HEVRA
                                        AND H.KOD_RECHIV = R.KOD_RECHIV 
                                        AND (ADD_MONTHS(H.TAARICH,1) -1) BETWEEN T.ME_TARICH AND T.AD_TARICH
                                        AND (  (P_ISUK IS NULL) OR T.ISUK IN (SELECT X FROM TABLE(CAST(CONVERT_STRING_TO_TABLE(P_ISUK ,  ',') AS MYTABTYPE)))    )
                                         AND ( (P_MAMAD = '-1') OR substr(T.MAAMAD,0,1) IN (SELECT X FROM TABLE(CAST(CONVERT_STRING_TO_TABLE(P_MAMAD ,  ',') AS MYTABTYPE)))     )
                        
                        ORDER BY H.MISPAR_ISHI,H.TAARICH,R.TEUR_RECHIV;
                            
                        EXCEPTION 
                WHEN OTHERS THEN 
                       RAISE;                                                                                     
END pro_getNetuneyHashvaatRizot;                                                                                            

 /***************************************************************/
PROCEDURE pro_get_rizot_chishuv_lehodesh(  P_CHODESH_HARAZA  IN VARCHAR2,
                                                                                           p_Cur out CurType) IS
                                                                                                                                                    
       p_FromDate date ; 

  BEGIN
if  ( trim(P_CHODESH_HARAZA) != '-1' ) then  
    p_FromDate := to_date('01/' || P_CHODESH_HARAZA ,'dd/mm/yyyy'); /* period= 05/2009=>  v_MinLimitDate = 01/05/2009 */
     end if ;   
 
    open p_cur for   
        SELECT BAKASHA_ID,Pirtey_Riza FROM(
                 SELECT -1 BAKASHA_ID, '' Pirtey_Riza, 1 ord , sysdate  ZMAN_HATCHALA from dual 
            UNION
                 SELECT TB.BAKASHA_ID, TB.BAKASHA_ID || ' -  ' || TB.TEUR || ' -  ' || 
                   replace(TB.ZMAN_HATCHALA,'-',' ') || (CASE     TB.HUAVRA_LESACHAR WHEN '1' THEN  ' -    '  ELSE ''  END)  Pirtey_Riza , 2 ord , TB.ZMAN_HATCHALA ZMAN_HATCHALA
                   FROM  TB_BAKASHOT TB ,
                                      TB_BAKASHOT_PARAMS P
                   WHERE  TB.STATUS=2 AND
                                          TB.SUG_BAKASHA= 1 AND
                                           TB.BAKASHA_ID = P.BAKASHA_ID AND
                                       (add_months( to_date('01/' || P.ERECH, 'dd/mm/yyyy') ,1) -1    >= p_FromDate)  AND
                                      P.PARAM_ID =2
        --           (  (trim(P_CHODESH_HARAZA) != '-1'  and  (TB.ZMAN_HATCHALA   BETWEEN p_FromDate And p_ToDate) ) or trim(P_CHODESH_HARAZA) = '-1')
                   ORDER BY ord , ZMAN_HATCHALA Desc);


     EXCEPTION 
                WHEN OTHERS THEN 
                       RAISE;    
      
END  pro_get_rizot_chishuv_lehodesh;

 /***************************************************************/
PROCEDURE  pro_get_ramot_chishuv_letezuga(p_Cur out CurType )  IS
BEGIN

               OPEN p_Cur FOR 
                              SELECT '' description,1kod  from dual 
                         UNION 
                          SELECT '' , 2  from dual;
                         
 EXCEPTION 
                WHEN OTHERS THEN 
                       RAISE;         
END   pro_get_ramot_chishuv_letezuga;

 /***************************************************************/
PROCEDURE  pro_GetHashvaatChodsheyRizot( P_CHODESH in varchar2,
                                                                                                           P_MIS_RITZA in integer,
                                                                                                       P_CHODESH_LEHASHVAA in varchar2,
                                                                                                   P_MIS_RITZA_LEHASVAA in integer,
                                                                                                   P_RAMA_LETEZUGA in varchar2,
                                                                                                    p_Cur out CurType )  IS
                                                                   
BEGIN
                OPEN p_Cur FOR     
                        SELECT    H.*    ,R.TEUR_RECHIV, I. TEUR_ISUK ,substr(maamad,0,1) MAMAD
                        FROM
                                               CTB_ISUK I,
                                            CTB_RECHIVIM R,
                                            OVDIM O,
                                            (     select   decode(A.MISPAR_ISHI,null,B.MISPAR_ISHI,A.MISPAR_ISHI) MISPAR_ISHI    ,            
                                                                      NVL(A.ERECH_RECHIV,0)  EA,  NVL(B.ERECH_RECHIV,0) EB,
                                                                      decode(A.KOD_RECHIV,null,B.KOD_RECHIV,A.KOD_RECHIV)KOD,
                                                                      nvl(CA,0) CA ,  nvl(CB,0) CB,
                                                                      NVL(A.MAAMAD, B.MAAMAD) maamad,  
																	  decode(A.ISUK,null,B.ISUK,A.ISUK) ISUK                                                              
                                                                                                                       
                                                     from
                                                                (        SELECT A.MISPAR_ISHI ,  A.ERECH_RECHIV , A.KOD_RECHIV,T.MAAMAD,T.ISUK, Count(A.ERECH_RECHIV) CA
                                                                        FROM  TB_CHISHUV_CHODESH_OVDIM A,
                                                                                                                  TMP_PIRTEY_OVDIM T                         
                                                                        WHERE A.BAKASHA_ID =  P_MIS_RITZA    AND
                                                                                         A.TAARICH=to_date('01/' || P_CHODESH,'dd/mm/yyyy')        AND
                                                                                         A.MISPAR_ISHI =T.MISPAR_ISHI(+)     AND 
                                                                                        (ADD_MONTHS(A.TAARICH,1) -1) BETWEEN T.ME_TARICH(+) AND T.AD_TARICH(+) 
                                                                                        GROUP BY     A.MISPAR_ISHI ,  A.ERECH_RECHIV , A.KOD_RECHIV,T.MAAMAD,T.ISUK   ) A
                                                                
                                                                FULL JOIN                        
                                                                                        
                                                                        ( SELECT   B.MISPAR_ISHI ,B.ERECH_RECHIV , B.KOD_RECHIV,T.MAAMAD,T.ISUK, Count(B.ERECH_RECHIV) CB
                                                                         FROM  TB_CHISHUV_CHODESH_OVDIM B,
                                                                                                                  TMP_PIRTEY_OVDIM T                         
                                                                        WHERE B.BAKASHA_ID =P_MIS_RITZA_LEHASVAA AND
                                                                                         B.TAARICH=to_date('01/' || P_CHODESH_LEHASHVAA,'dd/mm/yyyy')        AND
                                                                                         B.MISPAR_ISHI =T.MISPAR_ISHI(+)     AND 
                                                                                        (ADD_MONTHS(B.TAARICH,1) -1) BETWEEN T.ME_TARICH(+) AND T.AD_TARICH(+)    
                                                                                        GROUP BY     B.MISPAR_ISHI ,B.ERECH_RECHIV , B.KOD_RECHIV,T.MAAMAD,T.ISUK ) B
                                                                                        
                                                                ON         
                                                                                   A.MISPAR_ISHI=B.MISPAR_ISHI
                                                                    AND   A.KOD_RECHIV=B.KOD_RECHIV
                                                                    AND A.ISUK =B.ISUK
                                                                    AND A.MAAMAD= B.MAAMAD 
                                            )H
WHERE
                  H.KOD = R.KOD_RECHIV  
    AND  H.ISUK = I.KOD_ISUK
    AND I.KOD_HEVRA = O.KOD_HEVRA
    AND H.MISPAR_ISHI = O.MISPAR_ISHI
    
        ORDER BY  R.TEUR_RECHIV;

                                                                                           
                                                                                             
                         
            EXCEPTION 
                WHEN OTHERS THEN 
                       RAISE;                                                                  
END  pro_GetHashvaatChodsheyRizot;
 /***************************************************************/
PROCEDURE  pro_get_reports_list(P_PROFIL  in varchar2,
                                                                             p_Cur out CurType )  IS
BEGIN


               OPEN p_Cur FOR 
                              SELECT distinct s.SHEM_DOCH_BAKOD,s.TEUR_DOCH
                         FROM   CTB_SUGEY_DOCHOT s,
                                         TB_PROFIL_DOCHOT p
                         WHERE s.KOD_SUG_DOCH = p.KOD_SUG_DOCH
                                AND(P_PROFIL is not null and p.KOD_PROFIL in (SELECT X FROM TABLE(CAST(CONVERT_STRING_TO_TABLE(P_PROFIL ,  ',') AS MYTABTYPE))) )
                        ORDER BY     s.TEUR_DOCH;

                         
 EXCEPTION 
                WHEN OTHERS THEN 
                       RAISE;         
END   pro_get_reports_list;

 /***************************************************************/
PROCEDURE  pro_GetNetuneyIdkuneyRashemet( P_MIS_RASHEMET in integer,
                                                                                                           P_TAARICH_CA in VARCHAR2,  -- CA=Cartis Avoda
                                                                                                       P_SHAA in varchar2,
                                                                                                    p_Cur out CurType )  IS
            TaarichIdkun date;                                                       
BEGIN
            TaarichIdkun := to_date(P_TAARICH_CA || ' ' || P_SHAA || ':00' ,'dd/mm/yyyy HH24:mi:ss'); 
             
            OPEN p_Cur FOR     
				 select distinct MISPAR_ISHI,TAARICH_IDKUN_ACHARON
				 from(
                 --      SELECT distinct  MISPAR_ISHI,TAARICH_IDKUN_ACHARON  from(
                        SELECT  Y. MISPAR_ISHI, Y.TAARICH_IDKUN_ACHARON
                       FROM TB_YAMEY_AVODA_OVDIM Y
                       WHERE Y.MEADKEN_ACHARON=to_number(P_MIS_RASHEMET) AND
                                             Y.TAARICH=to_date(P_TAARICH_CA ,'dd/mm/yyyy') AND
                                         Y.TAARICH_IDKUN_ACHARON >= TaarichIdkun
                                    --    AND  Y.MISPAR_ISHI=201 
            UNION ALL
                         SELECT S. MISPAR_ISHI, S.TAARICH_IDKUN_ACHARON
                        FROM TB_SIDURIM_OVDIM S
                        WHERE S.MEADKEN_ACHARON=to_number(P_MIS_RASHEMET) AND
                                             S.TAARICH=to_date(P_TAARICH_CA ,'dd/mm/yyyy') AND
                                        S.TAARICH_IDKUN_ACHARON >= TaarichIdkun
                                --            AND  S.MISPAR_ISHI=201 
            UNION ALL
                        SELECT P. MISPAR_ISHI, P.TAARICH_IDKUN_ACHARON
                        FROM TB_PEILUT_OVDIM P
                        WHERE P.MEADKEN_ACHARON=to_number(P_MIS_RASHEMET) AND
                                              P.TAARICH=to_date(P_TAARICH_CA ,'dd/mm/yyyy') AND
                                        P.TAARICH_IDKUN_ACHARON >=TaarichIdkun
                                    --        AND  P.MISPAR_ISHI=201 
            UNION ALL
                          SELECT TY. MISPAR_ISHI, TY.TAARICH_IDKUN_ACHARON
                        FROM TRAIL_YAMEY_AVODA_OVDIM TY
                        WHERE TY.MEADKEN_ACHARON=to_number(P_MIS_RASHEMET) AND
                                              TY.TAARICH=to_date(P_TAARICH_CA ,'dd/mm/yyyy') AND
                                         TY.TAARICH_IDKUN_ACHARON >=TaarichIdkun
                                    --         AND  TY.MISPAR_ISHI=201 
            UNION ALL
                          SELECT TS. MISPAR_ISHI, TS.TAARICH_IDKUN_ACHARON
                        FROM TRAIL_SIDURIM_OVDIM TS
                        WHERE TS.MEADKEN_ACHARON=to_number(P_MIS_RASHEMET) AND
                                              TS.TAARICH=to_date(P_TAARICH_CA ,'dd/mm/yyyy') AND
                                         TS.TAARICH_IDKUN_ACHARON >=TaarichIdkun
                                        --     AND TS.MISPAR_ISHI=201 
            UNION  ALL
                          SELECT TP. MISPAR_ISHI, TP.TAARICH_IDKUN_ACHARON
                        FROM TRAIL_PEILUT_OVDIM TP
                        WHERE TP.MEADKEN_ACHARON=to_number(P_MIS_RASHEMET) AND
                                              TP.TAARICH=to_date(P_TAARICH_CA,'dd/mm/yyyy') AND
                                          TP.TAARICH_IDKUN_ACHARON >= TaarichIdkun )
		   
		   ORDER BY MISPAR_ISHI ASC,TAARICH_IDKUN_ACHARON ASC;               						  
                                        --      AND  TP.MISPAR_ISHI=201 
                    --                            ) H        
                                          
        --ORDER BY H.MISPAR_ISHI ASC, H.TAARICH_IDKUN_ACHARON ASC;                

         EXCEPTION 
                WHEN OTHERS THEN 
                       RAISE;                     
            

END pro_GetNetuneyIdkuneyRashemet;

PROCEDURE PREPARE_DAYLIST_OF_RPT( CurrentMonth varchar2 )  is 

  CurrentDay varchar2(2) ;
  PreviousDay varchar2(2);
 
  StrAllTheDateList varchar(300);
  StrList varchar(300);
  CoutiniousList boolean ;
  CDate TB_Chishuv_Yomi_Ovdim.Taarich%TYPE; 
  CMispar_Ishi TB_Chishuv_Yomi_Ovdim.Mispar_ishi%TYPE; 
  CKod_Rechiv TB_Chishuv_Yomi_Ovdim.kod_rechiv%TYPE;
  cursor cursor_GroupBy(p_Month varchar)  is  
                                    select  DayCalc.Mispar_ishi, DayCalc.kod_rechiv 
                                    from TB_Chishuv_Yomi_Ovdim DayCalc 
                                    where to_char(Taarich,'MM/YYYY') =  p_Month 
                                    group by DayCalc.Mispar_ishi, DayCalc.kod_rechiv;
 cursor cursor_date (p_MisparIshi  TB_Chishuv_Yomi_Ovdim.Mispar_ishi%TYPE ,p_Kod_Rechiv TB_Chishuv_Yomi_Ovdim.kod_rechiv%TYPE,p_Month varchar )  is
                                     select Taarich  
                                    from TB_Chishuv_Yomi_Ovdim DayCalc 
                                    where DAYCALC.MISPAR_ISHI = p_MisparIshi
                                    and kod_rechiv = p_Kod_Rechiv
                                    and to_char(Taarich,'MM/YYYY') =  p_Month 
                                    order by to_char(Taarich,'DD');                                    
                                    

BEGIN
  --CurrentMonth :=  '11/2009'; 
 

OPEN cursor_GroupBy(CurrentMonth) ;

LOOP 
    FETCH cursor_GroupBy INTO CMispar_ishi,CKod_Rechiv ;
        EXIT WHEN cursor_GroupBy%NOTFOUND;
    PreviousDay := '' ;
    CoutiniousList := false ;     
    OPEN cursor_date (CMispar_ishi,CKod_Rechiv,CurrentMonth ) ;
    LOOP 
        FETCH cursor_date INTO CDate;
        CurrentDay := to_char(CDate,'DD');
        EXIT WHEN cursor_date%NOTFOUND;
            if (NVL(to_number(PreviousDay),0) <> to_number(CurrentDay) ) then
                StrAllTheDateList := StrAllTheDateList || CurrentDay   || ',';
                if (to_number(PreviousDay) + 1 = to_number (CurrentDay) ) then 
                PreviousDay := CurrentDay ;
                    if (CoutiniousList = false) then
                        StrList := StrList || '-' || CurrentDay ; 
                        CoutiniousList := true;
                    else StrList := substr(StrList ,0,length(StrList) - 2 ) || CurrentDay ;  
                    end if ;      
                else CoutiniousList := false;
                end if ;
                if(CoutiniousList = false) then
                    if (Length(StrList) > 0 ) then 
                        StrList := StrList   ||  ','  || CurrentDay ;
                    else StrList :=  CurrentDay ;
                    end if ;
                end if ;
            end if ;
        PreviousDay := to_char(CDate,'DD');
    END LOOP;
    CLOSE cursor_date;
    INSERT INTO TB_TMP_DATES_PIVOT(DATES_LIST,MISPAR_ISHI,KOD_RECHIV)  
    VALUES(StrList,CMispar_Ishi,CKod_Rechiv);

--DBMS_OUTPUT.PUT_LINE('Mispar_ishi:' || CMispar_Ishi ||'Kod_Rechiv:' || CKod_Rechiv ||  ',the List is: '|| SubStr( StrAllTheDateList,0,length(StrAllTheDateList)-1));
--DBMS_OUTPUT.PUT_LINE('List is: '|| StrList);
StrAllTheDateList := '';
StrList := ''; 
END LOOP;
CLOSE cursor_Groupby;



END PREPARE_DAYLIST_OF_RPT ;




procedure pro_Get_AbsentWorkers(P_PERIOD in  VARCHAR2 ,
                                                   P_EZOR in number ,
                                                   P_ABSENCE_TYPE in NUMBER , 
                                                   P_WORKDAYS in NUMBER,
                                                   P_MAMAD in number ,
                                                     p_cur out CurType ) IS
  p_ToDate Date ; 
  p_FromDate date ; 
GeneralQry varchar2(32767);
ParamQry varchar2(1000);
    p_Erech TB_Parametrim.erech_param%TYPE ;
  BEGIN
  execute immediate 'truncate table TB_TMP_DATES_PIVOT ';
      p_FromDate := to_date('01/' || p_Period,'dd/mm/yyyy'); /* period= 05/2009=>  v_MinLimitDate = 01/05/2009 */
    p_ToDate := add_months(p_FromDate,1) -1 ;    /* period= 05/2009=>  v_MaxLimitDate = 31/05/2009 */
     PREPARE_DAYLIST_OF_RPT(P_PERIOD) ; 
     INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_PERIOD:',P_PERIOD);
     INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_EZOR:',P_EZOR);
     INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_ABSENCE_TYPE:',P_ABSENCE_TYPE);
     INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_WORKDAYS:',P_WORKDAYS);
     INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_MAMAD:',P_MAMAD);
     
  GeneralQry :=    '
     Select  substr(Details.EZOR,0,1) || substr(Details.MAAMAD,0,1) || ''-'' ||  Details.MISPAR_ISHI Mispar_ishi_Full,
                Snif.teur_snif_av,  
                Ov.Full_name  ,
                CalcMonth.SUG_HEADRUT,CalcMonth.DATES_LIST ,CalcMonth.TEUR_HEADRUT,CalcMonth.DAYS,CalcMonth.KOD_RECHIV,
                case substr(Details.maamad,0,1) 
                    when ''1'' then ''''
                    when ''2'' then ''''
                    else '''' end Maamad ,  
                case when Ov.Wording_date  in (51,52) then 5 
                        when Ov.Wording_date  in (61,62) then 6 
                        end WorkDay,
                case when (Ov.Matching_1 is not null and Ov.Matching_2 is not null )   
                then '''' ||
                         Ov.Matching_2 / 60 || 
                         '' ''
                when (Ov.Matching_1 is not null and Ov.Matching_2 is null )   
                then ''''         
                else '''' 
                end Matching , 
                Gil.Teur_kod_gil  
 from 
 ( 
            select kod_hevra, mispar_ishi , shem_mish|| ''  '' ||  shem_prat full_name, 
            (PKG_OVDIM.fun_get_meafyen_oved(mispar_ishi, 56,''' || trunc(P_ToDate) || ''' )) Wording_date, 
            (PKG_OVDIM.fun_get_meafyen_oved(mispar_ishi, 8,''' || trunc(P_ToDate) || ''' )) Matching_1,
            (PKG_OVDIM.fun_get_meafyen_oved(mispar_ishi, 20,''' || trunc(P_ToDate) || ''' )) Matching_2
            from ovdim
            ) Ov,
TMP_PIRTEY_OVDIM Details  ,
(select po.mispar_ishi,max(po.ME_TARICH) me_taarich
                       from tmp_Pirtey_Ovdim PO
                       where po.isuk is not null
                       and 
                       (Me_Tarich <=''' || trunc(P_ToDate) || ''' ) and (Ad_Tarich >=''' || trunc(P_FromDate) || ''' or Ad_Tarich is null)
                      group by po.mispar_ishi) RelevantDetails,
ctb_snif_av Snif  ,
CTB_Kod_Gil Gil,
 ( 
SELECT   CTB_SH.KOD_HEADRUT_CLALI KOD_HEADRUT, CTB_SH.TEUR_CLALI SUG_HEADRUT,
         YAMIMLIST.MISPAR_ISHI,
         YAMIMLIST.DATES_LIST,
         case when  ((CALCMONTH.KOD_RECHIV = 67 ) AND ( SubCalcMonth.KOD_RECHIV = 248))
                THEN SubCalcMonth.DAYS - DAYS
                 when  ((CALCMONTH.KOD_RECHIV = 66 ) AND ( SubCalcMonth.KOD_RECHIV = 249))
                THEN SubCalcMonth.DAYS - DAYS
                ELSE  CALCMONTH.ERECH_RECHIV 
         END DAYS, 
       CTB_R.TEUR_RECHIV TEUR_HEADRUT,
         CALCMONTH.TAARICH,
         CALCMONTH.KOD_RECHIV
  FROM   TB_CHISHUV_CHODESH_OVDIM CALCMONTH,
         TB_TMP_DATES_PIVOT YAMIMLIST,
         (select distinct TEUR_CLALI,KOD_HEADRUT_CLALI from  CTB_SUGEY_HEADRUYUT where KOD_HEADRUT_CLALI > 0) CTB_SH,
         CTB_RECHIVIM CTB_R,
         (
         SELECT   
                 CALCMONTH.MISPAR_ISHI,
                 CALCMONTH.ERECH_RECHIV DAYS,
                 CALCMONTH.KOD_RECHIV
          FROM   TB_CHISHUV_CHODESH_OVDIM CALCMONTH,
                      TB_TMP_DATES_PIVOT YAMIMLIST,
                     (select distinct TEUR_CLALI,KOD_HEADRUT_CLALI from  CTB_SUGEY_HEADRUYUT where KOD_HEADRUT_CLALI > 0) CTB_SH,
                     CTB_RECHIVIM CTB_R
         WHERE       (YAMIMLIST.MISPAR_ISHI(+) = CALCMONTH.MISPAR_ISHI)
                 AND (YAMIMLIST.KOD_RECHIV(+) = CALCMONTH.KOD_RECHIV)
                 AND (YAMIMLIST.KOD_RECHIV = CTB_R.KOD_RECHIV)
                 AND (CTB_R.KOD_RECHIV = CALCMONTH.KOD_RECHIV)
                  AND (CTB_SH.KOD_HEADRUT_CLALI = CTB_R.KOD_HEADRUT_CLALI)
                  and to_char(CALCMONTH.TAARICH,''MM/YYYY'') =''' || P_Period || '''
                  and  CALCMONTH.KOD_RECHIV IN (248,249)
         ) SubCalcMonth 
  WHERE       (YAMIMLIST.MISPAR_ISHI(+) = CALCMONTH.MISPAR_ISHI)
         AND (YAMIMLIST.KOD_RECHIV(+) = CALCMONTH.KOD_RECHIV)
         AND (YAMIMLIST.KOD_RECHIV = CTB_R.KOD_RECHIV)
         AND (CTB_R.KOD_RECHIV = CALCMONTH.KOD_RECHIV)
          AND (CTB_SH.KOD_HEADRUT_CLALI = CTB_R.KOD_HEADRUT_CLALI)
          and to_char(CALCMONTH.TAARICH,''MM/YYYY'') = ''' || P_Period || '''
          and calcmonth.mispar_ishi = SubCalcMonth.mispar_ishi ) CalcMonth
where 
Details.mispar_ishi = RelevantDetails.mispar_ishi 
and  Details.ME_TARICH = RelevantDetails.me_taarich
and Snif.KOD_HEVRA = OV.KOD_HEVRA 
and Ov.mispar_ishi = CalcMonth.mispar_ishi
and Ov.mispar_ishi = RelevantDetails.mispar_ishi
and Details.snif_av     = Snif.kod_snif_av
and Details.GIL         = Gil.kod_gil_hr  ' ;
if ( P_MAMAD <> '-1' ) THEN 
    ParamQry := ParamQry || ' substr(Details.MAAMAD,0,1) like ''' || P_MAMAD || ''' AND ';
end if ; 

if (( P_EZOR is not  null ) OR ( P_EZOR <> '' )) THEN 
    ParamQry := ParamQry || ' Details.EZOR in (' || P_EZOR || ') AND ';
end if ; 


if ( P_ABSENCE_TYPE <> '-1' ) THEN 
    ParamQry := ParamQry || ' CalcMonth.KOD_HEADRUT in (' || P_ABSENCE_TYPE || ') AND ';
end if ; 

if ( P_WORKDAYS <> '-1' ) THEN 
    ParamQry := ParamQry || 'substr(Ov.Wording_date,0,1) like ''' || P_WORKDAYS || ''' AND ';
end if ; 



if (( ParamQry is not null  ) OR ( ParamQry <> '')) then
  ParamQry := SUBSTR(ParamQry,0,LENGTH(ParamQry)-4); -- TO DELETE THE LAST 'AND '
  GeneralQry := GeneralQry || 'And ' || ParamQry;
end if ;

DBMS_OUTPUT.PUT_LINE ( GeneralQry);
--execute immediate 'select count(*) from (' || GeneralQry || ')' into rc ;
open p_cur for GeneralQry ;

         EXCEPTION 
                WHEN OTHERS THEN 
                       RAISE;                     
            

END pro_Get_AbsentWorkers;

procedure pro_GetMainDetailsAverage (P_STARTDATE in date, 
                                            P_ENDDATE in date ,
                                            P_SNIF in varchar2 ,
                                            P_MAMAD in varchar2 ,
                                            P_ISUK varchar2 ,
                                            P_EZOR in varchar ,
                                            P_COMPANYID  in varchar2 ,
                                            P_MisparIshi  in varchar2 ,
                                            P_KOD_YECHIDA IN varchar2 ,
                                            P_SECTORISUK in varchar2 ,
                                            p_cur out CurType ) IS
GeneralQry varchar2(32767);
QryMakatDate varchar2(3000);
ParamQry varchar2(1000);
Begin 

/*
INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_STARTDATE:',P_STARTDATE);
INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_ENDDATE:',P_ENDDATE);
INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_SNIF:',P_SNIF);
INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_MAMAD:',P_MAMAD);
INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_ISUK:',P_ISUK);
INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_EZOR:',P_EZOR);
INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_COMPANYID:',P_COMPANYID);
INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_MisparIshi:',P_MisparIshi);
INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_KOD_YECHIDA:',P_KOD_YECHIDA);
INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'P_SECTORISUK:',P_SECTORISUK);
*/
GeneralQry  := 'Select
Ov.shem_mish|| '' '' ||  Ov.shem_prat full_name ,Details.Mispar_ishi ,Gil.Teur_kod_gil    , Maamad.teur_maamad_hr  teur_maamad , Isuk.teur_isuk 
from ovdim Ov , 
TMP_PIRTEY_OVDIM Details  ,
(select po.mispar_ishi,max(po.ME_TARICH) me_taarich
                       from tmp_Pirtey_Ovdim PO
                       where po.isuk is not null
                             and (''' || trunc(P_STARTDATE) || '''  Between  po.ME_TARICH  and   nvl(po.ad_TARICH,to_date(''01/01/9999'' ,''dd/mm/yyyy''))
                               or   ''' || trunc(P_ENDDATE) || '''  Between  po.ME_TARICH  and   nvl(po.ad_TARICH,to_date(''01/01/9999'' ,''dd/mm/yyyy''))
                                or   po.ME_TARICH>= ''' || trunc(P_STARTDATE) || '''  and   nvl(po.ad_TARICH,to_date(''01/01/9999'' ,''dd/mm/yyyy''))<=  ''' || trunc(P_ENDDATE) || '''  )
                      group by po.mispar_ishi) RelevantDetails,

CTB_Kod_Gil Gil ,
 ctb_maamad Maamad,
 ctb_isuk Isuk ,
 ctb_snif_av Snif ,
 CTB_Yechida Yechida
where 
Ov.mispar_ishi = Details.mispar_ishi
and Details.mispar_ishi = RelevantDetails.mispar_ishi 
and Details.ME_TARICH = RelevantDetails.me_taarich (+)
and Snif.KOD_HEVRA = OV.KOD_HEVRA 
and Snif.kod_snif_av(+) = details.snif_av
and Isuk.KOD_HEVRA = OV.KOD_HEVRA
and MAAMAD.KOD_HEVRA = OV.KOD_HEVRA
and maamad.kod_maamad_hr(+) =  details.maamad
and Details.GIL         = Gil.kod_gil_hr
AND Maamad.kod_hevra =Isuk.kod_hevra 
and YECHIDA.KOD_YECHIDA = DETAILS.YECHIDA_IRGUNIT
and YECHIDA.KOD_HEVRA = OV.KOD_HEVRA
and Isuk.kod_isuk(+) = details.isuk ' ;
 
if (( P_MisparIshi is not  null ) OR ( P_MisparIshi <> '' )) THEN 
    ParamQry := ParamQry || '  Details.mispar_ishi in (' || P_MisparIshi || ') AND ';
end if ; 


if (  p_ezor <> '-1' ) THEN 
    ParamQry := ParamQry || '  Details.ezor in (' || p_ezor || ') AND ';
end if ; 

if (P_COMPANYID <> '-1' ) THEN 
    ParamQry := ParamQry || '  OV.KOD_HEVRA in (' || P_COMPANYID || ') AND ';
end if ;

if (( P_MAMAD is not  null ) OR ( P_MAMAD <> '' )) THEN 
    ParamQry := ParamQry || '  Details.MAAMAD in (' || P_MAMAD || ') AND ';
end if ; 

if (( P_ISUK is not  null ) OR ( P_ISUK <> '' )) THEN 
    ParamQry := ParamQry || '  Isuk.KOD_isuk in (' || P_ISUK || ') AND ';
end if ; 
 
if (( P_SNIF is not  null ) OR ( P_SNIF <> '' )) THEN 
    ParamQry := ParamQry || '  details.snif_av in (' || P_SNIF || ') AND ';
end if ; 
 
if (( P_KOD_YECHIDA is not  null ) OR ( P_KOD_YECHIDA <> '' )) THEN 
    ParamQry := ParamQry || ' YECHIDA.KOD_YECHIDA in (' || P_KOD_YECHIDA || ') AND ';
end if ; 

if (( P_SECTORISUK is not  null ) OR ( P_SECTORISUK <> '' )) THEN 
    ParamQry := ParamQry || ' Isuk.KOD_SECTOR_ISUK in (' || P_SECTORISUK || ') AND ';
end if ; 
 

if (( ParamQry is not null  ) OR ( ParamQry <> '')) then
  ParamQry := SUBSTR(ParamQry,0,LENGTH(ParamQry)-4); -- TO DELETE THE LAST 'AND '
  GeneralQry := GeneralQry || 'And ' || ParamQry;
end if ;

DBMS_OUTPUT.PUT_LINE ( GeneralQry);
--execute immediate 'select count(*) from (' || GeneralQry || ')' into rc ;
open p_cur for GeneralQry ;
 
    EXCEPTION 
    WHEN OTHERS THEN 
    RAISE;                     
            

END pro_GetMainDetailsAverage;

procedure pro_GetRechivValueAverage (P_STARTDATE in date, 
                                            P_ENDDATE in date ,
                                            P_MisparIshi  in varchar2,
                                            p_cur out CurType ) IS
Begin 
Open p_Cur for 
Select 
trim(to_char(sum(case kod_rechiv when 1 then Erech_Rechiv/60 else null end),'999999.99')) Nohehout,
trim(to_char(sum(case kod_rechiv when 105 then Erech_Rechiv else null end),'999999.99')) Nossafot,
trim(to_char(sum(case kod_rechiv when 100 then Erech_Rechiv else null end),'999999.99')) Shaot100  ,
trim(to_char(sum(case kod_rechiv when 101 then Erech_Rechiv else null end),'999999.99')) Shaot125,
trim(to_char(sum(case kod_rechiv when 102 then Erech_Rechiv else null end),'999999.99')) Shaot150,
trim(to_char(sum(case kod_rechiv when 192 then Erech_Rechiv else null end),'999999.99')) ShaotTafkid,
trim(to_char(sum(case kod_rechiv when 37 then Erech_Rechiv/60 else null end),'999999.99')) TafkidShabess,
trim(to_char(sum(case when kod_rechiv in(21,37,193)   then Erech_Rechiv/60 else null end),'999999.99')) NosafotTafkid,
trim(to_char(sum(case when kod_rechiv in(161,147)   then Erech_Rechiv/60 else null end),'999999.99')) KizuzTafkid,
trim(to_char(sum(case when kod_rechiv in(133,134)   then Erech_Rechiv else null end),'999999.99')) SumPremia,
trim(to_char(sum(case kod_rechiv when 2 then Erech_Rechiv/60 else null end),'999999.99')) DriveWeek,
trim(to_char(sum(case kod_rechiv when 189 then Erech_Rechiv/60 else null end),'999999.99')) Drive6,
trim(to_char(sum(case kod_rechiv when 35 then Erech_Rechiv/60 else null end),'999999.99')) DriveShabess,
trim(to_char(sum(case kod_rechiv when 60 then Erech_Rechiv else null end),'999999.99')) HillDays,
trim(to_char(sum(case kod_rechiv when 62 then Erech_Rechiv else null end),'999999.99')) MiluimDays,
trim(to_char(sum(case when kod_rechiv in(66,67)   then Erech_Rechiv else null end),'999999.99')) HofeshEadrut,
trim(to_char(sum(case when kod_rechiv in(56,60,61,62,64,65,66,67,68,69,70,71)   then Erech_Rechiv else null end),'999999.99')) SumEadrut,
trim(to_char(sum(case kod_rechiv when 57 then Erech_Rechiv else null end),'999999.99')) Adraha,
trim(to_char(sum(case kod_rechiv when 75 then Erech_Rechiv else null end),'999999.99')) NohehoutDay,
trim(to_char(sum(case kod_rechiv when 109 then Erech_Rechiv else null end),'999999.99')) Workday,
fct_GetSumMonthWithRechiv( P_STARTDATE ,P_ENDDATE  ,P_MisparIshi  ) Months,
trim(to_char(sum(case kod_rechiv when 194 then Erech_Rechiv else null end),'999999.99')) Nohah1_5,
trim(to_char(sum(case kod_rechiv when 126 then Erech_Rechiv else null end),'999999.99')) MonthlyQuota,
trim(to_char(sum(case kod_rechiv when 82 then Erech_Rechiv/60 else null end),'999999.99')) Nosafot1_5,
trim(to_char(sum(case kod_rechiv when 200 then Erech_Rechiv else null end),'999999.99'))AlM1_5,
trim(to_char(sum(case kod_rechiv when 195 then Erech_Rechiv else null end),'999999.99')) HoursDay_6,
trim(to_char(sum(case kod_rechiv when 196 then Erech_Rechiv else null end),'999999.99')) HoursShabess,
trim(to_char(sum(case when kod_rechiv in(54,55)   then Erech_Rechiv else null end),'999999.99')) HoursNight,
trim(to_char(sum(case when kod_rechiv in(133,134)   then Erech_Rechiv else null end),'999999.99')) PremiaNaagut,
trim(to_char(sum(case when kod_rechiv in(49,50)   then Erech_Rechiv else null end),'999999.99')) Pitsul,
trim(to_char(sum(case kod_rechiv when 57 then Erech_Rechiv else null end),'999999.99')) HadrahaDays,
trim(to_char(sum(case kod_rechiv when 67 then Erech_Rechiv else null end),'999999.99')) HofeshDays,
trim(to_char(sum(case kod_rechiv when 64 then Erech_Rechiv else null end),'999999.99')) AccidentDays,
trim(to_char(sum(case kod_rechiv when 66 then Erech_Rechiv else null end),'999999.99')) HeadrutDays,
trim(to_char(sum(case kod_rechiv when 190 then Erech_Rechiv/60 else null end),'999999.99')) HoursTnua,
trim(to_char(sum(case when kod_rechiv in(20,36,191)   then Erech_Rechiv else null end),'999999.99')) NosafotTnua,
trim(to_char(sum(case when kod_rechiv in(160,163)   then Erech_Rechiv else null end),'999999.99')) KizuzTnua,
trim(to_char(sum(case kod_rechiv when 188 then Erech_Rechiv else null end),'999999.99')) HourNaagut,
trim(to_char(sum(case when kod_rechiv in(19,35,189)   then Erech_Rechiv else null end),'999999.99')) NosafotNahagut,
0 KizuzNaagut,
trim(to_char(sum(case kod_rechiv when 85 then Erech_Rechiv else null end),'999999.99')) ZmanRetsef,
trim(to_char(sum(case kod_rechiv when 22 then Erech_Rechiv else null end),'999999.99')) GmulSum
from 
(         
Select Kod_Rechiv ,Erech_Rechiv 
from (
        Select  Ch.Kod_Rechiv ,   Avg(Ch.Erech_Rechiv) Erech_Rechiv     
        From TB_Chishuv_Chodesh_Ovdim Ch
        Where 
        ((P_MisparIshi is not null ) AND (  Ch.Mispar_Ishi  in (select x from table(cast(convert_string_to_table(P_MisparIshi ,  ',') as mytabtype)))))         
        and (Ch.Taarich between P_STARTDATE  and P_ENDDATE)
        and Ch.Bakasha_ID in(
                                        select B.BAKASHA_ID
                                        from  TB_Bakashot B
                                        where B.TAARICH_HAAVARA_LESACHAR in 
                                                                                                    (
                                                                                                        Select   Max(Taarich_Haavara_Lesachar) MaxDate 
                                                                                                        from TB_Bakashot B
                                                                                                        where Bakasha_ID in
                                                                                                                                      (
                                                                                                                                      Select  distinct Bakasha_ID  
                                                                                                                                      from TB_Chishuv_Chodesh_Ovdim  
                                                                                                                                      Where
                                                                                                                                      Taarich  between P_STARTDATE  and P_ENDDATE
                                                                                                                                      )
                                                                                                         and Taarich_Haavara_Lesachar is not null
                                                                                                         AND B.HUAVRA_LESACHAR =    1
                                                                                                         and Bakasha_ID is not null 
                                                                                                         GROUP BY To_char(Taarich_Haavara_Lesachar,'MM/YYYY')
                                                                                                    ) 
                                        )
        group by Ch.Kod_Rechiv) 
);
 
     EXCEPTION 
    WHEN OTHERS THEN 
    RAISE;                     
end        pro_GetRechivValueAverage ; 



function fct_GetSumMonthWithRechiv (P_STARTDATE in date, 
                                            P_ENDDATE in date ,
                                            P_MisparIshi  in varchar2 ) return  number  is 
CountMonth number  ;                                            
Begin 
Select Count(Cnt) into CountMonth
from (
        Select  COUNT(Ch.Kod_Rechiv) CNT 
        From TB_Chishuv_Chodesh_Ovdim Ch
        Where 
        ((P_MisparIshi is not null ) AND (  Ch.Mispar_Ishi  in (select x from table(cast(convert_string_to_table(P_MisparIshi ,  ',') as mytabtype)))))         
        and (Ch.Taarich between P_STARTDATE  and P_ENDDATE)
        and Ch.Bakasha_ID in(
                                        select B.BAKASHA_ID
                                        from  TB_Bakashot B
                                        where B.TAARICH_HAAVARA_LESACHAR in 
                                                                                                    (
                                                                                                        Select   Max(Taarich_Haavara_Lesachar) MaxDate 
                                                                                                        from TB_Bakashot B
                                                                                                        where Bakasha_ID in
                                                                                                                                      (
                                                                                                                                      Select  distinct Bakasha_ID  
                                                                                                                                      from TB_Chishuv_Chodesh_Ovdim  
                                                                                                                                      Where
                                                                                                                                      Taarich  between P_STARTDATE  and P_ENDDATE
                                                                                                                                      )
                                                                                                         and Taarich_Haavara_Lesachar is not null
                                                                                                         AND B.HUAVRA_LESACHAR =    1
                                                                                                         and Bakasha_ID is not null 
                                                                                                         GROUP BY To_char(Taarich_Haavara_Lesachar,'MM/YYYY')
                                                                                                    ) 
                                        )
        group by to_char(Ch.Taarich,'MM/YYYY')       
 
);

return CountMonth;
 
     EXCEPTION 
    WHEN OTHERS THEN
    return 0 ; 
end        fct_GetSumMonthWithRechiv ; 


 
procedure pro_GetDescriptionComponents (P_STARTDATE in varchar2,
                                           P_ENDDATE in varchar2,
                                            P_COMPANYID  in varchar2,
                                            p_cur out CurType ) IS
     FromDate varchar2(10);             
     ToDate varchar2(10);   
     dateTo Date;                                                                                       
BEGIN
        if ( length( P_STARTDATE) = 7) then
               FromDate := '01/'  || P_STARTDATE;
             dateTo := last_day(to_date( '01/'  || P_ENDDATE,'dd/mm/yyyy'));
             ToDate  := to_char(dateTo,'dd') ||  '/' || P_ENDDATE;
         else
             FromDate := P_STARTDATE;
             ToDate  :=  P_ENDDATE;     
          end if;

            Open p_Cur for 
                Select  Ch.MISPAR_ISHI ,Ch.taarich, Ch.Kod_Rechiv , Ch.Erech_Rechiv,
                  OV.SHEM_MISH || ' ' ||  OV.SHEM_PRAT  FULL_NAME  ,
                I.TEUR_ISUK,E.TEUR_EZOR,M.TEUR_MAAMAD_HR,S.TEUR_SNIF_AV,
                R.TEUR_RECHIV
                
                From TB_Chishuv_Chodesh_Ovdim Ch,
                           TMP_PIRTEY_OVDIM T,
                           CTB_ISUK I,
                           CTB_EZOR E,
                           CTB_MAAMAD M,
                           CTB_SNIF_AV S,
                           CTB_RECHIVIM R, 
                            OVDIM OV,        
                            ( Select o.mispar_ishi,o.taarich,o.Bakasha_ID
                             From TB_Chishuv_Chodesh_Ovdim  o
                             where o.bakasha_id= (Select b.Bakasha_ID
                                                                         From TB_Bakashot  b
                                                                         Where  b.Taarich_Haavara_Lesachar =  (Select Max(Taarich_Haavara_Lesachar)
                                                                                                                                                                      From TB_Bakashot
                                                                                                                                                           Where Bakasha_ID in  (Select Bakasha_ID
                                                                                                                                                                                                           From TB_Chishuv_Chodesh_Ovdim 
                                                                                                                                                                                                           Where Mispar_Ishi =o.mispar_ishi
                                                                                                                                                                                                            and to_char(Taarich,'mm/yyyy') =to_char(o.taarich,'mm/yyyy') )
                                                                                                                                                                        and Huavra_Lesachar=1))
                             group by  o.mispar_ishi,o.taarich,o.Bakasha_ID ) H
    WHERE Ch.Bakasha_ID=H.Bakasha_ID    and
                       Ch.mispar_ishi = H.mispar_ishi    and                                                                        
                     (Ch.Taarich between    to_date(FromDate,'dd/mm/yyyy')  and to_date(ToDate ,'dd/mm/yyyy')  )   AND                 
                      OV.MISPAR_ISHI = Ch.MISPAR_ISHI and
                      Ch.MISPAR_ISHI =T.MISPAR_ISHI(+) AND
                      (ADD_MONTHS(Ch.TAARICH,1) -1) BETWEEN T.ME_TARICH(+) AND T.AD_TARICH(+)    and
                       T .ISUK =I.KOD_ISUK AND
                       OV.KOD_HEVRA=I.KOD_HEVRA AND
                       T.EZOR =E.KOD_EZOR AND
                       OV.KOD_HEVRA=E.KOD_HEVRA AND
                       T.MAAMAD = M.KOD_MAAMAD_HR AND
                       OV.KOD_HEVRA=M.KOD_HEVRA   AND
                         T.SNIF_AV = S. KOD_SNIF_AV AND
                        OV.KOD_HEVRA=S.KOD_HEVRA   AND    
                        Ch.KOD_RECHIV = R.KOD_RECHIV  AND     
                        (P_COMPANYID='-1' or OV.KOD_HEVRA in (select x from table(cast(convert_string_to_table(P_COMPANYID ,  ',') as mytabtype))));
                                                                            
 EXCEPTION 
    WHEN OTHERS THEN 
    RAISE;                     
end   pro_GetDescriptionComponents;

PROCEDURE  pro_GetPundakimLeHitchashbenut( P_STARTDATE in TB_HITYAZVUT_PUNDAKIM.TAARICH%TYPE,
                                                                                                P_ENDDATE in TB_HITYAZVUT_PUNDAKIM.TAARICH%TYPE,
                                                                                     p_Cur out CurType ) IS
BEGIN
           Open p_Cur for                                              
                          select  m.TEUR_MIKUM_YECHIDA  ,t.TAARICH, 
                                     count(t.MISPAR_ISHI)SUM,substr(lpad(t.MIKUM_SHAON,5, '0'),0,3) KOD,
                                    (case to_char(t.taarich,'d') when '1' then '' 
                                                                                      when '2' then ''
                                                                                      when '3' then ''
                                                                                      when '4' then ''
                                                                                      when '5' then ''
                                                                                      when '6' then ''
                                                                                       when '7' then '' end)  || '  ' || c.TEUR_YOM teur_yom
                     from TB_HITYAZVUT_PUNDAKIM t,
                                CTB_MIKUM_YECHIDA m,
                               tb_yamim_meyuchadim b, ctb_sugey_yamim_meyuchadim c 
                    WHERE  substr(lpad(t.MIKUM_SHAON,5, '0'),0,3) =lpad(m.KOD_MIKUM_YECHIDA,3, '0')    and
                               t.taarich = b.taarich(+) and
                               b.sug_yom=c.sug_yom(+) and
                               t.TAARICH between P_STARTDATE and  P_ENDDATE
                 group by m.TEUR_MIKUM_YECHIDA,t.TAARICH,c.TEUR_YOM,t.MIKUM_SHAON
                 order by m.TEUR_MIKUM_YECHIDA,t.TAARICH,c.TEUR_YOM,t.MIKUM_SHAON;                                    

 EXCEPTION 
    WHEN OTHERS THEN 
    RAISE;                     
end     pro_GetPundakimLeHitchashbenut;            

procedure pro_get_Id_of_Ovdim( p_FromDate in date , p_ToDate in date ,
                                                                        p_preFix in varchar2,  p_cur out CurType) as 
begin 

open p_cur for 
             SELECT distinct Ov.MISPAR_ISHI,  
                case when (p_prefix is null) then  
                               Ov.shem_mish || ' ' ||  Ov.shem_prat || '(' || Ov.MISPAR_ISHI || ')'   
                      else '' 
                      end full_name 
          FROM  Ovdim Ov,
                             TB_HITYAZVUT_PUNDAKIM h
          WHERE 
              Ov.MISPAR_ISHI = h.MISPAR_ISHI and
              h.TAARICH between p_FromDate and p_ToDate and
             ( p_preFix is null OR Ov.MISPAR_ISHI Like p_preFix ||  '%'  )
           ORDER BY Ov.MISPAR_ISHI;            
  
        EXCEPTION 
         WHEN OTHERS THEN 
              RAISE;               
  END  pro_get_Id_of_Ovdim;   
  
procedure pro_ins_Heavy_Reports (p_BakashaId in tb_bakashot.bakasha_id%type, 
                                                   p_ReportName in CTB_SUGEY_DOCHOT.SHEM_DOCH_BAKOD%type,
                                                   p_ReportParams in    COLL_Report_Param,
                                                   p_MisparIshi in number ,
                                                   p_Extension in TB_DOCHOT_MISPAR_ISHI.EXTENSION_TYPE%type ,
                                                   p_DestinationFolder in TB_DOCHOT_MISPAR_ISHI.SHEM_TIKIYA%type,
                                                   p_SendToMail in number) as 
sEmail varchar2(20); 
iKodReport integer ;
begin 

if (p_SendToMail = 1) then
    select   O.EMAIL into   sEmail from ovdim O 
    where O.MISPAR_ISHI = p_MisparIshi ;
end if ;     
--INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'p_BakashaId:',p_BakashaId);
--INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'p_ReportName:',p_ReportName);
--INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'p_MisparIshi:',p_MisparIshi);
--INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'p_Extension:',p_Extension);
--INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'p_DestinationFolder:',p_DestinationFolder);
--INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'p_SendToMail:',p_SendToMail);

select  S.KOD_SUG_DOCH  into iKodReport 
from CTB_SUGEY_DOCHOT s 
where S.SHEM_DOCH_BAKOD  =  p_ReportName  and rownum  =1 
order by S.KOD_SUG_DOCH asc ;

   IF (p_ReportParams is not null) THEN
                 FOR i IN 1..p_ReportParams.COUNT LOOP
                           --check if exist in table
                BEGIN
                    insert into tb_parametrim_ledochot 
                    (BAKASHA_ID,KOD_SUG_DOCH,PAIL,SHEM_PARAM_BADOCH,ERECH)
                    values (p_BakashaId ,iKodReport ,1,p_ReportParams(i).Name  ,p_ReportParams(i).Value);                          
                END;
             END LOOP;
             
             insert into tb_dochot_mispar_ishi p
             (BAKASHA_ID,EXTENSION_TYPE,KOD_SUG_DOCH,MISPAR_ISHI,PAIL,SHEM_TIKIYA,Destination_Type )
             values (p_BakashaId,p_Extension,iKodReport,p_MisparIshi,1,p_DestinationFolder, 
             (case when (p_SendToMail = 1) then 1 else 0 end )
             );
     END IF;
 
--select '53435' into sEmail from dual ;


                         
                                                  

 EXCEPTION
         WHEN OTHERS THEN
              RAISE;
  END         pro_ins_Heavy_Reports;


  
 procedure  pro_get_Definition_Reports(p_BakashaId in  tb_bakashot.bakasha_id%type, p_cur out CurType) as 
begin 
     open p_cur for          
                 SELECT distinct t.KOD_SUG_DOCH KOD, c.SHEM_DOCH_BAKOD NAME,c.TEUR_DOCH, c.TVACH_TAARICHIM,T.BAKASHA_ID,T.EXTENSION_TYPE
                 ,T.MISPAR_ISHI
               FROM TB_DOCHOT_MISPAR_ISHI t,
                                CTB_SUGEY_DOCHOT c
                WHERE t.PAIL=1 and C.PAIL =1 
                                            and t.KOD_SUG_DOCH = c.KOD_SUG_DOCH
                                       and T.BAKASHA_ID = p_BakashaId ;
                                  --     and t.MISPAR_ISHI = 75757; 
 EXCEPTION 
         WHEN OTHERS THEN 
              RAISE;               
  END         pro_get_Definition_Reports;             
  
  procedure pro_get_Details_Reports      (p_BakashaId in  tb_bakashot.bakasha_id%type, p_cur out CurType) as 
begin 
if (p_BakashaId = 0) then 
     open p_cur for          
                    SELECT p.KOD_SUG_DOCH,p.SHEM_PARAM_BADOCH,p.ERECH,p.TAARICH_IDKUN_ACHARON , T.MISPAR_ISHI
                    FROM TB_DOCHOT_MISPAR_ISHI t,
                    TB_PARAMETRIM_LEDOCHOT p
                    WHERE t.PAIL=1
                    and p.PAIL=1
                    and t.KOD_SUG_DOCH = p.KOD_SUG_DOCH
                    and T.BAKASHA_ID = p.BAKASHA_ID
                    and T.BAKASHA_ID = p_BakashaId 
                union 
                    SELECT t.KOD_SUG_DOCH, 
                    'P_EZOR' AS SHEM_PARAM_BADOCH, 
                    PKG_OVDIM.FUNC_GET_ERECH_BY_KOD_NATUN (T.MISPAR_ISHI, 3,sysdate)    as  ERECH ,
                    sysdate as TAARICH_IDKUN_ACHARON , T.MISPAR_ISHI
                    FROM TB_DOCHOT_MISPAR_ISHI t
                    WHERE t.PAIL=1 and t.KOD_SUG_DOCH in(104,500,700,809,810,811) and T.BAKASHA_ID = 0 ;
else 
     open p_cur for          
                    SELECT p.KOD_SUG_DOCH,p.SHEM_PARAM_BADOCH,p.ERECH,p.TAARICH_IDKUN_ACHARON
                    FROM TB_DOCHOT_MISPAR_ISHI t,
                    TB_PARAMETRIM_LEDOCHOT p
                    WHERE t.PAIL=1
                    and p.PAIL=1
                    and t.KOD_SUG_DOCH = p.KOD_SUG_DOCH
                    and T.BAKASHA_ID = p.BAKASHA_ID
                    and T.BAKASHA_ID = p_BakashaId ; 
end if ;                                 


 EXCEPTION 
         WHEN OTHERS THEN 
              RAISE;               
  END pro_get_Details_Reports;
  
 procedure pro_get_Destinations_Reports(p_BakashaId in  tb_bakashot.bakasha_id%type,p_cur out CurType) as 
begin 
     open p_cur for          
                   SELECT distinct  t.KOD_SUG_DOCH, t.SHEM_TIKIYA, case when T.Destination_Type =1 then   o.EMAIL else null end EMAIL , T.MISPAR_ISHI
                 FROM TB_DOCHOT_MISPAR_ISHI t,
                              Ovdim o
                 WHERE t.PAIL=1
                          and t.MISPAR_ISHI = o.MISPAR_ISHI
                               and T.BAKASHA_ID = p_BakashaId
                      --       and t.MISPAR_ISHI = 75757
                Order by  t.KOD_SUG_DOCH;
            
 EXCEPTION 
         WHEN OTHERS THEN 
              RAISE;               
  END pro_get_Destinations_Reports;
  
  
  
  PROCEDURE Pro_Get_TlunotPundakim(p_Cur out Curtype,
                                                    P_STARTDATE in VARCHAR2,
                                                       P_ENDDATE in VARCHAR2,
                                                P_MISPAR_ISHI in VARCHAR2,
                                                P_SUG_REPORT NUMBER )  is
mis number;
begin 

if (P_SUG_REPORT = 1) then
   mis := 0;
else mis :=  -1;
end if;
DBMS_OUTPUT.PUT_LINE (P_SUG_REPORT);
DBMS_OUTPUT.PUT_LINE ('pro_Prepare_Netunim_Tnua:'  || to_char(sysdate,'HH24:mi:ss'));
PKG_REPORTS.pro_Prepare_Netunim_Tnua(P_STARTDATE,P_ENDDATE);
DBMS_OUTPUT.PUT_LINE ('pro_Prepare_Netunim_Tnua:'  || to_char(sysdate,'HH24:mi:ss'));
open p_Cur   for
    select    OV.SHEM_MISH , OV.SHEM_PRAT  ,y.TEUR_MIKUM_YECHIDA,
                 E.TEUR_EZOR ,M.TEUR_MAAMAD_HR , S.TEUR_SNIF_AV,
                H.*
 from
         CTB_MIKUM_YECHIDA y,
         TMP_PIRTEY_OVDIM T,
         CTB_EZOR E,
         CTB_MAAMAD M,
         CTB_SNIF_AV S,
         OVDIM OV ,        
        (select decode(x.mispar_ishi,null,y.mispar_ishi,x.mispar_ishi)mispar_ishi,
					 decode(x.taarich,null,y.taarich,x.taarich) taarich,
                      nvl(x.makat_nesia  ,y.makat_nesia) makat,x.mikum_pundak,y.mikum_shaon,
                      decode(x.SHAT_YETZIA,null,y.SHAT_YETZIA,x.SHAT_YETZIA) SHAT_YETZIA ,nvl(x.yom,y.yom) YOM,
                      nvl(x.MISPAR_SIDUR,y.MISPAR_SIDUR) MISPAR_SIDUR,nvl(x.OTO_NO,y.OTO_NO) OTO_NO,
                      nvl(to_char(y.SHAT_HITYAZVUT,'hh24:mi'),'') SHAT_HITYAZVUT,nvl(x.SHILUT,y.SHILUT) SHILUT,
                      nvl(x.TEUR_NESIA,y.TEUR_NESIA) TEUR_NESIA,
                    (case 
                       when x.mikum_pundak is not null and y.mikum_shaon is null and substr(x.MAKAT_NESIA,6,1) not  in ('6','7','8') then 1
                       when x.mikum_pundak is not null and y.mikum_shaon is null and substr(x.MAKAT_NESIA,6,1)  in ('6','7','8') then 4 
                       when  x.mikum_pundak is null and y.mikum_shaon is not null and y.k is not null then 2
                       when  x.mikum_pundak is null and y.mikum_shaon is not null and y.k is null then 3 
                     else 0
                     end) avera
        from
        (select distinct  p.MISPAR_ISHI, p.MAKAT_NESIA, p.TAARICH, v.MIKUM_PUNDAK,
                       p.SHAT_YETZIA, k.SHILUT,k.TEUR_NESIA,
                      DAYOFWEEK(p.TAARICH)  Yom,p.OTO_NO,p.MISPAR_SIDUR
        from TB_PEILUT_OVDIM p,
                   CTB_MAKATIM_LEPUNDAKIM k,
                  TMP_VISUTIM c,
                  TB_PUNDAKIM_VISUTIM v
        where substr( lpad(p.MAKAT_NESIA,8, '0'),0,5) = lpad(k.MAKAT ,5, '0') -- lpad(p.MAKAT_NESIA,5, '0')    = lpad(k.MAKAT ,5, '0') 
            and p.TAARICH between k.ME_TAARICH and k.AD_TAARICH
        --    and p.TAARICH  between to_date('01/01/2010','dd/mm/yyyy') and to_date('01/02/2010','dd/mm/yyyy')
            and p.TAARICH  between to_date(P_STARTDATE,'dd/mm/yyyy') and  to_date(P_ENDDATE,'dd/mm/yyyy')--P_STARTDATE and P_ENDDATE
            and substr( lpad(p.MAKAT_NESIA,8, '0'),0,5)=substr( lpad(c.MAKAT8,8, '0'),0,5)  -- lpad(p.MAKAT_NESIA,5, '0') = lpad(c.MAKAT8 ,5, '0') 
            and v.MIS_VISUT = substr(c.NIHUL,2)
            and  p.TAARICH between v.ME_TAARICH and v.AD_TAARICH
        and  p.TAARICH=c.START_DATE
            and   (P_MISPAR_ISHI is null or p.MISPAR_ISHI in (select x from table(cast(convert_string_to_table(P_MISPAR_ISHI ,  ',') as mytabtype))))
        --and p.MISPAR_ISHI = 11094
            )  x 
        
        full join
        
        ( select  distinct  t.MISPAR_ISHI,p.MAKAT_NESIA,p.SHAT_YETZIA,t.TAARICH,t.SHAT_HITYAZVUT,
                       substr(lpad(t.MIKUM_SHAON ,5, '0'),0,3)     MIKUM_SHAON   , k.MAKAT k, DAYOFWEEK(p.TAARICH)   Yom,
                       p.OTO_NO,p.MISPAR_SIDUR , c.SHILUT, c.DESCRIPTION TEUR_NESIA
        from TB_HITYAZVUT_PUNDAKIM t,
                  TB_PEILUT_OVDIM p  ,     
                  CTB_MAKATIM_LEPUNDAKIM k ,    
                   TMP_CATALOG c
        where  
        -- t.TAARICH  between to_date('01/01/2010','dd/mm/yyyy') and to_date('01/02/2010','dd/mm/yyyy')
        t.TAARICH  between to_date(P_STARTDATE,'dd/mm/yyyy') and  to_date(P_ENDDATE,'dd/mm/yyyy') -- P_STARTDATE and P_ENDDATE
        --and t.MISPAR_ISHI =11094 --  3854 --
        and t.MISPAR_ISHI=p.MISPAR_ISHI
        and p.TAARICH= t.TAARICH
        and t.SHAT_HITYAZVUT>= p.SHAT_YETZIA   and t.SHAT_HITYAZVUT<= (p.SHAT_YETZIA +( c.MAZAN_TICHNUN/1440)) -- interval  to_char(c.MAZAN_TASHLUM)  minute )
    --    and p.TAARICH  between to_date('01/01/2010','dd/mm/yyyy') and to_date('01/02/2010','dd/mm/yyyy')
        and p.TAARICH  between to_date(P_STARTDATE,'dd/mm/yyyy') and  to_date(P_ENDDATE,'dd/mm/yyyy')  -- P_STARTDATE and P_ENDDATE
        and substr( lpad(p.MAKAT_NESIA,8, '0'),0,5) =k.MAKAT(+)-- to_number(lpad(p.MAKAT_NESIA,5, '0') )   = k.MAKAT(+)
        and p.TAARICH between k.ME_TAARICH(+) and k.AD_TAARICH(+)
        and  p.TAARICH=c.ACTIVITY_DATE(+)        
        and p.MAKAT_NESIA = c.MAKAT8(+)  
        and   (P_MISPAR_ISHI is null or t.MISPAR_ISHI in (select x from table(cast(convert_string_to_table(P_MISPAR_ISHI ,  ',') as mytabtype))))
        ) y
        on x.MISPAR_ISHI=y.MISPAR_ISHI
             and x.TAARICH = y.TAARICH
              and x.MIKUM_PUNDAK = y.MIKUM_SHAON
             and x.MAKAT_NESIA = y.MAKAT_NESIA      ) H

WHERE y.KOD_MIKUM_YECHIDA (+)  = nvl( h.mikum_pundak,h.MIKUM_SHAON)
        and OV.MISPAR_ISHI = H.MISPAR_ISHI
        and OV.MISPAR_ISHI = T.MISPAR_ISHI
        and  H.TAARICH BETWEEN T.ME_TARICH AND T.AD_TARICH  
        and  T.EZOR =E.KOD_EZOR 
        and OV.KOD_HEVRA=E.KOD_HEVRA 
        and  T.MAAMAD = M.KOD_MAAMAD_HR 
        and  OV.KOD_HEVRA=M.KOD_HEVRA  
        and  T.SNIF_AV = S. KOD_SNIF_AV 
        and  OV.KOD_HEVRA=S.KOD_HEVRA
       and h.avera >mis
order by h.MISPAR_ISHI, h.TAARICH ,h.SHAT_YETZIA;
DBMS_OUTPUT.PUT_LINE ('sql:'  || to_char(sysdate,'HH24:mi:ss'));
end   Pro_Get_TlunotPundakim;

PROCEDURE pro_Prepare_Netunim_Tnua(P_STARTDATE in VARCHAR2,
                                                                                 P_ENDDATE in VARCHAR2) IS
rc number ;    
CountQry varchar2(3000);
CountRows number;
GeneralQry varchar2(3000);
InsertQry  varchar2(3000);                                                                 
BEGIN
DBMS_OUTPUT.PUT_LINE ('1:'  || to_char(sysdate,'HH24:mi:ss'));
        execute immediate  'truncate table tmp_Visutim' ;  
      /*  GeneralQry:= 'select distinct  p.TAARICH,p.MAKAT_NESIA,1 from TB_PEILUT_OVDIM p  ,TB_HITYAZVUT_PUNDAKIM t  where  p.TAARICH= t.TAARICH and t.MISPAR_ISHI=p.MISPAR_ISHI
                                                  and   (p.taarich between to_date( '''    || P_STARTDATE || ''',''dd/MM/yyyy'') and to_date(''' || P_ENDDATE || ''',''dd/MM/yyyy''))';
    */
	 GeneralQry:= 'select distinct  p.TAARICH,p.MAKAT_NESIA,1 from TB_PEILUT_OVDIM p  ,CTB_MAKATIM_LEPUNDAKIM c
	 			  		  			where  substr( lpad(p.MAKAT_NESIA,8, ''0''),0,5) = c.MAKAT and c.ME_TAARICH<=p.TAARICH and c.AD_TAARICH>=p.TAARICH';
        CountQry := 'Select  nvl(count(*),0)  from (' || GeneralQry || ')'  ;  
        execute immediate CountQry INTO CountRows  ; 
        DBMS_OUTPUT.PUT_LINE ('2:'  || to_char(sysdate,'HH24:mi:ss'));
    --    DBMS_OUTPUT.PUT_LINE (CountRows);
        if (CountRows > 0 ) then                             
                 InsertQry := 'INSERT INTO  tmp_visutim@kds_gw_at_tnpr(start_date,makat8,SIDURI) ' || GeneralQry  ;                      
                 execute immediate InsertQry ;
                 GetVisut4Kav@kds_gw_at_tnpr(rc);
                 insert into tmp_Visutim ( START_DATE,MAKAT8, SIDURI,NIHUL,  NIHUL_NAME,STATUS) 
                                 SELECT  START_DATE,MAKAT8, SIDURI,NIHUL,  NIHUL_NAME,STATUS  
                                 FROM TMP_VISUTIM@kds_gw_at_tnpr ;
                 commit ;        
        end if;         
        DBMS_OUTPUT.PUT_LINE ('3:'  || to_char(sysdate,'HH24:mi:ss'));
        GeneralQry:='';
        GeneralQry:= ' select  distinct  p.MAKAT_NESIA, p.TAARICH  from TB_PEILUT_OVDIM p  where 
                                    (p.taarich between to_date( '''    || P_STARTDATE || ''',''dd/MM/yyyy'') and to_date(''' || P_ENDDATE || ''',''dd/MM/yyyy''))';
        PKG_REPORTS.pro_Prepare_Catalog_Details(GeneralQry);
        DBMS_OUTPUT.PUT_LINE ('4:'  || to_char(sysdate,'HH24:mi:ss'));
     EXCEPTION 
         WHEN OTHERS THEN 
               RAISE;             
end pro_Prepare_Netunim_Tnua;
/****************************************************/

PROCEDURE pro_getPirteyOvedForWorkCard(p_Cur out Curtype,
                                                                                                    P_TAARICH in DATE,
                                                                                                P_MISPAR_ISHI in NUMBER) as                                                                                            
BEGIN
open p_Cur   for
        select o.shem_prat  || ' ' ||  o.shem_mish  full_name,DAYOFWEEK(P_TAARICH) yom,
                     t.MAAMAD kod_maamad,  m.TEUR_MAAMAD_HR maamad, 
                     s.TEUR_SNIF_AV snif, y.TACHOGRAF kod_tachograf,
                    z.TEUR_ZMAN_NESIAA,l.TEUR_LINA,
                    y.HAMARAT_SHABAT,h.TEUR_ZMAN_HALBASHA,
                    so1.NIDRESHET_HITIATZVUT HITIATZVUT_A, nvl(to_char(so1.SHAT_HITIATZVUT,'hh24:mi'),'')  SHAT_HITIATZVUT_A,
                    so1.HACHTAMA_BEATAR_LO_TAKIN HACHTAMA_A,so1.PTOR_MEHITIATZVUT PTOR_A,
                    b.TEUR_SIBA SIBA_A,t.DIRUG,t.DARGA,
                    so2.NIDRESHET_HITIATZVUT HITIATZVUT_B,nvl(to_char(so2.SHAT_HITIATZVUT,'hh24:mi'),'')  SHAT_HITIATZVUT_B,
                    so2.HACHTAMA_BEATAR_LO_TAKIN HACHTAMA_B,so2.PTOR_MEHITIATZVUT PTOR_B,
                    b2.TEUR_SIBA SIBA_B, y.MEASHER_O_MISTAYEG
					,  PKG_REPORTS.bdok_shibuz_mechona( P_TAARICH,P_MISPAR_ISHI) SHIBUZ_MECHONA
        from OVDIM o,      
                  TMP_PIRTEY_OVDIM t,
                  CTB_MAAMAD m,
                  CTB_SNIF_AV s,
                  TB_YAMEY_AVODA_OVDIM y,
                  CTB_ZMANEY_NESIAA z,
                  CTB_LINA l,
                  CTB_ZMANEY_HALBASHA h,
                   TB_SIDURIM_OVDIM so1,
                 CTB_SIBOT_LEDIVUCH_YADANI b,
                 TB_SIDURIM_OVDIM so2,
                  CTB_SIBOT_LEDIVUCH_YADANI b2
				 
        where o.MISPAR_ISHI = P_MISPAR_ISHI
        and o.MISPAR_ISHI = t.MISPAR_ISHI
        and  trunc(P_TAARICH) between t.ME_TARICH and t.AD_TARICH
        and t.MAAMAD = m.KOD_MAAMAD_HR
        and o.KOD_HEVRA = m.KOD_HEVRA
        and  t.SNIF_AV= s.KOD_SNIF_AV
        and o.KOD_HEVRA = s.KOD_HEVRA
        and o.MISPAR_ISHI = y.MISPAR_ISHI
        and y.TAARICH =  trunc(P_TAARICH)
        and y.BITUL_ZMAN_NESIOT = z.KOD_ZMAN_NESIAA
        and y.LINA =  l.KOD_LINA
        and y.HALBASHA = h.KOD_ZMAN_HALBASHA
        and so1.MISPAR_ISHI(+) = o.MISPAR_ISHI
        and so1.TAARICH(+) =trunc(P_TAARICH)
        and so1.NIDRESHET_HITIATZVUT(+) = 1 
	    and (so1.bitul_o_hosafa not in(1,3) or so1.bitul_o_hosafa is null)
        and so1.KOD_SIBA_LEDIVUCH_YADANI_IN = b.KOD_SIBA(+)
        and so2.MISPAR_ISHI(+) = o.MISPAR_ISHI
        and so2.TAARICH(+) =trunc(P_TAARICH)
        and so2.NIDRESHET_HITIATZVUT(+) = 2
		and (so2.bitul_o_hosafa not in(1,3) or so2.bitul_o_hosafa is null)
        and so2.KOD_SIBA_LEDIVUCH_YADANI_IN = b2.KOD_SIBA(+);

     EXCEPTION 
         WHEN OTHERS THEN 
               RAISE;             
end pro_getPirteyOvedForWorkCard;


PROCEDURE pro_getSidurimVePeiluyotForWC(p_Cur out Curtype,
                                                                                                    P_TAARICH in DATE,
                                                                                                P_MISPAR_ISHI in NUMBER) as
    GeneralQry varchar2(3000);                                                                                                                                                                                        
BEGIN
GeneralQry:='';
GeneralQry:='select * from(select  distinct  p.MAKAT_NESIA,  p.TAARICH from TB_PEILUT_OVDIM p  where p.MISPAR_ISHI ='    || P_MISPAR_ISHI || ' and   p.taarich  =   ''' || trunc(P_TAARICH) || ''')';
PKG_REPORTS.pro_Prepare_Catalog_Details(GeneralQry);

open p_Cur   for
	   select h.* from(
        select s.MISPAR_SIDUR, to_char( s.SHAT_HATCHALA,'hh24:mi')  SHAT_HATCHALA,s.SHAT_HATCHALA SHAT_HATCHALA_FULL,
                     to_char( s.SHAT_GMAR,'hh24:mi')  SHAT_GMAR,
                     to_char( p.SHAT_YETZIA,'hh24:mi')  SHAT_YETZIA,p.SHAT_YETZIA SHAT_YETZIA_FULL,
                     p.MAKAT_NESIA, p.OTO_NO,p.mispar_knisa,
                     to_char( p.SHAT_YETZIA -( nvl(p.KISUY_TOR,0)/1440)  ,'hh24:mi') KISUY_TOR,
                      c.SHILUT, decode(p.mispar_knisa,null,trim(c.DESCRIPTION),0,trim(c.DESCRIPTION),trim(p.teur_nesia)) TEUR_NESIA  ,c.SUG_SHIRUT_NAME ,c.ONATIUT,
					  p.MISPAR_MATALA,e.KOD_MEAFYEN MEAFYEN_NOSEA,p.MISPAR_SIDURI_OTO,
                     -- PKG_REPORTS.IsEilatTrip(nvl(c.KM,0),trunc( P_TAARICH),nvl(c.EILAT_TRIP,0)) isEilatTrip ,
					 c.EILAT_TRIP  isEilatTrip,el.TEUR_ELEMENT,t.teur_nekudat_tiful,trim(p.teur_nesia) teur,
					  rownum num
        from TB_SIDURIM_OVDIM s,
                  TB_PEILUT_OVDIM p  ,
                 TMP_CATALOG c,
				  TB_MEAFYENEY_ELEMENTIM e,
                 CTB_ELEMENTIM el,
				  ctb_nkudut_tifaul t
        where s.MISPAR_ISHI = P_MISPAR_ISHI
         --    and s.MISPAR_SIDUR =49150
              and s.TAARICH = trunc( P_TAARICH)
              and s.MISPAR_ISHI = p.MISPAR_ISHI(+)
              and s.TAARICH = p.TAARICH(+)
              and s.MISPAR_SIDUR =p.MISPAR_SIDUR(+)
              and s.SHAT_HATCHALA = p.SHAT_HATCHALA_SIDUR(+)
              and  p.TAARICH=c.ACTIVITY_DATE(+)
              and p.MAKAT_NESIA = c.MAKAT8(+)
			    and (p.BITUL_O_HOSAFA <>1 or p.BITUL_O_HOSAFA is null)
              and s.MISPAR_SIDUR not in (select MISPAR_SIDUR from TB_SIDURIM_MEYUCHADIM where KOD_MEAFYEN = 45)
			  and s.MISPAR_SIDUR not in(99500,99501,99200)
			  and (s.BITUL_O_HOSAFA  not in(1,3) or s.BITUL_O_HOSAFA is null)
			  and substr( p.MAKAT_NESIA,2,2) = e.KOD_ELEMENT(+) 
			  and substr( p.MAKAT_NESIA,2,2)=el.KOD_ELEMENT(+)
			and substr(p.MAKAT_NESIA,4,3)= substr(t.kod_nekudat_tiful(+),2,3)
			  and (el.PAIL=1 or el.PAIL is null)
			  and e.KOD_MEAFYEN(+) =19 --matala cenosea
			  	  ) h,
	 table(cast(convert_string_to_table('1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32'  ,  ',') as mytabtype)) tmp2
where   h.num(+) = tmp2.x
     order by h.SHAT_HATCHALA_FULL,h.SHAT_YETZIA_FULL,h.mispar_knisa asc;
	 
	 
--DBMS_OUTPUT.PUT_LINE (p_Cur);
 EXCEPTION 
         WHEN OTHERS THEN 
               RAISE;             
end       pro_getSidurimVePeiluyotForWC;

FUNCTION IsEilatTrip(km NUMBER,taarich DATE,eilatTrip NUMBER) return number as
erech number;
BEGIN
     select  nvl(p.ERECH_PARAM,0)
     into erech
     from TB_PARAMETRIM p
     where p.KOD_PARAM = 149
     and taarich between p.ME_TAARICH and p.AD_TAARICH;

     if (km>erech  and eilatTrip=1) then
         return 1;
        else
        return 0;
    end if;    
 EXCEPTION 
         WHEN OTHERS THEN 
               RAISE;             
END    IsEilatTrip;

FUNCTION bdok_shibuz_mechona(P_TAARICH in DATE, P_MISPAR_ISHI in NUMBER) return number as

CURSOR p_cur IS
	    select p.MAKAT_NESIA,p.OTO_NO
		from  TB_SIDURIM_OVDIM s,TB_PEILUT_OVDIM p  
		where s.MISPAR_ISHI = P_MISPAR_ISHI
              and s.TAARICH = trunc( P_TAARICH)
              and s.MISPAR_ISHI = p.MISPAR_ISHI(+)
              and s.TAARICH = p.TAARICH(+)
              and s.MISPAR_SIDUR =p.MISPAR_SIDUR(+)
              and s.SHAT_HATCHALA = p.SHAT_HATCHALA_SIDUR(+)
              and s.MISPAR_SIDUR not in (select MISPAR_SIDUR from TB_SIDURIM_MEYUCHADIM where KOD_MEAFYEN = 45)
			  and s.MISPAR_SIDUR not in(99500,99501)
			  and s.BITUL_O_HOSAFA <>1;
	v_rec  p_cur%ROWTYPE;		 
	flag varchar(5); 
	kod number(3); 
BEGIN
   	  flag:='true';
   	 	FOR v_rec  in   p_cur   LOOP
				 kod:=-1;
				if (v_rec.MAKAT_NESIA is not null and substr(v_rec.MAKAT_NESIA,1,1) ='7') then
					BEGIN
					   		select e.KOD_MEAFYEN
										into kod
										from  TB_MEAFYENEY_ELEMENTIM e
										where e.KOD_ELEMENT = to_number( substr(v_rec.MAKAT_NESIA,2,2) )
					  							and e.KOD_MEAFYEN =11;
							  EXCEPTION
				  				 		    WHEN NO_DATA_FOUND  THEN
				        						   kod:=-1;
						 END;
						 if ( kod <>-1 and v_rec.OTO_NO is null) then
						 	   flag:='false';
						 end if; 
					else
						 if (v_rec.MAKAT_NESIA is not null and v_rec.OTO_NO is null) then
						 	   flag:='false';
						 end if; 
					end if;
       END LOOP;
	--DBMS_OUTPUT.PUT_LINE (flag);   
	   if (flag ='true') then
	   	  return 1;
		else return 0;
	end if;
		  
 EXCEPTION 
         WHEN OTHERS THEN 
               RAISE;             
END    bdok_shibuz_mechona;

PROCEDURE pro_getPrepareReports(P_MISPAR_ISHI in NUMBER,
		  									  	 			  		 		   P_STATUS_LIST in VARCHAR2,
		  									   	  		                          p_Cur out Curtype ) as

BEGIN
open p_Cur   for																				  
		SELECT B.Status, B.Bakasha_ID, B.Sug_Bakasha, B.Teur, B.Zman_Hatchala, S.TEUR_STATUS_BAKASHA,
					      SB.TEUR_SUG_BAKASHA,B.Zman_Siyum, O.SHEM_PRAT || '  ' ||O. SHEM_MISH USER_NAME
					  ,D.KOD_SUG_DOCH, D.SHEM_TIKIYA,D.EXTENSION_TYPE
						FROM TB_Bakashot B, 
							 		  Ovdim O ,
							 		  CTB_STATUS_BAKASHA S,
									  CTB_SUG_BAKASHA SB,
									  TB_DOCHOT_MISPAR_ISHI D
						WHERE B.Mishtamesh_ID=P_MISPAR_ISHI --O.Mispar_Ishi (+)
						AND B.Mishtamesh_ID=O.Mispar_Ishi 
						AND B.STATUS=S.KOD_STATUS_BAKASHA
						AND B.SUG_BAKASHA=SB.KOD_SUG_BAKASHA
						AND B.BAKASHA_ID = D.BAKASHA_ID
						AND D.PAIL =1
						AND B.STATUS in (select x from table(cast(convert_string_to_table(P_STATUS_LIST ,  ',') as mytabtype)))
ORDER BY B.ZMAN_HATCHALA DESC;

 EXCEPTION 
         WHEN OTHERS THEN 
               RAISE;             
END pro_getPrepareReports;


PROCEDURE pro_updatePrepareReports(P_MISPAR_ISHI in NUMBER ) as

BEGIN
		UPDATE 	TB_Bakashot B
		SET 	B.STATUS = 2
		WHERE B.BAKASHA_ID in(SELECT B.Bakasha_ID
																FROM TB_Bakashot B, TB_DOCHOT_MISPAR_ISHI D
																WHERE B.Mishtamesh_ID=P_MISPAR_ISHI 
																AND B.BAKASHA_ID = D.BAKASHA_ID
																AND B.STATUS = 4
																AND D.PAIL =1);
 EXCEPTION 
         WHEN OTHERS THEN 
               RAISE;             
END pro_updatePrepareReports;


PROCEDURE pro_getSidureyVisaForWC(p_Cur out Curtype,
                                                                                     P_TAARICH in DATE,
                                                                                       P_MISPAR_ISHI in NUMBER) as
BEGIN
open p_Cur   for																									
		select distinct h.*,po.OTO_NO
from(
select s.MISPAR_SIDUR, to_char( s.SHAT_HATCHALA,'hh24:mi')  SHAT_HATCHALA,
             to_char( s.SHAT_GMAR,'hh24:mi')  SHAT_GMAR ,s.SECTOR_VISA,  s.YOM_VISA ,
			  y.TEUR_YOM_VISA, p.MISPAR_VISA,p.KM_VISA,  to_char( p.SHAT_YETZIA,'hh24:mi')   SHAT_YETZIA,
			  o.shem_prat  || ' ' ||  o.shem_mish  full_name,DAYOFWEEK(trunc(P_TAARICH)) yom,
			  t.MAAMAD kod_maamad,  m.TEUR_MAAMAD_HR maamad, 
              f.TEUR_SNIF_AV snif, ya.TACHOGRAF kod_tachograf,
              z.TEUR_ZMAN_NESIAA,l.TEUR_LINA,
              ya.HAMARAT_SHABAT, --,x.TEUR_ZMAN_HALBASHA,
			  ya.MEASHER_O_MISTAYEG,
			  s.SHAT_HATCHALA SHAT_SIDUR, s.TAARICH,s.MISPAR_ISHI

from TB_SIDURIM_OVDIM s,
          TB_PEILUT_OVDIM p  ,
          CTB_YOM_VISA y,
		  OVDIM o,      
          TMP_PIRTEY_OVDIM t,
           CTB_MAAMAD m,
           CTB_SNIF_AV f,
           TB_YAMEY_AVODA_OVDIM ya,
           CTB_ZMANEY_NESIAA z,
           CTB_LINA l  --,
        --   CTB_ZMANEY_HALBASHA x
 where s.MISPAR_ISHI =   P_MISPAR_ISHI
              and s.TAARICH =trunc(P_TAARICH)
			 and s.YOM_VISA = y.KOD_YOM_VISA(+)
              and s.MISPAR_ISHI = p.MISPAR_ISHI(+)
              and s.TAARICH = p.TAARICH(+)
              and s.MISPAR_SIDUR =p.MISPAR_SIDUR(+)
			  and s.BITUL_O_HOSAFA  not in(1,3)
              and s.SHAT_HATCHALA = p.SHAT_HATCHALA_SIDUR(+)
              and s.MISPAR_SIDUR  in (select MISPAR_SIDUR from TB_SIDURIM_MEYUCHADIM where KOD_MEAFYEN = 45)
    		  and substr(p.MAKAT_NESIA,0,1) ='5'
			  and  o.MISPAR_ISHI =   P_MISPAR_ISHI
			  and o.MISPAR_ISHI = t.MISPAR_ISHI
		      and trunc(P_TAARICH) between t.ME_TARICH and t.AD_TARICH
		      and t.MAAMAD = m.KOD_MAAMAD_HR
		      and o.KOD_HEVRA = m.KOD_HEVRA
		      and t.SNIF_AV= f.KOD_SNIF_AV
		      and o.KOD_HEVRA = f.KOD_HEVRA
		      and o.MISPAR_ISHI = ya.MISPAR_ISHI
		      and ya.TAARICH =  trunc(P_TAARICH)
		      and ya.BITUL_ZMAN_NESIOT = z.KOD_ZMAN_NESIAA
			 --  and ya.HALBASHA = x.KOD_ZMAN_HALBASHA
		      and ya.LINA =  l.KOD_LINA   )h,
			   TB_PEILUT_OVDIM po
where h.MISPAR_ISHI =po.MISPAR_ISHI and
	  		 h.MISPAR_SIDUR = po.MISPAR_SIDUR and
	  		 h.TAARICH = po.TAARICH and
			 h.SHAT_SIDUR = po.SHAT_HATCHALA_SIDUR 
		
order by h.MISPAR_SIDUR,h.SHAT_SIDUR;
END pro_getSidureyVisaForWC;		

PROCEDURE pro_get_HeavyReportsToDelete(p_Cur out Curtype) as

DaysNum number;
BEGIN

	 	select p.ERECH_PARAM
		into DaysNum
		from TB_PARAMETRIM p
		where p.KOD_PARAM = 94;

		open p_Cur   for			
				 select D.Bakasha_ID || (CASE    D.EXTENSION_TYPE  WHEN  1  THEN '.pdf'  ELSE  '.exl' END)  ReportName
		  		 from  TB_Bakashot B, TB_DOCHOT_MISPAR_ISHI D
				where  B.BAKASHA_ID = D.BAKASHA_ID
					   AND D.PAIL =1 
					   AND B.STATUS=2
					   AND trunc((B.ZMAN_SIYUM + DaysNum)) = trunc(sysdate);
																   						   
	UPDATE TB_DOCHOT_MISPAR_ISHI d
		SET d.PAIL = 0
		WHERE d.BAKASHA_ID in( select B.Bakasha_ID
			  			   	   		  			  		  	    from  TB_Bakashot B, TB_DOCHOT_MISPAR_ISHI D
																where  B.BAKASHA_ID = D.BAKASHA_ID
																	   AND D.PAIL =1
																	   AND B.STATUS=2
																	   AND trunc((B.ZMAN_SIYUM + DaysNum)) = trunc(sysdate));

	 EXCEPTION 
         WHEN OTHERS THEN 
               RAISE; 
END pro_get_HeavyReportsToDelete;
END PKG_REPORTS;
/
CREATE OR REPLACE PACKAGE PKG_REQUEST AS
/******************************************************************************
   NAME:       PKG_REQUEST
   PURPOSE:

   REVISIONS:
   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        30/09/2009             1. Created this package.
******************************************************************************/
TYPE	CurType	  IS	REF  CURSOR;


PROCEDURE pro_get_requests(p_bakasha_id IN TB_Bakashot.BAKASHA_ID%TYPE DEFAULT NULL ,
																p_sug_bakasha IN TB_Bakashot.SUG_BAKASHA%TYPE  DEFAULT NULL ,
																p_status IN TB_Bakashot.STATUS%TYPE DEFAULT NULL ,
																p_chodesh IN VARCHAR2,
																p_Cur OUT CurType) ;

PROCEDURE pro_get_requests_list(p_bakasha_id IN  varchar2,    p_month in varchar2,p_Cur OUT CurType) ;

PROCEDURE  pro_get_status_request(p_Cur OUT CurType);

PROCEDURE  pro_get_type_request(p_Cur OUT CurType) ;

PROCEDURE  pro_get_ovdim_log_bakashot(p_mispar_ishi IN  varchar2,
		   														 	  p_bakasha_id IN TB_Bakashot.BAKASHA_ID%TYPE DEFAULT NULL ,
		   														 	   p_month in varchar2,
		   															  p_Cur OUT CurType) ;

	PROCEDURE pro_get_month_requests(p_cur out CurType);

	PROCEDURE pro_get_log_bakashot(p_bakasha_id IN TB_Bakashot.BAKASHA_ID%TYPE DEFAULT NULL ,
																p_sug_bakasha IN TB_Bakashot.SUG_BAKASHA%TYPE  DEFAULT NULL ,
																p_mispar_ishi IN TB_Bakashot.STATUS%TYPE DEFAULT NULL ,
																p_chodesh IN VARCHAR2  ,p_Type_Message IN CHAR,
																p_Cur OUT CurType) ;
		
	PROCEDURE  pro_get_tahalich_klita(p_Cur OUT CurType);
	
	PROCEDURE pro_get_log_tahalich(p_from_date IN TB_LOG_TAHALICH.TAARICH%TYPE,
																p_to_date IN TB_LOG_TAHALICH.TAARICH%TYPE  ,
																p_process_code IN TB_LOG_TAHALICH.KOD_TAHALICH%TYPE DEFAULT NULL ,
																p_status  IN TB_LOG_TAHALICH.STATUS%TYPE DEFAULT NULL ,
																p_Cur OUT CurType);															
END PKG_REQUEST;
/

CREATE OR REPLACE PACKAGE BODY PKG_REQUEST AS
/******************************************************************************
   NAME:       PKG_REQUEST
   PURPOSE:

   REVISIONS:
   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        30/09/2009             1. Created this package body.
******************************************************************************/

PROCEDURE pro_get_requests(p_bakasha_id IN TB_Bakashot.BAKASHA_ID%TYPE DEFAULT NULL ,
																p_sug_bakasha IN TB_Bakashot.SUG_BAKASHA%TYPE  DEFAULT NULL ,
																p_status IN TB_Bakashot.STATUS%TYPE DEFAULT NULL ,
																p_chodesh IN VARCHAR2 ,
																p_Cur OUT CurType)
IS
  v_taarich_min date;
	 BEGIN
	  v_taarich_min:=add_months(to_date('01/' || to_char(sysdate,'mm/yyyy'),'dd/mm/yyyy'),-13) ;
 	 	  OPEN p_Cur FOR
      	  	   SELECT B.Status, B.Bakasha_ID, B.Sug_Bakasha, B.Teur, B.Zman_Hatchala, S.TEUR_STATUS_BAKASHA,
			   SB.TEUR_SUG_BAKASHA,
	   			 B.Zman_Siyum, O.SHEM_PRAT || '  ' ||O. SHEM_MISH USER_NAME, B.Huavra_Lesachar, B.Taarich_Haavara_Lesachar
				FROM TB_Bakashot B, Ovdim O ,CTB_STATUS_BAKASHA S,CTB_SUG_BAKASHA SB
				WHERE B.Mishtamesh_ID=O.Mispar_Ishi (+)
				AND B.STATUS=S.KOD_STATUS_BAKASHA
				AND B.SUG_BAKASHA=SB.KOD_SUG_BAKASHA
				AND (B.BAKASHA_ID=p_bakasha_id or p_bakasha_id IS NULL)
				AND (B.Sug_Bakasha=p_sug_bakasha OR p_sug_bakasha IS NULL)
				AND (B.STATUS=p_status OR p_status IS NULL)
				AND  to_char(b.Zman_Hatchala,'mm/yyyy')=nvl(p_chodesh,to_char(b.Zman_Hatchala,'mm/yyyy'))
				AND b.Zman_Hatchala>=v_taarich_min
				ORDER BY B.ZMAN_HATCHALA DESC;

	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END pro_get_requests;

PROCEDURE  pro_get_requests_list(p_bakasha_id IN  varchar2,
		   									  	  		   		  	      p_month in varchar2,
		   									  	 							 p_Cur OUT CurType)
IS
	 BEGIN
 	 	  OPEN p_Cur FOR
      	  	   SELECT B.Bakasha_ID
	   			FROM TB_Bakashot B
				WHERE to_char(B.Bakasha_ID) like p_bakasha_id
				and  to_char(Zman_Hatchala,'mm/yyyy')=nvl(p_month,to_char(Zman_Hatchala,'mm/yyyy'))
				ORDER BY B.Bakasha_ID ASC;

	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END pro_get_requests_list;

PROCEDURE  pro_get_status_request(p_Cur OUT CurType)
IS
	 BEGIN
 	 	  OPEN p_Cur FOR
      	  	   SELECT s.KOD_STATUS_BAKASHA CODE ,s.TEUR_STATUS_BAKASHA Description
	   			FROM CTB_STATUS_BAKASHA s
				WHERE S.PAIL=1
				ORDER BY s.TEUR_STATUS_BAKASHA ASC;

	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END pro_get_status_request;

PROCEDURE  pro_get_type_request(p_Cur OUT CurType)
IS
	 BEGIN
 	 	  OPEN p_Cur FOR
      	  	   SELECT s.KOD_SUG_BAKASHA CODE ,s.TEUR_SUG_BAKASHA Description
	   			FROM CTB_SUG_BAKASHA s
				WHERE S.PAIL=1
				ORDER BY s.TEUR_SUG_BAKASHA ASC;

	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END pro_get_type_request;

PROCEDURE  pro_get_ovdim_log_bakashot(p_mispar_ishi IN  varchar2,
		   														                        p_bakasha_id IN TB_Bakashot.BAKASHA_ID%TYPE DEFAULT NULL ,
		   														                        p_month in varchar2,
		   															 			   	   p_Cur OUT CurType)
IS
	 BEGIN
 	 	  OPEN p_Cur FOR
      	  	   select distinct l.mispar_ishi
			    from tb_log_bakashot l,tb_bakashot b
				where   to_char( l.mispar_ishi ) like p_mispar_ishi
				and l.bakasha_id=nvl( p_bakasha_id,l.bakasha_id)
				and b.bakasha_id=l.bakasha_id
				and  to_char(b.Zman_Hatchala,'mm/yyyy')=nvl(p_month,to_char(b.Zman_Hatchala,'mm/yyyy'))
				ORDER BY  l.mispar_ishi  ASC;

	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END pro_get_ovdim_log_bakashot;

PROCEDURE pro_get_month_requests(p_cur out CurType) is
	begin
	  open p_cur for
		 select  h.month_year  CODE,h.month_year   description
		 from
				(select month_year,to_date('01/' || month_year,'dd/mm/yyyy') taarich
				from(
					select   distinct to_char(Zman_Hatchala,'mm/yyyy') month_year
						from TB_bakashot
						order by month_year  desc)
				order by taarich  desc) h
		 where rownum<15;
  EXCEPTION
       WHEN OTHERS THEN
				RAISE;
end   pro_get_month_requests;


PROCEDURE pro_get_log_bakashot(p_bakasha_id IN TB_Bakashot.BAKASHA_ID%TYPE DEFAULT NULL ,
																p_sug_bakasha IN TB_Bakashot.SUG_BAKASHA%TYPE  DEFAULT NULL ,
																p_mispar_ishi IN TB_Bakashot.STATUS%TYPE DEFAULT NULL ,
																p_chodesh IN VARCHAR2 ,p_Type_Message IN CHAR,
																p_Cur OUT CurType)
IS
  v_taarich_min date;
	 BEGIN
	  v_taarich_min:=add_months(to_date('01/' || to_char(sysdate,'mm/yyyy'),'dd/mm/yyyy'),-13) ;
 	 	  OPEN p_Cur FOR
      	  	      	select l.bakasha_id,decode(l.sug_hodaa,'E','','W','','I','') sug_hodaa ,s.TEUR_SUG_BAKASHA,
					l.mispar_ishi,l.taarich,l.MISPAR_SIDUR,l.SHAT_HATCHALA_SIDUR,l.SHAT_YETZIA,l.TAARICH_IDKUN_ACHARON,l.KOD_YESHUT,
					l.TEUR_HODAA
					from tb_log_bakashot l,tb_bakashot b,ctb_sug_bakasha s
					where l.bakasha_id=nvl(p_bakasha_id, l.bakasha_id)
					and l.bakasha_id=b.bakasha_id
					and b.SUG_BAKASHA=s.kod_sug_bakasha(+)
					and  to_char(b.Zman_Hatchala,'mm/yyyy')=nvl(p_chodesh,to_char(b.Zman_Hatchala,'mm/yyyy'))
					AND b.Zman_Hatchala>=v_taarich_min
					and  (l.mispar_ishi=p_mispar_ishi or p_mispar_ishi is null)
					and (b.SUG_BAKASHA=p_sug_bakasha or p_sug_bakasha is null)
					and (l.SUG_HODAA = p_Type_Message or p_Type_Message is null)
				   ORDER BY B.bakasha_id DESC;

	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END pro_get_log_bakashot;

PROCEDURE  pro_get_tahalich_klita(p_Cur OUT CurType)
IS
	 BEGIN
 	 	  OPEN p_Cur FOR
      	  	   select T.KOD_TAHALICH  CODE , T.TEUR_TAHALICH  Description
				from CTB_TAHALICH_KLITA t
				where T.PAIL=1
				order by T.TEUR_TAHALICH ASC;

	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END pro_get_tahalich_klita;

PROCEDURE pro_get_log_tahalich(p_from_date IN TB_LOG_TAHALICH.TAARICH%TYPE,
																p_to_date IN TB_LOG_TAHALICH.TAARICH%TYPE  ,
																p_process_code IN TB_LOG_TAHALICH.KOD_TAHALICH%TYPE DEFAULT NULL ,
																p_status  IN TB_LOG_TAHALICH.STATUS%TYPE DEFAULT NULL ,
																p_Cur OUT CurType)
IS
 BEGIN
	 	  OPEN p_Cur FOR
      	  	      select L.TAARICH,T.TEUR_TAHALICH,P.TEUR_PEILUT_BE_TAHALICH,S.TEUR_STATUS_BAKASHA,TK.TEUR_TAKALA,L.TEUR_TECH
					from CTB_STATUS_BAKASHA s, TB_LOG_TAHALICH l,CTB_TAHALICH_KLITA t,CTB_PEILUT_BETAHALICH p, CTB_TAKALOT tk
					where L.STATUS = S.KOD_STATUS_BAKASHA
					and L.KOD_TAHALICH=T.KOD_TAHALICH
					and L.KOD_TAHALICH = P.KOD_TAHALICH
					and L.KOD_PEILUT_TAHALICH = P.KOD_PEILUT_BE_TAHALICH
					and L.KOD_TAKALA = TK.KOD_TAKALA(+)
					and trunc(L.TAARICH) between p_from_date and p_to_date
					and (L.KOD_TAHALICH=p_process_code or  p_process_code  is null)
					and ( L.STATUS =p_status or  p_status  is null)
					order by L.TAARICH desc;

	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END pro_get_log_tahalich;

END PKG_REQUEST;
/
CREATE OR REPLACE PACKAGE PKG_sdrn AS
TYPE    CurType      IS    REF  CURSOR;
/******************************************************************************
   NAME:       PKG_sdrn
   PURPOSE:

   REVISIONS:
   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        09/03/2010             1. Created this package.
******************************************************************************/

     PROCEDURE pro_ins_yamim_4_sidurim(pDt varchar) ;
     PROCEDURE pro_ins_sidurim_4_sidurim(pDt varchar) ;
     PROCEDURE pro_ins_peilut_4_sidurim(pDt varchar) ;
         PROCEDURE pro_get_sdrm_control(pDt varchar,p_Cur OUT CurType) ;
      PROCEDURE pro_upd_sdrm_control(pDt varchar);
    PROCEDURE pro_GetStatusSdrn(pDt varchar, p_cur out CurType);
	procedure instead_of_bug(pDt varchar) ;
 	 procedure instead_of_bug2(pDt varchar) ;
	 PROCEDURE pro_GetStatus2Sdrn(pAr varchar, p_cur out CurType) ;
	  PROCEDURE pro_GetDtReRunSdrn(pDt varchar, p_cur out CurType) ;
	  PROCEDURE pro_upd_sdrnRerun_control(pDt varchar) ;
 	  PROCEDURE pro_TrailNDel_peilut_4retrSdrn(pDt varchar);
 	  PROCEDURE pro_TrailNDel_sidurim_4reSdrn(pDt varchar);
	   	PROCEDURE pro_ins_sidurim_retroSdrn(pDt varchar) ;
		procedure instead_of_bug_retro(pDt varchar) ;
		procedure instead_of_bug2_retro(pDt varchar) ;
		PROCEDURE pro_ins_peilut_retroSdrn(pDt varchar) ;

END PKG_sdrn;
/

CREATE OR REPLACE PACKAGE BODY PKG_sdrn AS
/******************************************************************************
   NAME:       PKG_BATCH
   PURPOSE:

   REVISIONS:
   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        26/04/2009             1. Created this package body.
******************************************************************************/


  PROCEDURE pro_ins_yamim_4_sidurim(pDt varchar) IS
   BEGIN
 insert into  tb_yamey_avoda_ovdim (mispar_ishi,taarich,lina,taarich_idkun_acharon,meadken_acharon)
 select   distinct driver_id,start_dt,0,sysdate,-12
from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm
where start_dt= to_date(pDt,'yyyymmdd')
 and start_schedule<2400
--and end_schedule<2400
and  not  exists(select * from tb_yamey_avoda_ovdim
where  mispar_ishi=driver_id
and  taarich=start_dt);

 insert into  tb_yamey_avoda_ovdim (mispar_ishi,taarich,lina,taarich_idkun_acharon,meadken_acharon)
 select   distinct driver_id,start_dt+1,0,sysdate,-12
from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm
where start_dt= to_date(pDt,'yyyymmdd')
 and start_schedule>2359
--and end_schedule<2400
and  not  exists(select * from tb_yamey_avoda_ovdim
where  mispar_ishi=driver_id
and  taarich=start_dt+1);
  EXCEPTION
   WHEN OTHERS THEN
        RAISE;
END pro_ins_yamim_4_sidurim;


  PROCEDURE pro_ins_sidurim_4_sidurim(pDt varchar) IS
   BEGIN
  insert into tb_sidurim_ovdim s ( mispar_ishi  , taarich  , mispar_sidur  , shat_hatchala  , shat_gmar,sector_visa,meadken_acharon   )
 select   distinct k1.driver_id,k1.start_dt,k1.schedule_num,
to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.start_schedule,4,0),1,2)||':'||substr(lpad(k1.start_schedule,4,0),3,2),'yyyymmdd hh24:mi'),
to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.end_schedule,4,0),1,2)||':'||substr(lpad(k1.end_schedule,4,0),3,2),'yyyymmdd hh24:mi'),
decode(sug_visa,' ','',sug_visa) ,-12
from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k1
where k1.start_dt=  to_date(pDt,'yyyymmdd')
and k1.start_schedule<2400
and k1.end_schedule<2400
and not exists (select *  from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k2
where k2.start_dt=  to_date(pDt,'yyyymmdd')
and k2.start_schedule<2400
and k2.end_schedule<2400
and k1.driver_id=k2.driver_id
and k1.start_dt=k2.start_dt
and k1.schedule_num=k2.schedule_num
and k1.start_schedule=k2.start_schedule
and k1.end_schedule<>k2.end_schedule);

 insert into tb_sidurim_ovdim s ( mispar_ishi  , taarich  , mispar_sidur  , shat_hatchala  , shat_gmar,sector_visa,meadken_acharon   )
 select   distinct driver_id,start_dt,schedule_num,
to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi'),
to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(end_schedule-2400,4,0),1,2)||':'||substr(lpad(end_schedule,4,0),3,2),'yyyymmdd hh24:mi'),
decode(sug_visa,' ','',sug_visa) , -12
from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm
where start_dt= to_date(pDt,'yyyymmdd')
and start_schedule<2400
and end_schedule>2359
 --and schedule_num<100000
 and  exists(select * from tb_yamey_avoda_ovdim
where  mispar_ishi=driver_id
and  taarich=start_dt)
and not exists (select * from  tb_sidurim_ovdim s2
where s2.mispar_ishi=driver_id
and  s2.taarich= start_dt
and s2.mispar_sidur =schedule_num
and  s2.shat_hatchala =to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi')
and s2.shat_gmar<start_dt+1);

 insert into tb_sidurim_ovdim s ( mispar_ishi  , taarich  , mispar_sidur  , shat_hatchala  , shat_gmar,sector_visa,
 meadken_acharon,Shayah_LeYom_Kodem   )
 select   distinct driver_id,start_dt+1,schedule_num,
to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(start_schedule-2400,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi'),
to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(end_schedule-2400,4,0),1,2)||':'||substr(lpad(end_schedule,4,0),3,2),'yyyymmdd hh24:mi'),
decode(sug_visa,' ','',sug_visa) , -12,1
from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm
where start_dt= to_date(pDt,'yyyymmdd')
and start_schedule>2359
and end_schedule>2359
 --and schedule_num<100000
 and  exists(select * from tb_yamey_avoda_ovdim
where  mispar_ishi=driver_id
and  taarich=start_dt+1);

-- insert into tb_sidurim_ovdim s ( mispar_ishi  , taarich  , mispar_sidur  , shat_hatchala  , shat_gmar,sector_visa,meadken_acharon   )
--select   distinct driver_id,start_dt,schedule_num,
----to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||(substr(lpad(start_schedule,4,0),3,2)+1),'yyyymmdd hh24:mi'),
--to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi') +1/1440,
--to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(end_schedule-2400,4,0),1,2)||':'||substr(lpad(end_schedule,4,0),3,2),'yyyymmdd hh24:mi'),
--decode(sug_visa,' ','',sug_visa) , -12
--from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm
--where start_dt= to_date(pDt,'yyyymmdd')
--and start_schedule<2400
--and end_schedule>2359
-- --and schedule_num<100000
-- and  exists(select * from tb_yamey_avoda_ovdim
--where  mispar_ishi=driver_id
--and  taarich=start_dt)
--and  exists (select * from  tb_sidurim_ovdim s2
--where s2.mispar_ishi=driver_id
--and  s2.taarich= start_dt
--and s2.mispar_sidur =schedule_num
--and  s2.shat_hatchala =to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi')
--and s2.shat_gmar<start_dt+1);

PKG_sdrn.instead_of_bug(pDt );

 insert into tb_sidurim_ovdim s ( mispar_ishi  , taarich  , mispar_sidur  , shat_hatchala  , shat_gmar,sector_visa,
 meadken_acharon,Shayah_LeYom_Kodem   )
 select   distinct driver_id,start_dt+1,schedule_num,
to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(start_schedule-2400,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi'),
to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(end_schedule,4,0),1,2)||':'||substr(lpad(end_schedule,4,0),3,2),'yyyymmdd hh24:mi'),
decode(sug_visa,' ','',sug_visa) , -12,1
from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm
where start_dt= to_date(pDt,'yyyymmdd')
and start_schedule>2359
and end_schedule<2400
 --and schedule_num<100000
 and  exists(select * from tb_yamey_avoda_ovdim
where  mispar_ishi=driver_id
and  taarich=start_dt);



 insert into trail_sidurim_ovdim s ( mispar_ishi  , taarich  , mispar_sidur  , shat_hatchala  , shat_gmar,sector_visa,meadken_acharon   )
select   distinct driver_id,start_dt,schedule_num,
to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi') ,
to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(end_schedule-2400,4,0),1,2)||':'||substr(lpad(end_schedule,4,0),3,2),'yyyymmdd hh24:mi'),
decode(sug_visa,' ','',sug_visa) ,-12
from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm
where start_dt =  to_date(pDt,'yyyymmdd')
and start_schedule<2400
and end_schedule>2359
 and  exists(select * from tb_yamey_avoda_ovdim
where  mispar_ishi=driver_id
and  taarich=start_dt)
and  exists (select * from  tb_sidurim_ovdim s2
where s2.mispar_ishi=driver_id
and  s2.taarich= start_dt
and s2.mispar_sidur =schedule_num
and  s2.shat_hatchala =to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi')
and s2.shat_gmar<start_dt+1);

-- insert into tb_sidurim_ovdim s ( mispar_ishi  , taarich  , mispar_sidur  , shat_hatchala  , shat_gmar,sector_visa,meadken_acharon   )
-- select   distinct k1.driver_id,k1.start_dt,k1.schedule_num,
--to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.start_schedule,4,0),1,2)||':'||substr(lpad(k1.start_schedule,4,0),3,2),'yyyymmdd hh24:mi'),
--to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.end_schedule,4,0),1,2)||':'||substr(lpad(k1.end_schedule,4,0),3,2),'yyyymmdd hh24:mi'),
--decode(sug_visa,' ','',sug_visa) , -12
--from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k1
--where k1.start_dt =  to_date(pDt,'yyyymmdd')
--and k1.start_schedule<2400
--and k1.end_schedule<2400
--and k1.end_schedule=(select min(k3.end_schedule) from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k3
--where k3.start_dt =  to_date(pDt,'yyyymmdd')
--and k3.start_schedule<2400
--and k3.end_schedule<2400
--and k1.driver_id=k3.driver_id
--and k1.start_dt=k3.start_dt
--and k1.schedule_num=k3.schedule_num
--and k1.start_schedule=k3.start_schedule)
--and  exists (select *  from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k2
--where k2.start_dt =  to_date(pDt,'yyyymmdd')
--and k2.start_schedule<2400
--and k2.end_schedule<2400
--and k1.driver_id=k2.driver_id
--and k1.start_dt=k2.start_dt
--and k1.schedule_num=k2.schedule_num
--and k1.start_schedule=k2.start_schedule
--and k1.end_schedule<>k2.end_schedule);

PKG_sdrn.instead_of_bug2(pDt );

-- insert into tb_sidurim_ovdim s ( mispar_ishi  , taarich  , mispar_sidur  , shat_hatchala  , shat_gmar,sector_visa,meadken_acharon   )
-- select   distinct k1.driver_id,k1.start_dt,k1.schedule_num,
--to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.start_schedule,4,0),1,2)||':'||substr(lpad(k1.start_schedule,4,0),3,2),'yyyymmdd hh24:mi') +1/1440,
--to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.end_schedule,4,0),1,2)||':'||substr(lpad(k1.end_schedule,4,0),3,2),'yyyymmdd hh24:mi'),
--decode(sug_visa,' ','',sug_visa) , -128
--from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k1
--where k1.start_dt =  to_date(pDt,'yyyymmdd')
--and k1.start_schedule<2400
--and k1.end_schedule<2400
--and k1.end_schedule=(select max(k3.end_schedule) from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k3
--where k3.start_dt =  to_date(pDt,'yyyymmdd')
--and k3.start_schedule<2400
--and k3.end_schedule<2400
--and k1.driver_id=k3.driver_id
--and k1.start_dt=k3.start_dt
--and k1.schedule_num=k3.schedule_num
--and k1.start_schedule=k3.start_schedule)
--and  exists (select *  from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k2
--where k2.start_dt =  to_date(pDt,'yyyymmdd')
--and k2.start_schedule<2400
--and k2.end_schedule<2400
--and k1.driver_id=k2.driver_id
--and k1.start_dt=k2.start_dt
--and k1.schedule_num=k2.schedule_num
--and k1.start_schedule=k2.start_schedule
--and k1.end_schedule<>k2.end_schedule);

 insert into trail_sidurim_ovdim s ( mispar_ishi  , taarich  , mispar_sidur  , shat_hatchala  , shat_gmar,sector_visa,meadken_acharon   )
 select   distinct k1.driver_id,k1.start_dt,k1.schedule_num,
to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.start_schedule,4,0),1,2)||':'||substr(lpad(k1.start_schedule,4,0),3,2),'yyyymmdd hh24:mi') ,
to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.end_schedule,4,0),1,2)||':'||substr(lpad(k1.end_schedule,4,0),3,2),'yyyymmdd hh24:mi'),
decode(sug_visa,' ','',sug_visa) ,-12
from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k1
where k1.start_dt =  to_date(pDt,'yyyymmdd')
and k1.start_schedule<2400
and k1.end_schedule<2400
and k1.end_schedule=(select max(k3.end_schedule) from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k3
where k3.start_dt =  to_date(pDt,'yyyymmdd')
and k3.start_schedule<2400
and k3.end_schedule<2400
and k1.driver_id=k3.driver_id
and k1.start_dt=k3.start_dt
and k1.schedule_num=k3.schedule_num
and k1.start_schedule=k3.start_schedule)
and  exists (select *  from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k2
where k2.start_dt =  to_date(pDt,'yyyymmdd')
and k2.start_schedule<2400
and k2.end_schedule<2400
and k1.driver_id=k2.driver_id
and k1.start_dt=k2.start_dt
and k1.schedule_num=k2.schedule_num
and k1.start_schedule=k2.start_schedule
and k1.end_schedule<>k2.end_schedule);
  EXCEPTION
   WHEN OTHERS THEN
        RAISE;
END pro_ins_sidurim_4_sidurim;


 PROCEDURE pro_ins_peilut_4_sidurim(pDt varchar) IS
   BEGIN
insert into tb_peilut_ovdim (mispar_ishi,taarich,mispar_sidur,  snif_tnua,shat_hatchala_sidur,shat_yetzia,mispar_knisa,
makat_nesia,oto_no,mispar_siduri_oto,kisuy_tor,
 Shat_Bhirat_Nesia_Netzer , Oto_No_Netzer, Mispar_Sidur_Netzer,  Shat_yetzia_Netzer,  Makat_Netzer, Shilut_Netzer ,
 Mikum_Bhirat_Nesia_Netzer ,meadken_acharon  )
 select    driver_id,start_dt,schedule_num,branch,
 to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi'),
 to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_time,4,0),1,2)||':'||substr(lpad(start_time,4,0),3,2),'yyyymmdd hh24:mi'),ride_id,
 makat_line,bus_number,bus_sequence,waiting_time,
 spm_time,spm_bus_number,spm_schedule_num,spm_start_time,spm_makat_line,spm_line_sign,spm_location,-12
from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm
where  start_dt= to_date(pDt,'yyyymmdd')
and start_schedule<2400
and start_time<2400;
-- and schedule_num<100000;

  insert into tb_peilut_ovdim (mispar_ishi,taarich,mispar_sidur,  snif_tnua,shat_hatchala_sidur,shat_yetzia,mispar_knisa,
makat_nesia,oto_no,mispar_siduri_oto,kisuy_tor,
 Shat_Bhirat_Nesia_Netzer , Oto_No_Netzer, Mispar_Sidur_Netzer,  Shat_yetzia_Netzer,  Makat_Netzer, Shilut_Netzer ,
 Mikum_Bhirat_Nesia_Netzer ,meadken_acharon  )
  select    driver_id,start_dt,schedule_num,branch,
 to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi'),
 to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(start_time-2400,4,0),1,2)||':'||substr(lpad(start_time,4,0),3,2),'yyyymmdd hh24:mi'),ride_id,
 makat_line,bus_number,bus_sequence,waiting_time,
 spm_time,spm_bus_number,spm_schedule_num,spm_start_time,spm_makat_line,spm_line_sign,spm_location,-12
from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm
where  start_dt= to_date(pDt,'yyyymmdd')
and start_schedule<2400
and start_time>2359
 --and schedule_num<100000;
 and not exists (select * from  tb_sidurim_ovdim s2
where s2.mispar_ishi=driver_id
and  s2.taarich= start_dt
and s2.mispar_sidur =schedule_num
and  s2.shat_hatchala =to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi')
and s2.shat_gmar<start_dt+1);

 insert into tb_peilut_ovdim (mispar_ishi,taarich,mispar_sidur,  snif_tnua,shat_hatchala_sidur,shat_yetzia,mispar_knisa,
makat_nesia,oto_no,mispar_siduri_oto,kisuy_tor,
Shat_Bhirat_Nesia_Netzer , Oto_No_Netzer, Mispar_Sidur_Netzer,  Shat_yetzia_Netzer,  Makat_Netzer, Shilut_Netzer ,
 Mikum_Bhirat_Nesia_Netzer ,meadken_acharon  )
  select    driver_id,start_dt+1,schedule_num,branch,
 to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(start_schedule-2400,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi'),
 to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(start_time-2400,4,0),1,2)||':'||substr(lpad(start_time,4,0),3,2),'yyyymmdd hh24:mi'),ride_id,
 makat_line,bus_number,bus_sequence,waiting_time,
 spm_time,spm_bus_number,spm_schedule_num,spm_start_time,spm_makat_line,spm_line_sign,spm_location,-12
from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm
where  start_dt= to_date(pDt,'yyyymmdd')
and start_schedule>2359
and start_time>2359;
-- and schedule_num<100000;

 insert into tb_peilut_ovdim (mispar_ishi,taarich,mispar_sidur,  snif_tnua,shat_hatchala_sidur,shat_yetzia,mispar_knisa,
makat_nesia,oto_no,mispar_siduri_oto,kisuy_tor,
 Shat_Bhirat_Nesia_Netzer , Oto_No_Netzer, Mispar_Sidur_Netzer,  Shat_yetzia_Netzer,  Makat_Netzer, Shilut_Netzer ,
 Mikum_Bhirat_Nesia_Netzer  ,meadken_acharon )
  select    driver_id,start_dt,schedule_num,branch,
 to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi')+1/1440,
 to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(start_time-2400,4,0),1,2)||':'||substr(lpad(start_time,4,0),3,2),'yyyymmdd hh24:mi'),ride_id,
 makat_line,bus_number,bus_sequence,waiting_time,
 spm_time,spm_bus_number,spm_schedule_num,spm_start_time,spm_makat_line,spm_line_sign,spm_location,-12
from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm
where  start_dt= to_date(pDt,'yyyymmdd')
and start_schedule<2400
and start_time>2359
 --and schedule_num<100000;
 and exists (select * from  tb_sidurim_ovdim s2
where s2.mispar_ishi=driver_id
and  s2.taarich= start_dt
and s2.mispar_sidur =schedule_num
and  s2.shat_hatchala =to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi')
and s2.shat_gmar<start_dt+1);

insert into tb_peilut_ovdim (mispar_ishi,taarich,mispar_sidur,  snif_tnua,shat_hatchala_sidur,shat_yetzia,mispar_knisa,
makat_nesia,oto_no,mispar_siduri_oto,kisuy_tor,
 Shat_Bhirat_Nesia_Netzer , Oto_No_Netzer, Mispar_Sidur_Netzer,  Shat_yetzia_Netzer,  Makat_Netzer, Shilut_Netzer ,
 Mikum_Bhirat_Nesia_Netzer ,meadken_acharon  )
 select    k1.driver_id,k1.start_dt,k1.schedule_num,branch,
 to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.start_schedule,4,0),1,2)||':'||substr(lpad(k1.start_schedule,4,0),3,2),'yyyymmdd hh24:mi'),
 to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.start_time,4,0),1,2)||':'||substr(lpad(k1.start_time,4,0),3,2),'yyyymmdd hh24:mi'),k1.ride_id,
 k1.makat_line,bus_number,k1.bus_sequence,k1.waiting_time,
 k1.spm_time,k1.spm_bus_number,k1.spm_schedule_num,k1.spm_start_time,k1.spm_makat_line,
 k1.spm_line_sign,k1.spm_location,-12
from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k1
where  k1.start_dt= to_date(pDt,'yyyymmdd')
and k1.start_schedule<2400
and k1.start_time<2400
 --and k1.schedule_num<100000
and k1.end_schedule=(select min(k3.end_schedule) from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k3
where k3.start_dt =  to_date(pDt,'yyyymmdd')
and k3.start_schedule<2400
and k3.end_schedule<2400
and k1.driver_id=k3.driver_id
and k1.start_dt=k3.start_dt
and k1.schedule_num=k3.schedule_num
and k1.start_schedule=k3.start_schedule)
 and exists (select *  from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k2
where k2.start_dt=  to_date(pDt,'yyyymmdd')
and k2.start_schedule<2400
and k2.end_schedule<2400
and k1.driver_id=k2.driver_id
and k1.start_dt=k2.start_dt
and k1.schedule_num=k2.schedule_num
and k1.start_schedule=k2.start_schedule
and k1.end_schedule<>k2.end_schedule)
and not exists (select * from  tb_peilut_ovdim s2
where s2.mispar_ishi= k1.driver_id
and  s2.taarich= k1.start_dt
and  s2.taarich=  to_date(pDt,'yyyymmdd')
and s2.mispar_sidur =k1.schedule_num
and  s2.shat_hatchala_sidur =to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.start_schedule,4,0),1,2)||':'||substr(lpad(k1.start_schedule,4,0),3,2),'yyyymmdd hh24:mi')
and s2.SHAT_YETZIA=to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.start_time,4,0),1,2)||':'||substr(lpad(k1.start_time,4,0),3,2),'yyyymmdd hh24:mi')
and s2.MISPAR_KNISA=k1.ride_id);

insert into tb_peilut_ovdim (mispar_ishi,taarich,mispar_sidur, snif_tnua, shat_hatchala_sidur,shat_yetzia,mispar_knisa,
makat_nesia,oto_no,mispar_siduri_oto,kisuy_tor,
 Shat_Bhirat_Nesia_Netzer , Oto_No_Netzer, Mispar_Sidur_Netzer,  Shat_yetzia_Netzer,  Makat_Netzer, Shilut_Netzer ,
 Mikum_Bhirat_Nesia_Netzer ,meadken_acharon  )
 select    k1.driver_id,k1.start_dt,k1.schedule_num,branch,
 to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.start_schedule,4,0),1,2)||':'||substr(lpad(k1.start_schedule,4,0),3,2),'yyyymmdd hh24:mi')+1/1440,
 to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.start_time,4,0),1,2)||':'||substr(lpad(k1.start_time,4,0),3,2),'yyyymmdd hh24:mi'),k1.ride_id,
 k1.makat_line,bus_number,k1.bus_sequence,k1.waiting_time,
 k1.spm_time,k1.spm_bus_number,k1.spm_schedule_num,k1.spm_start_time,k1.spm_makat_line,
 k1.spm_line_sign,k1.spm_location,-12
from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k1
where  k1.start_dt= to_date(pDt,'yyyymmdd')
and k1.start_schedule<2400
and k1.start_time<2400
 --and k1.schedule_num<100000
 and k1.end_schedule=(select max(k3.end_schedule) from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k3
where k3.start_dt =  to_date(pDt,'yyyymmdd')
and k3.start_schedule<2400
and k3.end_schedule<2400
and k1.driver_id=k3.driver_id
and k1.start_dt=k3.start_dt
and k1.schedule_num=k3.schedule_num
and k1.start_schedule=k3.start_schedule)
and exists (select *  from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k2
where k2.start_dt=  to_date(pDt,'yyyymmdd')
and k2.start_schedule<2400
and k2.end_schedule<2400
and k1.driver_id=k2.driver_id
and k1.start_dt=k2.start_dt
and k1.schedule_num=k2.schedule_num
and k1.start_schedule=k2.start_schedule
and k1.end_schedule<>k2.end_schedule);

 update tb_peilut_ovdim
 set imut_netzer=1
 where taarich= to_date(pDt,'yyyymmdd')
  and Oto_No_Netzer>0 ;
 --and (Oto_No_Netzer>0 or Mispar_Sidur_Netzer>0  );

 update tb_peilut_ovdim
set mispar_matala=mispar_sidur
 where taarich= to_date(pDt,'yyyymmdd')
 and mispar_sidur< 1000;
 update tb_peilut_ovdim
 --todo: only if exists in sidurim shaya_leyom_kodem
set mispar_matala=mispar_sidur
 where taarich= to_date(pDt,'yyyymmdd')+1
 and mispar_sidur< 1000;
 
 
 update tb_peilut_ovdim
set teur_nesia=( select    line_description
				 		   from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm
						   	where  start_dt= taarich
							and driver_id=mispar_ishi
							and schedule_num=mispar_sidur
							and to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi')=shat_hatchala_sidur
							and to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_time,4,0),1,2)||':'||substr(lpad(start_time,4,0),3,2),'yyyymmdd hh24:mi')=shat_yetzia
							and makat_line=makat_nesia
							and ride_id=mispar_knisa
							and start_schedule<2400
							and start_time<2400
							and line_description is not null
							and ride_id>0
							and makat_line<50000000)
where taarich= to_date(pDt,'yyyymmdd')
and makat_nesia<50000000
and mispar_knisa>0
and trunc(shat_hatchala_sidur)=taarich
and trunc(shat_yetzia)=taarich;
 
update tb_peilut_ovdim
set teur_nesia=( select    line_description
				 		   from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm
						   	where  start_dt= taarich
							and driver_id=mispar_ishi
							and schedule_num=mispar_sidur
							and to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi')=shat_hatchala_sidur
							 and to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(start_time-2400,4,0),1,2)||':'||substr(lpad(start_time,4,0),3,2),'yyyymmdd hh24:mi')=shat_yetzia
							and makat_line=makat_nesia
							and ride_id=mispar_knisa
							and start_schedule<2400
							and start_time>2359
							and line_description is not null
				   			and ride_id>0
							and makat_line<50000000)
where taarich= to_date(pDt,'yyyymmdd')
and makat_nesia<50000000
and mispar_knisa>0
and trunc(shat_hatchala_sidur)=taarich
and trunc(shat_yetzia)=taarich+1;
 
update tb_peilut_ovdim
set teur_nesia=( select    line_description
				 		   from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm
						   	where  start_dt= taarich
							and driver_id=mispar_ishi
							and schedule_num=mispar_sidur
							and to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(start_schedule-2400,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi')=shat_hatchala_sidur
							 and to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(start_time-2400,4,0),1,2)||':'||substr(lpad(start_time,4,0),3,2),'yyyymmdd hh24:mi')=shat_yetzia
							and makat_line=makat_nesia
							and ride_id=mispar_knisa
							and start_schedule>2359
							and start_time>2359
							and line_description is not null
				   			and ride_id>0
							and makat_line<50000000)
where taarich= to_date(pDt,'yyyymmdd')
and makat_nesia<50000000
and mispar_knisa>0
and trunc(shat_hatchala_sidur)=taarich+1
and trunc(shat_yetzia)=taarich+1;
 
update tb_peilut_ovdim
set teur_nesia=( select    line_description
				 		   from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm
						   	where  start_dt= taarich
							and driver_id=mispar_ishi
							and schedule_num=mispar_sidur
							and to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi')=shat_hatchala_sidur
							and to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_time,4,0),1,2)||':'||substr(lpad(start_time,4,0),3,2),'yyyymmdd hh24:mi')=shat_yetzia
							and makat_line=makat_nesia
							and ride_id=mispar_knisa
							and start_schedule<2400
							and start_time<2400
							and line_description is not null
							and nvl(makat_line,0)=0
							and schedule_num<1000)
where taarich= to_date(pDt,'yyyymmdd')
and nvl(makat_nesia,0)=0
and mispar_sidur<1000
and trunc(shat_hatchala_sidur)=taarich
and trunc(shat_yetzia)=taarich;
 
update tb_peilut_ovdim
set teur_nesia=( select    line_description
				 		   from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm
						   	where  start_dt= taarich
							and driver_id=mispar_ishi
							and schedule_num=mispar_sidur
							and to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi')=shat_hatchala_sidur
							 and to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(start_time-2400,4,0),1,2)||':'||substr(lpad(start_time,4,0),3,2),'yyyymmdd hh24:mi')=shat_yetzia
							and makat_line=makat_nesia
							and ride_id=mispar_knisa
							and start_schedule<2400
							and start_time>2359
							and line_description is not null
							and nvl(makat_line,0)=0
							and schedule_num<1000)
where taarich= to_date(pDt,'yyyymmdd')
and nvl(makat_nesia,0)=0
and mispar_sidur<1000
and trunc(shat_hatchala_sidur)=taarich
and trunc(shat_yetzia)=taarich+1;
 
update tb_peilut_ovdim
set teur_nesia=( select    line_description
				 		   from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm
						   	where  start_dt= taarich
							and driver_id=mispar_ishi
							and schedule_num=mispar_sidur
							and to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(start_schedule-2400,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi')=shat_hatchala_sidur
							 and to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(start_time-2400,4,0),1,2)||':'||substr(lpad(start_time,4,0),3,2),'yyyymmdd hh24:mi')=shat_yetzia
							and makat_line=makat_nesia
							and ride_id=mispar_knisa
							and start_schedule>2359
							and start_time>2359
							and line_description is not null
							and nvl(makat_line,0)=0
							and schedule_num<1000)
where taarich= to_date(pDt,'yyyymmdd')
and nvl(makat_nesia,0)=0
and mispar_sidur<1000
and trunc(shat_hatchala_sidur)=taarich+1
and trunc(shat_yetzia)=taarich+1;

update tb_peilut_ovdim
set teur_nesia=( select    line_description
				 		   from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm
						   	where  start_dt= taarich-1
							and driver_id=mispar_ishi
							and schedule_num=mispar_sidur
							and to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(start_schedule-2400,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi')=shat_hatchala_sidur
							 and to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(start_time-2400,4,0),1,2)||':'||substr(lpad(start_time,4,0),3,2),'yyyymmdd hh24:mi')=shat_yetzia
							and makat_line=makat_nesia
							and ride_id=mispar_knisa
							and start_schedule>2359
							and start_time>2359
							and line_description is not null
							and nvl(makat_line,0)=0
							and schedule_num<1000)
where taarich= to_date(pDt,'yyyymmdd')+1
and nvl(makat_nesia,0)=0
and mispar_sidur<1000
and trunc(shat_hatchala_sidur)=taarich 
and trunc(shat_yetzia)=taarich;
 
   EXCEPTION
   WHEN OTHERS THEN
        RAISE;
END pro_ins_peilut_4_sidurim;


   PROCEDURE pro_get_sdrm_control(pDt varchar,p_Cur OUT CurType) IS
  BEGIN
  OPEN p_Cur FOR
    SELECT  *
  FROM
 kds.kds_control_driver_activities@kds2sdrm;
      END pro_get_sdrm_control;


   PROCEDURE pro_upd_sdrm_control(pDt varchar) IS
     BEGIN
      update  kds.kds_control_driver_activities@kds2sdrm
     set status=9
      where status=1
      and  start_dt = to_date(pDt,'yyyymmdd') ;
        EXCEPTION
   WHEN OTHERS THEN
        RAISE;
 END pro_upd_sdrm_control;



  PROCEDURE pro_GetStatusSdrn(pDt varchar, p_cur out CurType)  IS
     BEGIN
 open p_cur for
 select status
    from   kds.kds_control_driver_activities@kds2sdrm
    where start_dt=to_date(pDt,'yyyymmdd');
 END pro_GetStatusSdrn;


 	 procedure instead_of_bug(pDt varchar) is
CURSOR Sidurim1 IS
 select   distinct driver_id,start_dt,schedule_num,
to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi') +1/1440 hatchala,
to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(end_schedule-2400,4,0),1,2)||':'||substr(lpad(end_schedule,4,0),3,2),'yyyymmdd hh24:mi') gmar,
decode(sug_visa,' ','',sug_visa) sect, -12 meadken
from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm
where start_dt= to_date(pDt,'yyyymmdd')
and start_schedule<2400
and end_schedule>2359
 --and schedule_num<100000
 and  exists(select * from tb_yamey_avoda_ovdim
where  mispar_ishi=driver_id
and  taarich=start_dt)
and  exists (select * from  tb_sidurim_ovdim s2
where s2.mispar_ishi=driver_id
and  s2.taarich= start_dt
and s2.mispar_sidur =schedule_num
and  s2.shat_hatchala =to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi')
and s2.shat_gmar<start_dt+1);

BEGIN
FOR  Sidurim1_rec IN  Sidurim1 LOOP
insert into tb_sidurim_ovdim ( mispar_ishi  , taarich  , mispar_sidur  , shat_hatchala  ,
shat_gmar,sector_visa,meadken_acharon   )
values (Sidurim1_rec.driver_id,Sidurim1_rec.start_dt,  Sidurim1_rec.schedule_num,  Sidurim1_rec.hatchala,
Sidurim1_rec.gmar,  Sidurim1_rec.sect,   Sidurim1_rec.meadken   );
END LOOP;

EXCEPTION
   WHEN OTHERS THEN
        RAISE;
end instead_of_bug;

 procedure instead_of_bug2(pDt varchar) is
CURSOR Sidurim2 IS
  select   distinct k1.driver_id,k1.start_dt,k1.schedule_num,
to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.start_schedule,4,0),1,2)||':'||substr(lpad(k1.start_schedule,4,0),3,2),'yyyymmdd hh24:mi') hatchala,
to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.end_schedule,4,0),1,2)||':'||substr(lpad(k1.end_schedule,4,0),3,2),'yyyymmdd hh24:mi') gmar,
decode(sug_visa,' ','',sug_visa) sect, -12 meadken
from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k1
where k1.start_dt =  to_date(pDt,'yyyymmdd')
and k1.start_schedule<2400
and k1.end_schedule<2400
and k1.end_schedule=(select min(k3.end_schedule) from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k3
where k3.start_dt =  to_date(pDt,'yyyymmdd')
and k3.start_schedule<2400
and k3.end_schedule<2400
and k1.driver_id=k3.driver_id
and k1.start_dt=k3.start_dt
and k1.schedule_num=k3.schedule_num
and k1.start_schedule=k3.start_schedule)
and  exists (select *  from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k2
where k2.start_dt =  to_date(pDt,'yyyymmdd')
and k2.start_schedule<2400
and k2.end_schedule<2400
and k1.driver_id=k2.driver_id
and k1.start_dt=k2.start_dt
and k1.schedule_num=k2.schedule_num
and k1.start_schedule=k2.start_schedule
and k1.end_schedule<>k2.end_schedule);

cursor Sidurim3 is
select   distinct k1.driver_id,k1.start_dt,k1.schedule_num,
to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.start_schedule,4,0),1,2)||':'||substr(lpad(k1.start_schedule,4,0),3,2),'yyyymmdd hh24:mi') +1/1440 hatchala,
to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.end_schedule,4,0),1,2)||':'||substr(lpad(k1.end_schedule,4,0),3,2),'yyyymmdd hh24:mi') gmar,
decode(sug_visa,' ','',sug_visa)sect , -12 meadken
from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k1
where k1.start_dt =  to_date(pDt,'yyyymmdd')
and k1.start_schedule<2400
and k1.end_schedule<2400
and k1.end_schedule=(select max(k3.end_schedule) from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k3
where k3.start_dt =  to_date(pDt,'yyyymmdd')
and k3.start_schedule<2400
and k3.end_schedule<2400
and k1.driver_id=k3.driver_id
and k1.start_dt=k3.start_dt
and k1.schedule_num=k3.schedule_num
and k1.start_schedule=k3.start_schedule)
and  exists (select *  from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k2
where k2.start_dt =  to_date(pDt,'yyyymmdd')
and k2.start_schedule<2400
and k2.end_schedule<2400
and k1.driver_id=k2.driver_id
and k1.start_dt=k2.start_dt
and k1.schedule_num=k2.schedule_num
and k1.start_schedule=k2.start_schedule
and k1.end_schedule<>k2.end_schedule);

BEGIN
FOR  Sidurim2_rec IN  Sidurim2 LOOP
insert into tb_sidurim_ovdim ( mispar_ishi  , taarich  , mispar_sidur  , shat_hatchala  ,
shat_gmar,sector_visa,meadken_acharon   )
values (Sidurim2_rec.driver_id,Sidurim2_rec.start_dt,  Sidurim2_rec.schedule_num,  Sidurim2_rec.hatchala,
Sidurim2_rec.gmar,  Sidurim2_rec.sect,   Sidurim2_rec.meadken   );
END LOOP;
 FOR  Sidurim3_rec IN  Sidurim3 LOOP
insert into tb_sidurim_ovdim ( mispar_ishi  , taarich  , mispar_sidur  , shat_hatchala  ,
shat_gmar,sector_visa,meadken_acharon   )
values (Sidurim3_rec.driver_id,Sidurim3_rec.start_dt,  Sidurim3_rec.schedule_num,  Sidurim3_rec.hatchala,
Sidurim3_rec.gmar,  Sidurim3_rec.sect,   Sidurim3_rec.meadken   );
END LOOP;

EXCEPTION
   WHEN OTHERS THEN
        RAISE;
end instead_of_bug2;

PROCEDURE pro_GetStatus2Sdrn( pAr varchar, p_cur out CurType)  IS
     BEGIN
 open p_cur for
 select to_char(start_dt,'yyyymmdd') start_dt
    from   kds.kds_control_driver_activities@kds2sdrm
       where start_dt>=sysdate-(select erech_param from tb_parametrim where kod_param=100)
	and status=2
	order by start_dt;
	EXCEPTION
   WHEN OTHERS THEN
        RAISE;
 END pro_GetStatus2Sdrn;
 
 PROCEDURE pro_GetDtReRunSdrn(pDt varchar, p_cur out CurType)  IS
     BEGIN
 open p_cur for
 select max(taarich),kod_peilut_tahalich
  from tb_log_tahalich
where kod_tahalich=4
and kod_peilut_tahalich>=8
and status=1
and nvl(taarich_sgira,trunc(sysdate))=to_date(pDt,'yyyymmdd')
group by kod_peilut_tahalich
order by max(taarich) desc;
	EXCEPTION
   WHEN OTHERS THEN
        RAISE;
 END pro_GetDtReRunSdrn;
 
 PROCEDURE pro_upd_sdrnRerun_control(pDt varchar) IS
     BEGIN
      update  kds.kds_control_driver_activities@kds2sdrm
     set status=9
      where status=2
      and  start_dt = to_date(pDt,'yyyymmdd') ;
        EXCEPTION
   WHEN OTHERS THEN
        RAISE;
 END pro_upd_sdrnRerun_control;
 
 
 PROCEDURE pro_TrailNDel_peilut_4retrSdrn(pDt varchar) IS
   BEGIN
insert into trail_peilut_ovdim t
(t.MISPAR_ISHI   ,  t.TAARICH  ,  t.MISPAR_sidur  ,  t.Shat_hatchala_sidur	,
  t.Shat_yetzia		,  t.Mispar_knisa		,  t.Makat_nesia	,  t.Oto_no	,  t.Mispar_siduri_oto	 ,  t.Kisuy_tor		,  t.Bitul_O_Hosafa	,  t.Kod_shinuy_premia	  ,
  t.Snif_tnua	   ,  t.Mispar_visa		,  t.Imut_netzer		,  t.Shat_Bhirat_Nesia_Netzer  ,  t.Oto_No_Netzer		,  t.Mispar_Sidur_Netzer	 ,  t.Shat_yetzia_Netzer	,
  t.Makat_Netzer		,  t.Shilut_Netzer		,  t.Mispar_matala	 ,  t.Dakot_bafoal		,  t.Km_visa 	,  t.TAARICH_IDKUN_ACHARON  ,  t.MEADKEN_ACHARON 	,
  t.MISPAR_ISHI_trail   ,  t.TAARICH_IDKUN_trail      ,  t.Sug_peula  	,  
  t.Mikum_Bhirat_Nesia_Netzer ,  t.heara			,  t.Teur_Nesia )
select distinct p.MISPAR_ISHI   ,  p.TAARICH  ,  p.MISPAR_sidur  ,  p.Shat_hatchala_sidur	,
  p.Shat_yetzia		,  p.Mispar_knisa		,  p.Makat_nesia	,  p.Oto_no	,  p.Mispar_siduri_oto	 ,  p.Kisuy_tor		,  p.Bitul_O_Hosafa	,  p.Kod_shinuy_premia	  ,
  p.Snif_tnua	   ,  p.Mispar_visa		,  p.Imut_netzer		,  p.Shat_Bhirat_Nesia_Netzer  ,  p.Oto_No_Netzer		,  p.Mispar_Sidur_Netzer	 ,  p.Shat_yetzia_Netzer	,
  p.Makat_Netzer		,  p.Shilut_Netzer		,  p.Mispar_matala	 ,  p.Dakot_bafoal		,  p.Km_visa 	,  p.TAARICH_IDKUN_ACHARON  ,  p.MEADKEN_ACHARON 	,
 77690  ,  sysdate      ,  8 	,  
  p.Mikum_Bhirat_Nesia_Netzer ,  p.heara			,  p.Teur_Nesia  
from tb_peilut_ovdim p, tb_yamey_avoda_ovdim y
where p.taarich =   to_date(pDt,'yyyymmdd')  
 and (p.mispar_sidur < 99000 or p.mispar_sidur> 99999)
 and  y.taarich =   to_date(pDt,'yyyymmdd')  
and y.taarich  = p.taarich
and y.mispar_ishi=p.mispar_ishi
and y.measher_o_mistayeg is null
and  not exists (select * from tb_sidurim_ovdim s
 	 				  	   where s.taarich =   to_date(pDt,'yyyymmdd')  
						   and s.taarich  = p.taarich
						   and s.mispar_ishi=p.mispar_ishi
						   and s.mispar_sidur=p.mispar_sidur
						   and p.shat_hatchala_sidur=s.shat_hatchala
						   and s.shayah_leyom_kodem=1)    ;
						   
 insert into trail_peilut_ovdim t
(t.MISPAR_ISHI   ,  t.TAARICH  ,  t.MISPAR_sidur  ,  t.Shat_hatchala_sidur	,
  t.Shat_yetzia		,  t.Mispar_knisa		,  t.Makat_nesia	,  t.Oto_no	,  t.Mispar_siduri_oto	 ,  t.Kisuy_tor		,  t.Bitul_O_Hosafa	,  t.Kod_shinuy_premia	  ,
  t.Snif_tnua	   ,  t.Mispar_visa		,  t.Imut_netzer		,  t.Shat_Bhirat_Nesia_Netzer  ,  t.Oto_No_Netzer		,  t.Mispar_Sidur_Netzer	 ,  t.Shat_yetzia_Netzer	,
  t.Makat_Netzer		,  t.Shilut_Netzer		,  t.Mispar_matala	 ,  t.Dakot_bafoal		,  t.Km_visa 	,  t.TAARICH_IDKUN_ACHARON  ,  t.MEADKEN_ACHARON 	,
  t.MISPAR_ISHI_trail   ,  t.TAARICH_IDKUN_trail      ,  t.Sug_peula  	,  
  t.Mikum_Bhirat_Nesia_Netzer ,  t.heara			,  t.Teur_Nesia )
select distinct p.MISPAR_ISHI   ,  p.TAARICH  ,  p.MISPAR_sidur  ,  p.Shat_hatchala_sidur	,
  p.Shat_yetzia		,  p.Mispar_knisa		,  p.Makat_nesia	,  p.Oto_no	,  p.Mispar_siduri_oto	 ,  p.Kisuy_tor		,  p.Bitul_O_Hosafa	,  p.Kod_shinuy_premia	  ,
  p.Snif_tnua	   ,  p.Mispar_visa		,  p.Imut_netzer		,  p.Shat_Bhirat_Nesia_Netzer  ,  p.Oto_No_Netzer		,  p.Mispar_Sidur_Netzer	 ,  p.Shat_yetzia_Netzer	,
  p.Makat_Netzer		,  p.Shilut_Netzer		,  p.Mispar_matala	 ,  p.Dakot_bafoal		,  p.Km_visa 	,  p.TAARICH_IDKUN_ACHARON  ,  p.MEADKEN_ACHARON 	,
 77690  ,  sysdate      ,  8 	,  
  p.Mikum_Bhirat_Nesia_Netzer ,  p.heara			,  p.Teur_Nesia  
from tb_peilut_ovdim p, tb_yamey_avoda_ovdim y
where p.taarich =   to_date(pDt,'yyyymmdd')  
 and (p.mispar_sidur < 99000 or p.mispar_sidur> 99999)
 and  y.taarich =  to_date(pDt,'yyyymmdd')    
and y.taarich  = p.taarich
and y.mispar_ishi=p.mispar_ishi
and y.measher_o_mistayeg =1
and  not exists (select * from tb_sidurim_ovdim s
 	 				  	   where s.taarich =   to_date(pDt,'yyyymmdd')    
						   and s.taarich  = p.taarich
						   and s.mispar_ishi=p.mispar_ishi
						   and s.mispar_sidur=p.mispar_sidur
						   and s.shayah_leyom_kodem=1
						   and p.shat_hatchala_sidur=s.shat_hatchala
						   and (s.mispar_sidur < 99000 or s.mispar_sidur> 99999));
						   
 insert into trail_peilut_ovdim t
(t.MISPAR_ISHI   ,  t.TAARICH  ,  t.MISPAR_sidur  ,  t.Shat_hatchala_sidur	,
  t.Shat_yetzia		,  t.Mispar_knisa		,  t.Makat_nesia	,  t.Oto_no	,  t.Mispar_siduri_oto	 ,  t.Kisuy_tor		,  t.Bitul_O_Hosafa	,  t.Kod_shinuy_premia	  ,
  t.Snif_tnua	   ,  t.Mispar_visa		,  t.Imut_netzer		,  t.Shat_Bhirat_Nesia_Netzer  ,  t.Oto_No_Netzer		,  t.Mispar_Sidur_Netzer	 ,  t.Shat_yetzia_Netzer	,
  t.Makat_Netzer		,  t.Shilut_Netzer		,  t.Mispar_matala	 ,  t.Dakot_bafoal		,  t.Km_visa 	,  t.TAARICH_IDKUN_ACHARON  ,  t.MEADKEN_ACHARON 	,
  t.MISPAR_ISHI_trail   ,  t.TAARICH_IDKUN_trail      ,  t.Sug_peula  	,  
  t.Mikum_Bhirat_Nesia_Netzer ,  t.heara			,  t.Teur_Nesia )
select distinct p.MISPAR_ISHI   ,  p.TAARICH  ,  p.MISPAR_sidur  ,  p.Shat_hatchala_sidur	,
  p.Shat_yetzia		,  p.Mispar_knisa		,  p.Makat_nesia	,  p.Oto_no	,  p.Mispar_siduri_oto	 ,  p.Kisuy_tor		,  p.Bitul_O_Hosafa	,  p.Kod_shinuy_premia	  ,
  p.Snif_tnua	   ,  p.Mispar_visa		,  p.Imut_netzer		,  p.Shat_Bhirat_Nesia_Netzer  ,  p.Oto_No_Netzer		,  p.Mispar_Sidur_Netzer	 ,  p.Shat_yetzia_Netzer	,
  p.Makat_Netzer		,  p.Shilut_Netzer		,  p.Mispar_matala	 ,  p.Dakot_bafoal		,  p.Km_visa 	,  p.TAARICH_IDKUN_ACHARON  ,  p.MEADKEN_ACHARON 	,
 77690  ,  sysdate      ,  8 	,  
  p.Mikum_Bhirat_Nesia_Netzer ,  p.heara			,  p.Teur_Nesia  
from tb_peilut_ovdim p, tb_yamey_avoda_ovdim y,tb_sidurim_ovdim s
where p.taarich =   to_date(pDt,'yyyymmdd')  +1
 and (p.mispar_sidur < 99000 or p.mispar_sidur> 99999)
 and  y.taarich =   to_date(pDt,'yyyymmdd')  +1
and y.taarich  = p.taarich
and y.mispar_ishi=p.mispar_ishi
and y.measher_o_mistayeg is null
and s.taarich =   to_date(pDt,'yyyymmdd')  +1
and s.taarich  = p.taarich
and s.mispar_ishi=p.mispar_ishi
and s.mispar_sidur=p.mispar_sidur
and p.shat_hatchala_sidur=s.shat_hatchala
and s.shayah_leyom_kodem=1;

 insert into trail_peilut_ovdim t
(t.MISPAR_ISHI   ,  t.TAARICH  ,  t.MISPAR_sidur  ,  t.Shat_hatchala_sidur	,
  t.Shat_yetzia		,  t.Mispar_knisa		,  t.Makat_nesia	,  t.Oto_no	,  t.Mispar_siduri_oto	 ,  t.Kisuy_tor		,  t.Bitul_O_Hosafa	,  t.Kod_shinuy_premia	  ,
  t.Snif_tnua	   ,  t.Mispar_visa		,  t.Imut_netzer		,  t.Shat_Bhirat_Nesia_Netzer  ,  t.Oto_No_Netzer		,  t.Mispar_Sidur_Netzer	 ,  t.Shat_yetzia_Netzer	,
  t.Makat_Netzer		,  t.Shilut_Netzer		,  t.Mispar_matala	 ,  t.Dakot_bafoal		,  t.Km_visa 	,  t.TAARICH_IDKUN_ACHARON  ,  t.MEADKEN_ACHARON 	,
  t.MISPAR_ISHI_trail   ,  t.TAARICH_IDKUN_trail      ,  t.Sug_peula  	,  
  t.Mikum_Bhirat_Nesia_Netzer ,  t.heara			,  t.Teur_Nesia )
select distinct p.MISPAR_ISHI   ,  p.TAARICH  ,  p.MISPAR_sidur  ,  p.Shat_hatchala_sidur	,
  p.Shat_yetzia		,  p.Mispar_knisa		,  p.Makat_nesia	,  p.Oto_no	,  p.Mispar_siduri_oto	 ,  p.Kisuy_tor		,  p.Bitul_O_Hosafa	,  p.Kod_shinuy_premia	  ,
  p.Snif_tnua	   ,  p.Mispar_visa		,  p.Imut_netzer		,  p.Shat_Bhirat_Nesia_Netzer  ,  p.Oto_No_Netzer		,  p.Mispar_Sidur_Netzer	 ,  p.Shat_yetzia_Netzer	,
  p.Makat_Netzer		,  p.Shilut_Netzer		,  p.Mispar_matala	 ,  p.Dakot_bafoal		,  p.Km_visa 	,  p.TAARICH_IDKUN_ACHARON  ,  p.MEADKEN_ACHARON 	,
 77690  ,  sysdate      ,  8 	,  
  p.Mikum_Bhirat_Nesia_Netzer ,  p.heara			,  p.Teur_Nesia  
from tb_peilut_ovdim p, tb_yamey_avoda_ovdim y, tb_sidurim_ovdim s
where p.taarich =   to_date(pDt,'yyyymmdd')  +1 
 and (p.mispar_sidur < 99000 or p.mispar_sidur> 99999)
 and  y.taarich =  to_date(pDt,'yyyymmdd')  +1   
and y.taarich  = p.taarich
and y.mispar_ishi=p.mispar_ishi
and y.measher_o_mistayeg =1
and  s.taarich =   to_date(pDt,'yyyymmdd')  +1   
and s.taarich  = p.taarich
and s.mispar_ishi=p.mispar_ishi
and s.mispar_sidur=p.mispar_sidur
and p.shat_hatchala_sidur=s.shat_hatchala
and s.shayah_leyom_kodem=1
and  not exists (select * from tb_sidurim_ovdim s2
 	 				  	   where s2.taarich =   to_date(pDt,'yyyymmdd')  +1    
						   and s2.taarich  = p.taarich
						   and s2.mispar_ishi=p.mispar_ishi
						   and s2.mispar_sidur=p.mispar_sidur
						    and (s2.mispar_sidur < 99000 or s2.mispar_sidur> 99999)
							and p.shat_hatchala_sidur=s2.shat_hatchala
						   and s2.shayah_leyom_kodem=1);
						   
delete from tb_peilut_ovdim p 
where p.taarich =   to_date(pDt,'yyyymmdd')  
 and (p.mispar_sidur < 99000 or p.mispar_sidur> 99999)
 and exists (select * from  tb_yamey_avoda_ovdim y
 where  y.taarich =   to_date(pDt,'yyyymmdd')  
and y.taarich  = p.taarich
and y.mispar_ishi=p.mispar_ishi
and y.measher_o_mistayeg is null)
and  not exists (select * from tb_sidurim_ovdim s
 	 				  	   where s.taarich =   to_date(pDt,'yyyymmdd')  
						   and s.taarich  = p.taarich
						   and s.mispar_ishi=p.mispar_ishi
						   and s.mispar_sidur=p.mispar_sidur
						   and p.shat_hatchala_sidur=s.shat_hatchala
						   and s.shayah_leyom_kodem=1)  ;
						   
delete from tb_peilut_ovdim p 
where p.taarich =   to_date(pDt,'yyyymmdd')  
 and (p.mispar_sidur < 99000 or p.mispar_sidur> 99999)
 and exists (select * from   tb_yamey_avoda_ovdim y
where   y.taarich =  to_date(pDt,'yyyymmdd')    
and y.taarich  = p.taarich
and y.mispar_ishi=p.mispar_ishi
and y.measher_o_mistayeg =1)
and  not exists (select * from tb_sidurim_ovdim s
 	 				  	   where s.taarich =   to_date(pDt,'yyyymmdd')    
						   and s.taarich  = p.taarich
						   and s.mispar_ishi=p.mispar_ishi
						   and s.mispar_sidur=p.mispar_sidur
						   and s.shayah_leyom_kodem=1
						   and p.shat_hatchala_sidur=s.shat_hatchala
						   and (s.mispar_sidur < 99000 or s.mispar_sidur> 99999));
						   
delete from tb_peilut_ovdim p 
where p.taarich =   to_date(pDt,'yyyymmdd')  +1
 and (p.mispar_sidur < 99000 or p.mispar_sidur> 99999)
 and exists (select * from  tb_yamey_avoda_ovdim y  
where   y.taarich =   to_date(pDt,'yyyymmdd')  +1
and y.taarich  = p.taarich
and y.mispar_ishi=p.mispar_ishi
and y.measher_o_mistayeg is null)
and exists (select * from tb_sidurim_ovdim s
where  s.taarich =   to_date(pDt,'yyyymmdd')  +1
and s.taarich  = p.taarich
and s.mispar_ishi=p.mispar_ishi
and s.mispar_sidur=p.mispar_sidur
and p.shat_hatchala_sidur=s.shat_hatchala
and s.shayah_leyom_kodem=1);

delete from tb_peilut_ovdim p
where p.taarich =   to_date(pDt,'yyyymmdd')  +1 
 and (p.mispar_sidur < 99000 or p.mispar_sidur> 99999)
 and exists (select * from tb_yamey_avoda_ovdim y 
where  y.taarich =  to_date(pDt,'yyyymmdd')  +1   
and y.taarich  = p.taarich
and y.mispar_ishi=p.mispar_ishi
and y.measher_o_mistayeg =1)
and exists (select * from  tb_sidurim_ovdim s
where   s.taarich =   to_date(pDt,'yyyymmdd')  +1   
and s.taarich  = p.taarich
and s.mispar_ishi=p.mispar_ishi
and s.mispar_sidur=p.mispar_sidur
and p.shat_hatchala_sidur=s.shat_hatchala
and s.shayah_leyom_kodem=1)
and  not exists (select * from tb_sidurim_ovdim s2
 	 				  	   where s2.taarich =   to_date(pDt,'yyyymmdd')  +1    
						   and s2.taarich  = p.taarich
						   and s2.mispar_ishi=p.mispar_ishi
						   and s2.mispar_sidur=p.mispar_sidur
						    and (s2.mispar_sidur < 99000 or s2.mispar_sidur> 99999)
							and p.shat_hatchala_sidur=s2.shat_hatchala
						   and s2.shayah_leyom_kodem=1);
						   
        EXCEPTION
   WHEN OTHERS THEN
        RAISE;
		END  pro_TrailNDel_peilut_4retrSdrn;

		
	PROCEDURE pro_TrailNDel_sidurim_4reSdrn(pDt varchar) IS
   BEGIN
   	 insert into trail_sidurim_ovdim t
 ( MISPAR_ISHI  ,  MISPAR_sidur    ,  TAARICH ,  Shat_hatchala		,  
 Shat_gmar		,  Shat_hatchala_letashlum ,  Shat_gmar_letashlum	,  Pitzul_hafsaka	,  Chariga	,  Tosefet_Grira	,  Hashlama,  sug_hashlama 		,
  Yom_Visa		,  Lo_letashlum	,  Out_michsa	,  Mikum_shaon_knisa	 ,  Mikum_shaon_yetzia	,  Achuz_Knas_LePremyat_Visa	,  Achuz_Viza_Besikun	,
  Mispar_Musach_O_Machsan	,  Kod_siba_lo_letashlum		,  Kod_siba_ledivuch_yadani_in	,  Kod_siba_ledivuch_yadani_out	,  Menahel_Musach_Meadken	,
  Shayah_LeYom_Kodem 	,  Mispar_shiurey_nehiga	,  Mezake_Halbasha 	,  Mezake_nesiot		,  Sug_Hazmanat_Visa ,  Bitul_O_Hosafa	,
  tafkid_visa 		,  mivtza_visa 		,  Nidreshet_hitiatzvut 		,  Shat_hitiatzvut	,  Ptor_Mehitiatzvut 	,  Hachtama_Beatar_Lo_Takin  ,  Hafhatat_Nochechut_Visa	,
  Sector_Visa 		,  MEADKEN_ACHARON 	 ,  TAARICH_IDKUN_ACHARON   ,  MISPAR_ISHI_trail     ,  TAARICH_IDKUN_trail   , Sug_peula , heara		 )
select distinct p.MISPAR_ISHI  ,  MISPAR_sidur    ,  p.TAARICH ,  p.Shat_hatchala		,  
  Shat_gmar		,  Shat_hatchala_letashlum ,  Shat_gmar_letashlum	,  Pitzul_hafsaka	,  Chariga	,  Tosefet_Grira	,  Hashlama,  sug_hashlama 		,
  Yom_Visa		,  Lo_letashlum	,  Out_michsa	,  Mikum_shaon_knisa	 ,  Mikum_shaon_yetzia	,  Achuz_Knas_LePremyat_Visa	,  Achuz_Viza_Besikun	,
  Mispar_Musach_O_Machsan	,  Kod_siba_lo_letashlum		,  Kod_siba_ledivuch_yadani_in	,  Kod_siba_ledivuch_yadani_out	,  Menahel_Musach_Meadken	,
  Shayah_LeYom_Kodem 	,  Mispar_shiurey_nehiga	,  Mezake_Halbasha 	,  Mezake_nesiot		,    Sug_Hazmanat_Visa ,  Bitul_O_Hosafa	,
  tafkid_visa 		,  mivtza_visa 		,  Nidreshet_hitiatzvut 		,  Shat_hitiatzvut	,  Ptor_Mehitiatzvut 	,  Hachtama_Beatar_Lo_Takin  ,  Hafhatat_Nochechut_Visa	,
  Sector_Visa 		,  p.MEADKEN_ACHARON 	 ,  p.TAARICH_IDKUN_ACHARON  ,   77690  ,  sysdate  ,8    ,  p.heara
from tb_sidurim_ovdim p, tb_yamey_avoda_ovdim y
where p.taarich =   to_date(pDt,'yyyymmdd')  
 and (p.mispar_sidur < 99000 or p.mispar_sidur> 99999)
 and  y.taarich =   to_date(pDt,'yyyymmdd')  
and y.taarich  = p.taarich
and y.mispar_ishi=p.mispar_ishi
and y.measher_o_mistayeg is null
and nvl(p.shayah_leyom_kodem,0)=0 ;

  	 insert into trail_sidurim_ovdim t
 ( MISPAR_ISHI  ,  MISPAR_sidur    ,  TAARICH ,  Shat_hatchala		,  
 Shat_gmar		,  Shat_hatchala_letashlum ,  Shat_gmar_letashlum	,  Pitzul_hafsaka	,  Chariga	,  Tosefet_Grira	,  Hashlama,  sug_hashlama 		,
  Yom_Visa		,  Lo_letashlum	,  Out_michsa	,  Mikum_shaon_knisa	 ,  Mikum_shaon_yetzia	,  Achuz_Knas_LePremyat_Visa	,  Achuz_Viza_Besikun	,
  Mispar_Musach_O_Machsan	,  Kod_siba_lo_letashlum		,  Kod_siba_ledivuch_yadani_in	,  Kod_siba_ledivuch_yadani_out	,  Menahel_Musach_Meadken	,
  Shayah_LeYom_Kodem 	,  Mispar_shiurey_nehiga	,  Mezake_Halbasha 	,  Mezake_nesiot		,  Sug_Hazmanat_Visa ,  Bitul_O_Hosafa	,
  tafkid_visa 		,  mivtza_visa 		,  Nidreshet_hitiatzvut 		,  Shat_hitiatzvut	,  Ptor_Mehitiatzvut 	,  Hachtama_Beatar_Lo_Takin  ,  Hafhatat_Nochechut_Visa	,
  Sector_Visa 		,  MEADKEN_ACHARON 	 ,  TAARICH_IDKUN_ACHARON   ,  MISPAR_ISHI_trail     ,  TAARICH_IDKUN_trail   , Sug_peula , heara		 )
select distinct p.MISPAR_ISHI  ,  MISPAR_sidur    ,  p.TAARICH ,  p.Shat_hatchala		,  
  Shat_gmar		,  Shat_hatchala_letashlum ,  Shat_gmar_letashlum	,  Pitzul_hafsaka	,  Chariga	,  Tosefet_Grira	,  Hashlama,  sug_hashlama 		,
  Yom_Visa		,  Lo_letashlum	,  Out_michsa	,  Mikum_shaon_knisa	 ,  Mikum_shaon_yetzia	,  Achuz_Knas_LePremyat_Visa	,  Achuz_Viza_Besikun	,
  Mispar_Musach_O_Machsan	,  Kod_siba_lo_letashlum		,  Kod_siba_ledivuch_yadani_in	,  Kod_siba_ledivuch_yadani_out	,  Menahel_Musach_Meadken	,
  Shayah_LeYom_Kodem 	,  Mispar_shiurey_nehiga	,  Mezake_Halbasha 	,  Mezake_nesiot		,    Sug_Hazmanat_Visa ,  Bitul_O_Hosafa	,
  tafkid_visa 		,  mivtza_visa 		,  Nidreshet_hitiatzvut 		,  Shat_hitiatzvut	,  Ptor_Mehitiatzvut 	,  Hachtama_Beatar_Lo_Takin  ,  Hafhatat_Nochechut_Visa	,
  Sector_Visa 		,  p.MEADKEN_ACHARON 	 ,  p.TAARICH_IDKUN_ACHARON  ,   77690  ,  sysdate  ,8    ,  p.heara
from tb_sidurim_ovdim p, tb_yamey_avoda_ovdim y
where p.taarich =   to_date(pDt,'yyyymmdd')  
 and (p.mispar_sidur < 99000 or p.mispar_sidur> 99999)
 and  y.taarich =  to_date(pDt,'yyyymmdd')    
and y.taarich  = p.taarich
and y.mispar_ishi=p.mispar_ishi
and y.measher_o_mistayeg =1
and   nvl(p.shayah_leyom_kodem,0)=0
and  not exists (select * from tb_sidurim_ovdim s2
 	 				  	   where s2.taarich =   to_date(pDt,'yyyymmdd')    
						   and s2.taarich  = p.taarich
						   and s2.mispar_ishi=p.mispar_ishi
						   and s2.mispar_sidur=p.mispar_sidur
						    and (s2.mispar_sidur < 99000 or s2.mispar_sidur> 99999)
						   and nvl(s2.shayah_leyom_kodem,0)=0);

  	 insert into trail_sidurim_ovdim t
 ( MISPAR_ISHI  ,  MISPAR_sidur    ,  TAARICH ,  Shat_hatchala		,  
 Shat_gmar		,  Shat_hatchala_letashlum ,  Shat_gmar_letashlum	,  Pitzul_hafsaka	,  Chariga	,  Tosefet_Grira	,  Hashlama,  sug_hashlama 		,
  Yom_Visa		,  Lo_letashlum	,  Out_michsa	,  Mikum_shaon_knisa	 ,  Mikum_shaon_yetzia	,  Achuz_Knas_LePremyat_Visa	,  Achuz_Viza_Besikun	,
  Mispar_Musach_O_Machsan	,  Kod_siba_lo_letashlum		,  Kod_siba_ledivuch_yadani_in	,  Kod_siba_ledivuch_yadani_out	,  Menahel_Musach_Meadken	,
  Shayah_LeYom_Kodem 	,  Mispar_shiurey_nehiga	,  Mezake_Halbasha 	,  Mezake_nesiot		,  Sug_Hazmanat_Visa ,  Bitul_O_Hosafa	,
  tafkid_visa 		,  mivtza_visa 		,  Nidreshet_hitiatzvut 		,  Shat_hitiatzvut	,  Ptor_Mehitiatzvut 	,  Hachtama_Beatar_Lo_Takin  ,  Hafhatat_Nochechut_Visa	,
  Sector_Visa 		,  MEADKEN_ACHARON 	 ,  TAARICH_IDKUN_ACHARON   ,  MISPAR_ISHI_trail     ,  TAARICH_IDKUN_trail   , Sug_peula , heara		 )
select distinct p.MISPAR_ISHI  ,  MISPAR_sidur    ,  p.TAARICH ,  p.Shat_hatchala		,  
  Shat_gmar		,  Shat_hatchala_letashlum ,  Shat_gmar_letashlum	,  Pitzul_hafsaka	,  Chariga	,  Tosefet_Grira	,  Hashlama,  sug_hashlama 		,
  Yom_Visa		,  Lo_letashlum	,  Out_michsa	,  Mikum_shaon_knisa	 ,  Mikum_shaon_yetzia	,  Achuz_Knas_LePremyat_Visa	,  Achuz_Viza_Besikun	,
  Mispar_Musach_O_Machsan	,  Kod_siba_lo_letashlum		,  Kod_siba_ledivuch_yadani_in	,  Kod_siba_ledivuch_yadani_out	,  Menahel_Musach_Meadken	,
  Shayah_LeYom_Kodem 	,  Mispar_shiurey_nehiga	,  Mezake_Halbasha 	,  Mezake_nesiot		,    Sug_Hazmanat_Visa ,  Bitul_O_Hosafa	,
  tafkid_visa 		,  mivtza_visa 		,  Nidreshet_hitiatzvut 		,  Shat_hitiatzvut	,  Ptor_Mehitiatzvut 	,  Hachtama_Beatar_Lo_Takin  ,  Hafhatat_Nochechut_Visa	,
  Sector_Visa 		,  p.MEADKEN_ACHARON 	 ,  p.TAARICH_IDKUN_ACHARON  ,   77690  ,  sysdate  ,8    ,  p.heara
from tb_sidurim_ovdim p, tb_yamey_avoda_ovdim y
where p.taarich =   to_date(pDt,'yyyymmdd')  +1
 and (p.mispar_sidur < 99000 or p.mispar_sidur> 99999)
 and  y.taarich =   to_date(pDt,'yyyymmdd') +1 
and y.taarich  = p.taarich
and y.mispar_ishi=p.mispar_ishi
and y.measher_o_mistayeg is null
and p.shayah_leyom_kodem=1 ;

  	 insert into trail_sidurim_ovdim t
 ( MISPAR_ISHI  ,  MISPAR_sidur    ,  TAARICH ,  Shat_hatchala		,  
 Shat_gmar		,  Shat_hatchala_letashlum ,  Shat_gmar_letashlum	,  Pitzul_hafsaka	,  Chariga	,  Tosefet_Grira	,  Hashlama,  sug_hashlama 		,
  Yom_Visa		,  Lo_letashlum	,  Out_michsa	,  Mikum_shaon_knisa	 ,  Mikum_shaon_yetzia	,  Achuz_Knas_LePremyat_Visa	,  Achuz_Viza_Besikun	,
  Mispar_Musach_O_Machsan	,  Kod_siba_lo_letashlum		,  Kod_siba_ledivuch_yadani_in	,  Kod_siba_ledivuch_yadani_out	,  Menahel_Musach_Meadken	,
  Shayah_LeYom_Kodem 	,  Mispar_shiurey_nehiga	,  Mezake_Halbasha 	,  Mezake_nesiot		,  Sug_Hazmanat_Visa ,  Bitul_O_Hosafa	,
  tafkid_visa 		,  mivtza_visa 		,  Nidreshet_hitiatzvut 		,  Shat_hitiatzvut	,  Ptor_Mehitiatzvut 	,  Hachtama_Beatar_Lo_Takin  ,  Hafhatat_Nochechut_Visa	,
  Sector_Visa 		,  MEADKEN_ACHARON 	 ,  TAARICH_IDKUN_ACHARON   ,  MISPAR_ISHI_trail     ,  TAARICH_IDKUN_trail   , Sug_peula , heara		 )
select distinct p.MISPAR_ISHI  ,  MISPAR_sidur    ,  p.TAARICH ,  p.Shat_hatchala		,  
  Shat_gmar		,  Shat_hatchala_letashlum ,  Shat_gmar_letashlum	,  Pitzul_hafsaka	,  Chariga	,  Tosefet_Grira	,  Hashlama,  sug_hashlama 		,
  Yom_Visa		,  Lo_letashlum	,  Out_michsa	,  Mikum_shaon_knisa	 ,  Mikum_shaon_yetzia	,  Achuz_Knas_LePremyat_Visa	,  Achuz_Viza_Besikun	,
  Mispar_Musach_O_Machsan	,  Kod_siba_lo_letashlum		,  Kod_siba_ledivuch_yadani_in	,  Kod_siba_ledivuch_yadani_out	,  Menahel_Musach_Meadken	,
  Shayah_LeYom_Kodem 	,  Mispar_shiurey_nehiga	,  Mezake_Halbasha 	,  Mezake_nesiot		,    Sug_Hazmanat_Visa ,  Bitul_O_Hosafa	,
  tafkid_visa 		,  mivtza_visa 		,  Nidreshet_hitiatzvut 		,  Shat_hitiatzvut	,  Ptor_Mehitiatzvut 	,  Hachtama_Beatar_Lo_Takin  ,  Hafhatat_Nochechut_Visa	,
  Sector_Visa 		,  p.MEADKEN_ACHARON 	 ,  p.TAARICH_IDKUN_ACHARON  ,   77690  ,  sysdate  ,8    ,  p.heara
from tb_sidurim_ovdim p, tb_yamey_avoda_ovdim y
where p.taarich =   to_date(pDt,'yyyymmdd')  +1
 and (p.mispar_sidur < 99000 or p.mispar_sidur> 99999)
 and  y.taarich =  to_date(pDt,'yyyymmdd')    +1
and y.taarich  = p.taarich
and y.mispar_ishi=p.mispar_ishi
and y.measher_o_mistayeg =1
and    p.shayah_leyom_kodem=1
and  not exists (select * from tb_sidurim_ovdim s2
 	 				  	   where s2.taarich =   to_date(pDt,'yyyymmdd')    +1
						   and s2.taarich  = p.taarich
						   and s2.mispar_ishi=p.mispar_ishi
						   and s2.mispar_sidur=p.mispar_sidur
						    and (s2.mispar_sidur < 99000 or s2.mispar_sidur> 99999)
						   and s2.shayah_leyom_kodem=1);
						   
delete from  tb_sidurim_ovdim p 
where p.taarich =   to_date(pDt,'yyyymmdd')  
 and (p.mispar_sidur < 99000 or p.mispar_sidur> 99999)
 and nvl(p.shayah_leyom_kodem,0)=0
 and  exists (select * from  tb_yamey_avoda_ovdim y
 where y.taarich =   to_date(pDt,'yyyymmdd')  
and y.taarich  = p.taarich
and y.mispar_ishi=p.mispar_ishi
and y.measher_o_mistayeg is null );

 delete  from tb_sidurim_ovdim p 
where p.taarich =   to_date(pDt,'yyyymmdd')  
 and (p.mispar_sidur < 99000 or p.mispar_sidur> 99999)
 and   nvl(p.shayah_leyom_kodem,0)=0
 and  exists (select * from  tb_yamey_avoda_ovdim y
 where y.taarich =  to_date(pDt,'yyyymmdd')    
and y.taarich  = p.taarich
and y.mispar_ishi=p.mispar_ishi
and y.measher_o_mistayeg =1)
and  not exists (select * from tb_sidurim_ovdim s2
 	 				  	   where s2.taarich =   to_date(pDt,'yyyymmdd')    
						   and s2.taarich  = p.taarich
						   and s2.mispar_ishi=p.mispar_ishi
						   and s2.mispar_sidur=p.mispar_sidur
						    and (s2.mispar_sidur < 99000 or s2.mispar_sidur> 99999)
						   and nvl(s2.shayah_leyom_kodem,0)=0);
						   
delete  from tb_sidurim_ovdim p 
where p.taarich =   to_date(pDt,'yyyymmdd')  +1
 and (p.mispar_sidur < 99000 or p.mispar_sidur> 99999)
 and p.shayah_leyom_kodem=1
 and  exists (select * from  tb_yamey_avoda_ovdim y
 where y.taarich =   to_date(pDt,'yyyymmdd') +1 
and y.taarich  = p.taarich
and y.mispar_ishi=p.mispar_ishi
and y.measher_o_mistayeg is null );

delete from tb_sidurim_ovdim p 
where p.taarich =   to_date(pDt,'yyyymmdd')  +1
 and (p.mispar_sidur < 99000 or p.mispar_sidur> 99999)
 and    p.shayah_leyom_kodem=1
 and  exists (select * from  tb_yamey_avoda_ovdim y
 where  y.taarich =  to_date(pDt,'yyyymmdd')    +1
and y.taarich  = p.taarich
and y.mispar_ishi=p.mispar_ishi
and y.measher_o_mistayeg =1)
and  not exists (select * from tb_sidurim_ovdim s2
 	 				  	   where s2.taarich =   to_date(pDt,'yyyymmdd')    +1
						   and s2.taarich  = p.taarich
						   and s2.mispar_ishi=p.mispar_ishi
						   and s2.mispar_sidur=p.mispar_sidur
						    and (s2.mispar_sidur < 99000 or s2.mispar_sidur> 99999)
						   and s2.shayah_leyom_kodem=1);
						   				   
        EXCEPTION
   WHEN OTHERS THEN
        RAISE;
		END  pro_TrailNDel_sidurim_4reSdrn;   
		
	PROCEDURE pro_ins_sidurim_retroSdrn(pDt varchar) IS
   BEGIN
 		 insert into tb_sidurim_ovdim s ( mispar_ishi  , taarich  , mispar_sidur  , shat_hatchala  , shat_gmar,sector_visa,meadken_acharon   )
 select   distinct k1.driver_id,k1.start_dt,k1.schedule_num,
to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.start_schedule,4,0),1,2)||':'||substr(lpad(k1.start_schedule,4,0),3,2),'yyyymmdd hh24:mi'),
to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.end_schedule,4,0),1,2)||':'||substr(lpad(k1.end_schedule,4,0),3,2),'yyyymmdd hh24:mi'),
decode(sug_visa,' ','',sug_visa) ,-12
from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k1
where k1.start_dt=  to_date(pDt,'yyyymmdd')
and k1.start_schedule<2400
and k1.end_schedule<2400
and not exists (select *  from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k2
where k2.start_dt=  to_date(pDt,'yyyymmdd')
and k2.start_schedule<2400
and k2.end_schedule<2400
and k1.driver_id=k2.driver_id
and k1.start_dt=k2.start_dt
and k1.schedule_num=k2.schedule_num
and k1.start_schedule=k2.start_schedule
and k1.end_schedule<>k2.end_schedule)
and not exists (select * from tb_sidurim_ovdim s2
where   s2.taarich = to_date(pDt,'yyyymmdd')
and s2.taarich =  k1.start_dt
and  s2.mispar_ishi =k1.driver_id
and  s2.mispar_sidur =k1.schedule_num
and  s2.shat_hatchala =  to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.start_schedule,4,0),1,2)||':'||substr(lpad(k1.start_schedule,4,0),3,2),'yyyymmdd hh24:mi'));

insert into tb_sidurim_ovdim s ( mispar_ishi  , taarich  , mispar_sidur  , shat_hatchala  , shat_gmar,sector_visa,meadken_acharon   )
 select   distinct driver_id,start_dt,schedule_num,
to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi'),
to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(end_schedule-2400,4,0),1,2)||':'||substr(lpad(end_schedule,4,0),3,2),'yyyymmdd hh24:mi'),
decode(sug_visa,' ','',sug_visa) , -12
from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm
where start_dt= to_date(pDt,'yyyymmdd')
and start_schedule<2400
and end_schedule>2359
 --and schedule_num<100000
 and  exists(select * from tb_yamey_avoda_ovdim
where  mispar_ishi=driver_id
and  taarich=start_dt)
and not exists (select * from  tb_sidurim_ovdim s2
where s2.mispar_ishi=driver_id
and  s2.taarich= start_dt
and s2.mispar_sidur =schedule_num
and  s2.shat_hatchala =to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi')
and s2.shat_gmar<start_dt+1);

insert into tb_sidurim_ovdim s ( mispar_ishi  , taarich  , mispar_sidur  , shat_hatchala  , shat_gmar,sector_visa,
 meadken_acharon,Shayah_LeYom_Kodem   )
 select   distinct driver_id,start_dt+1,schedule_num,
to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(start_schedule-2400,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi'),
to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(end_schedule-2400,4,0),1,2)||':'||substr(lpad(end_schedule,4,0),3,2),'yyyymmdd hh24:mi'),
decode(sug_visa,' ','',sug_visa) , -12,1
from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k1
where start_dt= to_date(pDt,'yyyymmdd')
and start_schedule>2359
and end_schedule>2359
 --and schedule_num<100000
 and  exists(select * from tb_yamey_avoda_ovdim
where  mispar_ishi=driver_id
and  taarich=start_dt+1)
and not exists (select * from tb_sidurim_ovdim s2
where   s2.taarich = to_date(pDt,'yyyymmdd')+1
and s2.taarich =  k1.start_dt
and  s2.mispar_ishi =k1.driver_id
and  s2.mispar_sidur =k1.schedule_num
and  s2.shat_hatchala =  to_date(to_char(k1.start_dt+1,'yyyymmdd')||' '||substr(lpad(k1.start_schedule-2400,4,0),1,2)||':'||substr(lpad(k1.start_schedule,4,0),3,2),'yyyymmdd hh24:mi'));

PKG_sdrn.instead_of_bug_retro(pDt );

 insert into tb_sidurim_ovdim s ( mispar_ishi  , taarich  , mispar_sidur  , shat_hatchala  , shat_gmar,sector_visa,
 meadken_acharon,Shayah_LeYom_Kodem   )
 select   distinct driver_id,start_dt+1,schedule_num,
to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(start_schedule-2400,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi'),
to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(end_schedule,4,0),1,2)||':'||substr(lpad(end_schedule,4,0),3,2),'yyyymmdd hh24:mi'),
decode(sug_visa,' ','',sug_visa) , -12,1
from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k1
where start_dt= to_date(pDt,'yyyymmdd')
and start_schedule>2359
and end_schedule<2400
 --and schedule_num<100000
 and  exists(select * from tb_yamey_avoda_ovdim
where  mispar_ishi=driver_id
and  taarich=start_dt)
and not exists (select * from tb_sidurim_ovdim s2
where   s2.taarich = to_date(pDt,'yyyymmdd')
and s2.taarich =  k1.start_dt
and  s2.mispar_ishi =k1.driver_id
and  s2.mispar_sidur =k1.schedule_num
and  s2.shat_hatchala =  to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.start_schedule,4,0),1,2)||':'||substr(lpad(k1.start_schedule,4,0),3,2),'yyyymmdd hh24:mi'));

insert into trail_sidurim_ovdim s ( mispar_ishi  , taarich  , mispar_sidur  , shat_hatchala  , shat_gmar,sector_visa,meadken_acharon   )
select   distinct driver_id,start_dt,schedule_num,
to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi') ,
to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(end_schedule-2400,4,0),1,2)||':'||substr(lpad(end_schedule,4,0),3,2),'yyyymmdd hh24:mi'),
decode(sug_visa,' ','',sug_visa) ,-12
from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm
where start_dt =  to_date(pDt,'yyyymmdd')
and start_schedule<2400
and end_schedule>2359
 and  exists(select * from tb_yamey_avoda_ovdim
where  mispar_ishi=driver_id
and  taarich=start_dt)
and  exists (select * from  tb_sidurim_ovdim s2
where s2.mispar_ishi=driver_id
and  s2.taarich= start_dt
and s2.mispar_sidur =schedule_num
and  s2.shat_hatchala =to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi')
and s2.shat_gmar<start_dt+1);

 insert into trail_sidurim_ovdim s ( mispar_ishi  , taarich  , mispar_sidur  , shat_hatchala  , shat_gmar,sector_visa,meadken_acharon   )
 select   distinct k1.driver_id,k1.start_dt,k1.schedule_num,
to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.start_schedule,4,0),1,2)||':'||substr(lpad(k1.start_schedule,4,0),3,2),'yyyymmdd hh24:mi') ,
to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.end_schedule,4,0),1,2)||':'||substr(lpad(k1.end_schedule,4,0),3,2),'yyyymmdd hh24:mi'),
decode(sug_visa,' ','',sug_visa) ,-12
from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k1
where k1.start_dt =  to_date(pDt,'yyyymmdd')
and k1.start_schedule<2400
and k1.end_schedule<2400
and k1.end_schedule=(select max(k3.end_schedule) from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k3
where k3.start_dt =  to_date(pDt,'yyyymmdd')
and k3.start_schedule<2400
and k3.end_schedule<2400
and k1.driver_id=k3.driver_id
and k1.start_dt=k3.start_dt
and k1.schedule_num=k3.schedule_num
and k1.start_schedule=k3.start_schedule)
and  exists (select *  from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k2
where k2.start_dt =  to_date(pDt,'yyyymmdd')
and k2.start_schedule<2400
and k2.end_schedule<2400
and k1.driver_id=k2.driver_id
and k1.start_dt=k2.start_dt
and k1.schedule_num=k2.schedule_num
and k1.start_schedule=k2.start_schedule
and k1.end_schedule<>k2.end_schedule)
and not exists (select * from tb_sidurim_ovdim s2
where   s2.taarich = to_date(pDt,'yyyymmdd')
and s2.taarich =  k1.start_dt
and  s2.mispar_ishi =k1.driver_id
and  s2.mispar_sidur =k1.schedule_num
and  s2.shat_hatchala =  to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.start_schedule,4,0),1,2)||':'||substr(lpad(k1.start_schedule,4,0),3,2),'yyyymmdd hh24:mi'));
					   				   
        EXCEPTION
   WHEN OTHERS THEN
        RAISE;
		END  pro_ins_sidurim_retroSdrn;   
	
			 procedure instead_of_bug_retro(pDt varchar) is
CURSOR Sidurim1 IS
 select   distinct driver_id,start_dt,schedule_num,
to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi') +1/1440 hatchala,
to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(end_schedule-2400,4,0),1,2)||':'||substr(lpad(end_schedule,4,0),3,2),'yyyymmdd hh24:mi') gmar,
decode(sug_visa,' ','',sug_visa) sect, -12 meadken
from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k1
where start_dt= to_date(pDt,'yyyymmdd')
and start_schedule<2400
and end_schedule>2359
 --and schedule_num<100000
 and  exists(select * from tb_yamey_avoda_ovdim
where  mispar_ishi=driver_id
and  taarich=start_dt
and measher_o_mistayeg is null)
and  exists (select * from  tb_sidurim_ovdim s2
where s2.mispar_ishi=driver_id
and  s2.taarich= start_dt
and s2.mispar_sidur =schedule_num
and  s2.shat_hatchala =to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi')
and s2.shat_gmar<start_dt+1)
and  not exists (select * from  tb_sidurim_ovdim s3
where s3.mispar_ishi=driver_id
and  s3.taarich= start_dt
and s3.mispar_sidur =schedule_num
and  s3.shat_hatchala =to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi')+1/1440  
and s3.shat_gmar<start_dt+1)
union all
select   distinct driver_id,start_dt,schedule_num,
to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi') +1/1440 hatchala,
to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(end_schedule-2400,4,0),1,2)||':'||substr(lpad(end_schedule,4,0),3,2),'yyyymmdd hh24:mi') gmar,
decode(sug_visa,' ','',sug_visa) sect, -12 meadken
from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k1
where start_dt= to_date(pDt,'yyyymmdd')
and start_schedule<2400
and end_schedule>2359
 --and schedule_num<100000
 and  exists(select * from tb_yamey_avoda_ovdim
where  mispar_ishi=driver_id
and  taarich=start_dt
and measher_o_mistayeg=1)
and  exists (select * from  tb_sidurim_ovdim s2
where s2.mispar_ishi=driver_id
and  s2.taarich= start_dt
and s2.mispar_sidur =schedule_num
and  s2.shat_hatchala =to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi')
and s2.shat_gmar<start_dt+1)
and  not exists (select * from  tb_sidurim_ovdim s3
where s3.mispar_ishi=driver_id
and  s3.taarich= start_dt
and s3.mispar_sidur =schedule_num
and  s3.shat_hatchala =to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi')+1/1440  
and s3.shat_gmar<start_dt+1)
and  not exists (select * from  tb_sidurim_ovdim s4
where s4.mispar_ishi=driver_id
and  s4.taarich= start_dt
and s4.mispar_sidur =schedule_num
and   nvl(s4.shayah_leyom_kodem,0)=0
and (s4.mispar_sidur < 99000 or s4.mispar_sidur> 99999)
and nvl(s4.shayah_leyom_kodem,0)=0);

BEGIN
FOR  Sidurim1_rec IN  Sidurim1 LOOP
insert into tb_sidurim_ovdim ( mispar_ishi  , taarich  , mispar_sidur  , shat_hatchala  ,
shat_gmar,sector_visa,meadken_acharon   )
values (Sidurim1_rec.driver_id,Sidurim1_rec.start_dt,  Sidurim1_rec.schedule_num,  Sidurim1_rec.hatchala,
Sidurim1_rec.gmar,  Sidurim1_rec.sect,   Sidurim1_rec.meadken   );
END LOOP;

EXCEPTION
   WHEN OTHERS THEN
        RAISE;
end instead_of_bug_retro;

 procedure instead_of_bug2_retro(pDt varchar) is
 
CURSOR Sidurim2 IS
select   distinct k1.driver_id,k1.start_dt,k1.schedule_num,
to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.start_schedule,4,0),1,2)||':'||substr(lpad(k1.start_schedule,4,0),3,2),'yyyymmdd hh24:mi') hatchala,
to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.end_schedule,4,0),1,2)||':'||substr(lpad(k1.end_schedule,4,0),3,2),'yyyymmdd hh24:mi') gmar,
decode(sug_visa,' ','',sug_visa) sect, -12 meadken
from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k1
where k1.start_dt =  to_date(pDt,'yyyymmdd')
and k1.start_schedule<2400
and k1.end_schedule<2400
and k1.end_schedule=(select min(k3.end_schedule) from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k3
where k3.start_dt =  to_date(pDt,'yyyymmdd')
and k3.start_schedule<2400
and k3.end_schedule<2400
and k1.driver_id=k3.driver_id
and k1.start_dt=k3.start_dt
and k1.schedule_num=k3.schedule_num
and k1.start_schedule=k3.start_schedule)
and  exists (select *  from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k2
where k2.start_dt =  to_date(pDt,'yyyymmdd')
and k2.start_schedule<2400
and k2.end_schedule<2400
and k1.driver_id=k2.driver_id
and k1.start_dt=k2.start_dt
and k1.schedule_num=k2.schedule_num
and k1.start_schedule=k2.start_schedule
and k1.end_schedule<>k2.end_schedule)
and not exists (select * from tb_sidurim_ovdim s2
where   s2.taarich = to_date(pDt,'yyyymmdd')
and s2.taarich =  k1.start_dt
and  s2.mispar_ishi =k1.driver_id
and  s2.mispar_sidur =k1.schedule_num
and  s2.shat_hatchala =  to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.start_schedule,4,0),1,2)||':'||substr(lpad(k1.start_schedule,4,0),3,2),'yyyymmdd hh24:mi'));

cursor Sidurim3 is
select   distinct k1.driver_id,k1.start_dt,k1.schedule_num,
to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.start_schedule,4,0),1,2)||':'||substr(lpad(k1.start_schedule,4,0),3,2),'yyyymmdd hh24:mi') +1/1440 hatchala,
to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.end_schedule,4,0),1,2)||':'||substr(lpad(k1.end_schedule,4,0),3,2),'yyyymmdd hh24:mi') gmar,
decode(sug_visa,' ','',sug_visa)sect , -12 meadken
from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k1
where k1.start_dt =  to_date(pDt,'yyyymmdd')
and k1.start_schedule<2400
and k1.end_schedule<2400
and k1.end_schedule=(select max(k3.end_schedule) from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k3
where k3.start_dt =  to_date(pDt,'yyyymmdd')
and k3.start_schedule<2400
and k3.end_schedule<2400
and k1.driver_id=k3.driver_id
and k1.start_dt=k3.start_dt
and k1.schedule_num=k3.schedule_num
and k1.start_schedule=k3.start_schedule)
and  exists (select *  from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k2
where k2.start_dt =  to_date(pDt,'yyyymmdd')
and k2.start_schedule<2400
and k2.end_schedule<2400
and k1.driver_id=k2.driver_id
and k1.start_dt=k2.start_dt
and k1.schedule_num=k2.schedule_num
and k1.start_schedule=k2.start_schedule
and k1.end_schedule<>k2.end_schedule)
and not exists (select * from tb_sidurim_ovdim s2
where   s2.taarich = to_date(pDt,'yyyymmdd')
and s2.taarich =  k1.start_dt
and  s2.mispar_ishi =k1.driver_id
and  s2.mispar_sidur =k1.schedule_num
and  s2.shat_hatchala =  to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.start_schedule,4,0),1,2)||':'||substr(lpad(k1.start_schedule,4,0),3,2),'yyyymmdd hh24:mi'));


BEGIN
FOR  Sidurim2_rec IN  Sidurim2 LOOP
insert into tb_sidurim_ovdim ( mispar_ishi  , taarich  , mispar_sidur  , shat_hatchala  ,
shat_gmar,sector_visa,meadken_acharon   )
values (Sidurim2_rec.driver_id,Sidurim2_rec.start_dt,  Sidurim2_rec.schedule_num,  Sidurim2_rec.hatchala,
Sidurim2_rec.gmar,  Sidurim2_rec.sect,   Sidurim2_rec.meadken   );
END LOOP;
 FOR  Sidurim3_rec IN  Sidurim3 LOOP
insert into tb_sidurim_ovdim ( mispar_ishi  , taarich  , mispar_sidur  , shat_hatchala  ,
shat_gmar,sector_visa,meadken_acharon   )
values (Sidurim3_rec.driver_id,Sidurim3_rec.start_dt,  Sidurim3_rec.schedule_num,  Sidurim3_rec.hatchala,
Sidurim3_rec.gmar,  Sidurim3_rec.sect,   Sidurim3_rec.meadken   );
END LOOP;

EXCEPTION
   WHEN OTHERS THEN
        RAISE;
end instead_of_bug2_retro;

PROCEDURE pro_ins_peilut_retroSdrn(pDt varchar) IS
   BEGIN
   insert into tb_peilut_ovdim (mispar_ishi,taarich,mispar_sidur,  snif_tnua,shat_hatchala_sidur,shat_yetzia,mispar_knisa,
makat_nesia,oto_no,mispar_siduri_oto,kisuy_tor,
 Shat_Bhirat_Nesia_Netzer , Oto_No_Netzer, Mispar_Sidur_Netzer,  Shat_yetzia_Netzer,  Makat_Netzer, Shilut_Netzer ,
 Mikum_Bhirat_Nesia_Netzer ,meadken_acharon  )
   select    driver_id,start_dt,schedule_num,branch,
 to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi'),
 to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_time,4,0),1,2)||':'||substr(lpad(start_time,4,0),3,2),'yyyymmdd hh24:mi'),ride_id,
 makat_line,bus_number,bus_sequence,waiting_time,
 spm_time,spm_bus_number,spm_schedule_num,spm_start_time,spm_makat_line,spm_line_sign,spm_location,-12
from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm,tb_yamey_avoda_ovdim y
where  start_dt= to_date(pDt,'yyyymmdd')
and start_schedule<2400
and start_time<2400
and   y.taarich =   to_date(pDt,'yyyymmdd')  
and y.taarich  = start_dt
and y.mispar_ishi=driver_id
and y.measher_o_mistayeg is null;

insert into tb_peilut_ovdim (mispar_ishi,taarich,mispar_sidur,  snif_tnua,shat_hatchala_sidur,shat_yetzia,mispar_knisa,
makat_nesia,oto_no,mispar_siduri_oto,kisuy_tor,
 Shat_Bhirat_Nesia_Netzer , Oto_No_Netzer, Mispar_Sidur_Netzer,  Shat_yetzia_Netzer,  Makat_Netzer, Shilut_Netzer ,
 Mikum_Bhirat_Nesia_Netzer ,meadken_acharon  )
 select    driver_id,start_dt,schedule_num,branch,
 to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi'),
 to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_time,4,0),1,2)||':'||substr(lpad(start_time,4,0),3,2),'yyyymmdd hh24:mi'),ride_id,
 makat_line,bus_number,bus_sequence,waiting_time,
 spm_time,spm_bus_number,spm_schedule_num,spm_start_time,spm_makat_line,spm_line_sign,spm_location,-12
from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm,tb_yamey_avoda_ovdim y
where  start_dt= to_date(pDt,'yyyymmdd')
and start_schedule<2400
and start_time<2400
and   y.taarich =   to_date(pDt,'yyyymmdd')  
and y.taarich  = start_dt
and y.mispar_ishi=driver_id
and y.measher_o_mistayeg =1
and  not exists (select * from tb_sidurim_ovdim s
 	 				  	   where s.taarich =   to_date(pDt,'yyyymmdd')  
						   and s.taarich  = start_dt
						   and s.mispar_ishi=driver_id
						   and s.mispar_sidur=schedule_num
						   and s.shat_hatchala= to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi')
						   and s.shayah_leyom_kodem=1) ;
						   
 insert into tb_peilut_ovdim (mispar_ishi,taarich,mispar_sidur,  snif_tnua,shat_hatchala_sidur,shat_yetzia,mispar_knisa,
makat_nesia,oto_no,mispar_siduri_oto,kisuy_tor,
 Shat_Bhirat_Nesia_Netzer , Oto_No_Netzer, Mispar_Sidur_Netzer,  Shat_yetzia_Netzer,  Makat_Netzer, Shilut_Netzer ,
 Mikum_Bhirat_Nesia_Netzer ,meadken_acharon  )
select    driver_id,start_dt,schedule_num,branch,
 to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi'),
 to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(start_time-2400,4,0),1,2)||':'||substr(lpad(start_time,4,0),3,2),'yyyymmdd hh24:mi'),ride_id,
 makat_line,bus_number,bus_sequence,waiting_time,
 spm_time,spm_bus_number,spm_schedule_num,spm_start_time,spm_makat_line,spm_line_sign,spm_location,-12
from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k1,tb_yamey_avoda_ovdim y
where  start_dt=   to_date(pDt,'yyyymmdd') 
and start_schedule<2400
and start_time>2359
 --and schedule_num<100000;
 and   y.taarich =   to_date(pDt,'yyyymmdd')  
and y.taarich  = start_dt
and y.mispar_ishi=driver_id
and y.measher_o_mistayeg is null
 and not exists (select * from  tb_sidurim_ovdim s2
where s2.mispar_ishi=driver_id
and  s2.taarich= start_dt
and s2.mispar_sidur =schedule_num
and  s2.shat_hatchala =to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi')
and s2.shat_gmar<start_dt+1);

  insert into tb_peilut_ovdim (mispar_ishi,taarich,mispar_sidur,  snif_tnua,shat_hatchala_sidur,shat_yetzia,mispar_knisa,
makat_nesia,oto_no,mispar_siduri_oto,kisuy_tor,
 Shat_Bhirat_Nesia_Netzer , Oto_No_Netzer, Mispar_Sidur_Netzer,  Shat_yetzia_Netzer,  Makat_Netzer, Shilut_Netzer ,
 Mikum_Bhirat_Nesia_Netzer ,meadken_acharon  )
select    driver_id,start_dt,schedule_num,branch,
 to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi'),
 to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(start_time-2400,4,0),1,2)||':'||substr(lpad(start_time,4,0),3,2),'yyyymmdd hh24:mi'),ride_id,
 makat_line,bus_number,bus_sequence,waiting_time,
 spm_time,spm_bus_number,spm_schedule_num,spm_start_time,spm_makat_line,spm_line_sign,spm_location,-12
from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k1,tb_yamey_avoda_ovdim y
where  start_dt=   to_date(pDt,'yyyymmdd') 
and start_schedule<2400
and start_time>2359
 --and schedule_num<100000;
 and   y.taarich =   to_date(pDt,'yyyymmdd')  
and y.taarich  = start_dt
and y.mispar_ishi=driver_id
and y.measher_o_mistayeg =1
 and not exists (select * from  tb_sidurim_ovdim s2
where s2.mispar_ishi=driver_id
and  s2.taarich= start_dt
and s2.mispar_sidur =schedule_num
and  s2.shat_hatchala =to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi')
and s2.shat_gmar<start_dt+1)
and  not exists (select * from tb_sidurim_ovdim s
 	 				  	   where s.taarich =   to_date(pDt,'yyyymmdd')  
						   and s.taarich  = start_dt
						   and s.mispar_ishi=driver_id
						   and s.mispar_sidur=schedule_num
						   and s.shat_hatchala= to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi')
						   and s.shayah_leyom_kodem=1);

 insert into tb_peilut_ovdim (mispar_ishi,taarich,mispar_sidur,  snif_tnua,shat_hatchala_sidur,shat_yetzia,mispar_knisa,
makat_nesia,oto_no,mispar_siduri_oto,kisuy_tor,
 Shat_Bhirat_Nesia_Netzer , Oto_No_Netzer, Mispar_Sidur_Netzer,  Shat_yetzia_Netzer,  Makat_Netzer, Shilut_Netzer ,
 Mikum_Bhirat_Nesia_Netzer ,meadken_acharon  )
select    driver_id,start_dt+1,schedule_num,branch,
 to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(start_schedule-2400,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi'),
 to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(start_time-2400,4,0),1,2)||':'||substr(lpad(start_time,4,0),3,2),'yyyymmdd hh24:mi'),ride_id,
 makat_line,bus_number,bus_sequence,waiting_time,
 spm_time,spm_bus_number,spm_schedule_num,spm_start_time,spm_makat_line,spm_line_sign,spm_location,-12
from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k1,tb_yamey_avoda_ovdim y
where  start_dt=  to_date(pDt,'yyyymmdd')  
and start_schedule>2359
and start_time>2359
-- and schedule_num<100000;
 and   y.taarich =   to_date(pDt,'yyyymmdd')  
and y.taarich  = start_dt
and y.mispar_ishi=driver_id
and y.measher_o_mistayeg is null; 

  insert into tb_peilut_ovdim (mispar_ishi,taarich,mispar_sidur,  snif_tnua,shat_hatchala_sidur,shat_yetzia,mispar_knisa,
makat_nesia,oto_no,mispar_siduri_oto,kisuy_tor,
Shat_Bhirat_Nesia_Netzer , Oto_No_Netzer, Mispar_Sidur_Netzer,  Shat_yetzia_Netzer,  Makat_Netzer, Shilut_Netzer ,
 Mikum_Bhirat_Nesia_Netzer ,meadken_acharon  )
  select    driver_id,start_dt+1,schedule_num,branch,
 to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(start_schedule-2400,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi'),
 to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(start_time-2400,4,0),1,2)||':'||substr(lpad(start_time,4,0),3,2),'yyyymmdd hh24:mi'),ride_id,
 makat_line,bus_number,bus_sequence,waiting_time,
 spm_time,spm_bus_number,spm_schedule_num,spm_start_time,spm_makat_line,spm_line_sign,spm_location,-12
from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k1,tb_yamey_avoda_ovdim y
where  start_dt=  to_date(pDt,'yyyymmdd')  
and start_schedule>2359
and start_time>2359
-- and schedule_num<100000;
 and   y.taarich =   to_date(pDt,'yyyymmdd')  
and y.taarich  = start_dt
and y.mispar_ishi=driver_id
and y.measher_o_mistayeg=1
and  not exists (select * from tb_sidurim_ovdim s
 	 				  	   where s.taarich =   to_date(pDt,'yyyymmdd')  
						   and s.taarich  = start_dt
						   and s.mispar_ishi=driver_id
						   and s.mispar_sidur=schedule_num
						   and s.shat_hatchala=  to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(start_schedule-2400,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi')
						   and s.shayah_leyom_kodem=1) ;
						   
 insert into tb_peilut_ovdim (mispar_ishi,taarich,mispar_sidur,  snif_tnua,shat_hatchala_sidur,shat_yetzia,mispar_knisa,
makat_nesia,oto_no,mispar_siduri_oto,kisuy_tor,
Shat_Bhirat_Nesia_Netzer , Oto_No_Netzer, Mispar_Sidur_Netzer,  Shat_yetzia_Netzer,  Makat_Netzer, Shilut_Netzer ,
 Mikum_Bhirat_Nesia_Netzer ,meadken_acharon  )
    select    driver_id,start_dt,schedule_num,branch,
 to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi')+1/1440,
 to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(start_time-2400,4,0),1,2)||':'||substr(lpad(start_time,4,0),3,2),'yyyymmdd hh24:mi'),ride_id,
 makat_line,bus_number,bus_sequence,waiting_time,
 spm_time,spm_bus_number,spm_schedule_num,spm_start_time,spm_makat_line,spm_line_sign,spm_location,-12
from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm ,tb_yamey_avoda_ovdim y
where  start_dt= to_date(pDt,'yyyymmdd')
and start_schedule<2400
and start_time>2359
 --and schedule_num<100000;
and   y.taarich   =   to_date(pDt,'yyyymmdd')  
and y.taarich  = start_dt
and y.mispar_ishi=driver_id
and y.measher_o_mistayeg is null
 and exists (select * from  tb_sidurim_ovdim s2
where s2.mispar_ishi=driver_id
and  s2.taarich= start_dt
and s2.mispar_sidur =schedule_num
and  s2.shat_hatchala =to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi')
and s2.shat_gmar<start_dt+1);

  insert into tb_peilut_ovdim (mispar_ishi,taarich,mispar_sidur,  snif_tnua,shat_hatchala_sidur,shat_yetzia,mispar_knisa,
makat_nesia,oto_no,mispar_siduri_oto,kisuy_tor,
Shat_Bhirat_Nesia_Netzer , Oto_No_Netzer, Mispar_Sidur_Netzer,  Shat_yetzia_Netzer,  Makat_Netzer, Shilut_Netzer ,
 Mikum_Bhirat_Nesia_Netzer ,meadken_acharon  )
   select    driver_id,start_dt,schedule_num,branch,
 to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi')+1/1440,
 to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(start_time-2400,4,0),1,2)||':'||substr(lpad(start_time,4,0),3,2),'yyyymmdd hh24:mi'),ride_id,
 makat_line,bus_number,bus_sequence,waiting_time,
 spm_time,spm_bus_number,spm_schedule_num,spm_start_time,spm_makat_line,spm_line_sign,spm_location,-12
from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm ,tb_yamey_avoda_ovdim y
where  start_dt= to_date(pDt,'yyyymmdd')
and start_schedule<2400
and start_time>2359
 --and schedule_num<100000;
and   y.taarich   =   to_date(pDt,'yyyymmdd')  
and y.taarich  = start_dt
and y.mispar_ishi=driver_id
and y.measher_o_mistayeg =1
 and exists (select * from  tb_sidurim_ovdim s2
where s2.mispar_ishi=driver_id
and  s2.taarich= start_dt
and s2.mispar_sidur =schedule_num
and  s2.shat_hatchala =to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi')
and s2.shat_gmar<start_dt+1)
and not exists (select * from tb_sidurim_ovdim s3
 	 				  	   where s3.taarich =   to_date(pDt,'yyyymmdd')  
						   and s3.taarich  = start_dt
						   and s3.mispar_ishi=driver_id
						   and s3.mispar_sidur=schedule_num
						   and s3.shat_hatchala= to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi') ) ;
						   
insert into tb_peilut_ovdim (mispar_ishi,taarich,mispar_sidur,  snif_tnua,shat_hatchala_sidur,shat_yetzia,mispar_knisa,
makat_nesia,oto_no,mispar_siduri_oto,kisuy_tor,
 Shat_Bhirat_Nesia_Netzer , Oto_No_Netzer, Mispar_Sidur_Netzer,  Shat_yetzia_Netzer,  Makat_Netzer, Shilut_Netzer ,
 Mikum_Bhirat_Nesia_Netzer ,meadken_acharon  )
 select    k1.driver_id,k1.start_dt,k1.schedule_num,branch,
 to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.start_schedule,4,0),1,2)||':'||substr(lpad(k1.start_schedule,4,0),3,2),'yyyymmdd hh24:mi'),
 to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.start_time,4,0),1,2)||':'||substr(lpad(k1.start_time,4,0),3,2),'yyyymmdd hh24:mi'),k1.ride_id,
 k1.makat_line,bus_number,k1.bus_sequence,k1.waiting_time,
 k1.spm_time,k1.spm_bus_number,k1.spm_schedule_num,k1.spm_start_time,k1.spm_makat_line,
 k1.spm_line_sign,k1.spm_location,-12
from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k1 ,tb_yamey_avoda_ovdim y
where  k1.start_dt= to_date(pDt,'yyyymmdd')
and k1.start_schedule<2400
and k1.start_time<2400
 --and k1.schedule_num<100000
 and   y.taarich   =   to_date(pDt,'yyyymmdd')  
and y.taarich  = start_dt
and y.mispar_ishi=driver_id
and y.measher_o_mistayeg is null
and k1.end_schedule=(select min(k3.end_schedule) from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k3
where k3.start_dt =  to_date(pDt,'yyyymmdd')
and k3.start_schedule<2400
and k3.end_schedule<2400
and k1.driver_id=k3.driver_id
and k1.start_dt=k3.start_dt
and k1.schedule_num=k3.schedule_num
and k1.start_schedule=k3.start_schedule)
 and exists (select *  from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k2
where k2.start_dt=  to_date(pDt,'yyyymmdd')
and k2.start_schedule<2400
and k2.end_schedule<2400
and k1.driver_id=k2.driver_id
and k1.start_dt=k2.start_dt
and k1.schedule_num=k2.schedule_num
and k1.start_schedule=k2.start_schedule
and k1.end_schedule<>k2.end_schedule)
and not exists (select * from  tb_peilut_ovdim s2
where s2.mispar_ishi= k1.driver_id
and  s2.taarich= k1.start_dt
and  s2.taarich=  to_date(pDt,'yyyymmdd')
and s2.mispar_sidur =k1.schedule_num
and  s2.shat_hatchala_sidur =to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.start_schedule,4,0),1,2)||':'||substr(lpad(k1.start_schedule,4,0),3,2),'yyyymmdd hh24:mi')
and s2.SHAT_YETZIA=to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.start_time,4,0),1,2)||':'||substr(lpad(k1.start_time,4,0),3,2),'yyyymmdd hh24:mi')
and s2.MISPAR_KNISA=k1.ride_id);

insert into tb_peilut_ovdim (mispar_ishi,taarich,mispar_sidur,  snif_tnua,shat_hatchala_sidur,shat_yetzia,mispar_knisa,
makat_nesia,oto_no,mispar_siduri_oto,kisuy_tor,
 Shat_Bhirat_Nesia_Netzer , Oto_No_Netzer, Mispar_Sidur_Netzer,  Shat_yetzia_Netzer,  Makat_Netzer, Shilut_Netzer ,
 Mikum_Bhirat_Nesia_Netzer ,meadken_acharon  )
 select    k1.driver_id,k1.start_dt,k1.schedule_num,branch,
 to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.start_schedule,4,0),1,2)||':'||substr(lpad(k1.start_schedule,4,0),3,2),'yyyymmdd hh24:mi')+1/1440,
 to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.start_time,4,0),1,2)||':'||substr(lpad(k1.start_time,4,0),3,2),'yyyymmdd hh24:mi'),k1.ride_id,
 k1.makat_line,bus_number,k1.bus_sequence,k1.waiting_time,
 k1.spm_time,k1.spm_bus_number,k1.spm_schedule_num,k1.spm_start_time,k1.spm_makat_line,
 k1.spm_line_sign,k1.spm_location,-12
from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k1 ,tb_yamey_avoda_ovdim y
where  k1.start_dt= to_date(pDt,'yyyymmdd')
and k1.start_schedule<2400
and k1.start_time<2400
 --and k1.schedule_num<100000
 and   y.taarich   =   to_date(pDt,'yyyymmdd')  
and y.taarich  = start_dt
and y.mispar_ishi=driver_id
and y.measher_o_mistayeg=1
 and k1.end_schedule=(select max(k3.end_schedule) from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k3
where k3.start_dt =  to_date(pDt,'yyyymmdd')
and k3.start_schedule<2400
and k3.end_schedule<2400
and k1.driver_id=k3.driver_id
and k1.start_dt=k3.start_dt
and k1.schedule_num=k3.schedule_num
and k1.start_schedule=k3.start_schedule)
and exists (select *  from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k2
where k2.start_dt=  to_date(pDt,'yyyymmdd')
and k2.start_schedule<2400
and k2.end_schedule<2400
and k1.driver_id=k2.driver_id
and k1.start_dt=k2.start_dt
and k1.schedule_num=k2.schedule_num
and k1.start_schedule=k2.start_schedule
and k1.end_schedule<>k2.end_schedule)
and  not exists (select * from tb_sidurim_ovdim s
 	 				  	   where s.taarich =   to_date(pDt,'yyyymmdd')  
						   and s.taarich  = start_dt
						   and s.mispar_ishi=driver_id
						   and s.mispar_sidur=schedule_num
						   and s.shat_hatchala= to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi'));

insert into tb_peilut_ovdim (mispar_ishi,taarich,mispar_sidur, snif_tnua, shat_hatchala_sidur,shat_yetzia,mispar_knisa,
makat_nesia,oto_no,mispar_siduri_oto,kisuy_tor,
 Shat_Bhirat_Nesia_Netzer , Oto_No_Netzer, Mispar_Sidur_Netzer,  Shat_yetzia_Netzer,  Makat_Netzer, Shilut_Netzer ,
 Mikum_Bhirat_Nesia_Netzer ,meadken_acharon  )
 select    k1.driver_id,k1.start_dt,k1.schedule_num,branch,
 to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.start_schedule,4,0),1,2)||':'||substr(lpad(k1.start_schedule,4,0),3,2),'yyyymmdd hh24:mi')+1/1440,
 to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.start_time,4,0),1,2)||':'||substr(lpad(k1.start_time,4,0),3,2),'yyyymmdd hh24:mi'),k1.ride_id,
 k1.makat_line,bus_number,k1.bus_sequence,k1.waiting_time,
 k1.spm_time,k1.spm_bus_number,k1.spm_schedule_num,k1.spm_start_time,k1.spm_makat_line,
 k1.spm_line_sign,k1.spm_location,-12
from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k1 ,tb_yamey_avoda_ovdim y
where  k1.start_dt= to_date(pDt,'yyyymmdd')
and k1.start_schedule<2400
and k1.start_time<2400
 --and k1.schedule_num<100000
 and   y.taarich   =   to_date(pDt,'yyyymmdd')  
and y.taarich  = start_dt
and y.mispar_ishi=driver_id
and y.measher_o_mistayeg is null
 and k1.end_schedule=(select max(k3.end_schedule) from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k3
where k3.start_dt =  to_date(pDt,'yyyymmdd')
and k3.start_schedule<2400
and k3.end_schedule<2400
and k1.driver_id=k3.driver_id
and k1.start_dt=k3.start_dt
and k1.schedule_num=k3.schedule_num
and k1.start_schedule=k3.start_schedule)
and exists (select *  from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k2
where k2.start_dt=  to_date(pDt,'yyyymmdd')
and k2.start_schedule<2400
and k2.end_schedule<2400
and k1.driver_id=k2.driver_id
and k1.start_dt=k2.start_dt
and k1.schedule_num=k2.schedule_num
and k1.start_schedule=k2.start_schedule
and k1.end_schedule<>k2.end_schedule);

insert into tb_peilut_ovdim (mispar_ishi,taarich,mispar_sidur, snif_tnua, shat_hatchala_sidur,shat_yetzia,mispar_knisa,
makat_nesia,oto_no,mispar_siduri_oto,kisuy_tor,
 Shat_Bhirat_Nesia_Netzer , Oto_No_Netzer, Mispar_Sidur_Netzer,  Shat_yetzia_Netzer,  Makat_Netzer, Shilut_Netzer ,
 Mikum_Bhirat_Nesia_Netzer ,meadken_acharon  )
select    k1.driver_id,k1.start_dt,k1.schedule_num,branch,
 to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.start_schedule,4,0),1,2)||':'||substr(lpad(k1.start_schedule,4,0),3,2),'yyyymmdd hh24:mi')+1/1440,
 to_date(to_char(k1.start_dt,'yyyymmdd')||' '||substr(lpad(k1.start_time,4,0),1,2)||':'||substr(lpad(k1.start_time,4,0),3,2),'yyyymmdd hh24:mi'),k1.ride_id,
 k1.makat_line,bus_number,k1.bus_sequence,k1.waiting_time,
 k1.spm_time,k1.spm_bus_number,k1.spm_schedule_num,k1.spm_start_time,k1.spm_makat_line,
 k1.spm_line_sign,k1.spm_location,-12
from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k1 ,tb_yamey_avoda_ovdim y
where  k1.start_dt= to_date(pDt,'yyyymmdd')
and k1.start_schedule<2400
and k1.start_time<2400
 --and k1.schedule_num<100000
 and   y.taarich   =   to_date(pDt,'yyyymmdd')  
and y.taarich  = start_dt
and y.mispar_ishi=driver_id
and y.measher_o_mistayeg =1
 and k1.end_schedule=(select max(k3.end_schedule) from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k3
where k3.start_dt =  to_date(pDt,'yyyymmdd')
and k3.start_schedule<2400
and k3.end_schedule<2400
and k1.driver_id=k3.driver_id
and k1.start_dt=k3.start_dt
and k1.schedule_num=k3.schedule_num
and k1.start_schedule=k3.start_schedule)
and exists (select *  from  kds.KDS_DRIVER_ACTIVITIES@kds2sdrm k2
where k2.start_dt=  to_date(pDt,'yyyymmdd')
and k2.start_schedule<2400
and k2.end_schedule<2400
and k1.driver_id=k2.driver_id
and k1.start_dt=k2.start_dt
and k1.schedule_num=k2.schedule_num
and k1.start_schedule=k2.start_schedule
and k1.end_schedule<>k2.end_schedule)
and  not exists (select * from tb_sidurim_ovdim s
 	 				  	   where s.taarich =   to_date(pDt,'yyyymmdd')  
						   and s.taarich  = start_dt
						   and s.mispar_ishi=driver_id
						   and s.mispar_sidur=schedule_num
						   and s.shat_hatchala= to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi'));

update tb_peilut_ovdim
 set imut_netzer=1
 where taarich= to_date(pDt,'yyyymmdd')
  and Oto_No_Netzer>0 ;
 --and (Oto_No_Netzer>0 or Mispar_Sidur_Netzer>0  );

 update tb_peilut_ovdim
set mispar_matala=mispar_sidur
 where taarich= to_date(pDt,'yyyymmdd')
 and mispar_sidur< 1000;
 update tb_peilut_ovdim
 --todo: only if exists in sidurim shaya_leyom_kodem
set mispar_matala=mispar_sidur
 where taarich= to_date(pDt,'yyyymmdd')+1
 and mispar_sidur< 1000;
 
 
 update tb_peilut_ovdim
set teur_nesia=( select    line_description
				 		   from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm
						   	where  start_dt= taarich
							and driver_id=mispar_ishi
							and schedule_num=mispar_sidur
							and to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi')=shat_hatchala_sidur
							and to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_time,4,0),1,2)||':'||substr(lpad(start_time,4,0),3,2),'yyyymmdd hh24:mi')=shat_yetzia
							and makat_line=makat_nesia
							and ride_id=mispar_knisa
							and start_schedule<2400
							and start_time<2400
							and line_description is not null
							and ride_id>0
							and makat_line<50000000)
where taarich= to_date(pDt,'yyyymmdd')
and makat_nesia<50000000
and mispar_knisa>0
and trunc(shat_hatchala_sidur)=taarich
and trunc(shat_yetzia)=taarich;
 
update tb_peilut_ovdim
set teur_nesia=( select    line_description
				 		   from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm
						   	where  start_dt= taarich
							and driver_id=mispar_ishi
							and schedule_num=mispar_sidur
							and to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi')=shat_hatchala_sidur
							 and to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(start_time-2400,4,0),1,2)||':'||substr(lpad(start_time,4,0),3,2),'yyyymmdd hh24:mi')=shat_yetzia
							and makat_line=makat_nesia
							and ride_id=mispar_knisa
							and start_schedule<2400
							and start_time>2359
							and line_description is not null
				   			and ride_id>0
							and makat_line<50000000)
where taarich= to_date(pDt,'yyyymmdd')
and makat_nesia<50000000
and mispar_knisa>0
and trunc(shat_hatchala_sidur)=taarich
and trunc(shat_yetzia)=taarich+1;
 
update tb_peilut_ovdim
set teur_nesia=( select    line_description
				 		   from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm
						   	where  start_dt= taarich
							and driver_id=mispar_ishi
							and schedule_num=mispar_sidur
							and to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(start_schedule-2400,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi')=shat_hatchala_sidur
							 and to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(start_time-2400,4,0),1,2)||':'||substr(lpad(start_time,4,0),3,2),'yyyymmdd hh24:mi')=shat_yetzia
							and makat_line=makat_nesia
							and ride_id=mispar_knisa
							and start_schedule>2359
							and start_time>2359
							and line_description is not null
				   			and ride_id>0
							and makat_line<50000000)
where taarich= to_date(pDt,'yyyymmdd')
and makat_nesia<50000000
and mispar_knisa>0
and trunc(shat_hatchala_sidur)=taarich+1
and trunc(shat_yetzia)=taarich+1;
 
update tb_peilut_ovdim
set teur_nesia=( select    line_description
				 		   from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm
						   	where  start_dt= taarich
							and driver_id=mispar_ishi
							and schedule_num=mispar_sidur
							and to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi')=shat_hatchala_sidur
							and to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_time,4,0),1,2)||':'||substr(lpad(start_time,4,0),3,2),'yyyymmdd hh24:mi')=shat_yetzia
							and makat_line=makat_nesia
							and ride_id=mispar_knisa
							and start_schedule<2400
							and start_time<2400
							and line_description is not null
							and nvl(makat_line,0)=0
							and schedule_num<1000)
where taarich= to_date(pDt,'yyyymmdd')
and nvl(makat_nesia,0)=0
and mispar_sidur<1000
and trunc(shat_hatchala_sidur)=taarich
and trunc(shat_yetzia)=taarich;
 
update tb_peilut_ovdim
set teur_nesia=( select    line_description
				 		   from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm
						   	where  start_dt= taarich
							and driver_id=mispar_ishi
							and schedule_num=mispar_sidur
							and to_date(to_char(start_dt,'yyyymmdd')||' '||substr(lpad(start_schedule,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi')=shat_hatchala_sidur
							 and to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(start_time-2400,4,0),1,2)||':'||substr(lpad(start_time,4,0),3,2),'yyyymmdd hh24:mi')=shat_yetzia
							and makat_line=makat_nesia
							and ride_id=mispar_knisa
							and start_schedule<2400
							and start_time>2359
							and line_description is not null
							and nvl(makat_line,0)=0
							and schedule_num<1000)
where taarich= to_date(pDt,'yyyymmdd')
and nvl(makat_nesia,0)=0
and mispar_sidur<1000
and trunc(shat_hatchala_sidur)=taarich
and trunc(shat_yetzia)=taarich+1;
 
update tb_peilut_ovdim
set teur_nesia=( select    line_description
				 		   from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm
						   	where  start_dt= taarich
							and driver_id=mispar_ishi
							and schedule_num=mispar_sidur
							and to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(start_schedule-2400,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi')=shat_hatchala_sidur
							 and to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(start_time-2400,4,0),1,2)||':'||substr(lpad(start_time,4,0),3,2),'yyyymmdd hh24:mi')=shat_yetzia
							and makat_line=makat_nesia
							and ride_id=mispar_knisa
							and start_schedule>2359
							and start_time>2359
							and line_description is not null
							and nvl(makat_line,0)=0
							and schedule_num<1000)
where taarich= to_date(pDt,'yyyymmdd')
and nvl(makat_nesia,0)=0
and mispar_sidur<1000
and trunc(shat_hatchala_sidur)=taarich+1
and trunc(shat_yetzia)=taarich+1;

update tb_peilut_ovdim
set teur_nesia=( select    line_description
				 		   from kds.KDS_DRIVER_ACTIVITIES@kds2sdrm
						   	where  start_dt= taarich-1
							and driver_id=mispar_ishi
							and schedule_num=mispar_sidur
							and to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(start_schedule-2400,4,0),1,2)||':'||substr(lpad(start_schedule,4,0),3,2),'yyyymmdd hh24:mi')=shat_hatchala_sidur
							 and to_date(to_char(start_dt+1,'yyyymmdd')||' '||substr(lpad(start_time-2400,4,0),1,2)||':'||substr(lpad(start_time,4,0),3,2),'yyyymmdd hh24:mi')=shat_yetzia
							and makat_line=makat_nesia
							and ride_id=mispar_knisa
							and start_schedule>2359
							and start_time>2359
							and line_description is not null
							and nvl(makat_line,0)=0
							and schedule_num<1000)
where taarich= to_date(pDt,'yyyymmdd')+1
and nvl(makat_nesia,0)=0
and mispar_sidur<1000
and trunc(shat_hatchala_sidur)=taarich 
and trunc(shat_yetzia)=taarich;
						   
   EXCEPTION
   WHEN OTHERS THEN
        RAISE;
end pro_ins_peilut_retroSdrn;

 	

END PKG_sdrn;
/
CREATE OR REPLACE PACKAGE PKG_SIDURIM  AS

TYPE	CurType	  IS	REF  CURSOR;
PROCEDURE pro_get_data(p_Kod IN VARCHAR2,p_Period in VARCHAR2, p_Cur OUT CurType);
PROCEDURE pro_get_matching_description(p_Prefix in VARCHAR2,  p_Cur OUT CurType);
PROCEDURE pro_get_matching_kod(p_Prefix in VARCHAR2,  p_Cur OUT CurType);
PROCEDURE pro_get_description_by_kod(p_Kod in VARCHAR2,p_Desc out VARCHAR2);
PROCEDURE pro_get_kod_by_description(p_Desc in CTB_SIDURIM_MEYUCHADIM.TEUR_SIDUR_MEYCHAD%type,p_Kod out CTB_SIDURIM_MEYUCHADIM.KOD_SIDUR_MEYUCHAD%type);
PROCEDURE pro_get_details_Kod(p_Cur OUT CurType );
PROCEDURE pro_get_history(p_FilterKod in varchar2 , p_Kod in VARCHAR2,p_ToDate in VARCHAR2,  p_Cur out Curtype);
PROCEDURE pro_upd_data(p_KodMeafyen number,p_MisparSidur number,p_MeTaarich date,p_AdTaarich date,p_Erech VARCHAR2 ,p_SugNatun VARCHAR2,p_comment varchar2, p_taarich_idkun_acharon DATE,p_meadken_acharon NUMBER) ;
PROCEDURE pro_ins_data(p_KodMeafyen number,p_MisparSidur number,p_MeTaarich date,p_AdTaarich date,p_Erech VARCHAR2 ,p_SugNatun VARCHAR2,p_comment varchar2, p_taarich_idkun_acharon DATE,p_meadken_acharon NUMBER) ;
PROCEDURE pro_Del_data(p_KodMeafyen number,p_MisparSidur number,p_MeTaarich date);

PROCEDURE get_sidur(p_sidur_position IN VARCHAR2,  p_mispar_ishi IN TB_SIDURIM_OVDIM.MISPAR_ISHI%type,p_taarich  IN TB_SIDURIM_OVDIM.TAARICH%type, p_Cur OUT CurType);
PROCEDURE get_sidurim_meyuchadim_all(p_tar_me IN tb_sidurim_meyuchadim.me_taarich%type,
		  									   	  										 p_tar_ad  IN tb_sidurim_meyuchadim.me_taarich%type,
																						 p_Cur OUT CurType) ;

PROCEDURE pro_get_ctb_sidurim_meafyen(p_taarich in tmp_sidurim_meyuchadim.AD_TARICH%type, p_cur out CurType);

PROCEDURE pro_ins_upd_sidurim_ovdim(p_mispar_ishi IN tb_sidurim_ovdim.mispar_ishi%type,
 			 										 								p_mispar_sidur IN tb_sidurim_ovdim.mispar_sidur%type,
																					 p_taarich IN  tb_sidurim_ovdim.taarich%type,
																			      p_shat_hatchala IN tb_sidurim_ovdim.shat_hatchala%type,
																					p_shat_gmar IN tb_sidurim_ovdim.shat_gmar%type,
																				p_user_upd  IN tb_sidurim_ovdim.MEADKEN_ACHARON%type);

PROCEDURE pro_get_sidurim_leoved(p_mispar_ishi IN tb_sidurim_ovdim.mispar_ishi%type,
 			 										 						p_taarich IN  tb_sidurim_ovdim.taarich%type,
																			p_cur out CurType);

PROCEDURE pro_get_meafyen_sidur_by_kod(P_Kod_Sidur in integer,
		  										   	  		  									 P_Taarich in VARCHAR2,
		  						   					  	 		 							 p_Cur out CurType) ;

 PROCEDURE pro_get_teur_whithoutlist(p_Prefix in VARCHAR2 , whithOutList in VARCHAR2,   whithOutListMisSidur in VARCHAR2  ,p_Cur OUT CurType);
 PROCEDURE pro_get_kod_whithoutlist(p_Prefix in VARCHAR2 , whithOutList in VARCHAR2,   whithOutListMisSidur in VARCHAR2  ,p_Cur OUT CurType);

 PROCEDURE pro_get_meafyen_sidur_ragil(P_Sug_Sidur in integer,
		  										   	  		  							P_Taarich in VARCHAR2,
		  						   					  	 		 							 p_Cur out CurType);
PROCEDURE  calling_Pivot_Sidurim_M;
PROCEDURE Pivot_Sidurim_Meyuchadim ;

	/************************************************************************/
PROCEDURE pro_get_yom_viza( p_Cur out CurType);
PROCEDURE pro_get_sug_hazmanat_viza( p_Cur out CurType);
PROCEDURE pro_get_kod_mivza_viza( p_Cur out CurType);
PROCEDURE pro_get_lina( p_Cur out CurType);
PROCEDURE ProGetMusach_O_Machsan(p_Taarich  in VARCHAR2, p_Cur out CurType) ;
--PROCEDURE ProGetMusach_O_Machsan(p_Taarich  in CTB_MAHSANIM.ME_TAARICH_TOKEF%type, p_Cur out CurType) ;

PROCEDURE get_tmp_sidurim_meyuchadim(p_tar_me IN tb_sidurim_meyuchadim.me_taarich%type,
		  									   	  										 p_tar_ad  IN tb_sidurim_meyuchadim.me_taarich%type,
																						 p_Cur OUT CurType) ;
PROCEDURE get_tb_sadot_nosafim_lesidur(p_cur out CurType);
PROCEDURE pro_get_meafyeney_sidur(p_cur out CurType);
PROCEDURE pro_get_siba_lo_letashlum(p_mispar_ishi IN tb_sidurim_ovdim.mispar_ishi%type,p_date IN  tb_sidurim_ovdim.taarich%type, p_mispar_sidur IN tb_sidurim_ovdim.mispar_sidur%type ,p_shat_hatchala in varchar2,  p_teur_siba out varchar2);
                                                                               
PROCEDURE Pivot_test ;
END PKG_SIDURIM;
/

CREATE OR REPLACE PACKAGE BODY PKG_SIDURIM AS

  PROCEDURE pro_get_data(p_Kod IN VARCHAR2,p_Period in VARCHAR2,p_Cur OUT CurType) is
  v_MaxLimitDate Date ;
  v_MinLimitDate date ;
  BEGIN
  	v_MinLimitDate := to_date('01/' || p_Period,'dd/mm/yyyy'); /* period= 05/2009=>  v_MinLimitDate = 01/05/2009 */
    v_MaxLimitDate := add_months(v_MinLimitDate,1) -1 ;    /* period= 05/2009=>  v_MaxLimitDate = 31/05/2009 */


          OPEN p_Cur FOR
          SELECT tb.MISPAR_SIDUR, ctb.Kod_Meafyen,(ctb.Kod_Meafyen||'-'|| ctb.shem_meafyen || '(' || ctb.SUG_NATUN || ')')DetailsMeafyen ,tb.Me_Taarich,tb.Ad_Taarich,Erech, ctb.sug_natun,tb.taarich_idkun_acharon LastUpdate,TB.HEARA
          FROM TB_SIDURIM_MEYUCHADIM tb      INNER JOIN ctb_meafyeney_sidurim ctb
          ON ctb.kod_meafyen= tb.kod_meafyen
          WHERE ((tb.Me_Taarich <=  v_MaxLimitDate ) and (tb.Ad_Taarich >= v_MinLimitDate or tb.Ad_Taarich is null ))
          AND tb.MISPAR_SIDUR = p_Kod AND ctb.PAIL = 1
          ORDER BY   ctb.Kod_Meafyen ;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
  END pro_get_data;

  PROCEDURE pro_get_matching_description(p_Prefix in VARCHAR2,  p_Cur OUT CurType) AS
  BEGIN
  OPEN p_Cur for
      SELECT TEUR_SIDUR_MEYCHAD from CTB_SIDURIM_MEYUCHADIM SM
      WHERE SM.TEUR_SIDUR_MEYCHAD   LIKE  p_Prefix || '%' and pail =1
      order by TEUR_SIDUR_MEYCHAD asc;
    NULL;
  END pro_get_matching_description;


  PROCEDURE pro_get_matching_kod(p_Prefix in VARCHAR2,  p_Cur OUT CurType) AS
  BEGIN
  OPEN p_Cur for
      SELECT KOD_SIDUR_MEYUCHAD
      FROM CTB_SIDURIM_MEYUCHADIM SM
      WHERE SM.KOD_SIDUR_MEYUCHAD   LIKE  p_Prefix || '%' and pail =1
      ORDER BY KOD_SIDUR_MEYUCHAD ASC ;
    END pro_get_matching_kod;

PROCEDURE pro_get_history(p_FilterKod in VARCHAR2, p_Kod in VARCHAR2,p_ToDate in VARCHAR2, p_Cur out Curtype) IS
  v_tar_me DATE ;
  BEGIN
      v_tar_me:=to_date(p_ToDate,'dd/mm/yyyy');
  OPEN p_Cur for
      SELECT SM.ME_TAARICH,SM.ad_taarich,SM.erech
      FROM TB_SIDURIM_MEYUCHADIM SM
      WHERE SM.kod_meafyen =p_Kod and SM.AD_TAARICH< v_tar_me and MISPAR_SIDUR = p_filterkod
      ORDER BY SM.ME_TAARICH asc ;

END pro_get_history;

PROCEDURE pro_get_description_by_kod(p_Kod in VARCHAR2,p_Desc out VARCHAR2) is
  BEGIN

        SELECT  case when ( pail = 1)  then SM.teur_sidur_meychad
                        else '-1' end  into p_Desc
        FROM CTB_SIDURIM_MEYUCHADIM SM
        WHERE SM.KOD_SIDUR_MEYUCHAD = p_Kod ;
    EXCEPTION
       WHEN NO_DATA_FOUND THEN
       p_Desc := '';
    END pro_get_description_by_kod;

  PROCEDURE pro_get_kod_by_description(p_Desc in CTB_SIDURIM_MEYUCHADIM.TEUR_SIDUR_MEYCHAD%type  ,p_Kod out CTB_SIDURIM_MEYUCHADIM.KOD_SIDUR_MEYUCHAD%type) AS
  BEGIN
          SELECT  case when ( pail = 1)  then SM.KOD_SIDUR_MEYUCHAD
                        else -1 end  into p_Kod
        FROM CTB_SIDURIM_MEYUCHADIM SM
        WHERE SM.teur_sidur_meychad = p_Desc ;
    EXCEPTION
        WHEN NO_DATA_FOUND THEN
        p_Kod := '';
    END pro_get_kod_by_description;

PROCEDURE pro_get_details_Kod(p_Cur OUT CurType ) as
BEGIN
  OPEN p_Cur for
      SELECT  SM.KOD_MEAFYEN Kod_Meafyen , ('-' || SM.KOD_MEAFYEN  || SM.SHEM_MEAFYEN || '(' || sm.SUG_NATUN || ')' ) DetailsMeafyen
      FROM ctb_meafyeney_sidurim SM
      WHERE SM.PAIL = 1 and (SIDUR_MEYUCHAD_OR_SUG_SIDUR = 0 or SIDUR_MEYUCHAD_OR_SUG_SIDUR = 2)
      order by Kod_Meafyen asc ;
END pro_get_details_Kod;

  PROCEDURE pro_upd_data(p_KodMeafyen number,p_MisparSidur number,p_MeTaarich date,p_AdTaarich date,p_Erech VARCHAR2 ,p_SugNatun VARCHAR2,p_comment varchar2, p_taarich_idkun_acharon DATE,p_meadken_acharon NUMBER) AS
  BEGIN
    update TB_SIDURIM_MEYUCHADIM SM
    set SM.ERECH = p_Erech ,
        SM.AD_TAARICH = p_AdTaarich ,
          SM.TAARICH_IDKUN_ACHARON = p_taarich_idkun_acharon,
          SM.MEADKEN_ACHARON = p_meadken_acharon,
          SM.HEARA = p_comment
    where MISPAR_SIDUR = p_MisparSidur AND
    ME_TAARICH = p_MeTaarich AND
    KOD_MEAFYEN = p_KodMeafyen;
  END pro_upd_data;

PROCEDURE pro_ins_data(p_KodMeafyen number,p_MisparSidur number,p_MeTaarich date,p_AdTaarich date,p_Erech VARCHAR2 ,p_SugNatun VARCHAR2,p_comment varchar2, p_taarich_idkun_acharon DATE,p_meadken_acharon NUMBER) AS
  BEGIN
  insert into TB_SIDURIM_MEYUCHADIM
    (ad_taarich, erech, kod_meafyen, me_taarich, meadken_acharon, mispar_sidur,heara)
    VALUES (p_adtaarich, p_erech, p_kodmeafyen, p_metaarich, p_meadken_acharon, p_misparsidur,p_comment);
  END pro_ins_data;

      PROCEDURE pro_Del_data(p_KodMeafyen number,p_MisparSidur number,p_MeTaarich date)  AS
  BEGIN
      Delete TB_SIDURIM_MEYUCHADIM
    where MISPAR_SIDUR = p_MisparSidur AND
    ME_TAARICH = p_MeTaarich AND
    KOD_MEAFYEN = p_KodMeafyen;

  END pro_Del_data;



    /*   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0       06/07/2009      sari       1.    */
PROCEDURE get_sidurim_meyuchadim_all(p_tar_me IN tb_sidurim_meyuchadim.me_taarich%type,
		  									   	  										 p_tar_ad  IN tb_sidurim_meyuchadim.me_taarich%type,
																						 p_Cur OUT CurType) AS
BEGIN
	 OPEN p_cur for
	 	  SELECT tb.MISPAR_SIDUR,tb.Kod_Meafyen,tb.Me_Taarich,nvl(tb.Ad_Taarich,to_date('01/01/9999','dd/mm/yyyy')) ad_taarich,Erech
		FROM TB_SIDURIM_MEYUCHADIM tb
		WHERE  tb.Me_Taarich <=p_tar_me
		AND nvl(tb.Ad_Taarich,to_date('01/01/9999','dd/mm/yyyy'))  >=p_tar_ad;

EXCEPTION
       WHEN OTHERS THEN
				RAISE;
  END get_sidurim_meyuchadim_all;

PROCEDURE get_sidur(p_sidur_position IN VARCHAR2,  p_mispar_ishi IN TB_SIDURIM_OVDIM.MISPAR_ISHI%type,p_taarich  IN TB_SIDURIM_OVDIM.TAARICH%type, p_Cur OUT CurType)
AS
shat_hatchala date;
BEGIN
	 	  if p_sidur_position != null then

		  		  	   if p_sidur_position = 'first' then

							   SELECT min(tbs.SHAT_HATCHALA)  into shat_hatchala
							   FROM TB_SIDURIM_OVDIM tbs
					   		   WHERE  tbs.TAARICH = to_date(to_char(p_taarich, 'dd/mm/yyyy'), 'dd/mm/yyyy')
								          and tbs.MISPAR_ISHI = p_mispar_ishi
										  and (tbs.BITUL_O_HOSAFA=2 or   tbs.BITUL_O_HOSAFA=4);

						   		OPEN p_cur for
						   		SELECT *
					   			FROM TB_SIDURIM_OVDIM tb
					   			WHERE  tb.TAARICH = to_date(to_char(p_taarich, 'dd/mm/yyyy'), 'dd/mm/yyyy')
									      and tb.MISPAR_ISHI = p_mispar_ishi
									      and tb.SHAT_HATCHALA = shat_hatchala
										  and (tb.BITUL_O_HOSAFA=2 or   tb.BITUL_O_HOSAFA=4);

					   elsif p_sidur_position = 'last' then

							   SELECT max(tbs.SHAT_HATCHALA)  into shat_hatchala
							   FROM TB_SIDURIM_OVDIM tbs
					   		   WHERE  tbs.TAARICH = to_date(to_char(p_taarich, 'dd/mm/yyyy'), 'dd/mm/yyyy')
								          and tbs.MISPAR_ISHI = p_mispar_ishi
										  and (tbs.BITUL_O_HOSAFA=2 or   tbs.BITUL_O_HOSAFA=4);

								OPEN p_cur for
								SELECT *
					   			FROM TB_SIDURIM_OVDIM tb
					   			WHERE  tb.TAARICH = to_date(to_char(p_taarich, 'dd/mm/yyyy'), 'dd/mm/yyyy')
									      and tb.MISPAR_ISHI = p_mispar_ishi
									      and tb.SHAT_HATCHALA = shat_hatchala
										 and (tb.BITUL_O_HOSAFA=2 or   tb.BITUL_O_HOSAFA=4) ;
					 end if;

		  else

				  	   OPEN p_cur for
				  	   SELECT *
					   FROM TB_SIDURIM_OVDIM tb
					   WHERE  tb.Taarich = to_date(to_char(p_taarich, 'dd/mm/yyyy'), 'dd/mm/yyyy')
				                  and tb.MISPAR_ISHI = p_mispar_ishi
								  and (tb.BITUL_O_HOSAFA=2 or   tb.BITUL_O_HOSAFA=4);
		  end if;

EXCEPTION
       WHEN OTHERS THEN
				RAISE;
  END get_sidur;

  PROCEDURE pro_get_ctb_sidurim_meafyen(p_taarich in tmp_sidurim_meyuchadim.AD_TARICH%type,  p_cur out CurType)
IS
BEGIN
     OPEN p_cur FOR
     select  c.kod_sidur_meyuchad,c.teur_sidur_meychad ,s.sidur_misug_headrut,s.shat_hatchala_muteret,s.shat_gmar_muteret,
	s.nitan_ledaveach_ad_taarich,s.headrut_hova_ledaveach_shaot
		from tmp_sidurim_meyuchadim s ,ctb_sidurim_meyuchadim c
		where s.mispar_sidur=c.kod_sidur_meyuchad
		and  s.Me_Tarich <=p_taarich
		AND nvl(s.AD_TARICH,to_date('01/01/9999','dd/mm/yyyy'))  >=p_taarich
		order by c.teur_sidur_meychad ;

EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END pro_get_ctb_sidurim_meafyen;

  PROCEDURE pro_get_sidurim_leoved(p_mispar_ishi IN tb_sidurim_ovdim.mispar_ishi%type,
 			 										 							p_taarich IN  tb_sidurim_ovdim.taarich%type,
																				p_cur out CurType) AS
  BEGIN
		open p_cur  for
			 		select mispar_sidur,shat_hatchala,shat_gmar,nvl(kod_siba_lo_letashlum,0)kod_siba_lo_letashlum,nvl(Lo_letashlum,0) Lo_letashlum,NVL(Bitul_O_Hosafa,0) Bitul_O_Hosafa from tb_sidurim_ovdim
					where mispar_ishi=p_mispar_ishi
					and taarich =p_taarich;

		EXCEPTION
        WHEN OTHERS THEN
		RAISE;
	END pro_get_sidurim_leoved;

PROCEDURE pro_ins_upd_sidurim_ovdim(p_mispar_ishi IN tb_sidurim_ovdim.mispar_ishi%type,
 			 										 								p_mispar_sidur IN tb_sidurim_ovdim.mispar_sidur%type,
																					 p_taarich IN  tb_sidurim_ovdim.taarich%type,
																			      p_shat_hatchala IN tb_sidurim_ovdim.shat_hatchala%type,
																					p_shat_gmar IN tb_sidurim_ovdim.shat_gmar%type,
																				p_user_upd  IN tb_sidurim_ovdim.MEADKEN_ACHARON%type)       AS
			 v_count number;
	BEGIN
		  v_count:=0;
		   select count(*)  into v_count
			 from 	 tb_sidurim_ovdim
			 WHERE mispar_ishi=p_mispar_ishi
			AND taarich =trunc(p_taarich)
			AND mispar_sidur=p_mispar_sidur
			AND shat_hatchala=p_shat_hatchala;

		 	if (v_count=0) then
					   insert into tb_sidurim_ovdim
					   (mispar_ishi,mispar_sidur,taarich,shat_hatchala,shat_gmar,meadken_acharon,Taarich_idkun_acharon)
					   values(p_mispar_ishi,p_mispar_sidur,trunc(p_taarich),p_shat_hatchala,p_shat_gmar ,p_user_upd,sysdate);
			else
					 INSERT INTO TRAIL_SIDURIM_OVDIM (mispar_ishi,mispar_sidur,taarich,
		                                    shat_hatchala,shat_gmar,shat_hatchala_letashlum,shat_gmar_letashlum,
		                                    pitzul_hafsaka,chariga,tosefet_grira,hashlama,yom_visa,
		                                    lo_letashlum,out_michsa,mikum_shaon_knisa,mikum_shaon_yetzia,
		                                    achuz_knas_lepremyat_visa,achuz_viza_besikun,mispar_musach_o_machsan,
		                                    kod_siba_lo_letashlum,kod_siba_ledivuch_yadani_in,kod_siba_ledivuch_yadani_out,
		                                    meadken_acharon,taarich_idkun_acharon,heara,shayah_leyom_kodem,mispar_shiurey_nehiga,
		                                    mispar_ishi_trail,taarich_idkun_trail,sug_peula,mezake_halbasha,mezake_nesiot)
									    SELECT mispar_ishi,mispar_sidur,taarich,
									          shat_hatchala,shat_gmar,shat_hatchala_letashlum,shat_gmar_letashlum,
									          pitzul_hafsaka,chariga,tosefet_grira,hashlama,yom_visa,
									          lo_letashlum,out_michsa,mikum_shaon_knisa,mikum_shaon_yetzia,
									          achuz_knas_lepremyat_visa,achuz_viza_besikun,mispar_musach_o_machsan,
									          kod_siba_lo_letashlum,kod_siba_ledivuch_yadani_in,kod_siba_ledivuch_yadani_out,
									          meadken_acharon,taarich_idkun_acharon,heara,shayah_leyom_kodem,mispar_shiurey_nehiga,
									          p_user_upd,sysdate,3, mezake_halbasha,mezake_nesiot
									    FROM TB_SIDURIM_OVDIM
									    WHERE mispar_ishi  =p_mispar_ishi    AND
									         mispar_sidur  = p_mispar_sidur  AND
									         taarich       = trunc(p_taarich) AND
									         shat_hatchala = p_shat_hatchala;


							UPDATE  TB_SIDURIM_OVDIM
							SET shat_hatchala=p_shat_hatchala,
							shat_gmar=p_shat_gmar,
							meadken_acharon=p_user_upd,
							Taarich_idkun_acharon=sysdate
							WHERE mispar_ishi=p_mispar_ishi
							AND taarich =trunc(p_taarich)
							AND mispar_sidur=p_mispar_sidur
							AND shat_hatchala=p_shat_hatchala;
			end if;

			EXCEPTION
        WHEN OTHERS THEN
		RAISE;
	END pro_ins_upd_sidurim_ovdim;

PROCEDURE pro_get_meafyen_sidur_by_kod(P_Kod_Sidur in integer,
		  										   	  		  									 P_Taarich in VARCHAR2,
		  						   					  	 		 							 p_Cur out CurType) IS
			  v_tar DATE ;
BEGIN
 v_tar:=to_date(P_Taarich,'dd/mm/yyyy');
      OPEN p_Cur for
		    SELECT  S.KOD_MEAFYEN,S.ERECH
			FROM TB_SIDURIM_MEYUCHADIM S
			WHERE
	 		 	 		  S.MISPAR_SIDUR = P_Kod_Sidur and
						    v_tar BETWEEN S.ME_TAARICH AND S.AD_TAARICH ;
EXCEPTION
    WHEN OTHERS THEN
        RAISE;
END pro_get_meafyen_sidur_by_kod;

 PROCEDURE pro_get_teur_whithoutlist(p_Prefix in VARCHAR2 , whithOutList in VARCHAR2 ,
 		   									  	 		  	whithOutListMisSidur in VARCHAR2 ,
 		   									  	 		                      p_Cur OUT CurType) AS
  BEGIN
  OPEN p_Cur for
  	   		  SELECT distinct(SM.TEUR_SIDUR_MEYCHAD)
	          FROM CTB_SIDURIM_MEYUCHADIM SM
              WHERE   SM.TEUR_SIDUR_MEYCHAD   LIKE  p_Prefix || '%'  and
			  		  			SM.PAIL=1 AND
								SM.KOD_SIDUR_MEYUCHAD not in( select x from table(cast(convert_string_to_table(  whithOutListMisSidur,  ',') as mytabtype)) )  AND
								--SM.KOD_SIDUR_MEYUCHAD NOT  IN() AND
	  		  		  	      SM.KOD_SIDUR_MEYUCHAD NOT  IN(
												  	  	   	  	   SELECT distinct( t.MISPAR_SIDUR)
																   FROM TB_SIDURIM_MEYUCHADIM t
																   WHERE t.KOD_MEAFYEN in( select x from table(cast(convert_string_to_table(whithOutList ,  ',') as mytabtype)) )
																   )
      order by SM.TEUR_SIDUR_MEYCHAD asc;

   EXCEPTION
    WHEN OTHERS THEN
        RAISE;
 END pro_get_teur_whithoutlist;

PROCEDURE pro_get_kod_whithoutlist(p_Prefix in VARCHAR2 , whithOutList in VARCHAR2 ,
		  									   			  			   	  		   whithOutListMisSidur in VARCHAR2 ,
		  									   			  			   	  		   p_Cur OUT CurType) AS
  BEGIN
  OPEN p_Cur for
  	          SELECT distinct(SM.KOD_SIDUR_MEYUCHAD)
	          FROM CTB_SIDURIM_MEYUCHADIM SM
              WHERE   SM.KOD_SIDUR_MEYUCHAD   LIKE  p_Prefix || '%'  and
			  		  			  SM.PAIL=1 AND
								  SM.KOD_SIDUR_MEYUCHAD not in( select x from table(cast(convert_string_to_table(  whithOutListMisSidur,  ',') as mytabtype)) )  AND
							--	  SM.KOD_SIDUR_MEYUCHAD not in(whithOutListMisSidur) AND
	  		  		  	          SM.KOD_SIDUR_MEYUCHAD NOT  IN(
												  	  	   	  	   SELECT distinct( t.MISPAR_SIDUR)
																   FROM TB_SIDURIM_MEYUCHADIM t
																   WHERE t.KOD_MEAFYEN in( select x from table(cast(convert_string_to_table(whithOutList ,  ',') as mytabtype)) ))
					order by 	SM.KOD_SIDUR_MEYUCHAD;

   EXCEPTION
    WHEN OTHERS THEN
        RAISE;
 END pro_get_kod_whithoutlist;

 PROCEDURE pro_get_meafyen_sidur_ragil(P_Sug_Sidur in integer,
		  										   	  		  							P_Taarich in VARCHAR2,
		  						   					  	 		 							 p_Cur out CurType) IS
			  v_tar DATE ;
BEGIN
 v_tar:=to_date(P_Taarich,'dd/mm/yyyy');
      OPEN p_Cur for
		    SELECT  M.KOD_MEAFYEN,M.ERECH
			FROM  TB_MEAFYENEY_SUG_SIDUR M
			WHERE
	 		 	 		 M.SUG_SIDUR = P_Sug_Sidur AND
						    v_tar BETWEEN M.ME_TAARICH AND M.AD_TAARICH ;
EXCEPTION
    WHEN OTHERS THEN
        RAISE;
END pro_get_meafyen_sidur_ragil;

PROCEDURE calling_Pivot_Sidurim_M IS
 --    v_idkun_tb     date;
  --   v_idkun_tmp   date;
BEGIN
--select max(nvl(m.taarich_idkun_acharon,sysdate)) idkun_tb,
--max(nvl(t.taarich_idkun_acharon,sysdate)) idkun_tmp
--into v_idkun_tb, v_idkun_tmp
--from tb_sidurim_meyuchadim m, tmp_sidurim_meyuchadim t;

--if (v_idkun_tb > v_idkun_tmp) then
delete from   tmp_sidurim_meyuchadim;
 PKG_SIDURIM.Pivot_Sidurim_Meyuchadim;
--end if;
commit;
END calling_Pivot_Sidurim_M;

PROCEDURE Pivot_Sidurim_Meyuchadim IS
CURSOR Sidurim_tmp IS
  SELECT  distinct  mispar_sidur
from   tb_sidurim_meyuchadim
 -- where   mispar_sidur <99813 --between 63473 and 77690
;

CURSOR Me_tarich_tmp(par_sidur number) IS
select distinct me_tarich from
(select distinct p1.me_taarich  me_tarich
from   tb_sidurim_meyuchadim  p1
	where  p1.mispar_sidur=par_sidur
	union all
select distinct   p2.ad_taarich+1 me_tarich
--distinct  nvl(p2.ad_taarich,to_date('31/12/2100','dd/mm/yyyy'))+1 me_tarich
	from   tb_sidurim_meyuchadim p2
	where  p2.mispar_sidur=par_sidur
    and p2.ad_taarich<to_date('31/12/4712','dd/mm/yyyy')
    and   p2.ad_taarich is not null
  -- -- and p2.ad_taarich<to_date('31/12/2100','dd/mm/yyyy')
   -- and decode(p2.ad_taarich,to_date('31/12/4712','dd/mm/yyyy'),null, to_date('31/12/2100','dd/mm/yyyy'),null,   p2.ad_taarich) is not null
    --  and not exists( select * from tb_sidurim_meyuchadim p3 where  p3.mispar_sidur=par_sidur
   	--  	   		   		  		 and   p2.ad_taarich+1=p3.me_taarich
	--							 and  p2.mispar_sidur= p3.mispar_sidur);
	)
	order by me_tarich;


CURSOR Me_Ad_tmp(par_sidur number) IS
select me_tarich,nvl(ad_tarich,to_date('31/12/4712','dd/mm/yyyy')) ad_tarich
from    tmp_sidurim_meyuchadim
where mispar_sidur=par_sidur;

CURSOR sidurim_meyuchadim_tmp(par_sidur number,p_Dt_from date, p_Dt_to date) IS
select
  mispar_sidur,
  teur, Sug_sidur	 ,sector_avoda	 ,sug_premia, mofia_bdoch_nochachut_minhal_u, headrut_hova_ledaveach_shaot,
  shat_hatchala_muteret,
  shat_gmar_muteret,
  hukiyut_beshabaton ,hokiyut_beshishi ,
  sug_hashaot_beyom_shishi,	 sug_hashaot_beyom_shabaton, hova_ledaveach_peilut,
  zakay_leaman_nesia,zakay_lezman_halbasha,  max_shaot_byom_hol	 ,
  sug_shaot_byom_hol_if_migbala,	 max_shaot_byom_shishi	 ,max_shaot_beshabaton	 ,
  asur_2_peiluyot_meoto_sug,hashlama_lemin_shaot_imahu,
  mutar_lebitzua_rak_lemeafyen_x, mutar_lebitzua_rak_lerishyon,avar_hadracha_meyuchedet	,
  zakay_michutz_lamichsa,  zakay_lepizul 	 ,
  nitan_ledaveach_ad_taarich,
  kod_tipul_meyuchad_Baklita,	 kod_tipul_meyuchad_Bashguim,	 kod_tipul_meyuchad_Bachishuv,
  asur_ledivuach_lechevrot_bat	, zakay_lehamara		 ,kod_headrut		 ,zakay_lelina	 ,
  zakay_lechariga,
  hova_ledaveach_mispar_machsan,hova_ledaveach_mispar_musach,
  hova_yom_visa_namlak ,
  asur_divuach_simun_tachograf,	 zakay_lehashlama_avur_sidur ,zakay_lechishuv_retzifut	 ,
  metagber_benihul_tnua,asur_ledaveach_mispar_rechev,
  zarich_ledaveach_km,sidur_namlak_visa,sidur_asur_ledaveach_peilut,
  avodat_musach	,zakaut_lepizul_nehagut	,zakaut_legmul_chisachon,
  sug_avoda,sidur_misug_headrut, shaon_nochachut,ein_leshalem_tos_lila,max_dakot_boded,
   dakot_n_letashlum_hol,sidur_kaytanot_veruey_kayiz,sidur_lo_nivdak_sofash,
  lo_letashlum_automati,kizuz_al_pi_hatchala_gmar,Michsat_shaot_chodshit,
       zakaut_lenosafot	,   lo_pogea_bemichsat_nosafot,   rechiv_lezvira_yomit,
   rechiv_lezvira_chodshit,   max_dakot_nosafot_bechodesh,   zakaut_tamritz_nosafot_minhal,
     michsat_shishi_lebaley_x,  shabaton_tashlum_kavua,	   max_yemey_avoda_bechodesh,
	 kod_ishur_WF	,	   sidur_mishtatel_bechafifa,  tashlum_kavua_beshishi,	   lo_zakay_legmul_beshishi,
	  lo_zakay_legmul_beshabaton,		   sug_shaot_nosafot	,  musachey_mishmeret2,
	  asur_leshanot_zman_peilut,   lo_nidreshet_hityazvut,   zakaut_lerezifut_benahagut,
	  zakaut_letamriz_nos_nehagut,	   tokef_hatchala	,	   tokef_siyum		,   hovat_hityazvut	,   element1_hova	,
	  element2_hova	,   element3_hova	,   bdikat_hityazvut_letachanat_s,     
	  nitan_ledaveach_bmachala_aruc, nizbar_yomit_lehalbasha_nesio,heara_letiud
from (
  select
    mispar_sidur,
    max(case when kod_meafyen=1 then nvl(erech,'-1')   else '' end)    teur,
    max(case when  kod_meafyen=2 then nvl(erech,'-1')   else '' end)   Sug_sidur	 ,
    max(case when  kod_meafyen=3 then nvl(erech,'-1')   else '' end)   sector_avoda,
    max(case when  kod_meafyen=72 then nvl(erech,'-1')   else '' end)   sug_premia,
    max(case when  kod_meafyen=5 then nvl(erech,'-1')   else '' end)   mofia_bdoch_nochachut_minhal_u,
    max(case when  kod_meafyen=6 then nvl(erech,'-1')   else '' end)   headrut_hova_ledaveach_shaot,
    max(case when  kod_meafyen=7 then erech  else  null  end)  shat_hatchala_muteret,
    max(case when  kod_meafyen=8 then erech  else  null end)  shat_gmar_muteret,
    max(case when  kod_meafyen=9 then nvl(erech,'-1')   else '' end)   hukiyut_beshabaton,
    max(case when  kod_meafyen=10 then nvl(erech,'-1')   else '' end) hokiyut_beshishi,
    max(case when  kod_meafyen=11 then nvl(erech,'-1')   else '' end) sug_hashaot_beyom_shishi,
    max(case when  kod_meafyen=12 then nvl(erech,'-1')   else '' end) sug_hashaot_beyom_shabaton,
    max(case when  kod_meafyen=13 then nvl(erech,'-1')   else '' end) hova_ledaveach_peilut,
    max(case when  kod_meafyen=14 then nvl(erech,'-1')   else '' end) zakay_leaman_nesia	 ,
    max(case when  kod_meafyen=15  then nvl(erech,'-1')   else '' end) zakay_lezman_halbasha,
    max(case when  kod_meafyen=16 then nvl(erech,'-1')   else '' end)  max_shaot_byom_hol	 ,
    max(case when  kod_meafyen=17 then nvl(erech,'-1')   else '' end)  sug_shaot_byom_hol_if_migbala,
    max(case when  kod_meafyen=18 then nvl(erech,'-1')   else '' end)  max_shaot_byom_shishi	 ,
    max(case when  kod_meafyen=19 then nvl(erech,'-1')   else '' end)  max_shaot_beshabaton	 ,
    max(case when  kod_meafyen=20 then nvl(erech,'-1')   else '' end)  asur_2_peiluyot_meoto_sug,
    max(case when  kod_meafyen=21 then nvl(erech,'-1')   else '' end)  hashlama_lemin_shaot_imahu,
    max(case when  kod_meafyen=22 then nvl(erech,'-1')   else '' end)  mutar_lebitzua_rak_lemeafyen_x,
    max(case when  kod_meafyen=23 then nvl(erech,'-1')   else '' end)  mutar_lebitzua_rak_lerishyon,
    max(case when  kod_meafyen=24 then nvl(erech,'-1')   else '' end)  avar_hadracha_meyuchedet	,
    max(case when  kod_meafyen=25 then nvl(erech,'-1')   else '' end)  zakay_michutz_lamichsa,
    max(case when  kod_meafyen=26 then nvl(erech,'-1')   else '' end)  zakay_lepizul 	 ,
    max(case when  kod_meafyen=27 then nvl(erech,'-1')   else '' end)  nitan_ledaveach_ad_taarich,
    max(case when  kod_meafyen=28 then nvl(erech,'-1')   else '' end)  kod_tipul_meyuchad_Baklita,
    max(case when  kod_meafyen=29 then nvl(erech,'-1')   else '' end)  kod_tipul_meyuchad_Bashguim,
    max(case when  kod_meafyen=30 then nvl(erech,'-1')   else '' end)  kod_tipul_meyuchad_Bachishuv,
    max(case when  kod_meafyen=31 then nvl(erech,'-1')   else '' end)  asur_ledivuach_lechevrot_bat	,
    max(case when  kod_meafyen=32 then nvl(erech,'-1')   else '' end)  zakay_lehamara		 ,
    max(case when  kod_meafyen=33 then nvl(erech,'-1')   else '' end)  kod_headrut		 ,
    max(case when  kod_meafyen=34 then nvl(erech,'-1')   else '' end)  zakay_lelina	 ,
    max(case when  kod_meafyen=35 then nvl(erech,'-1')   else '' end)  zakay_lechariga,
    max(case when  kod_meafyen=36 then nvl(erech,'-1')   else '' end)  hova_ledaveach_mispar_machsan,
    max(case when  kod_meafyen=37 then nvl(erech,'-1')   else '' end)  hova_ledaveach_mispar_musach,
    max(case when  kod_meafyen=38 then nvl(erech,'-1')   else '' end)  hova_yom_visa_namlak,
    max(case when  kod_meafyen=39 then nvl(erech,'-1')   else '' end)  asur_divuach_simun_tachograf,
    max(case when  kod_meafyen=40 then nvl(erech,'-1')   else '' end)  zakay_lehashlama_avur_sidur ,
    max(case when  kod_meafyen=41 then nvl(erech,'-1')   else '' end)  zakay_lechishuv_retzifut,
	max(case when  kod_meafyen=42 then nvl(erech,'-1')   else '' end)  metagber_benihul_tnua,
    max(case when  kod_meafyen=43 then nvl(erech,'-1')   else '' end)  asur_ledaveach_mispar_rechev,
    max(case when  kod_meafyen=44 then nvl(erech,'-1')   else '' end)  zarich_ledaveach_km,
    max(case when  kod_meafyen=45 then nvl(erech,'-1')   else '' end)  sidur_namlak_visa,
    max(case when  kod_meafyen=46 then nvl(erech,'-1')   else '' end)  sidur_asur_ledaveach_peilut,
	max(case when  kod_meafyen=47 then nvl(erech,'-1')   else '' end)  avodat_musach	,
	max(case when  kod_meafyen=48 then nvl(erech,'-1')   else '' end)  zakaut_lepizul_nehagut	,
	max(case when  kod_meafyen=49 then nvl(erech,'-1')   else '' end)  zakaut_legmul_chisachon,
	max(case when  kod_meafyen=50 then nvl(erech,'-1')   else '' end)      zakaut_lenosafot	,
    max(case when  kod_meafyen=51 then nvl(erech,'-1')   else '' end)	  lo_pogea_bemichsat_nosafot,
    max(case when  kod_meafyen=52 then nvl(erech,'-1')   else '' end)  sug_avoda,
    max(case when  kod_meafyen=53 then nvl(erech,'-1')   else '' end)  sidur_misug_headrut,
    max(case when  kod_meafyen=54 then nvl(erech,'-1')   else '' end)  shaon_nochachut,
    max(case when  kod_meafyen=55 then nvl(erech,'-1')   else '' end)	   rechiv_lezvira_yomit,
    max(case when  kod_meafyen=56 then nvl(erech,'-1')   else '' end)	   rechiv_lezvira_chodshit,
	max(case when  kod_meafyen=57 then nvl(erech,'-1')   else '' end)  Michsat_shaot_chodshit,
    max(case when  kod_meafyen=58 then nvl(erech,'-1')   else '' end)	   max_dakot_nosafot_bechodesh,
    max(case when  kod_meafyen=59 then nvl(erech,'-1')   else '' end)	   zakaut_tamritz_nosafot_minhal,
    max(case when  kod_meafyen=60 then nvl(erech,'-1')   else '' end)  max_dakot_boded,
    max(case when  kod_meafyen=61 then nvl(erech,'-1')   else '' end)  ein_leshalem_tos_lila,
	max(case when  kod_meafyen=62 then nvl(erech,'-1')   else '' end)  dakot_n_letashlum_hol,
    max(case when  kod_meafyen=63 then nvl(erech,'-1')   else '' end)	   michsat_shishi_lebaley_x,
    max(case when  kod_meafyen=64 then nvl(erech,'-1')   else '' end)       shabaton_tashlum_kavua,
    max(case when  kod_meafyen=65 then nvl(erech,'-1')   else '' end)  	   max_yemey_avoda_bechodesh,
    max(case when  kod_meafyen=66 then nvl(erech,'-1')   else '' end)  	   kod_ishur_WF	,
    max(case when  kod_meafyen=67 then nvl(erech,'-1')   else '' end)  	   sidur_mishtatel_bechafifa,
    max(case when  kod_meafyen=68 then nvl(erech,'-1')   else '' end)  	   tashlum_kavua_beshishi,
    max(case when  kod_meafyen=69 then nvl(erech,'-1')   else '' end)  	   lo_zakay_legmul_beshishi,
    max(case when  kod_meafyen=70 then nvl(erech,'-1')   else '' end)  	   lo_zakay_legmul_beshabaton,
    max(case when  kod_meafyen=71 then nvl(erech,'-1')   else '' end)  	   sug_shaot_nosafot	,
	max(case when  kod_meafyen=4 then nvl(erech,'-1')   else '' end)        sidur_lo_nivdak_sofash,
    max(case when  kod_meafyen=73 then nvl(erech,'-1')   else '' end)      sidur_kaytanot_veruey_kayiz,
    max(case when  kod_meafyen=74 then nvl(erech,'-1')   else '' end)  	   musachey_mishmeret2,
    max(case when  kod_meafyen=75 then nvl(erech,'-1')   else '' end)	   asur_leshanot_zman_peilut,
    max(case when  kod_meafyen=76 then nvl(erech,'-1')   else '' end)	   lo_nidreshet_hityazvut,
    max(case when  kod_meafyen=77 then nvl(erech,'-1')   else '' end)	   zakaut_lerezifut_benahagut,
	max(case when  kod_meafyen=78 then nvl(erech,'-1')   else '' end)      kizuz_al_pi_hatchala_gmar,
	max(case when  kod_meafyen=79 then nvl(erech,'-1')   else '' end)      lo_letashlum_automati,
    max(case when  kod_meafyen=80 then nvl(erech,'-1')   else '' end)	   zakaut_letamriz_nos_nehagut,
	max(case when  kod_meafyen=81 then erech  else  null  end)   tokef_hatchala	 ,
	max(case when  kod_meafyen=82 then erech  else  null  end)   tokef_siyum	 ,
    max(case when  kod_meafyen=83 then nvl(erech,'-1')   else '' end)	   hovat_hityazvut	,
    max(case when  kod_meafyen=93 then nvl(erech,'-1')   else '' end)	   element1_hova	,
    max(case when  kod_meafyen=94 then nvl(erech,'-1')   else '' end)	   element2_hova	,
    max(case when  kod_meafyen=95 then nvl(erech,'-1')   else '' end)	   element3_hova	,
    max(case when  kod_meafyen=96 then nvl(erech,'-1')   else '' end)	   bdikat_hityazvut_letachanat_s,
	max(case when  kod_meafyen=97 then nvl(erech,'-1')   else '' end)	   nitan_ledaveach_bmachala_aruc,
	max(case when  kod_meafyen=98 then nvl(erech,'-1')   else '' end)	   nizbar_yomit_lehalbasha_nesio,
	max(case when  kod_meafyen=99 then nvl(erech,'-1')   else '' end)	  heara_letiud
  from
    tb_sidurim_meyuchadim
	where mispar_sidur =par_sidur
			and ((p_Dt_from <= me_taarich  and  p_Dt_to >= me_taarich  and p_Dt_to <= nvl(ad_taarich,to_date('31/12/4712','dd/mm/yyyy')))
	 or  (p_Dt_from <= me_taarich  and p_Dt_to >= nvl(ad_taarich,to_date('31/12/4712','dd/mm/yyyy')))
     or (p_Dt_from >= me_taarich  and  p_Dt_from <= nvl(ad_taarich,to_date('31/12/4712','dd/mm/yyyy')) and p_Dt_to >= nvl(ad_taarich,to_date('31/12/4712','dd/mm/yyyy')))
	 or (p_Dt_from >= me_taarich   and  p_Dt_to <= nvl(ad_taarich,to_date('31/12/4712','dd/mm/yyyy'))))
--	and ((to_date(p_Dt_from,'dd/mm/yyyy') <= me_taarich  and to_date(p_Dt_to,'dd/mm/yyyy') >= me_taarich  and to_date(p_Dt_to,'dd/mm/yyyy') <= nvl(ad_taarich,to_date('31/12/4712','dd/mm/yyyy')))
--	 or  (to_date(p_Dt_from,'dd/mm/yyyy') <= me_taarich  and to_date(p_Dt_to,'dd/mm/yyyy') >= nvl(ad_taarich,to_date('31/12/4712','dd/mm/yyyy')))
 --    or (to_date(p_Dt_from,'dd/mm/yyyy') >= me_taarich  and to_date(p_Dt_from,'dd/mm/yyyy') <= nvl(ad_taarich,to_date('31/12/4712','dd/mm/yyyy')) and to_date(p_Dt_to,'dd/mm/yyyy') >= nvl(ad_taarich,to_date('31/12/4712','dd/mm/yyyy')))
--	 or (to_date(p_Dt_from,'dd/mm/yyyy') >= me_taarich   and to_date(p_Dt_to,'dd/mm/yyyy') <= nvl(ad_taarich,to_date('31/12/4712','dd/mm/yyyy'))))
	 group by
   mispar_sidur);

BEGIN

FOR  Sidurim_tmp_rec IN  Sidurim_tmp LOOP

FOR  Me_tarich_tmp_rec IN  Me_tarich_tmp(Sidurim_tmp_rec.mispar_sidur) LOOP

 insert into tmp_sidurim_meyuchadim
 (mispar_sidur,me_tarich,ad_tarich)
 values (Sidurim_tmp_rec.mispar_sidur,Me_tarich_tmp_rec.me_tarich,
-- ( select distinct least((select   nvl(min(ad_taarich),to_date('31/12/2100','dd/mm/yyyy'))
 ( select distinct least((select   nvl(min(p1.ad_taarich),to_date('31/12/4712','dd/mm/yyyy'))
from   tb_sidurim_meyuchadim p1
	where  mispar_sidur=Sidurim_tmp_rec.mispar_sidur
	and p1.ad_taarich>=Me_tarich_tmp_rec.me_tarich)
	,
	(select nvl(min(p2.me_taarich) - 1,to_date('31/12/4712','dd/mm/yyyy'))
from   tb_sidurim_meyuchadim p2
	where  mispar_sidur=Sidurim_tmp_rec.mispar_sidur
		 and p2.me_taarich>(select min(p3.me_taarich) from tb_sidurim_meyuchadim p3 where mispar_sidur=Sidurim_tmp_rec.mispar_sidur)
 and  p2.me_taarich>Me_tarich_tmp_rec.me_tarich )
	 ,
	 to_date('31/12/4712','dd/mm/yyyy')) ad_tarich
from   tb_sidurim_meyuchadim p4
	where  mispar_sidur=Sidurim_tmp_rec.mispar_sidur)
 );

END LOOP;

 delete  from  tmp_sidurim_meyuchadim
 where mispar_sidur=Sidurim_tmp_rec.mispar_sidur
 and ad_tarich<to_date('01/01/2008','dd/mm/yyyy');


 FOR  Me_Ad_tmp_rec IN  Me_Ad_tmp(Sidurim_tmp_rec.mispar_sidur) LOOP

 FOR  sidurim_meyuchadim_tmp_rec IN  sidurim_meyuchadim_tmp(Sidurim_tmp_rec.mispar_sidur,
 Me_Ad_tmp_rec.me_tarich,Me_Ad_tmp_rec.ad_tarich)
 LOOP
 update  tmp_sidurim_meyuchadim
 set  teur=sidurim_meyuchadim_tmp_rec.teur,
 	  sug_premia=sidurim_meyuchadim_tmp_rec.sug_premia,
	 shat_hatchala_muteret= to_date(sidurim_meyuchadim_tmp_rec.shat_hatchala_muteret,'hh24:mi'),
 	 shat_gmar_muteret= to_date(sidurim_meyuchadim_tmp_rec.shat_gmar_muteret,'hh24:mi'),
 	  hova_ledaveach_peilut=sidurim_meyuchadim_tmp_rec.hova_ledaveach_peilut,
 	  zakay_lezman_halbasha=sidurim_meyuchadim_tmp_rec.zakay_lezman_halbasha,
 	  asur_2_peiluyot_meoto_sug=sidurim_meyuchadim_tmp_rec.asur_2_peiluyot_meoto_sug,
 	  mutar_lebitzua_rak_lmeafyen_x	=sidurim_meyuchadim_tmp_rec.mutar_lebitzua_rak_lemeafyen_x,
      mutar_lebitzua_rak_lerishyon=sidurim_meyuchadim_tmp_rec.mutar_lebitzua_rak_lerishyon,
      zakay_michutz_lamichsa=sidurim_meyuchadim_tmp_rec.zakay_michutz_lamichsa,
	  nitan_ledaveach_ad_taarich=sidurim_meyuchadim_tmp_rec.nitan_ledaveach_ad_taarich,
	  zakay_lechariga=sidurim_meyuchadim_tmp_rec.zakay_lechariga,
	  hova_ledaveach_mispar_machsan=sidurim_meyuchadim_tmp_rec.hova_ledaveach_mispar_machsan,
	  hova_ledaveach_mispar_musach=sidurim_meyuchadim_tmp_rec.hova_ledaveach_mispar_musach,
	  hova_yom_visa_namlak=sidurim_meyuchadim_tmp_rec.hova_yom_visa_namlak,
      Sug_sidur	=sidurim_meyuchadim_tmp_rec.sug_sidur,
      sector_avoda	=sidurim_meyuchadim_tmp_rec.sector_avoda,
      headrut_hova_ledaveach_shaot=sidurim_meyuchadim_tmp_rec.headrut_hova_ledaveach_shaot,
      mofia_bdoch_nochachut_minhal_u=sidurim_meyuchadim_tmp_rec.mofia_bdoch_nochachut_minhal_u,
      hukiyut_beshabaton=sidurim_meyuchadim_tmp_rec.hukiyut_beshabaton,
      hokiyut_beshishi=sidurim_meyuchadim_tmp_rec.hokiyut_beshishi,
      sug_hashaot_beyom_shishi	=sidurim_meyuchadim_tmp_rec.sug_hashaot_beyom_shishi	,
      sug_hashaot_beyom_shabaton =sidurim_meyuchadim_tmp_rec.sug_hashaot_beyom_shabaton ,
      zakay_leaman_nesia	=sidurim_meyuchadim_tmp_rec.zakay_leaman_nesia,
      max_shaot_byom_hol	=sidurim_meyuchadim_tmp_rec.max_shaot_byom_hol,
      sug_shaot_byom_hol_if_migbala	=sidurim_meyuchadim_tmp_rec.sug_shaot_byom_hol_if_migbala	,
      max_shaot_byom_shishi	=sidurim_meyuchadim_tmp_rec.max_shaot_byom_shishi	,
      max_shaot_beshabaton	=sidurim_meyuchadim_tmp_rec.max_shaot_beshabaton	,
      hashlama_lemin_shaot_imahu	=sidurim_meyuchadim_tmp_rec.hashlama_lemin_shaot_imahu,
      avar_hadracha_meyuchedet	=sidurim_meyuchadim_tmp_rec.avar_hadracha_meyuchedet	,
      zakay_lepizul 	=sidurim_meyuchadim_tmp_rec.zakay_lepizul ,
      kod_tipul_meyuchad_Baklita	=sidurim_meyuchadim_tmp_rec.kod_tipul_meyuchad_Baklita,
      kod_tipul_meyuchad_Bashguim	=sidurim_meyuchadim_tmp_rec.kod_tipul_meyuchad_Bashguim	,
      kod_tipul_meyuchad_Bachishuv	=sidurim_meyuchadim_tmp_rec.kod_tipul_meyuchad_Bachishuv,
      asur_ledivuach_lechevrot_bat	=sidurim_meyuchadim_tmp_rec.asur_ledivuach_lechevrot_bat,
      zakay_lehamara		=sidurim_meyuchadim_tmp_rec.zakay_lehamara,
      kod_headrut		=sidurim_meyuchadim_tmp_rec.kod_headrut	,
      zakay_lelina	=sidurim_meyuchadim_tmp_rec.zakay_lelina,
      asur_divuach_simun_tachograf	=sidurim_meyuchadim_tmp_rec.asur_divuach_simun_tachograf,
      zakay_lehashlama_avur_sidur=sidurim_meyuchadim_tmp_rec.zakay_lehashlama_avur_sidur,
      zakay_lechishuv_retzifut	=sidurim_meyuchadim_tmp_rec.zakay_lechishuv_retzifut,
	  metagber_benihul_tnua=sidurim_meyuchadim_tmp_rec.metagber_benihul_tnua,
	  zarich_ledaveach_km=sidurim_meyuchadim_tmp_rec.zarich_ledaveach_km,
      asur_ledaveach_mispar_rechev =sidurim_meyuchadim_tmp_rec.asur_ledaveach_mispar_rechev,
      sidur_namlak_visa  =sidurim_meyuchadim_tmp_rec.sidur_namlak_visa,
      sidur_asur_ledaveach_peilut=sidurim_meyuchadim_tmp_rec.sidur_asur_ledaveach_peilut,
	  avodat_musach	=sidurim_meyuchadim_tmp_rec.avodat_musach,
	  zakaut_lepizul_nehagut	=sidurim_meyuchadim_tmp_rec.zakaut_lepizul_nehagut,
	  zakaut_legmul_chisachon=sidurim_meyuchadim_tmp_rec.zakaut_legmul_chisachon,
	  sug_avoda  =sidurim_meyuchadim_tmp_rec.sug_avoda,
      sidur_misug_headrut =sidurim_meyuchadim_tmp_rec.sidur_misug_headrut,
	   shaon_nochachut  =sidurim_meyuchadim_tmp_rec.shaon_nochachut,
      ein_leshalem_tos_lila=sidurim_meyuchadim_tmp_rec.ein_leshalem_tos_lila,
	  max_dakot_boded= sidurim_meyuchadim_tmp_rec.max_dakot_boded,
	   dakot_n_letashlum_hol= sidurim_meyuchadim_tmp_rec. dakot_n_letashlum_hol,
      sidur_kaytanot_veruey_kayiz=sidurim_meyuchadim_tmp_rec.sidur_kaytanot_veruey_kayiz,
	  sidur_lo_nivdak_sofash=sidurim_meyuchadim_tmp_rec.sidur_lo_nivdak_sofash,
	  kizuz_al_pi_hatchala_gmar=sidurim_meyuchadim_tmp_rec.kizuz_al_pi_hatchala_gmar,
	  lo_letashlum_automati=sidurim_meyuchadim_tmp_rec.lo_letashlum_automati,
	  Michsat_shaot_chodshit=sidurim_meyuchadim_tmp_rec.Michsat_shaot_chodshit,
      zakaut_lenosafot	=sidurim_meyuchadim_tmp_rec.zakaut_lenosafot,
	  lo_pogea_bemichsat_nosafot	=sidurim_meyuchadim_tmp_rec.lo_pogea_bemichsat_nosafot,
	   rechiv_lezvira_yomit	=sidurim_meyuchadim_tmp_rec.rechiv_lezvira_yomit,
	   rechiv_lezvira_chodshit	=sidurim_meyuchadim_tmp_rec.rechiv_lezvira_chodshit	,
	   max_dakot_nosafot_bechodesh	=sidurim_meyuchadim_tmp_rec.max_dakot_nosafot_bechodesh,
	   zakaut_tamritz_nosafot_minhal=sidurim_meyuchadim_tmp_rec.zakaut_tamritz_nosafot_minhal,
	   michsat_shishi_lebaley_x=sidurim_meyuchadim_tmp_rec.michsat_shishi_lebaley_x,
       shabaton_tashlum_kavua	=sidurim_meyuchadim_tmp_rec.shabaton_tashlum_kavua,
  	   max_yemey_avoda_bechodesh	=sidurim_meyuchadim_tmp_rec.max_yemey_avoda_bechodesh,
  	   kod_ishur_WF=sidurim_meyuchadim_tmp_rec. kod_ishur_WF,
  	   sidur_mishtatel_bechafifa=sidurim_meyuchadim_tmp_rec.sidur_mishtatel_bechafifa,
  	   tashlum_kavua_beshishi	=sidurim_meyuchadim_tmp_rec. tashlum_kavua_beshishi,
  	   lo_zakay_legmul_beshishi=sidurim_meyuchadim_tmp_rec.lo_zakay_legmul_beshishi,
  	   lo_zakay_legmul_beshabaton	=sidurim_meyuchadim_tmp_rec. lo_zakay_legmul_beshabaton	,
  	   sug_shaot_nosafot	=sidurim_meyuchadim_tmp_rec.sug_shaot_nosafot,
  	   musachey_mishmeret2	=sidurim_meyuchadim_tmp_rec.musachey_mishmeret2,
	   asur_leshanot_zman_peilut	=sidurim_meyuchadim_tmp_rec. asur_leshanot_zman_peilut	,
	   lo_nidreshet_hityazvut	=sidurim_meyuchadim_tmp_rec.lo_nidreshet_hityazvut	,
	   zakaut_lerezifut_benahagut=sidurim_meyuchadim_tmp_rec.zakaut_lerezifut_benahagut,
	   zakaut_letamriz_nos_nehagut=sidurim_meyuchadim_tmp_rec.zakaut_letamriz_nos_nehagut,
	   hovat_hityazvut	=sidurim_meyuchadim_tmp_rec.hovat_hityazvut	,
	   element1_hova	=sidurim_meyuchadim_tmp_rec.element1_hova,
	   element2_hova	=sidurim_meyuchadim_tmp_rec.element2_hova,
	   element3_hova	=sidurim_meyuchadim_tmp_rec.element3_hova	,
	   bdikat_hityazvut_letachanat_s=sidurim_meyuchadim_tmp_rec.bdikat_hityazvut_letachanat_s,
	   nitan_ledaveach_bmachala_aruc=  sidurim_meyuchadim_tmp_rec.nitan_ledaveach_bmachala_aruc,
	   nizbar_yomit_lehalbasha_nesio     =  sidurim_meyuchadim_tmp_rec.nizbar_yomit_lehalbasha_nesio,
	  tokef_hatchala= to_date(sidurim_meyuchadim_tmp_rec.tokef_hatchala,'dd/mm/yyyy'),
	  tokef_siyum	= to_date(sidurim_meyuchadim_tmp_rec.tokef_siyum,'dd/mm/yyyy'),
	   heara_letiud		=sidurim_meyuchadim_tmp_rec.heara_letiud
 where mispar_sidur=Sidurim_tmp_rec.mispar_sidur
 and me_tarich=Me_Ad_tmp_rec.me_tarich
 and ad_tarich=Me_Ad_tmp_rec.ad_tarich;
END LOOP;
END LOOP;
END LOOP;
END Pivot_Sidurim_Meyuchadim;

/**************************************************************/

PROCEDURE pro_get_yom_viza( p_Cur out CurType) IS
BEGIN

      OPEN p_Cur for
	   SELECT  Y.KOD_YOM_VISA code, Y.TEUR_YOM_VISA description
			FROM  CTB_YOM_VISA Y
			WHERE Y.PAIL='1'
			ORDER BY Y.TEUR_YOM_VISA;

EXCEPTION
    WHEN OTHERS THEN
        RAISE;
END pro_get_yom_viza;

PROCEDURE	pro_get_sug_hazmanat_viza( p_Cur out CurType) IS
BEGIN

      OPEN p_Cur for
	   SELECT S.KOD_HAZMANA   code, S.TEUR_HAZMANA ||  '('  || S.KOD_HAZMANA || ')'  description
			FROM  CTB_SUG_HAZMANA_VISA S
			WHERE S.PAIL='1'
			ORDER BY S.TEUR_HAZMANA;

EXCEPTION
    WHEN OTHERS THEN
        RAISE;
END pro_get_sug_hazmanat_viza;

PROCEDURE	pro_get_kod_mivza_viza( p_Cur out CurType) IS
BEGIN

      OPEN p_Cur for
	   SELECT M.KOD_MIVTZA_VISA  code,M.TEUR_MIVTZA_VISA  description
			FROM  CTB_MIVTZA_VISA M
			WHERE M.PAIL='1'
			ORDER BY M.TEUR_MIVTZA_VISA;


EXCEPTION
    WHEN OTHERS THEN
        RAISE;
END pro_get_kod_mivza_viza;

PROCEDURE	pro_get_lina( p_Cur out CurType) IS
BEGIN

      OPEN p_Cur for
	     SELECT L.KOD_LINA  code,L.TEUR_LINA  description
			FROM  CTB_LINA L
            WHERE L.PAIL='1'
			ORDER BY L.TEUR_LINA;

EXCEPTION
    WHEN OTHERS THEN
        RAISE;
END pro_get_lina;

PROCEDURE ProGetMusach_O_Machsan(p_Taarich  in VARCHAR2, p_Cur out CurType) IS
BEGIN

      OPEN p_Cur for
	     SELECT M.MAHSAN_AHSANA code, M.MAHSAN_AHSANA  description
			FROM  CTB_MAHSANIM M
            WHERE to_date(p_Taarich,'dd/mm/yyyy') Between m.ME_TAARICH_TOKEF and nvl(M.AD_TAARICH_TOKEF,to_date('01/01/4000','dd/mm/yyyy'))
			ORDER BY M.MAHSAN_AHSANA;

EXCEPTION
    WHEN OTHERS THEN
        RAISE;
END ProGetMusach_O_Machsan;

PROCEDURE get_tmp_sidurim_meyuchadim(p_tar_me IN tb_sidurim_meyuchadim.me_taarich%type,
		  									   	  										 p_tar_ad  IN tb_sidurim_meyuchadim.me_taarich%type,
																						 p_Cur OUT CurType) AS
BEGIN
	 OPEN p_cur for
	 	  SELECT ts.mispar_sidur, ts.zakay_lezman_halbasha halbash_kod,
           ts.shat_hatchala_muteret,
          ts.shat_gmar_muteret,
           ts.zakay_michutz_lamichsa,
           ts.sidur_asur_ledaveach_peilut no_peilot_kod,
           ts.asur_ledaveach_mispar_rechev no_oto_no,
           ts.sidur_namlak_visa sidur_visa_kod,
         ts.sector_avoda,
         ts.zakay_lehashlama_avur_sidur hashlama_kod,
       ts.zakay_lechariga, ts.zakay_lehamara ,
      ts.zakay_leaman_nesia,
         ts.hova_ledaveach_peilut peilut_required_kod,
           ts.asur_ledivuach_lechevrot_bat sidur_not_valid_kod,
             ts.hukiyut_beshabaton sidur_not_in_shabton_kod,
          ts.sidur_misug_headrut headrut_type_kod,
         ts.sug_avoda,
          ts.shaon_nochachut,
         ts.mispar_sidur mispar_sidur_myuhad,
          ts.sidur_kaytanot_veruey_kayiz sidur_in_summer,
           ts.lo_letashlum_automati,
		   ts.zakay_lepizul,
          ts.kizuz_al_pi_hatchala_gmar,
		  ts.hovat_hityazvut,
		  ts.hova_ledaveach_mispar_machsan,
		  ts.sidur_lo_nivdak_sofash,
		  ts.nitan_ledaveach_bmachala_aruc
		FROM TMP_SIDURIM_MEYUCHADIM ts
		WHERE  ts.Me_Tarich <=p_tar_me
		AND nvl(ts.AD_TARICH ,to_date('01/01/9999','dd/mm/yyyy'))  >=p_tar_ad;

EXCEPTION
       WHEN OTHERS THEN
				RAISE;
  END get_tmp_sidurim_meyuchadim;
PROCEDURE get_tb_sadot_nosafim_lesidur(p_cur out CurType) IS
BEGIN
    OPEN p_Cur FOR
    SELECT * FROM TB_SADOT_NOSAFIM_LESIDUR;
END  get_tb_sadot_nosafim_lesidur;
PROCEDURE pro_get_meafyeney_sidur(p_cur out CurType) IS
BEGIN
  OPEN p_cur FOR
  SELECT DISTINCT mispar_sidur sidur_key, kod_meafyen,erech from  TB_SIDURIM_MEYUCHADIM
  UNION ALL
  SELECT DISTINCT sug_sidur sidur_key, kod_meafyen,erech from TB_MEAFYENEY_SUG_SIDUR;


END pro_get_meafyeney_sidur;


PROCEDURE Pivot_test IS
CURSOR Sidurim_tmp IS
  SELECT  distinct  mispar_sidur
from   tb_sidurim_meyuchadim
 --where   mispar_sidur between 63473 and 77690
;

CURSOR Me_tarich_tmp(par_sidur number) IS
select distinct me_tarich from
(select distinct p1.me_taarich  me_tarich
from   tb_sidurim_meyuchadim  p1
	where  p1.mispar_sidur=par_sidur
	union all
select distinct   p2.ad_taarich+1 me_tarich
--distinct  nvl(p2.ad_taarich,to_date('31/12/2100','dd/mm/yyyy'))+1 me_tarich
	from   tb_sidurim_meyuchadim p2
	where  p2.mispar_sidur=par_sidur
  -- and p2.ad_taarich<to_date('31/12/2100','dd/mm/yyyy')
   and decode(p2.ad_taarich,to_date('31/12/4712','dd/mm/yyyy'),null, to_date('31/12/2100','dd/mm/yyyy'),null,   p2.ad_taarich) is not null
    --  and not exists( select * from tb_sidurim_meyuchadim p3 where  p3.mispar_sidur=par_sidur
   	--  	   		   		  		 and   p2.ad_taarich+1=p3.me_taarich
	--							 and  p2.mispar_sidur= p3.mispar_sidur);
	)
	order by me_tarich;



BEGIN

FOR  Sidurim_tmp_rec IN  Sidurim_tmp LOOP

FOR  Me_tarich_tmp_rec IN  Me_tarich_tmp(Sidurim_tmp_rec.mispar_sidur) LOOP

 insert into tmp_sidurim_meyuchadim
 (mispar_sidur,me_tarich,ad_tarich)
 values (Sidurim_tmp_rec.mispar_sidur,Me_tarich_tmp_rec.me_tarich,
 ( select distinct least((select   nvl(min(ad_taarich),to_date('31/12/2100','dd/mm/yyyy'))
from   tb_sidurim_meyuchadim
	where  mispar_sidur=Sidurim_tmp_rec.mispar_sidur
	and ad_taarich>=to_date(Me_tarich_tmp_rec.me_tarich,'dd/mm/yyyy'))
	,
	(select nvl(min(me_taarich) - 1,to_date('31/12/2100','dd/mm/yyyy'))
from   tb_sidurim_meyuchadim
	where  mispar_sidur=Sidurim_tmp_rec.mispar_sidur
		 and me_taarich>(select min(me_taarich) from tb_sidurim_meyuchadim where mispar_sidur=Sidurim_tmp_rec.mispar_sidur)
 and  me_taarich>to_date(Me_tarich_tmp_rec.me_tarich,'dd/mm/yyyy') )
	 ,
	 to_date('31/12/2100','dd/mm/yyyy')) ad_tarich
from   tb_sidurim_meyuchadim
	where  mispar_sidur=Sidurim_tmp_rec.mispar_sidur)
 );

END LOOP;

 delete  from  tmp_sidurim_meyuchadim
 where mispar_sidur=Sidurim_tmp_rec.mispar_sidur
 and ad_tarich<to_date('01/01/2008','dd/mm/yyyy');


END LOOP;

END Pivot_test;


PROCEDURE pro_get_siba_lo_letashlum(p_mispar_ishi IN tb_sidurim_ovdim.mispar_ishi%type,p_date IN  tb_sidurim_ovdim.taarich%type, p_mispar_sidur IN tb_sidurim_ovdim.mispar_sidur%type,p_shat_hatchala in varchar2, p_teur_siba out varchar2)
IS
    v_teur_siba ctb_Sibot_LoLetashlum.teur_siba%type;
BEGIN
    v_teur_siba:='';
    SELECT A.TEUR_SIBA into v_teur_siba
    FROM ctb_Sibot_LoLetashlum a, tb_sidurim_ovdim b
    WHERE a.kod_siba = b.Kod_Siba_Lo_Letashlum
    and B.MISPAR_ISHI = p_mispar_ishi
    and trunc(B.TAARICH) = p_date
    and B.MISPAR_SIDUR = p_mispar_sidur
    and B.shat_hatchala = to_date(p_shat_hatchala,'dd/mm/yyyy HH24:MI:SS');

    p_teur_siba := v_teur_siba;
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        p_teur_siba := '';  
END pro_get_siba_lo_letashlum;
END PKG_SIDURIM;
/
CREATE OR REPLACE PACKAGE          PKG_SUG_SIDUR AS
TYPE	CurType	  IS	REF  CURSOR;
PROCEDURE pro_get_data(p_Kod IN VARCHAR2,p_Period in VARCHAR2,p_Cur OUT CurType);
PROCEDURE pro_get_matching_description(p_Prefix in VARCHAR2,  p_Cur OUT CurType);
PROCEDURE pro_get_matching_kod(p_Prefix in VARCHAR2,  p_Cur OUT CurType);
PROCEDURE pro_get_description_by_kod(p_Kod in VARCHAR2,p_Desc out VARCHAR2);
PROCEDURE pro_get_kod_by_description(p_Desc in VARCHAR2,p_Kod out VARCHAR2);
PROCEDURE pro_get_details_Kod(p_Cur OUT CurType );
PROCEDURE pro_get_history(p_FilterKod in varchar2 , p_Kod in VARCHAR2,p_ToDate in VARCHAR2,  p_Cur out Curtype);
PROCEDURE pro_upd_data(p_KodMeafyen number,p_SugSidur number,p_MeTaarich date,p_AdTaarich date,p_Erech VARCHAR2 ,p_SugNatun VARCHAR2,p_comment varchar2, p_taarich_idkun_acharon DATE,p_meadken_acharon NUMBER) ;
PROCEDURE pro_ins_data(p_KodMeafyen number,p_SugSidur number,p_MeTaarich date,p_AdTaarich date,p_Erech VARCHAR2 ,p_SugNatun VARCHAR2,p_comment varchar2, p_taarich_idkun_acharon DATE,p_meadken_acharon NUMBER) ;
PROCEDURE pro_Del_data(p_KodMeafyen number,p_SugSidur number,p_MeTaarich date);

PROCEDURE get_meafyeney_sug_sidur_all(p_tar_me IN TB_Meafyeney_Sug_Sidur.me_taarich%type,
		  									   	  										 p_tar_ad  IN TB_Meafyeney_Sug_Sidur.me_taarich%type,
																						 p_Cur OUT CurType) ;
PROCEDURE calling_Pivot_Meafyeney_S ;
PROCEDURE Pivot_Meafyeney_Sug_Sidur ;

END PKG_SUG_SIDUR; 
/

CREATE OR REPLACE PACKAGE BODY          PKG_SUG_SIDUR AS

  PROCEDURE pro_get_data(p_Kod IN VARCHAR2,p_Period in VARCHAR2,p_Cur OUT CurType) iS
  v_MaxLimitDate Date ;
  v_MinLimitDate date ;
  BEGIN
    v_MinLimitDate := to_date('01/' || p_Period,'dd/mm/yyyy'); /* period= 05/2009=>  v_MinLimitDate = 01/05/2009 */
    v_MaxLimitDate := add_months(v_MinLimitDate,1) -1 ;    /* period= 05/2009=>  v_MaxLimitDate = 31/05/2009 */
    OPEN p_Cur FOR
          SELECT tb.SUG_SIDUR , ctb.Kod_Meafyen,(ctb.Kod_Meafyen||'-'|| ctb.shem_meafyen  || '(' || ctb.SUG_NATUN || ')') DetailsMeafyen , tb.me_taarich, tb.ad_taarich, tb.erech, ctb.sug_natun,tb.Taarich_Idkun_Acharon  LastUpdate,TB.HEARA
          FROM TB_Meafyeney_Sug_Sidur tb
          INNER JOIN ctb_meafyeney_sidurim ctb
          ON ctb.kod_meafyen= tb.kod_meafyen
          WHERE ((tb.Me_Taarich <=  v_MaxLimitDate ) and (tb.Ad_Taarich >= v_MinLimitDate or tb.Ad_Taarich is null ))
          AND tb.SUG_SIDUR = p_Kod AND ctb.PAIL = 1
          ORDER BY   ctb.Kod_Meafyen ;

    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    NULL;
  END pro_get_data;

  PROCEDURE pro_get_matching_description(p_Prefix in VARCHAR2,  p_Cur OUT CurType) AS
  BEGIN
  OPEN p_Cur for
      SELECT TEUR_SIDUR_AVODA  from CTB_SUG_SIDUR SS
      WHERE SS.TEUR_SIDUR_AVODA   LIKE  p_Prefix || '%'
      order by TEUR_SIDUR_AVODA asc ;
    NULL;
  END pro_get_matching_description;

  PROCEDURE pro_get_matching_kod(p_Prefix in VARCHAR2,  p_Cur OUT CurType) AS

  BEGIN
      OPEN p_Cur for
          SELECT KOD_SIDUR_AVODA
          FROM CTB_SUG_SIDUR SS
          WHERE SS.KOD_SIDUR_AVODA   LIKE  p_Prefix || '%'
          ORDER BY KOD_SIDUR_AVODA ASC;
  END pro_get_matching_kod;

  PROCEDURE pro_get_description_by_kod(p_Kod in VARCHAR2,p_Desc out VARCHAR2) AS
  BEGIN
      SELECT  SS.TEUR_SIDUR_AVODA INTO p_desc
      FROM CTB_SUG_SIDUR SS
      WHERE SS.KOD_SIDUR_AVODA = p_Kod;
    EXCEPTION
        WHEN NO_DATA_FOUND THEN
        p_Desc := '';
    NULL;
  END pro_get_description_by_kod;

  PROCEDURE pro_get_kod_by_description(p_Desc in VARCHAR2,p_Kod out VARCHAR2) AS
  BEGIN
      SELECT  SS.KOD_SIDUR_AVODA  INTO p_Kod
      from CTB_SUG_SIDUR SS
      WHERE SS.TEUR_SIDUR_AVODA = p_desc;
    EXCEPTION
        WHEN NO_DATA_FOUND THEN
        p_Kod := '';
  END pro_get_kod_by_description;

  PROCEDURE pro_get_details_Kod(p_Cur OUT CurType ) AS
  BEGIN
      OPEN p_Cur for
      SELECT  SM.KOD_MEAFYEN Kod_Meafyen , ('-' || SM.KOD_MEAFYEN  || SM.SHEM_MEAFYEN || '(' || sm.SUG_NATUN || ')' ) DetailsMeafyen
      FROM CTB_MEAFYENEY_SIDURIM SM
      WHERE SM.PAIL = 1 and (SIDUR_MEYUCHAD_OR_SUG_SIDUR = 1  or SIDUR_MEYUCHAD_OR_SUG_SIDUR = 2)
      order by Kod_Meafyen asc ;

  END pro_get_details_Kod;

  PROCEDURE pro_get_history(p_FilterKod in varchar2 ,p_Kod in VARCHAR2, p_ToDate in VARCHAR2, p_Cur out Curtype) IS
  v_tar_me DATE ;
  BEGIN
      v_tar_me:=to_date(p_ToDate,'dd/mm/yyyy');
  OPEN p_Cur for
      SELECT SM.ME_TAARICH,SM.ad_taarich,SM.erech
      FROM TB_Meafyeney_Sug_Sidur SM
      WHERE SM.kod_meafyen =p_Kod and SM.AD_TAARICH< v_tar_me and SM.SUG_SIDUR = p_filterkod
      ORDER BY SM.ME_TAARICH asc ;
  END pro_get_history;

  PROCEDURE pro_upd_data(p_KodMeafyen number,p_SugSidur number,p_MeTaarich date,p_AdTaarich date,p_Erech VARCHAR2 ,p_SugNatun VARCHAR2,p_comment varchar2, p_taarich_idkun_acharon DATE,p_meadken_acharon NUMBER)  AS
  BEGIN
update TB_Meafyeney_Sug_Sidur SM
    set SM.ERECH = p_Erech ,
        SM.AD_TAARICH = p_AdTaarich ,
          SM.TAARICH_IDKUN_ACHARON = p_taarich_idkun_acharon,
          SM.MEADKEN_ACHARON = p_meadken_acharon,
          SM.HEARA = p_comment
    where SUG_SIDUR = p_SugSidur AND
    ME_TAARICH = p_MeTaarich AND
    KOD_MEAFYEN = p_KodMeafyen;

  END pro_upd_data;

  PROCEDURE pro_ins_data(p_KodMeafyen number,p_SugSidur number,p_MeTaarich date,p_AdTaarich date,p_Erech VARCHAR2 ,p_SugNatun VARCHAR2,p_comment varchar2, p_taarich_idkun_acharon DATE,p_meadken_acharon NUMBER)  AS
  BEGIN
      insert into TB_Meafyeney_Sug_Sidur
    (ad_taarich, erech, kod_meafyen, me_taarich, meadken_acharon, SUG_SIDUR,heara)
    VALUES (p_adtaarich, p_erech, p_kodmeafyen, p_metaarich, p_meadken_acharon, p_SugSidur,p_comment);
  END pro_ins_data;

      PROCEDURE pro_Del_data(p_KodMeafyen number,p_SugSidur number,p_MeTaarich date)  AS
  BEGIN
      Delete TB_Meafyeney_Sug_Sidur
    where SUG_SIDUR = p_SugSidur AND
    ME_TAARICH = p_MeTaarich AND
    KOD_MEAFYEN = p_KodMeafyen;

  END pro_Del_data;


    /*   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0       06/07/2009      sari       1.    */
PROCEDURE get_meafyeney_sug_sidur_all(p_tar_me IN TB_Meafyeney_Sug_Sidur.me_taarich%type,
		  									   	  										 p_tar_ad  IN TB_Meafyeney_Sug_Sidur.me_taarich%type,
																						 p_Cur OUT CurType) AS
BEGIN
	 OPEN p_cur for
	 	  SELECT tb.SUG_SIDUR,tb.me_taarich, nvl(tb.ad_taarich,to_date('01/01/9999','dd/mm/yyyy')) ad_taarich,tb.kod_meafyen, tb.erech
			FROM TB_Meafyeney_Sug_Sidur tb
			WHERE  tb.Me_Taarich <=p_tar_me
			AND nvl(tb.Ad_Taarich,to_date('01/01/9999','dd/mm/yyyy'))  >=p_tar_ad;

EXCEPTION
       WHEN OTHERS THEN
				RAISE;
  END get_meafyeney_sug_sidur_all;
PROCEDURE calling_Pivot_Meafyeney_S IS
  --   v_idkun_tb     date;
  --   v_idkun_tmp   date;

BEGIN
--select max(nvl(s.taarich_idkun_acharon,sysdate)) idkun_tb,
--max(nvl(t.taarich_idkun_acharon,sysdate)) idkun_tmp
--into v_idkun_tb, v_idkun_tmp
--from tb_meafyeney_sug_sidur s, tmp_meafyeney_sug_sidur t;

--if (v_idkun_tb > v_idkun_tmp) then
delete from   tmp_meafyeney_sug_sidur;
PKG_SUG_SIDUR.Pivot_Meafyeney_Sug_Sidur;
--end if;
commit;

END calling_Pivot_Meafyeney_S;
PROCEDURE Pivot_Meafyeney_Sug_Sidur IS

--todo: truncate tmp_sidurim_meyuchadim
CURSOR Sug_Sidurim_tmp IS
SELECT  distinct  mss.sug_sidur
from --  tb_meafyeney_sug_sidur
    tb_meafyeney_sug_sidur mss,ctb_meafyeney_sidurim cms
	 where sidur_meyuchad_or_sug_sidur<>0
	 and mss.kod_meafyen=cms.kod_meafyen
;

CURSOR Me_tarich_tmp(par_sug_sidur number) IS
select distinct me_tarich from (
select distinct p1.me_taarich  me_tarich
from    tb_meafyeney_sug_sidur  p1
	where  p1.sug_sidur=par_sug_sidur
	union all
select distinct   p2.ad_taarich+1 me_tarich
	from   tb_meafyeney_sug_sidur p2
	where  p2.sug_sidur=par_sug_sidur
    and p2.ad_taarich<to_date('31/12/4712','dd/mm/yyyy')
	and p2.ad_taarich is not null
	--and decode(p2.ad_taarich,to_date('31/12/4712','dd/mm/yyyy'),null, to_date('31/12/2100','dd/mm/yyyy'),null,   p2.ad_taarich) is not null
  --    and not exists( select * from tb_meafyeney_sug_sidur p3 where  p3.sug_sidur=par_sug_sidur
  -- 	   	   		   		  		 and   p2.ad_taarich+1=p3.me_taarich
   --							 and  p2.sug_sidur= p3.sug_sidur);
   ) order by me_tarich;


CURSOR Me_Ad_tmp(par_sug_sidur number) IS
select me_tarich,nvl(ad_tarich,to_date('31/12/4712','dd/mm/yyyy')) ad_tarich
from     tmp_meafyeney_sug_sidur
where sug_sidur=par_sug_sidur;

CURSOR meafyeney_sug_sidur_tmp(par_sug_sidur number,p_Dt_from date, p_Dt_to date) IS
select
  sug_sidur, teur,
  --Sug_sidur	 ,
  sector_avoda	 ,sug_premia, mofia_bdoch_nochachut_minhal_u,headrut_hova_ledaveach_shaot,
    shat_hatchala_muteret,
  shat_gmar_muteret,
  hukiyut_beshabaton ,hokiyut_beshishi ,
  sug_hashaot_beyom_shishi,	 sug_hashaot_beyom_shabaton, hova_ledaveach_peilut,
  zakay_leaman_nesia,zakay_lezman_halbasha,  max_shaot_byom_hol	 ,
  sug_shaot_byom_hol_if_migbala,	 max_shaot_byom_shishi	 ,max_shaot_beshabaton	 ,
  asur_2_peiluyot_meoto_sug,hashlama_lemin_shaot_imahu,
  mutar_lebitzua_rak_lemeafyen_x, mutar_lebitzua_rak_lerishyon,avar_hadracha_meyuchedet	,
  zakay_michutz_lamichsa,  zakay_lepizul 	 ,
  nitan_ledaveach_ad_taarich,
  kod_tipul_meyuchad_Baklita,	 kod_tipul_meyuchad_Bashguim,	 kod_tipul_meyuchad_Bachishuv,
  asur_ledivuach_lechevrot_bat	, zakay_lehamara		 ,kod_headrut		 ,zakay_lelina	 ,
  zakay_lechariga,
  hova_ledaveach_mispar_machsan,hova_ledaveach_mispar_musach,
  hova_yom_visa_namlak ,
  asur_divuach_simun_tachograf,	 zakay_lehashlama_avur_sidur ,zakay_lechishuv_retzifut	 ,
  metagber_benihul_tnua,asur_ledaveach_mispar_rechev,
  zarich_ledaveach_km,sidur_namlak_visa,sidur_asur_ledaveach_peilut,
  avodat_musach	,zakaut_lepizul_nehagut	,zakaut_legmul_chisachon,
  sug_avoda,sidur_misug_headrut, shaon_nochachut,
 ein_leshalem_tos_lila,
  max_dakot_boded,
   dakot_n_letashlum_hol,sidur_kaytanot_veruey_kayiz,
  lo_letashlum_automati,kizuz_al_pi_hatchala_gmar,Michsat_shaot_chodshit,
       zakaut_lenosafot	,   lo_pogea_bemichsat_nosafot,   rechiv_lezvira_yomit,
   rechiv_lezvira_chodshit,   max_dakot_nosafot_bechodesh,   zakaut_tamritz_nosafot_minhal,
     michsat_shishi_lebaley_x,  shabaton_tashlum_kavua,	   max_yemey_avoda_bechodesh,
	 kod_ishur_WF	,	   sidur_mishtatel_bechafifa,  tashlum_kavua_beshishi,	   lo_zakay_legmul_beshishi,
	  lo_zakay_legmul_beshabaton,		   sug_shaot_nosafot	,  musachey_mishmeret2,
	  asur_leshanot_zman_peilut,   lo_nidreshet_hityazvut,   zakaut_lerezifut_benahagut,
	  zakaut_letamriz_nos_nehagut,	   tokef_hatchala	,	   tokef_siyum		,   hovat_hityazvut	,   element1_hova	,
	  element2_hova	,   element3_hova	,   bdikat_hityazvut_letachanat_s,     heara_letiud
from (
  select
    sug_sidur,
     max(case when kod_meafyen=1 then nvl(erech,'-1')   else '' end)    teur,
    max(case when  kod_meafyen=3 then nvl(erech,'-1')   else '' end)   sector_avoda,
    max(case when  kod_meafyen=72 then nvl(erech,'-1')   else '' end)   sug_premia,
    max(case when  kod_meafyen=5 then nvl(erech,'-1')   else '' end)   mofia_bdoch_nochachut_minhal_u,
    max(case when  kod_meafyen=6 then nvl(erech,'-1')   else '' end)   headrut_hova_ledaveach_shaot,
    max(case when  kod_meafyen=7 then erech  else  null  end)  shat_hatchala_muteret,
    max(case when  kod_meafyen=8 then erech  else  null end)  shat_gmar_muteret,
    max(case when  kod_meafyen=9 then nvl(erech,'-1')   else '' end)   hukiyut_beshabaton,
    max(case when  kod_meafyen=10 then nvl(erech,'-1')   else '' end) hokiyut_beshishi,
    max(case when  kod_meafyen=11 then nvl(erech,'-1')   else '' end) sug_hashaot_beyom_shishi,
    max(case when  kod_meafyen=12 then nvl(erech,'-1')   else '' end) sug_hashaot_beyom_shabaton,
    max(case when  kod_meafyen=13 then nvl(erech,'-1')   else '' end) hova_ledaveach_peilut,
    max(case when  kod_meafyen=14 then nvl(erech,'-1')   else '' end) zakay_leaman_nesia	 ,
    max(case when  kod_meafyen=15  then nvl(erech,'-1')   else '' end) zakay_lezman_halbasha,
    max(case when  kod_meafyen=16 then nvl(erech,'-1')   else '' end)  max_shaot_byom_hol	 ,
    max(case when  kod_meafyen=17 then nvl(erech,'-1')   else '' end)  sug_shaot_byom_hol_if_migbala,
    max(case when  kod_meafyen=18 then nvl(erech,'-1')   else '' end)  max_shaot_byom_shishi	 ,
    max(case when  kod_meafyen=19 then nvl(erech,'-1')   else '' end)  max_shaot_beshabaton	 ,
    max(case when  kod_meafyen=20 then nvl(erech,'-1')   else '' end)  asur_2_peiluyot_meoto_sug,
    max(case when  kod_meafyen=21 then nvl(erech,'-1')   else '' end)  hashlama_lemin_shaot_imahu,
    max(case when  kod_meafyen=22 then nvl(erech,'-1')   else '' end)  mutar_lebitzua_rak_lemeafyen_x,
    max(case when  kod_meafyen=23 then nvl(erech,'-1')   else '' end)  mutar_lebitzua_rak_lerishyon,
    max(case when  kod_meafyen=24 then nvl(erech,'-1')   else '' end)  avar_hadracha_meyuchedet	,
    max(case when  kod_meafyen=25 then nvl(erech,'-1')   else '' end)  zakay_michutz_lamichsa,
    max(case when  kod_meafyen=26 then nvl(erech,'-1')   else '' end)  zakay_lepizul 	 ,
    max(case when  kod_meafyen=27 then nvl(erech,'-1')   else '' end)  nitan_ledaveach_ad_taarich,
    max(case when  kod_meafyen=28 then nvl(erech,'-1')   else '' end)  kod_tipul_meyuchad_Baklita,
    max(case when  kod_meafyen=29 then nvl(erech,'-1')   else '' end)  kod_tipul_meyuchad_Bashguim,
    max(case when  kod_meafyen=30 then nvl(erech,'-1')   else '' end)  kod_tipul_meyuchad_Bachishuv,
    max(case when  kod_meafyen=31 then nvl(erech,'-1')   else '' end)  asur_ledivuach_lechevrot_bat	,
    max(case when  kod_meafyen=32 then nvl(erech,'-1')   else '' end)  zakay_lehamara		 ,
    max(case when  kod_meafyen=33 then nvl(erech,'-1')   else '' end)  kod_headrut		 ,
    max(case when  kod_meafyen=34 then nvl(erech,'-1')   else '' end)  zakay_lelina	 ,
    max(case when  kod_meafyen=35 then nvl(erech,'-1')   else '' end)  zakay_lechariga,
    max(case when  kod_meafyen=36 then nvl(erech,'-1')   else '' end)  hova_ledaveach_mispar_machsan,
    max(case when  kod_meafyen=37 then nvl(erech,'-1')   else '' end)  hova_ledaveach_mispar_musach,
    max(case when  kod_meafyen=38 then nvl(erech,'-1')   else '' end)  hova_yom_visa_namlak,
    max(case when  kod_meafyen=39 then nvl(erech,'-1')   else '' end)  asur_divuach_simun_tachograf,
    max(case when  kod_meafyen=40 then nvl(erech,'-1')   else '' end)  zakay_lehashlama_avur_sidur ,
    max(case when  kod_meafyen=41 then nvl(erech,'-1')   else '' end)  zakay_lechishuv_retzifut,
	max(case when  kod_meafyen=42 then nvl(erech,'-1')   else '' end)  metagber_benihul_tnua,
    max(case when  kod_meafyen=43 then nvl(erech,'-1')   else '' end)  asur_ledaveach_mispar_rechev,
    max(case when  kod_meafyen=44 then nvl(erech,'-1')   else '' end)  zarich_ledaveach_km,
    max(case when  kod_meafyen=45 then nvl(erech,'-1')   else '' end)  sidur_namlak_visa,
    max(case when  kod_meafyen=46 then nvl(erech,'-1')   else '' end)  sidur_asur_ledaveach_peilut,
	max(case when  kod_meafyen=47 then nvl(erech,'-1')   else '' end)  avodat_musach	,
	max(case when  kod_meafyen=48 then nvl(erech,'-1')   else '' end)  zakaut_lepizul_nehagut	,
	max(case when  kod_meafyen=49 then nvl(erech,'-1')   else '' end)  zakaut_legmul_chisachon,
	max(case when  kod_meafyen=50 then nvl(erech,'-1')   else '' end)      zakaut_lenosafot	,
    max(case when  kod_meafyen=51 then nvl(erech,'-1')   else '' end)	  lo_pogea_bemichsat_nosafot,
    max(case when  kod_meafyen=52 then nvl(erech,'-1')   else '' end)  sug_avoda,
    max(case when  kod_meafyen=53 then nvl(erech,'-1')   else '' end)  sidur_misug_headrut,
    max(case when  kod_meafyen=54 then nvl(erech,'-1')   else '' end)  shaon_nochachut,
    max(case when  kod_meafyen=55 then nvl(erech,'-1')   else '' end)	   rechiv_lezvira_yomit,
    max(case when  kod_meafyen=56 then nvl(erech,'-1')   else '' end)	   rechiv_lezvira_chodshit,
	max(case when  kod_meafyen=57 then nvl(erech,'-1')   else '' end)  Michsat_shaot_chodshit,
    max(case when  kod_meafyen=58 then nvl(erech,'-1')   else '' end)	   max_dakot_nosafot_bechodesh,
    max(case when  kod_meafyen=59 then nvl(erech,'-1')   else '' end)	   zakaut_tamritz_nosafot_minhal,
    max(case when  kod_meafyen=60 then nvl(erech,'-1')   else '' end)  max_dakot_boded,
    max(case when  kod_meafyen=61 then nvl(erech,'-1')   else '' end)  ein_leshalem_tos_lila,
	max(case when  kod_meafyen=62 then nvl(erech,'-1')   else '' end)  dakot_n_letashlum_hol,
    max(case when  kod_meafyen=63 then nvl(erech,'-1')   else '' end)	   michsat_shishi_lebaley_x,
    max(case when  kod_meafyen=64 then nvl(erech,'-1')   else '' end)       shabaton_tashlum_kavua,
    max(case when  kod_meafyen=65 then nvl(erech,'-1')   else '' end)  	   max_yemey_avoda_bechodesh,
    max(case when  kod_meafyen=66 then nvl(erech,'-1')   else '' end)  	   kod_ishur_WF	,
    max(case when  kod_meafyen=67 then nvl(erech,'-1')   else '' end)  	   sidur_mishtatel_bechafifa,
    max(case when  kod_meafyen=68 then nvl(erech,'-1')   else '' end)  	   tashlum_kavua_beshishi,
    max(case when  kod_meafyen=69 then nvl(erech,'-1')   else '' end)  	   lo_zakay_legmul_beshishi,
    max(case when  kod_meafyen=70 then nvl(erech,'-1')   else '' end)  	   lo_zakay_legmul_beshabaton,
    max(case when  kod_meafyen=71 then nvl(erech,'-1')   else '' end)  	   sug_shaot_nosafot	,
    max(case when  kod_meafyen=73 then nvl(erech,'-1')   else '' end)  sidur_kaytanot_veruey_kayiz,
    max(case when  kod_meafyen=74 then nvl(erech,'-1')   else '' end)  	   musachey_mishmeret2,
    max(case when  kod_meafyen=75 then nvl(erech,'-1')   else '' end)	   asur_leshanot_zman_peilut,
    max(case when  kod_meafyen=76 then nvl(erech,'-1')   else '' end)	   lo_nidreshet_hityazvut,
    max(case when  kod_meafyen=77 then nvl(erech,'-1')   else '' end)	   zakaut_lerezifut_benahagut,
	max(case when  kod_meafyen=78 then nvl(erech,'-1')   else '' end)  kizuz_al_pi_hatchala_gmar,
	max(case when  kod_meafyen=79 then nvl(erech,'-1')   else '' end)  lo_letashlum_automati,
    max(case when  kod_meafyen=80 then nvl(erech,'-1')   else '' end)	   zakaut_letamriz_nos_nehagut,
	max(case when  kod_meafyen=81 then erech  else  null  end)   tokef_hatchala	 ,
	max(case when  kod_meafyen=82 then erech  else  null  end)   tokef_siyum	 ,
    max(case when  kod_meafyen=83 then nvl(erech,'-1')   else '' end)	   hovat_hityazvut	,
    max(case when  kod_meafyen=93 then nvl(erech,'-1')   else '' end)	   element1_hova	,
    max(case when  kod_meafyen=94 then nvl(erech,'-1')   else '' end)	   element2_hova	,
    max(case when  kod_meafyen=95 then nvl(erech,'-1')   else '' end)	   element3_hova	,
    max(case when  kod_meafyen=96 then nvl(erech,'-1')   else '' end)	   bdikat_hityazvut_letachanat_s,
	max(case when  kod_meafyen=99 then nvl(erech,'-1')   else '' end)	  heara_letiud
  from
     tb_meafyeney_sug_sidur
	where sug_sidur=par_sug_sidur
				and ((p_Dt_from <= me_taarich  and  p_Dt_to >= me_taarich  and p_Dt_to <= nvl(ad_taarich,to_date('31/12/4712','dd/mm/yyyy')))
	 or  (p_Dt_from <= me_taarich  and p_Dt_to >= nvl(ad_taarich,to_date('31/12/4712','dd/mm/yyyy')))
     or (p_Dt_from >= me_taarich  and  p_Dt_from <= nvl(ad_taarich,to_date('31/12/4712','dd/mm/yyyy')) and p_Dt_to >= nvl(ad_taarich,to_date('31/12/4712','dd/mm/yyyy')))
	 or (p_Dt_from >= me_taarich   and  p_Dt_to <= nvl(ad_taarich,to_date('31/12/4712','dd/mm/yyyy'))))
--	and ((to_date(p_Dt_from,'dd/mm/yyyy') <= me_taarich  and to_date(p_Dt_to,'dd/mm/yyyy') >= me_taarich  and to_date(p_Dt_to,'dd/mm/yyyy') <= nvl(ad_taarich,to_date('31/12/4712','dd/mm/yyyy')))
--	 or  (to_date(p_Dt_from,'dd/mm/yyyy') <= me_taarich  and to_date(p_Dt_to,'dd/mm/yyyy') >= nvl(ad_taarich,to_date('31/12/4712','dd/mm/yyyy')))
 --    or (to_date(p_Dt_from,'dd/mm/yyyy') >= me_taarich  and to_date(p_Dt_from,'dd/mm/yyyy') <= nvl(ad_taarich,to_date('31/12/4712','dd/mm/yyyy')) and to_date(p_Dt_to,'dd/mm/yyyy') >= nvl(ad_taarich,to_date('31/12/4712','dd/mm/yyyy')))
--	 or (to_date(p_Dt_from,'dd/mm/yyyy') >= me_taarich   and to_date(p_Dt_to,'dd/mm/yyyy') <= nvl(ad_taarich,to_date('31/12/4712','dd/mm/yyyy'))))
	 group by
   sug_sidur);

BEGIN

FOR  Sug_Sidurim_tmp_rec IN  Sug_Sidurim_tmp LOOP

FOR  Me_tarich_tmp_rec IN  Me_tarich_tmp(Sug_Sidurim_tmp_rec.sug_sidur) LOOP

 insert into  tmp_meafyeney_sug_sidur
 (sug_sidur,me_tarich,ad_tarich)
 values (Sug_Sidurim_tmp_rec.sug_sidur,Me_tarich_tmp_rec.me_tarich,
 ( select distinct least((select   nvl(min(ad_taarich),to_date('31/12/4712','dd/mm/yyyy'))
from    tb_meafyeney_sug_sidur
	where  sug_sidur=Sug_Sidurim_tmp_rec.sug_sidur
	and ad_taarich>=Me_tarich_tmp_rec.me_tarich)
	,
	(select nvl(min(me_taarich) - 1,to_date('31/12/4712','dd/mm/yyyy'))
from    tb_meafyeney_sug_sidur
	where  sug_sidur=Sug_Sidurim_tmp_rec.sug_sidur
		 and me_taarich>(select min(me_taarich) from  tb_meafyeney_sug_sidur where sug_sidur=Sug_Sidurim_tmp_rec.sug_sidur)
 and  me_taarich>Me_tarich_tmp_rec.me_tarich )
	 ,
	 to_date('31/12/4712','dd/mm/yyyy')) ad_tarich
from    tb_meafyeney_sug_sidur
	where  sug_sidur=Sug_Sidurim_tmp_rec.sug_sidur)
 );

END LOOP;

 delete  from   tmp_meafyeney_sug_sidur
 where sug_sidur=Sug_Sidurim_tmp_rec.sug_sidur
 and ad_tarich<to_date('01/01/2008','dd/mm/yyyy');


 FOR  Me_Ad_tmp_rec IN  Me_Ad_tmp(Sug_Sidurim_tmp_rec.sug_sidur) LOOP

 FOR  meafyeney_sug_sidur_tmp_rec IN  meafyeney_sug_sidur_tmp(Sug_Sidurim_tmp_rec.sug_sidur,
 Me_Ad_tmp_rec.me_tarich,Me_Ad_tmp_rec.ad_tarich)
 LOOP
 update   tmp_meafyeney_sug_sidur
 set  teur=meafyeney_sug_sidur_tmp_rec.teur,
 	  sug_premia=meafyeney_sug_sidur_tmp_rec.sug_premia,
	 shat_hatchala_muteret= to_date(meafyeney_sug_sidur_tmp_rec.shat_hatchala_muteret,'hh24:mi'),
 	 shat_gmar_muteret= to_date(meafyeney_sug_sidur_tmp_rec.shat_gmar_muteret,'hh24:mi'),
 	  hova_ledaveach_peilut=meafyeney_sug_sidur_tmp_rec.hova_ledaveach_peilut,
 	  zakay_lezman_halbasha=meafyeney_sug_sidur_tmp_rec.zakay_lezman_halbasha,
 	  asur_2_peiluyot_meoto_sug=meafyeney_sug_sidur_tmp_rec.asur_2_peiluyot_meoto_sug,
 	  mutar_lebitzua_rak_lmeafyen_x	=meafyeney_sug_sidur_tmp_rec.mutar_lebitzua_rak_lemeafyen_x,
      mutar_lebitzua_rak_lerishyon=meafyeney_sug_sidur_tmp_rec.mutar_lebitzua_rak_lerishyon,
      zakay_michutz_lamichsa=meafyeney_sug_sidur_tmp_rec.zakay_michutz_lamichsa,
	  nitan_ledaveach_ad_taarich=meafyeney_sug_sidur_tmp_rec.nitan_ledaveach_ad_taarich,
	  zakay_lechariga=meafyeney_sug_sidur_tmp_rec.zakay_lechariga,
	  hova_ledaveach_mispar_machsan=meafyeney_sug_sidur_tmp_rec.hova_ledaveach_mispar_machsan,
	  hova_ledaveach_mispar_musach=meafyeney_sug_sidur_tmp_rec.hova_ledaveach_mispar_musach,
	  hova_yom_visa_namlak=meafyeney_sug_sidur_tmp_rec.hova_yom_visa_namlak,
      Sug_sidur	=meafyeney_sug_sidur_tmp_rec.sug_sidur,
      sector_avoda	=meafyeney_sug_sidur_tmp_rec.sector_avoda,
      mofia_bdoch_nochachut_minhal_u=meafyeney_sug_sidur_tmp_rec.mofia_bdoch_nochachut_minhal_u,
      headrut_hova_ledaveach_shaot=meafyeney_sug_sidur_tmp_rec.headrut_hova_ledaveach_shaot,
      hukiyut_beshabaton=meafyeney_sug_sidur_tmp_rec.hukiyut_beshabaton,
      hokiyut_beshishi=meafyeney_sug_sidur_tmp_rec.hokiyut_beshishi,
      sug_hashaot_beyom_shishi	=meafyeney_sug_sidur_tmp_rec.sug_hashaot_beyom_shishi	,
      sug_hashaot_beyom_shabaton =meafyeney_sug_sidur_tmp_rec.sug_hashaot_beyom_shabaton ,
      zakay_leaman_nesia	=meafyeney_sug_sidur_tmp_rec.zakay_leaman_nesia,
      max_shaot_byom_hol	=meafyeney_sug_sidur_tmp_rec.max_shaot_byom_hol,
      sug_shaot_byom_hol_if_migbala	=meafyeney_sug_sidur_tmp_rec.sug_shaot_byom_hol_if_migbala	,
      max_shaot_byom_shishi	=meafyeney_sug_sidur_tmp_rec.max_shaot_byom_shishi	,
      max_shaot_beshabaton	=meafyeney_sug_sidur_tmp_rec.max_shaot_beshabaton	,
      hashlama_lemin_shaot_imahu	=meafyeney_sug_sidur_tmp_rec.hashlama_lemin_shaot_imahu,
      avar_hadracha_meyuchedet	=meafyeney_sug_sidur_tmp_rec.avar_hadracha_meyuchedet	,
      zakay_lepizul 	=meafyeney_sug_sidur_tmp_rec.zakay_lepizul ,
      kod_tipul_meyuchad_Baklita	=meafyeney_sug_sidur_tmp_rec.kod_tipul_meyuchad_Baklita,
      kod_tipul_meyuchad_Bashguim	=meafyeney_sug_sidur_tmp_rec.kod_tipul_meyuchad_Bashguim	,
      kod_tipul_meyuchad_Bachishuv	=meafyeney_sug_sidur_tmp_rec.kod_tipul_meyuchad_Bachishuv,
      asur_ledivuach_lechevrot_bat	=meafyeney_sug_sidur_tmp_rec.asur_ledivuach_lechevrot_bat,
      zakay_lehamara		=meafyeney_sug_sidur_tmp_rec.zakay_lehamara,
      kod_headrut		=meafyeney_sug_sidur_tmp_rec.kod_headrut	,
      zakay_lelina	=meafyeney_sug_sidur_tmp_rec.zakay_lelina,
      asur_divuach_simun_tachograf	=meafyeney_sug_sidur_tmp_rec.asur_divuach_simun_tachograf,
      zakay_lehashlama_avur_sidur=meafyeney_sug_sidur_tmp_rec.zakay_lehashlama_avur_sidur,
      zakay_lechishuv_retzifut	=meafyeney_sug_sidur_tmp_rec.zakay_lechishuv_retzifut,
	  metagber_benihul_tnua=meafyeney_sug_sidur_tmp_rec.metagber_benihul_tnua,
	  zarich_ledaveach_km=meafyeney_sug_sidur_tmp_rec.zarich_ledaveach_km,
      asur_ledaveach_mispar_rechev =meafyeney_sug_sidur_tmp_rec.asur_ledaveach_mispar_rechev,
      sidur_namlak_visa  =meafyeney_sug_sidur_tmp_rec.sidur_namlak_visa,
      sidur_asur_ledaveach_peilut=meafyeney_sug_sidur_tmp_rec.sidur_asur_ledaveach_peilut,
	  avodat_musach	=meafyeney_sug_sidur_tmp_rec.avodat_musach,
	  zakaut_lepizul_nehagut	=meafyeney_sug_sidur_tmp_rec.zakaut_lepizul_nehagut,
	  zakaut_legmul_chisachon=meafyeney_sug_sidur_tmp_rec.zakaut_legmul_chisachon,
	  sug_avoda  =meafyeney_sug_sidur_tmp_rec.sug_avoda,
      sidur_misug_headrut =meafyeney_sug_sidur_tmp_rec.sidur_misug_headrut,
	   shaon_nochachut  =meafyeney_sug_sidur_tmp_rec.shaon_nochachut,
     ein_leshalem_tos_lila=meafyeney_sug_sidur_tmp_rec.ein_leshalem_tos_lila,
	  max_dakot_boded= meafyeney_sug_sidur_tmp_rec.max_dakot_boded,
	   dakot_n_letashlum_hol= meafyeney_sug_sidur_tmp_rec. dakot_n_letashlum_hol,
      sidur_kaytanot_veruey_kayiz=meafyeney_sug_sidur_tmp_rec.sidur_kaytanot_veruey_kayiz,
	  kizuz_al_pi_hatchala_gmar=meafyeney_sug_sidur_tmp_rec.kizuz_al_pi_hatchala_gmar,
	  lo_letashlum_automati=meafyeney_sug_sidur_tmp_rec.lo_letashlum_automati,
	  Michsat_shaot_chodshit=meafyeney_sug_sidur_tmp_rec.Michsat_shaot_chodshit,
      zakaut_lenosafot	=meafyeney_sug_sidur_tmp_rec.zakaut_lenosafot,
	  lo_pogea_bemichsat_nosafot	=meafyeney_sug_sidur_tmp_rec.lo_pogea_bemichsat_nosafot,
	   rechiv_lezvira_yomit	=meafyeney_sug_sidur_tmp_rec.rechiv_lezvira_yomit,
	   rechiv_lezvira_chodshit	=meafyeney_sug_sidur_tmp_rec.rechiv_lezvira_chodshit	,
	   max_dakot_nosafot_bechodesh	=meafyeney_sug_sidur_tmp_rec.max_dakot_nosafot_bechodesh,
	   zakaut_tamritz_nosafot_minhal=meafyeney_sug_sidur_tmp_rec.zakaut_tamritz_nosafot_minhal,
	   michsat_shishi_lebaley_x=meafyeney_sug_sidur_tmp_rec.michsat_shishi_lebaley_x,
       shabaton_tashlum_kavua	=meafyeney_sug_sidur_tmp_rec.shabaton_tashlum_kavua,
  	   max_yemey_avoda_bechodesh	=meafyeney_sug_sidur_tmp_rec.max_yemey_avoda_bechodesh,
  	   kod_ishur_WF=meafyeney_sug_sidur_tmp_rec. kod_ishur_WF,
  	   sidur_mishtatel_bechafifa=meafyeney_sug_sidur_tmp_rec.sidur_mishtatel_bechafifa,
  	   tashlum_kavua_beshishi	=meafyeney_sug_sidur_tmp_rec. tashlum_kavua_beshishi,
  	   lo_zakay_legmul_beshishi=meafyeney_sug_sidur_tmp_rec.lo_zakay_legmul_beshishi,
  	   lo_zakay_legmul_beshabaton	=meafyeney_sug_sidur_tmp_rec. lo_zakay_legmul_beshabaton	,
  	   sug_shaot_nosafot	=meafyeney_sug_sidur_tmp_rec.sug_shaot_nosafot,
  	   musachey_mishmeret2	=meafyeney_sug_sidur_tmp_rec.musachey_mishmeret2,
	   asur_leshanot_zman_peilut	=meafyeney_sug_sidur_tmp_rec. asur_leshanot_zman_peilut	,
	   lo_nidreshet_hityazvut	=meafyeney_sug_sidur_tmp_rec.lo_nidreshet_hityazvut	,
	   zakaut_lerezifut_benahagut=meafyeney_sug_sidur_tmp_rec.zakaut_lerezifut_benahagut,
	   zakaut_letamriz_nos_nehagut=meafyeney_sug_sidur_tmp_rec.zakaut_letamriz_nos_nehagut,
	   hovat_hityazvut	=meafyeney_sug_sidur_tmp_rec.hovat_hityazvut	,
	   element1_hova	=meafyeney_sug_sidur_tmp_rec.element1_hova,
	   element2_hova	=meafyeney_sug_sidur_tmp_rec.element2_hova,
	   element3_hova	=meafyeney_sug_sidur_tmp_rec.element3_hova	,
	   bdikat_hityazvut_letachanat_s=meafyeney_sug_sidur_tmp_rec.bdikat_hityazvut_letachanat_s,
	   tokef_hatchala= to_date(meafyeney_sug_sidur_tmp_rec.tokef_hatchala,'hh24:mi'),
	   tokef_siyum	= to_date(meafyeney_sug_sidur_tmp_rec.tokef_siyum,'hh24:mi'),
	   heara_letiud		=meafyeney_sug_sidur_tmp_rec.heara_letiud
	    where sug_sidur=Sug_Sidurim_tmp_rec.sug_sidur
 and me_tarich=Me_Ad_tmp_rec.me_tarich
 and ad_tarich=Me_Ad_tmp_rec.ad_tarich;
END LOOP;
END LOOP;
END LOOP;
END Pivot_Meafyeney_Sug_Sidur;


END PKG_SUG_SIDUR; 
/
CREATE OR REPLACE PACKAGE          PKG_SYSMAN AS

/******************************************************************************
   NAME:       PKG_UTILS
   PURPOSE: Provide Cursors for Selecting, Inserting and Updating
                      System Manager tables

   REVISIONS:
   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        01/06/2009       Gregory      1. Created this package.
   1.1        01/06/2009       Gregory      1. get_yamim_meyuchadim.
   1.2        01/06/2009       Gregory      1. get_sugey_yamim_meyuchadim.
******************************************************************************/
TYPE	CurType	  IS	REF  CURSOR;

PROCEDURE get_yamim_meyuchadim(p_Cur OUT CurType);
PROCEDURE get_sugey_yamim_meyuchadim(p_Cur OUT CurType);
PROCEDURE get_sugey_yamim_minhal(p_Cur OUT CurType);
PROCEDURE get_sugey_yamim_meshek(p_Cur OUT CurType);
PROCEDURE get_sugey_yamim_nehagut(p_Cur OUT CurType);
PROCEDURE get_sugey_yamim_tnua(p_Cur OUT CurType);
PROCEDURE get_sugey_yamim_meyuchadim(Sug_Yom number,p_Cur OUT CurType);
PROCEDURE update_yamim_meyuchadim(p_taarich DATE,p_sug_yom NUMBER, p_sug_yom_muchlaf_minhal NUMBER,
    p_sug_yom_muchlaf_meshek NUMBER,
    p_sug_yom_muchlaf_nehagut NUMBER,
    p_sug_yom_muchlaf_tnua NUMBER,p_pail NUMBER,p_taarich_idkun_acharon DATE,p_meadken_acharon NUMBER);
PROCEDURE insert_yamim_meyuchadim(p_taarich DATE,p_sug_yom NUMBER, p_sug_yom_muchlaf_minhal NUMBER,
    p_sug_yom_muchlaf_meshek NUMBER,
    p_sug_yom_muchlaf_nehagut NUMBER,
    p_sug_yom_muchlaf_tnua NUMBER,p_pail NUMBER,p_taarich_idkun_acharon DATE,p_meadken_acharon NUMBER);
PROCEDURE get_kategoria_tavla(p_kod_kategoria NUMBER,p_Cur OUT CurType);
PROCEDURE get_michsa_yomit(p_Cur OUT CurType);
PROCEDURE update_michsa_yomit(p_kod_michsa NUMBER,p_michsa NUMBER,p_shavoa_avoda NUMBER,p_me_taarich DATE,p_ad_taarich DATE,p_sug_yom NUMBER,p_meadken_acharon NUMBER);
PROCEDURE insert_michsa_yomit(p_kod_michsa NUMBER,p_michsa NUMBER,p_shavoa_avoda NUMBER,p_me_taarich DATE,p_ad_taarich DATE,p_sug_yom NUMBER,p_meadken_acharon NUMBER);
PROCEDURE get_zman_nesia_mishtane(p_Cur OUT CurType);
PROCEDURE update_zman_nesia_mishtane(p_merkaz_erua NUMBER,p_mikum_yaad NUMBER,p_dakot NUMBER,p_me_taarich DATE,p_ad_taarich DATE,p_meadken_acharon NUMBER);
PROCEDURE insert_zman_nesia_mishtane(p_merkaz_erua NUMBER,p_mikum_yaad NUMBER,p_dakot NUMBER,p_me_taarich DATE,p_ad_taarich DATE,p_meadken_acharon NUMBER);
PROCEDURE get_merkaz_eroa(p_Cur OUT CurType);
PROCEDURE get_mikum_yaad(p_Cur OUT CurType);
PROCEDURE get_agaf(p_Cur OUT CurType);
PROCEDURE get_masach(p_Cur OUT CurType);
PROCEDURE get_masach_Bugim(p_Cur OUT CurType);
PROCEDURE get_hodaa(p_masach_id number,p_Cur OUT CurType);
PROCEDURE get_Profil(p_Cur OUT CurType);
PROCEDURE get_Sug_Erech(p_Cur OUT CurType);
PROCEDURE get_Ishurim(p_Cur OUT CurType);
PROCEDURE get_Rechivim(p_Cur OUT CurType);
PROCEDURE get_sibot_ledivuch_yadani(p_Cur OUT CurType);
PROCEDURE update_sibot_ledivuch_yadani(p_kod_siba NUMBER,p_teur_siba VARCHAR2,p_goremet_lebitul_znam_nesiaa VARCHAR2,p_bitul_znam_halbasha VARCHAR2,p_meadken_acharon NUMBER);
PROCEDURE insert_sibot_ledivuch_yadani(p_kod_siba NUMBER,p_teur_siba VARCHAR2,p_goremet_lebitul_zman_nesiaa VARCHAR2,p_bitul_zman_halbasha VARCHAR2,p_meadken_acharon NUMBER);
PROCEDURE S_CTB_DARGAT_RISHAYON
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE I_CTB_DIVUCH_HARIGA_MESHAOT
              (
              P_KOD_DIVUCH                    NUMBER              ,
			   P_TEUR_DIVUCH                   VARCHAR2  ,
               P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE S_CTB_DIVUCH_HARIGA_MESHAOT
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_DIVUCH_HARIGA_MESHAOT
              (
               P_KOD_DIVUCH                    NUMBER              ,
			   P_TEUR_DIVUCH                   VARCHAR2  ,
               P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE S_CTB_ELEMENTIM
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE S_CTB_EZOR
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE I_CTB_HARSHAA
              (
               P_KOD_HARSHAA                   NUMBER              ,
			   P_TEUR_HARSHAA                  VARCHAR2,
               P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE S_CTB_HARSHAA
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_HARSHAA
              (
              P_KOD_HARSHAA                   NUMBER              ,
			   P_TEUR_HARSHAA                  VARCHAR2,
               P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE I_CTB_HAZMANA_MEYUCHEDET
              (
               P_KOD_HAZMANA                   NUMBER              ,
			   P_TEUR_HAZMANA                  VARCHAR2            ,
			   P_ZMAN_LETASHLUM                NUMBER ,
               P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE S_CTB_HAZMANA_MEYUCHEDET
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_HAZMANA_MEYUCHEDET
              (
               P_KOD_HAZMANA                   NUMBER              ,
			   P_TEUR_HAZMANA                  VARCHAR2            ,
			   P_ZMAN_LETASHLUM                NUMBER ,
               P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE I_CTB_HEAROT_RECHIVIM
              (
               P_KOD_RECHIV                    NUMBER              ,
               P_HEARA                         VARCHAR2            ,
               P_MUTAM_BITACHON                NUMBER              ,
               P_PAIL                          CHAR ,
			   P_TAARICH_IDKUN_ACHARON  Date ,
			   P_MEADKEN_ACHARON		          Number
              )
              ;
PROCEDURE S_CTB_HEAROT_RECHIVIM
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_HEAROT_RECHIVIM
              (
               P_KOD_RECHIV                    NUMBER              ,
               P_HEARA                         VARCHAR2            ,
               P_MUTAM_BITACHON                NUMBER              ,
               P_PAIL                          CHAR ,
			   P_TAARICH_IDKUN_ACHARON  Date ,
			   P_MEADKEN_ACHARON		          Number
              )
              ;
PROCEDURE I_CTB_HISTAYGUT
              (
               P_KOD_HISTAYGUT                 NUMBER              ,
               P_NAHAG_RASHAI_LEASHER          VARCHAR2            ,
               P_PAIL                          VARCHAR2            ,
               P_TEUR_HISTAYGUT                VARCHAR2
              )
              ;
PROCEDURE S_CTB_HISTAYGUT
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_HISTAYGUT
              (
               P_KOD_HISTAYGUT                 NUMBER              ,
               P_NAHAG_RASHAI_LEASHER          VARCHAR2            ,
               P_PAIL                          VARCHAR2            ,
               P_TEUR_HISTAYGUT                VARCHAR2
              )
              ;
PROCEDURE S_CTB_ISUK
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE I_CTB_KODIM_MEYUCHADIM_LEIDKUN
              (
              P_KOD_IDKUN                     NUMBER              ,
               P_TEUR_IDKUN                    VARCHAR2,
			   P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE S_CTB_KODIM_MEYUCHADIM_LEIDKUN
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_KODIM_MEYUCHADIM_LEIDKUN
              (
              P_KOD_IDKUN                     NUMBER              ,
               P_TEUR_IDKUN                    VARCHAR2,
			   P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE S_CTB_KOD_GIL
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE I_CTB_KOD_KVUZAT_NESIAA
              (
               P_KOD_KVUZAT_NESIAA             NUMBER              ,
               P_TEUR_KVUZAT_NESIAA            VARCHAR2 ,
			   P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE S_CTB_KOD_KVUZAT_NESIAA
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_KOD_KVUZAT_NESIAA
              (
               P_KOD_KVUZAT_NESIAA             NUMBER              ,
               P_TEUR_KVUZAT_NESIAA            VARCHAR2 ,
			   P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE I_CTB_KOD_PEILUT
              (
               P_KOD_SECTOR_PEILUT             VARCHAR2            ,
			   P_TEUR_SECTOR_PEILUT 			   VARCHAR2            ,
               P_PAIL                          VARCHAR2,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE S_CTB_KOD_PEILUT
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_KOD_PEILUT
              (
               P_KOD_SECTOR_PEILUT             VARCHAR2            ,
			   P_TEUR_SECTOR_PEILUT 			   VARCHAR2            ,
               P_PAIL                          VARCHAR2,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE I_CTB_LINA
              (
                P_KOD_LINA                      NUMBER              ,
               P_TEUR_LINA                     VARCHAR2  ,
			   P_PAIL                          CHAR                ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE S_CTB_LINA
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_LINA
              (
               P_KOD_LINA                      NUMBER              ,
               P_TEUR_LINA                     VARCHAR2  ,
			   P_PAIL                          CHAR                ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE S_CTB_MAAMAD
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE S_CTB_MEAFYEN_BITZUA
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE S_CTB_MUTAMUT
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE I_CTB_NATUN_HR
              (
               P_KOD_NATUN                     NUMBER              ,
               P_TEUR_NATUN                    VARCHAR2,
			   P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE S_CTB_NATUN_HR
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_NATUN_HR
              (
               P_KOD_NATUN                     NUMBER              ,
               P_TEUR_NATUN                    VARCHAR2,
			   P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE S_CTB_NKUDUT_TIFAUL
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE I_CTB_PITZUL_HAFSAKA
              (
                P_KOD_PIZUL_HAFSAKA             NUMBER              ,
			   P_TEUR_PIZUL_HAFSAKA            VARCHAR2 ,
               P_PAIL                          CHAR                ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
                )
              ;
PROCEDURE S_CTB_PITZUL_HAFSAKA
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_PITZUL_HAFSAKA
              (
               P_KOD_PIZUL_HAFSAKA             NUMBER              ,
			   P_TEUR_PIZUL_HAFSAKA            VARCHAR2 ,
               P_PAIL                          CHAR                ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
                )
              ;
PROCEDURE I_CTB_PROFIL
              (
              P_KOD_PROFIL                    NUMBER              ,
               P_TEUR_PROFIL                   VARCHAR2 ,
			   P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE S_CTB_PROFIL
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_PROFIL
              (
              P_KOD_PROFIL                    NUMBER              ,
               P_TEUR_PROFIL                   VARCHAR2 ,
			   P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE I_CTB_SECTOR_ISUK
              (
               P_KOD_SECTOR_ISUK               NUMBER,
               P_TEUR_SECTOR_ISUK              VARCHAR2
              )
              ;
PROCEDURE S_CTB_SECTOR_ISUK
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_SECTOR_ISUK
              (
               P_KOD_SECTOR_ISUK               NUMBER,
               P_TEUR_SECTOR_ISUK              VARCHAR2
              )
              ;
PROCEDURE I_CTB_SECTOR_VISA
              (
               P_KOD_SECTOR_VISA               NUMBER              ,
               P_TEUR_SECTOR_VISA              VARCHAR2,
			   P_PAIL                          CHAR                ,
			   p_taarich_idkun_acharon DATE,
			   p_meadken_acharon NUMBER
              )
              ;
PROCEDURE S_CTB_SECTOR_VISA
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_SECTOR_VISA
              (
               P_KOD_SECTOR_VISA               NUMBER              ,
               P_TEUR_SECTOR_VISA              VARCHAR2,
			   P_PAIL                          CHAR                ,
			   p_taarich_idkun_acharon DATE,
			   p_meadken_acharon NUMBER
              )
              ;
PROCEDURE I_CTB_SHGIOT
              (
               P_KOD_SHGIA                     NUMBER              ,
			   P_TEUR_SHGIA                    VARCHAR2 ,
			   P_RAMA                          NUMBER              ,
			   P_NATUN_LEBDIKA		 VARCHAR2,
			   P_ISHUR_RASHEMET                NUMBER              ,
               P_KOD_ISHUR                     NUMBER              ,
               P_PAIL                          VARCHAR2            ,
 			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE S_CTB_SHGIOT
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_SHGIOT
              (
               P_KOD_SHGIA                     NUMBER              ,
			   P_TEUR_SHGIA                    VARCHAR2 ,
			   P_RAMA                          NUMBER              ,
			   P_NATUN_LEBDIKA		 VARCHAR2,
			   P_ISHUR_RASHEMET                NUMBER              ,
               P_KOD_ISHUR                     NUMBER              ,
               P_PAIL                          VARCHAR2            ,
 			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE I_CTB_SIBOT_HASHLAMA_LEYOM
              (
               P_KOD_SIBA                      NUMBER              ,
               P_TEUR_SIBA                     VARCHAR2,
               P_LETZUGA                       NUMBER              ,
               P_PAIL                          CHAR                ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE S_CTB_SIBOT_HASHLAMA_LEYOM
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_SIBOT_HASHLAMA_LEYOM
              (
               P_KOD_SIBA                      NUMBER              ,
               P_TEUR_SIBA                     VARCHAR2,
               P_LETZUGA                       NUMBER              ,
               P_PAIL                          CHAR                ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE I_CTB_SIBOT_LEDIVUCH_YADANI
              (
               P_KOD_SIBA                      NUMBER              ,
			   P_TEUR_SIBA                   VARCHAR2,
			   P_GOREMET_LEBITUL_Z_NESIAA   NUMBER ,
			   P_GOREMET_LEBITUL_Z_HALBASHA NUMBER              ,
               P_PAIL                          VARCHAR2            ,
			   P_MUTZDAK 					   NUMBER              ,
			   P_DORESH_ISHUR         VARCHAR2,
         P_TAARICH_IDKUN_ACHARON         DATE,
			   P_MEADKEN_ACHARON               NUMBER
              )
              ;
PROCEDURE S_CTB_SIBOT_LEDIVUCH_YADANI
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_SIBOT_LEDIVUCH_YADANI
              (
               P_KOD_SIBA                      NUMBER              ,
			   P_TEUR_SIBA                   VARCHAR2,
			   P_GOREMET_LEBITUL_Z_NESIAA   NUMBER   ,
			   P_GOREMET_LEBITUL_Z_HALBASHA NUMBER              ,
               P_PAIL                          VARCHAR2            ,
			   P_MUTZDAK 					   NUMBER              ,
			   P_DORESH_ISHUR         VARCHAR2,
         P_TAARICH_IDKUN_ACHARON         DATE,
			   P_MEADKEN_ACHARON               NUMBER
              )
              ;
PROCEDURE I_CTB_SIBOT_LOLETASHLUM
              (
              P_KOD_SIBA                      NUMBER              ,
			   P_TEUR_SIBA                     VARCHAR2 ,
               P_PAIL                          CHAR                ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE S_CTB_SIBOT_LOLETASHLUM
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_SIBOT_LOLETASHLUM
              (
               P_KOD_SIBA                      NUMBER              ,
			   P_TEUR_SIBA                     VARCHAR2 ,
               P_PAIL                          CHAR                ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE I_CTB_SIDURIM_MEYUCHADIM
              (
               P_KOD_SIDUR_MEYUCHAD            NUMBER              ,
               P_TEUR_SIDUR_MEYCHAD            VARCHAR2,
			   P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
               P_KOD_SIDUR_MEYUCHAD_YASHAN      NUMBER  ,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE S_CTB_SIDURIM_MEYUCHADIM
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_SIDURIM_MEYUCHADIM
              (
                P_KOD_SIDUR_MEYUCHAD            NUMBER              ,
               P_TEUR_SIDUR_MEYCHAD            VARCHAR2,
			   P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
               P_KOD_SIDUR_MEYUCHAD_YASHAN      NUMBER  ,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE S_CTB_SNIFEY_MASHAR
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE S_CTB_SNIFEY_TNUAA
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE S_CTB_SNIF_AV
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE S_CTB_STATUS
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE I_CTB_STATUS_KARTIS
              (
               P_KOD_STATUS_KARTIS             NUMBER              ,
			   P_TEUR_STATUS_KARTIS            VARCHAR2,
               P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE S_CTB_STATUS_KARTIS
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_STATUS_KARTIS
              (
                P_KOD_STATUS_KARTIS             NUMBER              ,
			   P_TEUR_STATUS_KARTIS            VARCHAR2,
               P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE I_CTB_SUGEY_HEADRUYUT
              (
                P_KOD_HEADRUT                   NUMBER              ,
               P_TEUR_HEADRUT                  VARCHAR2 ,
			   P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE S_CTB_SUGEY_HEADRUYUT
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_SUGEY_HEADRUYUT
              (
               P_KOD_HEADRUT                   NUMBER              ,
               P_TEUR_HEADRUT                  VARCHAR2 ,
			   P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE I_CTB_SUGEY_PREMIOT
              (
               P_KOD_PREMIA                    NUMBER              ,
               P_TEUR_PREMIA                   VARCHAR2,
			   P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE S_CTB_SUGEY_PREMIOT
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_SUGEY_PREMIOT
              (
               P_KOD_PREMIA                    NUMBER              ,
               P_TEUR_PREMIA                   VARCHAR2,
			   P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE I_CTB_SUGEY_YAMIM_MEYUCHADIM
              (
			   P_SUG_YOM                       NUMBER              ,
               P_TEUR_YOM                      VARCHAR2            ,
               P_TEUR_YOM_MEKUZAR              VARCHAR2            ,
               P_YOM_AVODA                     CHAR   ,
			   P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE S_CTB_SUGEY_YAMIM_MEYUCHADIM
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_SUGEY_YAMIM_MEYUCHADIM
              (
 			    P_SUG_YOM                       NUMBER              ,
               P_TEUR_YOM                      VARCHAR2            ,
               P_TEUR_YOM_MEKUZAR              VARCHAR2            ,
               P_YOM_AVODA                     CHAR   ,
			   P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE I_CTB_SUG_AVODA
              (
               P_KOD_SUG_AVODA                 NUMBER              ,
               P_PAIL                          VARCHAR2            ,
               P_TEUR_SUG_AVODA                VARCHAR2
              )
              ;
PROCEDURE S_CTB_SUG_AVODA
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_SUG_AVODA
              (
               P_KOD_SUG_AVODA                 NUMBER              ,
               P_PAIL                          VARCHAR2            ,
               P_TEUR_SUG_AVODA                VARCHAR2
              )
              ;
PROCEDURE I_CTB_SUG_BAKASHA
              (
               P_KOD_SUG_BAKASHA               NUMBER              ,
			   P_TEUR_SUG_BAKASHA              VARCHAR2,
               P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE S_CTB_SUG_BAKASHA
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_SUG_BAKASHA
              (
               P_KOD_SUG_BAKASHA               NUMBER              ,
			   P_TEUR_SUG_BAKASHA              VARCHAR2,
               P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE I_CTB_SUG_HAZMANA_VISA
              (
               P_KOD_HAZMANA                   NUMBER              ,
               --P_PAIL                          CHAR                ,
               P_TEUR_HAZMANA                  VARCHAR2            ,
               P_TEUR_HAZMANA_MEKUZAR          VARCHAR2,
			   P_Pail  						               VARCHAR2,
			   p_taarich_idkun_acharon DATE,
			   p_meadken_acharon NUMBER
              )
              ;
PROCEDURE S_CTB_SUG_HAZMANA_VISA
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_SUG_HAZMANA_VISA
              (
               P_KOD_HAZMANA                   NUMBER              ,
               --P_PAIL                          CHAR                ,
               P_TEUR_HAZMANA                  VARCHAR2            ,
               P_TEUR_HAZMANA_MEKUZAR          VARCHAR2,
			   P_Pail  						               VARCHAR2,
			   p_taarich_idkun_acharon DATE,
			   p_meadken_acharon NUMBER
              )
              ;
PROCEDURE S_CTB_SUG_MISRA
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE I_CTB_SUG_PARAM_BAKASHOT
              (
               P_KOD_SUG_PARAM                 NUMBER              ,
               P_PAIL                          VARCHAR2            ,
               P_TEUR_SUG_PARAM                VARCHAR2
              )
              ;
PROCEDURE S_CTB_SUG_PARAM_BAKASHOT
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_SUG_PARAM_BAKASHOT
              (
               P_KOD_SUG_PARAM                 NUMBER              ,
               P_PAIL                          VARCHAR2            ,
               P_TEUR_SUG_PARAM                VARCHAR2
              )
              ;
PROCEDURE S_CTB_SUG_SIDUR
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE I_CTB_TFKIDIM_MEASHRIM
              (
               P_KOD_TAFKID_MEASHER            NUMBER              ,
               P_TEUR_TAFKID_MEASHER           VARCHAR2
              )
              ;
PROCEDURE S_CTB_TFKIDIM_MEASHRIM
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_TFKIDIM_MEASHRIM
              (
               P_KOD_TAFKID_MEASHER            NUMBER              ,
               P_TEUR_TAFKID_MEASHER           VARCHAR2
              )
              ;
PROCEDURE S_CTB_YECHIDA
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE I_CTB_ZMANEY_HALBASHA
              (
               P_KOD_ZMAN_HALBASHA             NUMBER              ,
               P_PAIL                          VARCHAR2            ,
               P_TEUR_ZMAN_HALBASHA            VARCHAR2
              )
              ;
PROCEDURE S_CTB_ZMANEY_HALBASHA
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_ZMANEY_HALBASHA
              (
               P_KOD_ZMAN_HALBASHA             NUMBER              ,
               P_PAIL                          VARCHAR2            ,
               P_TEUR_ZMAN_HALBASHA            VARCHAR2
              )
              ;
PROCEDURE I_CTB_ZMANEY_NESIAA
              (
              P_KOD_ZMAN_NESIAA               NUMBER              ,
               P_TEUR_ZMAN_NESIAA              VARCHAR2,
			   P_PAIL                          CHAR                ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE S_CTB_ZMANEY_NESIAA
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_ZMANEY_NESIAA
              (
               P_KOD_ZMAN_NESIAA               NUMBER              ,
               P_TEUR_ZMAN_NESIAA              VARCHAR2,
			   P_PAIL                          CHAR                ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE I_CTB_ZMAN_NSIAA_MISHTANE
              (
               P_MERKAZ_ERUA                   NUMBER              ,
			   P_MIKUM_YAAD                    NUMBER ,
               P_DAKOT                         NUMBER              ,
               P_ME_TAARICH                    DATE                ,
			   P_AD_TAARICH                    DATE,
			   P_TAARICH_IDKUN_ACHARON         DATE,
			   P_MEADKEN_ACHARON               NUMBER
              )
              ;
PROCEDURE S_CTB_ZMAN_NSIAA_MISHTANE
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_ZMAN_NSIAA_MISHTANE
              (
               P_MERKAZ_ERUA                   NUMBER              ,
			   P_MIKUM_YAAD                    NUMBER ,
               P_DAKOT                         NUMBER              ,
               P_ME_TAARICH                    DATE                ,
			   P_AD_TAARICH                    DATE,
			   P_TAARICH_IDKUN_ACHARON         DATE,
			   P_MEADKEN_ACHARON               NUMBER
              )
              ;
PROCEDURE I_CTB_ISHURIM
              (
              P_KOD_ISHUR                     NUMBER              ,
			   P_TEUR_ISHUR                    VARCHAR2,
               P_MEAKEV_TASHLUM                NUMBER              ,
               P_PAIL                          VARCHAR2            ,
			  P_MAFNE_LESADE     VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE S_CTB_ISHURIM
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_ISHURIM
              (
              P_KOD_ISHUR                     NUMBER              ,
			   P_TEUR_ISHUR                    VARCHAR2,
               P_MEAKEV_TASHLUM                NUMBER              ,
               P_PAIL                          VARCHAR2            ,
			  P_MAFNE_LESADE     VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE I_CTB_MEAFYENEY_ELEMENTIM
              (
 			   P_KOD_MEAFYEN                   NUMBER              ,
               P_SHEM_MEAFYEN                  VARCHAR2            ,
               P_SUG_NATUN                     VARCHAR2      ,
			   P_PAIL                          CHAR                ,
			   P_KOD_SUG_ERECH                   NUMBER              ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE S_CTB_MEAFYENEY_ELEMENTIM
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_MEAFYENEY_ELEMENTIM
              (
               P_KOD_MEAFYEN                   NUMBER              ,
               P_SHEM_MEAFYEN                  VARCHAR2            ,
	           P_SUG_NATUN                     VARCHAR2      ,
			   P_PAIL                         char               ,
			   P_KOD_SUG_ERECH                   NUMBER              ,
               P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE I_CTB_MEAFYENEY_SIDURIM
              (
               P_KOD_MEAFYEN                   NUMBER              ,
			   P_SHEM_MEAFYEN                  VARCHAR2            ,
			   P_TEUR_MEAFYEN                  VARCHAR2 ,
			   P_SUG_NATUN                     VARCHAR2            ,
			   P_SIDUR_MEYUCHAD_OR_SUG_SIDUR   NUMBER              ,
			   P_PAIL                          CHAR                ,
               P_KOD_SUG_ERECH                   NUMBER              ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              );
PROCEDURE S_CTB_MEAFYENEY_SIDURIM
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_MEAFYENEY_SIDURIM
              (
               P_KOD_MEAFYEN                   NUMBER              ,
			   P_SHEM_MEAFYEN                  VARCHAR2            ,
			   P_TEUR_MEAFYEN                  VARCHAR2 ,
			   P_SUG_NATUN                     VARCHAR2            ,
			   P_SIDUR_MEYUCHAD_OR_SUG_SIDUR   NUMBER              ,
			   P_PAIL                          CHAR                ,
			   P_KOD_SUG_ERECH                   NUMBER              ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE I_CTB_PARAMETRIM
              (
               P_KOD_PARAM                     NUMBER              ,
			   P_TEUR_PARAM                    VARCHAR2 ,
			   P_SUG_NATUN                     VARCHAR2            ,
               P_PAIL                          VARCHAR2            ,
			   P_KOD_SUG_ERECH                   NUMBER              ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE S_CTB_PARAMETRIM
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_PARAMETRIM
              (
               P_KOD_PARAM                     NUMBER              ,
			   P_TEUR_PARAM                    VARCHAR2 ,
			   P_SUG_NATUN                     VARCHAR2            ,
               P_PAIL                          VARCHAR2            ,
			   P_KOD_SUG_ERECH                   NUMBER              ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE I_CTB_RECHIVIM
              (
 			   P_KOD_RECHIV                    NUMBER              ,
			   P_TEUR_RECHIV                   VARCHAR2,
               P_LETZUGA_BESIKUM_CHODSHI       NUMBER,
               P_MIYUN_BESIKUM_CHODSHI         NUMBER              ,
			   P_LETZUGA_BETIHKUR_RASHEMET Number,
			   P_KOD_HEADRUT_CLALI Number,
			   P_YESH_HEARA Number,
               P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE S_CTB_RECHIVIM
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_RECHIVIM
              (
 			   P_KOD_RECHIV                    NUMBER              ,
			   P_TEUR_RECHIV                   VARCHAR2,
               P_LETZUGA_BESIKUM_CHODSHI       NUMBER,
               P_MIYUN_BESIKUM_CHODSHI         NUMBER              ,
			   P_LETZUGA_BETIHKUR_RASHEMET Number,
			   P_KOD_HEADRUT_CLALI Number,
			   P_YESH_HEARA Number,
               P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE I_TB_MICHSA_AGAPIT
              (
               P_KOD_AGAF                      NUMBER              ,
               P_ME_TAARICH                    DATE                ,
               P_AD_TAARICH                    DATE,
               P_MICHSA_AGAPIT                 NUMBER,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE S_TB_MICHSA_AGAPIT
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_TB_MICHSA_AGAPIT
              (
 			   P_KOD_AGAF                      NUMBER              ,
               P_ME_TAARICH                    DATE                ,
               P_AD_TAARICH                    DATE,
               P_MICHSA_AGAPIT                 NUMBER,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE I_TB_MICHSA_YOMIT
              (
                   P_KOD_MICHSA                    NUMBER              ,
				   P_SUG_YOM                       NUMBER,
  				   P_SHAVOA_AVODA                  NUMBER              ,
                   P_ME_TAARICH                    DATE                ,
               	   P_AD_TAARICH                    DATE,
              	   P_MICHSA                        NUMBER,
				   P_TAARICH_IDKUN_ACHARON         DATE,
			   	   P_MEADKEN_ACHARON               NUMBER
              )
              ;
PROCEDURE S_TB_MICHSA_YOMIT
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_TB_MICHSA_YOMIT
              (
                   P_KOD_MICHSA                    NUMBER              ,
				   P_SUG_YOM                       NUMBER,
  				   P_SHAVOA_AVODA                  NUMBER              ,
                   P_ME_TAARICH                    DATE                ,
               	   P_AD_TAARICH                    DATE,
              	   P_MICHSA                        NUMBER,
				   P_TAARICH_IDKUN_ACHARON         DATE,
			   	   P_MEADKEN_ACHARON               NUMBER
              )
              ;
PROCEDURE I_TB_YAMIM_MEYUCHADIM
              (
               P_SUG_YOM                       NUMBER              ,
               P_SUG_YOM_MUCHLAF_MESHEK        NUMBER              ,
               P_SUG_YOM_MUCHLAF_MINHAL        NUMBER              ,
               P_SUG_YOM_MUCHLAF_NEHAGUT       NUMBER              ,
               P_SUG_YOM_MUCHLAF_TNUA          NUMBER              ,
               P_TAARICH                       DATE
              )
              ;
PROCEDURE S_TB_YAMIM_MEYUCHADIM
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_TB_YAMIM_MEYUCHADIM
              (
               P_SUG_YOM                       NUMBER              ,
               P_SUG_YOM_MUCHLAF_MESHEK        NUMBER              ,
               P_SUG_YOM_MUCHLAF_MINHAL        NUMBER              ,
               P_SUG_YOM_MUCHLAF_NEHAGUT       NUMBER              ,
               P_SUG_YOM_MUCHLAF_TNUA          NUMBER              ,
               P_TAARICH                       DATE
              )
              ;
PROCEDURE S_OVDIM_IM_SHINUY_HR
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE I_CTB_MERKAZ_EROA
              (
               P_KOD_MERKAZ_EROA               NUMBER              ,
			   P_TEUR_MERKAZ_EROA              VARCHAR2 ,
               P_KOD_MERKAZ_EROA_EZORI         NUMBER              ,
               P_PAIL                          CHAR                ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE S_CTB_MERKAZ_EROA
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_MERKAZ_EROA
              (
                P_KOD_MERKAZ_EROA               NUMBER              ,
			   P_TEUR_MERKAZ_EROA              VARCHAR2 ,
               P_KOD_MERKAZ_EROA_EZORI         NUMBER              ,
               P_PAIL                          CHAR                ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE I_CTB_MIKUM_YECHIDA
              (
               P_KOD_MIKUM_YECHIDA             NUMBER              ,
               P_TEUR_MIKUM_YECHIDA            VARCHAR2 ,
			   P_Kod_mikum_yechida_ezori		   NUMBER,
			   P_Pail							     VARCHAR2 ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE S_CTB_MIKUM_YECHIDA
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_MIKUM_YECHIDA
              (
                P_KOD_MIKUM_YECHIDA             NUMBER              ,
               P_TEUR_MIKUM_YECHIDA            VARCHAR2 ,
			   P_Kod_mikum_yechida_ezori		   NUMBER,
			   P_Pail							     VARCHAR2 ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
              ;
PROCEDURE I_CTB_MIVTZA_VISA
              (
               P_KOD_MIVTZA_VISA               NUMBER              ,
               P_TEUR_MIVTZA_VISA              VARCHAR2,
			   P_PAIL                          VARCHAR2            ,
			   p_taarich_idkun_acharon DATE,
			   P_meadken_acharon            NUMBER
              )
              ;
PROCEDURE S_CTB_MIVTZA_VISA
              (
               P_CUR OUT         CURTYPE
              )
              ;
PROCEDURE U_CTB_MIVTZA_VISA
              (
               P_KOD_MIVTZA_VISA               NUMBER              ,
               P_TEUR_MIVTZA_VISA              VARCHAR2  ,
			   P_PAIL                          VARCHAR2            ,
			   p_taarich_idkun_acharon DATE,
			   p_meadken_acharon NUMBER
              )
              ;
PROCEDURE I_CTB_STATUS_BAKASHA
              (
               P_KOD_STATUS_BAKASHA            NUMBER              ,
               P_MEADKEN_ACHARON               NUMBER              ,
               P_TEUR_STATUS_BAKASHA           VARCHAR2            ,
               P_PAIL                          VARCHAR2
              )
              ;
PROCEDURE S_CTB_STATUS_BAKASHA
              (
               P_KOD_STATUS_BAKASHA            NUMBER              ,
               P_TAARICH_IDKUN_ACHARON         DATE                ,
               P_MEADKEN_ACHARON               NUMBER              ,
               P_TEUR_STATUS_BAKASHA           VARCHAR2            ,
               P_PAIL                          VARCHAR2    ,
               P_CUR OUT          CURTYPE
              )
              ;
PROCEDURE U_CTB_STATUS_BAKASHA
              (
               P_KOD_STATUS_BAKASHA            NUMBER              ,
               P_TAARICH_IDKUN_ACHARON         DATE                ,
               P_MEADKEN_ACHARON               NUMBER              ,
               P_TEUR_STATUS_BAKASHA           VARCHAR2            ,
               P_PAIL                          VARCHAR2
              )
              ;
PROCEDURE I_CTB_SUG_AVODA_BEVISA
              (
               P_KOD_SUG_AVODA_BEVISA          NUMBER              ,
               --P_MEADKEN_ACHARON               NUMBER              ,
               P_TEUR_SUG_AVODA_BEVISA         VARCHAR2,
			   P_Pail  						               VARCHAR2,
			   p_taarich_idkun_acharon DATE,
			   p_meadken_acharon NUMBER
              )
              ;
PROCEDURE S_CTB_SUG_AVODA_BEVISA
              (
              --Tammy  P_KOD_SUG_AVODA_BEVISA          NUMBER              ,
               --P_MEADKEN_ACHARON               NUMBER              ,
               --P_TAARICH_IDKUN_ACHARON         DATE                ,
               --P_TEUR_SUG_AVODA_BEVISA         VARCHAR2           ,
               P_CUR OUT          CURTYPE
              )
              ;
PROCEDURE U_CTB_SUG_AVODA_BEVISA
              (
               P_KOD_SUG_AVODA_BEVISA          NUMBER              ,
               P_TEUR_SUG_AVODA_BEVISA         VARCHAR2,
			   P_Pail  						               VARCHAR2,
			   p_taarich_idkun_acharon DATE,
			   p_meadken_acharon NUMBER
              )
              ;
PROCEDURE I_CTB_SUG_VISA_HOFSHIT
              (
               P_KOD_VISA                      NUMBER              ,
               --P_MEADKEN_ACHARON               NUMBER              ,
               P_TEUR_VISA                     VARCHAR2,
			   P_Pail  						               VARCHAR2,
			   p_taarich_idkun_acharon DATE,
			   p_meadken_acharon NUMBER
              )
              ;
PROCEDURE S_CTB_SUG_VISA_HOFSHIT
              (
               --Tammy P_KOD_VISA                      NUMBER              ,
               --P_MEADKEN_ACHARON               NUMBER              ,
               --P_TAARICH_IDKUN_ACHARON         DATE                ,
               --P_TEUR_VISA                     VARCHAR2        ,
               P_CUR OUT          CURTYPE
              )
              ;
PROCEDURE U_CTB_SUG_VISA_HOFSHIT
              (
               P_KOD_VISA                      NUMBER              ,
               --P_MEADKEN_ACHARON               NUMBER              ,
               --P_TAARICH_IDKUN_ACHARON         DATE                ,
               P_TEUR_VISA                     VARCHAR2 ,
			   P_Pail  						               VARCHAR2,
			   p_taarich_idkun_acharon DATE,
			   p_meadken_acharon NUMBER
              )
              ;
PROCEDURE I_CTB_YOM_VISA
              (
               P_KOD_YOM_VISA                  NUMBER              ,
               --P_MEADKEN_ACHARON               NUMBER              ,
               P_TEUR_YOM_VISA                 VARCHAR2 ,
			   P_Pail						   			 		    VARCHAR2 ,
               P_TAARICH_IDKUN_ACHARON         DATE,
			   P_MEADKEN_ACHARON               NUMBER
              )
              ;
PROCEDURE S_CTB_YOM_VISA
              (
               --Tammy P_KOD_YOM_VISA                  NUMBER              ,
               --P_MEADKEN_ACHARON               NUMBER              ,
               --P_TAARICH_IDKUN_ACHARON         DATE                ,
               --P_TEUR_YOM_VISA                 VARCHAR2         ,
               P_CUR OUT          CURTYPE
              )
              ;
PROCEDURE U_CTB_YOM_VISA
              (
               P_KOD_YOM_VISA                  NUMBER              ,
               --P_MEADKEN_ACHARON               NUMBER              ,
               --P_TAARICH_IDKUN_ACHARON         DATE                ,
               P_TEUR_YOM_VISA                 VARCHAR2  ,
			   P_Pail						   			 		    VARCHAR2 ,
               P_TAARICH_IDKUN_ACHARON         DATE,
			   P_MEADKEN_ACHARON               NUMBER
              )
              ;
PROCEDURE I_CTB_RAMOT_ISHURIM
              (
               P_KOD_ISHUR                     NUMBER              ,
               P_RAMA                          NUMBER              ,
               P_KOD_TAFKID_MEASHER            NUMBER              ,
               P_PAIL                          CHAR                ,
               P_MEADKEN_ACHARON               NUMBER
              )
              ;
PROCEDURE S_CTB_RAMOT_ISHURIM
              (
               P_KOD_ISHUR                     NUMBER              ,
               P_RAMA                          NUMBER              ,
               P_KOD_TAFKID_MEASHER            NUMBER              ,
               P_PAIL                          CHAR                ,
               P_TAARICH_IDKUN_ACHARON         DATE                ,
               P_MEADKEN_ACHARON               NUMBER   ,
               P_CUR OUT          CURTYPE
              )
              ;
PROCEDURE U_CTB_RAMOT_ISHURIM
              (
               P_KOD_ISHUR                     NUMBER              ,
               P_RAMA                          NUMBER              ,
               P_KOD_TAFKID_MEASHER            NUMBER              ,
               P_PAIL                          CHAR                ,
               P_TAARICH_IDKUN_ACHARON         DATE                ,
               P_MEADKEN_ACHARON               NUMBER
              )
              ;
PROCEDURE S_TB_BAKASHOT_PARAMS
              (
               P_BAKASHA_ID                    NUMBER              ,
               P_PARAM_ID                      NUMBER              ,
               P_ERECH                         VARCHAR2         ,
               P_CUR OUT          CURTYPE
              )
              ;
PROCEDURE I_TB_HARSHAOT_MASACHIM
              (
               P_MASACH_ID                     NUMBER              ,
               P_PAKAD_ID                      NUMBER              ,
               P_KOD_PROFIL                    NUMBER              ,
               P_KOD_HARSHAA                   NUMBER
              )
              ;
PROCEDURE S_TB_HARSHAOT_MASACHIM
              (
               P_MASACH_ID                     NUMBER              ,
               P_PAKAD_ID                      NUMBER              ,
               P_KOD_PROFIL                    NUMBER              ,
               P_KOD_HARSHAA                   NUMBER     ,
               P_CUR OUT          CURTYPE
              )
              ;
PROCEDURE U_TB_HARSHAOT_MASACHIM
              (
               P_MASACH_ID                     NUMBER              ,
               P_PAKAD_ID                      NUMBER              ,
               P_KOD_PROFIL                    NUMBER              ,
               P_KOD_HARSHAA                   NUMBER
              )
              ;
PROCEDURE I_TB_HODAOT
              (
               P_KOD_HODAA                     NUMBER              ,
			   P_MELEL_HODAA                   VARCHAR2 ,
               P_MASACH_ID                     NUMBER              ,
               P_ME_TAARICH                    DATE                ,
               P_AD_TAARICH                    DATE              ,
			   P_TAARICH_IDKUN_ACHARON         DATE,
			   P_MEADKEN_ACHARON               NUMBER
              )
              ;
PROCEDURE S_TB_HODAOT
              (
               -- TammyP_KOD_HODAA                     NUMBER              ,
               --P_MASACH_ID                     NUMBER              ,
               --P_ME_TAARICH                    DATE                ,
               ---P_AD_TAARICH                    DATE                ,
               --P_MELEL_HODAA                   VARCHAR2         ,
               P_CUR OUT          CURTYPE
              )
              ;
PROCEDURE U_TB_HODAOT
              (
               P_KOD_HODAA                     NUMBER              ,
			   P_MELEL_HODAA                   VARCHAR2 ,
               P_MASACH_ID                     NUMBER              ,
               P_ME_TAARICH                    DATE                ,
               P_AD_TAARICH                    DATE               ,
			   P_TAARICH_IDKUN_ACHARON         DATE,
			   P_MEADKEN_ACHARON               NUMBER
              )
              ;
PROCEDURE I_TB_HODAOT_LEPROFIL
              (
                P_KOD_PROFIL                    NUMBER,
        	   P_KOD_HODAA                     NUMBER              ,
               p_MASACH_ID  Number,
			   P_TAARICH_IDKUN_ACHARON         DATE,
			   P_MEADKEN_ACHARON               NUMBER
              )
              ;
PROCEDURE S_TB_HODAOT_LEPROFIL
              (
               -- Tammy P_KOD_HODAA                     NUMBER              ,
               --P_KOD_PROFIL                    NUMBER           ,
               P_CUR OUT          CURTYPE
              )
              ;
PROCEDURE U_TB_HODAOT_LEPROFIL
              (
                 P_KOD_PROFIL                    NUMBER,
               P_KOD_HODAA                     NUMBER              ,
             p_MASACH_ID  Number,
			   P_TAARICH_IDKUN_ACHARON         DATE,
			   P_MEADKEN_ACHARON               NUMBER
              )
              ;
PROCEDURE S_TB_LOG_BAKASHOT
              (
               P_MISPAR_SIDURI                 NUMBER              ,
               P_BAKASHA_ID                    NUMBER              ,
               P_TAARICH_IDKUN_ACHARON         DATE                ,
               P_SUG_HODAA                     VARCHAR2            ,
               P_KOD_TAHALICH                  VARCHAR2            ,
               P_KOD_YESHUT                    NUMBER              ,
               P_MISPAR_ISHI                   NUMBER              ,
               P_TAARICH                       DATE                ,
               P_MISPAR_SIDUR                  NUMBER              ,
               P_SHAT_HATCHALA_SIDUR           DATE                ,
               P_SHAT_YETZIA                   DATE                ,
               P_MISPAR_KNISA                  NUMBER              ,
               P_KOD_HODAA                     NUMBER              ,
               P_TEUR_HODAA                    VARCHAR2            ,
               P_CUR OUT          CURTYPE
              )
              ;
PROCEDURE I_TB_MASACH
              (
               P_MASACH_ID                     NUMBER              ,
               P_PAKAD_ID                      NUMBER              ,
               P_SHEM                          CHAR                ,
               P_SUG                           NUMBER              ,
               P_TEUR                          VARCHAR2
              )
              ;
PROCEDURE S_TB_MASACH
              (
               P_MASACH_ID                     NUMBER              ,
               P_PAKAD_ID                      NUMBER              ,
               P_SHEM                          CHAR                ,
               P_SUG                           NUMBER              ,
               P_TEUR                          VARCHAR2          ,
               P_CUR OUT          CURTYPE
              )
              ;
PROCEDURE U_TB_MASACH
              (
               P_MASACH_ID                     NUMBER              ,
               P_PAKAD_ID                      NUMBER              ,
               P_SHEM                          CHAR                ,
               P_SUG                           NUMBER              ,
               P_TEUR                          VARCHAR2
              )
              ;
PROCEDURE I_TB_MEAFYENEY_SUG_SIDUR
              (
               P_SUG_SIDUR                     NUMBER              ,
               P_ME_TAARICH                    DATE                ,
               P_AD_TAARICH                    DATE                ,
               P_KOD_MEAFYEN                   NUMBER              ,
               P_ERECH                         VARCHAR2            ,
               P_MEADKEN_ACHARON               NUMBER              ,
               P_HEARA                         VARCHAR2
              )
              ;
PROCEDURE S_TB_MEAFYENEY_SUG_SIDUR
              (
               P_SUG_SIDUR                     NUMBER              ,
               P_ME_TAARICH                    DATE                ,
               P_AD_TAARICH                    DATE                ,
               P_KOD_MEAFYEN                   NUMBER              ,
               P_ERECH                         VARCHAR2            ,
               P_TAARICH_IDKUN_ACHARON         DATE                ,
               P_MEADKEN_ACHARON               NUMBER              ,
               P_HEARA                         VARCHAR2           ,
               P_CUR OUT          CURTYPE
              )
              ;
PROCEDURE U_TB_MEAFYENEY_SUG_SIDUR
              (
               P_SUG_SIDUR                     NUMBER              ,
               P_ME_TAARICH                    DATE                ,
               P_AD_TAARICH                    DATE                ,
               P_KOD_MEAFYEN                   NUMBER              ,
               P_ERECH                         VARCHAR2            ,
               P_TAARICH_IDKUN_ACHARON         DATE                ,
               P_MEADKEN_ACHARON               NUMBER              ,
               P_HEARA                         VARCHAR2
              )
              ;
PROCEDURE I_TB_SIDURIM_MEYUCHADIM_RECHIV
              (
               P_MISPAR_SIDUR                  NUMBER              ,
               P_ME_TAARICH                    DATE                ,
               P_AD_TAARICH                    DATE                ,
               P_KOD_RECHIV                    NUMBER              ,
               P_MEADKEN_ACHARON               NUMBER
              )
              ;
PROCEDURE S_TB_SIDURIM_MEYUCHADIM_RECHIV
              (
               P_MISPAR_SIDUR                  NUMBER              ,
               P_ME_TAARICH                    DATE                ,
               P_AD_TAARICH                    DATE                ,
               P_KOD_RECHIV                    NUMBER              ,
               P_TAARICH_IDKUN_ACHARON         DATE                ,
               P_MEADKEN_ACHARON               NUMBER              ,
               P_CUR OUT          CURTYPE
              )
              ;
PROCEDURE U_TB_SIDURIM_MEYUCHADIM_RECHIV
              (
               P_MISPAR_SIDUR                  NUMBER              ,
               P_ME_TAARICH                    DATE                ,
               P_AD_TAARICH                    DATE                ,
               P_KOD_RECHIV                    NUMBER              ,
               P_TAARICH_IDKUN_ACHARON         DATE                ,
               P_MEADKEN_ACHARON               NUMBER
              )
              ;
PROCEDURE I_TB_SUG_SIDUR_RECHIV
              (
               P_SUG_SIDUR                     NUMBER              ,
               P_ME_TAARICH                    DATE                ,
               P_AD_TAARICH                    DATE                ,
               P_KOD_RECHIV                    NUMBER              ,
               P_MEADKEN_ACHARON               NUMBER
              )
              ;
PROCEDURE S_TB_SUG_SIDUR_RECHIV
              (
               P_SUG_SIDUR                     NUMBER              ,
               P_ME_TAARICH                    DATE                ,
               P_AD_TAARICH                    DATE                ,
               P_KOD_RECHIV                    NUMBER              ,
               P_TAARICH_IDKUN_ACHARON         DATE                ,
               P_MEADKEN_ACHARON               NUMBER        ,
               P_CUR OUT          CURTYPE
              )
              ;
PROCEDURE U_TB_SUG_SIDUR_RECHIV
              (
               P_SUG_SIDUR                     NUMBER              ,
               P_ME_TAARICH                    DATE                ,
               P_AD_TAARICH                    DATE                ,
               P_KOD_RECHIV                    NUMBER              ,
               P_TAARICH_IDKUN_ACHARON         DATE                ,
               P_MEADKEN_ACHARON               NUMBER
              )
              ;
--Tammy 020302010
PROCEDURE I_CTB_SUGEY_DOCHOT

              (
               P_KOD_SUG_DOCH                     NUMBER              ,
               P_TEUR_DOCH                    VARCHAR2     ,
			   P_SHEM_DOCH_BAKOD          VARCHAR2 ,
			   P_PAIL					  		   		   			  VARCHAR2 ,
			   P_TAARICH_IDKUN_ACHARON  Date ,
			   P_MEADKEN_ACHARON		          Number
              );

PROCEDURE S_CTB_SUGEY_DOCHOT
              (
               P_CUR OUT          CURTYPE
              );

PROCEDURE U_CTB_SUGEY_DOCHOT
              (
               P_KOD_SUG_DOCH                     NUMBER              ,
               P_TEUR_DOCH                    VARCHAR2     ,
			   P_SHEM_DOCH_BAKOD          VARCHAR2 ,
			   P_PAIL					  		   		   			  VARCHAR2 ,
			   P_TAARICH_IDKUN_ACHARON  Date ,
			   P_MEADKEN_ACHARON		          Number
              );
PROCEDURE I_TB_BUGIM
              (
               P_MISPAR                     NUMBER              ,
			   P_MISPAR_ISHI                    NUMBER     ,
			   P_MISPAR_SIDUR          NUMBER ,
			   P_TAARICH					  		   		   			  Date ,
			   P_SHAT_YETZIA											   varchar2 ,
			   P_SHAT_HATCHALA_SIDUR    varchar2 ,
			   P_MAKAT_NESIA NUMBER ,
			   P_MASACH     varchar2,
			   P_TEUR            varchar2,
			   --P_MISHTAMESH_ID NUMBER ,
			   --P_STATUS      varchar2,
			   --P_TAARICH_PTICHA   Date ,
			   P_TAARICH_IDKUN_ACHARON  Date ,
			   P_MEADKEN_ACHARON		          Number
			                 );
PROCEDURE S_TB_BUGIM
              (
               P_CUR OUT          CURTYPE
              );
PROCEDURE U_TB_BUGIM
              (
               P_MISPAR                     NUMBER              ,
			   P_MISPAR_ISHI                    NUMBER     ,
			   P_MISPAR_SIDUR          NUMBER ,
			   P_TAARICH					  		   		   			  Date ,
			   P_SHAT_YETZIA											   varchar2 ,
			   P_SHAT_HATCHALA_SIDUR    varchar2 ,
			   P_MAKAT_NESIA NUMBER ,
			   P_MASACH     varchar2,
			   P_TEUR            varchar2,
			   --P_MISHTAMESH_ID NUMBER ,
			   --P_STATUS      varchar2,
			   --P_TAARICH_PTICHA   Date ,
			   P_TAARICH_IDKUN_ACHARON  Date ,
			   P_MEADKEN_ACHARON		          Number
              );

END PKG_SYSMAN; 
/

CREATE OR REPLACE PACKAGE BODY          PKG_SYSMAN AS

  PROCEDURE get_yamim_meyuchadim(p_Cur OUT CurType)
  IS
	 BEGIN
     OPEN p_Cur FOR
      select t.taarich,t.sug_yom,
      t.sug_yom_muchlaf_minhal,
      t.sug_yom_muchlaf_meshek,
      t.sug_yom_muchlaf_nehagut,
       t.sug_yom_muchlaf_tnua,
      t.taarich_idkun_acharon LastUpdate,s.teur_yom ,t.pail,
      s1.teur_yom teur_yom_minhal,
      s2.teur_yom teur_yom_meshek,
      s3.teur_yom teur_yom_nehagut,
      s4.teur_yom teur_yom_tnua
      from tb_yamim_meyuchadim t, ctb_sugey_yamim_meyuchadim s,
      ctb_sugey_yamim_meyuchadim s1,ctb_sugey_yamim_meyuchadim s2,
      ctb_sugey_yamim_meyuchadim s3,ctb_sugey_yamim_meyuchadim s4
      where t.sug_yom=s.sug_yom
      and t.sug_yom_muchlaf_minhal=s1.sug_yom(+)
      and t.sug_yom_muchlaf_meshek=s2.sug_yom(+)
      and t.sug_yom_muchlaf_nehagut=s3.sug_yom(+)
      and t.sug_yom_muchlaf_tnua=s4.sug_yom(+)
      order by t.taarich desc;

	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
  END get_yamim_meyuchadim;



PROCEDURE get_sugey_yamim_meyuchadim(p_Cur OUT CurType)
  IS
	 BEGIN
     OPEN p_Cur FOR
      select sug_yom,teur_yom FROM
      ctb_sugey_yamim_meyuchadim
      where pail=1;

	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
  END get_sugey_yamim_meyuchadim;

  PROCEDURE get_sugey_yamim_minhal(p_Cur OUT CurType)
  IS
	 BEGIN
     OPEN p_Cur FOR
      select sug_yom,teur_yom teur_yom_minhal  FROM
      ctb_sugey_yamim_meyuchadim
      where pail=1;

	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
  END get_sugey_yamim_minhal;

   PROCEDURE get_sugey_yamim_meshek(p_Cur OUT CurType)
  IS
	 BEGIN
     OPEN p_Cur FOR
      select sug_yom,teur_yom teur_yom_meshek  FROM
      ctb_sugey_yamim_meyuchadim
      where pail=1;

	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
  END get_sugey_yamim_meshek;

  PROCEDURE get_sugey_yamim_nehagut(p_Cur OUT CurType)
  IS
	 BEGIN
     OPEN p_Cur FOR
      select sug_yom,teur_yom teur_yom_nehagut  FROM
      ctb_sugey_yamim_meyuchadim
      where pail=1;

	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
  END get_sugey_yamim_nehagut;

  PROCEDURE get_sugey_yamim_tnua(p_Cur OUT CurType)
  IS
	 BEGIN
     OPEN p_Cur FOR
      select sug_yom,teur_yom teur_yom_tnua  FROM
      ctb_sugey_yamim_meyuchadim
      where pail=1;

	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
  END get_sugey_yamim_tnua;

PROCEDURE get_sugey_yamim_meyuchadim(Sug_Yom  number,p_Cur OUT CurType)
  IS
  SQLSTR VARCHAR2(2000);
	 BEGIN
   SQLSTR := 'select sug_yom,teur_yom FROM ctb_sugey_yamim_meyuchadim ctb where ctb.sug_yom =' || Sug_Yom ;
     OPEN p_Cur FOR SQLSTR;
     dbms_output.put_line(SQLSTR);


	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
  END get_sugey_yamim_meyuchadim;

  PROCEDURE update_yamim_meyuchadim(p_taarich DATE,p_sug_yom NUMBER,
    p_sug_yom_muchlaf_minhal NUMBER,
    p_sug_yom_muchlaf_meshek NUMBER,
    p_sug_yom_muchlaf_nehagut NUMBER,
    p_sug_yom_muchlaf_tnua NUMBER,
    p_pail NUMBER,
    p_taarich_idkun_acharon DATE,p_meadken_acharon NUMBER)
  is
  BEGIN
    update tb_yamim_meyuchadim t
    set t.sug_yom= p_sug_yom,
      t.sug_yom_muchlaf_minhal=p_sug_yom_muchlaf_minhal,
      t.sug_yom_muchlaf_meshek=p_sug_yom_muchlaf_meshek,
      t.sug_yom_muchlaf_nehagut=p_sug_yom_muchlaf_nehagut,
       t.sug_yom_muchlaf_tnua=p_sug_yom_muchlaf_tnua,
       t.pail= p_pail,
    taarich_idkun_acharon= p_taarich_idkun_acharon,
    meadken_acharon= p_meadken_acharon
    where taarich= p_taarich;
  end update_yamim_meyuchadim;

  PROCEDURE insert_yamim_meyuchadim(p_taarich DATE,p_sug_yom NUMBER,
   p_sug_yom_muchlaf_minhal NUMBER,
    p_sug_yom_muchlaf_meshek NUMBER,
    p_sug_yom_muchlaf_nehagut NUMBER,
    p_sug_yom_muchlaf_tnua NUMBER,
     p_pail NUMBER,
  p_taarich_idkun_acharon DATE,p_meadken_acharon NUMBER)
  is
  BEGIN
    INSERT into tb_yamim_meyuchadim(taarich, sug_yom,
    sug_yom_muchlaf_minhal,sug_yom_muchlaf_meshek,
    sug_yom_muchlaf_nehagut,sug_yom_muchlaf_tnua,
    meadken_acharon,pail)
    values(p_taarich, p_sug_yom,
      p_sug_yom_muchlaf_minhal,p_sug_yom_muchlaf_meshek,
      p_sug_yom_muchlaf_nehagut,p_sug_yom_muchlaf_tnua,
    p_meadken_acharon,p_pail);
  end insert_yamim_meyuchadim;

  PROCEDURE get_kategoria_tavla(p_kod_kategoria NUMBER,p_Cur OUT CurType)
    is
      BEGIN
      OPEN p_Cur FOR
        select t.shem_tavla_db,t.teur_tavla,k.TEUR_KATEGORIA
        from TB_KATEGORIAT_TAVLA t, ctb_kategoriot_tavla k
        where t.kod_kategoria=p_kod_kategoria
        and t.kod_kategoria=k.kod_kategoria
        and t.pail<>0
        order by miyun;

  end get_kategoria_tavla;


  PROCEDURE get_michsa_yomit(p_Cur OUT CurType)
  IS
	 BEGIN
     OPEN p_Cur FOR
      SELECT my.KOD_MICHSA, my.SUG_YOM, my.SHAVOA_AVODA, my.ME_TAARICH, my.AD_TAARICH, my.MICHSA,s.teur_yom FROM
      TB_MICHSA_YOMIT my,ctb_sugey_yamim_meyuchadim s
      where my.sug_yom=s.sug_yom
	  ORDER BY my.KOD_MICHSA asc, my.SUG_YOM asc, my.SHAVOA_AVODA asc, my.ME_TAARICH asc;

	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
  END get_michsa_yomit;

   PROCEDURE update_michsa_yomit(p_kod_michsa NUMBER,p_michsa NUMBER,p_shavoa_avoda NUMBER,p_me_taarich DATE,p_ad_taarich DATE,p_sug_yom NUMBER,p_meadken_acharon NUMBER)
  is
  BEGIN
    update TB_MICHSA_YOMIT my
    set my.SUG_YOM = p_sug_yom,
    my.TAARICH_IDKUN_ACHARON = sysdate,
    my.MEADKEN_ACHARON = p_meadken_acharon,
	my.MICHSA = p_michsa,
	my.SHAVOA_AVODA = p_shavoa_avoda,
	my.AD_TAARICH = p_ad_taarich
    where my.ME_TAARICH = p_me_taarich
	    and my.KOD_MICHSA = p_kod_michsa;
  end update_michsa_yomit;

  PROCEDURE insert_michsa_yomit(p_kod_michsa NUMBER,p_michsa NUMBER,p_shavoa_avoda NUMBER,p_me_taarich DATE,p_ad_taarich DATE,p_sug_yom NUMBER,p_meadken_acharon NUMBER)
  is
  BEGIN
    INSERT into TB_MICHSA_YOMIT(KOD_MICHSA, SUG_YOM, SHAVOA_AVODA, MICHSA, ME_TAARICH, AD_TAARICH, TAARICH_IDKUN_ACHARON, MEADKEN_ACHARON)
    values(p_kod_michsa, p_sug_yom, p_shavoa_avoda, p_michsa, p_me_taarich, p_ad_taarich, sysdate ,p_meadken_acharon);
  end insert_michsa_yomit;

  PROCEDURE get_zman_nesia_mishtane(p_Cur OUT CurType)
  IS
	 BEGIN
     OPEN p_Cur FOR
      SELECT me.TEUR_MERKAZ_EROA, my.TEUR_MIKUM_YECHIDA, znm.ME_TAARICH, znm.AD_TAARICH, znm.DAKOT
	  FROM CTB_ZMAN_NSIAA_MISHTANE znm
	                INNER JOIN (SELECT ctb_me.KOD_MERKAZ_EROA, ctb_me.TEUR_MERKAZ_EROA
	  					  	   		   		   FROM CTB_Merkaz_Eroa ctb_me) me
					ON me.KOD_MERKAZ_EROA = znm.MERKAZ_ERUA
					INNER JOIN (SELECT ctb_my.KOD_MIKUM_YECHIDA, ctb_my.TEUR_MIKUM_YECHIDA
	  					  	   		   			FROM CTB_Mikum_Yechida ctb_my) my
					ON my.KOD_MIKUM_YECHIDA = znm.MIKUM_YAAD
	  ORDER BY znm.MERKAZ_ERUA asc, znm.MIKUM_YAAD asc, znm.ME_TAARICH asc;

	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
  END get_zman_nesia_mishtane;

  PROCEDURE update_zman_nesia_mishtane(p_merkaz_erua NUMBER,p_mikum_yaad NUMBER,p_dakot NUMBER,p_me_taarich DATE,p_ad_taarich DATE,p_meadken_acharon NUMBER)
  is
  BEGIN
    update CTB_ZMAN_NSIAA_MISHTANE znm
    set znm.MIKUM_YAAD = p_mikum_yaad,
	znm.DAKOT = p_dakot,
	znm.AD_TAARICH = p_ad_taarich,
	znm.TAARICH_IDKUN_ACHARON = sysdate,
	znm.MEADKEN_ACHARON = p_meadken_acharon
    where znm.ME_TAARICH = p_me_taarich
	    and znm.MERKAZ_ERUA = p_merkaz_erua;
  end update_zman_nesia_mishtane;

  PROCEDURE insert_zman_nesia_mishtane(p_merkaz_erua NUMBER,p_mikum_yaad NUMBER,p_dakot NUMBER,p_me_taarich DATE,p_ad_taarich DATE,p_meadken_acharon NUMBER)
  is
  BEGIN
    INSERT into CTB_ZMAN_NSIAA_MISHTANE(MERKAZ_ERUA, MIKUM_YAAD, DAKOT, ME_TAARICH, AD_TAARICH, TAARICH_IDKUN_ACHARON, MEADKEN_ACHARON)
    values(p_merkaz_erua, p_mikum_yaad, p_dakot, p_me_taarich, p_ad_taarich, sysdate ,p_meadken_acharon);
  end insert_zman_nesia_mishtane;

  PROCEDURE get_merkaz_eroa(p_Cur OUT CurType)
  IS
	 BEGIN
     OPEN p_Cur FOR
      SELECT me.KOD_MERKAZ_EROA, me.TEUR_MERKAZ_EROA
	  FROM CTB_Merkaz_Eroa me
	  WHERE me.PAIL = '1'
	  order by me.TEUR_MERKAZ_EROA;

	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
  END get_merkaz_eroa;

  PROCEDURE get_mikum_yaad(p_Cur OUT CurType)
  IS
	 BEGIN
     OPEN p_Cur FOR
      SELECT my.KOD_MIKUM_YECHIDA, my.TEUR_MIKUM_YECHIDA
	  FROM CTB_Mikum_Yechida my
	  WHERE my.PAIL = '1'
	  order by my.TEUR_MIKUM_YECHIDA;

	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
  END get_mikum_yaad;

  PROCEDURE get_agaf(p_Cur OUT CurType)
  IS
	 BEGIN
     OPEN p_Cur FOR
	 Select KOD_YECHIDA,Teur_Yechida
    From CTB_Yechida
    Where  lower(SUG_YECHIDA) = 'mn_ag';

	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
  END get_agaf;

  PROCEDURE get_masach(p_Cur OUT CurType)
  IS
	 BEGIN
     OPEN p_Cur FOR
	 Select MASACH_ID,Teur
    From TB_MASACH
    Where  SUG = 1 and masach_id= pakad_id
	and teur is not null
	order by teur;

	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
  END get_masach;

  PROCEDURE get_masach_Bugim(p_Cur OUT CurType)
  IS
	 BEGIN
     OPEN p_Cur FOR
	 Select MASACH_ID MASACH,Teur Teur_Masach
    From TB_MASACH
    Where  SUG = 1 and masach_id in (19,4,5,7,10,13,16,23)
	and teur is not null
	order by teur;

	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
  END get_masach_Bugim;


  PROCEDURE get_hodaa(p_masach_id number, p_Cur OUT CurType)
  IS
	 BEGIN
     OPEN p_Cur FOR
	 Select t.KOD_HODAA,t.MELEL_HODAA,tm.TEUR
    From TB_HODAOT t,TB_MASACH tm
    Where t.MASACH_ID=tm.MASACH_ID
    and  t.MASACH_ID=nvl(p_masach_id,t.MASACH_ID)
	And tm.SUG=1;

	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
  END get_hodaa;

  PROCEDURE get_Profil(p_Cur OUT CurType)
  IS
	 BEGIN
     OPEN p_Cur FOR
	 Select KOD_PROFIL,TEUR_PROFIL
    From CTB_PROFIL
    Where PAIL='1'
	order by KOD_PROFIL;

	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
  END get_Profil;

  PROCEDURE get_Sug_Erech(p_Cur OUT CurType)
  IS
	 BEGIN
     OPEN p_Cur FOR
	 Select KOD_SUG_ERECH,TEUR_SUG_ERECH
    From CTB_SUGEY_ARACHIM
    Where PAIL='1'
	order by KOD_SUG_ERECH;

	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
  END get_Sug_Erech;

      PROCEDURE get_Ishurim(p_Cur OUT CurType)
  IS
	 BEGIN
     OPEN p_Cur FOR
	 Select KOD_ISHUR,TEUR_ISHUR
    From CTB_ISHURIM
    Where  PAIL = '1'
     order by KOD_ISHUR;
	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
  END get_Ishurim;

  PROCEDURE get_Rechivim(p_Cur OUT CurType)
  IS
	 BEGIN
     OPEN p_Cur FOR
	 Select KOD_RECHIV,TEUR_RECHIV
    From CTB_RECHIVIM
    Where  PAIL = '1'
     order by TEUR_RECHIV;
	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
  END get_Rechivim;



  PROCEDURE get_sibot_ledivuch_yadani(p_Cur OUT CurType)
  IS
	 BEGIN
     OPEN p_Cur FOR
      SELECT sly.KOD_SIBA,  sly.TEUR_SIBA, sly.GOREMET_LEBITUL_ZMAN_NESIAA, sly.GOREMET_LEBITUL_ZMAN_HALBASHA, sly.PAIL
	  FROM CTB_SIBOT_LEDIVUCH_YADANI sly
	  ORDER BY sly.KOD_SIBA asc;

	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
  END get_sibot_ledivuch_yadani;

  PROCEDURE update_sibot_ledivuch_yadani(p_kod_siba NUMBER,p_teur_siba VARCHAR2,p_goremet_lebitul_znam_nesiaa VARCHAR2,p_bitul_znam_halbasha VARCHAR2,p_meadken_acharon NUMBER)
  is
  BEGIN
    update CTB_SIBOT_LEDIVUCH_YADANI sly
    set sly.TEUR_SIBA = p_teur_siba,
	sly.GOREMET_LEBITUL_ZMAN_NESIAA = p_goremet_lebitul_znam_nesiaa,
	sly.GOREMET_LEBITUL_ZMAN_HALBASHA = p_bitul_znam_halbasha,
	sly.TAARICH_IDKUN_ACHARON = sysdate,
	sly.MEADKEN_ACHARON = p_meadken_acharon
    where sly.KOD_SIBA = p_kod_siba;
  end update_sibot_ledivuch_yadani;

  PROCEDURE insert_sibot_ledivuch_yadani(p_kod_siba NUMBER,p_teur_siba VARCHAR2,p_goremet_lebitul_zman_nesiaa VARCHAR2,p_bitul_zman_halbasha VARCHAR2,p_meadken_acharon NUMBER)
  is
  BEGIN
    INSERT into CTB_SIBOT_LEDIVUCH_YADANI(KOD_SIBA, TEUR_SIBA, GOREMET_LEBITUL_ZMAN_NESIAA, GOREMET_LEBITUL_ZMAN_HALBASHA, TAARICH_IDKUN_ACHARON, MEADKEN_ACHARON)
    values(p_kod_siba, p_teur_siba, p_goremet_lebitul_zman_nesiaa, p_bitul_zman_halbasha, sysdate ,p_meadken_acharon);
  end insert_sibot_ledivuch_yadani;

PROCEDURE S_CTB_DARGAT_RISHAYON
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_DARGAT_RISHAYON           ,
                           KOD_DARGAT_RISHAYON_OLD       ,
                           TEUR_DARGAT_RISHAYON
             FROM        CTB_DARGAT_RISHAYON
             ORDER BY
                  KOD_DARGAT_RISHAYON
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_DARGAT_RISHAYON;
PROCEDURE I_CTB_DIVUCH_HARIGA_MESHAOT
              (
               P_KOD_DIVUCH                    NUMBER              ,
			   P_TEUR_DIVUCH                   VARCHAR2  ,
               P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             INSERT INTO CTB_DIVUCH_HARIGA_MESHAOT
                          (
                           KOD_DIVUCH                    ,
                           PAIL                          ,
                           TEUR_DIVUCH,
						   TAARICH_IDKUN_ACHARON ,
						   MEADKEN_ACHARON
                          )
             VALUES
                          (
                           P_KOD_DIVUCH                    ,
                           P_PAIL                          ,
                           P_TEUR_DIVUCH,
						   P_TAARICH_IDKUN_ACHARON ,
						   P_MEADKEN_ACHARON
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_DIVUCH_HARIGA_MESHAOT;
PROCEDURE S_CTB_DIVUCH_HARIGA_MESHAOT
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_DIVUCH                    ,
                           PAIL                          ,
                           TAARICH_IDKUN_ACHARON         ,
                           TEUR_DIVUCH
             FROM        CTB_DIVUCH_HARIGA_MESHAOT
             ORDER BY
                  KOD_DIVUCH
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_DIVUCH_HARIGA_MESHAOT;
PROCEDURE U_CTB_DIVUCH_HARIGA_MESHAOT
              (
               P_KOD_DIVUCH                    NUMBER              ,
			   P_TEUR_DIVUCH                   VARCHAR2  ,
               P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             UPDATE      CTB_DIVUCH_HARIGA_MESHAOT
                SET
                KOD_DIVUCH                = P_KOD_DIVUCH               ,
                PAIL                      = P_PAIL                     ,
                TAARICH_IDKUN_ACHARON     = P_TAARICH_IDKUN_ACHARON    ,
                TEUR_DIVUCH               = P_TEUR_DIVUCH,
				  MEADKEN_ACHARON = P_MEADKEN_ACHARON
                WHERE
                 KOD_DIVUCH                = P_KOD_DIVUCH
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_DIVUCH_HARIGA_MESHAOT;
PROCEDURE S_CTB_ELEMENTIM
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_ELEMENT                   ,
                           LETASHLUM_PREMIA              ,
                           PAIL                          ,
                           TEUR_ELEMENT
             FROM        CTB_ELEMENTIM
             ORDER BY
                  KOD_ELEMENT
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_ELEMENTIM;
PROCEDURE S_CTB_EZOR
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           ce.KOD_EZOR                      ,
                           ch.Teur_HEVRA                     ,
                           ce.TEUR_EZOR
             FROM        CTB_EZOR ce, CTB_HEVRA ch
             where ce.KOD_HEVRA =ch.KOD_HEVRA
             ORDER BY
                  KOD_EZOR
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_EZOR;
PROCEDURE I_CTB_HARSHAA
              (
              P_KOD_HARSHAA                   NUMBER              ,
			   P_TEUR_HARSHAA                  VARCHAR2,
               P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             INSERT INTO CTB_HARSHAA
                          (
                           KOD_HARSHAA                   ,
                           PAIL                          ,
                           TEUR_HARSHAA,
						   TAARICH_IDKUN_ACHARON,
						   MEADKEN_ACHARON
                          )
             VALUES
                          (
                           P_KOD_HARSHAA                   ,
                           P_PAIL                          ,
                           P_TEUR_HARSHAA,
						   P_TAARICH_IDKUN_ACHARON,
						   P_MEADKEN_ACHARON
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_HARSHAA;
PROCEDURE S_CTB_HARSHAA
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_HARSHAA                   ,
                           PAIL                          ,
                           TAARICH_IDKUN_ACHARON         ,
                           TEUR_HARSHAA
             FROM        CTB_HARSHAA
             ORDER BY
                  KOD_HARSHAA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_HARSHAA;
PROCEDURE U_CTB_HARSHAA
              (
               P_KOD_HARSHAA                   NUMBER              ,
			   P_TEUR_HARSHAA                  VARCHAR2,
               P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             UPDATE      CTB_HARSHAA
                SET
                KOD_HARSHAA               = P_KOD_HARSHAA              ,
                PAIL                      = P_PAIL                     ,
                TAARICH_IDKUN_ACHARON     = TAARICH_IDKUN_ACHARON    ,
                TEUR_HARSHAA              = P_TEUR_HARSHAA   ,
				MEADKEN_ACHARON = P_MEADKEN_ACHARON
                WHERE
                 KOD_HARSHAA               = P_KOD_HARSHAA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_HARSHAA;
PROCEDURE I_CTB_HAZMANA_MEYUCHEDET
              (
               P_KOD_HAZMANA                   NUMBER              ,
			   P_TEUR_HAZMANA                  VARCHAR2            ,
			   P_ZMAN_LETASHLUM                NUMBER ,
               P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             INSERT INTO CTB_HAZMANA_MEYUCHEDET
                          (
                           KOD_HAZMANA                   ,
                           PAIL                          ,
                           TEUR_HAZMANA                  ,
                           ZMAN_LETASHLUM    ,
						   TAARICH_IDKUN_ACHARON,
						    MEADKEN_ACHARON
                          )
             VALUES
                          (
                           P_KOD_HAZMANA                   ,
                           P_PAIL                          ,
                           P_TEUR_HAZMANA                  ,
                           P_ZMAN_LETASHLUM,
						   P_TAARICH_IDKUN_ACHARON,
						   P_MEADKEN_ACHARON
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_HAZMANA_MEYUCHEDET;
PROCEDURE S_CTB_HAZMANA_MEYUCHEDET
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_HAZMANA                   ,
                           PAIL                          ,
                           TAARICH_IDKUN_ACHARON         ,
                           TEUR_HAZMANA                  ,
                           ZMAN_LETASHLUM
             FROM        CTB_HAZMANA_MEYUCHEDET
             ORDER BY
                  KOD_HAZMANA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_HAZMANA_MEYUCHEDET;
PROCEDURE U_CTB_HAZMANA_MEYUCHEDET
              (
               P_KOD_HAZMANA                   NUMBER              ,
			   P_TEUR_HAZMANA                  VARCHAR2            ,
			   P_ZMAN_LETASHLUM                NUMBER ,
               P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number

              )
           IS
           BEGIN
             UPDATE      CTB_HAZMANA_MEYUCHEDET
                SET
                KOD_HAZMANA               = P_KOD_HAZMANA              ,
                PAIL                      = P_PAIL                     ,
                TAARICH_IDKUN_ACHARON     = P_TAARICH_IDKUN_ACHARON    ,
                TEUR_HAZMANA              = P_TEUR_HAZMANA             ,
                ZMAN_LETASHLUM            = P_ZMAN_LETASHLUM ,
				 MEADKEN_ACHARON = P_MEADKEN_ACHARON
                WHERE
                 KOD_HAZMANA               = P_KOD_HAZMANA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_HAZMANA_MEYUCHEDET;
  PROCEDURE I_CTB_HEAROT_RECHIVIM
              (
               P_KOD_RECHIV                    NUMBER              ,
               P_HEARA                         VARCHAR2            ,
               P_MUTAM_BITACHON                NUMBER              ,
               P_PAIL                          CHAR ,
			   P_TAARICH_IDKUN_ACHARON  Date ,
			   P_MEADKEN_ACHARON		          Number
              )
           IS
           BEGIN
          INSERT INTO CTB_HEAROT_RECHIVIM
                          (
                           HEARA                         ,
                           KOD_RECHIV                    ,
                           MUTAM_BITACHON                ,
                           PAIL,
						   TAARICH_IDKUN_ACHARON   ,
			   			   MEADKEN_ACHARON
                          )
             VALUES
                          (
                           P_HEARA                         ,
                           P_KOD_RECHIV                    ,
                           P_MUTAM_BITACHON                ,
                           P_PAIL,
						   P_TAARICH_IDKUN_ACHARON   ,
			   			   P_MEADKEN_ACHARON
                          )
                           ;

             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_HEAROT_RECHIVIM;

PROCEDURE S_CTB_HEAROT_RECHIVIM
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                          ch.HEARA                         ,
                           cr.TEUR_RECHIV                    ,
                           ch.MUTAM_BITACHON                ,
                           ch.PAIL                          ,
                           ch.TAARICH_IDKUN_ACHARON         ,
                           ch.KOD_RECHIV
             FROM        CTB_HEAROT_RECHIVIM ch,CTB_RECHIVIM cr
			 where ch.KOD_RECHIV=cr.KOD_RECHIV
			 Order by  cr.TEUR_RECHIV ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_HEAROT_RECHIVIM;
PROCEDURE U_CTB_HEAROT_RECHIVIM
              (
               P_KOD_RECHIV                    NUMBER              ,
               P_HEARA                         VARCHAR2            ,
               P_MUTAM_BITACHON                NUMBER              ,
               P_PAIL                          CHAR ,
			   P_TAARICH_IDKUN_ACHARON  Date ,
			   P_MEADKEN_ACHARON		          Number
              )
           IS
           BEGIN
             UPDATE      CTB_HEAROT_RECHIVIM
                SET
                HEARA                     = P_HEARA                    ,
                KOD_RECHIV                = P_KOD_RECHIV               ,
                MUTAM_BITACHON            = P_MUTAM_BITACHON           ,
                PAIL                      = P_PAIL                     ,
                TAARICH_IDKUN_ACHARON     = TAARICH_IDKUN_ACHARON,
				  MEADKEN_ACHARON = P_MEADKEN_ACHARON
                WHERE
                 KOD_RECHIV                = P_KOD_RECHIV
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_HEAROT_RECHIVIM;
PROCEDURE I_CTB_HISTAYGUT
              (
               P_KOD_HISTAYGUT                 NUMBER              ,
               P_NAHAG_RASHAI_LEASHER          VARCHAR2            ,
               P_PAIL                          VARCHAR2            ,
               P_TEUR_HISTAYGUT                VARCHAR2
              )
           IS
           BEGIN
             INSERT INTO CTB_HISTAYGUT
                          (
                           KOD_HISTAYGUT                 ,
                           NAHAG_RASHAI_LEASHER          ,
                           PAIL                          ,
                           TEUR_HISTAYGUT
                          )
             VALUES
                          (
                           P_KOD_HISTAYGUT                 ,
                           P_NAHAG_RASHAI_LEASHER          ,
                           P_PAIL                          ,
                           P_TEUR_HISTAYGUT
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_HISTAYGUT;
PROCEDURE S_CTB_HISTAYGUT
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_HISTAYGUT                 ,
                           NAHAG_RASHAI_LEASHER          ,
                           PAIL                          ,
                           TAARICH_IDKUN_ACHARON         ,
                           TEUR_HISTAYGUT
             FROM        CTB_HISTAYGUT
             ORDER BY
                  KOD_HISTAYGUT
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_HISTAYGUT;
PROCEDURE U_CTB_HISTAYGUT
              (
               P_KOD_HISTAYGUT                 NUMBER              ,
               P_NAHAG_RASHAI_LEASHER          VARCHAR2            ,
               P_PAIL                          VARCHAR2            ,
               P_TEUR_HISTAYGUT                VARCHAR2
              )
           IS
           BEGIN
             UPDATE      CTB_HISTAYGUT
                SET
                KOD_HISTAYGUT             = P_KOD_HISTAYGUT            ,
                NAHAG_RASHAI_LEASHER      = P_NAHAG_RASHAI_LEASHER     ,
                PAIL                      = P_PAIL                     ,
                TAARICH_IDKUN_ACHARON     = SYSDATE    ,
                TEUR_HISTAYGUT            = P_TEUR_HISTAYGUT
                WHERE
                 KOD_HISTAYGUT             = P_KOD_HISTAYGUT
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_HISTAYGUT;
PROCEDURE S_CTB_ISUK
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           Teur_HEVRA                     ,
                           KOD_ISUK                      ,
                           TEUR_ISUK    ,
						   TEUR_SECTOR_ISUK
             FROM        CTB_ISUK ci,CTB_SECTOR_ISUK cs,CTB_HEVRA ch
			 where ci.kod_hevra=ch.kod_hevra
			 and cs.KOD_SECTOR_ISUK=ci.KOD_SECTOR_ISUK
             ORDER BY
                  KOD_ISUK
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_ISUK;
PROCEDURE I_CTB_KODIM_MEYUCHADIM_LEIDKUN
              (
                P_KOD_IDKUN                     NUMBER              ,
               P_TEUR_IDKUN                    VARCHAR2,
			   P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             INSERT INTO CTB_KODIM_MEYUCHADIM_LEIDKUN
                          (
                           KOD_IDKUN                     ,
                           PAIL                          ,
                           TEUR_IDKUN,
						   TAARICH_IDKUN_ACHARON,
							MEADKEN_ACHARON
                          )
             VALUES
                          (
                           P_KOD_IDKUN                     ,
                           P_PAIL                          ,
                           P_TEUR_IDKUN,
						   P_TAARICH_IDKUN_ACHARON,
			   			   P_MEADKEN_ACHARON
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_KODIM_MEYUCHADIM_LEIDKUN;
PROCEDURE S_CTB_KODIM_MEYUCHADIM_LEIDKUN
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_IDKUN                     ,
                           PAIL                          ,
                           TAARICH_IDKUN_ACHARON         ,
                           TEUR_IDKUN
             FROM        CTB_KODIM_MEYUCHADIM_LEIDKUN
             ORDER BY
                  KOD_IDKUN
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_KODIM_MEYUCHADIM_LEIDKUN;
PROCEDURE U_CTB_KODIM_MEYUCHADIM_LEIDKUN
              (
               P_KOD_IDKUN                     NUMBER              ,
               P_TEUR_IDKUN                    VARCHAR2,
			   P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             UPDATE      CTB_KODIM_MEYUCHADIM_LEIDKUN
                SET
                KOD_IDKUN                 = P_KOD_IDKUN                ,
                PAIL                      = P_PAIL                     ,
                TAARICH_IDKUN_ACHARON     =    P_TAARICH_IDKUN_ACHARON ,
                TEUR_IDKUN                = P_TEUR_IDKUN,
				MEADKEN_ACHARON = P_MEADKEN_ACHARON
                WHERE
                 KOD_IDKUN                 = P_KOD_IDKUN
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_KODIM_MEYUCHADIM_LEIDKUN;
PROCEDURE S_CTB_KOD_GIL
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_GIL_HILAN                 ,
                           KOD_GIL_HR                    ,
                           TEUR_KOD_GIL
             FROM        CTB_KOD_GIL
             ORDER BY
                  KOD_GIL_HR
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_KOD_GIL;
PROCEDURE I_CTB_KOD_KVUZAT_NESIAA
              (
               P_KOD_KVUZAT_NESIAA             NUMBER              ,
               P_TEUR_KVUZAT_NESIAA            VARCHAR2 ,
			   P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             INSERT INTO CTB_KOD_KVUZAT_NESIAA
                          (
                           KOD_KVUZAT_NESIAA             ,
                           PAIL                          ,
                           TEUR_KVUZAT_NESIAA,
						    TAARICH_IDKUN_ACHARON     ,
			   				MEADKEN_ACHARON
                          )
             VALUES
                          (
                           P_KOD_KVUZAT_NESIAA             ,
                           P_PAIL                          ,
                           P_TEUR_KVUZAT_NESIAA,
						   P_TAARICH_IDKUN_ACHARON     ,
			   			   P_MEADKEN_ACHARON
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_KOD_KVUZAT_NESIAA;
PROCEDURE S_CTB_KOD_KVUZAT_NESIAA
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_KVUZAT_NESIAA             ,
                           PAIL                          ,
                           TAARICH_IDKUN_ACHARON         ,
                           TEUR_KVUZAT_NESIAA
             FROM        CTB_KOD_KVUZAT_NESIAA
             ORDER BY
                  KOD_KVUZAT_NESIAA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_KOD_KVUZAT_NESIAA;
PROCEDURE U_CTB_KOD_KVUZAT_NESIAA
              (
               P_KOD_KVUZAT_NESIAA             NUMBER              ,
               P_TEUR_KVUZAT_NESIAA            VARCHAR2,
			   P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             UPDATE      CTB_KOD_KVUZAT_NESIAA
                SET
                KOD_KVUZAT_NESIAA         = P_KOD_KVUZAT_NESIAA        ,
                PAIL                      = P_PAIL                     ,
                TAARICH_IDKUN_ACHARON     = P_TAARICH_IDKUN_ACHARON    ,
                TEUR_KVUZAT_NESIAA        = P_TEUR_KVUZAT_NESIAA,
				MEADKEN_ACHARON = P_MEADKEN_ACHARON
                WHERE
                 KOD_KVUZAT_NESIAA         = P_KOD_KVUZAT_NESIAA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_KOD_KVUZAT_NESIAA;
PROCEDURE I_CTB_KOD_PEILUT
              (
               P_KOD_SECTOR_PEILUT             VARCHAR2            ,
			   P_TEUR_SECTOR_PEILUT 			   VARCHAR2            ,
               P_PAIL                          VARCHAR2,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             INSERT INTO CTB_KOD_PEILUT
                          (
                           KOD_SECTOR_PEILUT             ,
						   TEUR_SECTOR_PEILUT,
                           PAIL,
						   TAARICH_IDKUN_ACHARON,
						   MEADKEN_ACHARON
                          )
             VALUES
                          (
                           P_KOD_SECTOR_PEILUT             ,
						    P_TEUR_SECTOR_PEILUT,
                           P_PAIL,
						   P_TAARICH_IDKUN_ACHARON,
						   P_MEADKEN_ACHARON
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_KOD_PEILUT;
PROCEDURE S_CTB_KOD_PEILUT
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_SECTOR_PEILUT             ,
						   TEUR_SECTOR_PEILUT,
                           PAIL                          ,
                           TAARICH_IDKUN_ACHARON
             FROM        CTB_KOD_PEILUT
             ORDER BY
                  KOD_SECTOR_PEILUT
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_KOD_PEILUT;
PROCEDURE U_CTB_KOD_PEILUT
              (
               P_KOD_SECTOR_PEILUT             VARCHAR2            ,
			   P_TEUR_SECTOR_PEILUT 			   VARCHAR2            ,
               P_PAIL                          VARCHAR2,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             UPDATE      CTB_KOD_PEILUT
                SET
                KOD_SECTOR_PEILUT         = P_KOD_SECTOR_PEILUT        ,
				TEUR_SECTOR_PEILUT = P_TEUR_SECTOR_PEILUT,
                PAIL                      = P_PAIL                     ,
                TAARICH_IDKUN_ACHARON     = P_TAARICH_IDKUN_ACHARON,
				  MEADKEN_ACHARON = P_MEADKEN_ACHARON
                WHERE
                 KOD_SECTOR_PEILUT         = P_KOD_SECTOR_PEILUT
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_KOD_PEILUT;
PROCEDURE I_CTB_LINA
              (
               P_KOD_LINA                      NUMBER              ,
               P_TEUR_LINA                     VARCHAR2  ,
			   P_PAIL                          CHAR                ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             INSERT INTO CTB_LINA
                          (
                           KOD_LINA                      ,
                           PAIL                          ,
                           TEUR_LINA,
						   TAARICH_IDKUN_ACHARON     ,
			   			    MEADKEN_ACHARON
                          )
             VALUES
                          (
                           P_KOD_LINA                      ,
                           P_PAIL                          ,
                           P_TEUR_LINA,
						   P_TAARICH_IDKUN_ACHARON     ,
			   			   P_MEADKEN_ACHARON
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_LINA;
PROCEDURE S_CTB_LINA
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_LINA                      ,
                           PAIL                          ,
                           TAARICH_IDKUN_ACHARON         ,
                           TEUR_LINA
             FROM        CTB_LINA
             ORDER BY
                  KOD_LINA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_LINA;
PROCEDURE U_CTB_LINA
              (
               P_KOD_LINA                      NUMBER              ,
               P_TEUR_LINA                     VARCHAR2,
               P_PAIL                          CHAR                ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             UPDATE      CTB_LINA
                SET
                KOD_LINA                  = P_KOD_LINA                 ,
                PAIL                      = P_PAIL                     ,
                TAARICH_IDKUN_ACHARON     = TAARICH_IDKUN_ACHARON   ,
                TEUR_LINA                 = P_TEUR_LINA ,
				 MEADKEN_ACHARON = P_MEADKEN_ACHARON
                WHERE
                 KOD_LINA                  = P_KOD_LINA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_LINA;
PROCEDURE S_CTB_MAAMAD
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           ch.teur_HEVRA                     ,
                           cm.KOD_MAAMAD_HILAN              ,
                           cm.KOD_MAAMAD_HR                 ,
                           cm.TEUR_MAAMAD_HR
             FROM        CTB_MAAMAD cm, CTB_HEVRA ch
			 where ch.kod_HEVRA=cm.kod_HEVRA
             ORDER BY
                  KOD_MAAMAD_HR
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_MAAMAD;
PROCEDURE S_CTB_MEAFYEN_BITZUA
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           cm.KOD_MEAFYEN_BITZUA            ,
                           cm.TEUR_MEAFYEN_BITZUA           ,
                           cy.TEUR_YECHIDA_MEAFYEN
             FROM        CTB_MEAFYEN_BITZUA cm,CTB_YECHIDAT_MEAFYEN cy
			 where cm.YECHIDAT_MEAFYEN   = cy.KOD_YECHIDA_MEAFYEN
             ORDER BY
                  KOD_MEAFYEN_BITZUA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_MEAFYEN_BITZUA;
PROCEDURE S_CTB_MUTAMUT
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           ISUR_HUVALAT_NUSIM            ,
                           ISUR_NEHIGA                   ,
                           ISUR_SHAOT_NOSAFOT            ,
                           KOD_MUTAMUT                   ,
                           MEZAKE_GMUL                   ,
                           REFUI                         ,
                           TEUR_MUTAMUT
             FROM        CTB_MUTAMUT
             ORDER BY
                  KOD_MUTAMUT
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_MUTAMUT;
PROCEDURE I_CTB_NATUN_HR
              (
               P_KOD_NATUN                     NUMBER              ,
               P_TEUR_NATUN                    VARCHAR2,
			   P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             INSERT INTO CTB_NATUN_HR
                          (
                           KOD_NATUN                     ,
                           PAIL                          ,
                           TEUR_NATUN,
						   TAARICH_IDKUN_ACHARON,
						   MEADKEN_ACHARON
                          )
             VALUES
                          (
                           P_KOD_NATUN                     ,
                           P_PAIL                          ,
                           P_TEUR_NATUN ,
						   P_TAARICH_IDKUN_ACHARON,
						   P_MEADKEN_ACHARON
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_NATUN_HR;
PROCEDURE S_CTB_NATUN_HR
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_NATUN                     ,
                           PAIL                          ,
                           TAARICH_IDKUN_ACHARON         ,
                           TEUR_NATUN
             FROM        CTB_NATUN_HR
             ORDER BY
                  KOD_NATUN
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_NATUN_HR;
PROCEDURE U_CTB_NATUN_HR
              (
               P_KOD_NATUN                     NUMBER              ,
               P_TEUR_NATUN                    VARCHAR2,
			   P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             UPDATE      CTB_NATUN_HR
                SET
                KOD_NATUN                 = P_KOD_NATUN                ,
                PAIL                      = P_PAIL                     ,
                TAARICH_IDKUN_ACHARON     = P_TAARICH_IDKUN_ACHARON    ,
                TEUR_NATUN                = P_TEUR_NATUN ,
				 MEADKEN_ACHARON =P_MEADKEN_ACHARON
                WHERE
                 KOD_NATUN                 = P_KOD_NATUN
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_NATUN_HR;
PROCEDURE S_CTB_NKUDUT_TIFAUL
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_NEKUDAT_TIFUL             ,
                           TEUR_NEKUDAT_TIFUL
             FROM        CTB_NKUDUT_TIFAUL
             ORDER BY
                  KOD_NeKUDaT_TIFUL
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_NKUDUT_TIFAUL;
PROCEDURE I_CTB_PITZUL_HAFSAKA
              (
 			  P_KOD_PIZUL_HAFSAKA             NUMBER              ,
			   P_TEUR_PIZUL_HAFSAKA            VARCHAR2 ,
               P_PAIL                          CHAR                ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             INSERT INTO CTB_PITZUL_HAFSAKA
                          (
                           KOD_PIZUL_HAFSAKA             ,
                           PAIL                          ,
                           TEUR_PIZUL_HAFSAKA,
						   TAARICH_IDKUN_ACHARON,
						   MEADKEN_ACHARON
                          )
             VALUES
                          (
                           P_KOD_PIZUL_HAFSAKA             ,
                           P_PAIL                          ,
                           P_TEUR_PIZUL_HAFSAKA,
						   P_TAARICH_IDKUN_ACHARON,
						   P_MEADKEN_ACHARON
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_PITZUL_HAFSAKA;
PROCEDURE S_CTB_PITZUL_HAFSAKA
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_PIZUL_HAFSAKA             ,
                           PAIL                          ,
                           TAARICH_IDKUN_ACHARON         ,
                           TEUR_PIZUL_HAFSAKA
             FROM        CTB_PITZUL_HAFSAKA
             ORDER BY
                  KOD_PIZUL_HAFSAKA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_PITZUL_HAFSAKA;
PROCEDURE U_CTB_PITZUL_HAFSAKA
              (
               P_KOD_PIZUL_HAFSAKA             NUMBER              ,
			   P_TEUR_PIZUL_HAFSAKA            VARCHAR2 ,
               P_PAIL                          CHAR                ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             UPDATE      CTB_PITZUL_HAFSAKA
                SET
                KOD_PIZUL_HAFSAKA         = P_KOD_PIZUL_HAFSAKA        ,
                PAIL                      = P_PAIL                     ,
                TAARICH_IDKUN_ACHARON     = P_TAARICH_IDKUN_ACHARON    ,
                TEUR_PIZUL_HAFSAKA        = P_TEUR_PIZUL_HAFSAKA ,
				 MEADKEN_ACHARON = P_MEADKEN_ACHARON
                WHERE
                 KOD_PIZUL_HAFSAKA         = P_KOD_PIZUL_HAFSAKA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_PITZUL_HAFSAKA;
PROCEDURE I_CTB_PROFIL
              (
               P_KOD_PROFIL                    NUMBER              ,
               P_TEUR_PROFIL                   VARCHAR2 ,
			   P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             INSERT INTO CTB_PROFIL
                          (
                           KOD_PROFIL                    ,
                           PAIL                          ,
                           TEUR_PROFIL,
						   TAARICH_IDKUN_ACHARON     ,
			   			   MEADKEN_ACHARON
                          )
             VALUES
                          (
                           P_KOD_PROFIL                    ,
                           P_PAIL                          ,
                           P_TEUR_PROFIL ,
						   P_TAARICH_IDKUN_ACHARON,
						   P_MEADKEN_ACHARON
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_PROFIL;
PROCEDURE S_CTB_PROFIL
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_PROFIL                    ,
                           PAIL                          ,
                           TAARICH_IDKUN_ACHARON         ,
                           TEUR_PROFIL
             FROM        CTB_PROFIL
             ORDER BY
                  KOD_PROFIL
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_PROFIL;
PROCEDURE U_CTB_PROFIL
              (
               P_KOD_PROFIL                    NUMBER              ,
               P_TEUR_PROFIL                   VARCHAR2 ,
			   P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             UPDATE      CTB_PROFIL
                SET
                KOD_PROFIL                = P_KOD_PROFIL               ,
                PAIL                      = P_PAIL                     ,
                TAARICH_IDKUN_ACHARON     = TAARICH_IDKUN_ACHARON    ,
                TEUR_PROFIL               = P_TEUR_PROFIL,
				 MEADKEN_ACHARON = P_MEADKEN_ACHARON
                WHERE
                 KOD_PROFIL                = P_KOD_PROFIL
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_PROFIL;
PROCEDURE I_CTB_SECTOR_ISUK
              (
               P_KOD_SECTOR_ISUK               NUMBER,
               P_TEUR_SECTOR_ISUK              VARCHAR2
              )
           IS
           BEGIN
             INSERT INTO CTB_SECTOR_ISUK
                          (
                           KOD_SECTOR_ISUK               ,
                           TEUR_SECTOR_ISUK
                          )
             VALUES
                          (
                           P_KOD_SECTOR_ISUK               ,
                           P_TEUR_SECTOR_ISUK
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_SECTOR_ISUK;
PROCEDURE S_CTB_SECTOR_ISUK
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_SECTOR_ISUK               ,
                           TEUR_SECTOR_ISUK
             FROM        CTB_SECTOR_ISUK
             ORDER BY
                  KOD_SECTOR_ISUK
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_SECTOR_ISUK;
PROCEDURE U_CTB_SECTOR_ISUK
              (
               P_KOD_SECTOR_ISUK               NUMBER,
               P_TEUR_SECTOR_ISUK              VARCHAR2
              )
           IS
           BEGIN
             UPDATE      CTB_SECTOR_ISUK
                SET
                KOD_SECTOR_ISUK           = P_KOD_SECTOR_ISUK          ,
                TEUR_SECTOR_ISUK          = P_TEUR_SECTOR_ISUK
                WHERE
                 KOD_SECTOR_ISUK           = P_KOD_SECTOR_ISUK
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_SECTOR_ISUK;
PROCEDURE I_CTB_SECTOR_VISA
              (
               P_KOD_SECTOR_VISA               NUMBER              ,
               P_TEUR_SECTOR_VISA              VARCHAR2,
			   P_PAIL                          CHAR                ,
			   p_taarich_idkun_acharon DATE,
			   p_meadken_acharon NUMBER
              )
           IS
           BEGIN
             INSERT INTO CTB_SECTOR_VISA
                          (
                           KOD_SECTOR_VISA               ,
                           PAIL                          ,
                           TEUR_SECTOR_VISA,
						   taarich_idkun_acharon ,
			               meadken_acharon
                          )
             VALUES
                          (
                           P_KOD_SECTOR_VISA               ,
                           P_PAIL                          ,
                           P_TEUR_SECTOR_VISA,
						   p_taarich_idkun_acharon ,
			               p_meadken_acharon
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_SECTOR_VISA;
PROCEDURE S_CTB_SECTOR_VISA
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_SECTOR_VISA               ,
                           PAIL                          ,
                           TAARICH_IDKUN_ACHARON         ,
                           TEUR_SECTOR_VISA
             FROM        CTB_SECTOR_VISA
             ORDER BY
                  KOD_SECTOR_VISA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_SECTOR_VISA;
PROCEDURE U_CTB_SECTOR_VISA
              (
               P_KOD_SECTOR_VISA               NUMBER              ,
               P_TEUR_SECTOR_VISA              VARCHAR2 ,
			   P_PAIL                          CHAR                ,
			   p_taarich_idkun_acharon DATE,
			   p_meadken_acharon NUMBER
              )
           IS
           BEGIN
             UPDATE      CTB_SECTOR_VISA
                SET
                KOD_SECTOR_VISA           = P_KOD_SECTOR_VISA          ,
                PAIL                      = P_PAIL                     ,
                TAARICH_IDKUN_ACHARON     = p_taarich_idkun_acharon    ,
                TEUR_SECTOR_VISA          = P_TEUR_SECTOR_VISA,
				meadken_acharon 		  	= 		  P_meadken_acharon
                WHERE
                 KOD_SECTOR_VISA           = P_KOD_SECTOR_VISA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_SECTOR_VISA;
PROCEDURE I_CTB_SHGIOT
              (
               P_KOD_SHGIA                     NUMBER              ,
			   P_TEUR_SHGIA                    VARCHAR2 ,
			   P_RAMA                          NUMBER              ,
			   P_NATUN_LEBDIKA		 VARCHAR2,
			   P_ISHUR_RASHEMET                NUMBER              ,
               P_KOD_ISHUR                     NUMBER              ,
               P_PAIL                          VARCHAR2            ,
 			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             INSERT INTO CTB_SHGIOT
                          (
                           ISHUR_RASHEMET                ,
                           KOD_ISHUR                     ,
                           KOD_SHGIA                     ,
                           PAIL                          ,
                           RAMA                          ,
                           TEUR_SHGIA   ,
						   NATUN_LEBDIKA ,
						   TAARICH_IDKUN_ACHARON,
							MEADKEN_ACHARON
                          )
             VALUES
                          (
                           P_ISHUR_RASHEMET                ,
                           P_KOD_ISHUR                     ,
                           P_KOD_SHGIA                     ,
                           P_PAIL                          ,
                           P_RAMA                          ,
                           P_TEUR_SHGIA ,
						   P_NATUN_LEBDIKA,
						   P_TAARICH_IDKUN_ACHARON,
						   P_MEADKEN_ACHARON
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_SHGIOT;
PROCEDURE S_CTB_SHGIOT
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           s.ISHUR_RASHEMET                ,
                           s.KOD_ISHUR                     ,
                           s.KOD_SHGIA                     ,
                           s.PAIL                          ,
                           s.RAMA                          ,
                           s.TAARICH_IDKUN_ACHARON         ,
                           s.TEUR_SHGIA      ,
						   s.NATUN_LEBDIKA,
						   ci.TEUR_ISHUR
             FROM        CTB_SHGIOT s,CTB_ISHURIM ci
			  where   s.KOD_ISHUR=ci.KOD_ISHUR(+)
             ORDER BY
                  KOD_SHGIA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_SHGIOT;
PROCEDURE U_CTB_SHGIOT
              (
               P_KOD_SHGIA                     NUMBER              ,
			   P_TEUR_SHGIA                    VARCHAR2 ,
			   P_RAMA                          NUMBER              ,
			   P_NATUN_LEBDIKA		 VARCHAR2,
			   P_ISHUR_RASHEMET                NUMBER              ,
               P_KOD_ISHUR                     NUMBER              ,
               P_PAIL                          VARCHAR2            ,
 			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             UPDATE      CTB_SHGIOT
                SET
                ISHUR_RASHEMET            = P_ISHUR_RASHEMET           ,
                KOD_ISHUR                 = P_KOD_ISHUR                ,
                 PAIL                      = P_PAIL                     ,
                RAMA                      = P_RAMA                     ,
                TAARICH_IDKUN_ACHARON     = P_TAARICH_IDKUN_ACHARON    ,
                 TEUR_SHGIA                = P_TEUR_SHGIA ,
				  NATUN_LEBDIKA	      = P_NATUN_LEBDIKA,
				  MEADKEN_ACHARON = P_MEADKEN_ACHARON
                WHERE
                 KOD_SHGIA                 = P_KOD_SHGIA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_SHGIOT;
PROCEDURE I_CTB_SIBOT_HASHLAMA_LEYOM
              (
               P_KOD_SIBA                      NUMBER              ,
               P_TEUR_SIBA                     VARCHAR2,
               P_LETZUGA                       NUMBER              ,
               P_PAIL                          CHAR                ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             INSERT INTO CTB_SIBOT_HASHLAMA_LEYOM
                          (
                           KOD_SIBA                      ,
                           LETZUGA                       ,
                           PAIL                          ,
                           TEUR_SIBA,
						   TAARICH_IDKUN_ACHARON,
						    MEADKEN_ACHARON
                          )
             VALUES
                          (
                           P_KOD_SIBA                      ,
                           P_LETZUGA                       ,
                           P_PAIL                          ,
                           P_TEUR_SIBA ,
						   P_TAARICH_IDKUN_ACHARON,
						   P_MEADKEN_ACHARON
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_SIBOT_HASHLAMA_LEYOM;
PROCEDURE S_CTB_SIBOT_HASHLAMA_LEYOM
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_SIBA                      ,
                           LETZUGA                       ,
                           PAIL                          ,
                           TAARICH_IDKUN_ACHARON         ,
                           TEUR_SIBA
             FROM        CTB_SIBOT_HASHLAMA_LEYOM
             ORDER BY
                  KOD_SIBA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_SIBOT_HASHLAMA_LEYOM;
PROCEDURE U_CTB_SIBOT_HASHLAMA_LEYOM
              (
               P_KOD_SIBA                      NUMBER              ,
               P_TEUR_SIBA                     VARCHAR2,
               P_LETZUGA                       NUMBER              ,
               P_PAIL                          CHAR                ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             UPDATE      CTB_SIBOT_HASHLAMA_LEYOM
                SET
                KOD_SIBA                  = P_KOD_SIBA                 ,
                LETZUGA                   = P_LETZUGA                  ,
                PAIL                      = P_PAIL                     ,
                TAARICH_IDKUN_ACHARON     = P_TAARICH_IDKUN_ACHARON    ,
                TEUR_SIBA                 = P_TEUR_SIBA ,
				  MEADKEN_ACHARON = P_MEADKEN_ACHARON
                WHERE
                 KOD_SIBA                  = P_KOD_SIBA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_SIBOT_HASHLAMA_LEYOM;
PROCEDURE I_CTB_SIBOT_LEDIVUCH_YADANI
              (
               P_KOD_SIBA                      NUMBER              ,
			   P_TEUR_SIBA                   VARCHAR2,
			   P_GOREMET_LEBITUL_Z_NESIAA   NUMBER              ,
			   P_GOREMET_LEBITUL_Z_HALBASHA NUMBER              ,
               P_PAIL                          VARCHAR2            ,
			   P_MUTZDAK 					   NUMBER              ,
			   P_DORESH_ISHUR         VARCHAR2,
         P_TAARICH_IDKUN_ACHARON         DATE,
			   P_MEADKEN_ACHARON               NUMBER
              )
           IS
           BEGIN
             INSERT INTO CTB_SIBOT_LEDIVUCH_YADANI
                          (
                           GOREMET_LEBITUL_Zman_HALBASHA ,
                           GOREMET_LEBITUL_Zman_NESIAA   ,
                           KOD_SIBA                      ,
                           PAIL                          ,
                           TEUR_SIBA    ,
						   MUTZDAK,
						   DORESH_ISHUR,
						  MEADKEN_ACHARON,
						  TAARICH_IDKUN_ACHARON
                          )
             VALUES
                          (
                           P_GOREMET_LEBITUL_Z_HALBASHA ,
                           P_GOREMET_LEBITUL_Z_NESIAA   ,
                           P_KOD_SIBA                      ,
                           P_PAIL                          ,
                           P_TEUR_SIBA,
						   P_MUTZDAK,
						   P_DORESH_ISHUR,
						   P_MEADKEN_ACHARON,
						   P_TAARICH_IDKUN_ACHARON
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_SIBOT_LEDIVUCH_YADANI;
PROCEDURE S_CTB_SIBOT_LEDIVUCH_YADANI
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           GOREMET_LEBITUL_Zman_HALBASHA ,
                           GOREMET_LEBITUL_Zman_NESIAA   ,
                           KOD_SIBA                      ,
                           PAIL                          ,
                           TAARICH_IDKUN_ACHARON         ,
                           TEUR_SIBA,
						  MUTZDAK,
						   DORESH_ISHUR
             FROM        CTB_SIBOT_LEDIVUCH_YADANI
             ORDER BY
                  KOD_SIBA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_SIBOT_LEDIVUCH_YADANI;
PROCEDURE U_CTB_SIBOT_LEDIVUCH_YADANI
              (
               P_KOD_SIBA                      NUMBER              ,
			   P_TEUR_SIBA                   VARCHAR2,
			   P_GOREMET_LEBITUL_Z_NESIAA   NUMBER              ,
			   P_GOREMET_LEBITUL_Z_HALBASHA NUMBER              ,
               P_PAIL                          VARCHAR2            ,
			   P_MUTZDAK 					   NUMBER              ,
			   P_DORESH_ISHUR         VARCHAR2,
          P_TAARICH_IDKUN_ACHARON         DATE,
			   P_MEADKEN_ACHARON               NUMBER
              )
           IS
           BEGIN
             UPDATE      CTB_SIBOT_LEDIVUCH_YADANI
                SET
                GOREMET_LEBITUL_ZMAN_HALBasha = P_GOREMET_LEBITUL_Z_HALBasha,
                GOREMET_LEBITUL_ZMAN_NESIaa = P_GOREMET_LEBITUL_Z_NESIaa,
                PAIL                      = P_PAIL                     ,
                TAARICH_IDKUN_ACHARON     = P_TAARICH_IDKUN_ACHARON    ,
                TEUR_SIBA                 = P_TEUR_SIBA,
				 MUTZDAK				  =      P_MUTZDAK,
				 DORESH_ISHUR       = P_DORESH_ISHUR,
				 MEADKEN_ACHARON  = P_MEADKEN_ACHARON
                WHERE    KOD_SIBA                  = P_KOD_SIBA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_SIBOT_LEDIVUCH_YADANI;
PROCEDURE I_CTB_SIBOT_LOLETASHLUM
              (
              P_KOD_SIBA                      NUMBER              ,
			   P_TEUR_SIBA                     VARCHAR2 ,
               P_PAIL                          CHAR                ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             INSERT INTO CTB_SIBOT_LOLETASHLUM
                          (
                           KOD_SIBA                      ,
                           PAIL                          ,
                           TEUR_SIBA,
						   TAARICH_IDKUN_ACHARON,
							MEADKEN_ACHARON
                          )
             VALUES
                          (
                           P_KOD_SIBA                      ,
                           P_PAIL                          ,
                           P_TEUR_SIBA,
						   P_TAARICH_IDKUN_ACHARON,
						   P_MEADKEN_ACHARON
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_SIBOT_LOLETASHLUM;
PROCEDURE S_CTB_SIBOT_LOLETASHLUM
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_SIBA                      ,
                           PAIL                          ,
                           TAARICH_IDKUN_ACHARON         ,
                           TEUR_SIBA
             FROM        CTB_SIBOT_LOLETASHLUM
             ORDER BY
                  KOD_SIBA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_SIBOT_LOLETASHLUM;
PROCEDURE U_CTB_SIBOT_LOLETASHLUM
              (
               P_KOD_SIBA                      NUMBER              ,
			   P_TEUR_SIBA                     VARCHAR2 ,
               P_PAIL                          CHAR                ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             UPDATE      CTB_SIBOT_LOLETASHLUM
                SET
                KOD_SIBA                  = P_KOD_SIBA                 ,
                PAIL                      = P_PAIL                     ,
                TAARICH_IDKUN_ACHARON     = P_TAARICH_IDKUN_ACHARON    ,
                TEUR_SIBA                 = P_TEUR_SIBA,
				 MEADKEN_ACHARON = P_MEADKEN_ACHARON
                WHERE
                 KOD_SIBA                  = P_KOD_SIBA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_SIBOT_LOLETASHLUM;
PROCEDURE I_CTB_SIDURIM_MEYUCHADIM
              (
               P_KOD_SIDUR_MEYUCHAD            NUMBER              ,
               P_TEUR_SIDUR_MEYCHAD            VARCHAR2,
			   P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
               P_KOD_SIDUR_MEYUCHAD_YASHAN      NUMBER              ,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             INSERT INTO CTB_SIDURIM_MEYUCHADIM
                          (
                           KOD_SIDUR_MEYUCHAD            ,
                           PAIL                          ,
                           TEUR_SIDUR_MEYCHAD,
						   TAARICH_IDKUN_ACHARON,
						   MEADKEN_ACHARON,
                           KOD_SIDUR_MEYUCHAD_YASHAN
                          )
             VALUES
                          (
                           P_KOD_SIDUR_MEYUCHAD            ,
                           P_PAIL                          ,
                           P_TEUR_SIDUR_MEYCHAD,
						   P_TAARICH_IDKUN_ACHARON,
						   P_MEADKEN_ACHARON,
                           P_KOD_SIDUR_MEYUCHAD_YASHAN
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_SIDURIM_MEYUCHADIM;
PROCEDURE S_CTB_SIDURIM_MEYUCHADIM
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_SIDUR_MEYUCHAD            ,
                           PAIL                          ,
                           TAARICH_IDKUN_ACHARON         ,
                           TEUR_SIDUR_MEYCHAD     ,
                           KOD_SIDUR_MEYUCHAD_YASHAN
             FROM        CTB_SIDURIM_MEYUCHADIM
             ORDER BY
                  KOD_SIDUR_MEYUCHAD
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_SIDURIM_MEYUCHADIM;
PROCEDURE U_CTB_SIDURIM_MEYUCHADIM
              (
               P_KOD_SIDUR_MEYUCHAD            NUMBER              ,
               P_TEUR_SIDUR_MEYCHAD            VARCHAR2,
			   P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
               P_KOD_SIDUR_MEYUCHAD_YASHAN      NUMBER              ,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             UPDATE      CTB_SIDURIM_MEYUCHADIM
                SET
                KOD_SIDUR_MEYUCHAD        = P_KOD_SIDUR_MEYUCHAD       ,
                PAIL                      = P_PAIL                     ,
                TAARICH_IDKUN_ACHARON     = P_TAARICH_IDKUN_ACHARON    ,
                TEUR_SIDUR_MEYCHAD        = P_TEUR_SIDUR_MEYCHAD  ,
				MEADKEN_ACHARON = P_MEADKEN_ACHARON   ,
                KOD_SIDUR_MEYUCHAD_YASHAN = P_KOD_SIDUR_MEYUCHAD_YASHAN
                WHERE
                 KOD_SIDUR_MEYUCHAD        = P_KOD_SIDUR_MEYUCHAD
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_SIDURIM_MEYUCHADIM;
PROCEDURE S_CTB_SNIFEY_MASHAR
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_SNIF                      ,
                           TEUR_SNIF
             FROM        CTB_SNIFEY_MASHAR
             ORDER BY
                  KOD_SNIF
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_SNIFEY_MASHAR;
PROCEDURE S_CTB_SNIFEY_TNUAA
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_SNIF_TNUAA                ,
                           TEUR_SNIF_TNUAA
             FROM        CTB_SNIFEY_TNUAA
             ORDER BY
                  KOD_SNIF_TNUAA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_SNIFEY_TNUAA;
PROCEDURE S_CTB_SNIF_AV
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           cs.KOD_SNIF_AV                   ,
                           cs.TEUR_SNIF_AV ,
						   ct.TEUR_SNIF_TNUAA,
						   ch.TEUR_HEVRA,
						   ce.TEUR_EZOR
             FROM        CTB_SNIF_AV cs, CTB_EZOR ce,CTB_HEVRA ch,CTB_SNIFEY_TNUAA ct
			 where cs.KOD_HEVRA=ce.KOD_HEVRA
			 and cs.EZOR=ce.KOD_EZOR
			 and cs.KOD_HEVRA=ch.KOD_HEVRA
			 and cs.SNIF_TNUA=ct.KOD_SNIF_TNUAA
             ORDER BY
                  KOD_SNIF_AV
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_SNIF_AV;
PROCEDURE S_CTB_STATUS
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           ch.Teur_HEVRA                     ,
                           cs.KOD_STATUS_HILAN              ,
                           cs.KOD_STATUS_HR                 ,
                           cs.TEUR_STATUS
             FROM        CTB_STATUS cs,CTB_HEVRA ch
			 where  cs.KOD_HEVRA=ch.KOD_HEVRA
             ORDER BY
                  KOD_STATUS_HR
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_STATUS;
PROCEDURE I_CTB_STATUS_KARTIS
              (
               P_KOD_STATUS_KARTIS             NUMBER              ,
			   P_TEUR_STATUS_KARTIS            VARCHAR2,
               P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             INSERT INTO CTB_STATUS_KARTIS
                          (
                           KOD_STATUS_KARTIS             ,
                           PAIL                          ,
                           TEUR_STATUS_KARTIS ,
						   TAARICH_IDKUN_ACHARON,
							MEADKEN_ACHARON
                          )
             VALUES
                          (
                           P_KOD_STATUS_KARTIS             ,
                           P_PAIL                          ,
                           P_TEUR_STATUS_KARTIS ,
						   P_TAARICH_IDKUN_ACHARON     ,
			   			   P_MEADKEN_ACHARON
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_STATUS_KARTIS;
PROCEDURE S_CTB_STATUS_KARTIS
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_STATUS_KARTIS             ,
                           PAIL                          ,
                           TAARICH_IDKUN_ACHARON         ,
                           TEUR_STATUS_KARTIS
             FROM        CTB_STATUS_KARTIS
             ORDER BY
                  KOD_STATUS_KARTIS
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_STATUS_KARTIS;
PROCEDURE U_CTB_STATUS_KARTIS
              (
               P_KOD_STATUS_KARTIS             NUMBER              ,
			   P_TEUR_STATUS_KARTIS            VARCHAR2,
               P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             UPDATE      CTB_STATUS_KARTIS
                SET
                KOD_STATUS_KARTIS         = P_KOD_STATUS_KARTIS        ,
                PAIL                      = P_PAIL                     ,
                TAARICH_IDKUN_ACHARON     = TAARICH_IDKUN_ACHARON    ,
                TEUR_STATUS_KARTIS        = P_TEUR_STATUS_KARTIS  ,
				 MEADKEN_ACHARON = P_MEADKEN_ACHARON
                WHERE
                 KOD_STATUS_KARTIS         = P_KOD_STATUS_KARTIS
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_STATUS_KARTIS;
PROCEDURE I_CTB_SUGEY_HEADRUYUT
              (
               P_KOD_HEADRUT                   NUMBER              ,
               P_TEUR_HEADRUT                  VARCHAR2 ,
			   P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             INSERT INTO CTB_SUGEY_HEADRUYUT
                          (
                           KOD_HEADRUT                   ,
                           PAIL                          ,
                           TEUR_HEADRUT ,
						   TAARICH_IDKUN_ACHARON,
							MEADKEN_ACHARON
                          )
             VALUES
                          (
                           P_KOD_HEADRUT                   ,
                           P_PAIL                          ,
                           P_TEUR_HEADRUT,
						   P_TAARICH_IDKUN_ACHARON,
						   P_MEADKEN_ACHARON
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_SUGEY_HEADRUYUT;
PROCEDURE S_CTB_SUGEY_HEADRUYUT
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_HEADRUT                   ,
                           PAIL                          ,
                           TAARICH_IDKUN_ACHARON         ,
                           TEUR_HEADRUT
             FROM        CTB_SUGEY_HEADRUYUT
             ORDER BY
                  KOD_HEADRUT
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_SUGEY_HEADRUYUT;
PROCEDURE U_CTB_SUGEY_HEADRUYUT
              (
               P_KOD_HEADRUT                   NUMBER              ,
               P_TEUR_HEADRUT                  VARCHAR2 ,
			   P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             UPDATE      CTB_SUGEY_HEADRUYUT
                SET
                KOD_HEADRUT               = P_KOD_HEADRUT              ,
                PAIL                      = P_PAIL                     ,
                TAARICH_IDKUN_ACHARON     = P_TAARICH_IDKUN_ACHARON    ,
                TEUR_HEADRUT              = P_TEUR_HEADRUT,
				MEADKEN_ACHARON = P_MEADKEN_ACHARON
                WHERE
                 KOD_HEADRUT               = P_KOD_HEADRUT
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_SUGEY_HEADRUYUT;
PROCEDURE I_CTB_SUGEY_PREMIOT
              (
               P_KOD_PREMIA                    NUMBER              ,
               P_TEUR_PREMIA                   VARCHAR2,
			   P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             INSERT INTO CTB_SUGEY_PREMIOT
                          (
                           KOD_PREMIA                    ,
                           PAIL                          ,
                           TEUR_PREMIA,
						   TAARICH_IDKUN_ACHARON,
						   MEADKEN_ACHARON
                          )
             VALUES
                          (
                           P_KOD_PREMIA                    ,
                           P_PAIL                          ,
                           P_TEUR_PREMIA,
						   P_TAARICH_IDKUN_ACHARON,
						   P_MEADKEN_ACHARON
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_SUGEY_PREMIOT;
PROCEDURE S_CTB_SUGEY_PREMIOT
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_PREMIA                    ,
                           PAIL                          ,
                           TAARICH_IDKUN_ACHARON         ,
                           TEUR_PREMIA,
                           KOD_RACHIV_PREMIA,
                           EXCEL_FILE_COLUMN
             FROM        CTB_SUGEY_PREMIOT
             ORDER BY
                  KOD_PREMIA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_SUGEY_PREMIOT;
PROCEDURE U_CTB_SUGEY_PREMIOT
              (
               P_KOD_PREMIA                    NUMBER              ,
               P_TEUR_PREMIA                   VARCHAR2,
			   P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             UPDATE      CTB_SUGEY_PREMIOT
                SET
                KOD_PREMIA                = P_KOD_PREMIA               ,
                PAIL                      = P_PAIL                     ,
                TAARICH_IDKUN_ACHARON     = P_TAARICH_IDKUN_ACHARON    ,
                TEUR_PREMIA               = P_TEUR_PREMIA,
				MEADKEN_ACHARON =   P_MEADKEN_ACHARON
                WHERE
                 KOD_PREMIA                = P_KOD_PREMIA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_SUGEY_PREMIOT;
PROCEDURE I_CTB_SUGEY_YAMIM_MEYUCHADIM
              (
               P_SUG_YOM                       NUMBER              ,
               P_TEUR_YOM                      VARCHAR2            ,
               P_TEUR_YOM_MEKUZAR              VARCHAR2            ,
               P_YOM_AVODA                     CHAR   ,
			   P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             INSERT INTO CTB_SUGEY_YAMIM_MEYUCHADIM
                          (
                           PAIL                          ,
                           SUG_YOM                       ,
                           TEUR_YOM                      ,
                           TEUR_YOM_MEKUZAR              ,
                           YOM_AVODA,
						   TAARICH_IDKUN_ACHARON,
							MEADKEN_ACHARON
                          )
             VALUES
                          (
                           P_PAIL                          ,
                           P_SUG_YOM                       ,
                           P_TEUR_YOM                      ,
                           P_TEUR_YOM_MEKUZAR              ,
                           P_YOM_AVODA,
						   P_TAARICH_IDKUN_ACHARON,
						   P_MEADKEN_ACHARON
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_SUGEY_YAMIM_MEYUCHADIM;
PROCEDURE S_CTB_SUGEY_YAMIM_MEYUCHADIM
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           PAIL                          ,
                           SUG_YOM                       ,
                           TAARICH_IDKUN_ACHARON         ,
                           TEUR_YOM                      ,
                           TEUR_YOM_MEKUZAR              ,
                            YOM_AVODA
             FROM        CTB_SUGEY_YAMIM_MEYUCHADIM
             ORDER BY
                  SUG_YOM
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_SUGEY_YAMIM_MEYUCHADIM;
PROCEDURE U_CTB_SUGEY_YAMIM_MEYUCHADIM
              (

               P_SUG_YOM                       NUMBER              ,
               P_TEUR_YOM                      VARCHAR2            ,
               P_TEUR_YOM_MEKUZAR              VARCHAR2            ,
               P_YOM_AVODA                     CHAR   ,
			   P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number

              )
           IS
           BEGIN
             UPDATE      CTB_SUGEY_YAMIM_MEYUCHADIM
                SET
                PAIL                      = P_PAIL                     ,
                SUG_YOM                   = P_SUG_YOM                  ,
               TEUR_YOM                  = P_TEUR_YOM                 ,
                TEUR_YOM_MEKUZAR          = P_TEUR_YOM_MEKUZAR         ,
                YOM_AVODA                 = P_YOM_AVODA,
				TAARICH_IDKUN_ACHARON = P_TAARICH_IDKUN_ACHARON     ,
			     MEADKEN_ACHARON = P_MEADKEN_ACHARON
                WHERE
                 SUG_YOM                   = P_SUG_YOM
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_SUGEY_YAMIM_MEYUCHADIM;
PROCEDURE I_CTB_SUG_AVODA
              (
               P_KOD_SUG_AVODA                 NUMBER              ,
               P_PAIL                          VARCHAR2            ,
               P_TEUR_SUG_AVODA                VARCHAR2
              )
           IS
           BEGIN
             INSERT INTO CTB_SUG_AVODA
                          (
                           KOD_SUG_AVODA                 ,
                           PAIL                          ,
                           TEUR_SUG_AVODA
                          )
             VALUES
                          (
                           P_KOD_SUG_AVODA                 ,
                           P_PAIL                          ,
                           P_TEUR_SUG_AVODA
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_SUG_AVODA;
PROCEDURE S_CTB_SUG_AVODA
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_SUG_AVODA                 ,
                           PAIL                          ,
                           TAARICH_IDKUN_ACHARON         ,
                           TEUR_SUG_AVODA
             FROM        CTB_SUG_AVODA
             ORDER BY
                  KOD_SUG_AVODA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_SUG_AVODA;
PROCEDURE U_CTB_SUG_AVODA
              (
               P_KOD_SUG_AVODA                 NUMBER              ,
               P_PAIL                          VARCHAR2            ,
               P_TEUR_SUG_AVODA                VARCHAR2
              )
           IS
           BEGIN
             UPDATE      CTB_SUG_AVODA
                SET
                KOD_SUG_AVODA             = P_KOD_SUG_AVODA            ,
                PAIL                      = P_PAIL                     ,
                TAARICH_IDKUN_ACHARON     = SYSDATE    ,
                TEUR_SUG_AVODA            = P_TEUR_SUG_AVODA
                WHERE
                 KOD_SUG_AVODA             = P_KOD_SUG_AVODA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_SUG_AVODA;
PROCEDURE I_CTB_SUG_BAKASHA
              (
               P_KOD_SUG_BAKASHA               NUMBER              ,
			   P_TEUR_SUG_BAKASHA              VARCHAR2,
               P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             INSERT INTO CTB_SUG_BAKASHA
                          (
                           KOD_SUG_BAKASHA               ,
                           PAIL                          ,
                           TEUR_SUG_BAKASHA ,
						    TAARICH_IDKUN_ACHARON     ,
			   				MEADKEN_ACHARON
                          )
             VALUES
                          (
                           P_KOD_SUG_BAKASHA               ,
                           P_PAIL                          ,
                           P_TEUR_SUG_BAKASHA,
						   P_TAARICH_IDKUN_ACHARON     ,
			   			   P_MEADKEN_ACHARON
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_SUG_BAKASHA;
PROCEDURE S_CTB_SUG_BAKASHA
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_SUG_BAKASHA               ,
                           PAIL                          ,
                           TAARICH_IDKUN_ACHARON         ,
                           TEUR_SUG_BAKASHA
             FROM        CTB_SUG_BAKASHA
             ORDER BY
                  KOD_SUG_BAKASHA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_SUG_BAKASHA;
PROCEDURE U_CTB_SUG_BAKASHA
              (
               P_KOD_SUG_BAKASHA               NUMBER              ,
			   P_TEUR_SUG_BAKASHA              VARCHAR2,
               P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             UPDATE      CTB_SUG_BAKASHA
                SET
                KOD_SUG_BAKASHA           = P_KOD_SUG_BAKASHA          ,
                PAIL                      = P_PAIL                     ,
                TAARICH_IDKUN_ACHARON     = TAARICH_IDKUN_ACHARON    ,
                TEUR_SUG_BAKASHA          = P_TEUR_SUG_BAKASHA ,
				  MEADKEN_ACHARON = P_MEADKEN_ACHARON
                WHERE
                 KOD_SUG_BAKASHA           = P_KOD_SUG_BAKASHA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_SUG_BAKASHA;
PROCEDURE I_CTB_SUG_HAZMANA_VISA
              (
               P_KOD_HAZMANA                   NUMBER              ,
               --P_PAIL                          CHAR                ,
               P_TEUR_HAZMANA                  VARCHAR2            ,
               P_TEUR_HAZMANA_MEKUZAR          VARCHAR2,
			   P_Pail  						               VARCHAR2,
			   p_taarich_idkun_acharon DATE,
			   p_meadken_acharon NUMBER
              )
           IS
           BEGIN
             INSERT INTO CTB_SUG_HAZMANA_VISA
                          (
                           KOD_HAZMANA                   ,
                           PAIL                          ,
                           TEUR_HAZMANA                  ,
                           TEUR_HAZMANA_MEKUZAR,
						    taarich_idkun_acharon,
							meadken_acharon
                          )
             VALUES
                          (
                           P_KOD_HAZMANA                   ,
                           P_PAIL                          ,
                           P_TEUR_HAZMANA                  ,
                           P_TEUR_HAZMANA_MEKUZAR,
						  p_taarich_idkun_acharon ,
			   			   p_meadken_acharon
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_SUG_HAZMANA_VISA;
PROCEDURE S_CTB_SUG_HAZMANA_VISA
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_HAZMANA                   ,
                           PAIL                          ,
                           TAARICH_IDKUN_ACHARON         ,
                           TEUR_HAZMANA                  ,
                           TEUR_HAZMANA_MEKUZAR
             FROM        CTB_SUG_HAZMANA_VISA
			 order by KOD_HAZMANA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_SUG_HAZMANA_VISA;
PROCEDURE U_CTB_SUG_HAZMANA_VISA
              (
               P_KOD_HAZMANA                   NUMBER              ,
               --P_PAIL                          CHAR                ,
               P_TEUR_HAZMANA                  VARCHAR2            ,
               P_TEUR_HAZMANA_MEKUZAR          VARCHAR2,
			   P_Pail  						               VARCHAR2,
			   p_taarich_idkun_acharon DATE,
			   p_meadken_acharon NUMBER
              )
           IS
           BEGIN
             UPDATE      CTB_SUG_HAZMANA_VISA
                SET
                KOD_HAZMANA               = P_KOD_HAZMANA              ,
                PAIL                      = P_PAIL                     ,
                TAARICH_IDKUN_ACHARON     = P_TAARICH_IDKUN_ACHARON    ,
                TEUR_HAZMANA              = P_TEUR_HAZMANA             ,
                TEUR_HAZMANA_MEKUZAR      = P_TEUR_HAZMANA_MEKUZAR,
				meadken_acharon = P_meadken_acharon
                WHERE
                 KOD_HAZMANA               = P_KOD_HAZMANA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_SUG_HAZMANA_VISA;
PROCEDURE S_CTB_SUG_MISRA
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_SUG_MISRA                 ,
                           TEUR_SUG_MISRA
             FROM        CTB_SUG_MISRA
             ORDER BY
                  KOD_SUG_MISRA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_SUG_MISRA;
PROCEDURE I_CTB_SUG_PARAM_BAKASHOT
              (
               P_KOD_SUG_PARAM                 NUMBER              ,
               P_PAIL                          VARCHAR2            ,
               P_TEUR_SUG_PARAM                VARCHAR2
              )
           IS
           BEGIN
             INSERT INTO CTB_SUG_PARAM_BAKASHOT
                          (
                           KOD_SUG_PARAM                 ,
                           PAIL                          ,
                           TEUR_SUG_PARAM
                          )
             VALUES
                          (
                           P_KOD_SUG_PARAM                 ,
                           P_PAIL                          ,
                           P_TEUR_SUG_PARAM
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_SUG_PARAM_BAKASHOT;
PROCEDURE S_CTB_SUG_PARAM_BAKASHOT
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_SUG_PARAM                 ,
                           PAIL                          ,
                           TAARICH_IDKUN_ACHARON         ,
                           TEUR_SUG_PARAM
             FROM        CTB_SUG_PARAM_BAKASHOT
             ORDER BY
                  KOD_SUG_PARAM
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_SUG_PARAM_BAKASHOT;
PROCEDURE U_CTB_SUG_PARAM_BAKASHOT
              (
               P_KOD_SUG_PARAM                 NUMBER              ,
               P_PAIL                          VARCHAR2            ,
               P_TEUR_SUG_PARAM                VARCHAR2
              )
           IS
           BEGIN
             UPDATE      CTB_SUG_PARAM_BAKASHOT
                SET
                KOD_SUG_PARAM             = P_KOD_SUG_PARAM            ,
                PAIL                      = P_PAIL                     ,
                TAARICH_IDKUN_ACHARON     = SYSDATE    ,
                TEUR_SUG_PARAM            = P_TEUR_SUG_PARAM
                WHERE
                 KOD_SUG_PARAM             = P_KOD_SUG_PARAM
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_SUG_PARAM_BAKASHOT;
PROCEDURE S_CTB_SUG_SIDUR
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_SIDUR_AVODA               ,
                           TEUR_SIDUR_AVODA
             FROM        CTB_SUG_SIDUR
             ORDER BY
                  KOD_SIDUR_AVODA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_SUG_SIDUR;
PROCEDURE I_CTB_TFKIDIM_MEASHRIM
              (
               P_KOD_TAFKID_MEASHER            NUMBER              ,
               P_TEUR_TAFKID_MEASHER           VARCHAR2
              )
           IS
           BEGIN
             INSERT INTO CTB_TFKIDIM_MEASHRIM
                          (
                           KOD_TAFKID_MEASHER            ,
                           TEUR_TAFKID_MEASHER
                          )
             VALUES
                          (
                           P_KOD_TAFKID_MEASHER            ,
                           P_TEUR_TAFKID_MEASHER
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_TFKIDIM_MEASHRIM;
PROCEDURE S_CTB_TFKIDIM_MEASHRIM
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           ct.KOD_TAFKID_MEASHER            ,
                           ct.TEUR_TAFKID_MEASHER   ,
						   ct.SUG_PEILUT,
						   ch.TEUR_HEVRA
             FROM        CTB_TFKIDIM_MEASHRIM ct, ctb_hevra ch
			 where ct.kod_hevra=ch.kod_hevra
             ORDER BY
                  KOD_TAFKID_MEASHER
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_TFKIDIM_MEASHRIM;
PROCEDURE U_CTB_TFKIDIM_MEASHRIM
              (
               P_KOD_TAFKID_MEASHER            NUMBER              ,
               P_TEUR_TAFKID_MEASHER           VARCHAR2
              )
           IS
           BEGIN
             UPDATE      CTB_TFKIDIM_MEASHRIM
                SET
                KOD_TAFKID_MEASHER        = P_KOD_TAFKID_MEASHER       ,
                TEUR_TAFKID_MEASHER       = P_TEUR_TAFKID_MEASHER
                WHERE
                 KOD_TAFKID_MEASHER        = P_KOD_TAFKID_MEASHER
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_TFKIDIM_MEASHRIM;
PROCEDURE S_CTB_YECHIDA
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           ch.Teur_HEVRA                     ,
                           cy.KOD_YECHIDA                   ,
                           cy.SUG_YECHIDA                   ,
                           cy.TEUR_YECHIDA
             FROM        CTB_YECHIDA cy, CTB_HEVRA ch
             where cy.kod_hevra=ch.kod_hevra
             ORDER BY
                  KOD_YECHIDA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_YECHIDA;
PROCEDURE I_CTB_ZMANEY_HALBASHA
              (
               P_KOD_ZMAN_HALBASHA             NUMBER              ,
               P_PAIL                          VARCHAR2            ,
               P_TEUR_ZMAN_HALBASHA            VARCHAR2
              )
           IS
           BEGIN
             INSERT INTO CTB_ZMANEY_HALBASHA
                          (
                           KOD_ZMAN_HALBASHA             ,
                           PAIL                          ,
                           TEUR_ZMAN_HALBASHA
                          )
             VALUES
                          (
                           P_KOD_ZMAN_HALBASHA             ,
                           P_PAIL                          ,
                           P_TEUR_ZMAN_HALBASHA
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_ZMANEY_HALBASHA;
PROCEDURE S_CTB_ZMANEY_HALBASHA
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_ZMAN_HALBASHA             ,
                           PAIL                          ,
                           TAARICH_IDKUN_ACHARON         ,
                           TEUR_ZMAN_HALBASHA
             FROM        CTB_ZMANEY_HALBASHA
             ORDER BY
                  KOD_ZMAN_HALBASHA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_ZMANEY_HALBASHA;
PROCEDURE U_CTB_ZMANEY_HALBASHA
              (
               P_KOD_ZMAN_HALBASHA             NUMBER              ,
               P_PAIL                          VARCHAR2            ,
               P_TEUR_ZMAN_HALBASHA            VARCHAR2
              )
           IS
           BEGIN
             UPDATE      CTB_ZMANEY_HALBASHA
                SET
                KOD_ZMAN_HALBASHA         = P_KOD_ZMAN_HALBASHA        ,
                PAIL                      = P_PAIL                     ,
                TAARICH_IDKUN_ACHARON     = SYSDATE    ,
                TEUR_ZMAN_HALBASHA        = P_TEUR_ZMAN_HALBASHA
                WHERE
                 KOD_ZMAN_HALBASHA         = P_KOD_ZMAN_HALBASHA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_ZMANEY_HALBASHA;
PROCEDURE I_CTB_ZMANEY_NESIAA
              (
              P_KOD_ZMAN_NESIAA               NUMBER              ,
               P_TEUR_ZMAN_NESIAA              VARCHAR2,
			   P_PAIL                          CHAR                ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             INSERT INTO CTB_ZMANEY_NESIAA
                          (
                           KOD_ZMAN_NESIAA               ,
                           PAIL                          ,
                           TEUR_ZMAN_NESIAA  ,
						   TAARICH_IDKUN_ACHARON ,
							MEADKEN_ACHARON
                          )
             VALUES
                          (
                           P_KOD_ZMAN_NESIAA               ,
                           P_PAIL                          ,
                           P_TEUR_ZMAN_NESIAA,
						   P_TAARICH_IDKUN_ACHARON ,
						   P_MEADKEN_ACHARON
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_ZMANEY_NESIAA;
PROCEDURE S_CTB_ZMANEY_NESIAA
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_ZMAN_NESIAA               ,
                           PAIL                          ,
                           TAARICH_IDKUN_ACHARON         ,
                           TEUR_ZMAN_NESIAA
             FROM        CTB_ZMANEY_NESIAA
             ORDER BY
                  KOD_ZMAN_NESIAA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_ZMANEY_NESIAA;
PROCEDURE U_CTB_ZMANEY_NESIAA
              (
               P_KOD_ZMAN_NESIAA               NUMBER              ,
               P_TEUR_ZMAN_NESIAA              VARCHAR2,
			   P_PAIL                          CHAR                ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             UPDATE      CTB_ZMANEY_NESIAA
                SET
                KOD_ZMAN_NESIAA           = P_KOD_ZMAN_NESIAA          ,
                PAIL                      = P_PAIL                     ,
                TAARICH_IDKUN_ACHARON     = P_TAARICH_IDKUN_ACHARON    ,
                TEUR_ZMAN_NESIAA          = P_TEUR_ZMAN_NESIAA,
				 MEADKEN_ACHARON = P_MEADKEN_ACHARON
                WHERE
                 KOD_ZMAN_NESIAA           = P_KOD_ZMAN_NESIAA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_ZMANEY_NESIAA;
PROCEDURE I_CTB_ZMAN_NSIAA_MISHTANE
              (
               P_MERKAZ_ERUA                   NUMBER              ,
			   P_MIKUM_YAAD                    NUMBER ,
               P_DAKOT                         NUMBER              ,
               P_ME_TAARICH                    DATE                ,
			   P_AD_TAARICH                    DATE,
			   P_TAARICH_IDKUN_ACHARON         DATE,
			   P_MEADKEN_ACHARON               NUMBER
              )
           IS
           BEGIN
             INSERT INTO CTB_ZMAN_NSIAA_MISHTANE
                          (
                           AD_TAARICH                    ,
                           MERKAZ_ERUA                   ,
                           DAKOT                         ,
                           ME_TAARICH                    ,
                           MIKUM_YAAD,
						   TAARICH_IDKUN_ACHARON,
							MEADKEN_ACHARON
                          )
             VALUES
                          (
                           P_AD_TAARICH                    ,
                           P_MERKAZ_ERUA                   ,
                           P_DAKOT                         ,
                           P_ME_TAARICH                    ,
                           P_MIKUM_YAAD,
						   P_TAARICH_IDKUN_ACHARON,
						   P_MEADKEN_ACHARON
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_ZMAN_NSIAA_MISHTANE;
PROCEDURE S_CTB_ZMAN_NSIAA_MISHTANE
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           cz.AD_TAARICH                    ,
                          cm.TEUR_MERKAZ_EROA                    ,
                          cz.MERKAZ_ERUA  KOD_MERKAZ_EROA,
                           cz.DAKOT                         ,
                           cz.ME_TAARICH                    ,
                           cy.TEUR_MIKUM_YECHIDA                     ,
                           cz.TAARICH_IDKUN_ACHARON         ,
                           cz.MIKUM_YAAD KOD_MIKUM_YECHIDA
             FROM        CTB_ZMAN_NSIAA_MISHTANE cz,CTB_MERKAZ_EROA cm,CTB_MIKUM_YECHIDA cy
             where cm.KOD_MERKAZ_EROA=cz.MERKAZ_ERUA
			 and cy.KOD_MIKUM_YECHIDA=cz.MIKUM_YAAD
             ORDER BY
                  cm.TEUR_MERKAZ_EROA     ,
                  cy.TEUR_MIKUM_YECHIDA          ,
                  ME_TAARICH
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_ZMAN_NSIAA_MISHTANE;
PROCEDURE U_CTB_ZMAN_NSIAA_MISHTANE
              (
               P_MERKAZ_ERUA                   NUMBER              ,
			   P_MIKUM_YAAD                    NUMBER ,
               P_DAKOT                         NUMBER              ,
               P_ME_TAARICH                    DATE                ,
			   P_AD_TAARICH                    DATE,
			   P_TAARICH_IDKUN_ACHARON         DATE,
			   P_MEADKEN_ACHARON               NUMBER
              )
           IS
           BEGIN
             UPDATE      CTB_ZMAN_NSIAA_MISHTANE
                SET
                AD_TAARICH                = P_AD_TAARICH               ,
                MERKAZ_ERUA               = P_MERKAZ_ERUA              ,
                DAKOT                     = P_DAKOT                    ,
                ME_TAARICH                = P_ME_TAARICH               ,
                MIKUM_YAAD                = P_MIKUM_YAAD               ,
                TAARICH_IDKUN_ACHARON     = P_TAARICH_IDKUN_ACHARON,
				 MEADKEN_ACHARON = P_MEADKEN_ACHARON
                WHERE
                 MERKAZ_ERUA               = P_MERKAZ_ERUA
				 and  MIKUM_YAAD                = P_MIKUM_YAAD
				 and  ME_TAARICH                = P_ME_TAARICH
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_ZMAN_NSIAA_MISHTANE;
PROCEDURE I_CTB_ISHURIM
              (
             P_KOD_ISHUR                     NUMBER              ,
			   P_TEUR_ISHUR                    VARCHAR2,
               P_MEAKEV_TASHLUM                NUMBER              ,
               P_PAIL                          VARCHAR2            ,
			  P_MAFNE_LESADE     VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             INSERT INTO CTB_ISHURIM
                          (
                           KOD_ISHUR                     ,
                           MEAKEV_TASHLUM                ,
                           PAIL                          ,
                           TEUR_ISHUR,
						   TAARICH_IDKUN_ACHARON,
						    MEADKEN_ACHARON,
							MAFNE_LESADE
                          )
             VALUES
                          (
                           P_KOD_ISHUR                     ,
                           P_MEAKEV_TASHLUM                ,
                           P_PAIL                          ,
                           P_TEUR_ISHUR,
						   P_TAARICH_IDKUN_ACHARON,
						   P_MEADKEN_ACHARON,
						   P_MAFNE_LESADE
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_ISHURIM;
PROCEDURE S_CTB_ISHURIM
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_ISHUR                     ,
                           MEAKEV_TASHLUM                ,
                           PAIL                          ,
                           TAARICH_IDKUN_ACHARON         ,
                           TEUR_ISHUR ,
						   MAFNE_LESADE
             FROM        CTB_ISHURIM
             ORDER BY
                  KOD_ISHUR
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_ISHURIM;
PROCEDURE U_CTB_ISHURIM
              (
               P_KOD_ISHUR                     NUMBER              ,
			   P_TEUR_ISHUR                    VARCHAR2,
               P_MEAKEV_TASHLUM                NUMBER              ,
               P_PAIL                          VARCHAR2            ,
			  P_MAFNE_LESADE     VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             UPDATE      CTB_ISHURIM
                SET
                KOD_ISHUR                 = P_KOD_ISHUR                ,
                MEAKEV_TASHLUM            = P_MEAKEV_TASHLUM           ,
                PAIL                      = P_PAIL                     ,
                TAARICH_IDKUN_ACHARON     = TAARICH_IDKUN_ACHARON    ,
                TEUR_ISHUR                = P_TEUR_ISHUR,
				MEADKEN_ACHARON = P_MEADKEN_ACHARON,
				MAFNE_LESADE = P_MAFNE_LESADE
                WHERE
                 KOD_ISHUR                 = P_KOD_ISHUR
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_ISHURIM;
PROCEDURE I_CTB_MEAFYENEY_ELEMENTIM
              (
               P_KOD_MEAFYEN                   NUMBER              ,
               P_SHEM_MEAFYEN                  VARCHAR2            ,
               P_SUG_NATUN                     VARCHAR2      ,
			   P_PAIL                          CHAR                ,
			   P_KOD_SUG_ERECH                   NUMBER              ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             INSERT INTO CTB_MEAFYENEY_ELEMENTIM
                          (
                           KOD_MEAFYEN                   ,
                           PAIL                          ,
                           SHEM_MEAFYEN                  ,
                           SUG_NATUN ,
						   TAARICH_IDKUN_ACHARON,
						   KOD_SUG_ERECH                                 ,
						    MEADKEN_ACHARON
                          )
             VALUES
                          (
                           P_KOD_MEAFYEN                   ,
                           P_PAIL                          ,
                           P_SHEM_MEAFYEN                  ,
                           P_SUG_NATUN ,
						   P_TAARICH_IDKUN_ACHARON,
						   P_KOD_SUG_ERECH,
						   P_MEADKEN_ACHARON
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_MEAFYENEY_ELEMENTIM;
PROCEDURE S_CTB_MEAFYENEY_ELEMENTIM
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           cm.KOD_MEAFYEN                   ,
                           cm.PAIL                          ,
                           cm.SHEM_MEAFYEN                  ,
                           cm.SUG_NATUN                     ,
                           cm.TAARICH_IDKUN_ACHARON ,
						    cm.KOD_SUG_ERECH,
							ar.TEUR_SUG_ERECH
             FROM        CTB_MEAFYENEY_ELEMENTIM cm,CTB_SUGEY_ARACHIM ar
			 where cm.KOD_SUG_ERECH= ar.KOD_SUG_ERECH
             ORDER BY
                  KOD_MEAFYEN
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_MEAFYENEY_ELEMENTIM;
PROCEDURE U_CTB_MEAFYENEY_ELEMENTIM
              (
               P_KOD_MEAFYEN                   NUMBER              ,
               P_SHEM_MEAFYEN                  VARCHAR2            ,
	           P_SUG_NATUN                     VARCHAR2      ,
			   P_PAIL                          char               ,
			   P_KOD_SUG_ERECH                   NUMBER              ,
          P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             UPDATE      CTB_MEAFYENEY_ELEMENTIM
                SET
                KOD_MEAFYEN               = P_KOD_MEAFYEN              ,
                PAIL                      = P_PAIL                     ,
                SHEM_MEAFYEN              = P_SHEM_MEAFYEN             ,
                SUG_NATUN                 = P_SUG_NATUN                ,
                TAARICH_IDKUN_ACHARON     = TAARICH_IDKUN_ACHARON,
				KOD_SUG_ERECH = P_KOD_SUG_ERECH                                 ,
				 MEADKEN_ACHARON = P_MEADKEN_ACHARON
                WHERE
                 KOD_MEAFYEN               = P_KOD_MEAFYEN
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_MEAFYENEY_ELEMENTIM;
PROCEDURE I_CTB_MEAFYENEY_SIDURIM
              (
               P_KOD_MEAFYEN                   NUMBER              ,
			   P_SHEM_MEAFYEN                  VARCHAR2            ,
			   P_TEUR_MEAFYEN                  VARCHAR2 ,
			   P_SUG_NATUN                     VARCHAR2            ,
			   P_SIDUR_MEYUCHAD_OR_SUG_SIDUR   NUMBER              ,
			   P_PAIL                          CHAR                ,
               P_KOD_SUG_ERECH                   NUMBER              ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             INSERT INTO CTB_MEAFYENEY_SIDURIM
                          (
                           KOD_MEAFYEN                   ,
                           PAIL                          ,
                           SHEM_MEAFYEN                  ,
                           SIDUR_MEYUCHAD_OR_SUG_SIDUR   ,
                           SUG_NATUN                     ,
                           TEUR_MEAFYEN,
						    TAARICH_IDKUN_ACHARON,
							KOD_SUG_ERECH,
							 MEADKEN_ACHARON
                          )
             VALUES
                          (
                           P_KOD_MEAFYEN                   ,
                           P_PAIL                          ,
                           P_SHEM_MEAFYEN                  ,
                           P_SIDUR_MEYUCHAD_OR_SUG_SIDUR   ,
                           P_SUG_NATUN                     ,
                           P_TEUR_MEAFYEN,
						   P_TAARICH_IDKUN_ACHARON,
						   P_KOD_SUG_ERECH,
						   P_MEADKEN_ACHARON
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_MEAFYENEY_SIDURIM;
PROCEDURE S_CTB_MEAFYENEY_SIDURIM
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           a1.KOD_MEAFYEN                   ,
                           a1.PAIL                          ,
                           a1.SHEM_MEAFYEN                  ,
                           a1.SIDUR_MEYUCHAD_OR_SUG_SIDUR   ,
                           a1.SUG_NATUN                     ,
                           a1.TAARICH_IDKUN_ACHARON         ,
                           a1.TEUR_MEAFYEN,
						   a1.KOD_SUG_ERECH,
						   b1.TEUR_SUG_ERECH
             FROM        CTB_MEAFYENEY_SIDURIM a1,CTB_SUGEY_ARACHIM b1
			 where a1.KOD_SUG_ERECH= b1.KOD_SUG_ERECH
			 order by KOD_MEAFYEN
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_MEAFYENEY_SIDURIM;
PROCEDURE U_CTB_MEAFYENEY_SIDURIM
              (
               P_KOD_MEAFYEN                   NUMBER              ,
			   P_SHEM_MEAFYEN                  VARCHAR2            ,
			   P_TEUR_MEAFYEN                  VARCHAR2 ,
			   P_SUG_NATUN                     VARCHAR2            ,
			   P_SIDUR_MEYUCHAD_OR_SUG_SIDUR   NUMBER              ,
			   P_PAIL                          CHAR                ,
               P_KOD_SUG_ERECH                   NUMBER              ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             UPDATE      CTB_MEAFYENEY_SIDURIM
                SET
                KOD_MEAFYEN               = P_KOD_MEAFYEN              ,
                PAIL                      = P_PAIL                     ,
                SHEM_MEAFYEN              = P_SHEM_MEAFYEN             ,
                SIDUR_MEYUCHAD_OR_SUG_SIDur = P_SIDUR_MEYUCHAD_OR_SUG_SIDur,
                SUG_NATUN                 = P_SUG_NATUN                ,
                TAARICH_IDKUN_ACHARON     = P_TAARICH_IDKUN_ACHARON    ,
                TEUR_MEAFYEN              = P_TEUR_MEAFYEN ,
				KOD_SUG_ERECH = P_KOD_SUG_ERECH,
				 MEADKEN_ACHARON=P_MEADKEN_ACHARON
                WHERE
                 KOD_MEAFYEN               = P_KOD_MEAFYEN
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_MEAFYENEY_SIDURIM;
PROCEDURE I_CTB_PARAMETRIM
              (
               P_KOD_PARAM                     NUMBER              ,
			   P_TEUR_PARAM                    VARCHAR2 ,
			   P_SUG_NATUN                     VARCHAR2            ,
               P_PAIL                          VARCHAR2            ,
			   P_KOD_SUG_ERECH                   NUMBER              ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             INSERT INTO CTB_PARAMETRIM
                          (
                           KOD_PARAM                     ,
                           PAIL                          ,
                           SUG_NATUN                     ,
                           TEUR_PARAM,
						     KOD_SUG_ERECH,
						   TAARICH_IDKUN_ACHARON,
							MEADKEN_ACHARON
                          )
             VALUES
                          (
                           P_KOD_PARAM                     ,
                           P_PAIL                          ,
                           P_SUG_NATUN                     ,
                           P_TEUR_PARAM,
						   P_KOD_SUG_ERECH,
						   P_TAARICH_IDKUN_ACHARON,
						   P_MEADKEN_ACHARON
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_PARAMETRIM;
PROCEDURE S_CTB_PARAMETRIM
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           p.KOD_PARAM                     ,
                           p.PAIL                          ,
                           p.SUG_NATUN                     ,
                           p.TAARICH_IDKUN_ACHARON         ,
                           p.TEUR_PARAM ,
						   p.KOD_SUG_ERECH,
						   s.TEUR_SUG_ERECH
             FROM        CTB_PARAMETRIM p,CTB_SUGEY_ARACHIM s
			 where p.KOD_SUG_ERECH= s.KOD_SUG_ERECH
             ORDER BY
                  KOD_PARAM
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_PARAMETRIM;
PROCEDURE U_CTB_PARAMETRIM
              (
               P_KOD_PARAM                     NUMBER              ,
			   P_TEUR_PARAM                    VARCHAR2 ,
			   P_SUG_NATUN                     VARCHAR2            ,
               P_PAIL                          VARCHAR2            ,
			   P_KOD_SUG_ERECH                   NUMBER              ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             UPDATE      CTB_PARAMETRIM
                SET
                KOD_PARAM                 = P_KOD_PARAM                ,
                PAIL                      = P_PAIL                     ,
                SUG_NATUN                 = P_SUG_NATUN                ,
                TAARICH_IDKUN_ACHARON     = P_TAARICH_IDKUN_ACHARON    ,
                TEUR_PARAM                = P_TEUR_PARAM ,
				KOD_SUG_ERECH = P_KOD_SUG_ERECH,
				 MEADKEN_ACHARON =  P_MEADKEN_ACHARON
                WHERE
                 KOD_PARAM                 = P_KOD_PARAM
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_PARAMETRIM;
PROCEDURE I_CTB_RECHIVIM
              (
  			   P_KOD_RECHIV                    NUMBER              ,
			   P_TEUR_RECHIV                   VARCHAR2,
               P_LETZUGA_BESIKUM_CHODSHI       NUMBER,
               P_MIYUN_BESIKUM_CHODSHI         NUMBER              ,
			   P_LETZUGA_BETIHKUR_RASHEMET Number,
			   P_KOD_HEADRUT_CLALI Number,
			   P_YESH_HEARA Number,
               P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             INSERT INTO CTB_RECHIVIM
                          (
                           KOD_RECHIV                    ,
                           LETZUGA_BESIKUM_CHODSHI       ,
                           MIYUN_BESIKUM_CHODSHI         ,
                           PAIL                          ,
                           TEUR_RECHIV,
						    LETZUGA_BETIHKUR_RASHEMET ,
			  				KOD_HEADRUT_CLALI ,
			  				YESH_HEARA ,
			   				TAARICH_IDKUN_ACHARON     ,
			   				MEADKEN_ACHARON
                          )
             VALUES
                          (
                           P_KOD_RECHIV                    ,
                           P_LETZUGA_BESIKUM_CHODSHI       ,
                           P_MIYUN_BESIKUM_CHODSHI         ,
                           P_PAIL                          ,
                           P_TEUR_RECHIV,
						    P_LETZUGA_BETIHKUR_RASHEMET ,
			   				P_KOD_HEADRUT_CLALI ,
			   				P_YESH_HEARA ,
			   				P_TAARICH_IDKUN_ACHARON     ,
			   				P_MEADKEN_ACHARON
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_RECHIVIM;
PROCEDURE S_CTB_RECHIVIM
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_RECHIV                    ,
                           LETZUGA_BESIKUM_CHODSHI       ,
                           MIYUN_BESIKUM_CHODSHI         ,
                           PAIL                          ,
                           TAARICH_IDKUN_ACHARON         ,
                           TEUR_RECHIV ,
						   LETZUGA_BETIHKUR_RASHEMET,
						   KOD_HEADRUT_CLALI,
						   YESH_HEARA
             FROM        CTB_RECHIVIM
             ORDER BY
                  KOD_RECHIV
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_RECHIVIM;
PROCEDURE U_CTB_RECHIVIM
              (
               P_KOD_RECHIV                    NUMBER              ,
			   P_TEUR_RECHIV                   VARCHAR2,
               P_LETZUGA_BESIKUM_CHODSHI       NUMBER,
               P_MIYUN_BESIKUM_CHODSHI         NUMBER              ,
			   P_LETZUGA_BETIHKUR_RASHEMET Number,
			   P_KOD_HEADRUT_CLALI Number,
			   P_YESH_HEARA Number,
               P_PAIL                          VARCHAR2            ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             UPDATE      CTB_RECHIVIM
                SET
                KOD_RECHIV                = P_KOD_RECHIV               ,
                LETZUGA_BESIKUM_CHODSHI   = P_LETZUGA_BESIKUM_CHODSHI  ,
                MIYUN_BESIKUM_CHODSHI     = P_MIYUN_BESIKUM_CHODSHI    ,
                PAIL                      = P_PAIL                     ,
                TAARICH_IDKUN_ACHARON     = P_TAARICH_IDKUN_ACHARON    ,
                TEUR_RECHIV               = P_TEUR_RECHIV,
				 LETZUGA_BETIHKUR_RASHEMET = P_LETZUGA_BETIHKUR_RASHEMET ,
			   	 KOD_HEADRUT_CLALI = P_KOD_HEADRUT_CLALI ,
			   	 YESH_HEARA = P_YESH_HEARA ,
			   	 MEADKEN_ACHARON = P_MEADKEN_ACHARON
                WHERE
                 KOD_RECHIV                = P_KOD_RECHIV
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_RECHIVIM;
PROCEDURE I_TB_MICHSA_AGAPIT
              (
               P_KOD_AGAF                      NUMBER              ,
               P_ME_TAARICH                    DATE                ,
               P_AD_TAARICH                    DATE,
               P_MICHSA_AGAPIT                 NUMBER,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             INSERT INTO TB_MICHSA_AGAPIT
                          (
                           AD_TAARICH                    ,
                           KOD_AGAF                      ,
                           ME_TAARICH                    ,
                           MICHSA_AGAPIT,
						  TAARICH_IDKUN_ACHARON,
						   MEADKEN_ACHARON

                          )
             VALUES
                          (
                           P_AD_TAARICH                    ,
                           P_KOD_AGAF                      ,
                           P_ME_TAARICH                    ,
                           P_MICHSA_AGAPIT  ,
						   P_TAARICH_IDKUN_ACHARON,
						   P_MEADKEN_ACHARON
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_TB_MICHSA_AGAPIT;
PROCEDURE S_TB_MICHSA_AGAPIT
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           tm.AD_TAARICH                    ,
                           cy.TEUR_YECHIDA                      ,
                           tm.ME_TAARICH                    ,
                           tm.MICHSA_AGAPIT                 ,
                           tm.TAARICH_IDKUN_ACHARON       ,
                           tm.KOD_AGAF
             FROM        TB_MICHSA_AGAPIT tm,CTB_YECHIDA cy
             where tm.KOD_AGAF=cy.KOD_YECHIDA
             ORDER BY
                  cy.TEUR_YECHIDA, tm.ME_TAARICH
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_TB_MICHSA_AGAPIT;
PROCEDURE U_TB_MICHSA_AGAPIT
              (
               P_KOD_AGAF                      NUMBER              ,
               P_ME_TAARICH                    DATE                ,
               P_AD_TAARICH                    DATE,
               P_MICHSA_AGAPIT                 NUMBER,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             UPDATE      TB_MICHSA_AGAPIT
                SET
                AD_TAARICH                = P_AD_TAARICH               ,
                KOD_AGAF                  = P_KOD_AGAF                 ,
                ME_TAARICH                = P_ME_TAARICH               ,
                MICHSA_AGAPIT             = P_MICHSA_AGAPIT            ,
                TAARICH_IDKUN_ACHARON     = P_TAARICH_IDKUN_ACHARON,
				 MEADKEN_ACHARON		  	= P_MEADKEN_ACHARON
                WHERE
                 KOD_AGAF                  = P_KOD_AGAF
				 And ME_TAARICH                = P_ME_TAARICH
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_TB_MICHSA_AGAPIT;
PROCEDURE I_TB_MICHSA_YOMIT
              (
                   P_KOD_MICHSA                    NUMBER              ,
				   P_SUG_YOM                       NUMBER,
  				   P_SHAVOA_AVODA                  NUMBER              ,
                   P_ME_TAARICH                    DATE                ,
               	   P_AD_TAARICH                    DATE,
              	   P_MICHSA                        NUMBER,
				   P_TAARICH_IDKUN_ACHARON         DATE,
			   	   P_MEADKEN_ACHARON               NUMBER
              )
           IS
           BEGIN
             INSERT INTO TB_MICHSA_YOMIT
                          (
                           AD_TAARICH                    ,
                           KOD_MICHSA                    ,
                           ME_TAARICH                    ,
                           MICHSA                        ,
                           SHAVOA_AVODA                  ,
                           SUG_YOM   ,
						   TAARICH_IDKUN_ACHARON,
							MEADKEN_ACHARON
                          )
             VALUES
                          (
                           P_AD_TAARICH                    ,
                           P_KOD_MICHSA                    ,
                           P_ME_TAARICH                    ,
                           P_MICHSA                        ,
                           P_SHAVOA_AVODA                  ,
                           P_SUG_YOM,
						   P_TAARICH_IDKUN_ACHARON,
						P_MEADKEN_ACHARON
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_TB_MICHSA_YOMIT;
PROCEDURE S_TB_MICHSA_YOMIT
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           tm.AD_TAARICH                    ,
                           tm.KOD_MICHSA                    ,
                           tm.ME_TAARICH                    ,
                           tm.MICHSA                        ,
                           tm.SHAVOA_AVODA                  ,
                           tm.SUG_YOM                       ,
                           tm.TAARICH_IDKUN_ACHARON,
						   cs.TEUR_YOM
             FROM        TB_MICHSA_YOMIT tm,CTB_SUGEY_YAMIM_MEYUCHADIM cs
             where tm.SUG_YOM=cs.SUG_YOM
             ORDER BY
                  KOD_MICHSA          ,
                  SHAVOA_AVODA        ,
                  ME_TAARICH
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_TB_MICHSA_YOMIT;
PROCEDURE U_TB_MICHSA_YOMIT
              (
			       P_KOD_MICHSA                    NUMBER              ,
				   P_SUG_YOM                       NUMBER,
  				   P_SHAVOA_AVODA                  NUMBER              ,
                   P_ME_TAARICH                    DATE                ,
               	   P_AD_TAARICH                    DATE,
              	   P_MICHSA                        NUMBER,
				   P_TAARICH_IDKUN_ACHARON         DATE,
			   	   P_MEADKEN_ACHARON               NUMBER
              )
           IS
           BEGIN
             UPDATE      TB_MICHSA_YOMIT
                SET
                AD_TAARICH                = P_AD_TAARICH               ,
                KOD_MICHSA                = P_KOD_MICHSA               ,
                ME_TAARICH                = P_ME_TAARICH               ,
                MICHSA                    = P_MICHSA                   ,
                SHAVOA_AVODA              = P_SHAVOA_AVODA             ,
                SUG_YOM                   = P_SUG_YOM                  ,
                TAARICH_IDKUN_ACHARON     = P_TAARICH_IDKUN_ACHARON,
				 MEADKEN_ACHARON 		  =P_MEADKEN_ACHARON
                WHERE
                 SUG_YOM                   = P_SUG_YOM
				 and  KOD_MICHSA   = P_KOD_MICHSA
				 and ME_TAARICH    = P_ME_TAARICH
				 and SHAVOA_AVODA              = P_SHAVOA_AVODA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_TB_MICHSA_YOMIT;
PROCEDURE I_TB_YAMIM_MEYUCHADIM
              (
               P_SUG_YOM                       NUMBER              ,
               P_SUG_YOM_MUCHLAF_MESHEK        NUMBER              ,
               P_SUG_YOM_MUCHLAF_MINHAL        NUMBER              ,
               P_SUG_YOM_MUCHLAF_NEHAGUT       NUMBER              ,
               P_SUG_YOM_MUCHLAF_TNUA          NUMBER              ,
               P_TAARICH                       DATE
              )
           IS
           BEGIN
             INSERT INTO TB_YAMIM_MEYUCHADIM
                          (
                           SUG_YOM                       ,
                           SUG_YOM_MUCHLAF_MESHEK        ,
                           SUG_YOM_MUCHLAF_MINHAL        ,
                           SUG_YOM_MUCHLAF_NEHAGUT       ,
                           SUG_YOM_MUCHLAF_TNUA          ,
                           TAARICH
                          )
             VALUES
                          (
                           P_SUG_YOM                       ,
                           P_SUG_YOM_MUCHLAF_MESHEK        ,
                           P_SUG_YOM_MUCHLAF_MINHAL        ,
                           P_SUG_YOM_MUCHLAF_NEHAGUT       ,
                           P_SUG_YOM_MUCHLAF_TNUA          ,
                           P_TAARICH
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_TB_YAMIM_MEYUCHADIM;
PROCEDURE S_TB_YAMIM_MEYUCHADIM
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           SUG_YOM                       ,
                           SUG_YOM_MUCHLAF_MESHEK        ,
                           SUG_YOM_MUCHLAF_MINHAL        ,
                           SUG_YOM_MUCHLAF_NEHAGUT       ,
                           SUG_YOM_MUCHLAF_TNUA          ,
                           TAARICH                       ,
                           TAARICH_IDKUN_ACHARON
             FROM        TB_YAMIM_MEYUCHADIM
             ORDER BY
                  TAARICH
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_TB_YAMIM_MEYUCHADIM;
PROCEDURE U_TB_YAMIM_MEYUCHADIM
              (
               P_SUG_YOM                       NUMBER              ,
               P_SUG_YOM_MUCHLAF_MESHEK        NUMBER              ,
               P_SUG_YOM_MUCHLAF_MINHAL        NUMBER              ,
               P_SUG_YOM_MUCHLAF_NEHAGUT       NUMBER              ,
               P_SUG_YOM_MUCHLAF_TNUA          NUMBER              ,
               P_TAARICH                       DATE
              )
           IS
           BEGIN
             UPDATE      TB_YAMIM_MEYUCHADIM
                SET
                SUG_YOM                   = P_SUG_YOM                  ,
                SUG_YOM_MUCHLAF_MESHEK    = P_SUG_YOM_MUCHLAF_MESHEK   ,
                SUG_YOM_MUCHLAF_MINHAL    = P_SUG_YOM_MUCHLAF_MINHAL   ,
                SUG_YOM_MUCHLAF_NEHAGUT   = P_SUG_YOM_MUCHLAF_NEHAGUT  ,
                SUG_YOM_MUCHLAF_TNUA      = P_SUG_YOM_MUCHLAF_TNUA     ,
                TAARICH                   = P_TAARICH                  ,
                TAARICH_IDKUN_ACHARON     = SYSDATE
                WHERE
                 TAARICH                   = P_TAARICH
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_TB_YAMIM_MEYUCHADIM;
PROCEDURE S_OVDIM_IM_SHINUY_HR
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           MISPAR_ISHI                   ,
                           TAARICH,
                           TAARICH_IDKUN_HR
             FROM        OVDIM_IM_SHINUY_HR
             ORDER BY
                  MISPAR_ISHI
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_OVDIM_IM_SHINUY_HR;
PROCEDURE I_CTB_MERKAZ_EROA
              (
               P_KOD_MERKAZ_EROA               NUMBER              ,
			   P_TEUR_MERKAZ_EROA              VARCHAR2 ,
               P_KOD_MERKAZ_EROA_EZORI         NUMBER              ,
               P_PAIL                          CHAR                ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             INSERT INTO CTB_MERKAZ_EROA
                          (
                           KOD_MERKAZ_EROA               ,
                           KOD_MERKAZ_EROA_EZORI         ,
                           PAIL                          ,
                           TEUR_MERKAZ_EROA ,
						   TAARICH_IDKUN_ACHARON,
						    MEADKEN_ACHARON
                          )
             VALUES
                          (
                           P_KOD_MERKAZ_EROA               ,
                           P_KOD_MERKAZ_EROA_EZORI         ,
                           P_PAIL                          ,
                           P_TEUR_MERKAZ_EROA,
						   P_TAARICH_IDKUN_ACHARON,
						    P_MEADKEN_ACHARON
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_MERKAZ_EROA;
PROCEDURE S_CTB_MERKAZ_EROA
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_MERKAZ_EROA               ,
                           KOD_MERKAZ_EROA_EZORI         ,
                           PAIL                          ,
                           TAARICH_IDKUN_ACHARON         ,
                           TEUR_MERKAZ_EROA
             FROM        CTB_MERKAZ_EROA
             ORDER BY
                  KOD_MERKAZ_EROA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_MERKAZ_EROA;
PROCEDURE U_CTB_MERKAZ_EROA
              (
               P_KOD_MERKAZ_EROA               NUMBER              ,
			   P_TEUR_MERKAZ_EROA              VARCHAR2 ,
               P_KOD_MERKAZ_EROA_EZORI         NUMBER              ,
               P_PAIL                          CHAR                ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             UPDATE      CTB_MERKAZ_EROA
                SET
                KOD_MERKAZ_EROA           = P_KOD_MERKAZ_EROA          ,
                KOD_MERKAZ_EROA_EZORI     = P_KOD_MERKAZ_EROA_EZORI    ,
                PAIL                      = P_PAIL                     ,
                TAARICH_IDKUN_ACHARON     = P_TAARICH_IDKUN_ACHARON    ,
                TEUR_MERKAZ_EROA          = P_TEUR_MERKAZ_EROA ,
				 MEADKEN_ACHARON = P_MEADKEN_ACHARON
                WHERE
                 KOD_MERKAZ_EROA           = P_KOD_MERKAZ_EROA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_MERKAZ_EROA;
PROCEDURE I_CTB_MIKUM_YECHIDA
              (
               P_KOD_MIKUM_YECHIDA             NUMBER              ,
               P_TEUR_MIKUM_YECHIDA            VARCHAR2 ,
			   P_Kod_mikum_yechida_ezori		   NUMBER,
			   P_Pail							     VARCHAR2 ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             INSERT INTO CTB_MIKUM_YECHIDA
                          (
                           KOD_MIKUM_YECHIDA             ,
                           TEUR_MIKUM_YECHIDA,
						   Kod_mikum_yechida_ezori	,
						   Pail,
						  TAARICH_IDKUN_ACHARON,
						   MEADKEN_ACHARON
                          )
             VALUES
                          (
                           P_KOD_MIKUM_YECHIDA             ,
                           P_TEUR_MIKUM_YECHIDA,
						  P_Kod_mikum_yechida_ezori	,
						  P_Pail,
						  P_TAARICH_IDKUN_ACHARON,
						  P_MEADKEN_ACHARON
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_MIKUM_YECHIDA;
PROCEDURE S_CTB_MIKUM_YECHIDA
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_MIKUM_YECHIDA             ,
                           TEUR_MIKUM_YECHIDA ,
						   KOD_MIKUM_YECHIDA_EZORI,
						   pail,
						   TAARICH_IDKUN_ACHARON
             FROM        CTB_MIKUM_YECHIDA
             ORDER BY
                  KOD_MIKUM_YECHIDA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_MIKUM_YECHIDA;
PROCEDURE U_CTB_MIKUM_YECHIDA
              (
               P_KOD_MIKUM_YECHIDA             NUMBER              ,
               P_TEUR_MIKUM_YECHIDA            VARCHAR2 ,
			   P_Kod_mikum_yechida_ezori		   NUMBER,
			   P_Pail							     VARCHAR2 ,
			   P_TAARICH_IDKUN_ACHARON     Date,
			   P_MEADKEN_ACHARON            Number
              )
           IS
           BEGIN
             UPDATE      CTB_MIKUM_YECHIDA
                SET
                KOD_MIKUM_YECHIDA         = P_KOD_MIKUM_YECHIDA        ,
                TEUR_MIKUM_YECHIDA        = P_TEUR_MIKUM_YECHIDA,
				Kod_mikum_yechida_ezori		   = P_Kod_mikum_yechida_ezori,
			    Pail							     						   =P_Pail	 ,
			   TAARICH_IDKUN_ACHARON     = P_TAARICH_IDKUN_ACHARON,
			   MEADKEN_ACHARON                   = P_MEADKEN_ACHARON
                WHERE
                 KOD_MIKUM_YECHIDA         = P_KOD_MIKUM_YECHIDA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_MIKUM_YECHIDA;
PROCEDURE I_CTB_MIVTZA_VISA
              (
               P_KOD_MIVTZA_VISA               NUMBER              ,
			   P_TEUR_MIVTZA_VISA              VARCHAR2,
               P_PAIL                          VARCHAR2            ,
			   p_taarich_idkun_acharon DATE,
			   p_meadken_acharon NUMBER
              )
           IS
           BEGIN
             INSERT INTO CTB_MIVTZA_VISA
                          (
                           KOD_MIVTZA_VISA               ,
                           TEUR_MIVTZA_VISA ,
						   PAIL                          ,
						    taarich_idkun_acharon,
						    meadken_acharon
                          )
             VALUES
                          (
                           P_KOD_MIVTZA_VISA               ,
                           P_TEUR_MIVTZA_VISA,
						   P_PAIL                          ,
						   p_taarich_idkun_acharon,
						   P_meadken_acharon
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_MIVTZA_VISA;
PROCEDURE S_CTB_MIVTZA_VISA
              (
               P_CUR OUT         CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                           KOD_MIVTZA_VISA               ,
                           PAIL                          ,
                           TAARICH_IDKUN_ACHARON         ,
                           TEUR_MIVTZA_VISA
             FROM        CTB_MIVTZA_VISA
             ORDER BY
                  KOD_MIVTZA_VISA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_MIVTZA_VISA;
PROCEDURE U_CTB_MIVTZA_VISA
              (
               P_KOD_MIVTZA_VISA               NUMBER              ,
               P_TEUR_MIVTZA_VISA              VARCHAR2,
			   P_PAIL                          VARCHAR2            ,
			   p_taarich_idkun_acharon DATE,
			   p_meadken_acharon NUMBER
              )
           IS
           BEGIN
             UPDATE      CTB_MIVTZA_VISA
                SET
                KOD_MIVTZA_VISA           = P_KOD_MIVTZA_VISA          ,
				TEUR_MIVTZA_VISA          = P_TEUR_MIVTZA_VISA ,
                PAIL                      = P_PAIL                     ,
                --TAARICH_IDKUN_ACHARON     = SYSDATE    ,
                taarich_idkun_acharon =p_taarich_idkun_acharon,
				meadken_acharon     =p_meadken_acharon
                WHERE
                 KOD_MIVTZA_VISA           = P_KOD_MIVTZA_VISA
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_MIVTZA_VISA;
PROCEDURE I_CTB_STATUS_BAKASHA
              (
               P_KOD_STATUS_BAKASHA            NUMBER              ,
               P_MEADKEN_ACHARON               NUMBER              ,
               P_TEUR_STATUS_BAKASHA           VARCHAR2            ,
               P_PAIL                          VARCHAR2
              )
           IS
           BEGIN
             INSERT INTO CTB_STATUS_BAKASHA
                          (
                             KOD_STATUS_BAKASHA            ,
                             MEADKEN_ACHARON               ,
                             TEUR_STATUS_BAKASHA           ,
                             PAIL
                          )
             VALUES
                          (
                           P_KOD_STATUS_BAKASHA            ,
                           P_MEADKEN_ACHARON               ,
                           P_TEUR_STATUS_BAKASHA           ,
                           P_PAIL
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_STATUS_BAKASHA;
PROCEDURE S_CTB_STATUS_BAKASHA
              (
               P_KOD_STATUS_BAKASHA            NUMBER              ,
               P_TAARICH_IDKUN_ACHARON         DATE                ,
               P_MEADKEN_ACHARON               NUMBER              ,
               P_TEUR_STATUS_BAKASHA           VARCHAR2            ,
               P_PAIL                          VARCHAR2    ,
               P_CUR OUT          CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                  KOD_STATUS_BAKASHA       ,
                  TAARICH_IDKUN_ACHARON    ,
                  MEADKEN_ACHARON          ,
                  TEUR_STATUS_BAKASHA      ,
                  PAIL
             FROM CTB_STATUS_BAKASHA
                WHERE
                  KOD_STATUS_BAKASHA   = P_KOD_STATUS_BAKASHA
                ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_STATUS_BAKASHA;
PROCEDURE U_CTB_STATUS_BAKASHA
              (
               P_KOD_STATUS_BAKASHA            NUMBER              ,
               P_TAARICH_IDKUN_ACHARON         DATE                ,
               P_MEADKEN_ACHARON               NUMBER              ,
               P_TEUR_STATUS_BAKASHA           VARCHAR2            ,
               P_PAIL                          VARCHAR2
              )
           IS
           BEGIN
             UPDATE         CTB_STATUS_BAKASHA
                SET
                  KOD_STATUS_BAKASHA        = P_KOD_STATUS_BAKASHA     ,
                  TAARICH_IDKUN_ACHARON     = SYSDATE                  ,
                  MEADKEN_ACHARON           = P_MEADKEN_ACHARON        ,
                  TEUR_STATUS_BAKASHA       = P_TEUR_STATUS_BAKASHA    ,
                  PAIL                      = P_PAIL
                WHERE
                  KOD_STATUS_BAKASHA   = P_KOD_STATUS_BAKASHA
                ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_STATUS_BAKASHA;
PROCEDURE I_CTB_SUG_AVODA_BEVISA
              (
               P_KOD_SUG_AVODA_BEVISA          NUMBER              ,
               P_TEUR_SUG_AVODA_BEVISA         VARCHAR2,
			   P_Pail  						               VARCHAR2,
			   p_taarich_idkun_acharon DATE,
			   p_meadken_acharon NUMBER
              )
           IS
           BEGIN
             INSERT INTO CTB_SUG_AVODA_BEVISA
                          (
                             KOD_SUG_AVODA_BEVISA          ,
                             TEUR_SUG_AVODA_BEVISA,
							 Pail  						               ,
			   				 taarich_idkun_acharon ,
			  				 meadken_acharon
                          )
             VALUES
                          (
                           P_KOD_SUG_AVODA_BEVISA          ,
                           --P_MEADKEN_ACHARON               ,
                           P_TEUR_SUG_AVODA_BEVISA,
						   P_Pail  						               ,
			   			   p_taarich_idkun_acharon ,
			   			   p_meadken_acharon
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_SUG_AVODA_BEVISA;
PROCEDURE S_CTB_SUG_AVODA_BEVISA
              (
               --Tammy P_KOD_SUG_AVODA_BEVISA          NUMBER              ,
               --P_MEADKEN_ACHARON               NUMBER              ,
               --P_TAARICH_IDKUN_ACHARON         DATE                ,
               --P_TEUR_SUG_AVODA_BEVISA         VARCHAR2      ,
               P_CUR OUT          CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                  KOD_SUG_AVODA_BEVISA     ,
                  MEADKEN_ACHARON          ,
                  TAARICH_IDKUN_ACHARON    ,
                  TEUR_SUG_AVODA_BEVISA ,
				  Pail
             FROM CTB_SUG_AVODA_BEVISA
			 order by KOD_SUG_AVODA_BEVISA;
                --WHERE
                  --KOD_SUG_AVODA_BEVISA = P_KOD_SUG_AVODA_BEVISA
               -- ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_SUG_AVODA_BEVISA;
PROCEDURE U_CTB_SUG_AVODA_BEVISA
              (
               P_KOD_SUG_AVODA_BEVISA          NUMBER              ,
               P_TEUR_SUG_AVODA_BEVISA         VARCHAR2,
			   P_Pail  						               VARCHAR2,
			   p_taarich_idkun_acharon DATE,
			   p_meadken_acharon NUMBER
              )
           IS
           BEGIN
             UPDATE         CTB_SUG_AVODA_BEVISA
                SET
                  KOD_SUG_AVODA_BEVISA      = P_KOD_SUG_AVODA_BEVISA   ,
                 TEUR_SUG_AVODA_BEVISA     = P_TEUR_SUG_AVODA_BEVISA,
				  Pail  						               =P_Pail  ,
			   	  taarich_idkun_acharon =p_taarich_idkun_acharon,
			   	  meadken_acharon =     p_meadken_acharon
                WHERE
                  KOD_SUG_AVODA_BEVISA = P_KOD_SUG_AVODA_BEVISA
                ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_SUG_AVODA_BEVISA;
PROCEDURE I_CTB_SUG_VISA_HOFSHIT
              (
               P_KOD_VISA                      NUMBER              ,
               --P_MEADKEN_ACHARON               NUMBER              ,
               P_TEUR_VISA                     VARCHAR2,
			   P_Pail  						               VARCHAR2,
			   p_taarich_idkun_acharon DATE,
			   p_meadken_acharon NUMBER
              )
           IS
           BEGIN
             INSERT INTO CTB_SUG_VISA_HOFSHIT
                          (
                             KOD_VISA                      ,
                             MEADKEN_ACHARON               ,
                             TEUR_VISA,
							  Pail ,
							   taarich_idkun_acharon
                          )
             VALUES
                          (
                           P_KOD_VISA                      ,
                           P_MEADKEN_ACHARON               ,
                           P_TEUR_VISA,
						   P_pail,
						   P_taarich_idkun_acharon
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_SUG_VISA_HOFSHIT;
PROCEDURE S_CTB_SUG_VISA_HOFSHIT
              (
               -- Tammy P_KOD_VISA                      NUMBER              ,
               --P_MEADKEN_ACHARON               NUMBER              ,
               --P_TAARICH_IDKUN_ACHARON         DATE                ,
               --P_TEUR_VISA                     VARCHAR2   ,
               P_CUR OUT          CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                  KOD_VISA                 ,
                  MEADKEN_ACHARON          ,
                  TAARICH_IDKUN_ACHARON    ,
                  TEUR_VISA ,
				  Pail
             FROM CTB_SUG_VISA_HOFSHIT
			 Order by KOD_VISA;
                --WHERE
                  --KOD_VISA             = P_KOD_VISA
             --  ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_SUG_VISA_HOFSHIT;
PROCEDURE U_CTB_SUG_VISA_HOFSHIT
              (
               P_KOD_VISA                      NUMBER              ,
               --P_MEADKEN_ACHARON               NUMBER              ,
               --P_TAARICH_IDKUN_ACHARON         DATE                ,
               P_TEUR_VISA                     VARCHAR2,
			   P_Pail  						               VARCHAR2,
			   p_taarich_idkun_acharon DATE,
			   p_meadken_acharon NUMBER
              )
           IS
           BEGIN
             UPDATE         CTB_SUG_VISA_HOFSHIT
                SET
                  KOD_VISA                  = P_KOD_VISA               ,
                  MEADKEN_ACHARON           = P_MEADKEN_ACHARON        ,
                  TAARICH_IDKUN_ACHARON     = P_TAARICH_IDKUN_ACHARON  ,
                  TEUR_VISA                 = P_TEUR_VISA,
				  Pail					  			   = P_Pail
                WHERE
                  KOD_VISA             = P_KOD_VISA
                ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_SUG_VISA_HOFSHIT;
PROCEDURE I_CTB_YOM_VISA
              (
               P_KOD_YOM_VISA                  NUMBER              ,
              -- P_MEADKEN_ACHARON               NUMBER              ,
               P_TEUR_YOM_VISA                 VARCHAR2   ,
			   P_Pail						   			 		    VARCHAR2 ,
               P_TAARICH_IDKUN_ACHARON         DATE,
			   P_MEADKEN_ACHARON               NUMBER
              )
           IS
           BEGIN
             INSERT INTO CTB_YOM_VISA
                          (
                             KOD_YOM_VISA                  ,
                             MEADKEN_ACHARON               ,
                             TEUR_YOM_VISA,
							 Pail						   			 		     ,
                             TAARICH_IDKUN_ACHARON
                          )
             VALUES
                          (
                           P_KOD_YOM_VISA                  ,
                           P_MEADKEN_ACHARON               ,
                           P_TEUR_YOM_VISA   ,
						   P_Pail	,
						    P_TAARICH_IDKUN_ACHARON
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_YOM_VISA;
PROCEDURE S_CTB_YOM_VISA
              (
               --Tammy P_KOD_YOM_VISA                  NUMBER              ,
               --P_MEADKEN_ACHARON               NUMBER              ,
               --P_TAARICH_IDKUN_ACHARON         DATE                ,
               --P_TEUR_YOM_VISA                 VARCHAR2   ,
               P_CUR OUT          CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                  KOD_YOM_VISA             ,
                  MEADKEN_ACHARON          ,
                  TAARICH_IDKUN_ACHARON    ,
                  TEUR_YOM_VISA  ,
				  Pail
             FROM CTB_YOM_VISA
			 Order by KOD_YOM_VISA;
                --WHERE
                  --KOD_YOM_VISA         = P_KOD_YOM_VISA
                --;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_YOM_VISA;
PROCEDURE U_CTB_YOM_VISA
              (
               P_KOD_YOM_VISA                  NUMBER              ,
               P_TEUR_YOM_VISA                 VARCHAR2 ,
			   P_Pail						   			 		    VARCHAR2 ,
               P_TAARICH_IDKUN_ACHARON         DATE,
			   P_MEADKEN_ACHARON               NUMBER
              )
           IS
           BEGIN
             UPDATE         CTB_YOM_VISA
                SET
                  KOD_YOM_VISA              = P_KOD_YOM_VISA           ,
                  MEADKEN_ACHARON           = P_MEADKEN_ACHARON        ,
                  TAARICH_IDKUN_ACHARON     = P_TAARICH_IDKUN_ACHARON  ,
                  TEUR_YOM_VISA             = P_TEUR_YOM_VISA,
				  Pail	= P_Pail
                WHERE
                  KOD_YOM_VISA         = P_KOD_YOM_VISA
                ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_YOM_VISA;
PROCEDURE I_CTB_RAMOT_ISHURIM
              (
               P_KOD_ISHUR                     NUMBER              ,
               P_RAMA                          NUMBER              ,
               P_KOD_TAFKID_MEASHER            NUMBER              ,
               P_PAIL                          CHAR                ,
               P_MEADKEN_ACHARON               NUMBER
              )
           IS
           BEGIN
             INSERT INTO CTB_RAMOT_ISHURIM
                          (
                             KOD_ISHUR                     ,
                             RAMA                          ,
                             KOD_TAFKID_MEASHER            ,
                             PAIL                          ,
                             MEADKEN_ACHARON
                          )
             VALUES
                          (
                           P_KOD_ISHUR                     ,
                           P_RAMA                          ,
                           P_KOD_TAFKID_MEASHER            ,
                           P_PAIL                          ,
                           P_MEADKEN_ACHARON
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_RAMOT_ISHURIM;
PROCEDURE S_CTB_RAMOT_ISHURIM
              (
               P_KOD_ISHUR                     NUMBER              ,
               P_RAMA                          NUMBER              ,
               P_KOD_TAFKID_MEASHER            NUMBER              ,
               P_PAIL                          CHAR                ,
               P_TAARICH_IDKUN_ACHARON         DATE                ,
               P_MEADKEN_ACHARON               NUMBER      ,
               P_CUR OUT          CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                  KOD_ISHUR                ,
                  RAMA                     ,
                  KOD_TAFKID_MEASHER       ,
                  PAIL                     ,
                  TAARICH_IDKUN_ACHARON    ,
                  MEADKEN_ACHARON
             FROM CTB_RAMOT_ISHURIM
                WHERE
                  KOD_ISHUR            = P_KOD_ISHUR
                ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_RAMOT_ISHURIM;
PROCEDURE U_CTB_RAMOT_ISHURIM
              (
               P_KOD_ISHUR                     NUMBER              ,
               P_RAMA                          NUMBER              ,
               P_KOD_TAFKID_MEASHER            NUMBER              ,
               P_PAIL                          CHAR                ,
               P_TAARICH_IDKUN_ACHARON         DATE                ,
               P_MEADKEN_ACHARON               NUMBER
              )
           IS
           BEGIN
             UPDATE         CTB_RAMOT_ISHURIM
                SET
                  KOD_ISHUR                 = P_KOD_ISHUR              ,
                  RAMA                      = P_RAMA                   ,
                  KOD_TAFKID_MEASHER        = P_KOD_TAFKID_MEASHER     ,
                  PAIL                      = P_PAIL                   ,
                  TAARICH_IDKUN_ACHARON     = SYSDATE                  ,
                  MEADKEN_ACHARON           = P_MEADKEN_ACHARON
                WHERE
                  KOD_ISHUR            = P_KOD_ISHUR
                ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_RAMOT_ISHURIM;
PROCEDURE S_TB_BAKASHOT_PARAMS
              (
               P_BAKASHA_ID                    NUMBER              ,
               P_PARAM_ID                      NUMBER              ,
               P_ERECH                         VARCHAR2       ,
               P_CUR OUT          CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                  BAKASHA_ID               ,
                  PARAM_ID                 ,
                  ERECH
             FROM TB_BAKASHOT_PARAMS
                WHERE
                  BAKASHA_ID           = P_BAKASHA_ID          AND
                  PARAM_ID             = P_PARAM_ID
                ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_TB_BAKASHOT_PARAMS;
PROCEDURE I_TB_HARSHAOT_MASACHIM
              (
               P_MASACH_ID                     NUMBER              ,
               P_PAKAD_ID                      NUMBER              ,
               P_KOD_PROFIL                    NUMBER              ,
               P_KOD_HARSHAA                   NUMBER
              )
           IS
           BEGIN
             INSERT INTO TB_HARSHAOT_MASACHIM
                          (
                             MASACH_ID                     ,
                             PAKAD_ID                      ,
                             KOD_PROFIL                    ,
                             KOD_HARSHAA
                          )
             VALUES
                          (
                           P_MASACH_ID                     ,
                           P_PAKAD_ID                      ,
                           P_KOD_PROFIL                    ,
                           P_KOD_HARSHAA
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_TB_HARSHAOT_MASACHIM;
PROCEDURE S_TB_HARSHAOT_MASACHIM
              (
               P_MASACH_ID                     NUMBER              ,
               P_PAKAD_ID                      NUMBER              ,
               P_KOD_PROFIL                    NUMBER              ,
               P_KOD_HARSHAA                   NUMBER  ,
               P_CUR OUT          CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                  MASACH_ID                ,
                  PAKAD_ID                 ,
                  KOD_PROFIL               ,
                  KOD_HARSHAA
             FROM TB_HARSHAOT_MASACHIM
                WHERE
                  MASACH_ID            = P_MASACH_ID           AND
                  PAKAD_ID             = P_PAKAD_ID            AND
                  KOD_PROFIL           = P_KOD_PROFIL
                ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_TB_HARSHAOT_MASACHIM;
PROCEDURE U_TB_HARSHAOT_MASACHIM
              (
               P_MASACH_ID                     NUMBER              ,
               P_PAKAD_ID                      NUMBER              ,
               P_KOD_PROFIL                    NUMBER              ,
               P_KOD_HARSHAA                   NUMBER
              )
           IS
           BEGIN
             UPDATE         TB_HARSHAOT_MASACHIM
                SET
                  MASACH_ID                 = P_MASACH_ID              ,
                  PAKAD_ID                  = P_PAKAD_ID               ,
                  KOD_PROFIL                = P_KOD_PROFIL             ,
                  KOD_HARSHAA               = P_KOD_HARSHAA
                WHERE
                  MASACH_ID            = P_MASACH_ID           AND
                  PAKAD_ID             = P_PAKAD_ID            AND
                  KOD_PROFIL           = P_KOD_PROFIL
                ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_TB_HARSHAOT_MASACHIM;
PROCEDURE I_TB_HODAOT
              (
      		   P_KOD_HODAA                     NUMBER              ,
			   P_MELEL_HODAA                   VARCHAR2 ,
               P_MASACH_ID                     NUMBER              ,
               P_ME_TAARICH                    DATE                ,
               P_AD_TAARICH                    DATE               ,
			   P_TAARICH_IDKUN_ACHARON         DATE,
			   P_MEADKEN_ACHARON               NUMBER
              )
           IS
           BEGIN
             INSERT INTO TB_HODAOT
                          (
                             KOD_HODAA                     ,
                             MASACH_ID                     ,
                             ME_TAARICH                    ,
                             AD_TAARICH                    ,
                             MELEL_HODAA ,
							 TAARICH_IDKUN_ACHARON         ,
			   				 MEADKEN_ACHARON
                          )
             VALUES
                          (
                           P_KOD_HODAA                     ,
                           P_MASACH_ID                     ,
                           P_ME_TAARICH                    ,
                           P_AD_TAARICH                    ,
                           P_MELEL_HODAA,
						   P_TAARICH_IDKUN_ACHARON         ,
			   			   P_MEADKEN_ACHARON
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_TB_HODAOT;
/*Tammy PROCEDURE S_TB_HODAOT
              (
               P_KOD_HODAA                     NUMBER              ,
               P_MASACH_ID                     NUMBER              ,
               P_ME_TAARICH                    DATE                ,
               P_AD_TAARICH                    DATE                ,
               P_MELEL_HODAA                   VARCHAR2            ,
               P_CUR OUT          CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                  KOD_HODAA                ,
                  MASACH_ID                ,
                  ME_TAARICH               ,
                  AD_TAARICH               ,
                  MELEL_HODAA
             FROM TB_HODAOT
                WHERE
                  KOD_HODAA            = P_KOD_HODAA
                ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_TB_HODAOT;*/
PROCEDURE U_TB_HODAOT
              (
               P_KOD_HODAA                     NUMBER              ,
			   P_MELEL_HODAA                   VARCHAR2 ,
               P_MASACH_ID                     NUMBER              ,
               P_ME_TAARICH                    DATE                ,
               P_AD_TAARICH                    DATE              ,
			   P_TAARICH_IDKUN_ACHARON         DATE,
			   P_MEADKEN_ACHARON               NUMBER
              )
           IS
           BEGIN
             UPDATE         TB_HODAOT
                SET
                  KOD_HODAA                 = P_KOD_HODAA              ,
                  MASACH_ID                 = P_MASACH_ID              ,
                  ME_TAARICH                = P_ME_TAARICH             ,
                  AD_TAARICH                = P_AD_TAARICH             ,
                  MELEL_HODAA               = P_MELEL_HODAA,
				  TAARICH_IDKUN_ACHARON = P_TAARICH_IDKUN_ACHARON         ,
			      MEADKEN_ACHARON = P_MEADKEN_ACHARON
                WHERE
                  KOD_HODAA            = P_KOD_HODAA
                ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_TB_HODAOT;
PROCEDURE I_TB_HODAOT_LEPROFIL
              (
               P_KOD_PROFIL                    NUMBER,
               P_KOD_HODAA                     NUMBER              ,
                p_MASACH_ID  Number,
			   P_TAARICH_IDKUN_ACHARON         DATE,
			   P_MEADKEN_ACHARON               NUMBER
              )
           IS
           BEGIN
             INSERT INTO TB_HODAOT_LEPROFIL
                          (
                             KOD_HODAA                     ,
                             KOD_PROFIL,
							 TAARICH_IDKUN_ACHARON,
							  MEADKEN_ACHARON
                          )
             VALUES
                          (
                           P_KOD_HODAA                     ,
                           P_KOD_PROFIL ,
						   P_TAARICH_IDKUN_ACHARON         ,
			   			   P_MEADKEN_ACHARON
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_TB_HODAOT_LEPROFIL;
PROCEDURE S_TB_HODAOT_LEPROFIL
              (
               --Tammy P_KOD_HODAA                     NUMBER              ,
               --P_KOD_PROFIL                    NUMBER      ,
               P_CUR OUT          CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                  tl.KOD_HODAA  ,tl.KOD_PROFIL, th.MELEL_HODAA,cp.TEUR_PROFIL ,tm.TEUR ,tl.TAARICH_IDKUN_ACHARON,
                  th.MASACH_ID
             FROM TB_HODAOT_LEPROFIL tl,TB_HODAOT th,CTB_PROFIL cp,TB_MASACH tm
                WHERE
                  tl.KOD_HODAA            = th.KOD_HODAA
                  AND tl.KOD_PROFIL           = cp.KOD_PROFIL
				  and th.MASACH_ID=tm.MASACH_ID
				  order by  tm.TEUR
                ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_TB_HODAOT_LEPROFIL;
PROCEDURE U_TB_HODAOT_LEPROFIL
              (
              P_KOD_PROFIL                    NUMBER,
               P_KOD_HODAA                     NUMBER              ,
                p_MASACH_ID  Number,
			   P_TAARICH_IDKUN_ACHARON         DATE,
			   P_MEADKEN_ACHARON               NUMBER
              )
           IS
           BEGIN
             UPDATE         TB_HODAOT_LEPROFIL
                SET
                  KOD_HODAA                 = P_KOD_HODAA              ,
                  KOD_PROFIL                = P_KOD_PROFIL,
				  TAARICH_IDKUN_ACHARON = P_TAARICH_IDKUN_ACHARON,
				  MEADKEN_ACHARON = P_MEADKEN_ACHARON
                WHERE
                  KOD_HODAA            = P_KOD_HODAA           AND
                  KOD_PROFIL           = P_KOD_PROFIL
                ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_TB_HODAOT_LEPROFIL;
PROCEDURE S_TB_LOG_BAKASHOT
              (
               P_MISPAR_SIDURI                 NUMBER              ,
               P_BAKASHA_ID                    NUMBER              ,
               P_TAARICH_IDKUN_ACHARON         DATE                ,
               P_SUG_HODAA                     VARCHAR2            ,
               P_KOD_TAHALICH                  VARCHAR2            ,
               P_KOD_YESHUT                    NUMBER              ,
               P_MISPAR_ISHI                   NUMBER              ,
               P_TAARICH                       DATE                ,
               P_MISPAR_SIDUR                  NUMBER              ,
               P_SHAT_HATCHALA_SIDUR           DATE                ,
               P_SHAT_YETZIA                   DATE                ,
               P_MISPAR_KNISA                  NUMBER              ,
               P_KOD_HODAA                     NUMBER              ,
               P_TEUR_HODAA                    VARCHAR2      ,
               P_CUR OUT          CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                  MISPAR_SIDURI            ,
                  BAKASHA_ID               ,
                  TAARICH_IDKUN_ACHARON    ,
                  SUG_HODAA                ,
                  KOD_TAHALICH             ,
                  KOD_YESHUT               ,
                  MISPAR_ISHI              ,
                  TAARICH                  ,
                  MISPAR_SIDUR             ,
                  SHAT_HATCHALA_SIDUR      ,
                  SHAT_YETZIA              ,
                  MISPAR_KNISA             ,
                  KOD_HODAA                ,
                  TEUR_HODAA
             FROM TB_LOG_BAKASHOT
                WHERE
                  BAKASHA_ID           = P_BAKASHA_ID          AND
                  TAARICH_IDKUN_ACHAROn = P_TAARICH_IDKUN_ACHAROn
                ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_TB_LOG_BAKASHOT;
PROCEDURE I_TB_MASACH
              (
               P_MASACH_ID                     NUMBER              ,
               P_PAKAD_ID                      NUMBER              ,
               P_SHEM                          CHAR                ,
               P_SUG                           NUMBER              ,
               P_TEUR                          VARCHAR2
              )
           IS
           BEGIN
             INSERT INTO TB_MASACH
                          (
                             MASACH_ID                     ,
                             PAKAD_ID                      ,
                             SHEM                          ,
                             SUG                           ,
                             TEUR
                          )
             VALUES
                          (
                           P_MASACH_ID                     ,
                           P_PAKAD_ID                      ,
                           P_SHEM                          ,
                           P_SUG                           ,
                           P_TEUR
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_TB_MASACH;
PROCEDURE S_TB_MASACH
              (
               P_MASACH_ID                     NUMBER              ,
               P_PAKAD_ID                      NUMBER              ,
               P_SHEM                          CHAR                ,
               P_SUG                           NUMBER              ,
               P_TEUR                          VARCHAR2           ,
               P_CUR OUT          CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                  MASACH_ID                ,
                  PAKAD_ID                 ,
                  SHEM                     ,
                  SUG                      ,
                  TEUR
             FROM TB_MASACH
                WHERE
                  MASACH_ID            = P_MASACH_ID           AND
                  PAKAD_ID             = P_PAKAD_ID
                ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_TB_MASACH;
PROCEDURE U_TB_MASACH
              (
               P_MASACH_ID                     NUMBER              ,
               P_PAKAD_ID                      NUMBER              ,
               P_SHEM                          CHAR                ,
               P_SUG                           NUMBER              ,
               P_TEUR                          VARCHAR2
              )
           IS
           BEGIN
             UPDATE         TB_MASACH
                SET
                  MASACH_ID                 = P_MASACH_ID              ,
                  PAKAD_ID                  = P_PAKAD_ID               ,
                  SHEM                      = P_SHEM                   ,
                  SUG                       = P_SUG                    ,
                  TEUR                      = P_TEUR
                WHERE
                  MASACH_ID            = P_MASACH_ID           AND
                  PAKAD_ID             = P_PAKAD_ID
                ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_TB_MASACH;
PROCEDURE I_TB_MEAFYENEY_SUG_SIDUR
              (
               P_SUG_SIDUR                     NUMBER              ,
               P_ME_TAARICH                    DATE                ,
               P_AD_TAARICH                    DATE                ,
               P_KOD_MEAFYEN                   NUMBER              ,
               P_ERECH                         VARCHAR2            ,
               P_MEADKEN_ACHARON               NUMBER              ,
               P_HEARA                         VARCHAR2
              )
           IS
           BEGIN
             INSERT INTO TB_MEAFYENEY_SUG_SIDUR
                          (
                             SUG_SIDUR                     ,
                             ME_TAARICH                    ,
                             AD_TAARICH                    ,
                             KOD_MEAFYEN                   ,
                             ERECH                         ,
                             MEADKEN_ACHARON               ,
                             HEARA
                          )
             VALUES
                          (
                           P_SUG_SIDUR                     ,
                           P_ME_TAARICH                    ,
                           P_AD_TAARICH                    ,
                           P_KOD_MEAFYEN                   ,
                           P_ERECH                         ,
                           P_MEADKEN_ACHARON               ,
                           P_HEARA
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_TB_MEAFYENEY_SUG_SIDUR;
PROCEDURE S_TB_MEAFYENEY_SUG_SIDUR
              (
               P_SUG_SIDUR                     NUMBER              ,
               P_ME_TAARICH                    DATE                ,
               P_AD_TAARICH                    DATE                ,
               P_KOD_MEAFYEN                   NUMBER              ,
               P_ERECH                         VARCHAR2            ,
               P_TAARICH_IDKUN_ACHARON         DATE                ,
               P_MEADKEN_ACHARON               NUMBER              ,
               P_HEARA                         VARCHAR2     ,
               P_CUR OUT          CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                  SUG_SIDUR                ,
                  ME_TAARICH               ,
                  AD_TAARICH               ,
                  KOD_MEAFYEN              ,
                  ERECH                    ,
                  TAARICH_IDKUN_ACHARON    ,
                  MEADKEN_ACHARON          ,
                  HEARA
             FROM TB_MEAFYENEY_SUG_SIDUR
                WHERE
                  SUG_SIDUR            = P_SUG_SIDUR           AND
                  ME_TAARICH           = P_ME_TAARICH          AND
                  KOD_MEAFYEN          = P_KOD_MEAFYEN
                ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_TB_MEAFYENEY_SUG_SIDUR;
PROCEDURE U_TB_MEAFYENEY_SUG_SIDUR
              (
               P_SUG_SIDUR                     NUMBER              ,
               P_ME_TAARICH                    DATE                ,
               P_AD_TAARICH                    DATE                ,
               P_KOD_MEAFYEN                   NUMBER              ,
               P_ERECH                         VARCHAR2            ,
               P_TAARICH_IDKUN_ACHARON         DATE                ,
               P_MEADKEN_ACHARON               NUMBER              ,
               P_HEARA                         VARCHAR2
              )
           IS
           BEGIN
             UPDATE         TB_MEAFYENEY_SUG_SIDUR
                SET
                  SUG_SIDUR                 = P_SUG_SIDUR              ,
                  ME_TAARICH                = P_ME_TAARICH             ,
                  AD_TAARICH                = P_AD_TAARICH             ,
                  KOD_MEAFYEN               = P_KOD_MEAFYEN            ,
                  ERECH                     = P_ERECH                  ,
                  TAARICH_IDKUN_ACHARON     = SYSDATE                  ,
                  MEADKEN_ACHARON           = P_MEADKEN_ACHARON        ,
                  HEARA                     = P_HEARA
                WHERE
                  SUG_SIDUR            = P_SUG_SIDUR           AND
                  ME_TAARICH           = P_ME_TAARICH          AND
                  KOD_MEAFYEN          = P_KOD_MEAFYEN
                ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_TB_MEAFYENEY_SUG_SIDUR;
PROCEDURE I_TB_SIDURIM_MEYUCHADIM_RECHIV
              (
               P_MISPAR_SIDUR                  NUMBER              ,
               P_ME_TAARICH                    DATE                ,
               P_AD_TAARICH                    DATE                ,
               P_KOD_RECHIV                    NUMBER              ,
               P_MEADKEN_ACHARON               NUMBER
              )
           IS
           BEGIN
             INSERT INTO TB_SIDURIM_MEYUCHADIM_RECHIV
                          (
                             MISPAR_SIDUR                  ,
                             ME_TAARICH                    ,
                             AD_TAARICH                    ,
                             KOD_RECHIV                    ,
                             MEADKEN_ACHARON
                          )
             VALUES
                          (
                           P_MISPAR_SIDUR                  ,
                           P_ME_TAARICH                    ,
                           P_AD_TAARICH                    ,
                           P_KOD_RECHIV                    ,
                           P_MEADKEN_ACHARON
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_TB_SIDURIM_MEYUCHADIM_RECHIV;
PROCEDURE S_TB_SIDURIM_MEYUCHADIM_RECHIV
              (
               P_MISPAR_SIDUR                  NUMBER              ,
               P_ME_TAARICH                    DATE                ,
               P_AD_TAARICH                    DATE                ,
               P_KOD_RECHIV                    NUMBER              ,
               P_TAARICH_IDKUN_ACHARON         DATE                ,
               P_MEADKEN_ACHARON               NUMBER        ,
               P_CUR OUT          CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                  MISPAR_SIDUR             ,
                  ME_TAARICH               ,
                  AD_TAARICH               ,
                  KOD_RECHIV               ,
                  TAARICH_IDKUN_ACHARON    ,
                  MEADKEN_ACHARON
             FROM TB_SIDURIM_MEYUCHADIM_RECHIV
                WHERE
                  MISPAR_SIDUR         = P_MISPAR_SIDUR        AND
                  ME_TAARICH           = P_ME_TAARICH          AND
                  KOD_RECHIV           = P_KOD_RECHIV
                ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_TB_SIDURIM_MEYUCHADIM_RECHIV;
PROCEDURE U_TB_SIDURIM_MEYUCHADIM_RECHIV
              (
               P_MISPAR_SIDUR                  NUMBER              ,
               P_ME_TAARICH                    DATE                ,
               P_AD_TAARICH                    DATE                ,
               P_KOD_RECHIV                    NUMBER              ,
               P_TAARICH_IDKUN_ACHARON         DATE                ,
               P_MEADKEN_ACHARON               NUMBER
              )
           IS
           BEGIN
             UPDATE         TB_SIDURIM_MEYUCHADIM_RECHIV
                SET
                  MISPAR_SIDUR              = P_MISPAR_SIDUR           ,
                  ME_TAARICH                = P_ME_TAARICH             ,
                  AD_TAARICH                = P_AD_TAARICH             ,
                  KOD_RECHIV                = P_KOD_RECHIV             ,
                  TAARICH_IDKUN_ACHARON     = SYSDATE                  ,
                  MEADKEN_ACHARON           = P_MEADKEN_ACHARON
                WHERE
                  MISPAR_SIDUR         = P_MISPAR_SIDUR        AND
                  ME_TAARICH           = P_ME_TAARICH          AND
                  KOD_RECHIV           = P_KOD_RECHIV
                ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_TB_SIDURIM_MEYUCHADIM_RECHIV;
PROCEDURE I_TB_SUG_SIDUR_RECHIV
              (
               P_SUG_SIDUR                     NUMBER              ,
               P_ME_TAARICH                    DATE                ,
               P_AD_TAARICH                    DATE                ,
               P_KOD_RECHIV                    NUMBER              ,
               P_MEADKEN_ACHARON               NUMBER
              )
           IS
           BEGIN
             INSERT INTO TB_SUG_SIDUR_RECHIV
                          (
                             SUG_SIDUR                     ,
                             ME_TAARICH                    ,
                             AD_TAARICH                    ,
                             KOD_RECHIV                    ,
                             MEADKEN_ACHARON
                          )
             VALUES
                          (
                           P_SUG_SIDUR                     ,
                           P_ME_TAARICH                    ,
                           P_AD_TAARICH                    ,
                           P_KOD_RECHIV                    ,
                           P_MEADKEN_ACHARON
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_TB_SUG_SIDUR_RECHIV;
PROCEDURE S_TB_SUG_SIDUR_RECHIV
              (
               P_SUG_SIDUR                     NUMBER              ,
               P_ME_TAARICH                    DATE                ,
               P_AD_TAARICH                    DATE                ,
               P_KOD_RECHIV                    NUMBER              ,
               P_TAARICH_IDKUN_ACHARON         DATE                ,
               P_MEADKEN_ACHARON               NUMBER   ,
               P_CUR OUT          CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                  SUG_SIDUR                ,
                  ME_TAARICH               ,
                  AD_TAARICH               ,
                  KOD_RECHIV               ,
                  TAARICH_IDKUN_ACHARON    ,
                  MEADKEN_ACHARON
             FROM TB_SUG_SIDUR_RECHIV
                WHERE
                  SUG_SIDUR            = P_SUG_SIDUR           AND
                  ME_TAARICH           = P_ME_TAARICH          AND
                  KOD_RECHIV           = P_KOD_RECHIV
                ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_TB_SUG_SIDUR_RECHIV;
PROCEDURE U_TB_SUG_SIDUR_RECHIV
              (
               P_SUG_SIDUR                     NUMBER              ,
               P_ME_TAARICH                    DATE                ,
               P_AD_TAARICH                    DATE                ,
               P_KOD_RECHIV                    NUMBER              ,
               P_TAARICH_IDKUN_ACHARON         DATE                ,
               P_MEADKEN_ACHARON               NUMBER
              )
           IS
           BEGIN
             UPDATE         TB_SUG_SIDUR_RECHIV
                SET
                  SUG_SIDUR                 = P_SUG_SIDUR              ,
                  ME_TAARICH                = P_ME_TAARICH             ,
                  AD_TAARICH                = P_AD_TAARICH             ,
                  KOD_RECHIV                = P_KOD_RECHIV             ,
                  TAARICH_IDKUN_ACHARON     = SYSDATE                  ,
                  MEADKEN_ACHARON           = P_MEADKEN_ACHARON
                WHERE
                  SUG_SIDUR            = P_SUG_SIDUR           AND
                  ME_TAARICH           = P_ME_TAARICH          AND
                  KOD_RECHIV           = P_KOD_RECHIV
                ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_TB_SUG_SIDUR_RECHIV;

PROCEDURE S_TB_HODAOT(p_Cur OUT CurType)
  IS
	 BEGIN
     OPEN p_Cur FOR
      select th.AD_TAARICH,th.KOD_HODAA,th.MELEL_HODAA,th.ME_TAARICH,tm.TEUR,tm.MASACH_ID,th.TAARICH_IDKUN_ACHARON
      from TB_HODAOT th,TB_MASACH tm
      where th.MASACH_ID=tm.MASACH_ID and tm.SUG=1
      order by th.ME_TAARICH desc;

	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
  END S_TB_HODAOT;

--Tammy added 02032010
PROCEDURE I_CTB_SUGEY_DOCHOT

              (
               P_KOD_SUG_DOCH                     NUMBER              ,
               P_TEUR_DOCH                    VARCHAR2     ,
			   P_SHEM_DOCH_BAKOD          VARCHAR2 ,
			   P_PAIL					  		   		   			  VARCHAR2 ,
			   P_TAARICH_IDKUN_ACHARON  Date ,
			   P_MEADKEN_ACHARON		          Number
              )
           IS
           BEGIN
             INSERT INTO CTB_SUGEY_DOCHOT
                          (
                            KOD_SUG_DOCH                     ,
                            TEUR_DOCH   					 ,
							 SHEM_DOCH_BAKOD,
							 PAIL,
							 TAARICH_IDKUN_ACHARON,
							 MEADKEN_ACHARON
                          )
             VALUES
                          (
                           P_KOD_SUG_DOCH                                   ,
               			   P_TEUR_DOCH                         ,
			   			   P_SHEM_DOCH_BAKOD           ,
			   			   P_PAIL					  		   		   			   ,
			   			   P_TAARICH_IDKUN_ACHARON   ,
			   			   P_MEADKEN_ACHARON
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_CTB_SUGEY_DOCHOT;
PROCEDURE S_CTB_SUGEY_DOCHOT
              (
               P_CUR OUT          CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
             SELECT
                            KOD_SUG_DOCH                     ,
                            TEUR_DOCH   					 ,
							 SHEM_DOCH_BAKOD,
							 PAIL,
							 TAARICH_IDKUN_ACHARON
             FROM CTB_SUGEY_DOCHOT
		     order by  KOD_SUG_DOCH
                ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_CTB_SUGEY_DOCHOT;
PROCEDURE U_CTB_SUGEY_DOCHOT
              (
               P_KOD_SUG_DOCH                     NUMBER              ,
               P_TEUR_DOCH                    VARCHAR2     ,
			   P_SHEM_DOCH_BAKOD          VARCHAR2 ,
			   P_PAIL					  		   		   			  VARCHAR2 ,
			   P_TAARICH_IDKUN_ACHARON  Date ,
			   P_MEADKEN_ACHARON		          Number
              )
           IS
           BEGIN
             UPDATE         CTB_SUGEY_DOCHOT
                SET
                              TEUR_DOCH   			   		 =	P_TEUR_DOCH ,
							 SHEM_DOCH_BAKOD	=   P_SHEM_DOCH_BAKOD,
							 PAIL									      =   P_PAIL,
							 MEADKEN_ACHARON	= 	P_MEADKEN_ACHARON,
							 TAARICH_IDKUN_ACHARON = P_TAARICH_IDKUN_ACHARON
                WHERE
					   		 KOD_SUG_DOCH               =  P_KOD_SUG_DOCH
                ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_CTB_SUGEY_DOCHOT;

--Tammy added 08042010
PROCEDURE I_TB_BUGIM
              (
               P_MISPAR                     NUMBER              ,
			   P_MISPAR_ISHI                    NUMBER     ,
			   P_MISPAR_SIDUR          NUMBER ,
			   P_TAARICH					  		   		   			  Date ,
			   P_SHAT_YETZIA											   varchar2 ,
			   P_SHAT_HATCHALA_SIDUR    varchar2 ,
			   P_MAKAT_NESIA NUMBER ,
			   P_MASACH     varchar2,
			   P_TEUR            varchar2,
			   --P_MISHTAMESH_ID NUMBER ,
			   --P_STATUS      varchar2,
			   --P_TAARICH_PTICHA   Date ,
			   P_TAARICH_IDKUN_ACHARON  Date ,
			   P_MEADKEN_ACHARON		          Number
              )
           IS
           BEGIN
             INSERT INTO TB_BUGIM
                          (
                            MISPAR                                   ,
               				MISPAR_ISHI                         ,
			   				MISPAR_SIDUR           ,
			   				TAARICH					  		   		   			   ,
			   				SHAT_YETZIA											   ,
			   				SHAT_HATCHALA_SIDUR    ,
			   				MAKAT_NESIA  ,
			   				MISHTAMESH_ID  ,
			   				TAARICH_PTICHA    ,
			   				STATUS      ,
			   				MASACH     ,
			   				TEUR            ,
			   				TAARICH_IDKUN_ACHARON   ,
			   				MEADKEN_ACHARON
                          )
             VALUES
                          (
                           --P_MISPAR                                   ,
						   mispar_bugim.nextval ,
               			   P_MISPAR_ISHI                         ,
			   			   P_MISPAR_SIDUR           ,
			   			   P_TAARICH					  		   		   			   ,
			   			   P_SHAT_YETZIA											   ,
			   			   P_SHAT_HATCHALA_SIDUR    ,
			   			   P_MAKAT_NESIA  ,
			   			   P_MEADKEN_ACHARON  , -- Tammy insert m.i. of medken acharon
			   			   sysdate    ,
			   			   1      ,
			   			   P_MASACH     ,
			   			   P_TEUR            ,
			   			   P_TAARICH_IDKUN_ACHARON   ,
			   			   P_MEADKEN_ACHARON
                          )
                           ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END I_TB_BUGIM;
PROCEDURE S_TB_BUGIM
              (
               P_CUR OUT          CURTYPE
              )
           IS
           BEGIN
            OPEN P_CUR FOR
            SELECT
                            b.MISPAR                                   ,
                               b.MISPAR_ISHI                         ,
                               b.MISPAR_SIDUR           ,
                               b.TAARICH                                                           ,
                               b.SHAT_YETZIA                                               ,
                               b.SHAT_HATCHALA_SIDUR    ,
                               b.MAKAT_NESIA  ,
                               b.MISHTAMESH_ID  ,
                               b.TAARICH_PTICHA    ,
                               b.STATUS      ,
                               m.TEUR   teur_masach  ,
                               b.MASACH,
                               b.TEUR            ,
                               b.TAARICH_IDKUN_ACHARON   ,
                               b.MEADKEN_ACHARON
             FROM TB_BUGIM b,TB_MASACH m
             where B.MASACH=M.MASACH_ID
             and M.MASACH_ID=M.PAKAD_ID
		     order by  MISPAR
                ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END S_TB_BUGIM;
PROCEDURE U_TB_BUGIM
              (
                P_MISPAR                     NUMBER              ,
			   P_MISPAR_ISHI                    NUMBER     ,
			   P_MISPAR_SIDUR          NUMBER ,
			   P_TAARICH					  		   		   			  Date ,
			   P_SHAT_YETZIA											   varchar2 ,
			   P_SHAT_HATCHALA_SIDUR    varchar2 ,
			   P_MAKAT_NESIA NUMBER ,
			   P_MASACH     varchar2,
			   P_TEUR            varchar2,
			   --P_MISHTAMESH_ID NUMBER ,
			   --P_STATUS      varchar2,
			   --P_TAARICH_PTICHA   Date ,
			   P_TAARICH_IDKUN_ACHARON  Date ,
			   P_MEADKEN_ACHARON		          Number               )
           IS
           BEGIN
             UPDATE        TB_BUGIM
                SET
                              MISPAR= P_MISPAR                                   ,
               				  MISPAR_ISHI = P_MISPAR_ISHI                         ,
			   				  MISPAR_SIDUR = P_MISPAR_SIDUR           ,
			   				 TAARICH = P_TAARICH					  		   		   			   ,
			   				  SHAT_YETZIA	 = P_SHAT_YETZIA											   ,
			   				  SHAT_HATCHALA_SIDUR = P_SHAT_HATCHALA_SIDUR    ,
			   				  MAKAT_NESIA =  P_MAKAT_NESIA  ,
			   				  --MISHTAMESH_ID = P_MISHTAMESH_ID  ,
			   				  TAARICH_PTICHA = sysdate    ,
			   				  --STATUS = P_STATUS      ,
			   				  MASACH = P_MASACH     ,
			   				  TEUR= P_TEUR            ,
			   				  TAARICH_IDKUN_ACHARON = P_TAARICH_IDKUN_ACHARON   ,
			   				  MEADKEN_ACHARON = P_MEADKEN_ACHARON
                WHERE
					   		 MISPAR               =  P_MISPAR
                ;
             EXCEPTION
                   WHEN OTHERS THEN
                        RAISE;

END U_TB_BUGIM;

END PKG_SYSMAN; 
/
CREATE OR REPLACE PACKAGE          PKG_TNUA AS
/******************************************************************************
   NAME:       PKG_TNUA
   PURPOSE:

   REVISIONS:
   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        26/04/2009             1. Created this package.
******************************************************************************/

/*
Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        27/04/2009      vered       1. ????? ????? ????? ?????
*/
TYPE    CurType      IS       REF CURSOR;

TYPE my_type IS RECORD (
  activity_date     DATE,
  makat8            NUMBER(8),
  description       VARCHAR2(50 CHAR),
  shilut            CHAR(4 CHAR),
  kisui_tor         NUMBER(2),
  mazan_tichnun     NUMBER(4),  
  mazan_tashlum     NUMBER(4),
  km                NUMBER(4,1),
  eshel             NUMBER(1),
  nihul_name        VARCHAR2(50 CHAR),
  sug_shirut_name   VARCHAR2(50 CHAR),
  migun             NUMBER(1),
  xy_moked_tchila   NUMBER(8),
  xy_moked_siyum   number(8),
  eilat_trip        NUMBER(1),
  status            NUMBER(2),
  snif              number(2),
  snif_name         varchar2(50 char),
  sug_auto          number(1),
  Onatiut           number(2)
  );

  TYPE my_cursor IS REF CURSOR RETURN my_type;

/*CURSOR p_cur IS
SELECT license_number
     FROM VCL_GENERAL_VEHICLE_VIEW@kds2maale;*/

FUNCTION fn_get_makat_type(p_makat in tb_peilut_ovdim.makat_nesia%type) return integer;
PROCEDURE pro_get_mashar_data(p_cars_number in varchar2, p_cur out CurType);

PROCEDURE pro_get_mashar_bus_license_num(p_oto_no in tb_peilut_ovdim.oto_no%type, p_license_no out number);
PROCEDURE pro_get_kavim_details_test(p_mispar_ishi in number, p_date_from date, p_date_to date, p_cur out my_cursor);
PROCEDURE pro_get_kavim_details(p_mispar_ishi in tb_sidurim_ovdim.mispar_ishi%type, p_date_from date, p_date_to date, p_cur out my_cursor);
END PKG_TNUA; 
/

CREATE OR REPLACE PACKAGE BODY          PKG_TNUA AS
v_cur number;
/******************************************************************************
   NAME:       PKG_TNUA
   PURPOSE:

   REVISIONS:
   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        26/04/2009             1. Created this package.
******************************************************************************/

/*
Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        27/04/2009      vered       1. ????? ????? ????? ?????
*/

FUNCTION fn_get_makat_type(p_makat in tb_peilut_ovdim.makat_nesia%type) return integer
IS
    --iFirstDigit number;
    iMakatType number;
    v_makat tb_peilut_ovdim.makat_nesia%type;
BEGIN

     v_makat:=to_number(rpad(to_char(p_makat),8,'0'));

     IF (v_makat<60000000) THEN
         iMakatType:=1; --kav sherut
     ELSIF v_makat BETWEEN 60000000 AND 69999999 THEN
           iMakatType:=2; --Empty
     ELSIF v_makat BETWEEN 80000000 AND 99999999 THEN
           iMakatType:=3; --Namak
     ELSIF v_makat BETWEEN 70000000 AND 70099999 THEN
           iMakatType:=4; --
     ELSIF v_makat BETWEEN 70100000 AND 79900000 THEN
           iMakatType:=5; --Element
     ELSE
          iMakatType:=0;
     END If;


    /* iFirstDigit:=TRUNC(v_makat / 10000000);
     IF (iFirstDigit=7) THEN
        iFirstDigit:=TRUNC(MOD(v_makat , 10000000) / 1000000);
        IF (iFirstDigit<>0) THEN
            --Element
            iMakatType:=5;
        ELSE
            iFirstDigit:=TRUNC(MOD(MOD(v_makat , 10000000),1000000) / 100000);
            IF (iFirstDigit=0) THEN
                iMakatType:=4; --
            ELSE
                iMakatType:=5; --Element
            END IF;
        END IF;
      ELSE
          IF (iFirstDigit BETWEEN 0 AND 5) THEN
             iMakatType:=1; --kav sherut
          ELSIF (iFirstDigit=6) THEN
             iMakatType:=2; --Empty
          ELSIF (iFirstDigit=8 or iFirstDigit=9) THEN
             iMakatType:=3; --Namak
          END IF;
     END IF;*/

     RETURN iMakatType;
END fn_get_makat_type;
PROCEDURE pro_get_mashar_data(p_cars_number in varchar2,p_cur out CurType)
IS
-- PRAGMA AUTONOMOUS_TRANSACTION;

BEGIN


    SET TRANSACTION READ ONLY;
     --SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

/*     OPEN p_cur;
     LOOP
      FETCH p_cur into v_cur;
      EXIT WHEN p_cur%NOTFOUND;
     END LOOP;*/
     OPEN p_cur FOR
     SELECT license_number, bus_number,Vehicle_Type
     FROM VCL_GENERAL_VEHICLE_VIEW@kds2maale
     WHERE bus_number in
     (select x from table(cast(convert_string_to_table(p_cars_number ,  ',') as mytabtype)));


     COMMIT;
EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END pro_get_mashar_data;
PROCEDURE pro_get_mashar_bus_license_num(p_oto_no in tb_peilut_ovdim.oto_no%type, p_license_no out number)
IS
    v_license_no number;
BEGIN
    SELECT license_number INTO v_license_no
    FROM VCL_GENERAL_VEHICLE_VIEW@kds2maale
    WHERE bus_number=p_oto_no;

    p_license_no:=v_license_no;
    EXCEPTION
         WHEN NO_DATA_FOUND THEN
            p_license_no:=0;
END pro_get_mashar_bus_license_num;
PROCEDURE pro_get_kavim_details_test(p_mispar_ishi in number, p_date_from date, p_date_to date, p_cur out my_cursor) is
    rc number;
    CURSOR v_Cur IS
    SELECT distinct po.MAKAT_NESIA, po.TAARICH
    FROM tb_sidurim_ovdim o,tb_peilut_ovdim po
    WHERE o.mispar_ishi = po.mispar_ishi(+)
          AND o.taarich = po.taarich(+)
          AND o.mispar_sidur= po.mispar_sidur(+)
          AND o.shat_hatchala = po.shat_hatchala_sidur(+)
          AND o.mispar_ishi=p_mispar_ishi
          AND trunc(o.taarich) between trunc(p_date_from) and trunc(p_date_to);

    v_rec v_Cur%ROWTYPE;
BEGIN
     BEGIN
           --Insert makats to tmp_table
          OPEN  v_Cur;
          LOOP
                FETCH  v_Cur INTO v_rec;
                EXIT WHEN v_Cur%NOTFOUND;
                     INSERT INTO TMP_CATALOG_DETAILS@kds_gw_at_tnpr
                              (activity_date,makat8)
                      VALUES (v_rec.taarich,v_rec.makat_nesia);

          END LOOP;
          CLOSE v_Cur;
          EXCEPTION
              WHEN DUP_VAL_ON_INDEX THEN
                   NULL;
      END;

      --Get makats details
       kds_catalog_pack.GetKavimDetails@kds_gw_at_tnpr(rc);

      OPEN p_cur FOR
      SELECT * FROM TMP_CATALOG_DETAILS@kds_gw_at_tnpr;

EXCEPTION
      WHEN OTHERS THEN
        RAISE;
END pro_get_kavim_details_test;--
PROCEDURE pro_get_kavim_details(p_mispar_ishi in tb_sidurim_ovdim.mispar_ishi%type, p_date_from date, p_date_to date, p_cur out my_cursor) is
    v_count  number;
    rc number;
BEGIN
    SELECT DISTINCT count(po.mispar_ishi) into v_count
    FROM tb_sidurim_ovdim o,tb_peilut_ovdim po
    WHERE o.mispar_ishi = po.mispar_ishi
          AND o.taarich = po.taarich
          AND o.mispar_sidur= po.mispar_sidur
          AND o.shat_hatchala = po.shat_hatchala_sidur
          AND o.mispar_ishi=p_mispar_ishi
          AND trunc(o.taarich) between trunc(p_date_from) and trunc(p_date_to);

    IF (v_count>0) THEN
    BEGIN
       INSERT INTO TMP_CATALOG_DETAILS@kds_gw_at_tnpr
                              (activity_date,makat8)
       SELECT distinct po.TAARICH ,po.MAKAT_NESIA
       FROM tb_sidurim_ovdim o,tb_peilut_ovdim po
       WHERE o.mispar_ishi = po.mispar_ishi
          AND o.taarich = po.taarich
          AND o.mispar_sidur= po.mispar_sidur
          AND o.shat_hatchala = po.shat_hatchala_sidur
          AND o.mispar_ishi=p_mispar_ishi
          AND trunc(o.taarich) between trunc(p_date_from) and trunc(p_date_to);

       EXCEPTION
              WHEN DUP_VAL_ON_INDEX THEN
                   NULL;
     END;
     BEGIN
        --Get makats details
      kds_catalog_pack.GetKavimDetails@kds_gw_at_tnpr(rc);

      OPEN p_cur FOR
      SELECT * FROM TMP_CATALOG_DETAILS@kds_gw_at_tnpr;
     END;
    END IF;

END  pro_get_kavim_details;
END PKG_TNUA; 
/
CREATE OR REPLACE PACKAGE PKG_UTILS AS
/******************************************************************************
   NAME:       PKG_UTILS
   PURPOSE:

   REVISIONS:
   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        26/04/2009             1. Created this package.
******************************************************************************/

/*
Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        27/04/2009      sari       1. ????? ????? ????? ?????
*/
TYPE	CurType	  IS	REF  CURSOR;

PROCEDURE MoveRecordsToHistory(p_taarich in TB_SIDURIM_OVDIM.taarich%type);

PROCEDURE pro_get_ezorim(p_Cur OUT CurType);

PROCEDURE pro_get_snif_av(p_kod_ezor in ctb_ezor.kod_ezor%type, p_cur OUT CurType);

PROCEDURE pro_get_profil(p_Cur OUT CurType) ;

PROCEDURE pro_get_harshaot_to_profil(p_kod_profil in  tb_harshaot_masachim.KOD_PROFIL%type, p_Cur OUT CurType);

PROCEDURE pro_get_maamad(p_kod_hevra in ctb_maamad.kod_hevra%type, p_cur OUT CurType);

PROCEDURE pro_get_hodaot_to_profil(p_kod_masach  IN TB_Hodaot.MASACH_ID%type ,
		  									   		   		                  p_kod_profil IN  tb_harshaot_masachim.KOD_PROFIL%type ,
		  										  	  							   p_Cur OUT CurType) ;

PROCEDURE pro_get_error_ovdim(p_kod_snif in ctb_snif_av.kod_snif_av%type, p_kod_maamad in ctb_maamad.kod_maamad_hr%type,
                              p_from_date in date, p_to_date in date,
                              p_cur OUT CurType);

PROCEDURE pro_get_log_tahalich(p_Cur OUT CurType) ;

PROCEDURE pro_get_etz_nihuly_by_user(p_prefix in varchar2, p_mispar_ishi in NUMBER, p_cur out CurType) ;
PROCEDURE pro_ins_Manage_Tree(p_mispar_ishi in number );

PROCEDURE pro_get_etz_nihuly_by_name(p_prefix in varchar2, p_mispar_ishi in NUMBER, p_cur out CurType);

PROCEDURE pro_get_meafyeney_bitua(p_Cur OUT CurType) ;

PROCEDURE pro_get_kod_natun(p_Cur OUT CurType) ;
PROCEDURE pro_get_parameters_table(p_cur out CurType);
PROCEDURE pro_get_ctb_elementim(p_cur out CurType);
PROCEDURE pro_get_sugey_yamim_meyuchadim(p_cur out CurType);
PROCEDURE pro_get_yamim_meyuchadim(p_cur out CurType);
PROCEDURE pro_get_sidurim_meyuch_rechiv(p_date in tb_sidurim_meyuchadim_rechiv.me_taarich%type,
		  									   	  		 p_cur out CurType);
PROCEDURE pro_get_sug_sidur_rechiv(p_date in tb_sidurim_meyuchadim_rechiv.me_taarich%type,
		  									   	  		 p_cur out CurType);
PROCEDURE pro_get_ctb_mutamut(p_cur out CurType);
PROCEDURE pro_get_sibot_ledivuch_yadani(p_cur out CurType);
PROCEDURE pro_get_status_ishur_max_level(p_mispar_ishi in tb_ishurim.mispar_ishi%type,
                                         p_taarich in tb_ishurim.taarich%type,
                                         p_kod_ishur in tb_ishurim.kod_ishur%type,
                                         p_kod_status out tb_ishurim.kod_status_ishur%type);
FUNCTION  pro_check_ishur(p_mispar_ishi in tb_ishurim.mispar_ishi%type,
                                         p_taarich in tb_ishurim.taarich%type,
                                         p_kod_ishur in tb_ishurim.kod_ishur%type,
                                       p_mispar_sidur in tb_ishurim.mispar_sidur%type default  null,
									    p_shat_hatchala in tb_ishurim.Shat_Hatchala%type default  null) RETURN  NUMBER;

										PROCEDURE pro_get_premia_yadanit(p_mispar_ishi in TB_Premyot_Yadaniyot.MISPAR_ISHI%type, p_chodesh in TB_Premyot_Yadaniyot.TAARICH%type, p_sug_premya in TB_Premyot_Yadaniyot.SUG_PREMYA%type, p_Cur out CurType);

PROCEDURE pro_get_ovdim_for_premia(p_kod_premia in MEAFYENIM_OVDIM.KOD_MEAFYEN%type,p_taarich in MEAFYENIM_OVDIM.ME_TAARICH%type, p_cur out CurType);

PROCEDURE pro_get_ovdim_for_premiot(p_mispar_ishi in varchar2,p_kod_premia in MEAFYENIM_OVDIM.KOD_MEAFYEN%type,p_Period in varchar2, p_cur out CurType);

PROCEDURE pro_get_premyot_details(p_premya_codes varchar2, p_cur out CurType);

PROCEDURE pro_get_premyot_view(p_mispar_ishi in PREMYOT_VW.mispar_ishi%type,
                                         p_tkufa in PREMYOT_VW.tkufa%type,
                                         p_cur out CurType);

PROCEDURE pro_get_zman_nesia(p_merkaz_erua in ctb_zman_nsiaa_mishtane.merkaz_erua%type,
                             p_mikum_yaad  in ctb_zman_nsiaa_mishtane.mikum_yaad%type,
                             p_taarich     in ctb_zman_nsiaa_mishtane.me_taarich%type,
                             p_dakot out   ctb_zman_nsiaa_mishtane.dakot%type);

PROCEDURE Pro_Get_Value_From_Parametrim( p_Kod_Param in  TB_Parametrim.Kod_Param%TYPE,
                                                                               p_Period in varchar2 ,
                                                                              p_Erech_Param out  TB_Parametrim.ERECH_PARAM%TYPE)       ;

PROCEDURE Pro_Get_Value_From_Parametrim (p_kod_param in TB_PARAMETRIM.KOD_PARAM%type,
                                            p_taarich in date ,
                                            p_ERECH_PARAM    out integer)  ;

procedure Pro_Get_Previous_Months_List(p_FromDate IN date, NumOfPreviousMonth number ,DisplayAll number,   p_cur out CurType);

  PROCEDURE  pro_get_ovdim_leRitza (p_mis_ritza in integer  ,
  			 					   				   			  	                p_maamad in varchar2,
																			    p_isuk in varchar2,
																				p_preFix in varchar2,
																				p_cur out CurType);

  FUNCTION fun_GET_Rechiv_Value(p_MisparIshi in TB_Chishuv_Chodesh_Ovdim.Mispar_ishi%type,
                                                        p_Kod_Rechiv in TB_Chishuv_Chodesh_Ovdim.Kod_Rechiv%type,
                                                        p_StartDate in date,
                                                        p_EndDate in date,
                                                        p_Bakasha_ID in  TB_Chishuv_Chodesh_Ovdim.Bakasha_ID%type
                                                        ) RETURN number ;

	 PROCEDURE get_sadot_nosafim_lesidur(p_Sidur in integer,
 		  									   		   	  		 		        p_List_Meafyenim in varchar2,
																				p_cur out CurType) ;
	PROCEDURE get_sadot_nosafim_lePeilut(p_cur out CurType);
  PROCEDURE get_sadot_nosafim_kayamim(p_mispar_ishi in  integer,
														                                p_mispar_sidur in  integer,
																					    p_taarich in TB_SIDURIM_OVDIM.TAARICH%type,
																						p_shat_hatchala in TB_SIDURIM_OVDIM.shat_hatchala%type,
																						p_cur out CurType) ;
																						
	PROCEDURE pro_insert_barkod_Tachograf(p_mispar_ishi in  integer,p_taarich in TB_TACHOGRAF_LE_KARTIS.TAARICH%type,p_Barkod in  number	);		
    PROCEDURE fun_get_barkod_Tachograf(p_mispar_ishi in  integer,p_taarich in TB_TACHOGRAF_LE_KARTIS.TAARICH%type, p_cur out CurType  ) ;
	PROCEDURE pro_get_tavlaot_to_refresh(p_cur out CurType);														
END PKG_UTILS;
/

CREATE OR REPLACE PACKAGE BODY PKG_UTILS AS
/******************************************************************************
   NAME:       PKG_UTILS
   PURPOSE:

   REVISIONS:
   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        26/04/2009             1. Created this package.
******************************************************************************/

PROCEDURE MoveRecordsToHistory(p_taarich in TB_SIDURIM_OVDIM.taarich%type)
IS
	fromDate date;
	toDate date;
	 err_code number;
	  err_msg varchar2(100);
  BEGIN

  select trunc(p_taarich, 'MM') into fromDate from dual;
   select  last_day(p_taarich) into toDate from dual;


		insert  into HISTORY_YAMEY_AVODA_OVDIM(MISPAR_ISHI,TAARICH,SHAT_HATCHALA,SHAT_SIYUM,TACHOGRAF,BITUL_ZMAN_NESIOT,ZMAN_NESIA_HALOCH,ZMAN_NESIA_HAZOR,HALBASHA,LINA,HASHLAMA_LEYOM,SIBAT_HASHLAMA_LEYOM,STATUS,KOD_HISTAYGUT_AUTO,MEASHER_O_MISTAYEG,STATUS_TIPUL,MEADKEN_ACHARON,TAARICH_IDKUN_ACHARON,HEARA,HAMARAT_SHABAT)
		 (select MISPAR_ISHI,TAARICH,SHAT_HATCHALA,SHAT_SIYUM,TACHOGRAF,BITUL_ZMAN_NESIOT,ZMAN_NESIA_HALOCH,ZMAN_NESIA_HAZOR,HALBASHA,LINA,HASHLAMA_LEYOM,SIBAT_HASHLAMA_LEYOM,STATUS,KOD_HISTAYGUT_AUTO,MEASHER_O_MISTAYEG,STATUS_TIPUL,MEADKEN_ACHARON,TAARICH_IDKUN_ACHARON,HEARA,HAMARAT_SHABAT
		  from TB_YAMEY_AVODA_OVDIM
		  where Taarich between fromDate and toDate);
  
  
		insert into HISTORY_SIDURIM_OVDIM(MISPAR_ISHI,MISPAR_SIDUR,TAARICH,SHAT_HATCHALA,SHAT_GMAR,SHAT_HATCHALA_LETASHLUM,SHAT_GMAR_LETASHLUM,PITZUL_HAFSAKA,CHARIGA,TOSEFET_GRIRA,HASHLAMA,YOM_VISA,LO_LETASHLUM,OUT_MICHSA,MIKUM_SHAON_KNISA,MIKUM_SHAON_YETZIA,BITUL_O_HOSAFA,ACHUZ_KNAS_LEPREMYAT_VISA,ACHUZ_VIZA_BESIKUN,tafkid_visa,MISPAR_MUSACH_O_MACHSAN,KOD_SIBA_LO_LETASHLUM,KOD_SIBA_LEDIVUCH_YADANI_IN,KOD_SIBA_LEDIVUCH_YADANI_OUT,SHAYAH_LEYOM_KODEM,MEADKEN_ACHARON,TAARICH_IDKUN_ACHARON,HEARA,MISPAR_SHIUREY_NEHIGA,MEZAKE_HALBASHA,MEZAKE_NESIOT,MIVTZA_VISA,SUG_HAZMANAT_VISA,NIDRESHET_HITIATZVUT,SHAT_HITIATZVUT,PTOR_MEHITIATZVUT,MENAHEL_MUSACH_MEADKEN)
		 (select MISPAR_ISHI,MISPAR_SIDUR,TAARICH,SHAT_HATCHALA,SHAT_GMAR,SHAT_HATCHALA_LETASHLUM,SHAT_GMAR_LETASHLUM,PITZUL_HAFSAKA,CHARIGA,TOSEFET_GRIRA,HASHLAMA,YOM_VISA,LO_LETASHLUM,OUT_MICHSA,MIKUM_SHAON_KNISA,MIKUM_SHAON_YETZIA,BITUL_O_HOSAFA,ACHUZ_KNAS_LEPREMYAT_VISA,ACHUZ_VIZA_BESIKUN,tafkid_visa,MISPAR_MUSACH_O_MACHSAN,KOD_SIBA_LO_LETASHLUM,KOD_SIBA_LEDIVUCH_YADANI_IN,KOD_SIBA_LEDIVUCH_YADANI_OUT,SHAYAH_LEYOM_KODEM,MEADKEN_ACHARON,TAARICH_IDKUN_ACHARON,HEARA,MISPAR_SHIUREY_NEHIGA,MEZAKE_HALBASHA,MEZAKE_NESIOT,MIVTZA_VISA,SUG_HAZMANAT_VISA,NIDRESHET_HITIATZVUT,SHAT_HITIATZVUT,PTOR_MEHITIATZVUT,MENAHEL_MUSACH_MEADKEN
		  from TB_SIDURIM_OVDIM
		  where Taarich between fromDate and toDate);
  
		   insert into HISTORY_PEILUT_OVDIM(MISPAR_ISHI,TAARICH,MISPAR_SIDUR,SHAT_HATCHALA_SIDUR,SHAT_YETZIA,MISPAR_KNISA,MAKAT_NESIA,OTO_NO,MISPAR_SIDURI_OTO,KISUY_TOR,BITUL_O_HOSAFA,KOD_SHINUY_PREMIA,SNIF_TNUA,MISPAR_VISA,IMUT_NETZER,SHAT_BHIRAT_NESIA_NETZER,OTO_NO_NETZER,MISPAR_SIDUR_NETZER,SHAT_YETZIA_NETZER,MAKAT_NETZER,SHILUT_NETZER,MIKUM_BHIRAT_NESIA_NETZER,MISPAR_MATALA,TAARICH_IDKUN_ACHARON,MEADKEN_ACHARON,HEARA,DAKOT_BAFOAL,KM_VISA)
		 (select MISPAR_ISHI,TAARICH,MISPAR_SIDUR,SHAT_HATCHALA_SIDUR,SHAT_YETZIA,MISPAR_KNISA,MAKAT_NESIA,OTO_NO,MISPAR_SIDURI_OTO,KISUY_TOR,BITUL_O_HOSAFA,KOD_SHINUY_PREMIA,SNIF_TNUA,MISPAR_VISA,IMUT_NETZER,SHAT_BHIRAT_NESIA_NETZER,OTO_NO_NETZER,MISPAR_SIDUR_NETZER,SHAT_YETZIA_NETZER,MAKAT_NETZER,SHILUT_NETZER,MIKUM_BHIRAT_NESIA_NETZER,MISPAR_MATALA,TAARICH_IDKUN_ACHARON,MEADKEN_ACHARON,HEARA,DAKOT_BAFOAL,KM_VISA
		  from TB_PEILUT_OVDIM
		  where Taarich between fromDate and toDate);
  

		  delete  from TB_PEILUT_OVDIM
		  where Taarich between fromDate and toDate;
		 
		  delete from TB_SIDURIM_OVDIM
		  where Taarich between fromDate and toDate;
 
		  delete from TB_YAMEY_AVODA_OVDIM
		  where Taarich between fromDate and toDate;
	
	--	   commit;	  
		EXCEPTION
		        WHEN OTHERS THEN
				RAISE;
			--	BEGIN
					-- ROLLBACK;
						-- err_msg := substr(SQLERRM, 1, 200);
					  --   PKG_BATCH.pro_ins_log_tahalich(99,0,3,  err_msg);
					     ---commit;	  
				-- END;
 END MoveRecordsToHistory;

/*
Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        27/04/2009      vered       1. ????? ????? ????? ?????
*/
PROCEDURE pro_get_ezorim(p_Cur OUT CurType)
IS
	 BEGIN
     OPEN p_Cur FOR
       SELECT code,description
       FROM (
             SELECT  DISTINCT aa.kod_ezor code, kod_ezor || ' - ' ||  aa.teur_ezor description,aa.teur_ezor
             FROM ctb_ezor aa)
       ORDER BY teur_ezor;

	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END pro_get_ezorim;


PROCEDURE pro_get_snif_av(p_kod_ezor in ctb_ezor.kod_ezor%type,p_cur OUT CurType)
IS
    BEGIN
     OPEN p_Cur FOR
         SELECT a.Kod_Snif_Av code, a.Teur_Snif_Av  || ' (' ||  a.Kod_Snif_Av || ') '  || c.teur_hevra || ' ('  ||  b.kod_hevra || ')'    Description
         FROM  ctb_snif_av a, ctb_Ezor b, ctb_hevra c
         WHERE a.ezor=b.kod_ezor
               AND (a.ezor=p_kod_ezor or p_kod_ezor is null)
               AND a.kod_hevra = c.kod_hevra
               AND a.ezor=b.kod_ezor
               AND c.KOD_HEVRA=b.kod_hevra
         ORDER BY a.Teur_Snif_Av asc ;

	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END pro_get_snif_av;

/*
Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0       03/05/2009      sari       1.   
*/
PROCEDURE pro_get_profil(p_Cur OUT CurType)
IS
	 BEGIN
     OPEN p_Cur FOR
      	  select kod_profil,teur_profil from ctb_profil;

	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END pro_get_profil;


/*
Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0       03/05/2009      sari       1.     
*/
PROCEDURE pro_get_harshaot_to_profil(p_kod_profil IN  tb_harshaot_masachim.KOD_PROFIL%type ,
		  										  	  							   p_Cur OUT CurType)
IS
	 BEGIN
     OPEN p_Cur FOR
      	  select  m.sug,m.shem,h.kod_harshaa, m.masach_id
			from  tb_masach m, tb_harshaot_masachim h
			where m.masach_id=h.masach_id
			and m.pakad_id=h.pakad_id
			and h.kod_profil=p_kod_profil;

	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END pro_get_harshaot_to_profil;

PROCEDURE pro_get_maamad(p_kod_hevra in ctb_maamad.kod_hevra%type, p_cur OUT CurType) is
BEGIN
     OPEN p_Cur FOR
          select m.kod_hevra || '-' || m.kod_maamad_hr code, m.teur_maamad_hr  || ' (' || m.kod_maamad_hr || ') '   || c.teur_hevra || ' (' || c.kod_hevra || ')'  Description
          from  ctb_maamad m, ctb_hevra c
          where (m.kod_hevra=p_kod_hevra or p_kod_hevra is null)
                and m.kod_hevra= c.kod_hevra
          order by m.teur_maamad_hr;
         /*SELECT distinct a.kod_maamad_hr code, a.teur_maamad_hr  || ' ' || a.kod_maamad_hr || ' '   || c.teur_hevra || ' ' || c.kod_hevra  Description
         FROM  ctb_maamad a,pirtey_ovdim o , ctb_hevra c
         WHERE c.kod_hevra = a.kod_hevra
               and exists (select distinct m.mispar_ishi
                           from pirtey_ovdim  m
                           where m.kod_natun=4
                                 and m.erech=p_kod_snif and m.mispar_ishi=o.mispar_ishi)
         AND o.kod_natun =13
         AND o.erech =a.kod_maamad_hr

         ORDER BY a.kod_maamad_hr;*/


	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END pro_get_maamad;

/*
Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0       0405/2009      sari       1.     
*/
PROCEDURE pro_get_hodaot_to_profil(p_kod_masach  IN TB_Hodaot.MASACH_ID%type ,
		  									   		   		                  p_kod_profil IN  tb_harshaot_masachim.KOD_PROFIL%type ,
		  										  	  							   p_Cur OUT CurType)
IS
	 BEGIN
     OPEN p_Cur FOR
      	 Select h. Melel_Hodaa,h.Kod_Hodaa
		From TB_Hodaot h,  TB_Hodaot_LeProfil hp
		Where h.Kod_Hodaa= hp.Kod_Hodaa
		And h.MASACH_ID = p_kod_masach
		And hp.Kod_Profil = p_kod_profil
		And h. Me_Taarich <= trunc(sysdate)
		And h. Ad_Taarich >= trunc(sysdate);


	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END pro_get_hodaot_to_profil;

PROCEDURE pro_get_error_ovdim(p_kod_snif in ctb_snif_av.kod_snif_av%type, p_kod_maamad in ctb_maamad.kod_maamad_hr%type,
                              p_from_date in date, p_to_date in date,
                              p_cur OUT CurType)
IS
     BEGIN
     OPEN p_Cur FOR
      	 select distinct m1.mispar_ishi
         from pirtey_ovdim  m1, pirtey_ovdim m2,tb_yamey_avoda_ovdim l

         where m1.kod_natun=4
               and m1.erech=p_kod_snif
               and m2.KOD_NATUN=13
               and m2.erech= p_kod_maamad

               and m1.mispar_ishi=m2.mispar_ishi
               and m1.mispar_ishi=l.mispar_ishi
               and l.taarich between p_from_date and p_to_date;


	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END pro_get_error_ovdim;


 /*
Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0       0505/2009      sari       1.    
*/
PROCEDURE pro_get_log_tahalich(p_Cur OUT CurType)
IS
	 BEGIN
 	 	  OPEN p_Cur FOR
      	  	   Select k.Teur_Tahalich,p.Teur_Peilut_Be_Tahalich,
				l.Taarich,t.Teur_Takala,l.Teur_Tech
				From CTB_Tahalich_Klita k, CTB_Peilut_BeTahalich p, TB_Log_Tahalich l, CTB_Takalot t
				Where l. Status=3
				And l.Kod_Tahalich = k.Kod_Tahalich
				And k.Kod_Tahalich = p.Kod_Tahalich(+)
				And p.Kod_Peilut_Be_Tahalich = l.Kod_Peilut_Tahalich(+)
				AND l.Kod_Takala = t.Kod_Takala(+)
				Order By l.Taarich Desc;

	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END pro_get_log_tahalich;

 /*
Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0       02/06/2009      sari       1.    
*/
PROCEDURE pro_get_etz_nihuly_by_user(p_prefix in varchar2, p_mispar_ishi in NUMBER, p_cur out CurType) IS
BEGIN
   open p_Cur for
          select distinct a.yechidat_aba,a.yechida_mekorit,o.shem_mish || ' ' ||  o.shem_prat  || ' (' || a.mispar_ishi || ')' Oved_Name,a.mispar_ishi
				from
				     ovdim o,
									(select * from
									       ez_nihuly e,
										  (select Mispar_Ishi,erech from Pirtey_Ovdim
										   where  trunc(sysdate)>= Me_taarich
										  and trunc(sysdate)<= Ad_taarich
										  and  Kod_Natun=1) p
									where p.erech=e.yechida_mekorit) a
						where o.mispar_ishi=a.mispar_ishi
						and   o.mispar_ishi like p_prefix
						CONNECT BY a.YECHIDAT_ABA  = PRIOR a.yechida_mekorit
						START WITH (a.YECHIDAT_ABA  =(Select Erech
																							From Pirtey_Ovdim
																							Where Mispar_Ishi=p_mispar_ishi
																							and trunc(sysdate)>= Me_taarich
																							and trunc(sysdate)<= Ad_taarich
																							and  Kod_Natun=1)
														or a.yechida_mekorit   =(Select Erech
																							From Pirtey_Ovdim
																							Where Mispar_Ishi=p_mispar_ishi
																							and trunc(sysdate)>= Me_taarich
																							and trunc(sysdate)<= Ad_taarich
																							and  Kod_Natun=1))

					/*union all
						  select  e.yechidat_aba,e.yechida_mekorit,o.shem_mish || ' ' ||  o.shem_prat  || ' (' || o.mispar_ishi || ')' Oved_Name,o.mispar_ishi
							from
							     ovdim o, Pirtey_Ovdim p,ez_nihuly e
						      where  trunc(sysdate)>= Me_taarich
									  and trunc(sysdate)<= p.Ad_taarich
									  and  p.Kod_Natun=1
									  and p.Mispar_Ishi=p_mispar_ishi
									and p.erech=e.yechida_mekorit
									and o.mispar_ishi=p.mispar_ishi
									and   o.mispar_ishi like p_prefix		*/
				order by mispar_ishi;


	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END pro_get_etz_nihuly_by_user;

PROCEDURE pro_ins_Manage_Tree(p_mispar_ishi in number ) is 
begin 
INSERT INTO TMP_MANAGE_TREE 
          select distinct a.mispar_ishi
                from
                                    (select * from
                                           ez_nihuly e,
                                          (select Mispar_Ishi,erech from Pirtey_Ovdim
                                           where  trunc(sysdate)>= Me_taarich
                                          and trunc(sysdate)<= Ad_taarich
                                          and  Kod_Natun=1) p
                                    where p.erech=e.yechida_mekorit) a
                        CONNECT BY a.YECHIDAT_ABA  = PRIOR a.yechida_mekorit
                        START WITH (a.YECHIDAT_ABA  =(Select Erech
                                                                                            From Pirtey_Ovdim
                                                                                            Where Mispar_Ishi=p_mispar_ishi
                                                                                            and trunc(sysdate)>= Me_taarich
                                                                                            and trunc(sysdate)<= Ad_taarich
                                                                                            and  Kod_Natun=1)
                                                        or a.yechida_mekorit   =(Select Erech
                                                                                            From Pirtey_Ovdim
                                                                                            Where Mispar_Ishi=p_mispar_ishi
                                                                                            and trunc(sysdate)>= Me_taarich
                                                                                            and trunc(sysdate)<= Ad_taarich
                                                                                            and  Kod_Natun=1)) ;

 

end pro_ins_Manage_Tree; 

/*
Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0       02/06/2009      sari       1.    
*/
PROCEDURE pro_get_etz_nihuly_by_name(p_prefix in varchar2, p_mispar_ishi in NUMBER, p_cur out CurType) IS
BEGIN
   open p_Cur for
          select distinct a.yechidat_aba,a.yechida_mekorit,o.shem_mish || ' ' ||  o.shem_prat  || ' (' || o.mispar_ishi || ')' Oved_Name,a.mispar_ishi
				from
				     ovdim o,
									(select * from
									       ez_nihuly e,
										  (select Mispar_Ishi,erech from Pirtey_Ovdim
										   where  trunc(sysdate)>= Me_taarich
										  and trunc(sysdate)<= Ad_taarich
										  and  Kod_Natun=1) p
									where p.erech=e.yechida_mekorit) a
						where o.mispar_ishi=a.mispar_ishi
						and   o.shem_mish || ' ' ||  o.shem_prat like p_prefix
						CONNECT BY a.YECHIDAT_ABA  = PRIOR a.yechida_mekorit
						START WITH (a.YECHIDAT_ABA  =(Select Erech
																							From Pirtey_Ovdim
																							Where Mispar_Ishi=p_mispar_ishi
																							and trunc(sysdate)>= Me_taarich
																							and trunc(sysdate)<= Ad_taarich
																							and  Kod_Natun=1)
														or a.yechida_mekorit   =(Select Erech
																							From Pirtey_Ovdim
																							Where Mispar_Ishi=p_mispar_ishi
																							and trunc(sysdate)>= Me_taarich
																							and trunc(sysdate)<= Ad_taarich
																							and  Kod_Natun=1))

					/*union all
						  select  e.yechidat_aba,e.yechida_mekorit,o.shem_mish || ' ' ||  o.shem_prat  || ' (' || o.mispar_ishi || ')' Oved_Name,o.mispar_ishi
							from
							     ovdim o, Pirtey_Ovdim p,ez_nihuly e
						      where  trunc(sysdate)>= Me_taarich
									  and trunc(sysdate)<= p.Ad_taarich
									  and  p.Kod_Natun=1
									  and p.Mispar_Ishi=p_mispar_ishi
									and p.erech=e.yechida_mekorit
									and o.mispar_ishi=p.mispar_ishi
									and   o.shem_mish || ' ' ||  o.shem_prat like p_prefix						*/
				order by mispar_ishi;


	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END pro_get_etz_nihuly_by_name;

/*
Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0       0405/2009      sari       1.     
*/
PROCEDURE pro_get_meafyeney_bitua(p_Cur OUT CurType)
IS
	 BEGIN
     OPEN p_Cur FOR
      	 Select to_char(m.KOD_MEAFYEN_BITZUA) KOD_MEAFYEN_BITZUA,m.TEUR_MEAFYEN_BITZUA
		   from ctb_meafyen_bitzua  m
		   order by m.KOD_MEAFYEN_BITZUA ;


	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END pro_get_meafyeney_bitua;


/*
Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0       0405/2009      sari       1.   
*/
PROCEDURE pro_get_kod_natun(p_Cur OUT CurType)
IS
	 BEGIN
     OPEN p_Cur FOR
      	 Select to_char(n.KOD_NATUN) KOD_NATUN ,n.TEUR_NATUN
		 from ctb_natun_hr  n
		 Order by n.KOD_NATUN;


	 EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END pro_get_kod_natun;
PROCEDURE pro_get_parameters_table(p_cur out CurType)
IS
BEGIN
     OPEN p_cur FOR
     SELECT kod_param,me_taarich,ad_taarich,erech_param
     FROM TB_PARAMETRIM;

EXCEPTION
        WHEN OTHERS THEN
		RAISE;
END pro_get_parameters_table;
PROCEDURE pro_get_ctb_elementim(p_cur out CurType)
IS
BEGIN
    OPEN p_cur for
    SELECT * FROM CTB_ELEMENTIM;

END pro_get_ctb_elementim;
/*
Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0       27/07/2009      sari       1.    
*/
PROCEDURE pro_get_sugey_yamim_meyuchadim(p_cur out CurType)
IS
BEGIN
    OPEN p_cur for
	    SELECT sy.SUG_YOM,sy.TEUR_YOM,sy.YOM_AVODA,sy.SHBATON,sy.EREV_SHISHI_CHAG,sy.SHISHI_MUHLAF
		 FROM ctb_sugey_yamim_meyuchadim sy;

END pro_get_sugey_yamim_meyuchadim;

/*
Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0       28/07/2009      sari       1.    
*/
PROCEDURE pro_get_yamim_meyuchadim(p_cur out CurType)
IS
BEGIN
    OPEN p_cur for
	    SELECT m.SUG_YOM,m.taarich,m.Sug_Yom_Muchlaf_Minhal ,m.Sug_Yom_Muchlaf_Meshek , 
		m.Sug_Yom_Muchlaf_Tnua ,m.Sug_Yom_Muchlaf_Nehagut
		 FROM tb_yamim_meyuchadim m ;

END pro_get_yamim_meyuchadim;

/*
Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0       27/07/2009      sari       1.       
*/
PROCEDURE pro_get_sidurim_meyuch_rechiv(p_date in tb_sidurim_meyuchadim_rechiv.me_taarich%type,
		  									   	  											 p_cur out CurType)
IS
BEGIN
    OPEN p_cur for
	    SELECT sm.mispar_sidur,sm.me_taarich,sm.ad_taarich,sm.kod_rechiv
		 FROM TB_Sidurim_Meyuchadim_Rechiv sm
		 where p_date between sm.me_taarich and nvl(sm.ad_taarich,to_date('01/01/9999','dd/mm/yyyy'));

END pro_get_sidurim_meyuch_rechiv;

/*
Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0       27/07/2009      sari       1.      
*/
PROCEDURE pro_get_sug_sidur_rechiv(p_date in tb_sidurim_meyuchadim_rechiv.me_taarich%type,
		  									   	  											 p_cur out CurType)
IS
BEGIN
    OPEN p_cur for
	    SELECT sr.KOD_RECHIV,sr.ME_TAARICH,sr.AD_TAARICH,sr.SUG_SIDUR
		 FROM TB_Sug_sidur_Rechiv sr
		 where p_date between sr.me_taarich and nvl(sr.ad_taarich,to_date('01/01/9999','dd/mm/yyyy'));

END pro_get_sug_sidur_rechiv;

/*   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0       03/08/2009      sari       1.   */
PROCEDURE pro_get_ctb_mutamut(p_cur out CurType)
IS
BEGIN
    OPEN p_cur for
    SELECT m.kod_mutamut,m.teur_mutamut,m.mezake_gmul, m.isur_shaot_nosafot
    FROM ctb_mutamut m;

END pro_get_ctb_mutamut;


PROCEDURE pro_get_sibot_ledivuch_yadani(p_cur out CurType)
IS
BEGIN
    OPEN p_cur for
    SELECT m.goremet_lebitul_zman_halbasha,m.goremet_lebitul_zman_nesiaa,
           m.kod_siba, m.pail, m.teur_siba
    FROM ctb_sibot_ledivuch_yadani m
    WHERE Pail=1
    ORDER BY m.kod_siba;
END pro_get_sibot_ledivuch_yadani;


PROCEDURE pro_get_status_ishur_max_level(p_mispar_ishi in tb_ishurim.mispar_ishi%type,
                                         p_taarich in tb_ishurim.taarich%type,
                                         p_kod_ishur in tb_ishurim.kod_ishur%type,
                                         p_kod_status out tb_ishurim.kod_status_ishur%type)
IS
BEGIN
    SELECT kod_status_ishur into p_kod_status
    FROM TB_ISHURIM T
    WHERE t.mispar_ishi   = p_mispar_ishi
          AND t.taarich   = trunc(p_taarich)
          AND t.kod_ishur = p_kod_ishur
          AND t.rama = (SELECT MAX(rama) rama
                        FROM TB_ISHURIM I
                        WHERE i.mispar_ishi = t.mispar_ishi
                              AND i.taarich = t.taarich
                              AND i.kod_ishur = t.kod_ishur);
END pro_get_status_ishur_max_level;


FUNCTION  pro_check_ishur(p_mispar_ishi in tb_ishurim.mispar_ishi%type,
                                         p_taarich in tb_ishurim.taarich%type,
                                         p_kod_ishur in tb_ishurim.kod_ishur%type,
                                       p_mispar_sidur in tb_ishurim.mispar_sidur%type default  null,
									    p_shat_hatchala in tb_ishurim.Shat_Hatchala%type default  null) RETURN  NUMBER
	IS
	v_ishur number;
BEGIN
	 begin
		 select 1 into v_ishur
			From TB_Ishurim
			Where Mispar_Ishi = p_mispar_ishi
			And Kod_Ishur =  p_kod_ishur
			And Taarich =  p_taarich
			And (Mispar_Sidur =   p_mispar_sidur or   p_mispar_sidur is null)
			And (Shat_Hatchala= p_shat_hatchala or  p_shat_hatchala is null)
			and rownum=1;

			EXCEPTION
		 WHEN NO_DATA_FOUND THEN
					return 1;
	       WHEN OTHERS THEN
				  RAISE;
     end;

	begin
	   select 1 into v_ishur
		From TB_Ishurim
        Where Mispar_Ishi =  p_mispar_ishi
        And Kod_Ishur =  p_kod_ishur
       And Taarich = p_taarich
        And (Mispar_Sidur =   p_mispar_sidur or   p_mispar_sidur is null)
		And (Shat_Hatchala= p_shat_hatchala or  p_shat_hatchala is null)
        And Kod_Status_Ishur = 1
        And Rama = (select Max(rama)
      			                    From TB_Ishurim
								    Where Mispar_Ishi =  p_mispar_ishi
								     And Kod_Ishur =  p_kod_ishur
								    And Taarich = p_taarich
								    And (Mispar_Sidur =   p_mispar_sidur or   p_mispar_sidur is null)
							        And (Shat_Hatchala= p_shat_hatchala or  p_shat_hatchala is null));


		return v_ishur;

	EXCEPTION
		 WHEN NO_DATA_FOUND THEN
					 return 0;
	       WHEN OTHERS THEN
				 RAISE;
  end;

END pro_check_ishur;

PROCEDURE pro_get_ovdim_for_premia(p_kod_premia in MEAFYENIM_OVDIM.KOD_MEAFYEN%type,p_taarich in MEAFYENIM_OVDIM.ME_TAARICH%type, p_cur out CurType)
IS
BEGIN

	 open p_cur for
select *
  from
  (select  m.MISPAR_ISHI,
  		                    decode(m.kod_meafyen,null,b.kod_meafyen,m.kod_meafyen) kod_meafyen,
							  to_number(decode(m.erech_ishi,null,decode(m.ERECH_MECHDAL_PARTANY,null, b.erech ,m.ERECH_MECHDAL_PARTANY ),m.erech_ishi))  value_erech_ishi
							from tmp_meafyenim_Ovdim m,BREROT_MECHDAL_MEAFYENIM b
				where trunc(p_taarich) between m.ME_TAARICH(+) and nvl(m.AD_TAARICH(+),to_date('01/01/9999','dd/mm/yyyy'))
				  and  trunc(p_taarich) between b.ME_TAARICH and nvl(b.AD_TAARICH,to_date('01/01/9999','dd/mm/yyyy'))
				   and m.kod_meafyen=b.KOD_MEAFYEN(+)
				   and m.kod_meafyen=p_kod_premia
	) t
	where t.value_erech_ishi = 1
	order by t.MISPAR_ISHI asc;

	 EXCEPTION
		    WHEN OTHERS THEN
				 RAISE;

END pro_get_ovdim_for_premia;

PROCEDURE pro_get_ovdim_for_premiot(p_mispar_ishi in varchar2, p_kod_premia in MEAFYENIM_OVDIM.KOD_MEAFYEN%type,p_Period in varchar2, p_cur out CurType)
 is
  p_ToDate Date ;
  p_FromDate date ;
  BEGIN
      p_FromDate := to_date('01/' || p_Period,'dd/mm/yyyy'); /* period= 05/2009=>  v_MinLimitDate = 01/05/2009 */
    p_ToDate := add_months(p_FromDate,1) -1 ;    /* period= 05/2009=>  v_MaxLimitDate = 31/05/2009 */

     open p_cur for
select *
  from
  (select  m.MISPAR_ISHI,
                              decode(m.kod_meafyen,null,b.kod_meafyen,m.kod_meafyen) kod_meafyen,
                              to_number(decode(m.erech_ishi,null,decode(m.ERECH_MECHDAL_PARTANY,null, b.erech ,m.ERECH_MECHDAL_PARTANY ),m.erech_ishi))  value_erech_ishi
                            from tmp_meafyenim_Ovdim m,BREROT_MECHDAL_MEAFYENIM b
                WHERE (m.Me_Taarich <=  p_ToDate ) and (m.Ad_Taarich >= p_FromDate or m.Ad_Taarich is null )
                   and m.kod_meafyen=b.KOD_MEAFYEN(+)
                   and m.kod_meafyen=p_kod_premia
    ) t
    where t.value_erech_ishi = 1
    and t.mispar_ishi like  p_mispar_ishi || '%' 
    order by t.MISPAR_ISHI asc;

     EXCEPTION
            WHEN OTHERS THEN
                 RAISE;

END pro_get_ovdim_for_premiot;


PROCEDURE pro_get_premyot_details(p_premya_codes varchar2, p_cur out CurType)
IS
BEGIN
--INSERT INTO TB_LOG_TEST(ID,PARAM,VALUE) VALUES ( KDSADMIN.TB_LOG_TEST_SEQ.NEXTVAL , 'p_premya_codes:',p_premya_codes);
	 open p_cur for
	 	  select Kod_Premia, Teur_Premia
		  from CTB_SUGEY_PREMIOT
		  where  (p_premya_codes is not null and length(p_premya_codes) > 0 and   Kod_Premia in
                (select x from table(cast(convert_string_to_table(p_premya_codes ,  ',') as mytabtype)))
                );

	EXCEPTION
		    WHEN OTHERS THEN
				 RAISE;

END pro_get_premyot_details;

PROCEDURE pro_get_premyot_view(p_mispar_ishi in PREMYOT_VW.mispar_ishi%type,
                                         p_tkufa in PREMYOT_VW.tkufa%type,
                                         p_cur out CurType)
IS
BEGIN
   open p_cur for
   		Select Sug_premia,sum(Dakot_premia) Sum_dakot
		From PREMYOT_VW
		Where Mispar_ishi = p_mispar_ishi
		And Tkufa = p_tkufa
		Group by (Mispar_ishi,Tkufa, Sug_premia);

	EXCEPTION
		    WHEN OTHERS THEN
				 RAISE;
END pro_get_premyot_view;

PROCEDURE pro_get_premia_yadanit(p_mispar_ishi in TB_Premyot_Yadaniyot.MISPAR_ISHI%type, p_chodesh in TB_Premyot_Yadaniyot.TAARICH%type, p_sug_premya in TB_Premyot_Yadaniyot.SUG_PREMYA%type, p_Cur out CurType)
IS
BEGIN

	 open p_cur for
	 	  select DAKOT_PREMYA, Taarich_idkun_acharon,sug_premya
		  from TB_Premyot_Yadaniyot
		  where MISPAR_ISHI = p_mispar_ishi
		    and (SUG_PREMYA = p_sug_premya or p_sug_premya is null)
			and to_char(TAARICH,'mm/yyyy') = to_char(p_chodesh,'mm/yyyy');

	EXCEPTION
		    WHEN OTHERS THEN
				 RAISE;
END pro_get_premia_yadanit;

PROCEDURE pro_get_zman_nesia(p_merkaz_erua in  ctb_zman_nsiaa_mishtane.merkaz_erua%type,
                             p_mikum_yaad  in  ctb_zman_nsiaa_mishtane.mikum_yaad%type,
                             p_taarich     in ctb_zman_nsiaa_mishtane.me_taarich%type,
                             p_dakot       out ctb_zman_nsiaa_mishtane.dakot%type)
IS
    v_dakot number;
	v_kod_mikum_yechida number;
	 v_kod_merkaz_erua number;
BEGIN
    v_dakot:= 0;
	select    KOD_MIKUM_YECHIDA_EZORI  into  v_kod_mikum_yechida from CTB_MIKUM_YECHIDA
	where KOD_MIKUM_YECHIDA=substr(p_mikum_yaad,0,3);

	select  KOD_MERKAZ_EROA_EZORI    into  v_kod_merkaz_erua from CTB_MERKAZ_EROA
	where KOD_MERKAZ_EROA=p_merkaz_erua;

    select dakot into v_dakot
    from ctb_zman_nsiaa_mishtane c
    where c.merkaz_erua =  v_kod_merkaz_erua and
          c.mikum_yaad  = v_kod_mikum_yechida  and
          trunc(p_taarich) between c.me_taarich and c.ad_taarich;


    p_dakot := v_dakot;

EXCEPTION
        WHEN NO_DATA_FOUND THEN
		     p_dakot := -1;
        WHEN OTHERS THEN
             RAISE;
END pro_get_zman_nesia;

  procedure Pro_Get_Value_From_Parametrim( p_Kod_Param in  TB_Parametrim.Kod_Param%TYPE,
                                                                              p_Period in varchar2 ,
                                                                              p_Erech_Param out  TB_Parametrim.ERECH_PARAM%TYPE) IS
  p_ToDate Date ;
  p_FromDate date ;
  BEGIN
  	p_FromDate := to_date('01/' || p_Period,'dd/mm/yyyy'); /* period= 05/2009=>  v_MinLimitDate = 01/05/2009 */
    p_ToDate := add_months(p_FromDate,1) -1 ;    /* period= 05/2009=>  v_MaxLimitDate = 31/05/2009 */
    select  erech_param into p_Erech_Param
    from TB_Parametrim
    where Kod_Param = p_Kod_Param
    and (Me_Taarich <= p_ToDate) and (Ad_Taarich >= p_FromDate or Ad_Taarich is null ) ;
           EXCEPTION
		 WHEN OTHERS THEN
		      RAISE;
  END  Pro_Get_Value_From_Parametrim;

PROCEDURE Pro_Get_Value_From_Parametrim (p_kod_param in TB_PARAMETRIM.KOD_PARAM%type,
                                                                                p_taarich in date ,
                                                                                p_ERECH_PARAM    out integer)  IS
begin
    select ERECH_PARAM  into p_ERECH_PARAM
            from TB_PARAMETRIM
                where KOD_PARAM =  p_kod_param
                    and  ME_TAARICH   <= p_taarich
                    and  AD_TAARICH   >= p_taarich ;
EXCEPTION
    WHEN NO_DATA_FOUND THEN
         p_ERECH_PARAM := 0;
end Pro_Get_Value_From_Parametrim ;


procedure Pro_Get_Previous_Months_List(p_FromDate IN date, NumOfPreviousMonth number ,DisplayAll number,   p_cur out CurType) is
begin
open p_Cur for
  select x from table(cast(convert_string_to_table(
   KDSADMIN.PREVIOUS_MONTHS_LIST ( p_FromDate, NumOfPreviousMonth, DisplayAll ) ,  ',') as mytabtype));

   end Pro_Get_Previous_Months_List;




  PROCEDURE  pro_get_ovdim_leRitza (p_mis_ritza in integer  ,
  			 					   				   			  	                p_maamad in varchar2,
																			    p_isuk in varchar2,
																				p_preFix in varchar2,
																				p_cur out CurType) IS
  BEGIN
      open p_cur for
	--  select 75290, '' from dual ;
  SELECT Distinct Ov.MISPAR_ISHI,
	  		 		  case when (p_prefix is null) then
 					  	    Ov.shem_mish || ' ' ||  Ov.shem_prat || '(' || Ov.MISPAR_ISHI || ')'
					  else ''
					  end full_name
		   FROM TB_CHISHUV_CHODESH_OVDIM C,
		   				TMP_PIRTEY_OVDIM T ,
						OVDIM Ov
		   WHERE
		   		 			  c.MISPAR_ISHI = Ov.MISPAR_ISHI and
		   		 			  C.BAKASHA_ID =	p_mis_ritza AND
		   		 			 C.MISPAR_ISHI = T.MISPAR_ISHI AND
							--(  p_maamad is null OR  ( (substr( T.MAAMAD,0,1)  IN (SELECT X FROM TABLE(CAST(CONVERT_STRING_TO_TABLE(p_maamad ,  ',') AS MYTABTYPE))) )   AND      ( (add_months(C.TAARICH,1) -1) BETWEEN T.ME_TARICH and T.AD_TARICH)    )     ) AND
						--	(  p_isuk is null OR  ( (T.ISUK  IN (SELECT X FROM TABLE(CAST(CONVERT_STRING_TO_TABLE(p_isuk ,  ',') AS MYTABTYPE))) )   AND      ( (add_months(C.TAARICH,1) -1) BETWEEN T.ME_TARICH and T.AD_TARICH)    )     ) AND

						(add_months(C.TAARICH,1) -1) BETWEEN T.ME_TARICH(+) and T.AD_TARICH(+)
						and ((substr( T.MAAMAD,0,1)  IN (SELECT X FROM TABLE(CAST(CONVERT_STRING_TO_TABLE(p_maamad ,  ',') AS MYTABTYPE)))) or p_maamad is null) AND
				    	 (T.ISUK IN (SELECT X FROM TABLE(CAST(CONVERT_STRING_TO_TABLE(p_isuk ,  ',') AS MYTABTYPE)))  or p_isuk is null) AND
							( p_preFix is null OR C.MISPAR_ISHI Like p_preFix ||  '%'  )
		   ORDER BY Ov.MISPAR_ISHI;

	   EXCEPTION
		 WHEN OTHERS THEN
		      RAISE;
  END pro_get_ovdim_leRitza;

  FUNCTION fun_GET_Rechiv_Value ( p_MisparIshi in TB_Chishuv_Chodesh_Ovdim.Mispar_ishi%type,
                                                        p_Kod_Rechiv in TB_Chishuv_Chodesh_Ovdim.Kod_Rechiv%type,
                                                        p_StartDate in date,
                                                        p_EndDate in date,
                                                        p_Bakasha_ID in  TB_Chishuv_Chodesh_Ovdim.Bakasha_ID%type
                                                        ) RETURN number AS
ValueComponent number ;
begin
Select nvl( Ch.Erech_Rechiv,0)  into ValueComponent
From TB_Chishuv_Chodesh_Ovdim Ch
Where Ch.Kod_Rechiv=p_Kod_Rechiv
and Ch. Mispar_Ishi= p_MisparIshi
and Ch.Taarich between p_StartDate and p_EndDate
and Ch.Bakasha_ID=p_Bakasha_ID;

    return ValueComponent  ;

       EXCEPTION
            WHEN NO_DATA_FOUND THEN
                      ValueComponent := 0 ;
                          return ValueComponent  ;
            WHEN OTHERS THEN
                          RAISE;
END fun_GET_Rechiv_Value;


 PROCEDURE get_sadot_nosafim_lesidur(p_Sidur in integer,
 		  									   		   	  		 		        p_List_Meafyenim in varchar2,
																				p_cur out CurType) IS
 BEGIN
 		  open p_cur for
					 SELECT s.KOD_MEAFYEN,s.ERECH, c.*
					 FROM TB_SADOT_NOSAFIM_LESIDUR s,CTB_SADOT_NOSAFIM_LESIDUR c
					 WHERE s.KOD_SADE_IN_MASACH = c.KOD_SADE_IN_MASACH AND
					 	   			  (s.MISPAR_SIDUR=p_Sidur  or s.KOD_MEAFYEN in(  select x from table(cast(convert_string_to_table(p_List_Meafyenim ,  ',') as mytabtype)) )    ) and
									  c.RAMA = 1;



       EXCEPTION
         WHEN OTHERS THEN
              RAISE;
  End get_sadot_nosafim_lesidur;

  PROCEDURE get_sadot_nosafim_lePeilut(p_cur out CurType) IS
 BEGIN
 		  open p_cur for
					 SELECT c.*
					 FROM CTB_SADOT_NOSAFIM_LESIDUR c
					 WHERE  c.RAMA = 2;

       EXCEPTION
         WHEN OTHERS THEN
              RAISE;
  End get_sadot_nosafim_lePeilut;

  PROCEDURE get_sadot_nosafim_kayamim(p_mispar_ishi in  integer,
														                                p_mispar_sidur in  integer,
																					    p_taarich in TB_SIDURIM_OVDIM.TAARICH%type,
																						p_shat_hatchala in TB_SIDURIM_OVDIM.shat_hatchala%type,
																						p_cur out CurType) IS
	 BEGIN
	 			 open p_cur for
						  SELECT s.Mispar_Musach_O_Machsan,s.Yom_Visa,s.Achuz_Knas_LePremyat_Visa ,
							              s.Achuz_Viza_Besikun,s.Sug_Hazmanat_Visa,s.Mispar_shiurey_nehiga,
										  s.Tafkid_Visa,s.Mivtza_Visa,y.Lina
							FROM TB_SIDURIM_OVDIM s ,
										  TB_YAMEY_AVODA_OVDIM y
							WHERE s.MISPAR_ISHI =p_mispar_ishi  and
								  			   s.MISPAR_SIDUR =p_mispar_sidur and
								  			   s.TAARICH =	trunc( p_taarich) and
											   s.MISPAR_ISHI = y.MISPAR_ISHI and
											   s.SHAT_HATCHALA = p_shat_hatchala and
							                   s.TAARICH = y.TAARICH ;
											          EXCEPTION
         WHEN OTHERS THEN
              RAISE;
  End get_sadot_nosafim_kayamim;
  
  
  PROCEDURE pro_insert_barkod_Tachograf(p_mispar_ishi in  integer,
  													  	  		  	  			 			p_taarich in TB_TACHOGRAF_LE_KARTIS.TAARICH%type,
																							p_Barkod in number	)IS
	 BEGIN
	 			
				insert into TB_TACHOGRAF_LE_KARTIS(MISPAR_ISHI,TAARICH,MISPAR,BARKOD)
					   																 values(p_mispar_ishi,p_taarich ,1,p_Barkod);
		 EXCEPTION
         WHEN OTHERS THEN
              RAISE;
  End pro_insert_barkod_Tachograf;
		
				
 PROCEDURE fun_get_barkod_Tachograf(p_mispar_ishi in  integer,
			  										 p_taarich in TB_TACHOGRAF_LE_KARTIS.TAARICH%type,
													 p_cur out CurType  ) AS

begin
	 		  open p_Cur for
	 		   	select distinct t.Barkod 
				from TB_TACHOGRAF_LE_KARTIS t 
				where t.MISPAR_ISHI =p_mispar_ishi
					  and t.TAARICH =p_taarich;		   			
    				  
       EXCEPTION
            WHEN OTHERS THEN
                          RAISE;
END fun_get_barkod_Tachograf;
  
  
  
  	PROCEDURE pro_get_tavlaot_to_refresh(p_cur out CurType)
	IS
	 BEGIN
	 			open p_cur for
					    select trim(substr(p.teur_peilut_be_tahalich,9)) name, p.KOD_PEILUT_BE_TAHALICH kod
						from ctb_peilut_betahalich p
						where kod_tahalich=3
						and substr(teur_peilut_be_tahalich,1,7) = ('Refresh' )	
						order by	p.KOD_PEILUT_BE_TAHALICH asc;								
		 EXCEPTION
         WHEN OTHERS THEN
              RAISE;
  End pro_get_tavlaot_to_refresh;
																
END PKG_UTILS;
/

